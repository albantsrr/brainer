<?xml version='1.0' encoding='utf-8'?>
<html xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg" xmlns:epub="http://www.idpf.org/2007/ops" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" epub:prefix="index: http://www.index.com/">
  <head>
    <meta name="dcterms.conformsTo" content="PXE Basic 1.0"/>
    <meta name="generator" content="PXE Tools version 1.39.52"/>
    <!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
    <title>7.10 Dynamic Linking with Shared Libraries</title>
    <link rel="alternate stylesheet" type="text/css" title="night" href="../css/theme/night.css"/>
    <link rel="alternate stylesheet" type="text/css" title="sepia" href="../css/theme/sepia.css"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body epub:type="bodymatter" class="pcalibre1 pcalibre2 pcalibre">
<section id="P70004970270000000000000000063A5" class="pcalibre1 pcalibre2 pcalibre3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" id="P7000497027000000000000000044B5C" data-uri="chapter07.xhtml#P7000497027000000000000000044B5C" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.10 </span>Dynamic Linking with Shared Libraries</h1></header>
<p id="P7000497027000000000000000044B5D" data-uri="chapter07.xhtml#P7000497027000000000000000044B5D" class="pcalibre8 pcalibre1 pcalibre2">The static libraries that we studied in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P70004970270000000000000000061DE"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">7.6.2</span></a> address many of the issues associated with making large collections of related functions available to application programs. However, static libraries still have some significant disadvantages. Static libraries, like all software, need to be maintained and updated periodically. If application programmers want to use the most recent version of a library, they must somehow become aware that the library has changed and then explicitly relink their programs against the updated library.</p>
<p id="P7000497027000000000000000044B5E" data-uri="chapter07.xhtml#P7000497027000000000000000044B5E" class="pcalibre8 pcalibre1 pcalibre2">Another issue is that almost every C program uses standard I/O functions such as <code id="P7000497027000000000000000044B5F" data-uri="chapter07.xhtml#P7000497027000000000000000044B5F" class="pcalibre1 calibre1 pcalibre2">printf</code> and <code id="P7000497027000000000000000044B60" data-uri="chapter07.xhtml#P7000497027000000000000000044B60" class="pcalibre1 calibre1 pcalibre2">scanf</code>. At run time, the code for these functions is duplicated in the text segment of each running process. On a typical system that is running hundreds of processes, this can be a significant waste of scarce memory system resources. (An interesting property of memory is that it is <i class="pcalibre17 pcalibre2 pcalibre1">always</i> a scarce resource, regardless</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" id="P70004970270000000000000000063AB" data-uri="chapter07.xhtml#P70004970270000000000000000063AB"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" id="P7000497027000000000000000044B61" data-uri="chapter07.xhtml#P7000497027000000000000000044B61" epub:type="title"><span class="pcalibre1 pcalibre2 pcalibre5" id="P70004970270000000000000000063AD" title="699" data-uri="chapter07.xhtml#P70004970270000000000000000063AD" epub:type="pagebreak"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>How do loaders really work?</h1></header>
<p id="P7000497027000000000000000044B62" data-uri="chapter07.xhtml#P7000497027000000000000000044B62" class="pcalibre1 pcalibre2 pcalibre40">Our description of loading is conceptually correct but intentionally not entirely accurate. To understand how loading really works, you must understand the concepts of <i class="pcalibre17 pcalibre2 pcalibre1">processes</i>, <i class="pcalibre17 pcalibre2 pcalibre1">virtual memory</i>, and <i class="pcalibre17 pcalibre2 pcalibre1">memory mapping</i>, which we haven't discussed yet. As we encounter these concepts later in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000666E.xhtml#P700049702700000000000000000666E"><span class="pcalibre1 pcalibre21 pcalibre2">Chapters </span><span class="pcalibre1 pcalibre21 pcalibre2">8</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006FF7.xhtml#P7000497027000000000000000006FF7"><span class="pcalibre1 pcalibre21 pcalibre2">9</span></a>, we will revisit loading and gradually reveal the mystery to you.</p>
<p id="P7000497027000000000000000044B63" data-uri="chapter07.xhtml#P7000497027000000000000000044B63" class="pcalibre1 pcalibre2 pcalibre10">For the impatient reader, here is a preview of how loading really works: Each program in a Linux system runs in the context of a process with its own virtual address space. When the shell runs a program, the parent shell process forks a child process that is a duplicate of the parent. The child process invokes the loader via the <code id="P7000497027000000000000000044B64" data-uri="chapter07.xhtml#P7000497027000000000000000044B64" class="pcalibre1 calibre1 pcalibre2">execve</code> system call. The loader deletes the child's existing virtual memory segments and creates a new set of code, data, heap, and stack segments. The new stack and heap segments are initialized to zero. The new code and data segments are initialized to the contents of the executable file by mapping pages in the virtual address space to page-size chunks of the executable file. Finally, the loader jumps to the <code id="P7000497027000000000000000044B65" data-uri="chapter07.xhtml#P7000497027000000000000000044B65" class="pcalibre1 calibre1 pcalibre2">_start</code> address, which eventually calls the application's <code id="P7000497027000000000000000044B66" data-uri="chapter07.xhtml#P7000497027000000000000000044B66" class="pcalibre1 calibre1 pcalibre2">main</code> routine. Aside from some header information, there is no copying of data from disk to memory during loading. The copying is deferred until the CPU references a mapped virtual page, at which point the operating system automatically transfers the page from disk to memory using its paging mechanism.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" id="P7000497027000000000000000044B67" data-uri="chapter07.xhtml#P7000497027000000000000000044B67">of how much there is in a system. Disk space and kitchen trash cans share this same property.)</p>
<p id="P7000497027000000000000000044B68" data-uri="chapter07.xhtml#P7000497027000000000000000044B68" class="pcalibre8 pcalibre1 pcalibre2"><i class="pcalibre17 pcalibre2 pcalibre1">Shared libraries</i> are modern innovations that address the disadvantages of static libraries. A shared library is an object module that, at either run time or load time, can be loaded at an arbitrary memory address and linked with a program in memory. This process is known as <i class="pcalibre17 pcalibre2 pcalibre1">dynamic linking</i> and is performed by a program called a <i class="pcalibre17 pcalibre2 pcalibre1">dynamic linker</i>. Shared libraries are also referred to as <i class="pcalibre17 pcalibre2 pcalibre1">shared objects</i>, and on Linux systems they are indicated by the <code id="P7000497027000000000000000044B69" data-uri="chapter07.xhtml#P7000497027000000000000000044B69" class="pcalibre1 calibre1 pcalibre2">.so</code> suffix. Microsoft operating systems make heavy use of shared libraries, which they refer to as DLLs (dynamic link libraries).</p>
<p id="P7000497027000000000000000044B6A" data-uri="chapter07.xhtml#P7000497027000000000000000044B6A" class="pcalibre8 pcalibre1 pcalibre2">Shared libraries are "shared" in two different ways. First, in any given file system, there is exactly one <code id="P7000497027000000000000000044B6B" data-uri="chapter07.xhtml#P7000497027000000000000000044B6B" class="pcalibre1 calibre1 pcalibre2">.so</code> file for a particular library. The code and data in this <code id="P7000497027000000000000000044B6C" data-uri="chapter07.xhtml#P7000497027000000000000000044B6C" class="pcalibre1 calibre1 pcalibre2">.so</code> file are shared by all of the executable object files that reference the library, as opposed to the contents of static libraries, which are copied and embedded in the executables that reference them. Second, a single copy of the <code id="P7000497027000000000000000044B6D" data-uri="chapter07.xhtml#P7000497027000000000000000044B6D" class="pcalibre1 calibre1 pcalibre2">.text</code> section of a shared library in memory can be shared by different running processes. We will explore this in more detail when we study virtual memory in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006FF7.xhtml#P7000497027000000000000000006FF7"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">9</span></a>.</p>
<p id="P7000497027000000000000000044B6E" data-uri="chapter07.xhtml#P7000497027000000000000000044B6E" class="pcalibre8 pcalibre1 pcalibre2"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000063C1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.16</span></a> summarizes the dynamic linking process for the example program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P700049702700000000000000000621E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.7</span></a>. To build a shared library <code id="P7000497027000000000000000044B6F" data-uri="chapter07.xhtml#P7000497027000000000000000044B6F" class="pcalibre1 calibre1 pcalibre2">libvector.so</code> of our example vector routines in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P70004970270000000000000000061F7"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.6</span></a>, we invoke the compiler driver with some special directives to the compiler and linker:</p>
<pre id="P7000497027000000000000000044B70" data-uri="chapter07.xhtml#P7000497027000000000000000044B70" class="calibre2 pcalibre2 pcalibre1"><code id="P7000497027000000000000000044B71" data-uri="chapter07.xhtml#P7000497027000000000000000044B71" class="calibre3 pcalibre1 pcalibre2">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -shared -fpic -o libvector.so addvec.c multvec.c</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" id="P7000497027000000000000000044B72" data-uri="chapter07.xhtml#P7000497027000000000000000044B72">The <code id="P7000497027000000000000000044B73" data-uri="chapter07.xhtml#P7000497027000000000000000044B73" class="pcalibre1 calibre1 pcalibre2">-fpic</code> flag directs the compiler to generate <i class="pcalibre17 pcalibre2 pcalibre1">position-independent code</i> (more on this in the next section). The <code id="P7000497027000000000000000044B74" data-uri="chapter07.xhtml#P7000497027000000000000000044B74" class="pcalibre1 calibre1 pcalibre2">-shared</code> flag directs the linker to create a shared</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" id="P70004970270000000000000000063C1" data-uri="chapter07.xhtml#P70004970270000000000000000063C1">
<span class="pcalibre1 pcalibre2 pcalibre5" id="P70004970270000000000000000063C2" title="700" data-uri="chapter07.xhtml#P70004970270000000000000000063C2" epub:type="pagebreak"></span>
<img alt="A diagram illustrates dynamic linking with shared libraries." id="P7000497027000000000000000044B75" data-uri="P700049702700000000000000000B75D" src="../images/p700-1.png" class="pcalibre1 pcalibre2 calibre62"/>
<figcaption id="P7000497027000000000000000044B76" data-uri="chapter07.xhtml#P7000497027000000000000000044B76" class="pcalibre1 pcalibre2 calibre4"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" id="P7000497027000000000000000044B77" data-uri="chapter07.xhtml#P7000497027000000000000000044B77" epub:type="title"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.16 </span>Dynamic linking with shared libraries.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" id="P7000497027000000000000000024E8C" data-uri="chapter07.xhtml#P7000497027000000000000000024E8C">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p id="P7000497027000000000000000044B78" data-uri="chapter07.xhtml#P7000497027000000000000000044B78" class="pcalibre8 pcalibre1 pcalibre2">A diagram flows from top to bottom as follows:</p>
<ul id="P7000497027000000000000000044B79" data-uri="chapter07.xhtml#P7000497027000000000000000044B79" class="pcalibre1 pcalibre2 pcalibre62">
<li id="P7000497027000000000000000044B7A" data-uri="chapter07.xhtml#P7000497027000000000000000044B7A" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B7B" data-uri="chapter07.xhtml#P7000497027000000000000000044B7B" class="pcalibre1 pcalibre2 pcalibre10">Main2. C and vector.h</p></li>
<li id="P7000497027000000000000000044B7C" data-uri="chapter07.xhtml#P7000497027000000000000000044B7C" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B7D" data-uri="chapter07.xhtml#P7000497027000000000000000044B7D" class="pcalibre1 pcalibre2 pcalibre10">Translators (cpp, cc1, as)</p></li>
<li id="P7000497027000000000000000044B7E" data-uri="chapter07.xhtml#P7000497027000000000000000044B7E" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B7F" data-uri="chapter07.xhtml#P7000497027000000000000000044B7F" class="pcalibre1 pcalibre2 pcalibre10">Relocatable object file main2.0 and relocation and symbol table info libc.s0, libvector.so</p></li>
<li id="P7000497027000000000000000044B80" data-uri="chapter07.xhtml#P7000497027000000000000000044B80" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B81" data-uri="chapter07.xhtml#P7000497027000000000000000044B81" class="pcalibre1 pcalibre2 pcalibre10">Linker (ld)</p></li>
<li id="P7000497027000000000000000044B82" data-uri="chapter07.xhtml#P7000497027000000000000000044B82" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B83" data-uri="chapter07.xhtml#P7000497027000000000000000044B83" class="pcalibre1 pcalibre2 pcalibre10">Partially linked executable object file prog21</p></li>
<li id="P7000497027000000000000000044B84" data-uri="chapter07.xhtml#P7000497027000000000000000044B84" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B85" data-uri="chapter07.xhtml#P7000497027000000000000000044B85" class="pcalibre1 pcalibre2 pcalibre10">Loader (execve)</p></li>
<li id="P7000497027000000000000000044B86" data-uri="chapter07.xhtml#P7000497027000000000000000044B86" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B87" data-uri="chapter07.xhtml#P7000497027000000000000000044B87" class="pcalibre1 pcalibre2 pcalibre10">Fully linked executable in memory Dynamic linker (ld-linux.so); code and data from libc.so, libvector.so.</p></li>
</ul>
</details>

</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" id="P7000497027000000000000000044B88" data-uri="chapter07.xhtml#P7000497027000000000000000044B88">object file. Once we have created the library, we would then link it into our example program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P700049702700000000000000000621E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.7</span></a>:</p>
<pre id="P7000497027000000000000000044B89" data-uri="chapter07.xhtml#P7000497027000000000000000044B89" class="calibre2 pcalibre2 pcalibre1"><code id="P7000497027000000000000000044B8A" data-uri="chapter07.xhtml#P7000497027000000000000000044B8A" class="calibre3 pcalibre1 pcalibre2">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -o prog2l main2.c ./libvector.so</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" id="P7000497027000000000000000044B8B" data-uri="chapter07.xhtml#P7000497027000000000000000044B8B">This creates an executable object file <code id="P7000497027000000000000000044B8C" data-uri="chapter07.xhtml#P7000497027000000000000000044B8C" class="pcalibre1 calibre1 pcalibre2">prog2l</code> in a form that can be linked with <code id="P7000497027000000000000000044B8D" data-uri="chapter07.xhtml#P7000497027000000000000000044B8D" class="pcalibre1 calibre1 pcalibre2">libvector.so</code> at run time. The basic idea is to do some of the linking statically when the executable file is created, and then complete the linking process dynamically when the program is loaded. It is important to realize that none of the code or data sections from <code id="P7000497027000000000000000044B8E" data-uri="chapter07.xhtml#P7000497027000000000000000044B8E" class="pcalibre1 calibre1 pcalibre2">libvector.so</code> are actually copied into the executable <code id="P7000497027000000000000000044B8F" data-uri="chapter07.xhtml#P7000497027000000000000000044B8F" class="pcalibre1 calibre1 pcalibre2">prog2l</code> at this point. Instead, the linker copies some relocation and symbol table information that will allow references to code and data in <code id="P7000497027000000000000000044B90" data-uri="chapter07.xhtml#P7000497027000000000000000044B90" class="pcalibre1 calibre1 pcalibre2">libvector.so</code> to be resolved at load time.</p>
<p id="P7000497027000000000000000044B91" data-uri="chapter07.xhtml#P7000497027000000000000000044B91" class="pcalibre8 pcalibre1 pcalibre2">When the loader loads and runs the executable <code id="P7000497027000000000000000044B92" data-uri="chapter07.xhtml#P7000497027000000000000000044B92" class="pcalibre1 calibre1 pcalibre2">prog2l</code>, it loads the partially linked executable <code id="P7000497027000000000000000044B93" data-uri="chapter07.xhtml#P7000497027000000000000000044B93" class="pcalibre1 calibre1 pcalibre2">prog2l</code>, using the techniques discussed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006385.xhtml#P7000497027000000000000000006385"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">7.9</span></a>. Next, it notices that <code id="P7000497027000000000000000044B94" data-uri="chapter07.xhtml#P7000497027000000000000000044B94" class="pcalibre1 calibre1 pcalibre2">prog2l</code> contains a <code id="P7000497027000000000000000044B95" data-uri="chapter07.xhtml#P7000497027000000000000000044B95" class="pcalibre1 calibre1 pcalibre2">.interp</code> section, which contains the path name of the dynamic linker, which is itself a shared object (e.g., <code id="P7000497027000000000000000044B96" data-uri="chapter07.xhtml#P7000497027000000000000000044B96" class="pcalibre1 calibre1 pcalibre2">ld-linux.so</code> on Linux systems). Instead of passing control to the application, as it would normally do, the loader loads and runs the dynamic linker. The dynamic linker then finishes the linking task by performing the following relocations:</p>
<ul id="P7000497027000000000000000044B97" data-uri="chapter07.xhtml#P7000497027000000000000000044B97" class="pcalibre1 calibre9 pcalibre2">
<li id="P7000497027000000000000000044B98" data-uri="chapter07.xhtml#P7000497027000000000000000044B98" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B99" data-uri="chapter07.xhtml#P7000497027000000000000000044B99" class="pcalibre1 pcalibre2 pcalibre10">Relocating the text and data of <code id="P7000497027000000000000000044B9A" data-uri="chapter07.xhtml#P7000497027000000000000000044B9A" class="pcalibre1 calibre1 pcalibre2">libc.so</code> into some memory segment</p></li>
<li id="P7000497027000000000000000044B9B" data-uri="chapter07.xhtml#P7000497027000000000000000044B9B" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B9C" data-uri="chapter07.xhtml#P7000497027000000000000000044B9C" class="pcalibre1 pcalibre2 pcalibre10">Relocating the text and data of <code id="P7000497027000000000000000044B9D" data-uri="chapter07.xhtml#P7000497027000000000000000044B9D" class="pcalibre1 calibre1 pcalibre2">libvector.so</code> into another memory segment</p></li>
<li id="P7000497027000000000000000044B9E" data-uri="chapter07.xhtml#P7000497027000000000000000044B9E" class="pcalibre39 pcalibre2 pcalibre1"><p id="P7000497027000000000000000044B9F" data-uri="chapter07.xhtml#P7000497027000000000000000044B9F" class="pcalibre1 pcalibre2 pcalibre10">Relocating any references in <code id="P7000497027000000000000000044BA0" data-uri="chapter07.xhtml#P7000497027000000000000000044BA0" class="pcalibre1 calibre1 pcalibre2">prog2l</code> to symbols defined by <code id="P7000497027000000000000000044BA1" data-uri="chapter07.xhtml#P7000497027000000000000000044BA1" class="pcalibre1 calibre1 pcalibre2">libc.so</code> and <code id="P7000497027000000000000000044BA2" data-uri="chapter07.xhtml#P7000497027000000000000000044BA2" class="pcalibre1 calibre1 pcalibre2">libvector.so</code></p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" id="P7000497027000000000000000044BA3" data-uri="chapter07.xhtml#P7000497027000000000000000044BA3"><span class="pcalibre1 pcalibre2 pcalibre5" id="P70004970270000000000000000063E2" title="701" data-uri="chapter07.xhtml#P70004970270000000000000000063E2" epub:type="pagebreak"></span>Finally, the dynamic linker passes control to the application. From this point on, the locations of the shared libraries are fixed and do not change during execution of the program.</p>
</section></body></html>
