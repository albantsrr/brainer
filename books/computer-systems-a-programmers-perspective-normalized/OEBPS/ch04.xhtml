<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Chapter 4 Processor Architecture</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="chapter" id="P7000497027000000000000000003A76"><header class="pcalibre1 pcalibre2 pcalibre48"><h1 class="pcalibre1 pcalibre2 pcalibre49" data-uri="chapter04.xhtml#P7000497027000000000000000041C35" epub:type="title" id="P7000497027000000000000000041C35"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003A78" epub:type="pagebreak" id="P7000497027000000000000000003A78" title="351"></span><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre50 pcalibre2">4 </span>Processor Architecture</h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" id="d9e83652">
<nav class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000041C36" epub:type="toc" id="P7000497027000000000000000041C36">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041C37" id="P7000497027000000000000000041C37">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C38" id="P7000497027000000000000000041C38">
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter04.xhtml#P7000497027000000000000000041C39" id="P7000497027000000000000000041C39"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C3A" id="P7000497027000000000000000041C3A"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003AB0"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">4.1 </span>The Y86-64 Instruction Set Architecture </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">355</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter04.xhtml#P7000497027000000000000000041C3B" id="P7000497027000000000000000041C3B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C3C" id="P7000497027000000000000000041C3C"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003C81"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">4.2 </span>Logic Design and the Hardware Control Language HCL </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">372</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter04.xhtml#P7000497027000000000000000041C3D" id="P7000497027000000000000000041C3D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C3E" id="P7000497027000000000000000041C3E"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D54"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">4.3 </span>Sequential Y86-64 Implementations </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">384</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter04.xhtml#P7000497027000000000000000041C3F" id="P7000497027000000000000000041C3F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C40" id="P7000497027000000000000000041C40"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004152.xhtml#P7000497027000000000000000004152"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">4.4 </span>General Principles of Pipelining </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">412</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter04.xhtml#P7000497027000000000000000041C41" id="P7000497027000000000000000041C41"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C42" id="P7000497027000000000000000041C42"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000041EB_split_000.xhtml#P70004970270000000000000000041EB"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">4.5 </span>Pipelined Y86-64 Implementations </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">421</span></a></p></li>
</ol>
</div>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041C43" id="P7000497027000000000000000041C43">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C44" id="P7000497027000000000000000041C44">
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter04.xhtml#P7000497027000000000000000041C45" id="P7000497027000000000000000041C45"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C46" id="P7000497027000000000000000041C46"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000045BA.xhtml#P70004970270000000000000000045BA"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">4.6 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary</span> </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">470</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter04.xhtml#P7000497027000000000000000041C47" id="P7000497027000000000000000041C47"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C48" id="P7000497027000000000000000041C48"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000045DE.xhtml#P70004970270000000000000000045DE"><span class="pcalibre1 pcalibre2" epub:type="title">Bibliographic Notes </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">473</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter04.xhtml#P7000497027000000000000000041C49" id="P7000497027000000000000000041C49"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C4A" id="P7000497027000000000000000041C4A"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000045E1.xhtml#P70004970270000000000000000045E1"><span class="pcalibre1 pcalibre2" epub:type="title">Homework Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">473</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter04.xhtml#P7000497027000000000000000041C4B" id="P7000497027000000000000000041C4B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C4C" id="P7000497027000000000000000041C4C"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046A4"><span class="pcalibre1 pcalibre2" epub:type="title">Solutions to Practice Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">480</span></a></p></li>
</ol>
</div>
</nav>
<section class="pcalibre1 pcalibre2 pcalibre51" data-uri="chapter04.xhtml#P7000497027000000000000000041C4D" epub:type="introduction" id="P7000497027000000000000000041C4D">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C4E" id="P7000497027000000000000000041C4E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003A93" epub:type="pagebreak" id="P7000497027000000000000000003A93" title="352"></span>Modern microprocessors are among the most complex systems ever created by humans. A single silicon chip, roughly the size of a fingernail, can contain several high-performance processors, large cache memories, and the logic required to interface them to external devices. In terms of performance, the processors implemented on a single chip today dwarf the room-size supercomputers that cost over $10 million just 20 years ago. Even the embedded processors found in everyday appliances such as cell phones, navigation systems, and programmable thermostats are far more powerful than the early developers of computers could ever have envisioned.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C4F" id="P7000497027000000000000000041C4F">So far, we have only viewed computer systems down to the level of machine-language programs. We have seen that a processor must execute a sequence of instructions, where each instruction performs some primitive operation, such as adding two numbers. An instruction is encoded in binary form as a sequence of 1 or more bytes. The instructions supported by a particular processor and their byte-level encodings are known as its <i class="pcalibre17 pcalibre2 pcalibre1">instruction set architecture</i> (ISA). Different "families" of processors, such as Intel IA32 and x86-64, IBM/Freescale Power, and the ARM processor family, have different ISAs. A program compiled for one type of machine will not run on another. On the other hand, there are many different models of processors within a single family. Each manufacturer produces processors of ever-growing performance and complexity, but the different models remain compatible at the ISA level. Popular families, such as x86-64, have processors supplied by multiple manufacturers. Thus, the ISA provides a conceptual layer of abstraction between compiler writers, who need only know what instructions are permitted and how they are encoded, and processor designers, who must build machines that execute those instructions.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C50" id="P7000497027000000000000000041C50">In this chapter, we take a brief look at the design of processor hardware. We study the way a hardware system can execute the instructions of a particular ISA. This view will give you a better understanding of how computers work and the technological challenges faced by computer manufacturers. One important concept is that the actual way a modern processor operates can be quite different from the model of computation implied by the ISA. The ISA model would seem to imply <i class="pcalibre17 pcalibre2 pcalibre1">sequential</i> instruction execution, where each instruction is fetched and executed to completion before the next one begins. By executing different parts of multiple instructions simultaneously, the processor can achieve higher performance than if it executed just one instruction at a time. Special mechanisms are used to make sure the processor computes the same results as it would with sequential execution. This idea of using clever tricks to improve performance while maintaining the functionality of a simpler and more abstract model is well known in computer science. Examples include the use of caching in Web browsers and information retrieval data structures such as balanced binary trees and hash tables.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C51" id="P7000497027000000000000000041C51">Chances are you will never design your own processor. This is a task for experts working at fewer than 100 companies worldwide. Why, then, should you learn about processor design?</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C52" id="P7000497027000000000000000041C52">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C53" id="P7000497027000000000000000041C53"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C54" id="P7000497027000000000000000041C54"><span class="pcalibre1 pcalibre2 pcalibre41">It is intellectually interesting and important. </span>There is an intrinsic value in learning how things work. It is especially interesting to learn the inner workings of</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003A9A" id="P7000497027000000000000000003A9A"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 title1" data-uri="chapter04.xhtml#P7000497027000000000000000041C55" epub:type="title" id="P7000497027000000000000000041C55"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003A9C" epub:type="pagebreak" id="P7000497027000000000000000003A9C" title="353"></span><span class="label1 pcalibre1 pcalibre2">Aside </span>The progress of computer technology</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C56" id="P7000497027000000000000000041C56">To get a sense of how much computer technology has improved over the past four decades, consider the following two processors.</p>
<p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter04.xhtml#P7000497027000000000000000041C57" id="P7000497027000000000000000041C57">The first Cray 1 supercomputer was delivered to Los Alamos National Laboratory in 1976. It was the fastest computer in the world, able to perform as many as 250 million arithmetic operations per second. It came with 8 megabytes of random access memory, the maximum configuration allowed by the hardware. The machine was also very large—it weighed 5,000 kg, consumed 115 kilowatts, and cost $9 million. In total, around 80 of them were manufactured.</p>
<p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter04.xhtml#P7000497027000000000000000041C58" id="P7000497027000000000000000041C58">The Apple ARM A7 microprocessor chip, introduced in 2013 to power the iPhone 5S, contains two CPUs, each of which can perform several billion arithmetic operations per second, and 1 gigabyte of random access memory. The entire phone weighs just 112 grams, consumes around 1 watt, and costs less than $800. Over 9 million units were sold in the first weekend of its introduction. In addition to being a powerful computer, it can be used to take pictures, to place phone calls, and to provide driving directions, features never considered for the Cray 1.</p>
<p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter04.xhtml#P7000497027000000000000000041C59" id="P7000497027000000000000000041C59">These two systems, spaced just 37 years apart, demonstrate the tremendous progress of semiconductor technology. Whereas the Cray l's CPU was constructed using around 100,000 semiconductor chips, each containing less than 20 transistors, the Apple A7 has over 1 billion transistors on its single chip. The Cray 1's 8-megabyte memory required 8,192 chips, whereas the iPhone's gigabyte memory is contained in a single chip.</p>
</aside>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C5A" id="P7000497027000000000000000041C5A">a system that is such a part of the daily lives of computer scientists and engineers and yet remains a mystery to many. Processor design embodies many of the principles of good engineering practice. It requires creating a simple and regular structure to perform a complex task.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C5B" id="P7000497027000000000000000041C5B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C5C" id="P7000497027000000000000000041C5C"><span class="pcalibre1 pcalibre2 pcalibre41">Understanding how the processor works aids in understanding how the overall computer system works. </span>In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000005190.xhtml#P7000497027000000000000000005190"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">6</span></a>, we will look at the memory system and the techniques used to create an image of a very large memory with a very fast access time. Seeing the processor side of the processor-memory interface will make this presentation more complete.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C5D" id="P7000497027000000000000000041C5D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C5E" id="P7000497027000000000000000041C5E"><span class="pcalibre1 pcalibre2 pcalibre41">Although few people design processors, many design hardware systems that contain processors. </span>This has become commonplace as processors are embedded into real-world systems such as automobiles and appliances. Embedded-system designers must understand how processors work, because these systems are generally designed and programmed at a lower level of abstraction than is the case for desktop and server-based systems.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C5F" id="P7000497027000000000000000041C5F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C60" id="P7000497027000000000000000041C60"><span class="pcalibre1 pcalibre2 pcalibre41">You just might work on a processor design. </span>Although the number of companies producing microprocessors is small, the design teams working on those processors are already large and growing. There can be over 1,000 people involved in the different aspects of a major processor design.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C61" id="P7000497027000000000000000041C61">In this chapter, we start by defining a simple instruction set that we use as a running example for our processor implementations. We call this the "Y86-64" <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003AA9" epub:type="pagebreak" id="P7000497027000000000000000003AA9" title="354"></span>instruction set, because it was inspired by the x86-64 instruction set. Compared with x86-64, the Y86-64 instruction set has fewer data types, instructions, and addressing modes. It also has a simple byte-level encoding, making the machine code less compact than the comparable x86-64 code, but also much easier to design the CPU's decoding logic. Even though the Y86-64 instruction set is very simple, it is sufficiently complete to allow us to write programs manipulating integer data. Designing a processor to implement Y86-64 requires us to deal with many of the challenges faced by processor designers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C62" id="P7000497027000000000000000041C62">We then provide some background on digital hardware design. We describe the basic building blocks used in a processor and how they are connected together and operated. This presentation builds on our discussion of Boolean algebra and bit-level operations from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000000279.xhtml#P7000497027000000000000000000279"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">2</span></a>. We also introduce a simple language, HCL (for "hardware control language"), to describe the control portions of hardware systems. We will later use this language to describe our processor designs. Even if you already have some background in logic design, read this section to understand our particular notation.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C63" id="P7000497027000000000000000041C63">As a first step in designing a processor, we present a functionally correct, but somewhat impractical, Y86-64 processor based on <i class="pcalibre17 pcalibre2 pcalibre1">sequential</i> operation. This processor executes a complete Y86-64 instruction on every clock cycle. The clock must run slowly enough to allow an entire series of actions to complete within one cycle. Such a processor could be implemented, but its performance would be well below what could be achieved for this much hardware.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C64" id="P7000497027000000000000000041C64">With the sequential design as a basis, we then apply a series of transformations to create a <i class="pcalibre17 pcalibre2 pcalibre1">pipelined</i> processor. This processor breaks the execution of each instruction into five steps, each of which is handled by a separate section or <i class="pcalibre17 pcalibre2 pcalibre1">stage</i> of the hardware. Instructions progress through the stages of the pipeline, with one instruction entering the pipeline on each clock cycle. As a result, the processor can be executing the different steps of up to five instructions simultaneously. Making this processor preserve the sequential behavior of the Y86-64 ISA requires handling a variety of <i class="pcalibre17 pcalibre2 pcalibre1">hazard</i> conditions, where the location or operands of one instruction depend on those of other instructions that are still in the pipeline.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C65" id="P7000497027000000000000000041C65">We have devised a variety of tools for studying and experimenting with our processor designs. These include an assembler for Y86-64, a simulator for running Y86-64 programs on your machine, and simulators for two sequential and one pipelined processor design. The control logic for these designs is described by files in HCL notation. By editing these files and recompiling the simulator, you can alter and extend the simulator's behavior. A number of exercises are provided that involve implementing new instructions and modifying how the machine processes instructions. Testing code is provided to help you evaluate the correctness of your modifications. These exercises will greatly aid your understanding of the material and will give you an appreciation for the many different design alternatives faced by processor designers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C66" id="P7000497027000000000000000041C66">Web Aside <span class="pcalibre1 pcalibre29 pcalibre2">arch:vlog </span>on page 467 presents a representation of our pipelined Y86-64 processor in the Verilog hardware description language. This involves creating modules for the basic hardware building blocks and for the overall processor structure. We automatically translate the HCL description of the control <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003AAF" epub:type="pagebreak" id="P7000497027000000000000000003AAF" title="355"></span>logic into Verilog. By first debugging the HCL description with our simulators, we eliminate many of the tricky bugs that would otherwise show up in the hardware design. Given a Verilog description, there are commercial and open-source tools to support simulation and <i class="pcalibre17 pcalibre2 pcalibre1">logic synthesis</i>, generating actual circuit designs for the microprocessors. So, although much of the effort we expend here is to create pictorial and textual descriptions of a system, much as one would when writing software, the fact that these designs can be automatically synthesized demonstrates that we are indeed creating a system that can be realized as hardware.</p>
</section>
</section>
<!--EOF:P7000497027000000000000000003AB0-->
<!--EOF:P7000497027000000000000000003C81-->
<!--EOF:P7000497027000000000000000003D54-->
<!--EOF:P7000497027000000000000000004152-->
<!--EOF:P70004970270000000000000000041EB-->
<!--EOF:P70004970270000000000000000045BA-->
<!--EOF:P70004970270000000000000000045DE-->
<!--EOF:P70004970270000000000000000045E1-->
<!--EOF:P70004970270000000000000000046A4-->
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Chapter 2 Representing and Manipulating Information</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="chapter" id="P7000497027000000000000000000279"><header class="pcalibre1 pcalibre2 pcalibre48"><h1 class="pcalibre1 pcalibre2 pcalibre49" data-uri="chapter02.xhtml#P700049702700000000000000003E666" epub:type="title" id="P700049702700000000000000003E666"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter02.xhtml#P700049702700000000000000000027B" epub:type="pagebreak" id="P700049702700000000000000000027B" title="31"></span><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre50 pcalibre2">2 </span>Representing and Manipulating Information</h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" id="d9e9195">
<nav class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter02.xhtml#P700049702700000000000000003E667" epub:type="toc" id="P700049702700000000000000003E667">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter02.xhtml#P700049702700000000000000003E668" id="P700049702700000000000000003E668">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E669" id="P700049702700000000000000003E669">
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter02.xhtml#P700049702700000000000000003E66A" id="P700049702700000000000000003E66A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter02.xhtml#P700049702700000000000000003E66B" id="P700049702700000000000000003E66B"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000002AD_split_000.xhtml#P70004970270000000000000000002AD"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">2.1 </span>Information Storage </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">34</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter02.xhtml#P700049702700000000000000003E66C" id="P700049702700000000000000003E66C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter02.xhtml#P700049702700000000000000003E66D" id="P700049702700000000000000003E66D"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000077D_split_000.xhtml#P700049702700000000000000000077D"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">2.2 </span>Integer Representations </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">59</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter02.xhtml#P700049702700000000000000003E66E" id="P700049702700000000000000003E66E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter02.xhtml#P700049702700000000000000003E66F" id="P700049702700000000000000003E66F"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000000CB3_split_000.xhtml#P7000497027000000000000000000CB3"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">2.3 </span>Integer Arithmetic </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">84</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter02.xhtml#P700049702700000000000000003E670" id="P700049702700000000000000003E670"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter02.xhtml#P700049702700000000000000003E671" id="P700049702700000000000000003E671"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000010EA.xhtml#P70004970270000000000000000010EA"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">2.4 </span>Floating Point </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">108</span></a></p></li>
</ol>
</div>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter02.xhtml#P700049702700000000000000003E672" id="P700049702700000000000000003E672">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E673" id="P700049702700000000000000003E673">
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter02.xhtml#P700049702700000000000000003E674" id="P700049702700000000000000003E674"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter02.xhtml#P700049702700000000000000003E675" id="P700049702700000000000000003E675"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000001479.xhtml#P7000497027000000000000000001479"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">2.5 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary</span> </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">126</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter02.xhtml#P700049702700000000000000003E676" id="P700049702700000000000000003E676"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter02.xhtml#P700049702700000000000000003E677" id="P700049702700000000000000003E677"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000001493.xhtml#P7000497027000000000000000001493"><span class="pcalibre1 pcalibre2" epub:type="title">Bibliographic Notes </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">127</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter02.xhtml#P700049702700000000000000003E678" id="P700049702700000000000000003E678"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter02.xhtml#P700049702700000000000000003E679" id="P700049702700000000000000003E679"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000001498.xhtml#P7000497027000000000000000001498"><span class="pcalibre1 pcalibre2" epub:type="title">Homework Problems	</span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">128</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter02.xhtml#P700049702700000000000000003E67A" id="P700049702700000000000000003E67A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter02.xhtml#P700049702700000000000000003E67B" id="P700049702700000000000000003E67B"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000017AE_split_000.xhtml#P70004970270000000000000000017AE"><span class="pcalibre1 pcalibre2" epub:type="title">Solutions to Practice Problems </span>143</a></p></li>
</ol>
</div>
</nav>
<section class="pcalibre1 pcalibre2 pcalibre51" data-uri="chapter02.xhtml#P700049702700000000000000003E67C" epub:type="introduction" id="P700049702700000000000000003E67C">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E67D" id="P700049702700000000000000003E67D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter02.xhtml#P7000497027000000000000000000293" epub:type="pagebreak" id="P7000497027000000000000000000293" title="32"></span>Modern computers store and process information represented as two-valued signals. These lowly binary digits, or <i class="pcalibre17 pcalibre2 pcalibre1">bits</i>, form the basis of the digital revolution. The familiar decimal, or base-10, representation has been in use for over 1,000 years, having been developed in India, improved by Arab mathematicians in the 12th century, and brought to the West in the 13th century by the Italian mathematician Leonardo Pisano (ca. 1170 to ca. 1250), better known as Fibonacci. Using decimal notation is natural for 10-fingered humans, but binary values work better when building machines that store and process information. Two-valued signals can readily be represented, stored, and transmitted—for example, as the presence or absence of a hole in a punched card, as a high or low voltage on a wire, or as a magnetic domain oriented clockwise or counterclockwise. The electronic circuitry for storing and performing computations on two-valued signals is very simple and reliable, enabling manufacturers to integrate millions, or even billions, of such circuits on a single silicon chip.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E67E" id="P700049702700000000000000003E67E">In isolation, a single bit is not very useful. When we group bits together and apply some <i class="pcalibre17 pcalibre2 pcalibre1">interpretation</i> that gives meaning to the different possible bit patterns, however, we can represent the elements of any finite set. For example, using a binary number system, we can use groups of bits to encode nonnegative numbers. By using a standard character code, we can encode the letters and symbols in a document. We cover both of these encodings in this chapter, as well as encodings to represent negative numbers and to approximate real numbers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E67F" id="P700049702700000000000000003E67F">We consider the three most important representations of numbers. <i class="pcalibre17 pcalibre2 pcalibre1">Unsigned</i> encodings are based on traditional binary notation, representing numbers greater than or equal to 0. <i class="pcalibre17 pcalibre2 pcalibre1">Two's-complement</i> encodings are the most common way to represent <i class="pcalibre17 pcalibre2 pcalibre1">signed</i> integers, that is, numbers that may be either positive or negative. <i class="pcalibre17 pcalibre2 pcalibre1">Floating-point</i> encodings are a base-2 version of scientific notation for representing real numbers. Computers implement arithmetic operations, such as addition and multiplication, with these different representations, similar to the corresponding operations on integers and real numbers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E680" id="P700049702700000000000000003E680">Computer representations use a limited number of bits to encode a number, and hence some operations can <i class="pcalibre17 pcalibre2 pcalibre1">overflow</i> when the results are too large to be represented. This can lead to some surprising results. For example, on most of today's computers (those using a 32-bit representation for data type int), computing the expression</p>
<pre class="pcalibre53 pcalibre2 pcalibre1" data-uri="chapter02.xhtml#P700049702700000000000000003E681" id="P700049702700000000000000003E681"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E682" id="P700049702700000000000000003E682">
200 * 300 * 400 * 500
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E683" id="P700049702700000000000000003E683">yields –884,901,888. This runs counter to the properties of integer arithmetic—computing the product of a set of positive numbers has yielded a negative result.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E684" id="P700049702700000000000000003E684">On the other hand, integer computer arithmetic satisfies many of the familiar properties of true integer arithmetic. For example, multiplication is associative and commutative, so that computing any of the following C expressions yields –884,901,888:</p>
<pre class="pcalibre53 pcalibre2 pcalibre1" data-uri="chapter02.xhtml#P700049702700000000000000003E685" id="P700049702700000000000000003E685"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E686" id="P700049702700000000000000003E686">
(500 * 400) * (300 * 200)
((500 * 400) * 300) * 200
((200 * 500) * 300) * 400
400 * (200 * (300 * 500))
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E687" id="P700049702700000000000000003E687"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter02.xhtml#P700049702700000000000000000029E" epub:type="pagebreak" id="P700049702700000000000000000029E" title="33"></span>The computer might not generate the expected result, but at least it is consistent!</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E688" id="P700049702700000000000000003E688">Floating-point arithmetic has altogether different mathematical properties. The product of a set of positive numbers will always be positive, although overflow will yield the special value +∞. Floating-point arithmetic is not associative due to the finite precision of the representation. For example, the C expression <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E689" id="P700049702700000000000000003E689">(3.14+1e20)-1e20</code> will evaluate to 0.0 on most machines, while <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E68A" id="P700049702700000000000000003E68A">3.14+(1e20–1e20)</code> will evaluate to 3.14. The different mathematical properties of integer versus. floating-point arithmetic stem from the difference in how they handle the finiteness of their representations—integer representations can encode a comparatively small range of values, but do so precisely, while floating-point representations can encode a wide range of values, but only approximately.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E68B" id="P700049702700000000000000003E68B">By studying the actual number representations, we can understand the ranges of values that can be represented and the properties of the different arithmetic operations. This understanding is critical to writing programs that work correctly over the full range of numeric values and that are portable across different combinations of machine, operating system, and compiler. As we will describe, a number of computer security vulnerabilities have arisen due to some of the subtleties of computer arithmetic. Whereas in an earlier era program bugs would only inconvenience people when they happened to be triggered, there are now legions of hackers who try to exploit any bug they can find to obtain unauthorized access to other people's systems. This puts a higher level of obligation on programmers to understand how their programs work and how they can be made to behave in undesirable ways.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E68C" id="P700049702700000000000000003E68C">Computers use several different binary representations to encode numeric values. You will need to be familiar with these representations as you progress into machine-level programming in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001DCE.xhtml#P7000497027000000000000000001DCE"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">3</span></a>. We describe these encodings in this chapter and show you how to reason about number representations.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E68D" id="P700049702700000000000000003E68D">We derive several ways to perform arithmetic operations by directly manipulating the bit-level representations of numbers. Understanding these techniques will be important for understanding the machine-level code generated by compilers in their attempt to optimize the performance of arithmetic expression evaluation.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E68E" id="P700049702700000000000000003E68E">Our treatment of this material is based on a core set of mathematical principles. We start with the basic definitions of the encodings and then derive such properties as the range of representable numbers, their bit-level representations, and the properties of the arithmetic operations. We believe it is important for you to examine the material from this abstract viewpoint, because programmers need to have a clear understanding of how computer arithmetic relates to the more familiar integer and real arithmetic.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter02.xhtml#P700049702700000000000000003E68F" id="P700049702700000000000000003E68F">The C++ programming language is built upon C, using the exact same numeric representations and operations. Everything said in this chapter about C also holds for C++. The Java language definition, on the other hand, created a new set of standards for numeric representations and operations. Whereas the C standards are designed to allow a wide range of implementations, the Java standard is quite specific on the formats and encodings of data. We highlight the representations and operations supported by Java at several places in the chapter.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter02.xhtml#P70004970270000000000000000002A7" id="P70004970270000000000000000002A7"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 title1" data-uri="chapter02.xhtml#P700049702700000000000000003E690" epub:type="title" id="P700049702700000000000000003E690"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter02.xhtml#P70004970270000000000000000002A9" epub:type="pagebreak" id="P70004970270000000000000000002A9" title="34"></span><span class="label1 pcalibre1 pcalibre2">Aside </span>How to read this chapter</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter02.xhtml#P700049702700000000000000003E691" id="P700049702700000000000000003E691">In this chapter, we examine the fundamental properties of how numbers and other forms of data are represented on a computer and the properties of the operations that computers perform on these data. This requires us to delve into the language of mathematics, writing formulas and equations and showing derivations of important properties.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter02.xhtml#P700049702700000000000000003E692" id="P700049702700000000000000003E692">To help you navigate this exposition, we have structured the presentation to first state a property as a <i class="pcalibre17 pcalibre2 pcalibre1">principle</i> in mathematical notation. We then illustrate this principle with examples and an informal discussion. We recommend that you go back and forth between the statement of the principle and the examples and discussion until you have a solid intuition for what is being said and what is important about the property. For more complex properties, we also provide a <i class="pcalibre17 pcalibre2 pcalibre1">derivation</i>, structured much like a mathematical proof. You should try to understand these derivations eventually, but you could skip over them on first reading.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter02.xhtml#P700049702700000000000000003E693" id="P700049702700000000000000003E693">We also encourage you to work on the practice problems as you proceed through the presentation. The practice problems engage you in <i class="pcalibre17 pcalibre2 pcalibre1">active learning</i>, helping you put thoughts into action. With these as background, you will find it much easier to go back and follow the derivations. Be assured, as well, that the mathematical skills required to understand this material are within reach of someone with a good grasp of high school algebra.</p>
</aside>
</section>
</section>
<!--EOF:P70004970270000000000000000002AD-->
<!--EOF:P700049702700000000000000000077D-->
<!--EOF:P7000497027000000000000000000CB3-->
<!--EOF:P70004970270000000000000000010EA-->
<!--EOF:P7000497027000000000000000001479-->
<!--EOF:P7000497027000000000000000001493-->
<!--EOF:P7000497027000000000000000001498-->
<!--EOF:P70004970270000000000000000017AE-->
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>4.1 The Y86-64 Instruction Set Architecture</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000003AB0"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041C67" epub:type="title" id="P7000497027000000000000000041C67"><span class="pcalibre1 pcalibre21 pcalibre2">4.1 </span>The Y86-64 Instruction Set Architecture</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C68" id="P7000497027000000000000000041C68">Defining an instruction set architecture, such as Y86-64, includes defining the different components of its state, the set of instructions and their encodings, a set of programming conventions, and the handling of exceptional events.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003AB3" id="P7000497027000000000000000003AB3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C69" epub:type="title" id="P7000497027000000000000000041C69"><span class="pcalibre1 pcalibre21 pcalibre2">4.1.1 </span>Programmer-Visible State</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C6A" id="P7000497027000000000000000041C6A">As <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ABC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.1</span></a> illustrates, each instruction in a Y86-64 program can read and modify some part of the processor state. This is referred to as the <i class="pcalibre17 pcalibre2 pcalibre1">programmer-visible</i> state, where the "programmer" in this case is either someone writing programs in assembly code or a compiler generating machine-level code. We will see in our processor implementations that we do not need to represent and organize this state in exactly the manner implied by the ISA, as long as we can make sure that machine-level programs appear to have access to the programmer-visible state. The state for Y86-64 is similar to that for x86-64. There are 15 <i class="pcalibre17 pcalibre2 pcalibre1">program registers:</i> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C6B" id="P7000497027000000000000000041C6B">%rax, %rcx, %rdx, %rbx, %rsp, %rbp, %rsi, %rdi, and %r8</code> through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C6C" id="P7000497027000000000000000041C6C">%r14.</code> (We omit the x86-64 register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C6D" id="P7000497027000000000000000041C6D">%r</code> 15 to simplify the instruction encoding.) Each of these stores a 64-bit word. Register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C6E" id="P7000497027000000000000000041C6E">%rsp</code> is used as a stack pointer by the push, pop, call, and return instructions. Otherwise, the registers have no fixed meanings or values. There are three single-bit <i class="pcalibre17 pcalibre2 pcalibre1">condition codes</i>, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C6F" id="P7000497027000000000000000041C6F">ZF, SF</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C70" id="P7000497027000000000000000041C70">OF</code>, storing information</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003ABC" id="P7000497027000000000000000003ABC">
<img alt="A diagram shows fields for the Y86-64 programmer-visible state." class="pcalibre1 calibre28 pcalibre2" data-uri="P700049702700000000000000000B6C9" id="P7000497027000000000000000041C71" src="Images/chapter-04-image-01.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041C72" id="P7000497027000000000000000041C72"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041C73" epub:type="title" id="P7000497027000000000000000041C73"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.1 </span>Y86-64 programmer-visible state.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041C74" id="P7000497027000000000000000041C74"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C75" id="P7000497027000000000000000041C75">As with x86-64, programs for Y86-64 access and modify the program registers, the condition codes, the program counter (PC), and the memory. The status code indicates whether the program is running normally or some special event has occurred.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000021F56" id="P7000497027000000000000000021F56">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C76" id="P7000497027000000000000000041C76">The five fields are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P7000497027000000000000000041C77" id="P7000497027000000000000000041C77">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C78" id="P7000497027000000000000000041C78"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C79" id="P7000497027000000000000000041C79">RF: Program registers: %rax, %rcx, %rdx, %rbx, %rsp, %rbp, %rsi, %rdi, %r8, %r9, %r10, %r11, %r12, %r13, %r14</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C7A" id="P7000497027000000000000000041C7A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C7B" id="P7000497027000000000000000041C7B">CC: condition codes: ZF, SF, OF</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C7C" id="P7000497027000000000000000041C7C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C7D" id="P7000497027000000000000000041C7D">Stat: Program status (blank)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C7E" id="P7000497027000000000000000041C7E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C7F" id="P7000497027000000000000000041C7F">PC (blank)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C80" id="P7000497027000000000000000041C80"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C81" id="P7000497027000000000000000041C81">DMEM: Memory (blank)</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C82" id="P7000497027000000000000000041C82"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003AC3" epub:type="pagebreak" id="P7000497027000000000000000003AC3" title="356"></span>about the effect of the most recent arithmetic or logical instruction. The program counter (PC) holds the address of the instruction currently being executed.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C83" id="P7000497027000000000000000041C83">The <i class="pcalibre17 pcalibre2 pcalibre1">memory</i> is conceptually a large array of bytes, holding both program and data. Y86-64 programs reference memory locations using <i class="pcalibre17 pcalibre2 pcalibre1">virtual addresses.</i> A combination of hardware and operating system software translates these into the actual, or <i class="pcalibre17 pcalibre2 pcalibre1">physical</i>, addresses indicating where the values are actually stored in memory. We will study virtual memory in more detail in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006FF7.xhtml#P7000497027000000000000000006FF7"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">9</span></a>. For now, we can think of the virtual memory system as providing Y86-64 programs with an image of a monolithic byte array.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C84" id="P7000497027000000000000000041C84">A final part of the program state is a status code Stat, indicating the overall state of program execution. It will indicate either normal operation or that some sort of <i class="pcalibre17 pcalibre2 pcalibre1">exception</i> has occurred, such as when an instruction attempts to read from an invalid memory address. The possible status codes and the handling of exceptions is described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003BB9"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.1.4</span></a>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003AC6" id="P7000497027000000000000000003AC6"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C85" epub:type="title" id="P7000497027000000000000000041C85"><span class="pcalibre1 pcalibre21 pcalibre2">4.1.2 </span>Y86-64 Instructions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C86" id="P7000497027000000000000000041C86"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a> gives a concise description of the individual instructions in the Y86-64 ISA. We use this instruction set as a target for our processor implementations. The set of Y86-64 instructions is largely a subset of the x86-64 instruction set. It includes only 8-byte integer operations, has fewer addressing modes, and includes a smaller set of operations. Since we only use 8-byte data, we can refer to these as "words" without any ambiguity. In this figure, we show the assembly-code representation of the instructions on the left and the byte encodings on the right. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003B10"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3</span></a> shows further details of some of the instructions. The assembly-code format is similar to the ATT format for x86-64.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C87" id="P7000497027000000000000000041C87">Here are some details about the Y86-64 instructions.</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C88" id="P7000497027000000000000000041C88">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C89" id="P7000497027000000000000000041C89"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C8A" id="P7000497027000000000000000041C8A">The x86-64 <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C8B" id="P7000497027000000000000000041C8B">movq</code> instruction is split into four different instructions: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C8C" id="P7000497027000000000000000041C8C">irmovq, rrmovq, mrmovq</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C8D" id="P7000497027000000000000000041C8D">rmmovq</code>, explicitly indicating the form of the source and destination. The source is either immediate (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C8E" id="P7000497027000000000000000041C8E">i</code>), register (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C8F" id="P7000497027000000000000000041C8F">r</code>), or memory (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C90" id="P7000497027000000000000000041C90">m</code>). It is designated by the first character in the instruction name. The destination is either register (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C91" id="P7000497027000000000000000041C91">r</code>) or memory (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C92" id="P7000497027000000000000000041C92">m</code>). It is designated by the second character in the instruction name. Explicitly identifying the four types of data transfer will prove helpful when we decide how to implement them.</p>
<p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter04.xhtml#P7000497027000000000000000041C93" id="P7000497027000000000000000041C93">The memory references for the two memory movement instructions have a simple base and displacement format. We do not support the second index register or any scaling of a register's value in the address computation.</p>
<p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter04.xhtml#P7000497027000000000000000041C94" id="P7000497027000000000000000041C94">As with x86-64, we do not allow direct transfers from one memory location to another. In addition, we do not allow a transfer of immediate data to memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041C95" id="P7000497027000000000000000041C95"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041C96" id="P7000497027000000000000000041C96">There are four integer operation instructions, shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a> as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C97" id="P7000497027000000000000000041C97">OPq.</code> These are <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C98" id="P7000497027000000000000000041C98">addq, subq, andq</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C99" id="P7000497027000000000000000041C99">xorq</code>. They operate only on register data, whereas x86-64 also allows operations on memory data. These instructions set the three condition codes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C9A" id="P7000497027000000000000000041C9A">ZF, SF</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041C9B" id="P7000497027000000000000000041C9B">OF</code> (zero, sign, and overflow).</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003ADE" id="P7000497027000000000000000003ADE">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003ADF" epub:type="pagebreak" id="P7000497027000000000000000003ADF" title="357"></span><img alt="A diagram shows instruction sets." class="pcalibre1 pcalibre2 pcalibre139" data-uri="P700049702700000000000000000B6CA" id="P7000497027000000000000000041C9C" src="Images/chapter-04-image-02.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041C9D" id="P7000497027000000000000000041C9D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041C9E" epub:type="title" id="P7000497027000000000000000041C9E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.2 </span>Y86-64 instruction set.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041C9F" id="P7000497027000000000000000041C9F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CA0" id="P7000497027000000000000000041CA0">Instruction encodings range between 1 and 10 bytes. An instruction consists of a 1-byte instruction specifier, possibly a 1 -byte register specifier, and possibly an 8-byte constant word. Field <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CA1" id="P7000497027000000000000000041CA1">fn</code> specifies a particular integer operation (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CA2" id="P7000497027000000000000000041CA2">OPq</code>), data movement condition (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CA3" id="P7000497027000000000000000041CA3">cmovXX</code>), or branch condition (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CA4" id="P7000497027000000000000000041CA4">jXX</code>). All numeric values are shown in hexadecimal.</p><p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter04.xhtml#P7000497027000000000000000041CA5" id="P7000497027000000000000000041CA5">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000021F86" id="P7000497027000000000000000021F86">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CA6" id="P7000497027000000000000000041CA6">A diagram shows instruction sets, as summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000041CA7" id="P7000497027000000000000000041CA7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CA8" id="P7000497027000000000000000041CA8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CA9" id="P7000497027000000000000000041CA9">Halt: 1 byte containing 0 and 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CAA" id="P7000497027000000000000000041CAA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CAB" id="P7000497027000000000000000041CAB">Nop: 1 byte containing 1 and 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CAC" id="P7000497027000000000000000041CAC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CAD" id="P7000497027000000000000000041CAD">Rrmovq rA, rB: 2 bytes containing 2 and 0 in the first and rA and rB in the second</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CAE" id="P7000497027000000000000000041CAE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CAF" id="P7000497027000000000000000041CAF">Irmovq V, rB: 10 bytes containing 3 and 0 in the first, F and rB in the second, and V in the last 8 bytes</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CB0" id="P7000497027000000000000000041CB0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CB1" id="P7000497027000000000000000041CB1">Rmmovq rA, D(rB): 10 bytes containing 4 and 0 in the first, rA and rB in the second, and D in the last 8</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CB2" id="P7000497027000000000000000041CB2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CB3" id="P7000497027000000000000000041CB3">Nrmovq D(rB), rA: 10 bytes containing 5 and 0 in the first, rA and rB in the second, and D in the last 8</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CB4" id="P7000497027000000000000000041CB4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CB5" id="P7000497027000000000000000041CB5">0Pq rA, rB: 2 bytes containing 6 and fn in the first and rA and rB in the second</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CB6" id="P7000497027000000000000000041CB6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CB7" id="P7000497027000000000000000041CB7">jXX Dest: 9 bytes containing 7 and fn in the first and Dest in the last 8</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CB8" id="P7000497027000000000000000041CB8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CB9" id="P7000497027000000000000000041CB9">cmovXX rA, rB: 2 bytes containing 2 and fn in the first and rA and rB in the second</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CBA" id="P7000497027000000000000000041CBA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CBB" id="P7000497027000000000000000041CBB">call Dest: 9 bytes containing 8 and 0 in the first and Dest in the last 8</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CBC" id="P7000497027000000000000000041CBC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CBD" id="P7000497027000000000000000041CBD">ret: 1 byte containing 9 and 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CBE" id="P7000497027000000000000000041CBE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CBF" id="P7000497027000000000000000041CBF">pushq rA: 2 bytes containing A and 0 in the first and rA and F in the second</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CC0" id="P7000497027000000000000000041CC0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CC1" id="P7000497027000000000000000041CC1">popq rA: 2 bytes containing B and 0 in the first and rA and F in the second</p></li>
</ul>
</details>
</figcaption>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CC2" id="P7000497027000000000000000041CC2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CC3" id="P7000497027000000000000000041CC3">The seven jump instructions (shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a> as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CC4" id="P7000497027000000000000000041CC4">jXX</code>) are <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CC5" id="P7000497027000000000000000041CC5">jmp, jle, jl, je, jne, jge</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CC6" id="P7000497027000000000000000041CC6">jg</code>. Branches are taken according to the type of branch and the settings of the condition codes. The branch conditions are the same as with x86-64 (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000244F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.15</span></a>).</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CC7" id="P7000497027000000000000000041CC7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CC8" id="P7000497027000000000000000041CC8">There are six conditional move instructions (shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a> as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CC9" id="P7000497027000000000000000041CC9">cmovXX): cmovle, cmovl, cmove, cmovne, cmovge</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CCA" id="P7000497027000000000000000041CCA">cmovg</code>. These have the same format as the register-register move instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CCB" id="P7000497027000000000000000041CCB">rrmovq</code>, but the destination register is updated only if the condition codes satisfy the required constraints.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CCC" id="P7000497027000000000000000041CCC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CCD" id="P7000497027000000000000000041CCD">The call instruction pushes the return address on the stack and jumps to the destination address. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CCE" id="P7000497027000000000000000041CCE">ret</code> instruction returns from such a call.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CCF" id="P7000497027000000000000000041CCF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CD0" id="P7000497027000000000000000041CD0">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CD1" id="P7000497027000000000000000041CD1">pushq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CD2" id="P7000497027000000000000000041CD2">popq</code> instructions implement push and pop, just as they do in x86-64.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CD3" id="P7000497027000000000000000041CD3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CD4" id="P7000497027000000000000000041CD4">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CD5" id="P7000497027000000000000000041CD5">halt</code> instruction stops instruction execution. x86-64 has a comparable instruction, called <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CD6" id="P7000497027000000000000000041CD6">hlt</code>. x86-64 application programs are not permitted to use <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003AFE" epub:type="pagebreak" id="P7000497027000000000000000003AFE" title="358"></span>this instruction, since it causes the entire system to suspend operation. For Y86-64, executing the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CD7" id="P7000497027000000000000000041CD7">halt</code> instruction causes the processor to stop, with the status code set to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CD8" id="P7000497027000000000000000041CD8">HLT</code>. (See <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003BB9"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.1.4</span></a>.)</p>
</li>
</ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003B01" id="P7000497027000000000000000003B01"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CD9" epub:type="title" id="P7000497027000000000000000041CD9"><span class="pcalibre1 pcalibre21 pcalibre2">4.1.3 </span>Instruction Encoding</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CDA" id="P7000497027000000000000000041CDA"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a> also shows the byte-level encoding of the instructions. Each instruction requires between 1 and 10 bytes, depending on which fields are required. Every instruction has an initial byte identifying the instruction type. This byte is split into two 4-bit parts: the high-order, or <i class="pcalibre17 pcalibre2 pcalibre1">code</i>, part, and the low-order, or <i class="pcalibre17 pcalibre2 pcalibre1">function</i>, part. As can be seen in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a>, code values range from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CDB" id="P7000497027000000000000000041CDB">0</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CDC" id="P7000497027000000000000000041CDC">0xB</code>. The function values are significant only for the cases where a group of related instructions share a common code. These are given in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003B10"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3</span></a>, showing the specific encodings of the integer operation, branch, and conditional move instructions. Observe that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CDD" id="P7000497027000000000000000041CDD">rrmovq</code> has the same instruction code as the conditional moves. It can be viewed as an "unconditional move" just as the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CDE" id="P7000497027000000000000000041CDE">jmp</code> instruction is an unconditional jump, both having function code <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CDF" id="P7000497027000000000000000041CDF">0</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CE0" id="P7000497027000000000000000041CE0">As shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003B18"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.4</span></a>, each of the 15 program registers has an associated <i class="pcalibre17 pcalibre2 pcalibre1">register identifier</i> (ID) ranging from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CE1" id="P7000497027000000000000000041CE1">0</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CE2" id="P7000497027000000000000000041CE2">0xE</code>. The numbering of registers in Y86-64 matches what is used in x86-64. The program registers are stored within the CPU in a <i class="pcalibre17 pcalibre2 pcalibre1">register file</i>, a small random access memory where the register IDs serve as addresses. ID value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CE3" id="P7000497027000000000000000041CE3">0xF</code> is used in the instruction encodings and within our hardware designs when we need to indicate that no register should be accessed.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CE4" id="P7000497027000000000000000041CE4">Some instructions are just 1 byte long, but those that require operands have longer encodings. First, there can be an additional <i class="pcalibre17 pcalibre2 pcalibre1">register specifier byte</i>, specifying either one or two registers. These register fields are called rA and rB in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a>. As the assembly-code versions of the instructions show, they can specify the registers used for data sources and destinations, as well as the base register used in an address computation, depending on the instruction type. Instructions that have no register operands, such as branches and call, do not have a register specifier byte. Those that require just one register operand (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CE5" id="P7000497027000000000000000041CE5">irmovq, pushq</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CE6" id="P7000497027000000000000000041CE6">popq</code>) have</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003B10" id="P7000497027000000000000000003B10">
<img alt="A diagram shows instructions sets of operations, branches, and moves." class="pcalibre1 pcalibre2 pcalibre140" data-uri="P700049702700000000000000000B6CB" id="P7000497027000000000000000041CE7" src="Images/chapter-04-image-03.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041CE8" id="P7000497027000000000000000041CE8"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041CE9" epub:type="title" id="P7000497027000000000000000041CE9"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.3 </span>Function codes for Y86-64 instruction set.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041CEA" id="P7000497027000000000000000041CEA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CEB" id="P7000497027000000000000000041CEB">The code specifies a particular integer operation, branch condition, or data transfer condition. These instructions are shown as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CEC" id="P7000497027000000000000000041CEC">0Pq, jXX</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CED" id="P7000497027000000000000000041CED">cmovXX</code> in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.2</span></a>.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000021FCF" id="P7000497027000000000000000021FCF">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041CEE" id="P7000497027000000000000000041CEE">A diagram shows sets of instructions, as summarized below.</p>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter04.xhtml#P7000497027000000000000000041CEF" id="P7000497027000000000000000041CEF">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CF0" id="P7000497027000000000000000041CF0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CF1" id="P7000497027000000000000000041CF1">Operations:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000041CF2" id="P7000497027000000000000000041CF2">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CF3" id="P7000497027000000000000000041CF3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CF4" id="P7000497027000000000000000041CF4">Addq: 6 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CF5" id="P7000497027000000000000000041CF5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CF6" id="P7000497027000000000000000041CF6">Aubq: 6 1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CF7" id="P7000497027000000000000000041CF7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CF8" id="P7000497027000000000000000041CF8">Andq: 6 2</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CF9" id="P7000497027000000000000000041CF9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CFA" id="P7000497027000000000000000041CFA">Xorq: 6 3</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CFB" id="P7000497027000000000000000041CFB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CFC" id="P7000497027000000000000000041CFC">Branches:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000041CFD" id="P7000497027000000000000000041CFD">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041CFE" id="P7000497027000000000000000041CFE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041CFF" id="P7000497027000000000000000041CFF">Jmp: 7 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D00" id="P7000497027000000000000000041D00"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D01" id="P7000497027000000000000000041D01">Jle: 7 1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D02" id="P7000497027000000000000000041D02"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D03" id="P7000497027000000000000000041D03">Jl: 7 2</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D04" id="P7000497027000000000000000041D04"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D05" id="P7000497027000000000000000041D05">Je: 7 3</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D06" id="P7000497027000000000000000041D06"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D07" id="P7000497027000000000000000041D07">Jne: 7 4</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D08" id="P7000497027000000000000000041D08"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D09" id="P7000497027000000000000000041D09">Jge: 7 5</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D0A" id="P7000497027000000000000000041D0A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D0B" id="P7000497027000000000000000041D0B">Jg: 7 6</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D0C" id="P7000497027000000000000000041D0C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D0D" id="P7000497027000000000000000041D0D">Moves:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000041D0E" id="P7000497027000000000000000041D0E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D0F" id="P7000497027000000000000000041D0F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D10" id="P7000497027000000000000000041D10">Rrmovq: 2 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D11" id="P7000497027000000000000000041D11"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D12" id="P7000497027000000000000000041D12">Cmovle: 2 1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D13" id="P7000497027000000000000000041D13"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D14" id="P7000497027000000000000000041D14">Cmovl: 2 2</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D15" id="P7000497027000000000000000041D15"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D16" id="P7000497027000000000000000041D16">Cmove: 2 3</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D17" id="P7000497027000000000000000041D17"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D18" id="P7000497027000000000000000041D18">Cmovne: 2 4</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D19" id="P7000497027000000000000000041D19"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D1A" id="P7000497027000000000000000041D1A">Cmovge: 2 5</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D1B" id="P7000497027000000000000000041D1B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D1C" id="P7000497027000000000000000041D1C">Cmovg: 2 6</p></li>
</ul></li>
</ol>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003B18" id="P7000497027000000000000000003B18">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000041D1D" id="P7000497027000000000000000041D1D">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041D1E" id="P7000497027000000000000000041D1E"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003B1B" epub:type="pagebreak" id="P7000497027000000000000000003B1B" title="359"></span>Number	</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041D1F" id="P7000497027000000000000000041D1F">Register name	</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041D20" id="P7000497027000000000000000041D20">Number	</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041D21" id="P7000497027000000000000000041D21">Register name</th></tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D22" id="P7000497027000000000000000041D22"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D23" id="P7000497027000000000000000041D23">0</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D24" id="P7000497027000000000000000041D24"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D25" id="P7000497027000000000000000041D25">	%rax</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D26" id="P7000497027000000000000000041D26"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D27" id="P7000497027000000000000000041D27">	8</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D28" id="P7000497027000000000000000041D28"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D29" id="P7000497027000000000000000041D29">	%r8</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D2A" id="P7000497027000000000000000041D2A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D2B" id="P7000497027000000000000000041D2B">1</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D2C" id="P7000497027000000000000000041D2C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D2D" id="P7000497027000000000000000041D2D">	%rcx</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D2E" id="P7000497027000000000000000041D2E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D2F" id="P7000497027000000000000000041D2F">	9</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D30" id="P7000497027000000000000000041D30"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D31" id="P7000497027000000000000000041D31">	%r9</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D32" id="P7000497027000000000000000041D32"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D33" id="P7000497027000000000000000041D33">2</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D34" id="P7000497027000000000000000041D34"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D35" id="P7000497027000000000000000041D35">	%rdx</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D36" id="P7000497027000000000000000041D36"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D37" id="P7000497027000000000000000041D37">	A</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D38" id="P7000497027000000000000000041D38"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D39" id="P7000497027000000000000000041D39">	%r10</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D3A" id="P7000497027000000000000000041D3A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D3B" id="P7000497027000000000000000041D3B">3</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D3C" id="P7000497027000000000000000041D3C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D3D" id="P7000497027000000000000000041D3D">	%rbx</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D3E" id="P7000497027000000000000000041D3E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D3F" id="P7000497027000000000000000041D3F">	B</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D40" id="P7000497027000000000000000041D40"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D41" id="P7000497027000000000000000041D41">	%r11</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D42" id="P7000497027000000000000000041D42"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D43" id="P7000497027000000000000000041D43">4</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D44" id="P7000497027000000000000000041D44"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D45" id="P7000497027000000000000000041D45">	%rsp</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D46" id="P7000497027000000000000000041D46"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D47" id="P7000497027000000000000000041D47">	C</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D48" id="P7000497027000000000000000041D48"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D49" id="P7000497027000000000000000041D49">	%.r12</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D4A" id="P7000497027000000000000000041D4A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D4B" id="P7000497027000000000000000041D4B">5</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D4C" id="P7000497027000000000000000041D4C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D4D" id="P7000497027000000000000000041D4D">	%rbp</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D4E" id="P7000497027000000000000000041D4E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D4F" id="P7000497027000000000000000041D4F">	D</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D50" id="P7000497027000000000000000041D50"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D51" id="P7000497027000000000000000041D51">	%r13</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D52" id="P7000497027000000000000000041D52"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D53" id="P7000497027000000000000000041D53">6</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D54" id="P7000497027000000000000000041D54"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D55" id="P7000497027000000000000000041D55">	%rsi</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D56" id="P7000497027000000000000000041D56"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D57" id="P7000497027000000000000000041D57">	E</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D58" id="P7000497027000000000000000041D58"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D59" id="P7000497027000000000000000041D59">	%r14</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D5A" id="P7000497027000000000000000041D5A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D5B" id="P7000497027000000000000000041D5B">7</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D5C" id="P7000497027000000000000000041D5C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D5D" id="P7000497027000000000000000041D5D">	%rdi</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D5E" id="P7000497027000000000000000041D5E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D5F" id="P7000497027000000000000000041D5F">	F</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D60" id="P7000497027000000000000000041D60">No register</td></tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041D61" id="P7000497027000000000000000041D61"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041D62" epub:type="title" id="P7000497027000000000000000041D62"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.4 </span>Y86-64 program register identifiers.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D63" id="P7000497027000000000000000041D63"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D64" id="P7000497027000000000000000041D64">Each of the 1 5 program registers has an associated identifier (ID) ranging from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D65" id="P7000497027000000000000000041D65">0</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D66" id="P7000497027000000000000000041D66">0xE</code>. ID <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D67" id="P7000497027000000000000000041D67">0xF</code> in a register field of an instruction indicates the absence of a register operand.</p></div>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D68" id="P7000497027000000000000000041D68">the other register specifier set to value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D69" id="P7000497027000000000000000041D69">0xF</code>. This convention will prove useful in our processor implementation.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D6A" id="P7000497027000000000000000041D6A">Some instructions require an additional 8-byte <i class="pcalibre17 pcalibre2 pcalibre1">constant word.</i> This word can serve as the immediate data for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D6B" id="P7000497027000000000000000041D6B">irmovq</code>, the displacement for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D6C" id="P7000497027000000000000000041D6C">rmmovq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D6D" id="P7000497027000000000000000041D6D">mrmovq</code> address specifiers, and the destination of branches and calls. Note that branch and call destinations are given as absolute addresses, rather than using the PC-relative addressing seen in x86-64. Processors use PC-relative addressing to give more compact encodings of branch instructions and to allow code to be shifted from one part of memory to another without the need to update all of the branch target addresses. Since we are more concerned with simplicity in our presentation, we use absolute addressing. As with x86-64, all integers have a little-endian encoding. When the instruction is written in disassembled form, these bytes appear in reverse order.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D6E" id="P7000497027000000000000000041D6E">As an example, let us generate the byte encoding of the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D6F" id="P7000497027000000000000000041D6F">rmmovq %rsp, 0x123456789abcd(%rdx)</code> in hexadecimal. From <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a>, we can see that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D70" id="P7000497027000000000000000041D70">rmmovq</code> has initial byte 40. We can also see that source register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D71" id="P7000497027000000000000000041D71">%rsp</code> should be encoded in the rA field, and base register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D72" id="P7000497027000000000000000041D72">%rdx</code> should be encoded in the rB field. Using the register numbers in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003B18"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.4</span></a>, we get a register specifier byte of 42. Finally, the displacement is encoded in the 8-byte constant word. We first pad <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D73" id="P7000497027000000000000000041D73">0x123456789abcd</code> with leading zeros to fill out 8 bytes, giving a byte sequence of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D74" id="P7000497027000000000000000041D74">00 0123 45 67 89 ab cd</code>. We write this in byte-reversed order as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D75" id="P7000497027000000000000000041D75">cd ab 89 67 45 23 01 00</code>. Combining these, we get an instruction encoding of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D76" id="P7000497027000000000000000041D76">4042cdab896745230100.</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D77" id="P7000497027000000000000000041D77">One important property of any instruction set is that the byte encodings must have a unique interpretation. An arbitrary sequence of bytes either encodes a unique instruction sequence or is not a legal byte sequence. This property holds for Y86-64, because every instruction has a unique combination of code and function in its initial byte, and given this byte, we can determine the length and meaning of any additional bytes. This property ensures that a processor can execute an object-code program without any ambiguity about the meaning of the code. Even if the code is embedded within other bytes in the program, we can readily determine</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003B75" id="P7000497027000000000000000003B75"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000041D78" epub:type="title" id="P7000497027000000000000000041D78"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003B77" epub:type="pagebreak" id="P7000497027000000000000000003B77" title="360"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Comparing x86-64 to Y86-64 instruction encodings</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D79" id="P7000497027000000000000000041D79">Compared with the instruction encodings
 used in x86-64, the encoding of Y86-64 is much simpler but also less compact. The register fields occur only in fixed positions in all Y86-64 instructions, whereas they are packed into various positions in the different x86-64 instructions. An x86-64 instruction can encode constant values in 1, 2, 4, or 8 bytes, whereas Y86-64 always requires 8 bytes.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D7A" id="P7000497027000000000000000041D7A">the instruction sequence as long as we start from the first byte in the sequence. On the other hand, if we do not know the starting position of a code sequence, we cannot reliably determine how to split the sequence into individual instructions. This causes problems for disassemblers and other tools that attempt to extract machine-level programs directly from object-code byte sequences.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003B7A" epub:type="practice" id="P7000497027000000000000000003B7A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D7B" epub:type="title" id="P7000497027000000000000000041D7B"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.1 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000045E1.xhtml#P7000497027000000000000000004690">480</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041D7C" id="P7000497027000000000000000041D7C">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041D7D" id="P7000497027000000000000000041D7D">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D7E" id="P7000497027000000000000000041D7E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D7F" id="P7000497027000000000000000041D7F">Determine the byte encoding of the Y86-64 instruction sequence that follows. The line <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D80" id="P7000497027000000000000000041D80">.pos 0x100</code> indicates that the starting address of the object code should be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D81" id="P7000497027000000000000000041D81">0x100.</code></p></div>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041D82" id="P7000497027000000000000000041D82"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D83" id="P7000497027000000000000000041D83">.pos 0x100 # Start code at address 0x100
	irmovq $15,%rbx
	rrmovq %rbx,%rcx
loop:
	rmmovq %rcx,-3(%rbx)
	addq %rbx, 7,rcx
	jmp loop
</code>
</pre>
</li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003B84" epub:type="practice" id="P7000497027000000000000000003B84"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D84" epub:type="title" id="P7000497027000000000000000041D84"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046B3">481</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041D85" id="P7000497027000000000000000041D85">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041D86" id="P7000497027000000000000000041D86">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D87" id="P7000497027000000000000000041D87"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D88" id="P7000497027000000000000000041D88">For each byte sequence listed, determine the Y86-64 instruction sequence it encodes. If there is some invalid byte in the sequence, show the instruction sequence up to that point and indicate where the invalid value occurs. For each sequence, we show the starting address, then a colon, and then the byte sequence.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D89" id="P7000497027000000000000000041D89">A. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D8A" id="P7000497027000000000000000041D8A">0x100: 30f3fcffffffffffffff40630008000000000000</code></p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D8B" id="P7000497027000000000000000041D8B">B. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D8C" id="P7000497027000000000000000041D8C">0x200: a06f800c020000000000000030f30a00000000000000</code></p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D8D" id="P7000497027000000000000000041D8D">C. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D8E" id="P7000497027000000000000000041D8E">0x300: 5054070000000000000010f0b01f</code></p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D8F" id="P7000497027000000000000000041D8F">D. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D90" id="P7000497027000000000000000041D90">0x400: 611373000400000000000000</code></p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041D91" id="P7000497027000000000000000041D91">E. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041D92" id="P7000497027000000000000000041D92">0x500: 6362a0f0</code></p>
</div>
</li>
</ol>
</section>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003B94" id="P7000497027000000000000000003B94"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000041D93" epub:type="title" id="P7000497027000000000000000041D93"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003B96" epub:type="pagebreak" id="P7000497027000000000000000003B96" title="361"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>RISC and CISC instruction sets</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041D94" id="P7000497027000000000000000041D94">x86-64 is sometimes labeled as a "complex instruction set computer" (CISC—pronounced "sisk"), and is deemed to be the opposite of ISAs that are classified as "reduced instruction set computers" (RISC—pronounced "risk"). Historically, CISC machines came first, having evolved from the earliest computers. By the early 1980s, instruction sets for mainframe and minicomputers had grown quite large, as machine designers incorporated new instructions to support high-level tasks, such as manipulating circular buffers, performing decimal arithmetic, and evaluating polynomials. The first microprocessors appeared in the early 1970s and had limited instruction sets, because the integrated-circuit technology then posed severe constraints on what could be implemented on a single chip. Microprocessors evolved quickly and, by the early 1980s, were following the same path of increasing instruction set complexity that had been the case for mainframes and minicomputers. The x86 family took this path, evolving into IA32, and more recently into x86-64. The x86 line continues to evolve as new classes of instructions are added based on the needs of emerging applications.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041D95" id="P7000497027000000000000000041D95">The RISC design philosophy developed in the early 1980s as an alternative to these trends. A group of hardware and compiler experts at IBM, strongly influenced by the ideas of IBM researcher John Cocke, recognized that they could generate efficient code for a much simpler form of instruction set. In fact, many of the high-level instructions that were being added to instruction sets were very difficult to generate with a compiler and were seldom used. A simpler instruction set could be implemented with much less hardware and could be organized in an efficient pipeline structure, similar to those described later in this chapter. IBM did not commercialize this idea until many years later, when it developed the Power and PowerPC ISAs.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041D96" id="P7000497027000000000000000041D96">The RISC concept was further developed by Professors David Patterson, of the University of California at Berkeley, and John Hennessy, of Stanford University. Patterson gave the name RISC to this new class of machines, and CISC to the existing class, since there had previously been no need to have a special designation for a nearly universal form of instruction set.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041D97" id="P7000497027000000000000000041D97">When comparing CISC with the original RISC instruction sets, we find the following general characteristics:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000041D98" id="P7000497027000000000000000041D98">
<thead class="pcalibre44 pcalibre2 pcalibre1"><tr class="pcalibre45 pcalibre1 pcalibre2"><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041D99" id="P7000497027000000000000000041D99">CISC	</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041D9A" id="P7000497027000000000000000041D9A">Early RISC</th></tr></thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D9B" id="P7000497027000000000000000041D9B">A large number of instructions. The Intel document describing the complete set of instructions <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B408">[51]</a> is over 1,200 pages long.</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D9C" id="P7000497027000000000000000041D9C">Many fewer instructions—typically less than 100.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D9D" id="P7000497027000000000000000041D9D">Some instructions with long execution times. These include instructions that copy an entire block from one part of memory to another and others that copy multiple registers to and from memory.</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D9E" id="P7000497027000000000000000041D9E">No instruction with a long execution time. Some early RISC machines did not even have an integer multiply instruction, requiring compilers to implement multiplication as a sequence of additions.</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041D9F" id="P7000497027000000000000000041D9F">Variable-size encodings. x86-64 instructions can range from 1 to 15 bytes.</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA0" id="P7000497027000000000000000041DA0">Fixed-length encodings. Typically all instructions are encoded as 4 bytes.</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA1" id="P7000497027000000000000000041DA1"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003BA5" epub:type="pagebreak" id="P7000497027000000000000000003BA5" title="362"></span>Multiple formats for specifying operands. In x86-64, a memory operand specifier can have many different combinations of displacement, base and index registers, and scale factors.</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA2" id="P7000497027000000000000000041DA2">Simple addressing formats. Typically just base and displacement addressing.</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA3" id="P7000497027000000000000000041DA3">Arithmetic and logical operations can be applied to both memory and register operands.</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA4" id="P7000497027000000000000000041DA4">Arithmetic and logical operations only use register operands. Memory referencing is only allowed by <i class="pcalibre17 pcalibre2 pcalibre1">load</i> instructions, reading from memory into a register, and <i class="pcalibre17 pcalibre2 pcalibre1">store</i> instructions, writing from a register to memory. This convention is referred to as a <i class="pcalibre17 pcalibre2 pcalibre1">load/store architecture.</i></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA5" id="P7000497027000000000000000041DA5">Implementation artifacts hidden from machine-level programs. The ISA provides a clean abstraction between programs and how they get executed.</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA6" id="P7000497027000000000000000041DA6">Implementation artifacts exposed to machine-level programs. Some RISC machines prohibit particular instruction sequences and have jumps that do not take effect until the following instruction is executed. The compiler is given the task of optimizing performance within these constraints.</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA7" id="P7000497027000000000000000041DA7">Condition codes. Special flags are set as a side effect of instructions and then used for conditional branch testing.</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA8" id="P7000497027000000000000000041DA8">No condition codes. Instead, explicit test instructions store the test results in normal registers for use in conditional evaluation.</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DA9" id="P7000497027000000000000000041DA9">Stack-intensive procedure linkage. The stack is used for procedure arguments and return addresses.</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DAA" id="P7000497027000000000000000041DAA">Register-intensive procedure linkage. Registers are used for procedure arguments and return addresses. Some procedures can thereby avoid any memory references. Typically, the processor has many more (up to 32) registers.</td></tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041DAB" id="P7000497027000000000000000041DAB">The Y86-64 instruction set includes attributes of both CISC and RISC instruction sets. On the CISC side, it has condition codes and variable-length instructions, and it uses the stack to store return addresses. On the RISC side, it uses a load/store architecture and a regular instruction encoding, and it passes procedure arguments through registers. It can be viewed as taking a CISC instruction set (x86) and simplifying it by applying some of the principles of RISC.</p>
</aside>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003BB0" id="P7000497027000000000000000003BB0"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000041DAC" epub:type="title" id="P7000497027000000000000000041DAC"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003BB2" epub:type="pagebreak" id="P7000497027000000000000000003BB2" title="363"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>The RISC versus CISC controversy</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041DAD" id="P7000497027000000000000000041DAD">Through the 1980s, battles raged in the computer architecture community regarding the merits of RISC versus CISC instruction sets. Proponents of RISC claimed they could get more computing power for a given amount of hardware through a combination of streamlined instruction set design, advanced compiler technology, and pipelined processor implementation. CISC proponents countered that fewer CISC instructions were required to perform a given task, and so their machines could achieve higher overall performance.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041DAE" id="P7000497027000000000000000041DAE">Major companies introduced RISC processor lines, including Sun Microsystems (SPARC), IBM and Motorola (PowerPC), and Digital Equipment Corporation (Alpha). A British company, Acorn Computers Ltd., developed its own architecture, ARM (originally an acronym for "Acorn RISC machine"), which has become widely used in embedded applications, such as cell phones.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041DAF" id="P7000497027000000000000000041DAF">In the early 1990s, the debate diminished as it became clear that neither RISC nor CISC in their purest forms were better than designs that incorporated the best ideas of both. RISC machines evolved and introduced more instructions, many of which take multiple cycles to execute. RISC machines today have hundreds of instructions in their repertoire, hardly fitting the name "reduced instruction set machine." The idea of exposing implementation artifacts to machine-level programs proved to be shortsighted. As new processor models were developed using more advanced hardware structures, many of these artifacts became irrelevant, but they still remained part of the instruction set. Still, the core of RISC design is an instruction set that is well suited to execution on a pipelined machine.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041DB0" id="P7000497027000000000000000041DB0">More recent CISC machines also take advantage of high-performance pipeline structures. As we will discuss in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004B6C.xhtml#P7000497027000000000000000004B6C"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">5.7</span></a>, they fetch the CISC instructions and dynamically translate them into a sequence of simpler, RISC-like operations. For example, an instruction that adds a register to memory is translated into three operations: one to read the original memory value, one to perform the addition, and a third to write the sum to memory. Since the dynamic translation can generally be performed well in advance of the actual instruction execution, the processor can sustain a very high execution rate.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041DB1" id="P7000497027000000000000000041DB1">Marketing issues, apart from technological ones, have also played a major role in determining the success of different instruction sets. By maintaining compatibility with its existing processors, Intel with x86 made it easy to keep moving from one generation of processor to the next. As integrated-circuit technology improved, Intel and other x86 processor manufacturers could overcome the inefficiencies created by the original 8086 instruction set design, using RISC techniques to produce performance comparable to the best RISC machines. As we saw in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001E06.xhtml#P7000497027000000000000000001E06"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1</span></a>, the evolution of IA32 into x86-64 provided an opportunity to incorporate several features of RISC into the x86 family. In the areas of desktop, laptop, and server-based computing, x86 has achieved near total domination.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041DB2" id="P7000497027000000000000000041DB2">RISC processors have done very well in the market for <i class="pcalibre17 pcalibre2 pcalibre1">embedded processors</i>, controlling such systems as cellular telephones, automobile brakes, and Internet appliances. In these applications, saving on cost and power is more important than maintaining backward compatibility. In terms of the number of processors sold, this is a very large and growing market.</p>
</aside>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003BB9" id="P7000497027000000000000000003BB9"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DB3" epub:type="title" id="P7000497027000000000000000041DB3"><span class="pcalibre1 pcalibre21 pcalibre2">4.1.4 </span>Y86-64 Exceptions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DB4" id="P7000497027000000000000000041DB4">The programmer-visible state for Y86-64 (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003ABC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.1</span></a>) includes a status code Stat describing the overall state of the executing program. The possible values for this code are shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003BBD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5</span></a>. Code value 1, named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DB5" id="P7000497027000000000000000041DB5">AOK</code>, indicates that the program</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003BBD" id="P7000497027000000000000000003BBD">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000041DB6" id="P7000497027000000000000000041DB6">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2"><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041DB7" id="P7000497027000000000000000041DB7"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003BC0" epub:type="pagebreak" id="P7000497027000000000000000003BC0" title="364"></span>Value</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041DB8" id="P7000497027000000000000000041DB8">Name</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041DB9" id="P7000497027000000000000000041DB9">Meaning</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DBA" id="P7000497027000000000000000041DBA">1</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DBB" id="P7000497027000000000000000041DBB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DBC" id="P7000497027000000000000000041DBC">AOK</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DBD" id="P7000497027000000000000000041DBD">Normal operation</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DBE" id="P7000497027000000000000000041DBE">2</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DBF" id="P7000497027000000000000000041DBF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DC0" id="P7000497027000000000000000041DC0">HLT</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DC1" id="P7000497027000000000000000041DC1">halt instruction encountered</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DC2" id="P7000497027000000000000000041DC2">3</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DC3" id="P7000497027000000000000000041DC3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DC4" id="P7000497027000000000000000041DC4">ADR</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DC5" id="P7000497027000000000000000041DC5">Invalid address encountered</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DC6" id="P7000497027000000000000000041DC6">4</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DC7" id="P7000497027000000000000000041DC7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DC8" id="P7000497027000000000000000041DC8">INS</code></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041DC9" id="P7000497027000000000000000041DC9">Invalid instruction encountered</td></tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041DCA" id="P7000497027000000000000000041DCA"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041DCB" epub:type="title" id="P7000497027000000000000000041DCB"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.5 </span>Y86-64 status codes.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DCC" id="P7000497027000000000000000041DCC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041DCD" id="P7000497027000000000000000041DCD">In our design, the processor halts for any code other than <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DCE" id="P7000497027000000000000000041DCE">AOK</code>.</p></div>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DCF" id="P7000497027000000000000000041DCF">is executing normally, while the other codes indicate that some type of <i class="pcalibre17 pcalibre2 pcalibre1">exception</i> has occurred. Code 2, named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DD0" id="P7000497027000000000000000041DD0">HL</code>T, indicates that the processor has executed a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DD1" id="P7000497027000000000000000041DD1">halt</code> instruction. Code 3, named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DD2" id="P7000497027000000000000000041DD2">ADR</code>, indicates that the processor attempted to read from or write to an invalid memory address, either while fetching an instruction or while reading or writing data. We limit the maximum address (the exact limit varies by implementation), and any access to an address beyond this limit will trigger an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DD3" id="P7000497027000000000000000041DD3">ADR</code> exception. Code 4, named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DD4" id="P7000497027000000000000000041DD4">INS</code>, indicates that an invalid instruction code has been encountered.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DD5" id="P7000497027000000000000000041DD5">For Y86-64, we will simply have the processor stop executing instructions when it encounters any of the exceptions listed. In a more complete design, the processor would typically invoke an <i class="pcalibre17 pcalibre2 pcalibre1">exception handler</i>, a procedure designated to handle the specific type of exception encountered. As described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000666E.xhtml#P700049702700000000000000000666E"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">8</span></a>, exception handlers can be configured to have different effects, such as aborting the program or invoking a user-defined <i class="pcalibre17 pcalibre2 pcalibre1">signal handler.</i></p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003BDF" id="P7000497027000000000000000003BDF"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DD6" epub:type="title" id="P7000497027000000000000000041DD6"><span class="pcalibre1 pcalibre21 pcalibre2">4.1.5 </span>Y86-64 Programs</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DD7" id="P7000497027000000000000000041DD7"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003BE8"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.6</span></a> shows x86-64 and Y86-64 assembly code for the following C function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041DD8" id="P7000497027000000000000000041DD8">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DD9" id="P7000497027000000000000000041DD9">1	long sum(long *start, long count)
2	{
3	long sum = 0;
4	while (count) {
5	sum += *start;
6	start ++;
7	count--;
8	&gt;
9	return sum;
10	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DDA" id="P7000497027000000000000000041DDA">The x86-64 code was generated by the <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>compiler. The Y86-64 code is similar, but with the following differences:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DDB" id="P7000497027000000000000000041DDB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041DDC" id="P7000497027000000000000000041DDC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041DDD" id="P7000497027000000000000000041DDD">The Y86-64 code loads constants into registers (lines 2-3), since it cannot use immediate data in arithmetic instructions.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003BE8" id="P7000497027000000000000000003BE8">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041DDE" id="P7000497027000000000000000041DDE"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003BEA" epub:type="pagebreak" id="P7000497027000000000000000003BEA" title="365"></span>x86-64 code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041DDF" id="P7000497027000000000000000041DDF">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DE0" id="P7000497027000000000000000041DE0">	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">long sum(long * start, long count)
	start in %rdi, count in %rsi</i></b>
1	sum:
2	movl	$0, %eax	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">sum = 0</i></b>
3	jmp	.L2		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Goto test</i></b>
4	.L3:		    <b class="pcalibre1 pcalibre2 pcalibre12">loop:</b>
5	addq	(%rdi), %rax	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Add *start to sum</i></b>
6	addq $8, %rdi		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">start ++</i></b>
7	subq	$1, %rsi	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">count</i>--</b>
8	.L2:		    <b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">test:</i></b>
9	testq	%rsi, %rsi	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Test sum</i></b>
10	jne	.L3		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">If ! = 0, goto</i> loop</b>
11	rep;	ret		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Return</i></b></code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041DE1" id="P7000497027000000000000000041DE1">Y86-64 code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041DE2" id="P7000497027000000000000000041DE2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DE3" id="P7000497027000000000000000041DE3">	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">long sum(long * start, long count)
	start in %rdi, count in %rsi</i></b>
1	sum:
2	irmovq	$8,% r8		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Constant 8</i></b>
3	irmovq	$1,%r9		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Constant 1</i></b>
4	xorq	%rax,%rax	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">sum = 0</i></b>
5	andq	%rsi,%rsi	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Set CC</i></b>
6	jmp	test		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Go to test</i></b>
7	loop:
8	mrmovq	(%rdi),%r10	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Get *start</i></b>
9	addq %r10,%rax		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Add to sum</i></b>
10	addq	%r8,%rdi	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">start++</i></b>
11	subq	%r9,%rsi	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">count--. Set CC</i></b>
12	test:
13	jne	loop		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Stop when 0</i></b>
14	ret			<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Return</i></b>
</code>
</pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041DE4" id="P7000497027000000000000000041DE4"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041DE5" epub:type="title" id="P7000497027000000000000000041DE5"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.6 </span>Comparison of Y86-64 and x86-64 assembly programs.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DE6" id="P7000497027000000000000000041DE6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041DE7" id="P7000497027000000000000000041DE7">The sum function computes the sum of an integer array. The Y86-64 code follows the same general pattern as the x86-64 code.</p></div></figcaption>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041DE8" id="P7000497027000000000000000041DE8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041DE9" id="P7000497027000000000000000041DE9"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003BF6" epub:type="pagebreak" id="P7000497027000000000000000003BF6" title="366"></span>The Y86-64 code requires two instructions (lines 8-9) to read a value from memory and add it to a register, whereas the x86-64 code can do this with a single <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DEA" id="P7000497027000000000000000041DEA">addq</code> instruction (line 5).</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041DEB" id="P7000497027000000000000000041DEB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041DEC" id="P7000497027000000000000000041DEC">Our hand-coded Y86-64 implementation takes advantage of the property that the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DED" id="P7000497027000000000000000041DED">subq</code> instruction (line 11) also sets the condition codes, and so the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DEE" id="P7000497027000000000000000041DEE">testq</code> instruction of the <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>-generated code (line 9) is not required. For this to work, though, the Y86-64 code must set the condition codes prior to entering the loop with an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DEF" id="P7000497027000000000000000041DEF">andq</code> instruction (line 5).</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DF0" id="P7000497027000000000000000041DF0"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003C09"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.7</span></a> shows an example of a complete program file written in Y86-64 assembly code. The program contains both data and instructions. Directives indicate where to place code or data and how to align it. The program specifies issues such as stack placement, data initialization, program initialization, and program termination.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DF1" id="P7000497027000000000000000041DF1">In this program, words beginning with `.' are <i class="pcalibre17 pcalibre2 pcalibre1">assembler directives</i> telling the assembler to adjust the address at which it is generating code or to insert some words of data. The directive .<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DF2" id="P7000497027000000000000000041DF2">pos 0</code> (line 2) indicates that the assembler should begin generating code starting at address 0. This is the starting address for all Y86-64 programs. The next instruction (line 3) initializes the stack pointer. We can see that the label stack is declared at the end of the program (line 40), to indicate address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DF3" id="P7000497027000000000000000041DF3">0x200</code> using a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DF4" id="P7000497027000000000000000041DF4">.pos</code> directive (line 39). Our stack will therefore start at this address and grow toward lower addresses. We must ensure that the stack does not grow so large that it overwrites the code or other program data.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DF5" id="P7000497027000000000000000041DF5">Lines 8 to 13 of the program declare an array of four words, having the values</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041DF6" id="P7000497027000000000000000041DF6">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DF7" id="P7000497027000000000000000041DF7">0x000d000d000d000d, 0x00c000c000c000c0,
0x0b000b000b000b00, 0xa000a000a000a000
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DF8" id="P7000497027000000000000000041DF8">The label array denotes the start of this array, and is aligned on an 8-byte boundary (using the .align directive). Lines 16 to 19 show a "main" procedure that calls the function sum on the four-word array and then halts.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DF9" id="P7000497027000000000000000041DF9">As this example shows, since our only tool for creating Y86-64 code is an assembler, the programmer must perform tasks we ordinarily delegate to the compiler, linker, and run-time system. Fortunately, we only do this for small programs, for which simple mechanisms suffice.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DFA" id="P7000497027000000000000000041DFA"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003C11"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.8</span></a> shows the result of assembling the code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003C09"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.7</span></a> by an assembler we call <span class="pcalibre1 pcalibre29 pcalibre2">yas. </span>The assembler output is in ASCII format to make it more readable. On lines of the assembly file that contain instructions or data, the object code contains an address, followed by the values of between 1 and 10 bytes.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DFB" id="P7000497027000000000000000041DFB">We have implemented an <i class="pcalibre17 pcalibre2 pcalibre1">instruction set simulator</i> we call <span class="pcalibre1 pcalibre29 pcalibre2">yis</span>, the purpose of which is to model the execution of a Y86-64 machine-code program without attempting to model the behavior of any specific processor implementation. This form of simulation is useful for debugging programs before actual hardware is available, and for checking the result of either simulating the hardware or running</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003C09" id="P7000497027000000000000000003C09">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041DFC" id="P7000497027000000000000000041DFC">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041DFD" id="P7000497027000000000000000041DFD"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003C0C" epub:type="pagebreak" id="P7000497027000000000000000003C0C" title="367"></span>1	# Execution begins at address 0
2	    .pos 0
3	    irmovq stack, %rsp	# Set up stack pointer
4	    call main		# Execute main program
5	    halt		# Terminate program
6	
7	# Array of 4 elements
8	    .align 8
9	array :
10	    .quad 0x000d000d000d
11	    .quad 0x00c000c000c0
12	    .quad 0x0b000b000b00
13	    .quad 0xa000a000a000
14	
15	main:
16	    irmovq array,%rdi
17	    irmovq $4,%rsi
18	    call sum		# sum(array, 4)
19	    ret
20	
21	# long sum(long *start, long count)
22	# start in %rdi, count in %rsi
23	sum:
24	    irmovq $8,%r8	# Constant 8
25	    irmovq $1,%r9	# Constant 1
26	    xorq %rax/Zrax	# sum = 0
27	    andq %rsi,%rsi	# Set CC
28	    jmp test		# Goto test
29	loop :
30	    mrmovq (%rdi),%r10	# Get *start
31	    addq %r10,%rax	# Add to sum
32	    addq %r8,%rdi	# start++
33	    subq %r9,%rsi	# count--. Set CC
34	test:
35	    jne loop		# Stop when 0
36	    ret			# Return
37	
38	# Stack starts here and grows to lower addresses
39	    .pos 0x200
40	stack:
</code>
</pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041DFE" id="P7000497027000000000000000041DFE"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041DFF" epub:type="title" id="P7000497027000000000000000041DFF"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.7 </span>Sample program written in Y86-64 assembly code.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E00" id="P7000497027000000000000000041E00"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E01" id="P7000497027000000000000000041E01">The sum function is called to compute the sum of a four-element array.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E02" id="P7000497027000000000000000041E02">
</p></div>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003C11" id="P7000497027000000000000000003C11">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E03" id="P7000497027000000000000000041E03"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E04" id="P7000497027000000000000000041E04"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003C14" epub:type="pagebreak" id="P7000497027000000000000000003C14" title="368"></span>					| # Execution begins at address 0
0x000:					| .pos 0
0x000: 30f40002000000000000		| irmovq stack, %rsp # Set up stack pointer
0x00a: 803800000000000000		| call main # Execute main program
0x013: 00				| halt # Terminate program
					| # Array of 4 elements
0x018:					| .align 8
0x018:					| array:
0x018: 0d000d000d000000			| .quad 0x000d000d000d
0x020: c000c000c0000000			| .quad 0x00c000c000c0
0x028: 000b000b000b0000			| .quad 0x0b000b000b00
0x030: 00a000a000a00000			| .quad 0xa000a000a000
0x038:					| main:
0x038: 30f71800000000000000		| irmovq array,%rdi
0x042: 30f60400000000000000		| irmovq $4,%rsi
0x04c: 805600000000000000		| call sum # sum(array, 4)
0x055: 90				| ret
					| # long sum(long *start, long count)
					| # start in %rdi, count in %rsi
0x056 :					| sum :
0x056: 30f80800000000000000		| irmovq $8,%r8 # Constant 8
0x060: 30f90100000000000000		| irmovq $l,%r9 # Constant 1
0x06a: 6300				| xorq %rax,7,rax # sum = 0
0x06c: 6266				| andq %rsi, %rsi # Set CC
0x06e: 708700000000000000		| jmp test # Goto test
0x077:					| loop:
0x077: 50a70000000000000000		| mrmovq (%rdi),%10 # Get *start
0x081: 60a0				| addq %r10,%rax # Add to sum
0x083: 6087				| addq %r8,%rdi # start++
0x085: 6196				| subq %r9,%rsi # count--. Set CC
0x087:					| test:
0x087: 747700000000000000		| jne loop # Stop when 0
0x090: 90				| ret # Return
					| # Stack starts here and grows to lower addresses
0x200:					| .pos 0x200
0x200:					| stack:
</code>
</pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041E05" id="P7000497027000000000000000041E05"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041E06" epub:type="title" id="P7000497027000000000000000041E06"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.8 </span>Output of <span class="pcalibre1 pcalibre2 pcalibre84">yas </span>assembler.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E07" id="P7000497027000000000000000041E07"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E08" id="P7000497027000000000000000041E08">Each line includes a hexadecimal address and between 1 and 10 bytes of object code.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E09" id="P7000497027000000000000000041E09">
</p></div>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E0A" id="P7000497027000000000000000041E0A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003C1A" epub:type="pagebreak" id="P7000497027000000000000000003C1A" title="369"></span>the program on the hardware itself. Running on our sample object code, <span class="pcalibre1 pcalibre29 pcalibre2">yis </span>generates the following output:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E0B" id="P7000497027000000000000000041E0B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E0C" id="P7000497027000000000000000041E0C">Stopped in 34 steps at PC = 0x13. Status `HLT', CC Z=l S=0 0=0
Changes to registers:
%rax:	0x0000000000000000	0x0000abcdabcdabcd
%rsp:	0x0000000000000000	0x0000000000000200
%rdi:	0x0000000000000000	0x0000000000000038
%r8:	0x0000000000000000	0x0000000000000008
%r9:	0x0000000000000000	0x0000000000000001
%r10:	0x0000000000000000	0x0000a000a000a000
Changes to memory:
0x0lf0:	0x0000000000000000	0x0000000000000055
0x01f8:	0x0000000000000000	0x0000000000000013
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E0D" id="P7000497027000000000000000041E0D">The first line of the simulation output summarizes the execution and the resulting values of the PC and program status. In printing register and memory values, it only prints out words that change during simulation, either in registers or in memory. The original values (here they are all zero) are shown on the left, and the final values are shown on the right. We can see in this output that register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E0E" id="P7000497027000000000000000041E0E">%rax</code> contains <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E0F" id="P7000497027000000000000000041E0F">0xabcdabcdabcdabcd</code>, the sum of the 4-element array passed to procedure sum. In addition, we can see that the stack, which starts at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E10" id="P7000497027000000000000000041E10">0x200</code> and grows toward lower addresses, has been used, causing changes to words of memory at addresses <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E11" id="P7000497027000000000000000041E11">0x1f0-0x1f8</code>. The maximum address for executable code is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E12" id="P7000497027000000000000000041E12">0x090</code>, and so the pushing and popping of values on the stack did not corrupt the executable code.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003C23" id="P7000497027000000000000000003C23"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E13" epub:type="title" id="P7000497027000000000000000041E13"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046D8">482</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E14" id="P7000497027000000000000000041E14">One common pattern in machine-level programs is to add a constant value to a register. With the Y86-64 instructions presented thus far, this requires first using an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E15" id="P7000497027000000000000000041E15">irmovq</code> instruction to set a register to the constant, and then an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E16" id="P7000497027000000000000000041E16">addq</code> instruction to add this value to the destination register. Suppose we want to add a new instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E17" id="P7000497027000000000000000041E17">iaddq</code> with the following format:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003C29" id="P7000497027000000000000000003C29">
<img alt="A diagram illustrates the 10-byte instructions for iaddq V, rB with C and 0 in the first byte, F and rB in the second, and V in the last 8 bytes." class="pcalibre1 pcalibre2 pcalibre142" data-uri="P700049702700000000000000000B6CC" id="P7000497027000000000000000041E18" src="Images/chapter-04-image-04.png"/>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E19" id="P7000497027000000000000000041E19">This instruction adds the constant value V to register rB.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E1A" id="P7000497027000000000000000041E1A">Rewrite the Y86-64 <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E1B" id="P7000497027000000000000000041E1B">sum</code> function of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003BE8"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.6</span></a> to make use of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E1C" id="P7000497027000000000000000041E1C">iaddq</code> instruction. In the original version, we dedicated registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E1D" id="P7000497027000000000000000041E1D">%r8</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E1E" id="P7000497027000000000000000041E1E">%r9</code> to hold constant values. Now, we can avoid using those registers altogether.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003C31" epub:type="practice" id="P7000497027000000000000000003C31"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E1F" epub:type="title" id="P7000497027000000000000000041E1F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003C33" epub:type="pagebreak" id="P7000497027000000000000000003C33" title="370"></span><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.4 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046D8">482</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041E20" id="P7000497027000000000000000041E20">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041E21" id="P7000497027000000000000000041E21">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041E22" id="P7000497027000000000000000041E22"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E23" id="P7000497027000000000000000041E23">Write Y86-64 code to implement a recursive sum function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E24" id="P7000497027000000000000000041E24">rsum</code>, based on the following C code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E25" id="P7000497027000000000000000041E25"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E26" id="P7000497027000000000000000041E26">long rsum(long *start, long count)
{
if (count &lt;= 0)
	return 0;
return *start + rsum(start+l, count-1);
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E27" id="P7000497027000000000000000041E27">Use the same argument passing and register saving conventions as x86-64 code does. You might find it helpful to compile the C code on an x86-64 machine and then translate the instructions to Y86-64.</p>
</div>
</li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003C3C" epub:type="practice" id="P7000497027000000000000000003C3C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E28" epub:type="title" id="P7000497027000000000000000041E28"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046E7">483</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041E29" id="P7000497027000000000000000041E29">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041E2A" id="P7000497027000000000000000041E2A">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041E2B" id="P7000497027000000000000000041E2B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E2C" id="P7000497027000000000000000041E2C">Modify the Y86-64 code for the sum function (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003BE8"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.6</span></a>) to implement a function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E2D" id="P7000497027000000000000000041E2D">absSum</code> that computes the sum of absolute values of an array. Use a <i class="pcalibre17 pcalibre2 pcalibre1">conditional jump</i> instruction within your inner loop.</p></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003C43" epub:type="practice" id="P7000497027000000000000000003C43"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E2E" epub:type="title" id="P7000497027000000000000000041E2E"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.6 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046E7">483</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041E2F" id="P7000497027000000000000000041E2F">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041E30" id="P7000497027000000000000000041E30">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041E31" id="P7000497027000000000000000041E31"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E32" id="P7000497027000000000000000041E32">Modify the Y86-64 code for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E33" id="P7000497027000000000000000041E33">sum</code> function (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003BE8"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.6</span></a>) to implement a function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E34" id="P7000497027000000000000000041E34">absSum</code> that computes the sum of absolute values of an array. Use a <i class="pcalibre17 pcalibre2 pcalibre1">conditional move</i> instruction within your inner loop.</p></div>
</li>
</ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003C4B" id="P7000497027000000000000000003C4B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E35" epub:type="title" id="P7000497027000000000000000041E35"><span class="pcalibre1 pcalibre21 pcalibre2">4.1.6 </span>Some Y86-64 Instruction Details</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E36" id="P7000497027000000000000000041E36">Most Y86-64 instructions transform the program state in a straightforward manner, and so defining the intended effect of each instruction is not difficult. Two unusual instruction combinations, however, require special attention.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E37" id="P7000497027000000000000000041E37">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E38" id="P7000497027000000000000000041E38">pushq</code> instruction both decrements the stack pointer by 8 and writes a register value to memory. It is therefore not totally clear what the processor should do when executing the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E39" id="P7000497027000000000000000041E39">pushq %rsp</code>, since the register being pushed is being changed by the same instruction. Two different conventions are possible: (1) push the original value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E3A" id="P7000497027000000000000000041E3A">%rsp</code>, or (2) push the decremented value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E3B" id="P7000497027000000000000000041E3B">%rsp</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E3C" id="P7000497027000000000000000041E3C">For the Y86-64 processor, let us adopt the same convention as is used with x86-64, as determined in the following problem.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003C54" epub:type="practice" id="P7000497027000000000000000003C54"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E3D" epub:type="title" id="P7000497027000000000000000041E3D"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.7 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046F2">484</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041E3E" id="P7000497027000000000000000041E3E">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041E3F" id="P7000497027000000000000000041E3F">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041E40" id="P7000497027000000000000000041E40"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E41" id="P7000497027000000000000000041E41">Let us determine the behavior of the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E42" id="P7000497027000000000000000041E42">pushq %rsp</code> for an x86-64 processor. We could try reading the Intel documentation on this instruction, but a <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003C5B" epub:type="pagebreak" id="P7000497027000000000000000003C5B" title="371"></span>simpler approach is to conduct an experiment on an actual machine. The C compiler would not normally generate this instruction, so we must use hand-generated assembly code for this task. Here is a test function we have written (Web Aside <span class="pcalibre1 pcalibre29 pcalibre2">asm:easm </span>on page 178 describes how to write programs that combine C code with handwritten assembly code):</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E43" id="P7000497027000000000000000041E43"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E44" id="P7000497027000000000000000041E44">1	.text
2	.globl pushtest
3	pushtest:
4	movq	%rsp, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Copy stack pointer</i>
5	pushq	%rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Push stack pointer</i>
6	Popd	%rdx	<i class="pcalibre17 pcalibre2 pcalibre1">Pop it back</i>
7	subq %rdx, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Return 0 or 4</i>
8	ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E45" id="P7000497027000000000000000041E45">In our experiments, we find that function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E46" id="P7000497027000000000000000041E46">pushtest</code> always returns 0. What does this imply about the behavior of the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E47" id="P7000497027000000000000000041E47">pushq %rsp</code> under x86-64?</p></div></li></ol>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E48" id="P7000497027000000000000000041E48">A similar ambiguity occurs for the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E49" id="P7000497027000000000000000041E49">popq %rsp</code>. It could either set <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E4A" id="P7000497027000000000000000041E4A">%rsp</code> to the value read from memory or to the incremented stack pointer. As with <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003C54"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.7</span></a>, let us run an experiment to determine how an x86-64 machine would handle this instruction, and then design our Y86-64 machine to follow the same convention.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003C64" epub:type="practice" id="P7000497027000000000000000003C64"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E4B" epub:type="title" id="P7000497027000000000000000041E4B"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.8 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046F2">484</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041E4C" id="P7000497027000000000000000041E4C">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041E4D" id="P7000497027000000000000000041E4D">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041E4E" id="P7000497027000000000000000041E4E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E4F" id="P7000497027000000000000000041E4F">The following assembly-code function lets us determine the behavior of the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E50" id="P7000497027000000000000000041E50">popq %rsp</code> for x86-64:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E51" id="P7000497027000000000000000041E51"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E52" id="P7000497027000000000000000041E52">1	.text
2	.globl poptest
3	poptest:
4	movq	%rsp, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Save stack pointer</i>
5	pushq	$0xabcd	<i class="pcalibre17 pcalibre2 pcalibre1">Push test value</i>
6	popq	%rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Pop to stack pointer</i>
7	movq	%rsp, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Set popped value as return value</i>
8	movq	%rdi, %rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Restore stack pointer</i>
9	ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E53" id="P7000497027000000000000000041E53">We find this function always returns <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E54" id="P7000497027000000000000000041E54">0xabcd</code>. What does this imply about the behavior of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E55" id="P7000497027000000000000000041E55">popq%rsp?</code> What other Y86-64 instruction would have the exact same behavior?</p></div></li></ol>
</section>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003C70" id="P7000497027000000000000000003C70"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000041E56" epub:type="title" id="P7000497027000000000000000041E56"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003C72" epub:type="pagebreak" id="P7000497027000000000000000003C72" title="372"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Getting the details right: Inconsistencies across x86 models</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041E57" id="P7000497027000000000000000041E57"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003C54"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problems </span><span class="pcalibre1 pcalibre21 pcalibre2">4.7</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003C64"><span class="pcalibre1 pcalibre21 pcalibre2">4.8</span></a> are designed to help us devise a consistent set of conventions for instructions that push or pop the stack pointer. There seems to be little reason why one would want to perform either of these operations, and so a natural question to ask is, "Why worry about such picky details?"</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041E58" id="P7000497027000000000000000041E58">Several useful lessons can be learned about the importance of consistency from the following excerpt from the Intel documentation of the <span class="pcalibre1 pcalibre29 pcalibre2">push </span>instruction <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B408">[51]</a>:</p>
<div class="pcalibre1 pcalibre2 pcalibre90" data-uri="chapter04.xhtml#P7000497027000000000000000041E59" id="P7000497027000000000000000041E59">
<blockquote class="pcalibre88 pcalibre87 pcalibre91" data-uri="chapter04.xhtml#P7000497027000000000000000041E5A" id="P7000497027000000000000000041E5A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041E5B" id="P7000497027000000000000000041E5B">For IA-32 processors from the Intel 286 on, the PUSH ESP instruction pushes the value of the ESP register as it existed before the instruction was executed. (This is also true for Intel 64 architecture, real-address and virtual-8086 modes of IA-32 architecture.) For the Intel(r) 8086 processor, the PUSH SP instruction pushes the new value of the SP register (that is the value after it has been decremented by 2).</p>
</blockquote>
<div class="pcalibre1 pcalibre2 pcalibre92" data-uri="chapter04.xhtml#P7000497027000000000000000041E5C" id="P7000497027000000000000000041E5C"><p class="pcalibre1 pcalibre2 calibre15" data-uri="chapter04.xhtml#P7000497027000000000000000041E5D" id="P7000497027000000000000000041E5D">(PUSH ESP instruction. Intel Corporation. 50.)</p></div>
</div>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041E5E" id="P7000497027000000000000000041E5E">Although the exact details of this note may be difficult to follow, we can see that it states that, depending on what mode an x86 processor operates under, it will do different things when instructed to push the stack pointer register. Some modes push the original value, while others push the decremented value. (Interestingly, there is no corresponding ambiguity about popping to the stack pointer register.) There are two drawbacks to this inconsistency:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E5F" id="P7000497027000000000000000041E5F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E60" id="P7000497027000000000000000041E60"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E61" id="P7000497027000000000000000041E61">It decreases code portability. Programs may have different behavior depending on the processor mode. Although the particular instruction is not at all common, even the potential for incompatibility can have serious consequences.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E62" id="P7000497027000000000000000041E62"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E63" id="P7000497027000000000000000041E63">It complicates the documentation. As we see here, a special note is required to try to clarify the differences. The documentation for x86 is already complex enough without special cases such as this one.</p></li>
</ul>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E64" id="P7000497027000000000000000041E64">We conclude, therefore, that working out details in advance and striving for complete consistency can save a lot of trouble in the long run.</p>
</aside>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>4.2 Logic Design and the Hardware Control Language HCL</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000003C81"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041E65" epub:type="title" id="P7000497027000000000000000041E65"><span class="pcalibre1 pcalibre21 pcalibre2">4.2 </span>Logic Design and the Hardware Control Language HCL</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E66" id="P7000497027000000000000000041E66">In hardware design, electronic circuits are used to compute functions on bits and to store bits in different kinds of memory elements. Most contemporary circuit technology represents different bit values as high or low voltages on signal wires. In current technology, logic value 1 is represented by a high voltage of around 1.0 volt, while logic value 0 is represented by a low voltage of around 0.0 volts. Three major components are required to implement a digital system: <i class="pcalibre17 pcalibre2 pcalibre1">combinational logic</i> to compute functions on the bits, <i class="pcalibre17 pcalibre2 pcalibre1">memory elements</i> to store bits, and <i class="pcalibre17 pcalibre2 pcalibre1">clock signals</i> to regulate the updating of the memory elements.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E67" id="P7000497027000000000000000041E67">In this section, we provide a brief description of these different components. We also introduce HCL (for "hardware control language"), the language that we use to describe the control logic of the different processor designs. We only describe HCL informally here. A complete reference for HCL can be found in Web Aside <span class="pcalibre1 pcalibre29 pcalibre2">arch:hcl </span>on page 472.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003C85" id="P7000497027000000000000000003C85"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000041E68" epub:type="title" id="P7000497027000000000000000041E68"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003C87" epub:type="pagebreak" id="P7000497027000000000000000003C87" title="373"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Modern logic design</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041E69" id="P7000497027000000000000000041E69">At one time, hardware designers created circuit designs by drawing schematic diagrams of logic circuits (first with paper and pencil, and later with computer graphics terminals). Nowadays, most designs are expressed in a <i class="pcalibre17 pcalibre2 pcalibre1">hardware description language</i> (HDL), a textual notation that looks similar to a programming language but that is used to describe hardware structures rather than program behaviors. The most commonly used languages are Verilog, having a syntax similar to C, and VHDL, having a syntax similar to the Ada programming language. These languages were originally designed for creating simulation models of digital circuits. In the mid-1980s, researchers developed <i class="pcalibre17 pcalibre2 pcalibre1">logic synthesis</i> programs that could generate efficient circuit designs from HDL descriptions. There are now a number of commercial synthesis programs, and this has become the dominant technique for generating digital circuits. This shift from hand-designed circuits to synthesized ones can be likened to the shift from writing programs in assembly code to writing them in a high-level language and having a compiler generate the machine code.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E6A" id="P7000497027000000000000000041E6A">Our HCL language expresses only the control portions of a hardware design, with only a limited set of operations and with no modularity. As we will see, however, the control logic is the most difficult part of designing a microprocessor. We have developed tools that can directly translate HCL into Verilog, and by combining this code with Verilog code for the basic hardware units, we can generate HDL descriptions from which actual working microprocessors can be synthesized. By carefully separating out, designing, and testing the control logic, we can create a working microprocessor with reasonable effort. Web Aside <span class="pcalibre1 pcalibre29 pcalibre2">arch:vlog </span>on page 467 describes how we can generate Verilog versions of a Y86-64 processor.</p>
</aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003C8A" id="P7000497027000000000000000003C8A">
<img alt="A diagram illustrates three logic gate types." class="pcalibre1 pcalibre2 pcalibre143" data-uri="P700049702700000000000000000B6CD" id="P7000497027000000000000000041E6B" src="Images/chapter-04-image-05.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041E6C" id="P7000497027000000000000000041E6C"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041E6D" epub:type="title" id="P7000497027000000000000000041E6D"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.9 </span>Logic gate types.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041E6E" id="P7000497027000000000000000041E6E"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E6F" id="P7000497027000000000000000041E6F">Each gate generates output equal to some Boolean function of its inputs.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E70" id="P7000497027000000000000000041E70">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000022150" id="P7000497027000000000000000022150">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E71" id="P7000497027000000000000000041E71">The three logic gate types are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P7000497027000000000000000041E72" id="P7000497027000000000000000041E72">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E73" id="P7000497027000000000000000041E73"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E74" id="P7000497027000000000000000041E74">AND: round bullet shape with a and b on the left and out on the right, depicting out = a &amp;&amp; b</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E75" id="P7000497027000000000000000041E75"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E76" id="P7000497027000000000000000041E76">OR: pointing bullet shape with and b on the left and out on the right, depicting out = a | | b</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E77" id="P7000497027000000000000000041E77"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E78" id="P7000497027000000000000000041E78">NOT: triangle with a on the left and out on the right, depicting out = !a</p></li>
</ul>
</details>
</figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003C90" id="P7000497027000000000000000003C90"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E79" epub:type="title" id="P7000497027000000000000000041E79"><span class="pcalibre1 pcalibre21 pcalibre2">4.2.1 </span>Logic Gates</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E7A" id="P7000497027000000000000000041E7A">Logic gates are the basic computing elements for digital circuits. They generate an output equal to some Boolean function of the bit values at their inputs. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003C8A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.9</span></a> shows the standard symbols used for Boolean functions <span class="pcalibre1 pcalibre29 pcalibre2">and, or</span>, and <span class="pcalibre1 pcalibre29 pcalibre2">not. </span>HCL expressions are shown below the gates for the operators in C (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000002AD_split_001.xhtml#P70004970270000000000000000006AF"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">2.1.8</span></a>): <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E7B" id="P7000497027000000000000000041E7B">&amp;&amp;</code> for <span class="pcalibre1 pcalibre29 pcalibre2">and</span>, || for <span class="pcalibre1 pcalibre29 pcalibre2">or</span>, and ! for <span class="pcalibre1 pcalibre29 pcalibre2">not. </span>We use these instead of the bit-level C operators <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E7C" id="P7000497027000000000000000041E7C">&amp;</code>, |, and ~, because logic gates operate on single-bit quantities, not entire words. Although the figure illustrates only two-input versions of the <span class="pcalibre1 pcalibre29 pcalibre2">and </span>and <span class="pcalibre1 pcalibre29 pcalibre2">or </span>gates, it is common to see these being used as <var class="pcalibre17 pcalibre2 pcalibre1">n</var>-way operations for <var class="pcalibre17 pcalibre2 pcalibre1">n</var> &gt; 2. We still write these in HCL using binary operators, though, so the operation of a three-input <span class="pcalibre1 pcalibre29 pcalibre2">and </span>gate with inputs a, b, and c is described with the HCL expression a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E7D" id="P7000497027000000000000000041E7D">&amp;&amp;</code> b <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E7E" id="P7000497027000000000000000041E7E">&amp;&amp;</code> c.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E7F" id="P7000497027000000000000000041E7F">Logic gates are always active. If some input to a gate changes, then within some small amount of time, the output will change accordingly.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003C98" id="P7000497027000000000000000003C98">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003C99" epub:type="pagebreak" id="P7000497027000000000000000003C99" title="374"></span><img alt="A diagram illustrates a combination circuit." class="pcalibre1 pcalibre2 pcalibre144" data-uri="P700049702700000000000000000B6CE" id="P7000497027000000000000000041E80" src="Images/chapter-04-image-06.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041E81" id="P7000497027000000000000000041E81"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041E82" epub:type="title" id="P7000497027000000000000000041E82"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.10 </span>Combinational circuit to test for bit equality.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041E83" id="P7000497027000000000000000041E83"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E84" id="P7000497027000000000000000041E84">The output will equal 1 when both inputs are 0 or both are 1.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E85" id="P7000497027000000000000000041E85">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000022165" id="P7000497027000000000000000022165">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E86" id="P7000497027000000000000000041E86">A circuit has a and b on the left and eq on the right, with bit equal in between containing a circuit of logic gates. The bit equal has two AND gates leading to an OR gate, which leads to eq. A and B are each connected to the top AND gate and separate NOT gates, which are each connected to the bottom AND gate.</p>
</details>
</figcaption>
</figure>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003C9F" id="P7000497027000000000000000003C9F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E87" epub:type="title" id="P7000497027000000000000000041E87"><span class="pcalibre1 pcalibre21 pcalibre2">4.2.2 </span>Combinational Circuits and HCL Boolean Expressions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E88" id="P7000497027000000000000000041E88">By assembling a number of logic gates into a network, we can construct computational blocks known as <i class="pcalibre17 pcalibre2 pcalibre1">combinational circuits.</i> Several restrictions are placed on how the networks are constructed:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E89" id="P7000497027000000000000000041E89">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E8A" id="P7000497027000000000000000041E8A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E8B" id="P7000497027000000000000000041E8B">Every logic gate input must be connected to exactly one of the following: (1) one of the system inputs (known as a <i class="pcalibre17 pcalibre2 pcalibre1">primary input</i>), (2) the output connection of some memory element, or (3) the output of some logic gate.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E8C" id="P7000497027000000000000000041E8C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E8D" id="P7000497027000000000000000041E8D">The outputs of two or more logic gates cannot be connected together. Otherwise, the two could try to drive the wire toward different voltages, possibly causing an invalid voltage or a circuit malfunction.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E8E" id="P7000497027000000000000000041E8E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E8F" id="P7000497027000000000000000041E8F">The network must be <i class="pcalibre17 pcalibre2 pcalibre1">acyclic.</i> That is, there cannot be a path through a series of gates that forms a loop in the network. Such loops can cause ambiguity in the function computed by the network.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E90" id="P7000497027000000000000000041E90"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003C98"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.10</span></a> shows an example of a simple combinational circuit that we will find useful. It has two inputs, a and b. It generates a single output eq, such that the output will equal 1 if either a and b are both 1 (detected by the upper <span class="pcalibre1 pcalibre29 pcalibre2">and </span>gate) or are both 0 (detected by the lower <span class="pcalibre1 pcalibre29 pcalibre2">and </span>gate). We write the function of this network in HCL as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041E91" id="P7000497027000000000000000041E91"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E92" id="P7000497027000000000000000041E92">bool eq = (a &amp;&amp; b) || (!a &amp;&amp; !b);</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E93" id="P7000497027000000000000000041E93">This code simply defines the bit-level (denoted by data type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E94" id="P7000497027000000000000000041E94">bool</code>) signal eq as a function of inputs a and b. As this example shows, HCL uses C-style syntax, with `=' associating a signal name with an expression. Unlike C, however, we do not view this as performing a computation and assigning the result to some memory location. Instead, it is simply a way to give a name to an expression.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003CAE" id="P7000497027000000000000000003CAE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E95" epub:type="title" id="P7000497027000000000000000041E95"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.9 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046F2">484</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E96" id="P7000497027000000000000000041E96">Write an HCL expression for a signal <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E97" id="P7000497027000000000000000041E97">xor</code>, equal to the <span class="pcalibre1 pcalibre29 pcalibre2">exclusive-or </span>of inputs a and b. What is the relation between the signals <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E98" id="P7000497027000000000000000041E98">xor</code> and eq defined above?</p>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041E99" id="P7000497027000000000000000041E99"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CB4"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.11</span></a> shows another example of a simple but useful combinational circuit known as a <i class="pcalibre17 pcalibre2 pcalibre1">multiplexor</i> (commonly referred to as a "MUX"). A multiplexor</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003CB4" id="P7000497027000000000000000003CB4">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003CB5" epub:type="pagebreak" id="P7000497027000000000000000003CB5" title="375"></span><img alt="A diagram illustrates a multiplexor circuit." class="pcalibre1 pcalibre145 pcalibre2" data-uri="P700049702700000000000000000B6CF" id="P7000497027000000000000000041E9A" src="Images/chapter-04-image-07.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041E9B" id="P7000497027000000000000000041E9B"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041E9C" epub:type="title" id="P7000497027000000000000000041E9C"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.11 </span>Single-bit multiplexor circuit.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041E9D" id="P7000497027000000000000000041E9D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E9E" id="P7000497027000000000000000041E9E">The output will equal input a if the control signal s is 1 and will equal input b when s is 0.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P700049702700000000000000002217F" id="P700049702700000000000000002217F">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041E9F" id="P7000497027000000000000000041E9F">A circuit has a, b, and s on the left and out on the right, with bit MUX in between containing a circuit of logic gates. The bit MUX has two AND gates leading to an OR gate, which leads to out. S is connected to the bottom AND gate and a NOT gate connected to the top AND gate. A is connected to the bottom AND gate and B connected to the top AND gate.</p>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EA0" id="P7000497027000000000000000041EA0">selects a value from among a set of different data signals, depending on the value of a control input signal. In this single-bit multiplexor, the two data signals are the input bits a and b, while the control signal is the input bit s. The output will equal a when s is 1, and it will equal b when s is 0. In this circuit, we can see that the two <span class="pcalibre1 pcalibre29 pcalibre2">and </span>gates determine whether to pass their respective data inputs to the <span class="pcalibre1 pcalibre29 pcalibre2">or </span>gate. The upper <span class="pcalibre1 pcalibre29 pcalibre2">and </span>gate passes signal b when s is 0 (since the other input to the gate is !s), while the lower <span class="pcalibre1 pcalibre29 pcalibre2">and </span>gate passes signal a when s is 1. Again, we can write an HCL expression for the output signal, using the same operations as are present in the combinational circuit:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EA1" id="P7000497027000000000000000041EA1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EA2" id="P7000497027000000000000000041EA2">bool out = (s &amp;&amp; a) || (!s &amp;&amp; b);</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EA3" id="P7000497027000000000000000041EA3">Our HCL expressions demonstrate a clear parallel between combinational logic circuits and logical expressions in C. They both use Boolean operations to compute functions over their inputs. Several differences between these two ways of expressing computation are worth noting:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EA4" id="P7000497027000000000000000041EA4">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EA5" id="P7000497027000000000000000041EA5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EA6" id="P7000497027000000000000000041EA6">Since a combinational circuit consists of a series of logic gates, it has the property that the outputs continually respond to changes in the inputs. If some input to the circuit changes, then after some delay, the outputs will change accordingly. By contrast, a C expression is only evaluated when it is encountered during the execution of a program.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EA7" id="P7000497027000000000000000041EA7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EA8" id="P7000497027000000000000000041EA8">Logical expressions in C allow arguments to be arbitrary integers, interpreting 0 as <span class="pcalibre1 pcalibre29 pcalibre2">false </span>and anything else as <span class="pcalibre1 pcalibre29 pcalibre2">true. </span>In contrast, our logic gates only operate over the bit values 0 and 1.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EA9" id="P7000497027000000000000000041EA9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EAA" id="P7000497027000000000000000041EAA">Logical expressions in C have the property that they might only be partially evaluated. If the outcome of an <span class="pcalibre1 pcalibre29 pcalibre2">and </span>or <span class="pcalibre1 pcalibre29 pcalibre2">or </span>operation can be determined by just evaluating the first argument, then the second argument will not be evaluated. For example, with the C expression</p></li>
</ul>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EAB" id="P7000497027000000000000000041EAB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EAC" id="P7000497027000000000000000041EAC">(a &amp;&amp; !a) &amp;&amp; func(b, c)</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EAD" id="P7000497027000000000000000041EAD">the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EAE" id="P7000497027000000000000000041EAE">func</code> will not be called, because the expression (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EAF" id="P7000497027000000000000000041EAF">a &amp;&amp; !a</code>) evaluates to 0. In contrast, combinational logic does not have any partial evaluation rules. The gates simply respond to changing inputs.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003CCB" id="P7000497027000000000000000003CCB">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003CCC" epub:type="pagebreak" id="P7000497027000000000000000003CCC" title="376"></span><img alt="Diagrams illustrate bit-level implementation and word-level abstraction for equality test circuit." class="pcalibre1 pcalibre2 calibre29" data-uri="P700049702700000000000000000B6D1" id="P7000497027000000000000000041EB0" src="Images/chapter-04-image-08.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041EB1" id="P7000497027000000000000000041EB1"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041EB2" epub:type="title" id="P7000497027000000000000000041EB2"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.12 </span>Word-level equality test circuit.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041EB3" id="P7000497027000000000000000041EB3"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EB4" id="P7000497027000000000000000041EB4">The output will equal 1 when each bit from word A equals its counterpart from word B. Word-level equality is one of the operations in HCL.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EB5" id="P7000497027000000000000000041EB5">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000022196" id="P7000497027000000000000000022196">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EB6" id="P7000497027000000000000000041EB6">Two diagrams are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P7000497027000000000000000041EB7" id="P7000497027000000000000000041EB7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EB8" id="P7000497027000000000000000041EB8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EB9" id="P7000497027000000000000000041EB9">Bit-level implementation: four bit equal diagrams led to an AND gate and Eq:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000041EBA" id="P7000497027000000000000000041EBA">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EBB" id="P7000497027000000000000000041EBB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EBC" id="P7000497027000000000000000041EBC">a<sub class="pcalibre1 pcalibre2 calibre14">63</sub> and b<sub class="pcalibre1 pcalibre2 calibre14">63</sub> lead to eq<sub class="pcalibre1 pcalibre2 calibre14">63</sub></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EBD" id="P7000497027000000000000000041EBD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EBE" id="P7000497027000000000000000041EBE">a<sub class="pcalibre1 pcalibre2 calibre14">62</sub> and b<sub class="pcalibre1 pcalibre2 calibre14">62</sub> lead to eq<sub class="pcalibre1 pcalibre2 calibre14">62</sub></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EBF" id="P7000497027000000000000000041EBF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EC0" id="P7000497027000000000000000041EC0">a<sub class="pcalibre1 pcalibre2 calibre14">1</sub> and b<sub class="pcalibre1 pcalibre2 calibre14">1</sub> lead to eq<sub class="pcalibre1 pcalibre2 calibre14">1</sub></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EC1" id="P7000497027000000000000000041EC1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EC2" id="P7000497027000000000000000041EC2">a<sub class="pcalibre1 pcalibre2 calibre14">0</sub> and b<sub class="pcalibre1 pcalibre2 calibre14">0</sub> lead to eq<sub class="pcalibre1 pcalibre2 calibre14">0</sub></p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EC3" id="P7000497027000000000000000041EC3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EC4" id="P7000497027000000000000000041EC4">Word-level implemention: B and A lead to = which leads to A == B.</p></li>
</ul>
</details>
</figcaption>
</figure>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003CD2" id="P7000497027000000000000000003CD2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EC5" epub:type="title" id="P7000497027000000000000000041EC5"><span class="pcalibre1 pcalibre21 pcalibre2">4.2.3 </span>Word-Level Combinational Circuits and HCL Integer Expressions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EC6" id="P7000497027000000000000000041EC6">By assembling large networks of logic gates, we can construct combinational circuits that compute much more complex functions. Typically, we design circuits that operate on data <i class="pcalibre17 pcalibre2 pcalibre1">words.</i> These are groups of bit-level signals that represent an integer or some control pattern. For example, our processor designs will contain numerous words, with word sizes ranging between 4 and 64 bits, representing integers, addresses, instruction codes, and register identifiers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EC7" id="P7000497027000000000000000041EC7">Combinational circuits that perform word-level computations are constructed using logic gates to compute the individual bits of the output word, based on the individual bits of the input words. For example, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CCB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.12</span></a> shows a combinational circuit that tests whether two 64-bit words A and B are equal. That is, the output will equal 1 if and only if each bit of A equals the corresponding bit of B. This circuit is implemented using 64 of the single-bit equality circuits shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003C98"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.10</span></a>. The outputs of these single-bit circuits are combined with an <span class="pcalibre1 pcalibre29 pcalibre2">and </span>gate to form the circuit output.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EC8" id="P7000497027000000000000000041EC8">In HCL, we will declare any word-level signal as an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EC9" id="P7000497027000000000000000041EC9">int</code>, without specifying the word size. This is done for simplicity. In a full-featured hardware description language, every word can be declared to have a specific number of bits. HCL allows words to be compared for equality, and so the functionality of the circuit shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CCB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.12</span></a> can be expressed at the word level as</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041ECA" id="P7000497027000000000000000041ECA"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041ECB" id="P7000497027000000000000000041ECB">bool Eq = (A == B);</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041ECC" id="P7000497027000000000000000041ECC">where arguments A and B are of type int. Note that we use the same syntax conventions as in C, where `=' denotes assignment and `==' denotes the equality operator.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041ECD" id="P7000497027000000000000000041ECD"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003CDC" epub:type="pagebreak" id="P7000497027000000000000000003CDC" title="377"></span>As is shown on the right side of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CCB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.12</span></a>, we will draw word-level circuits using medium-thickness lines to represent the set of wires carrying the individual bits of the word, and we will show a single-bit signal as a dashed line.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003CDD" id="P7000497027000000000000000003CDD"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041ECE" epub:type="title" id="P7000497027000000000000000041ECE"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.10 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046F2">484</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041ECF" id="P7000497027000000000000000041ECF">Suppose you want to implement a word-level equality circuit using the <span class="pcalibre1 pcalibre29 pcalibre2">exclusive-or </span>circuits from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CAE"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.9</span></a> rather than from bit-level equality circuits. Design such a circuit for a 64-bit word consisting of 64 bit-level <span class="pcalibre1 pcalibre29 pcalibre2">exclusive-or </span>circuits and two additional logic gates.</p>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041ED0" id="P7000497027000000000000000041ED0"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CE1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.13</span></a> shows the circuit for a word-level multiplexor. This circuit generates a 64-bit word Out equal to one of the two input words, A or B, depending on the control input bit s. The circuit consists of 64 identical subcircuits, each having a structure similar to the bit-level multiplexor from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CB4"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.11</span></a>. Rather than replicating the bit-level multiplexor 64 times, the word-level version reduces the number of inverters by generating !s once and reusing it at each bit position.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003CE1" id="P7000497027000000000000000003CE1">
<img alt="Diagrams illustrate bit-level implementation and word-level abstraction for multiplexor circuit." class="pcalibre1 pcalibre2 calibre30" data-uri="P700049702700000000000000000B6D2" id="P7000497027000000000000000041ED1" src="Images/chapter-04-image-09.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041ED2" id="P7000497027000000000000000041ED2"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041ED3" epub:type="title" id="P7000497027000000000000000041ED3"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.13 </span>Word-level multiplexor circuit.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041ED4" id="P7000497027000000000000000041ED4"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041ED5" id="P7000497027000000000000000041ED5"> The output will equal input word A when the control signal s is 1, and it will equal B otherwise. Multiplexors are described in HCL using case expressions.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041ED6" id="P7000497027000000000000000041ED6">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000221B7" id="P70004970270000000000000000221B7">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041ED7" id="P7000497027000000000000000041ED7">Two diagrams are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P7000497027000000000000000041ED8" id="P7000497027000000000000000041ED8">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041ED9" id="P7000497027000000000000000041ED9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EDA" id="P7000497027000000000000000041EDA">Bit-level implementation: s leads to a series of AND gates as well as a NOT gate leading to the AND gates. Pairs of AND gates leads to OR gates leading to an OUT:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000041EDB" id="P7000497027000000000000000041EDB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EDC" id="P7000497027000000000000000041EDC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EDD" id="P7000497027000000000000000041EDD">Leading to out<sub class="pcalibre1 pcalibre2 calibre14">63</sub>, b<sub class="pcalibre1 pcalibre2 calibre14">63</sub> and a<sub class="pcalibre1 pcalibre2 calibre14">63</sub> lead to separate AND gates</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EDE" id="P7000497027000000000000000041EDE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EDF" id="P7000497027000000000000000041EDF">Leading to out<sub class="pcalibre1 pcalibre2 calibre14">62</sub>, b<sub class="pcalibre1 pcalibre2 calibre14">62</sub> and a<sub class="pcalibre1 pcalibre2 calibre14">62</sub> lead to separate AND gates</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EE0" id="P7000497027000000000000000041EE0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EE1" id="P7000497027000000000000000041EE1">Leading to out<sub class="pcalibre1 pcalibre2 calibre14">0</sub>, b<sub class="pcalibre1 pcalibre2 calibre14">0</sub> and a<sub class="pcalibre1 pcalibre2 calibre14">0</sub> lead to separate AND gates</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EE2" id="P7000497027000000000000000041EE2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EE3" id="P7000497027000000000000000041EE3">Word-level abstraction: S, B, and A lead to MUX, which leads to Out, showing:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000041EE4" id="P7000497027000000000000000041EE4">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EE5" id="P7000497027000000000000000041EE5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EE6" id="P7000497027000000000000000041EE6">Int Out = [</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EE7" id="P7000497027000000000000000041EE7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EE8" id="P7000497027000000000000000041EE8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EE9" id="P7000497027000000000000000041EE9">S : A;</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EEA" id="P7000497027000000000000000041EEA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EEB" id="P7000497027000000000000000041EEB">L: B;</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EEC" id="P7000497027000000000000000041EEC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EED" id="P7000497027000000000000000041EED">] ;</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EEE" id="P7000497027000000000000000041EEE"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003CE8" epub:type="pagebreak" id="P7000497027000000000000000003CE8" title="378"></span>We will use many forms of multiplexors in our processor designs. They allow us to select a word from a number of sources depending on some control condition. Multiplexing functions are described in HCL using <i class="pcalibre17 pcalibre2 pcalibre1">case expressions.</i> A case expression has the following general form:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EEF" id="P7000497027000000000000000041EEF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EF0" id="P7000497027000000000000000041EF0">[
<i class="pcalibre17 pcalibre2 pcalibre1">select<sub class="pcalibre1 pcalibre2 pcalibre122">1</sub> : expr<sub class="pcalibre1 pcalibre2 pcalibre122">1</sub>;</i>
<i class="pcalibre17 pcalibre2 pcalibre1">select<sub class="pcalibre1 pcalibre2 pcalibre122">2</sub></i> : <i class="pcalibre17 pcalibre2 pcalibre1">sxpr<sub class="pcalibre1 pcalibre2 pcalibre122">2</sub>;</i>
⋮
<i class="pcalibre17 pcalibre2 pcalibre1">select<sub class="pcalibre1 pcalibre2 pcalibre122">k</sub> : expr<sub class="pcalibre1 pcalibre2 pcalibre122">k</sub>;</i>
]
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EF1" id="P7000497027000000000000000041EF1">The expression contains a series of cases, where each case <var class="pcalibre17 pcalibre2 pcalibre1">i</var> consists of a Boolean expression <i class="pcalibre17 pcalibre2 pcalibre1">select<sub class="pcalibre1 pcalibre2 calibre14">i</sub></i>, indicating when this case should be selected, and an integer expression <i class="pcalibre17 pcalibre2 pcalibre1">expr<sub class="pcalibre1 pcalibre2 calibre14">i</sub></i>, indicating the resulting value.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EF2" id="P7000497027000000000000000041EF2">Unlike the switch statement of C, we do not require the different selection expressions to be mutually exclusive. Logically, the selection expressions are evaluated in sequence, and the case for the first one yielding 1 is selected. For example, the word-level multiplexor of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CE1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.13</span></a> can be described in HCL as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EF3" id="P7000497027000000000000000041EF3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EF4" id="P7000497027000000000000000041EF4">word Out = [
	s: A;
	1: B;
];
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EF5" id="P7000497027000000000000000041EF5">In this code, the second selection expression is simply 1, indicating that this case should be selected if no prior one has been. This is the way to specify a default case in HCL. Nearly all case expressions end in this manner.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EF6" id="P7000497027000000000000000041EF6">Allowing nonexclusive selection expressions makes the HCL code more readable. An actual hardware multiplexor must have mutually exclusive signals controlling which input word should be passed to the output, such as the signals s and !s in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CE1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.13</span></a>. To translate an HCL case expression into hardware, a logic synthesis program would need to analyze the set of selection expressions and resolve any possible conflicts by making sure that only the first matching case would be selected.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EF7" id="P7000497027000000000000000041EF7">The selection expressions can be arbitrary Boolean expressions, and there can be an arbitrary number of cases. This allows case expressions to describe blocks where there are many choices of input signals with complex selection criteria. For example, consider the diagram of a 4-way multiplexor shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CF4"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.14</span></a>. This circuit selects from among the four input words A, B, C, and D based on the control signals s1 and s0, treating the controls as a 2-bit binary number. We can express this in HCL using Boolean expressions to describe the different combinations of control bit patterns:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041EF8" id="P7000497027000000000000000041EF8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EF9" id="P7000497027000000000000000041EF9">word Out4 = [
	!s1 &amp;&amp; !s0 : A; # 00
</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003CF4" id="P7000497027000000000000000003CF4">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003CF5" epub:type="pagebreak" id="P7000497027000000000000000003CF5" title="379"></span><img alt="A diagram of a four-way multiplexor shows s1, s0, D, C, B, and A leading to MUX4, which leads to Out4." class="pcalibre147 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6D3" id="P7000497027000000000000000041EFA" src="Images/chapter-04-image-10.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041EFB" id="P7000497027000000000000000041EFB"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041EFC" epub:type="title" id="P7000497027000000000000000041EFC"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.14 </span>Four-way multiplexor.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EFD" id="P7000497027000000000000000041EFD"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041EFE" id="P7000497027000000000000000041EFE"> The different combinations of control signals s1 and s0 determine which data input is transmitted to the output.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041EFF" id="P7000497027000000000000000041EFF">
</p></div>
</figcaption>
</figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F00" id="P7000497027000000000000000041F00"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F01" id="P7000497027000000000000000041F01">	!s1 : B; # 01
	!s0 : C; # 10
	1 : D; # 11
];
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F02" id="P7000497027000000000000000041F02">The comments on the right (any text starting with # and running for the rest of the line is a comment) show which combination of s1 and s0 will cause the case to be selected. Observe that the selection expressions can sometimes be simplified, since only the first matching case is selected. For example, the second expression can be written <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F03" id="P7000497027000000000000000041F03">!s1</code>, rather than the more complete <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F04" id="P7000497027000000000000000041F04">!s1 &amp;&amp; s0</code>, since the only other possibility having <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F05" id="P7000497027000000000000000041F05">s1</code> equal to 0 was given as the first selection expression. Similarly, the third expression can be written as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F06" id="P7000497027000000000000000041F06">!s0</code>, while the fourth can simply be written as 1.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F07" id="P7000497027000000000000000041F07">As a final example, suppose we want to design a logic circuit that finds the minimum value among a set of words A, B, and C, diagrammed as follows:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003D03" id="P7000497027000000000000000003D03">
<img alt="A diagram shows C, B, and A leading to MIN3, leading to Min3." class="pcalibre1 pcalibre2 pcalibre148" data-uri="P700049702700000000000000000B6D4" id="P7000497027000000000000000041F08" src="Images/chapter-04-image-11.png"/>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F09" id="P7000497027000000000000000041F09">We can express this using an HCL case expression as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F0A" id="P7000497027000000000000000041F0A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F0B" id="P7000497027000000000000000041F0B">word Min3 = [
	A &lt;= B &amp;&amp; A &lt;= C : A;
	B &lt;= A &amp;&amp; B &lt;= C : B;
	1 : C;
];
</code></pre>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003D08" epub:type="practice" id="P7000497027000000000000000003D08"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F0C" epub:type="title" id="P7000497027000000000000000041F0C"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.11 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046F2">484</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041F0D" id="P7000497027000000000000000041F0D">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041F0E" id="P7000497027000000000000000041F0E">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F0F" id="P7000497027000000000000000041F0F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F10" id="P7000497027000000000000000041F10">The HCL code given for computing the minimum of three words contains four comparison expressions of the form <var class="pcalibre17 pcalibre2 pcalibre1">X</var> &lt;= <i class="pcalibre17 pcalibre2 pcalibre1">Y.</i> Rewrite the code to compute the same result, but using only three comparisons.</p></div>
</li>
</ol>
</section>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003D0E" id="P7000497027000000000000000003D0E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003D0F" epub:type="pagebreak" id="P7000497027000000000000000003D0F" title="380"></span><img alt="A diagram shows four ALU circuits." class="pcalibre1 pcalibre2 pcalibre149" data-uri="P700049702700000000000000000B6D5" id="P7000497027000000000000000041F11" src="Images/chapter-04-image-12.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041F12" id="P7000497027000000000000000041F12"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041F13" epub:type="title" id="P7000497027000000000000000041F13"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.15 </span>Arithmetic/logic unit (ALU).</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F14" id="P7000497027000000000000000041F14"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F15" id="P7000497027000000000000000041F15"> Depending on the setting of the function input, the circuit will perform one of four different arithmetic and logical operations.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F16" id="P7000497027000000000000000041F16">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000221F6" id="P70004970270000000000000000221F6">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F17" id="P7000497027000000000000000041F17">The four ALU circuits are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P7000497027000000000000000041F18" id="P7000497027000000000000000041F18">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F19" id="P7000497027000000000000000041F19"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F1A" id="P7000497027000000000000000041F1A">Input 0: Y and X lead to A and B, respectively, in ALU, with output X + Y</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F1B" id="P7000497027000000000000000041F1B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F1C" id="P7000497027000000000000000041F1C">Input 1: Y and X lead to A and B, respectively, in ALU, with output X minus Y</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F1D" id="P7000497027000000000000000041F1D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F1E" id="P7000497027000000000000000041F1E">Input 2: Y and X lead to A and B, respectively, in ALU, with output X &amp; Y</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F1F" id="P7000497027000000000000000041F1F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F20" id="P7000497027000000000000000041F20">Input 3: Y and X lead to A and B, respectively, in ALU, with output X ^ Y</p></li>
</ul>
</details>
</figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003D15" epub:type="practice" id="P7000497027000000000000000003D15"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F21" epub:type="title" id="P7000497027000000000000000041F21"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.12 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000046F2">484</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041F22" id="P7000497027000000000000000041F22">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041F23" id="P7000497027000000000000000041F23">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F24" id="P7000497027000000000000000041F24"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F25" id="P7000497027000000000000000041F25">Write HCL code describing a circuit that for word inputs A, B, and C selects the <i class="pcalibre17 pcalibre2 pcalibre1">median</i> of the three values. That is, the output equals the word lying between the minimum and maximum of the three inputs.</p></div>
</li>
</ol>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F26" id="P7000497027000000000000000041F26">Combinational logic circuits can be designed to perform many different types of operations on word-level data. The detailed design of these is beyond the scope of our presentation. One important combinational circuit, known as an <i class="pcalibre17 pcalibre2 pcalibre1">arithmetic/logic unit</i> (ALU), is diagrammed at an abstract level in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003D0E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.15</span></a>. In our version, the circuit has three inputs: two data inputs labeled A and B and a control input. Depending on the setting of the control input, the circuit will perform different arithmetic or logical operations on the data inputs. Observe that the four operations diagrammed for this ALU correspond to the four different integer operations supported by the Y86-64 instruction set, and the control values match the function codes for these instructions (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003B10"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3</span></a>). Note also the ordering of operands for subtraction, where the A input is subtracted from the B input. This ordering is chosen in anticipation of the ordering of arguments in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F27" id="P7000497027000000000000000041F27">subq</code> instruction.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003D1D" id="P7000497027000000000000000003D1D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F28" epub:type="title" id="P7000497027000000000000000041F28"><span class="pcalibre1 pcalibre21 pcalibre2">4.2.4 </span>Set Membership</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F29" id="P7000497027000000000000000041F29">In our processor designs, we will find many examples where we want to compare one signal against a number of possible matching signals, such as to test whether the code for some instruction being processed matches some category of instruction codes. As a simple example, suppose we want to generate the signals s1 and s0 for the 4-way multiplexor of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003CF4"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.14</span></a> by selecting the high- and low-order bits from a 2-bit signal code, as follows:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003D20" id="P7000497027000000000000000003D20">
<img alt="A diagram shows code leading to Control, leading to s1 and s0, which lead to MUX4. D, C, B, and A also lead to MUX4, which leads to Out4." class="pcalibre150 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6D6" id="P7000497027000000000000000041F2A" src="Images/chapter-04-image-13.png"/>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F2B" id="P7000497027000000000000000041F2B"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003D23" epub:type="pagebreak" id="P7000497027000000000000000003D23" title="381"></span>In this circuit, the 2-bit signal code would then control the selection among the four data words A, B, C, and D. We can express the generation of signals s1 and s0 using equality tests based on the possible values of code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F2C" id="P7000497027000000000000000041F2C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F2D" id="P7000497027000000000000000041F2D">bool s1 = code == 2 || code == 3;</code>
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F2E" id="P7000497027000000000000000041F2E">bool s0 = code == 1 || code == 3;</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F2F" id="P7000497027000000000000000041F2F">A more concise expression can be written that expresses the property that s1 is 1 when code is in the set {2, 3}, and s0 is 1 when code is in the set {1, 3}:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F30" id="P7000497027000000000000000041F30"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F31" id="P7000497027000000000000000041F31">bool s1 = code in { 2, 3 };</code>
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F32" id="P7000497027000000000000000041F32">bool s0 = code in { 1, 3 };</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F33" id="P7000497027000000000000000041F33">The general form of a set membership test is</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F34" id="P7000497027000000000000000041F34"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F35" id="P7000497027000000000000000041F35"><i class="pcalibre17 pcalibre2 pcalibre1">iexpr</i> in <i class="pcalibre17 pcalibre2 pcalibre1">{.iexpr<sub class="pcalibre1 pcalibre2 pcalibre122">1</sub>, iexpr<sub class="pcalibre1 pcalibre2 pcalibre122">2</sub>, ···, iexpr<sub class="pcalibre1 pcalibre2 pcalibre122">k</sub>}</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F36" id="P7000497027000000000000000041F36">where the value being tested <i class="pcalibre17 pcalibre2 pcalibre1">(iexpr)</i> and the candidate matches (<i class="pcalibre17 pcalibre2 pcalibre1">iexpr</i><sub class="pcalibre1 pcalibre2 calibre14">1</sub> through <i class="pcalibre17 pcalibre2 pcalibre1">iexpr<sub class="pcalibre1 pcalibre2 calibre14">k</sub></i>) are all integer expressions.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003D2F" id="P7000497027000000000000000003D2F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F37" epub:type="title" id="P7000497027000000000000000041F37"><span class="pcalibre1 pcalibre21 pcalibre2">4.2.5 </span>Memory and Clocking</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F38" id="P7000497027000000000000000041F38">Combinational circuits, by their very nature, do not store any information. Instead, they simply react to the signals at their inputs, generating outputs equal to some function of the inputs. To create <i class="pcalibre17 pcalibre2 pcalibre1">sequential circuits</i>—that is, systems that have state and perform computations on that state—we must introduce devices that store information represented as bits. Our storage devices are all controlled by a single <i class="pcalibre17 pcalibre2 pcalibre1">clock</i>, a periodic signal that determines when new values are to be loaded into the devices. We consider two classes of memory devices:</p>
<blockquote class="pcalibre88 pcalibre87 pcalibre86" data-uri="chapter04.xhtml#P7000497027000000000000000041F39" id="P7000497027000000000000000041F39"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F3A" id="P7000497027000000000000000041F3A"><i class="pcalibre17 pcalibre2 pcalibre1">Clocked registers</i> (or simply <i class="pcalibre17 pcalibre2 pcalibre1">registers)</i> store individual bits or words. The clock signal controls the loading of the register with the value at its input.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F3B" id="P7000497027000000000000000041F3B"><i class="pcalibre17 pcalibre2 pcalibre1">Random access memories</i> (or simply <i class="pcalibre17 pcalibre2 pcalibre1">memories</i>) store multiple words, using an address to select which word should be read or written. Examples of random access memories include (1) the virtual memory system of a processor, where a combination of hardware and operating system software make it appear to a processor that it can access any word within a large address space; and (2) the register file, where register identifiers serve as the addresses. In a Y86-64 processor, the register file holds the 15 program registers (<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F3C" id="P7000497027000000000000000041F3C">%rax</code> through <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F3D" id="P7000497027000000000000000041F3D">%r14</code>).</p>
</blockquote>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F3E" id="P7000497027000000000000000041F3E">As we can see, the word "register" means two slightly different things when speaking of hardware versus machine-language programming. In hardware, a register is directly connected to the rest of the circuit by its input and output wires. In machine-level programming, the registers represent a small collection of addressable words in the CPU, where the addresses consist of register IDs. These words are generally stored in the register file, although we will see that the hardware can sometimes pass a word directly from one instruction to another to</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003D38" id="P7000497027000000000000000003D38">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003D39" epub:type="pagebreak" id="P7000497027000000000000000003D39" title="382"></span><img alt="A diagram of the register operation shows a flow from state = x, with input y and output x, leading to rising clock leading to state = y, with output y." class="pcalibre151 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B6D7" id="P7000497027000000000000000041F3F" src="Images/chapter-04-image-14.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041F40" id="P7000497027000000000000000041F40"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041F41" epub:type="title" id="P7000497027000000000000000041F41"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.16 </span>Register operation.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F42" id="P7000497027000000000000000041F42"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F43" id="P7000497027000000000000000041F43"> The register outputs remain held at the current register state until the clock signal rises. When the clock rises, the values at the register inputs are captured to become the new register state.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F44" id="P7000497027000000000000000041F44">
</p></div>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F45" id="P7000497027000000000000000041F45">avoid the delay of first writing and then reading the register file. When necessary to avoid ambiguity, we will call the two classes of registers "hardware registers" and "program registers," respectively.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F46" id="P7000497027000000000000000041F46"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003D38"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.16</span></a> gives a more detailed view of a hardware register and how it operates. For most of the time, the register remains in a fixed state (shown as x), generating an output equal to its current state. Signals propagate through the combinational logic preceding the register, creating a new value for the register input (shown as y), but the register output remains fixed as long as the clock is low. As the clock rises, the input signals are loaded into the register as its next state (y), and this becomes the new register output until the next rising clock edge. A key point is that the registers serve as barriers between the combinational logic in different parts of the circuit. Values only propagate from a register input to its output once every clock cycle at the rising clock edge. Our Y86-64 processors will use clocked registers to hold the program counter (PC), the condition codes (CC), and the program status (Stat).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F47" id="P7000497027000000000000000041F47">The following diagram shows a typical register file:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003D42" id="P7000497027000000000000000003D42">
<img alt="A diagram of a register file, with clock input, has two read ports: A with input srcA and output valA and B with input srcB and output valB, and a write port with inputs dstW and valW." class="pcalibre1 pcalibre2 calibre31" data-uri="P700049702700000000000000000B6D8" id="P7000497027000000000000000041F48" src="Images/chapter-04-image-15.png"/>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F49" id="P7000497027000000000000000041F49">This register file has two <i class="pcalibre17 pcalibre2 pcalibre1">read ports</i>, named A and B, and one <i class="pcalibre17 pcalibre2 pcalibre1">write port</i>, named W. Such a <i class="pcalibre17 pcalibre2 pcalibre1">multiported</i> random access memory allows multiple read and write operations to take place simultaneously. In the register file diagrammed, the circuit can read the values of two program registers and update the state of a third. Each port has an address input, indicating which program register should be selected, and a data output or input giving a value for that program register. The addresses are register identifiers, using the encoding shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003B18"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.4</span></a>. The two read ports have address inputs srcA and srcB (short for "source A" and "source B") and data <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003D45" epub:type="pagebreak" id="P7000497027000000000000000003D45" title="383"></span>outputs valA and valB (short for "value A" and "value B"). The write port has address input dstW (short for "destination W") and data input valW (short for "value W").</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F4A" id="P7000497027000000000000000041F4A">The register file is not a combinational circuit, since it has internal storage. In our implementation, however, data can be read from the register file as if it were a block of combinational logic having addresses as inputs and the data as outputs. When either srcA or srcB is set to some register ID, then, after some delay, the value stored in the corresponding program register will appear on either valA or valB. For example, setting srcA to 3 will cause the value of program register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F4B" id="P7000497027000000000000000041F4B">%rbx</code> to be read, and this value will appear on output valA.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F4C" id="P7000497027000000000000000041F4C">The writing of words to the register file is controlled by the clock signal in a manner similar to the loading of values into a clocked register. Every time the clock rises, the value on input valW is written to the program register indicated by the register ID on input dstW. When dstW is set to the special ID value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F4D" id="P7000497027000000000000000041F4D">0xF</code>, no program register is written. Since the register file can be both read and written, a natural question to ask is, "What happens if the circuit attempts to read and write the same register simultaneously?" The answer is straightforward: if the same register ID is used for both a read port and the write port, then, as the clock rises, there will be a transition on the read port's data output from the old value to the new. When we incorporate the register file into our processor design, we will make sure that we take this property into consideration.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F4E" id="P7000497027000000000000000041F4E">Our processor has a random access memory for storing program data, as illustrated below:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003D4B" id="P7000497027000000000000000003D4B">
<img alt="A diagram of data memory shows inputs from clock, read, write, address, and data in and outputs as error and data out." class="pcalibre1 pcalibre2 calibre32" data-uri="P700049702700000000000000000B6D9" id="P7000497027000000000000000041F4F" src="Images/chapter-04-image-16.png"/>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F50" id="P7000497027000000000000000041F50">This memory has a single address input, a data input for writing, and a data output for reading. Like the register file, reading from our memory operates in a manner similar to combinational logic: If we provide an address on the address input and set the write control signal to 0, then after some delay, the value stored at that address will appear on data out. The error signal will be set to 1 if the address is out of range, and to 0 otherwise. Writing to the memory is controlled by the clock: We set address to the desired address, data in to the desired value, and write to 1. When we then operate the clock, the specified location in the memory will be updated, as long as the address is valid. As with the read operation, the error signal will be set to 1 if the address is invalid. This signal is generated by combinational logic, since the required bounds checking is purely a function of the address input and does not involve saving any state.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003D4E" id="P7000497027000000000000000003D4E"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000041F51" epub:type="title" id="P7000497027000000000000000041F51"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003D50" epub:type="pagebreak" id="P7000497027000000000000000003D50" title="384"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Real-life memory design</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041F52" id="P7000497027000000000000000041F52">The memory system in a full-scale microprocessor is far more complex than the simple one we assume in our design. It consists of several forms of hardware memories, including several random access memories, plus nonvolatile memory or magnetic disk, as well as a variety of hardware and software mechanisms for managing these devices. The design and characteristics of the memory system are described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000005190.xhtml#P7000497027000000000000000005190"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">6</span></a>.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F53" id="P7000497027000000000000000041F53">Nonetheless, our simple memory design can be used for smaller systems, and it provides us with an abstraction of the interface between the processor and memory for more complex systems.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F54" id="P7000497027000000000000000041F54">Our processor includes an additional read-only memory for reading instructions. In most actual systems, these memories are merged into a single memory with two ports: one for reading instructions, and the other for reading or writing data.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>4.3 Sequential Y86-64 Implementations</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000003D54"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041F55" epub:type="title" id="P7000497027000000000000000041F55"><span class="pcalibre1 pcalibre21 pcalibre2">4.3 </span>Sequential Y86-64 Implementations</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F56" id="P7000497027000000000000000041F56">Now we have the components required to implement a Y86-64 processor. As a first step, we describe a processor called SEQ (for "sequential" processor). On each clock cycle, SEQ performs all the steps required to process a complete instruction. This would require a very long cycle time, however, and so the clock rate would be unacceptably low. Our purpose in developing SEQ is to provide a first step toward our ultimate goal of implementing an efficient pipelined processor.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003D57" id="P7000497027000000000000000003D57"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F57" epub:type="title" id="P7000497027000000000000000041F57"><span class="pcalibre1 pcalibre21 pcalibre2">4.3.1 </span>Organizing Processing into Stages</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F58" id="P7000497027000000000000000041F58">In general, processing an instruction involves a number of operations. We organize them in a particular sequence of stages, attempting to make all instructions follow a uniform sequence, even though the instructions differ greatly in their actions. The detailed processing at each step depends on the particular instruction being executed. Creating this framework will allow us to design a processor that makes best use of the hardware. The following is an informal description of the stages and the operations performed within them:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F59" id="P7000497027000000000000000041F59">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F5A" id="P7000497027000000000000000041F5A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041F5B" id="P7000497027000000000000000041F5B"><span class="pcalibre1 pcalibre2 pcalibre41">Fetch. </span>The fetch stage reads the bytes of an instruction from memory, using the program counter (PC) as the memory address. From the instruction it extracts the two 4-bit portions of the instruction specifier byte, referred to as icode (the instruction code) and ifun (the instruction function). It possibly fetches a register specifier byte, giving one or both of the register operand specifiers rA and rB. It also possibly fetches an 8-byte constant word valC. It computes valP to be the address of the instruction following the current one in sequential order. That is, valP equals the value of the PC plus the length of the fetched instruction.</p>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F5C" id="P7000497027000000000000000041F5C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041F5D" id="P7000497027000000000000000041F5D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003D5F" epub:type="pagebreak" id="P7000497027000000000000000003D5F" title="385"></span><span class="pcalibre1 pcalibre2 pcalibre41">Decode. </span>The decode stage reads up to two operands from the register file, giving values valA and/or valB. Typically, it reads the registers designated by instruction fields rA and rB, but for some instructions it reads register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F5E" id="P7000497027000000000000000041F5E">%rsp</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F5F" id="P7000497027000000000000000041F5F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041F60" id="P7000497027000000000000000041F60"><span class="pcalibre1 pcalibre2 pcalibre41">Execute. </span>In the execute stage, the arithmetic/logic unit (ALU) either performs the operation specified by the instruction (according to the value of ifun), computes the effective address of a memory reference, or increments or decrements the stack pointer. We refer to the resulting value as valE. The condition codes are possibly set. For a conditional move instruction, the stage will evaluate the condition codes and move condition (given by ifun) and enable the updating of the destination register only if the condition holds. Similarly, for a jump instruction, it determines whether or not the branch should be taken.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F61" id="P7000497027000000000000000041F61"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041F62" id="P7000497027000000000000000041F62"><span class="pcalibre1 pcalibre2 pcalibre41">Memory. </span>The memory stage may write data to memory, or it may read data from memory. We refer to the value read as valM.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F63" id="P7000497027000000000000000041F63"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041F64" id="P7000497027000000000000000041F64"><span class="pcalibre1 pcalibre2 pcalibre41">Write back. </span>The write-back stage writes up to two results to the register file.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F65" id="P7000497027000000000000000041F65"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041F66" id="P7000497027000000000000000041F66"><span class="pcalibre1 pcalibre2 pcalibre41">PC update. </span>The PC is set to the address of the next instruction.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F67" id="P7000497027000000000000000041F67">The processor loops indefinitely, performing these stages. In our simplified implementation, the processor will stop when any exception occurs—that is, when it executes a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F68" id="P7000497027000000000000000041F68">halt</code> or invalid instruction, or it attempts to read or write an invalid address. In a more complete design, the processor would enter an exception-handling mode and begin executing special code determined by the type of exception.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F69" id="P7000497027000000000000000041F69">As can be seen by the preceding description, there is a surprising amount of processing required to execute a single instruction. Not only must we perform the stated operation of the instruction, we must also compute addresses, update stack pointers, and determine the next instruction address. Fortunately, the overall flow can be similar for every instruction. Using a very simple and uniform structure is important when designing hardware, since we want to minimize the total amount of hardware and we must ultimately map it onto the two-dimensional surface of an integrated-circuit chip. One way to minimize the complexity is to have the different instructions share as much of the hardware as possible. For example, each of our processor designs contains a single arithmetic/logic unit that is used in different ways depending on the type of instruction being executed. The cost of duplicating blocks of logic in hardware is much higher than the cost of having multiple copies of code in software. It is also more difficult to deal with many special cases and idiosyncrasies in a hardware system than with software.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F6A" id="P7000497027000000000000000041F6A">Our challenge is to arrange the computing required for each of the different instructions to fit within this general framework. We will use the code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D6D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17</span></a> to illustrate the processing of different Y86-64 instructions. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003EDE"><span class="pcalibre1 pcalibre21 pcalibre2">Figures </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18</span></a> through <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FD2"><span class="pcalibre1 pcalibre21 pcalibre2">4.21</span></a> contain tables describing how the different Y86-64 instructions proceed through the stages. It is worth the effort to study these tables carefully. They are in a form that enables a straightforward mapping into the hardware. Each line in these tables describes an assignment to some signal or stored state</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003D6D" id="P7000497027000000000000000003D6D">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000041F6B" id="P7000497027000000000000000041F6B">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F6C" id="P7000497027000000000000000041F6C"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003D70" epub:type="pagebreak" id="P7000497027000000000000000003D70" title="386"></span>1	0x000: 30f 20900000000000000	|	irmovq $9, %rdx
2	0x00a: 30f31500000000000000	|	irmovq $21, %rbx
3	0x014: 6123			|	subq %rdx, %rbx			# subtract
4	0x016: 30f48000000000000000	|	irmovq $128,%rsp		# <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003DAD"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">4.13</span></a>
5	0x020: 40436400000000000000	|	rmmovq %rsp, 100(%rbx)		# store
6	0x02a: a02f			|	pushq %rdx			# push
7	0x02c: b00f			|	popq %rax			# <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E52"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">4.14</span></a>
8	0x02e: 734000000000000000	|	je done				# Not taken
9	0x037: 804100000000000000	|	call proc			# <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003F4A"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">4.18</span></a>
10	0x040:				| done:
11	0x040: 00			|	halt
12	0x041:				| proc:
13	0x041: 90			|	ret				# Return
14					|
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041F6D" id="P7000497027000000000000000041F6D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041F6E" epub:type="title" id="P7000497027000000000000000041F6E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.17 </span>Sample Y86-64 instruction sequence.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F6F" id="P7000497027000000000000000041F6F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041F70" id="P7000497027000000000000000041F70"> We will trace the processing of these instructions through the different stages.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F71" id="P7000497027000000000000000041F71">(indicated by the assignment operation ‘←’). These should be read as if they were evaluated in sequence from top to bottom. When we later map the computations to hardware, we will find that we do not need to perform these evaluations in strict sequential order.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F72" id="P7000497027000000000000000041F72"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D82"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18</span></a> shows the processing required for instruction types <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F73" id="P7000497027000000000000000041F73">OPq</code> (integer and logical operations), <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F74" id="P7000497027000000000000000041F74">rrmovq</code> (register-register move), and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F75" id="P7000497027000000000000000041F75">irmovq</code> (immediate-register move). Let us first consider the integer operations. Examining <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a>, we can see that we have carefully chosen an encoding of instructions so that the four integer operations (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F76" id="P7000497027000000000000000041F76">addq, subq, andq</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F77" id="P7000497027000000000000000041F77">xorq</code>) all have the same value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F78" id="P7000497027000000000000000041F78">icode</code>. We can handle them all by an identical sequence of steps, except that the ALU computation must be set according to the particular instruction operation, encoded in ifun.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F79" id="P7000497027000000000000000041F79">The processing of an integer-operation instruction follows the general pattern listed above. In the fetch stage, we do not require a constant word, and so valP is computed as PC + 2. During the decode stage, we read both operands. These are supplied to the ALU in the execute stage, along with the function specifier ifun, so that valE becomes the instruction result. This computation is shown as the expression valB OP valA, where OP indicates the operation specified by ifun. Note the ordering of the two arguments—this order is consistent with the conventions of Y86-64 (and x86-64). For example, the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F7A" id="P7000497027000000000000000041F7A">subq %rax, %rdx</code> is supposed to compute the value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F7B" id="P7000497027000000000000000041F7B">R[%rdx] - R[%rax]</code>. Nothing happens in the memory stage for these instructions, but valE is written to register rB in the write-back stage, and the PC is set to valP to complete the instruction execution.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F7C" id="P7000497027000000000000000041F7C">Executing an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F7D" id="P7000497027000000000000000041F7D">rrmovq</code> instruction proceeds much like an arithmetic operation. We do not need to fetch the second register operand, however. Instead, we set the second ALU input to zero and add this to the first, giving valE = valA, which is</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003D82" id="P7000497027000000000000000003D82">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000041F7E" id="P7000497027000000000000000041F7E">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041F7F" id="P7000497027000000000000000041F7F"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003D85" epub:type="pagebreak" id="P7000497027000000000000000003D85" title="387"></span>Stage	</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041F80" id="P7000497027000000000000000041F80"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F81" id="P7000497027000000000000000041F81">OPq</code> rA, rB	</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041F82" id="P7000497027000000000000000041F82"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F83" id="P7000497027000000000000000041F83">rrmovq</code> rA, rB	</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041F84" id="P7000497027000000000000000041F84"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F85" id="P7000497027000000000000000041F85">irmovq</code> V, rB</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F86" id="P7000497027000000000000000041F86">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F87" id="P7000497027000000000000000041F87">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F88" id="P7000497027000000000000000041F88">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F89" id="P7000497027000000000000000041F89">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC +1]<br class="pcalibre1 pcalibre2 pcalibre7"/>valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 2]
</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F8A" id="P7000497027000000000000000041F8A">valP ← PC+ 2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F8B" id="P7000497027000000000000000041F8B">valP ← PC+ 2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F8C" id="P7000497027000000000000000041F8C">valP ← PC+ 10</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F8D" id="P7000497027000000000000000041F8D">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F8E" id="P7000497027000000000000000041F8E">valA ← R[rA] valB ← R[rB]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F8F" id="P7000497027000000000000000041F8F">valA ← R[rA]</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F90" id="P7000497027000000000000000041F90">
Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F91" id="P7000497027000000000000000041F91">valE ← valBOPvalA SetCC</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F92" id="P7000497027000000000000000041F92">valE ← 0 + valA</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F93" id="P7000497027000000000000000041F93">valE ← 0 + valC</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F94" id="P7000497027000000000000000041F94">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F95" id="P7000497027000000000000000041F95">
Write back</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F96" id="P7000497027000000000000000041F96">R[rB] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F97" id="P7000497027000000000000000041F97">R[rB] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F98" id="P7000497027000000000000000041F98">R[rB] ← valE</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F99" id="P7000497027000000000000000041F99">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F9A" id="P7000497027000000000000000041F9A">PC ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F9B" id="P7000497027000000000000000041F9B">PC ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041F9C" id="P7000497027000000000000000041F9C">PC ← valP</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000041F9D" id="P7000497027000000000000000041F9D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000041F9E" epub:type="title" id="P7000497027000000000000000041F9E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18 </span>Computations in sequential implementation of Y86-64 instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041F9F" id="P7000497027000000000000000041F9F">OPq, rrmovq</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FA0" id="P7000497027000000000000000041FA0">irmovq</code>. </h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FA1" id="P7000497027000000000000000041FA1"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FA2" id="P7000497027000000000000000041FA2">These instructions compute a value and store the result in a register. The notation <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FA3" id="P7000497027000000000000000041FA3">icode</code>: ifun indicates the two components of the instruction byte, while rA : rB indicates the two components of the register specifier byte. The notation M<sub class="pcalibre1 pcalibre2 calibre14">1</sub>[<var class="pcalibre17 pcalibre2 pcalibre1">x</var>] indicates accessing (either reading or writing) 1 byte at memory location <var class="pcalibre17 pcalibre2 pcalibre1">x</var>, while M<sub class="pcalibre1 pcalibre2 calibre14">8</sub>[<var class="pcalibre17 pcalibre2 pcalibre1">x</var>] indicates accessing 8 bytes.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041FA4" id="P7000497027000000000000000041FA4">
</p></div>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FA5" id="P7000497027000000000000000041FA5">then written to the register file. Similar processing occurs for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FA6" id="P7000497027000000000000000041FA6">irmovq</code>, except that we use constant value valC for the first ALU input. In addition, we must increment the program counter by 10 for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FA7" id="P7000497027000000000000000041FA7">irmovq</code> due to the long instruction format. Neither of these instructions changes the condition codes.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003DAD" epub:type="practice" id="P7000497027000000000000000003DAD"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FA8" epub:type="title" id="P7000497027000000000000000041FA8"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.13 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P7000497027000000000000000004719">485</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000041FA9" id="P7000497027000000000000000041FA9">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000041FAA" id="P7000497027000000000000000041FAA">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FAB" id="P7000497027000000000000000041FAB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041FAC" id="P7000497027000000000000000041FAC">Fill in the right-hand column of the following table to describe the processing of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FAD" id="P7000497027000000000000000041FAD">irmovq</code> instruction on line 4 of the object code in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D6D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17</span></a>:</p></div>
</li>
</ol>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000041FAE" id="P7000497027000000000000000041FAE">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FAF" id="P7000497027000000000000000041FAF">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FB0" id="P7000497027000000000000000041FB0">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FB1" id="P7000497027000000000000000041FB1">irmovq</code> V, rB</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FB2" id="P7000497027000000000000000041FB2">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FB3" id="P7000497027000000000000000041FB3">irmovq $128, %rsp</code> </th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FB4" id="P7000497027000000000000000041FB4">Fetch </td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FB5" id="P7000497027000000000000000041FB5">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 2]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valP ← PC+ 10</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FB6" id="P7000497027000000000000000041FB6">
Decode</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FB7" id="P7000497027000000000000000041FB7">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FB8" id="P7000497027000000000000000041FB8">valE ← 0 + valC</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
</tbody>
</table>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003DBF" id="P7000497027000000000000000003DBF"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000041FB9" epub:type="title" id="P7000497027000000000000000041FB9"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003DC1" epub:type="pagebreak" id="P7000497027000000000000000003DC1" title="388"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Tracing the execution of a <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter04.xhtml#P7000497027000000000000000041FBA" id="P7000497027000000000000000041FBA">subq</code> instruction</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000041FBB" id="P7000497027000000000000000041FBB">As an example, let us follow the processing of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FBC" id="P7000497027000000000000000041FBC">subq</code> instruction on line 3 of the object code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D6D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17</span></a>. We can see that the previous two instructions initialize registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FBD" id="P7000497027000000000000000041FBD">%rdx</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FBE" id="P7000497027000000000000000041FBE">%rbx</code> to 9 and 21, respectively. We can also see that the instruction is located at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FBF" id="P7000497027000000000000000041FBF">0x014</code> and consists of 2 bytes, having values <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FC0" id="P7000497027000000000000000041FC0">0x61</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FC1" id="P7000497027000000000000000041FC1">0x23</code>. The stages would proceed as shown in the following table, which lists the generic rule for processing an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FC2" id="P7000497027000000000000000041FC2">OPq</code> instruction (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D82"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18</span></a>) on the left, and the computations for this specific instruction on the right.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000041FC3" id="P7000497027000000000000000041FC3">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FC4" id="P7000497027000000000000000041FC4">Stage	</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FC5" id="P7000497027000000000000000041FC5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FC6" id="P7000497027000000000000000041FC6">OPq</code> rA, rB	</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FC7" id="P7000497027000000000000000041FC7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FC8" id="P7000497027000000000000000041FC8">subq %rdx, %rbx</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FC9" id="P7000497027000000000000000041FC9">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FCA" id="P7000497027000000000000000041FCA">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← MT.PC + 1]
</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FCB" id="P7000497027000000000000000041FCB">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FCC" id="P7000497027000000000000000041FCC">0x014</code>] = 6:1<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FCD" id="P7000497027000000000000000041FCD">0x015</code>] = 2:3</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FCE" id="P7000497027000000000000000041FCE">valP ← PC+ 2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FCF" id="P7000497027000000000000000041FCF">valP ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FD0" id="P7000497027000000000000000041FD0">0x014 + 2 = 0x016</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FD1" id="P7000497027000000000000000041FD1">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FD2" id="P7000497027000000000000000041FD2">valA ← R[rA]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valB ← R[rB]
</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FD3" id="P7000497027000000000000000041FD3">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FD4" id="P7000497027000000000000000041FD4">%rdx</code>] = 9<br class="pcalibre1 pcalibre2 pcalibre7"/>
va IB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FD5" id="P7000497027000000000000000041FD5">%rbx</code>] = 21</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FD6" id="P7000497027000000000000000041FD6">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FD7" id="P7000497027000000000000000041FD7">valE ← valBOPvalA<br class="pcalibre1 pcalibre2 pcalibre7"/>SetCC</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FD8" id="P7000497027000000000000000041FD8">valE ← 21 - 9=12<br class="pcalibre1 pcalibre2 pcalibre7"/>
ZF ← 0, SF ← 0, OF ← 0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FD9" id="P7000497027000000000000000041FD9">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FDA" id="P7000497027000000000000000041FDA">Write back</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FDB" id="P7000497027000000000000000041FDB">R[rB] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FDC" id="P7000497027000000000000000041FDC">R[%rbx] ← valE = 12</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FDD" id="P7000497027000000000000000041FDD">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FDE" id="P7000497027000000000000000041FDE">PC ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FDF" id="P7000497027000000000000000041FDF">PC ← valP = <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FE0" id="P7000497027000000000000000041FE0">0x016</code></td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000041FE1" id="P7000497027000000000000000041FE1">As this trace shows, we achieve the desired effect of setting register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FE2" id="P7000497027000000000000000041FE2">%rbx</code> to 12, setting all three condition codes to zero, and incrementing the PC by 2.</p>
</aside>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000041FE3" id="P7000497027000000000000000041FE3">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FE4" id="P7000497027000000000000000041FE4">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FE5" id="P7000497027000000000000000041FE5">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FE6" id="P7000497027000000000000000041FE6">irmovq</code>V, rB</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FE7" id="P7000497027000000000000000041FE7">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FE8" id="P7000497027000000000000000041FE8">irmovq $128, %rsp</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FE9" id="P7000497027000000000000000041FE9">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FEA" id="P7000497027000000000000000041FEA">Writeback</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FEB" id="P7000497027000000000000000041FEB">R[rB] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FEC" id="P7000497027000000000000000041FEC">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FED" id="P7000497027000000000000000041FED">PC ← va IP</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FEE" id="P7000497027000000000000000041FEE">How does this instruction execution modify the registers and the PC?</p>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FEF" id="P7000497027000000000000000041FEF"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003DFA"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.19</span></a> shows the processing required for the memory write and read instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FF0" id="P7000497027000000000000000041FF0">rmmovq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FF1" id="P7000497027000000000000000041FF1">mrmovq</code>. We see the same basic flow as before, but using the ALU to add valC to valB, giving the effective address (the sum of the displacement and the base register value) for the memory operation. In the memory stage, we either write the register value valA to memory or read valM from memory.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003DFA" id="P7000497027000000000000000003DFA">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000041FF2" id="P7000497027000000000000000041FF2">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FF3" id="P7000497027000000000000000041FF3"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003DFD" epub:type="pagebreak" id="P7000497027000000000000000003DFD" title="389"></span>
Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FF4" id="P7000497027000000000000000041FF4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FF5" id="P7000497027000000000000000041FF5">rmmovq</code> rA, D(rB)</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000041FF6" id="P7000497027000000000000000041FF6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000041FF7" id="P7000497027000000000000000041FF7">mrmovq</code> D (rB), rA</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FF8" id="P7000497027000000000000000041FF8">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FF9" id="P7000497027000000000000000041FF9">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 2]<br class="pcalibre1 caption pcalibre2"/>
valP ← PC+ 10</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FFA" id="P7000497027000000000000000041FFA">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 2]<br class="pcalibre1 caption pcalibre2"/>
valP ← PC+ 10</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FFB" id="P7000497027000000000000000041FFB">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FFC" id="P7000497027000000000000000041FFC">valA ← R[rA]<br class="pcalibre1 caption pcalibre2"/>
valB ← R[rB]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FFD" id="P7000497027000000000000000041FFD"><br class="pcalibre1 caption pcalibre2"/>valB ← R[rB]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FFE" id="P7000497027000000000000000041FFE">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000041FFF" id="P7000497027000000000000000041FFF">valE ← valB + valC</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042000" id="P7000497027000000000000000042000">valE ← valB + valC</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042001" id="P7000497027000000000000000042001">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042002" id="P7000497027000000000000000042002">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valE] ← valA</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042003" id="P7000497027000000000000000042003">valM ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valE]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042004" id="P7000497027000000000000000042004">Write back</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042005" id="P7000497027000000000000000042005">R[rA] ← valM</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042006" id="P7000497027000000000000000042006">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042007" id="P7000497027000000000000000042007">PC ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042008" id="P7000497027000000000000000042008">PC ← valP</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042009" id="P7000497027000000000000000042009"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P700049702700000000000000004200A" epub:type="title" id="P700049702700000000000000004200A"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.19 </span>Computations in sequential implementation of Y86-64 instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004200B" id="P700049702700000000000000004200B">rmmovq</code> <b class="pcalibre1 pcalibre2 pcalibre12">and</b> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004200C" id="P700049702700000000000000004200C">mrmovq</code>.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004200D" id="P700049702700000000000000004200D"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004200E" id="P700049702700000000000000004200E">These instructions read or write memory.
</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004200F" id="P700049702700000000000000004200F">
</p></div>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042010" id="P7000497027000000000000000042010"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E5F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.20</span></a> shows the steps required to process <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042011" id="P7000497027000000000000000042011">pushq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042012" id="P7000497027000000000000000042012">popq</code> instructions. These are among the most difficult Y86-64 instructions to implement, because they involve both accessing memory and incrementing or decrementing the stack pointer. Although the two instructions have similar flows, they have important differences.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042013" id="P7000497027000000000000000042013">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042014" id="P7000497027000000000000000042014">pushq</code> instruction starts much like our previous instructions, but in the decode stage we use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042015" id="P7000497027000000000000000042015">%rsp</code> as the identifier for the second register operand, giving the stack pointer as value valB. In the execute stage, we use the ALU to decrement the stack pointer by 8. This decremented value is used for the memory write address and is also stored back to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042016" id="P7000497027000000000000000042016">%rsp</code> in the write-back stage. By using valE as the address for the write operation, we adhere to the Y86-64 (and x86-64) convention that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042017" id="P7000497027000000000000000042017">pushq</code> should decrement the stack pointer before writing, even though the actual updating of the stack pointer does not occur until after the memory operation has completed.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042018" id="P7000497027000000000000000042018">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042019" id="P7000497027000000000000000042019">popq</code> instruction proceeds much like <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004201A" id="P700049702700000000000000004201A">pushq</code>, except that we read two copies of the stack pointer in the decode stage. This is clearly redundant, but we will see that having the stack pointer as both valA and valB makes the subsequent flow more similar to that of other instructions, enhancing the overall uniformity of the design. We use the ALU to increment the stack pointer by 8 in the execute stage, but use the unincremented value as the address for the memory operation. In the write-back stage, we update both the stack pointer register with the incremented stack pointer and register rA with the value read from memory. Using the unincremented stack pointer as the memory read address preserves the Y86-64</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003E24" id="P7000497027000000000000000003E24"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P700049702700000000000000004201B" epub:type="title" id="P700049702700000000000000004201B"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003E26" epub:type="pagebreak" id="P7000497027000000000000000003E26" title="390"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Tracing the execution of an <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter04.xhtml#P700049702700000000000000004201C" id="P700049702700000000000000004201C">rmmovq</code> instruction</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004201D" id="P700049702700000000000000004201D">Let us trace the processing of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004201E" id="P700049702700000000000000004201E">rmmovq</code> instruction on line 5 of the object code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D6D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17</span></a>. We can see that the previous instruction initialized register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004201F" id="P700049702700000000000000004201F">%rsp</code> to 128, while <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042020" id="P7000497027000000000000000042020">%rbx</code> still holds 12, as computed by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042021" id="P7000497027000000000000000042021">subq</code> instruction (line 3). We can also see that the instruction is located at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042022" id="P7000497027000000000000000042022">0x020</code> and consists of 10 bytes. The first 2 bytes have values <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042023" id="P7000497027000000000000000042023">0x40</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042024" id="P7000497027000000000000000042024">0x43</code>, while the final 8 bytes are a byte-reversed version of the number <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042025" id="P7000497027000000000000000042025">0x0000000000000064</code> (decimal 100). The stages would proceed as follows:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042026" id="P7000497027000000000000000042026">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042027" id="P7000497027000000000000000042027">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042028" id="P7000497027000000000000000042028">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042029" id="P7000497027000000000000000042029">rmmovq</code> rA, D(rB)</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004202A" id="P700049702700000000000000004202A">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004202B" id="P700049702700000000000000004202B">rmmovq</code> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004202C" id="P700049702700000000000000004202C">%rsp</code>, 100(<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004202D" id="P700049702700000000000000004202D">%rbx</code>)</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004202E" id="P700049702700000000000000004202E">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004202F" id="P700049702700000000000000004202F">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 2]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valP ← PC+ 10</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042030" id="P7000497027000000000000000042030">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042031" id="P7000497027000000000000000042031">0x020</code>] = 4:0<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042032" id="P7000497027000000000000000042032">0x021</code>] = 4:3<br class="pcalibre1 pcalibre2 pcalibre7"/>
valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042033" id="P7000497027000000000000000042033">0x022</code>] = 100<br class="pcalibre1 pcalibre2 pcalibre7"/>
valP ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042034" id="P7000497027000000000000000042034">0x020 + 10 = 0x02a</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042035" id="P7000497027000000000000000042035">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042036" id="P7000497027000000000000000042036">valA ← R[rA]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valB ← R[rB]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042037" id="P7000497027000000000000000042037">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042038" id="P7000497027000000000000000042038">%rsp</code>] = 128<br class="pcalibre1 pcalibre2 pcalibre7"/>va IB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042039" id="P7000497027000000000000000042039">%rbx</code>] = 12</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004203A" id="P700049702700000000000000004203A">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004203B" id="P700049702700000000000000004203B">valE ← valB + valC</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004203C" id="P700049702700000000000000004203C">valE ← 12 + 100 = 112</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004203D" id="P700049702700000000000000004203D">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004203E" id="P700049702700000000000000004203E">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valE] ← valA</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004203F" id="P700049702700000000000000004203F">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[112] ← 128</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042040" id="P7000497027000000000000000042040">Write back</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042041" id="P7000497027000000000000000042041">
PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042042" id="P7000497027000000000000000042042">PC ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042043" id="P7000497027000000000000000042043">PC ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042044" id="P7000497027000000000000000042044">0x02a</code></td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042045" id="P7000497027000000000000000042045">As this trace shows, the instruction has the effect of writing 128 to memory address 112 and incrementing the PC by 10.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042046" id="P7000497027000000000000000042046">(and x86-64) convention that popq should first read memory and then increment the stack pointer.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003E52" epub:type="practice" id="P7000497027000000000000000003E52"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042047" epub:type="title" id="P7000497027000000000000000042047"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.14 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P700049702700000000000000000474C">486</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000042048" id="P7000497027000000000000000042048">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000042049" id="P7000497027000000000000000042049">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P700049702700000000000000004204A" id="P700049702700000000000000004204A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004204B" id="P700049702700000000000000004204B">Fill in the right-hand column of the following table to describe the processing of the popq instruction on line 7 of the object code in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D6D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17</span></a>.</p></div></li>
</ol>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P700049702700000000000000004204C" id="P700049702700000000000000004204C">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004204D" id="P700049702700000000000000004204D">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004204E" id="P700049702700000000000000004204E">Generic popq rA</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004204F" id="P700049702700000000000000004204F">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042050" id="P7000497027000000000000000042050">popq %rax</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042051" id="P7000497027000000000000000042051">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042052" id="P7000497027000000000000000042052">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]
<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]
<br class="pcalibre1 pcalibre2 pcalibre7"/>
valP ← PC+ 2</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
</tbody>
</table>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003E5F" id="P7000497027000000000000000003E5F">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042053" id="P7000497027000000000000000042053">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042054" id="P7000497027000000000000000042054"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003E62" epub:type="pagebreak" id="P7000497027000000000000000003E62" title="391"></span>Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042055" id="P7000497027000000000000000042055"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042056" id="P7000497027000000000000000042056">pushq</code> rA</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042057" id="P7000497027000000000000000042057"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042058" id="P7000497027000000000000000042058">popq</code> rA</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042059" id="P7000497027000000000000000042059">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004205A" id="P700049702700000000000000004205A">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004205B" id="P700049702700000000000000004205B">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004205C" id="P700049702700000000000000004205C">valP ← PC+ 2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004205D" id="P700049702700000000000000004205D">valP ← PC+ 2</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004205E" id="P700049702700000000000000004205E">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004205F" id="P700049702700000000000000004205F">valA ← R[rA]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042060" id="P7000497027000000000000000042060">%rsp</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042061" id="P7000497027000000000000000042061">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042062" id="P7000497027000000000000000042062">%rsp</code>]<br class="pcalibre1 pcalibre2 pcalibre7"/>
va IB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042063" id="P7000497027000000000000000042063">%rsp</code>]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042064" id="P7000497027000000000000000042064">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042065" id="P7000497027000000000000000042065">valE ← valB+(-8)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042066" id="P7000497027000000000000000042066">valE ← valB + 8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042067" id="P7000497027000000000000000042067">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042068" id="P7000497027000000000000000042068">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valE] ← valA</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042069" id="P7000497027000000000000000042069">va IM ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valA]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004206A" id="P700049702700000000000000004206A">Write back</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004206B" id="P700049702700000000000000004206B">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004206C" id="P700049702700000000000000004206C">%rsp</code>] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004206D" id="P700049702700000000000000004206D">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004206E" id="P700049702700000000000000004206E">%rsp</code>] ← valE <br class="pcalibre1 caption pcalibre2"/>R[rA] ← valM</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004206F" id="P700049702700000000000000004206F">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042070" id="P7000497027000000000000000042070">PC ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042071" id="P7000497027000000000000000042071">PC ← valP</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042072" id="P7000497027000000000000000042072"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042073" epub:type="title" id="P7000497027000000000000000042073"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.20 </span>Computations in sequential implementation of Y86-64 instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042074" id="P7000497027000000000000000042074">pushq</code> <b class="pcalibre1 pcalibre2 pcalibre12">and</b> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042075" id="P7000497027000000000000000042075">popq</code>.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042076" id="P7000497027000000000000000042076"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042077" id="P7000497027000000000000000042077">These instructions push and pop the stack.
</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042078" id="P7000497027000000000000000042078">
</p></div>
</figcaption>
</figure>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042079" id="P7000497027000000000000000042079">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004207A" id="P700049702700000000000000004207A">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004207B" id="P700049702700000000000000004207B">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004207C" id="P700049702700000000000000004207C">popq</code> rA</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004207D" id="P700049702700000000000000004207D">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004207E" id="P700049702700000000000000004207E">popq %rax</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004207F" id="P700049702700000000000000004207F">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042080" id="P7000497027000000000000000042080">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042081" id="P7000497027000000000000000042081">%rsp</code>]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042082" id="P7000497027000000000000000042082">%rsp</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7"></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042083" id="P7000497027000000000000000042083">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042084" id="P7000497027000000000000000042084">valE ← valB + 8</td>
<td class="pcalibre1 pcalibre2 calibre7"></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042085" id="P7000497027000000000000000042085">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042086" id="P7000497027000000000000000042086">valM ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valA]</td>
<td class="pcalibre1 pcalibre2 calibre7"></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042087" id="P7000497027000000000000000042087">
Write back</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042088" id="P7000497027000000000000000042088">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042089" id="P7000497027000000000000000042089">%rsp</code>] ← valE<br class="pcalibre1 pcalibre2 pcalibre7"/>
R[rA] ← valM</td>
<td class="pcalibre1 pcalibre2 calibre7"></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004208A" id="P700049702700000000000000004208A">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004208B" id="P700049702700000000000000004208B">PC ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7"></td></tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004208C" id="P700049702700000000000000004208C">What effect does this instruction execution have on the registers and the PC?</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003E9A" epub:type="practice" id="P7000497027000000000000000003E9A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004208D" epub:type="title" id="P700049702700000000000000004208D"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.15 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P700049702700000000000000000474C">486</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P700049702700000000000000004208E" id="P700049702700000000000000004208E">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P700049702700000000000000004208F" id="P700049702700000000000000004208F">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042090" id="P7000497027000000000000000042090"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042091" id="P7000497027000000000000000042091">What would be the effect of the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042092" id="P7000497027000000000000000042092">pushq %rsp</code> according to the steps listed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E5F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.20</span></a>? Does this conform to the desired behavior for Y86-64, as determined in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C54"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.7</span></a>?</p></div></li></ol>
</section>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003EA1" id="P7000497027000000000000000003EA1"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000042093" epub:type="title" id="P7000497027000000000000000042093"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003EA3" epub:type="pagebreak" id="P7000497027000000000000000003EA3" title="392"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Tracing the execution of a <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter04.xhtml#P7000497027000000000000000042094" id="P7000497027000000000000000042094">pushq</code> instruction</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042095" id="P7000497027000000000000000042095">Let us trace the processing of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042096" id="P7000497027000000000000000042096">pushq</code> instruction on line 6 of the object code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D6D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17</span></a>. At this point, we have 9 in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042097" id="P7000497027000000000000000042097">%rdx</code> and 128 in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042098" id="P7000497027000000000000000042098">%rsp</code>. We can also see that the instruction is located at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042099" id="P7000497027000000000000000042099">0x02a</code> and consists of 2 bytes having values <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004209A" id="P700049702700000000000000004209A">0xa0</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004209B" id="P700049702700000000000000004209B">0x2f</code>. The stages would proceed as follows:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P700049702700000000000000004209C" id="P700049702700000000000000004209C">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004209D" id="P700049702700000000000000004209D">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004209E" id="P700049702700000000000000004209E">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004209F" id="P700049702700000000000000004209F">pushq</code> rA</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000420A0" id="P70004970270000000000000000420A0">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420A1" id="P70004970270000000000000000420A1">pushq %rdx</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420A2" id="P70004970270000000000000000420A2">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420A3" id="P70004970270000000000000000420A3">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← MT.PC + 1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420A4" id="P70004970270000000000000000420A4">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420A5" id="P70004970270000000000000000420A5">0x02a] = a:0</code><br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420A6" id="P70004970270000000000000000420A6">0x02b] = 2 : f</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420A7" id="P70004970270000000000000000420A7">valP ← PC+ 2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420A8" id="P70004970270000000000000000420A8">valP ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420A9" id="P70004970270000000000000000420A9">0x02a + 2 = 0x02c</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420AA" id="P70004970270000000000000000420AA">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420AB" id="P70004970270000000000000000420AB">valA ← R[rA]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420AC" id="P70004970270000000000000000420AC">%rsp</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420AD" id="P70004970270000000000000000420AD">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420AE" id="P70004970270000000000000000420AE">%rdx</code>] = 9<br class="pcalibre1 pcalibre2 pcalibre7"/>
valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420AF" id="P70004970270000000000000000420AF">%rsp</code>] = 128</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420B0" id="P70004970270000000000000000420B0">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420B1" id="P70004970270000000000000000420B1">valE ← valB + (-8)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420B2" id="P70004970270000000000000000420B2">valE ← 128+ (-8) = 120</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420B3" id="P70004970270000000000000000420B3">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420B4" id="P70004970270000000000000000420B4">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valE] ← valA</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420B5" id="P70004970270000000000000000420B5">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[120] ← 9</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420B6" id="P70004970270000000000000000420B6">Write back</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420B7" id="P70004970270000000000000000420B7">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420B8" id="P70004970270000000000000000420B8">%rsp</code>] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420B9" id="P70004970270000000000000000420B9">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420BA" id="P70004970270000000000000000420BA">%rsp</code>] ← 120</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420BB" id="P70004970270000000000000000420BB">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420BC" id="P70004970270000000000000000420BC">PC ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420BD" id="P70004970270000000000000000420BD">PC ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420BE" id="P70004970270000000000000000420BE">0x02c</code></td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000420BF" id="P70004970270000000000000000420BF">As this trace shows, the instruction has the effect of setting <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420C0" id="P70004970270000000000000000420C0">%rsp</code> to 120, writing 9 to address 120, and incrementing the PC by 2.</p>
</aside>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003ED1" epub:type="practice" id="P7000497027000000000000000003ED1"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420C1" epub:type="title" id="P70004970270000000000000000420C1"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.16 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P700049702700000000000000000474C">486</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P70004970270000000000000000420C2" id="P70004970270000000000000000420C2">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P70004970270000000000000000420C3" id="P70004970270000000000000000420C3">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420C4" id="P70004970270000000000000000420C4">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000420C5" id="P70004970270000000000000000420C5">Assume the two register writes in the write-back stage for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420C6" id="P70004970270000000000000000420C6">popq</code> occur in the order listed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E5F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.20</span></a>. What would be the effect of executing <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420C7" id="P70004970270000000000000000420C7">popq %rsp</code>? Does this conform to the desired behavior for Y86-64, as determined in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C64"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.8</span></a>?</p></div>
</li>
</ol>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420C8" id="P70004970270000000000000000420C8"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003EDE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.21</span></a> indicates the processing of our three control transfer instructions: the different jumps, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420C9" id="P70004970270000000000000000420C9">call</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420CA" id="P70004970270000000000000000420CA">ret</code>. We see that we can implement these instructions with the same overall flow as the preceding ones.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420CB" id="P70004970270000000000000000420CB">As with integer operations, we can process all of the jumps in a uniform manner, since they differ only when determining whether or not to take the branch. A jump instruction proceeds through fetch and decode much like the previous instructions, except that it does not require a register specifier byte. In the execute stage, we check the condition codes and the jump condition to determine whether or not to take the branch, yielding a 1-bit signal <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420CC" id="P70004970270000000000000000420CC">Cnd</code>. During the PC update stage, we test this flag and set the PC to valC (the jump target) if the flag is 1 and to valP (the address of the following instruction) if the flag is 0. Our notation <var class="pcalibre17 pcalibre2 pcalibre1">x</var> ? <var class="pcalibre17 pcalibre2 pcalibre1">a</var> : <var class="pcalibre17 pcalibre2 pcalibre1">b</var> is similar to the conditional expression in C—it yields <var class="pcalibre17 pcalibre2 pcalibre1">a</var> when <var class="pcalibre17 pcalibre2 pcalibre1">x</var> is 1 and <var class="pcalibre17 pcalibre2 pcalibre1">b</var> when <var class="pcalibre17 pcalibre2 pcalibre1">x</var> is 0.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003EDE" id="P7000497027000000000000000003EDE">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P70004970270000000000000000420CD" id="P70004970270000000000000000420CD">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000420CE" id="P70004970270000000000000000420CE"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003EE1" epub:type="pagebreak" id="P7000497027000000000000000003EE1" title="393"></span>Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000420CF" id="P70004970270000000000000000420CF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420D0" id="P70004970270000000000000000420D0">jXX</code> Dest</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000420D1" id="P70004970270000000000000000420D1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420D2" id="P70004970270000000000000000420D2">call</code> Dest</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000420D3" id="P70004970270000000000000000420D3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420D4" id="P70004970270000000000000000420D4">ret</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420D5" id="P70004970270000000000000000420D5">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420D6" id="P70004970270000000000000000420D6">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 1]<br class="pcalibre1 caption pcalibre2"/>
valP ← PC+ 9
</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420D7" id="P70004970270000000000000000420D7">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 1]<br class="pcalibre1 caption pcalibre2"/>valP ← PC+ 9</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420D8" id="P70004970270000000000000000420D8">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 caption pcalibre2"/>
valP ← PC + 1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420D9" id="P70004970270000000000000000420D9">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420DA" id="P70004970270000000000000000420DA"><br class="pcalibre1 pcalibre2 pcalibre7"/>valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420DB" id="P70004970270000000000000000420DB">%rsp</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420DC" id="P70004970270000000000000000420DC">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420DD" id="P70004970270000000000000000420DD">%rsp</code>]<br class="pcalibre1 pcalibre2 pcalibre7"/>valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420DE" id="P70004970270000000000000000420DE">%rsp</code>]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420DF" id="P70004970270000000000000000420DF">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420E0" id="P70004970270000000000000000420E0"><br class="pcalibre1 caption pcalibre2"/>Cnd ← Cond(CC, ifun)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420E1" id="P70004970270000000000000000420E1">valE ← valB + (-8)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420E2" id="P70004970270000000000000000420E2">valE ← valB + 8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420E3" id="P70004970270000000000000000420E3">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420E4" id="P70004970270000000000000000420E4">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valE] ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420E5" id="P70004970270000000000000000420E5">valM ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valA]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420E6" id="P70004970270000000000000000420E6">Write back</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420E7" id="P70004970270000000000000000420E7">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420E8" id="P70004970270000000000000000420E8">%rsp</code>] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420E9" id="P70004970270000000000000000420E9">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420EA" id="P70004970270000000000000000420EA">%rsp</code>] ← valE</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420EB" id="P70004970270000000000000000420EB">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420EC" id="P70004970270000000000000000420EC">PC ← Cnd?valC:valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420ED" id="P70004970270000000000000000420ED">PC ← valC</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420EE" id="P70004970270000000000000000420EE">PC ← valM</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P70004970270000000000000000420EF" id="P70004970270000000000000000420EF"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P70004970270000000000000000420F0" epub:type="title" id="P70004970270000000000000000420F0"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.21 </span>Computations in sequential implementation of Y86-64 instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420F1" id="P70004970270000000000000000420F1">jXX, call</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420F2" id="P70004970270000000000000000420F2">ret</code>.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420F3" id="P70004970270000000000000000420F3"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420F4" id="P70004970270000000000000000420F4"> These instructions cause control transfers.
</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000420F5" id="P70004970270000000000000000420F5">
</p></div>
</figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003F08" epub:type="practice" id="P7000497027000000000000000003F08"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420F6" epub:type="title" id="P70004970270000000000000000420F6"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P700049702700000000000000000474C">486</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P70004970270000000000000000420F7" id="P70004970270000000000000000420F7">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P70004970270000000000000000420F8" id="P70004970270000000000000000420F8">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P70004970270000000000000000420F9" id="P70004970270000000000000000420F9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000420FA" id="P70004970270000000000000000420FA">We can see by the instruction encodings (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figures </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">4.3</span></a>) that the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420FB" id="P70004970270000000000000000420FB">rrmovq</code> instruction is the unconditional version of a more general class of instructions that include the conditional moves. Show how you would modify the steps for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420FC" id="P70004970270000000000000000420FC">rrmovq</code> instruction below to also handle the six conditional move instructions. You may find it useful to see how the implementation of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000420FD" id="P70004970270000000000000000420FD">jXX</code> instructions (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003EDE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.21</span></a>) handles conditional behavior.</p></div>
</li>
</ol>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P70004970270000000000000000420FE" id="P70004970270000000000000000420FE">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2"><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000420FF" id="P70004970270000000000000000420FF">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042100" id="P7000497027000000000000000042100"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042101" id="P7000497027000000000000000042101">cmovXX</code> rA, rB</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042102" id="P7000497027000000000000000042102">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042103" id="P7000497027000000000000000042103">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>
rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valP ← PC + 2</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042104" id="P7000497027000000000000000042104">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042105" id="P7000497027000000000000000042105">valA ← R[rA]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042106" id="P7000497027000000000000000042106">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042107" id="P7000497027000000000000000042107">valE ← 0 + valA</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042108" id="P7000497027000000000000000042108">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042109" id="P7000497027000000000000000042109">Write back</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004210A" id="P700049702700000000000000004210A">
</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004210B" id="P700049702700000000000000004210B">R[rB] ← valE</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004210C" id="P700049702700000000000000004210C">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004210D" id="P700049702700000000000000004210D">PC ← valP</td>
</tr>
</tbody>
</table>
</section>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003F21" id="P7000497027000000000000000003F21"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P700049702700000000000000004210E" epub:type="title" id="P700049702700000000000000004210E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003F23" epub:type="pagebreak" id="P7000497027000000000000000003F23" title="394"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Tracing the execution of a <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter04.xhtml#P700049702700000000000000004210F" id="P700049702700000000000000004210F">je</code> instruction</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042110" id="P7000497027000000000000000042110">Let us trace the processing of the je instruction on line 8 of the object code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D6D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17</span></a>. The condition codes were all set to zero by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042111" id="P7000497027000000000000000042111">subq</code> instruction (line 3), and so the branch will not be taken. The instruction is located at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042112" id="P7000497027000000000000000042112">0x02e</code> and consists of 9 bytes. The first has value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042113" id="P7000497027000000000000000042113">0x73</code>, while the remaining 8 bytes are a byte-reversed version of the number <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042114" id="P7000497027000000000000000042114">0x0000000000000040</code>, the jump target. The stages would proceed as follows:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042115" id="P7000497027000000000000000042115">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042116" id="P7000497027000000000000000042116">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042117" id="P7000497027000000000000000042117">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042118" id="P7000497027000000000000000042118">jXX</code> Dest</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042119" id="P7000497027000000000000000042119">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004211A" id="P700049702700000000000000004211A">je 0x040</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004211B" id="P700049702700000000000000004211B">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004211C" id="P700049702700000000000000004211C">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004211D" id="P700049702700000000000000004211D">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004211E" id="P700049702700000000000000004211E">0x02e] = 7:3</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004211F" id="P700049702700000000000000004211F">valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042120" id="P7000497027000000000000000042120">valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042121" id="P7000497027000000000000000042121">[0x02f] = 0x040</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042122" id="P7000497027000000000000000042122">valP ← PC+ 9</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042123" id="P7000497027000000000000000042123">valP ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042124" id="P7000497027000000000000000042124">0x02e + 9 = 0x037</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042125" id="P7000497027000000000000000042125">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042126" id="P7000497027000000000000000042126">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042127" id="P7000497027000000000000000042127">
</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042128" id="P7000497027000000000000000042128">Cnd ← Cond(CC, ifun)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042129" id="P7000497027000000000000000042129">Cnd ← Cond<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004212A" id="P700049702700000000000000004212A">((0, 0, 0&gt;,3)=0</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004212B" id="P700049702700000000000000004212B">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004212C" id="P700049702700000000000000004212C">
Write back</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004212D" id="P700049702700000000000000004212D">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004212E" id="P700049702700000000000000004212E">PC ← Cnd?valC:valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004212F" id="P700049702700000000000000004212F">PC ← 0 ? <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042130" id="P7000497027000000000000000042130">0x040:0x037 = 0x037</code></td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042131" id="P7000497027000000000000000042131">As this trace shows, the instruction has the effect of incrementing the PC by 9.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042132" id="P7000497027000000000000000042132">Instructions call and ret bear some similarity to instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042133" id="P7000497027000000000000000042133">pushq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042134" id="P7000497027000000000000000042134">popq</code>, except that we push and pop program counter values. With instruction call, we push valP, the address of the instruction that follows the call instruction. During the PC update stage, we set the PC to valC, the call destination. With instruction ret, we assign valM, the value popped from the stack, to the PC in the PC update stage.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003F4A" id="P7000497027000000000000000003F4A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042135" epub:type="title" id="P7000497027000000000000000042135"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P7000497027000000000000000004798">487</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042136" id="P7000497027000000000000000042136">Fill in the right-hand column of the following table to describe the processing of the call instruction on line 9 of the object code in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D6D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17</span></a>:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042137" id="P7000497027000000000000000042137">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042138" id="P7000497027000000000000000042138">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042139" id="P7000497027000000000000000042139">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004213A" id="P700049702700000000000000004213A">call</code> Dest</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004213B" id="P700049702700000000000000004213B">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004213C" id="P700049702700000000000000004213C">call 0x041</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004213D" id="P700049702700000000000000004213D">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004213E" id="P700049702700000000000000004213E">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004213F" id="P700049702700000000000000004213F">valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 1]<br class="pcalibre1 pcalibre2 pcalibre7"/>
valP ← PC+ 9</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
</tbody>
</table>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000003F56" id="P7000497027000000000000000003F56"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000042140" epub:type="title" id="P7000497027000000000000000042140"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003F58" epub:type="pagebreak" id="P7000497027000000000000000003F58" title="395"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Tracing the execution of a ret instruction</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042141" id="P7000497027000000000000000042141">Let us trace the processing of the ret instruction on line 13 of the object code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D6D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17</span></a>. The instruction address is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042142" id="P7000497027000000000000000042142">0x041</code> and is encoded by a single byte <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042143" id="P7000497027000000000000000042143">0x90</code>. The previous call instruction set <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042144" id="P7000497027000000000000000042144">%rsp</code> to 120 and stored the return address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042145" id="P7000497027000000000000000042145">0x040</code> at memory address 120. The stages would proceed as follows:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042146" id="P7000497027000000000000000042146">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042147" id="P7000497027000000000000000042147">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042148" id="P7000497027000000000000000042148">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042149" id="P7000497027000000000000000042149">ret</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004214A" id="P700049702700000000000000004214A">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004214B" id="P700049702700000000000000004214B">ret</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004214C" id="P700049702700000000000000004214C">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004214D" id="P700049702700000000000000004214D">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004214E" id="P700049702700000000000000004214E">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004214F" id="P700049702700000000000000004214F">[0x041] = 9:0</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042150" id="P7000497027000000000000000042150">valP ← PC + 1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042151" id="P7000497027000000000000000042151">valP ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042152" id="P7000497027000000000000000042152">0x041+1 = 0x042</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042153" id="P7000497027000000000000000042153">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042154" id="P7000497027000000000000000042154">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042155" id="P7000497027000000000000000042155">%rsp</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042156" id="P7000497027000000000000000042156">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042157" id="P7000497027000000000000000042157">%rsp</code>] = 120
</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042158" id="P7000497027000000000000000042158">valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042159" id="P7000497027000000000000000042159">%rsp</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004215A" id="P700049702700000000000000004215A">valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004215B" id="P700049702700000000000000004215B">%rsp</code>] = 120</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004215C" id="P700049702700000000000000004215C">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004215D" id="P700049702700000000000000004215D">valE ← valB + 8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004215E" id="P700049702700000000000000004215E">valE ← 120 + 8=128</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004215F" id="P700049702700000000000000004215F">
Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042160" id="P7000497027000000000000000042160">valM ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valA]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042161" id="P7000497027000000000000000042161">valM ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[120] = <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042162" id="P7000497027000000000000000042162">0x040</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042163" id="P7000497027000000000000000042163">
Write back</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042164" id="P7000497027000000000000000042164">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042165" id="P7000497027000000000000000042165">%rsp</code>] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042166" id="P7000497027000000000000000042166">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042167" id="P7000497027000000000000000042167">%rsp</code>] ← 128</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042168" id="P7000497027000000000000000042168">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042169" id="P7000497027000000000000000042169">PC ← valM</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004216A" id="P700049702700000000000000004216A">PC ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004216B" id="P700049702700000000000000004216B">0x040</code></td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004216C" id="P700049702700000000000000004216C">As this trace shows, the instruction has the effect of setting the PC to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004216D" id="P700049702700000000000000004216D">0x040</code>, the address of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004216E" id="P700049702700000000000000004216E">halt</code> instruction. It also sets <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004216F" id="P700049702700000000000000004216F">%rsp</code> to 128.</p>
</aside>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042170" id="P7000497027000000000000000042170">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042171" id="P7000497027000000000000000042171">Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042172" id="P7000497027000000000000000042172">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042173" id="P7000497027000000000000000042173">call</code> Dest</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042174" id="P7000497027000000000000000042174">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042175" id="P7000497027000000000000000042175">call 0x041</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042176" id="P7000497027000000000000000042176">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042177" id="P7000497027000000000000000042177"><br class="pcalibre1 pcalibre2 pcalibre7"/>valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042178" id="P7000497027000000000000000042178">%rsp</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042179" id="P7000497027000000000000000042179">
Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004217A" id="P700049702700000000000000004217A">valE ← valB+(-8)</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004217B" id="P700049702700000000000000004217B">
Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004217C" id="P700049702700000000000000004217C">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valE] ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004217D" id="P700049702700000000000000004217D">
Write back</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004217E" id="P700049702700000000000000004217E">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004217F" id="P700049702700000000000000004217F">%rsp</code>] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042180" id="P7000497027000000000000000042180">
PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042181" id="P7000497027000000000000000042181">PC ← valC</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042182" id="P7000497027000000000000000042182">What effect would this instruction execution have on the registers, the PC, and the memory?</p>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042183" id="P7000497027000000000000000042183">We have created a uniform framework that handles all of the different types of Y86-64 instructions. Even though the instructions have widely varying behavior, we can organize the processing into six stages. Our task now is to create a hardware design that implements the stages and connects them together.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000003F9C" id="P7000497027000000000000000003F9C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042184" epub:type="title" id="P7000497027000000000000000042184"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003F9E" epub:type="pagebreak" id="P7000497027000000000000000003F9E" title="396"></span><span class="pcalibre1 pcalibre21 pcalibre2">4.3.2 </span>SEQ Hardware Structure</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042185" id="P7000497027000000000000000042185">The computations required to implement all of the Y86-64 instructions can be organized as a series of six basic stages: fetch, decode, execute, memory, write back, and PC update. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FAD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.22</span></a> shows an abstract view of a hardware structure that can perform these computations. The program counter is stored in a register, shown in the lower left-hand corner (labeled "PC"). Information then flows along wires (shown grouped together as a heavy gray line), first upward and then around to the right. Processing is performed by <i class="pcalibre17 pcalibre2 pcalibre1">hardware units</i> associated with the different stages. The feedback paths coming back down on the right-hand side contain the updated values to write to the register file and the updated program counter. In SEQ, all of the processing by the hardware units occurs within a single clock cycle, as is discussed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000004004"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3.3</span></a>. This diagram omits some small blocks of combinational logic as well as all of the control logic needed to operate the different hardware units and to route the appropriate values to the units. We will add this detail later. Our method of drawing processors with the flow going from bottom to top is unconventional. We will explain the reason for this convention when we start designing pipelined processors.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042186" id="P7000497027000000000000000042186">The hardware units are associated with the different processing stages:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042187" id="P7000497027000000000000000042187">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042188" id="P7000497027000000000000000042188"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042189" id="P7000497027000000000000000042189"><span class="pcalibre1 pcalibre2 pcalibre41">Fetch. </span>Using the program counter register as an address, the instruction memory reads the bytes of an instruction. The PC incrementer computes valP, the incremented program counter.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004218A" id="P700049702700000000000000004218A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004218B" id="P700049702700000000000000004218B"><span class="pcalibre1 pcalibre2 pcalibre41">Decode. </span>The register file has two read ports, A and B, via which register values valA and valB are read simultaneously.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004218C" id="P700049702700000000000000004218C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004218D" id="P700049702700000000000000004218D"><span class="pcalibre1 pcalibre2 pcalibre41">Execute. </span>The execute stage uses the arithmetic/logic (ALU) unit for different purposes according to the instruction type. For integer operations, it performs the specified operation. For other instructions, it serves as an adder to compute an incremented or decremented stack pointer, to compute an effective address, or simply to pass one of its inputs to its outputs by adding zero.</p>
<p class="pcalibre1 pcalibre2 pcalibre42" data-uri="chapter04.xhtml#P700049702700000000000000004218E" id="P700049702700000000000000004218E">The condition code register (CC) holds the three condition code bits. New values for the condition codes are computed by the ALU. When executing a conditional move instruction, the decision as to whether or not to update the destination register is computed based on the condition codes and move condition. Similarly, when executing a jump instruction, the branch signal Cnd is computed based on the condition codes and the jump type.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004218F" id="P700049702700000000000000004218F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042190" id="P7000497027000000000000000042190"><span class="pcalibre1 pcalibre2 pcalibre41">Memory. </span>The data memory reads or writes a word of memory when executing a memory instruction. The instruction and data memories access the same memory locations, but for different purposes.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042191" id="P7000497027000000000000000042191"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042192" id="P7000497027000000000000000042192"><span class="pcalibre1 pcalibre2 pcalibre41">Write back. </span>The register file has two write ports. Port E is used to write values computed by the ALU, while port M is used to write values read from the data memory.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003FAD" id="P7000497027000000000000000003FAD">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003FAE" epub:type="pagebreak" id="P7000497027000000000000000003FAE" title="397"></span><img alt="A diagram illustrates a sequential implementation." class="pcalibre1 pcalibre152 pcalibre2" data-uri="P700049702700000000000000000B6DA" id="P7000497027000000000000000042193" src="Images/chapter-04-image-17.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042194" id="P7000497027000000000000000042194"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042195" epub:type="title" id="P7000497027000000000000000042195"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.22 </span>Abstract view of SEQ, a sequential implementation.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042196" id="P7000497027000000000000000042196"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042197" id="P7000497027000000000000000042197"> The information processed during execution of an instruction follows a clockwise flow starting with an instruction fetch using the program counter (PC), shown in the lower left-hand corner of the figure.</p><p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter04.xhtml#P7000497027000000000000000042198" id="P7000497027000000000000000042198">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000022473" id="P7000497027000000000000000022473">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042199" id="P7000497027000000000000000042199">A diagram shows a flow through elements, forming various cycles. The elements are summarized in order below, from bottom to top:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P700049702700000000000000004219A" id="P700049702700000000000000004219A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004219B" id="P700049702700000000000000004219B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004219C" id="P700049702700000000000000004219C">PC</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004219D" id="P700049702700000000000000004219D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004219E" id="P700049702700000000000000004219E">Fetch: instruction memory (leading to valC) and PC increments (leading to valP)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004219F" id="P700049702700000000000000004219F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421A0" id="P70004970270000000000000000421A0">Icode, ifun rA, rB</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421A1" id="P70004970270000000000000000421A1"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421A2" id="P70004970270000000000000000421A2">Decode: srcA, srcB, dstE, dstM leading to Register file containing M and E and A and B, which lead to valA, valB</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421A3" id="P70004970270000000000000000421A3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421A4" id="P70004970270000000000000000421A4">Execute: aluA, aluB leading to ALU, which leads to valE and CC, which leads to Cnd</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421A5" id="P70004970270000000000000000421A5"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421A6" id="P70004970270000000000000000421A6">Memory: Addr, Data to Data Memory to valM</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421A7" id="P70004970270000000000000000421A7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421A8" id="P70004970270000000000000000421A8">Write back: valE, valM looping back to Register file M and E</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421A9" id="P70004970270000000000000000421A9"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421AA" id="P70004970270000000000000000421AA">PC update: newPC looping back to PC</p></li>
</ul>
</details>
</figcaption>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421AB" id="P70004970270000000000000000421AB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421AC" id="P70004970270000000000000000421AC"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003FB6" epub:type="pagebreak" id="P7000497027000000000000000003FB6" title="398"></span><span class="pcalibre1 pcalibre2 pcalibre41">PC update. </span>The new value of the program counter is selected to be either valP, the address of the next instruction, valC, the destination address specified by a call or jump instruction, or valM, the return address read from memory.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000421AD" id="P70004970270000000000000000421AD"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FCB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.23</span></a> gives a more detailed view of the hardware required to implement SEQ (although we will not see the complete details until we examine the individual stages). We see the same set of hardware units as earlier, but now the wires are shown explicitly. In this figure, as well as in our other hardware diagrams, we use the following drawing conventions:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000421AE" id="P70004970270000000000000000421AE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421AF" id="P70004970270000000000000000421AF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421B0" id="P70004970270000000000000000421B0"><span class="pcalibre1 pcalibre2 pcalibre41">Clocked registers are shown as white rectangles. </span>The program counter PC is the only clocked register in SEQ.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421B1" id="P70004970270000000000000000421B1"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421B2" id="P70004970270000000000000000421B2"><span class="pcalibre1 pcalibre2 pcalibre41">Hardware units are shown as light blue boxes. </span>These include the memories, the ALU, and so forth. We will use the same basic set of units for all of our processor implementations. We will treat these units as "black boxes" and not go into their detailed designs.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421B3" id="P70004970270000000000000000421B3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421B4" id="P70004970270000000000000000421B4"><span class="pcalibre1 pcalibre2 pcalibre41">Control logic blocks are drawn as gray rounded rectangles. </span>These blocks serve to select from among a set of signal sources or to compute some Boolean function. We will examine these blocks in complete detail, including developing HCL descriptions.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421B5" id="P70004970270000000000000000421B5"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421B6" id="P70004970270000000000000000421B6"><span class="pcalibre1 pcalibre2 pcalibre41">Wire names are indicated in white circles. </span>These are simply labels on the wires, not any kind of hardware element.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421B7" id="P70004970270000000000000000421B7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421B8" id="P70004970270000000000000000421B8"><span class="pcalibre1 pcalibre2 pcalibre41">Word-wide data connections are shown as medium lines. </span>Each of these lines actually represents a bundle of 64 wires, connected in parallel, for transferring a word from one part of the hardware to another.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421B9" id="P70004970270000000000000000421B9"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421BA" id="P70004970270000000000000000421BA"><span class="pcalibre1 pcalibre2 pcalibre41">Byte and narrower data connections are shown as thin lines. </span>Each of these lines actually represents a bundle of four or eight wires, depending on what type of values must be carried on the wires.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421BB" id="P70004970270000000000000000421BB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000421BC" id="P70004970270000000000000000421BC"><span class="pcalibre1 pcalibre2 pcalibre41">Single-bit connections are shown as dotted lines. </span>These represent control values passed between the units and blocks on the chip.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000421BD" id="P70004970270000000000000000421BD">All of the computations we have shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003EDE"><span class="pcalibre1 pcalibre21 pcalibre2">Figures </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18</span></a> through <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FD2"><span class="pcalibre1 pcalibre21 pcalibre2">4.21</span></a> have the property that each line represents either the computation of a specific value, such as valP, or the activation of some hardware unit, such as the memory. These computations and actions are listed in the second column of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FD2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.24</span></a>. In addition to the signals we have already described, this list includes four register ID signals: srcA, the source of valA; srcB, the source of valB; dstE, the register to which valE gets written; and dstM, the register to which valM gets written.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000421BE" id="P70004970270000000000000000421BE">The two right-hand columns of this figure show the computations for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000421BF" id="P70004970270000000000000000421BF">OPq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000421C0" id="P70004970270000000000000000421C0">mrmovq</code> instructions to illustrate the values being computed. To map the computations into hardware, we want to implement control logic that will transfer the data between the different hardware units and operate these units in such a way that the specified operations are performed for each of the different instruction types. That is the purpose of the control logic blocks, shown as gray rounded boxes</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003FCB" id="P7000497027000000000000000003FCB">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000003FCC" epub:type="pagebreak" id="P7000497027000000000000000003FCC" title="399"></span><img alt="A diagram illustrates a hardware sequential implementation." class="pcalibre1 pcalibre2 pcalibre153" data-uri="P700049702700000000000000000B6DB" id="P70004970270000000000000000421C1" src="Images/chapter-04-image-18.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P70004970270000000000000000421C2" id="P70004970270000000000000000421C2"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P70004970270000000000000000421C3" epub:type="title" id="P70004970270000000000000000421C3"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.23 </span>Hardware structure of SEQ, a sequential implementation.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P70004970270000000000000000421C4" id="P70004970270000000000000000421C4"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000421C5" id="P70004970270000000000000000421C5"> Some of the control signals, as well as the register and control word connections, are not shown.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421C6" id="P70004970270000000000000000421C6">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000224A1" id="P70004970270000000000000000224A1">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000421C7" id="P70004970270000000000000000421C7">A diagram shows a flow through elements, as summarized in order below, from bottom to top:</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P70004970270000000000000000421C8" id="P70004970270000000000000000421C8">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421C9" id="P70004970270000000000000000421C9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421CA" id="P70004970270000000000000000421CA">PC</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421CB" id="P70004970270000000000000000421CB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421CC" id="P70004970270000000000000000421CC">Fetch:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P70004970270000000000000000421CD" id="P70004970270000000000000000421CD">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421CE" id="P70004970270000000000000000421CE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421CF" id="P70004970270000000000000000421CF">Instruction memory, with instr_valid and Imem_error leading to Stat in PC update, with outputs:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421D0" id="P70004970270000000000000000421D0">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421D1" id="P70004970270000000000000000421D1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421D2" id="P70004970270000000000000000421D2">icode, to Stat at PC update and New PC</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421D3" id="P70004970270000000000000000421D3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421D4" id="P70004970270000000000000000421D4">ifun</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421D5" id="P70004970270000000000000000421D5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421D6" id="P70004970270000000000000000421D6">rA</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421D7" id="P70004970270000000000000000421D7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421D8" id="P70004970270000000000000000421D8">rB</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421D9" id="P70004970270000000000000000421D9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421DA" id="P70004970270000000000000000421DA">valC, to New PC and ALU A</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421DB" id="P70004970270000000000000000421DB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421DC" id="P70004970270000000000000000421DC">PC increment with output valP, to Data in memory and New PC</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421DD" id="P70004970270000000000000000421DD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421DE" id="P70004970270000000000000000421DE">Decode: Register file with outputs and inputs:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P70004970270000000000000000421DF" id="P70004970270000000000000000421DF">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421E0" id="P70004970270000000000000000421E0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421E1" id="P70004970270000000000000000421E1">Outputs A and B to valA and valB, respectively</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421E2" id="P70004970270000000000000000421E2">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421E3" id="P70004970270000000000000000421E3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421E4" id="P70004970270000000000000000421E4">valA to ALU A as well as Addr and Data in memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421E5" id="P70004970270000000000000000421E5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421E6" id="P70004970270000000000000000421E6">valB to ALU B</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421E7" id="P70004970270000000000000000421E7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421E8" id="P70004970270000000000000000421E8">Inputs M and E</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421E9" id="P70004970270000000000000000421E9">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421EA" id="P70004970270000000000000000421EA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421EB" id="P70004970270000000000000000421EB">M from output valM from Data memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421EC" id="P70004970270000000000000000421EC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421ED" id="P70004970270000000000000000421ED">E as write back from output valE from ALU</p></li>
</ul></li></ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421EE" id="P70004970270000000000000000421EE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421EF" id="P70004970270000000000000000421EF">Execute: ALU with inputs and outputs:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P70004970270000000000000000421F0" id="P70004970270000000000000000421F0">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421F1" id="P70004970270000000000000000421F1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421F2" id="P70004970270000000000000000421F2">Input ALU A from valC and valA</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421F3" id="P70004970270000000000000000421F3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421F4" id="P70004970270000000000000000421F4">Input ALU B from valB</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421F5" id="P70004970270000000000000000421F5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421F6" id="P70004970270000000000000000421F6">Input ALU fun.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421F7" id="P70004970270000000000000000421F7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421F8" id="P70004970270000000000000000421F8">Output CC to Cnd, to dstE, dstM, srcA, and srcB, each with own outputs</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421F9" id="P70004970270000000000000000421F9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421FA" id="P70004970270000000000000000421FA">Output valE to Addr input to Data memory and to Register file E as write back</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421FB" id="P70004970270000000000000000421FB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421FC" id="P70004970270000000000000000421FC">Memory: Data memory with inputs and outputs:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P70004970270000000000000000421FD" id="P70004970270000000000000000421FD">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000421FE" id="P70004970270000000000000000421FE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000421FF" id="P70004970270000000000000000421FF">Inputs read and write from Mem. Control</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042200" id="P7000497027000000000000000042200"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042201" id="P7000497027000000000000000042201">Input Addr from valE and valA</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042202" id="P7000497027000000000000000042202"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042203" id="P7000497027000000000000000042203">Input Data from valP and valA</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042204" id="P7000497027000000000000000042204"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042205" id="P7000497027000000000000000042205">Data out to valM, leading to Register file M and New PC</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042206" id="P7000497027000000000000000042206"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042207" id="P7000497027000000000000000042207">Dmem_error to Stat in PC update</p></li></ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042208" id="P7000497027000000000000000042208"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042209" id="P7000497027000000000000000042209">PC update: Stat output from Stat, with inputs from Instruction memory, icode output of Instruction memory, and Data memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004220A" id="P700049702700000000000000004220A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004220B" id="P700049702700000000000000004220B">New PC with output newPC looping back to PC</p></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000003FD2" id="P7000497027000000000000000003FD2">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P700049702700000000000000004220C" id="P700049702700000000000000004220C">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004220D" id="P700049702700000000000000004220D"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P7000497027000000000000000003FD5" epub:type="pagebreak" id="P7000497027000000000000000003FD5" title="400"></span>Stage</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004220E" id="P700049702700000000000000004220E">Computation</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004220F" id="P700049702700000000000000004220F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042210" id="P7000497027000000000000000042210">OPq</code> rA, rB</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042211" id="P7000497027000000000000000042211"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042212" id="P7000497027000000000000000042212">mrmovq</code> D(rB), rA</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042213" id="P7000497027000000000000000042213">Fetch</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042214" id="P7000497027000000000000000042214">icode, ifun</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042215" id="P7000497027000000000000000042215">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042216" id="P7000497027000000000000000042216">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042217" id="P7000497027000000000000000042217">rA, rB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042218" id="P7000497027000000000000000042218">rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042219" id="P7000497027000000000000000042219">rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC +1]
</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004221A" id="P700049702700000000000000004221A">valC</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004221B" id="P700049702700000000000000004221B">valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 2]
</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004221C" id="P700049702700000000000000004221C">valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004221D" id="P700049702700000000000000004221D">valP ← PC + 2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004221E" id="P700049702700000000000000004221E">valP ← PC+ 10</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004221F" id="P700049702700000000000000004221F">Decode</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042220" id="P7000497027000000000000000042220">valA, srcA</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042221" id="P7000497027000000000000000042221">valA ← R[rA]</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042222" id="P7000497027000000000000000042222">valB, srcB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042223" id="P7000497027000000000000000042223">valB ← R[rB]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042224" id="P7000497027000000000000000042224">valB ← R[rB]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042225" id="P7000497027000000000000000042225">Execute</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042226" id="P7000497027000000000000000042226">valE Cond. codes</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042227" id="P7000497027000000000000000042227">valE ← valB OP valA Set CC</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042228" id="P7000497027000000000000000042228">valE ← valB + valC</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042229" id="P7000497027000000000000000042229">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004222A" id="P700049702700000000000000004222A">Read/write</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004222B" id="P700049702700000000000000004222B">valM ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valE]</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004222C" id="P700049702700000000000000004222C">Write back</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004222D" id="P700049702700000000000000004222D">E port, dstE</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004222E" id="P700049702700000000000000004222E">R[rB] ← valE</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004222F" id="P700049702700000000000000004222F">M port, dstM</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042230" id="P7000497027000000000000000042230">R[rA] ← valM</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042231" id="P7000497027000000000000000042231">PC update</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042232" id="P7000497027000000000000000042232">PC</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042233" id="P7000497027000000000000000042233">PC ← valP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042234" id="P7000497027000000000000000042234">PC ← valP</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042235" id="P7000497027000000000000000042235"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042236" epub:type="title" id="P7000497027000000000000000042236"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.24 </span>Identifying the different computation steps in the sequential implementation.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042237" id="P7000497027000000000000000042237"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042238" id="P7000497027000000000000000042238"> The second column identifies the value being computed or the operation being performed in the stages of SEQ. The computations for instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042239" id="P7000497027000000000000000042239">OPq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004223A" id="P700049702700000000000000004223A">mrmovq</code> are shown as examples of the computations.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004223B" id="P700049702700000000000000004223B">
</p></div>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004223C" id="P700049702700000000000000004223C">in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FCB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.23</span></a>. Our task is to proceed through the individual stages and create detailed designs for these blocks.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004004" id="P7000497027000000000000000004004"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004223D" epub:type="title" id="P700049702700000000000000004223D"><span class="pcalibre1 pcalibre21 pcalibre2">4.3.3 </span>SEQ Timing</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004223E" id="P700049702700000000000000004223E">In introducing the tables of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003EDE"><span class="pcalibre1 pcalibre21 pcalibre2">Figures </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18</span></a> through <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FD2"><span class="pcalibre1 pcalibre21 pcalibre2">4.21</span></a>, we stated that they should be read as if they were written in a programming notation, with the assignments performed in sequence from top to bottom. On the other hand, the hardware structure of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FCB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.23</span></a> operates in a fundamentally different way, with a single clock transition triggering a flow through combinational logic to execute an entire instruction. Let us see how the hardware can implement the behavior listed in these tables.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004223F" id="P700049702700000000000000004223F">Our implementation of SEQ consists of combinational logic and two forms of memory devices: clocked registers (the program counter and condition code register) and random access memories (the register file, the instruction memory, and the data memory). Combinational logic does not require any sequencing or control—values propagate through a network of logic gates whenever the inputs change. As we have described, we also assume that reading from a random access memory operates much like combinational logic, with the output word generated based on the address input. This is a reasonable assumption for smaller <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004008" epub:type="pagebreak" id="P7000497027000000000000000004008" title="401"></span>memories (such as the register file), and we can mimic this effect for larger circuits using special clock circuits. Since our instruction memory is only used to read instructions, we can therefore treat this unit as if it were combinational logic.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042240" id="P7000497027000000000000000042240">We are left with just four hardware units that require an explicit control over their sequencing—the program counter, the condition code register, the data memory, and the register file. These are controlled via a single clock signal that triggers the loading of new values into the registers and the writing of values to the random access memories. The program counter is loaded with a new instruction address every clock cycle. The condition code register is loaded only when an integer operation instruction is executed. The data memory is written only when an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042241" id="P7000497027000000000000000042241">rmmovq, pushq</code>, or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042242" id="P7000497027000000000000000042242">call</code> instruction is executed. The two write ports of the register file allow two program registers to be updated on every cycle, but we can use the special register ID <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042243" id="P7000497027000000000000000042243">0xF</code> as a port address to indicate that no write should be performed for this port.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042244" id="P7000497027000000000000000042244">This clocking of the registers and memories is all that is required to control the sequencing of activities in our processor. Our hardware achieves the same effect as would a sequential execution of the assignments shown in the tables of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003EDE"><span class="pcalibre1 pcalibre21 pcalibre2">Figures </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18</span></a> through <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FD2"><span class="pcalibre1 pcalibre21 pcalibre2">4.21</span></a>, even though all of the state updates actually occur simultaneously and only as the clock rises to start the next cycle. This equivalence holds because of the nature of the Y86-64 instruction set, and because we have organized the computations in such a way that our design obeys the following principle:</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>4.4 General Principles of Pipelining</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000004152"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter04.xhtml#P70004970270000000000000000423CF" epub:type="title" id="P70004970270000000000000000423CF"><span class="pcalibre1 pcalibre21 pcalibre2">4.4 </span>General Principles of Pipelining</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423D0" id="P70004970270000000000000000423D0">Before attempting to design a pipelined Y86-64 processor, let us consider some general properties and principles of pipelined systems. Such systems are familiar to anyone who has been through the serving line at a cafeteria or run a car through an automated car wash. In a pipelined system, the task to be performed is divided into a series of discrete stages. In a cafeteria, this involves supplying salad, a main dish, dessert, and beverage. In a car wash, this involves spraying water and soap, scrubbing, applying wax, and drying. Rather than having one customer run through the entire sequence from beginning to end before the next can begin, we allow multiple customers to proceed through the system at once. In a traditional cafeteria line, the customers maintain the same order in the pipeline and pass through all stages, even if they do not want some of the courses. In the case of the car wash, a new car is allowed to enter the spraying stage as the preceding car moves from the spraying stage to the scrubbing stage. In general, the cars must move through the system at the same rate to avoid having one car crash into the next.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423D1" id="P70004970270000000000000000423D1">A key feature of pipelining is that it increases the <i class="pcalibre17 pcalibre2 pcalibre1">throughput</i> of the system (i.e., the number of customers served per unit time), but it may also slightly increase the <i class="pcalibre17 pcalibre2 pcalibre1">latency</i> (i.e., the time required to service an individual customer). For example, a customer in a cafeteria who only wants a dessert could pass through a nonpipelined system very quickly, stopping only at the dessert stage. A customer in a pipelined system who attempts to go directly to the dessert stage risks incurring the wrath of other customers.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004156" id="P7000497027000000000000000004156"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423D2" epub:type="title" id="P70004970270000000000000000423D2"><span class="pcalibre1 pcalibre21 pcalibre2">4.4.1 </span>Computational Pipelines</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423D3" id="P70004970270000000000000000423D3">Shifting our focus to computational pipelines, the "customers" are instructions and the stages perform some portion of the instruction execution. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004159"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.32</span></a>(a) shows an example of a simple nonpipelined hardware system. It consists of some logic that performs a computation, followed by a register to hold the results of this computation. A clock signal controls the loading of the register at some regular time interval. An example of such a system is the decoder in a compact disk (CD) player. The incoming signals are the bits read from the surface of the CD, and</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004159" id="P7000497027000000000000000004159">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000415A" epub:type="pagebreak" id="P700049702700000000000000000415A" title="413"></span><img alt="Diagrams illustrate unpipelined hardware and a pipeline." class="pcalibre158 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6E2" id="P70004970270000000000000000423D4" src="Images/chapter-04-image-19.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P70004970270000000000000000423D5" id="P70004970270000000000000000423D5"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P70004970270000000000000000423D6" epub:type="title" id="P70004970270000000000000000423D6"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.32 </span>Unpipelined computation hardware.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P70004970270000000000000000423D7" id="P70004970270000000000000000423D7"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423D8" id="P70004970270000000000000000423D8"> On each 320 ps cycle, the system spends 300 ps evaluating a combinational logic function and 20 ps storing the results in an output register.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000423D9" id="P70004970270000000000000000423D9">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000226B1" id="P70004970270000000000000000226B1">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423DA" id="P70004970270000000000000000423DA">Diagrams are summarized below.</p>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter04.xhtml#P70004970270000000000000000423DB" id="P70004970270000000000000000423DB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000423DC" id="P70004970270000000000000000423DC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000423DD" id="P70004970270000000000000000423DD">Hardware: Unpipelined: combination logic, with 300 ps, leading to Reg, with 20 ps, to Clock, with delay = 320 ps and throughput = 3.12 GIPS</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000423DE" id="P70004970270000000000000000423DE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000423DF" id="P70004970270000000000000000423DF">Pipeline diagram: Blue boxes move over time from I1 to I2 to I3.</p></li>
</ol>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423E0" id="P70004970270000000000000000423E0">the logic decodes these to generate audio signals. The computational block in the figure is implemented as combinational logic, meaning that the signals will pass through a series of logic gates, with the outputs becoming some function of the inputs after some time delay.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423E1" id="P70004970270000000000000000423E1">In contemporary logic design, we measure circuit delays in units of <i class="pcalibre17 pcalibre2 pcalibre1">picoseconds</i> (abbreviated "ps"), or 10<sup class="pcalibre1 pcalibre2 pcalibre85">-12</sup> seconds. In this example, we assume the combinational logic requires 300 ps, while the loading of the register requires 20 ps. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004159"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.32</span></a> shows a form of timing diagram known as a <i class="pcalibre17 pcalibre2 pcalibre1">pipeline diagram</i>. In this diagram, time flows from left to right. A series of instructions (here named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423E2" id="P70004970270000000000000000423E2">I1, I2</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423E3" id="P70004970270000000000000000423E3">I3</code>) are written from top to bottom. The solid rectangles indicate the times during which these instructions are executed. In this implementation, we must complete one instruction before beginning the next. Hence, the boxes do not overlap one another vertically. The following formula gives the maximum rate at which we could operate the system:</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter04.xhtml#P70004970270000000000000000423E4" id="P70004970270000000000000000423E4">
<m:math altimg="../images/ch04-eq1.png" altimg-height="36" altimg-width="460" alttext="" data-uri="" display="block"><m:mrow><m:mi>T</m:mi><m:mi>h</m:mi><m:mi>r</m:mi><m:mi>o</m:mi><m:mi>u</m:mi><m:mi>g</m:mi><m:mi>h</m:mi><m:mi>p</m:mi><m:mi>u</m:mi><m:mi>t</m:mi><m:mo>=</m:mo><m:mfrac><m:mrow><m:mn>1</m:mn><m:mtext> </m:mtext><m:mtext>instruction</m:mtext></m:mrow><m:mrow><m:mo stretchy="false">(</m:mo><m:mn>20</m:mn><m:mo>+</m:mo><m:mn>300</m:mn><m:mo stretchy="false">)</m:mo><m:mtext> </m:mtext><m:mtext>picoseconds</m:mtext></m:mrow></m:mfrac><m:mo>.</m:mo><m:mfrac><m:mrow><m:mn>1</m:mn><m:mo>,</m:mo><m:mn>000</m:mn><m:mtext> </m:mtext><m:mtext>picoseconds</m:mtext></m:mrow><m:mrow><m:mn>1</m:mn><m:mtext> </m:mtext><m:mtext>nanosecond</m:mtext></m:mrow></m:mfrac><m:mo>≈</m:mo><m:mn>3.12</m:mn><m:mtext> </m:mtext><m:mtext>GIPS</m:mtext></m:mrow></m:math>
</div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423E5" id="P70004970270000000000000000423E5">We express throughput in units of giga-instructions per second (abbreviated GIPS), or billions of instructions per second. The total time required to perform a single instruction from beginning to end is known as the <i class="pcalibre17 pcalibre2 pcalibre1">latency</i>. In this system, the latency is 320 ps, the reciprocal of the throughput.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423E6" id="P70004970270000000000000000423E6">Suppose we could divide the computation performed by our system into three stages, A, B, and C, where each requires 100 ps, as illustrated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000416C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.33</span></a>. Then we could put <i class="pcalibre17 pcalibre2 pcalibre1">pipeline registers</i> between the stages so that each instruction moves through the system in three steps, requiring three complete clock cycles from beginning to end. As the pipeline diagram in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000416C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.33</span></a> illustrates, we could allow <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423E7" id="P70004970270000000000000000423E7">I2</code> to enter stage A as soon as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423E8" id="P70004970270000000000000000423E8">I1</code> moves from A to B, and so on. In steady state, all three stages would be active, with one instruction leaving and a new one entering the system every clock cycle. We can see this during the third clock cycle in the pipeline diagram where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423E9" id="P70004970270000000000000000423E9">I1</code> is in stage C, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423EA" id="P70004970270000000000000000423EA">I2</code> is in stage B, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423EB" id="P70004970270000000000000000423EB">I3</code> is in stage A. In</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P700049702700000000000000000416C" id="P700049702700000000000000000416C">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000416D" epub:type="pagebreak" id="P700049702700000000000000000416D" title="414"></span><img alt="Diagrams illustrate three-stage pipeline hardware and a pipeline." class="pcalibre159 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B6E3" id="P70004970270000000000000000423EC" src="Images/chapter-04-image-20.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P70004970270000000000000000423ED" id="P70004970270000000000000000423ED"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P70004970270000000000000000423EE" epub:type="title" id="P70004970270000000000000000423EE"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.33 </span>Three-stage pipelined computation hardware.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P70004970270000000000000000423EF" id="P70004970270000000000000000423EF"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423F0" id="P70004970270000000000000000423F0"> The computation is split into stages A, B, and C. On each 120 ps cycle, each instruction progresses through one stage.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000423F1" id="P70004970270000000000000000423F1">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000226C9" id="P70004970270000000000000000226C9">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423F2" id="P70004970270000000000000000423F2">Diagrams are summarized below.</p>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter04.xhtml#P70004970270000000000000000423F3" id="P70004970270000000000000000423F3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000423F4" id="P70004970270000000000000000423F4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000423F5" id="P70004970270000000000000000423F5">Hardware: Three-stage pipeline: a series of comb. Logic (A, B, and C), each with 100 ps and leading to Reg with 20 ps, each connected to clock. Delay = 360 ps and throughput = 8.33 GIPS.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000423F6" id="P70004970270000000000000000423F6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000423F7" id="P70004970270000000000000000423F7">Pipeline diagram: Blue boxes each divided into A, B, and C move over time from I1 to I2 to I3, with A under the previous B and B under the previous C.</p></li>
</ol>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004173" id="P7000497027000000000000000004173">
<img alt="A diagram illustrates three-stage pipeline timing." class="pcalibre160 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B6E4" id="P70004970270000000000000000423F8" src="Images/chapter-04-image-21.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P70004970270000000000000000423F9" id="P70004970270000000000000000423F9"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P70004970270000000000000000423FA" epub:type="title" id="P70004970270000000000000000423FA"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.34 </span>Three-stage pipeline timing.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P70004970270000000000000000423FB" id="P70004970270000000000000000423FB"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423FC" id="P70004970270000000000000000423FC"> The rising edge of the clock signal controls the movement of instructions from one pipeline stage to the next.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000423FD" id="P70004970270000000000000000423FD">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000226D5" id="P70004970270000000000000000226D5">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000423FE" id="P70004970270000000000000000423FE">A diagram of three-stage pipeline timing I1 A from 0 to 120; I1 B and I2 A between 120 and 240; I1 C, I2 B, I3 C between 240 and 360; I2 C and I3 B between 360 and 480; and I3 C between 480 and 600.</p>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000423FF" id="P70004970270000000000000000423FF">this system, we could cycle the clocks every 100 + 20 = 120 picoseconds, giving a throughput of around 8.33 GIPS. Since processing a single instruction requires 3 clock cycles, the latency of this pipeline is 3 × 120 = 360 ps. We have increased the throughput of the system by a factor of 8.33/3.12 = 2.67 at the expense of some added hardware and a slight increase in the latency (360/320 = 1.12). The increased latency is due to the time overhead of the added pipeline registers.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000417A" id="P700049702700000000000000000417A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042400" epub:type="title" id="P7000497027000000000000000042400"><span class="pcalibre1 pcalibre21 pcalibre2">4.4.2 </span>A Detailed Look at Pipeline Operation</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042401" id="P7000497027000000000000000042401">To better understand how pipelining works, let us look in some detail at the timing and operation of pipeline computations. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004173"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.34</span></a> shows the pipeline diagram for the three-stage pipeline we have already looked at (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000416C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.33</span></a>). The transfer of the instructions between pipeline stages is controlled by a clock signal, as shown above the pipeline diagram. Every 120 ps, this signal rises from 0 to 1, initiating the next set of pipeline stage evaluations.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042402" id="P7000497027000000000000000042402"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004180"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.35</span></a> traces the circuit activity between times 240 and 360, as instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042403" id="P7000497027000000000000000042403">I1</code> (shown in dark gray) propagates through stage C, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042404" id="P7000497027000000000000000042404">I2</code> (shown in blue)</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004180" id="P7000497027000000000000000004180">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004181" epub:type="pagebreak" id="P7000497027000000000000000004181" title="415"></span><img alt="A diagram illustrates four stages in one clock cycle of a pipeline operation." class="pcalibre161 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6E5" id="P7000497027000000000000000042405" src="Images/chapter-04-image-22.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042406" id="P7000497027000000000000000042406"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042407" epub:type="title" id="P7000497027000000000000000042407"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.35 </span>One clock cycle of pipeline operation.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042408" id="P7000497027000000000000000042408"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042409" id="P7000497027000000000000000042409"> Just before the clock rises at time 240 (point 1), instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004240A" id="P700049702700000000000000004240A">I1</code> (shown in dark gray) and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004240B" id="P700049702700000000000000004240B">I2</code> (shown in blue) have completed stages B and A. After the clock rises, these instructions begin propagating through stages C and B, while instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004240C" id="P700049702700000000000000004240C">I3</code> (shown in light gray) begins propagating through stage A (points 2 and 3). Just before the clock rises again, the results for the instructions have propagated to the inputs of the pipeline registers (point 4).</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004240D" id="P700049702700000000000000004240D">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000226E5" id="P70004970270000000000000000226E5">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004240E" id="P700049702700000000000000004240E">A diagram shows I1 B and I2 A between time 120 and 240 and I1 C, I2 B, and I3 A between 240 and 360, with four times within illustrates, as summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P700049702700000000000000004240F" id="P700049702700000000000000004240F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042410" id="P7000497027000000000000000042410"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042411" id="P7000497027000000000000000042411">Time 239: A series of Comb. Logic (A, B, and C) each with 100 ps, separated by Reg connected to a clock, each with 20 ps. Comb logic A corresponds with I2 and the first Reg and Comb. Logic B correspond with I1.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042412" id="P7000497027000000000000000042412"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042413" id="P7000497027000000000000000042413">Time 241: A series of Comb. Logic (A, B, and C) each with 100 ps, separated by Reg connected to a clock, each with 20 ps. The first Reg corresponds with I2 and the second with I1.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042414" id="P7000497027000000000000000042414"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042415" id="P7000497027000000000000000042415">Time 300: A series of Comb. Logic (A, B, and C) each with 100 ps, separated by Reg connected to a clock, each with 20 ps. Part of Comb logic A corresponds with I3, the first Reg and part of Comb logic B with I2, and the second Reg and part of Comb logic C with I1.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042416" id="P7000497027000000000000000042416"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042417" id="P7000497027000000000000000042417">Time 359: A series of Comb. Logic (A, B, and C) each with 100 ps, separated by Reg connected to a clock, each with 20 ps. Comb logic A corresponds with I3, the first Reg and Comb. Logic B correspond with I2, and the second Reg and Comb logic C correspond with I1.</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042418" id="P7000497027000000000000000042418"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000418B" epub:type="pagebreak" id="P700049702700000000000000000418B" title="416"></span>propagates through stage B, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042419" id="P7000497027000000000000000042419">I3</code> (shown in light gray) propagates through stage A. Just before the rising clock at time 240 (point 1), the values computed in stage A for instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004241A" id="P700049702700000000000000004241A">I2</code> have reached the input of the first pipeline register, but its state and output remain set to those computed during stage A for instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004241B" id="P700049702700000000000000004241B">I1</code>. The values computed in stage B for instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004241C" id="P700049702700000000000000004241C">I1</code> have reached the input of the second pipeline register. As the clock rises, these inputs are loaded into the pipeline registers, becoming the register outputs (point 2). In addition, the input to stage A is set to initiate the computation of instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004241D" id="P700049702700000000000000004241D">I3</code>. The signals then propagate through the combinational logic for the different stages (point 3). As the curved wave fronts in the diagram at point 3 suggest, signals can propagate through different sections at different rates. Before time 360, the result values reach the inputs of the pipeline registers (point 4). When the clock rises at time 360, each of the instructions will have progressed through one pipeline stage.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004241E" id="P700049702700000000000000004241E">We can see from this detailed view of pipeline operation that slowing down the clock would not change the pipeline behavior. The signals propagate to the pipeline register inputs, but no change in the register states will occur until the clock rises. On the other hand, we could have disastrous effects if the clock were run too fast. The values would not have time to propagate through the combinational logic, and so the register inputs would not yet be valid when the clock rises.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004241F" id="P700049702700000000000000004241F">As with our discussion of the timing for the SEQ processor (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000004004"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3.3</span></a>), we see that the simple mechanism of having clocked registers between blocks of combinational logic suffices to control the flow of instructions in the pipeline. As the clock rises and falls repeatedly, the different instructions flow through the stages of the pipeline without interfering with one another.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004193" id="P7000497027000000000000000004193"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042420" epub:type="title" id="P7000497027000000000000000042420"><span class="pcalibre1 pcalibre21 pcalibre2">4.4.3 </span>Limitations of Pipelining</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042421" id="P7000497027000000000000000042421">The example of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000416C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.33</span></a> shows an ideal pipelined system in which we are able to divide the computation into three independent stages, each requiring one-third of the time required by the original logic. Unfortunately, other factors often arise that diminish the effectiveness of pipelining.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004196" id="P7000497027000000000000000004196"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042422" epub:type="title" id="P7000497027000000000000000042422">Nonuniform Partitioning</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042423" id="P7000497027000000000000000042423"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000419A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.36</span></a> shows a system in which we divide the computation into three stages as before, but the delays through the stages range from 50 to 150 ps. The sum of the delays through all of the stages remains 300 ps. However, the rate at which we can operate the clock is limited by the delay of the slowest stage. As the pipeline diagram in this figure shows, stage A will be idle (shown as a white box) for 100 ps every clock cycle, while stage C will be idle for 50 ps every clock cycle. Only stage B will be continuously active. We must set the clock cycle to 150 + 20 = 170 picoseconds, giving a throughput of 5.88 GIPS. In addition, the latency would increase to 510 ps due to the slower clock rate.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042424" id="P7000497027000000000000000042424">Devising a partitioning of the system computation into a series of stages having uniform delays can be a major challenge for hardware designers. Often,</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P700049702700000000000000000419A" id="P700049702700000000000000000419A">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000419B" epub:type="pagebreak" id="P700049702700000000000000000419B" title="417"></span><img alt="Diagrams illustrate three-stage pipeline with nonuniform stage delays hardware and a pipeline diagram." class="calibre35 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6E6" id="P7000497027000000000000000042425" src="Images/chapter-04-image-23.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042426" id="P7000497027000000000000000042426"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042427" epub:type="title" id="P7000497027000000000000000042427"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.36 </span>Limitations of pipelining due to nonuniform stage delays.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042428" id="P7000497027000000000000000042428"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042429" id="P7000497027000000000000000042429"> The system throughput is limited by the speed of the slowest stage.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004242A" id="P700049702700000000000000004242A">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000022702" id="P7000497027000000000000000022702">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004242B" id="P700049702700000000000000004242B">Diagrams are summarized below.</p>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter04.xhtml#P700049702700000000000000004242C" id="P700049702700000000000000004242C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004242D" id="P700049702700000000000000004242D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004242E" id="P700049702700000000000000004242E">Hardware: Three-stage pipeline, nonuniform stage delays: A series of Comb logic A separated by Reg with 20 ps: Comb logic A = 50 ps, Comb logic B = 150 ps, and Comb logic C = 100 ps. Delay  = 510 ps and throughput = 5.88 GIPS.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004242F" id="P700049702700000000000000004242F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042430" id="P7000497027000000000000000042430">Pipeline diagram: I1, I2, and I3 each are divided into unequal sections for A, B, and C.</p></li>
</ol>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042431" id="P7000497027000000000000000042431">some of the hardware units in a processor, such as the ALU and the memories, cannot be subdivided into multiple units with shorter delay. This makes it difficult to create a set of balanced stages. We will not concern ourselves with this level of detail in designing our pipelined Y86-64 processor, but it is important to appreciate the importance of timing optimization in actual system design.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000041A2" epub:type="practice" id="P70004970270000000000000000041A2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre127 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042432" epub:type="title" id="P7000497027000000000000000042432"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.28 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P70004970270000000000000000047F7">489</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000042433" id="P7000497027000000000000000042433">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000042434" id="P7000497027000000000000000042434">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042435" id="P7000497027000000000000000042435"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042436" id="P7000497027000000000000000042436">Suppose we analyze the combinational logic of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004159"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.32</span></a> and determine that it can be separated into a sequence of six blocks, named A to F, having delays of 80, 30, 60, 50, 70, and 10 ps, respectively, illustrated as follows:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P70004970270000000000000000041A8" id="P70004970270000000000000000041A8">
<img alt="A diagram shows a flow through the following” A 80 ps, B 30 ps, C 60 ps, D 50 ps, E 70 ps, F 10 ps, Reg 20 ps." class="pcalibre1 pcalibre2 calibre36" data-uri="P700049702700000000000000000B6E7" id="P7000497027000000000000000042437" src="Images/chapter-04-image-24.png"/>
</figure>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042438" id="P7000497027000000000000000042438">We can create pipelined versions of this design by inserting pipeline registers between pairs of these blocks. Different combinations of pipeline depth (how many stages) and maximum throughput arise, depending on where we insert the pipeline registers. Assume that a pipeline register has a delay of 20 ps.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter04.xhtml#P7000497027000000000000000042439" id="P7000497027000000000000000042439">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004243A" id="P700049702700000000000000004243A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004243B" id="P700049702700000000000000004243B">Inserting a single register gives a two-stage pipeline. Where should the register be inserted to maximize throughput? What would be the throughput and latency?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004243C" id="P700049702700000000000000004243C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004243D" id="P700049702700000000000000004243D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000041B0" epub:type="pagebreak" id="P70004970270000000000000000041B0" title="418"></span>Where should two registers be inserted to maximize the throughput of a three-stage pipeline? What would be the throughput and latency?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004243E" id="P700049702700000000000000004243E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004243F" id="P700049702700000000000000004243F">Where should three registers be inserted to maximize the throughput of a 4-stage pipeline? What would be the throughput and latency?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042440" id="P7000497027000000000000000042440"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042441" id="P7000497027000000000000000042441">What is the minimum number of stages that would yield a design with the maximum achievable throughput? Describe this design, its throughput, and its latency.</p></li>
</ol>
</div>
</li>
</ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000041B5" id="P70004970270000000000000000041B5"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042442" epub:type="title" id="P7000497027000000000000000042442">Diminishing Returns of Deep Pipelining</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042443" id="P7000497027000000000000000042443"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000041BF"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.37</span></a> illustrates another limitation of pipelining. In this example, we have divided the computation into six stages, each requiring 50 ps. Inserting a pipeline register between each pair of stages yields a six-stage pipeline. The minimum clock period for this system is 50 + 20 = 70 picoseconds, giving a throughput of 14.29 GIPS. Thus, in doubling the number of pipeline stages, we improve the performance by a factor of 14.29/8.33 = 1.71. Even though we have cut the time required for each computation block by a factor of 2, we do not get a doubling of the throughput, due to the delay through the pipeline registers. This delay becomes a limiting factor in the throughput of the pipeline. In our new design, this delay consumes 28.6% of the total clock period.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042444" id="P7000497027000000000000000042444">Modern processors employ very deep pipelines (15 or more stages) in an attempt to maximize the processor clock rate. The processor architects divide the instruction execution into a large number of very simple steps so that each stage can have a very small delay. The circuit designers carefully design the pipeline registers to minimize their delay. The chip designers must also carefully design the clock distribution network to ensure that the clock changes at the exact same time across the entire chip. All of these factors contribute to the challenge of designing high-speed microprocessors.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000041B9" epub:type="practice" id="P70004970270000000000000000041B9"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre127 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042445" epub:type="title" id="P7000497027000000000000000042445"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.29 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000046A4.xhtml#P700049702700000000000000000480E">490</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter04.xhtml#P7000497027000000000000000042446" id="P7000497027000000000000000042446">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000042447" id="P7000497027000000000000000042447">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042448" id="P7000497027000000000000000042448"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042449" id="P7000497027000000000000000042449">Suppose we could take the system of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004159"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.32</span></a> and divide it into an arbitrary number of pipeline stages <var class="pcalibre17 pcalibre2 pcalibre1">k</var>, each having a delay of 300/<var class="pcalibre17 pcalibre2 pcalibre1">k</var>, and with each pipeline register having a delay of 20 ps.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P70004970270000000000000000041BF" id="P70004970270000000000000000041BF">
<img alt="A diagram shows a flow of six Comb logic of 50 ps, each followed by Reg of 20 ps, with Delay = 420 ps, throughput = 14.29 GIPS." class="pcalibre1 pcalibre2 pcalibre162" data-uri="P700049702700000000000000000B6E8" id="P700049702700000000000000004244A" src="Images/chapter-04-image-25.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P700049702700000000000000004244B" id="P700049702700000000000000004244B"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P700049702700000000000000004244C" epub:type="title" id="P700049702700000000000000004244C"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.37 </span>Limitations of pipelining due to overhead.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004244D" id="P700049702700000000000000004244D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004244E" id="P700049702700000000000000004244E"> As the combinational logic is split into shorter blocks, the delay due to register updating becomes a limiting factor.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004244F" id="P700049702700000000000000004244F">
</p></div>
</figcaption>
</figure>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter04.xhtml#P7000497027000000000000000042450" id="P7000497027000000000000000042450">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042451" id="P7000497027000000000000000042451"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042452" id="P7000497027000000000000000042452"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000041C8" epub:type="pagebreak" id="P70004970270000000000000000041C8" title="419"></span>What would be the latency and the throughput of the system, as functions of <var class="pcalibre17 pcalibre2 pcalibre1">k</var>?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042453" id="P7000497027000000000000000042453"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042454" id="P7000497027000000000000000042454">What would be the ultimate limit on the throughput?</p></li>
</ol>
</div>
</li>
</ol>
</section>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000041CB" id="P70004970270000000000000000041CB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042455" epub:type="title" id="P7000497027000000000000000042455"><span class="pcalibre1 pcalibre21 pcalibre2">4.4.4 </span>Pipelining a System with Feedback</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042456" id="P7000497027000000000000000042456">Up to this point, we have considered only systems in which the objects passing through the pipeline—whether cars, people, or instructions—are completely independent of one another. For a system that executes machine programs such as x86-64 or Y86-64, however, there are potential dependencies between successive instructions. For example, consider the following Y86-64 instruction sequence:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P700049702700000000000000002272E" id="P700049702700000000000000002272E">
<img alt="A sequence has elements connected between lines." class="pcalibre1 pcalibre163 pcalibre2" data-uri="P700049702700000000000000000B6E9" id="P7000497027000000000000000042457" src="Images/chapter-04-image-26.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042458" id="P7000497027000000000000000042458">
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000022731" id="P7000497027000000000000000022731">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<ol class="pcalibre1 calibre19 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042459" id="P7000497027000000000000000042459">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004245A" id="P700049702700000000000000004245A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004245B" id="P700049702700000000000000004245B">Irmovq $50, %rax</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004245C" id="P700049702700000000000000004245C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004245D" id="P700049702700000000000000004245D">Addq %rax (from above), %rbx</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004245E" id="P700049702700000000000000004245E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004245F" id="P700049702700000000000000004245F">Mrmovq 100(%rbx [from above]), %rdx</p></li>
</ol>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042460" id="P7000497027000000000000000042460">In this three-instruction sequence, there is a <i class="pcalibre17 pcalibre2 pcalibre1">data dependency</i> between each successive pair of instructions, as indicated by the circled register names and the arrows between them. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042461" id="P7000497027000000000000000042461">irmovq</code> instruction (line 1) stores its result in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042462" id="P7000497027000000000000000042462">%rax</code>, which then must be read by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042463" id="P7000497027000000000000000042463">addq</code> instruction (line 2); and this instruction stores its result in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042464" id="P7000497027000000000000000042464">%rbx</code>, which must then be read by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042465" id="P7000497027000000000000000042465">mrmovq</code> instruction (line 3).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042466" id="P7000497027000000000000000042466">Another source of sequential dependencies occurs due to the instruction control flow. Consider the following Y86-64 instruction sequence:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042467" id="P7000497027000000000000000042467">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042468" id="P7000497027000000000000000042468">1	loop:
2	  subq %rdx,%rbx
3	  jne targ
4	  irmovq $10,%rdx
5	  jmp loop
6	targ:
7	  halt
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042469" id="P7000497027000000000000000042469">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004246A" id="P700049702700000000000000004246A">jne</code> instruction (line 3) creates a <i class="pcalibre17 pcalibre2 pcalibre1">control dependency</i> since the outcome of the conditional test determines whether the next instruction to execute will be the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004246B" id="P700049702700000000000000004246B">irmovq</code> instruction (line 4) or the halt instruction (line 7). In our design for SEQ, these dependencies were handled by the feedback paths shown on the right-hand side of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FAD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.22</span></a>. This feedback brings the updated register values down to the register file and the new PC value down to the PC register.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004246C" id="P700049702700000000000000004246C"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000041DD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.38</span></a> illustrates the perils of introducing pipelining into a system containing feedback paths. In the original system (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000041DD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.38</span></a>(a)), the result of each</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P70004970270000000000000000041DD" id="P70004970270000000000000000041DD">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000041DE" epub:type="pagebreak" id="P70004970270000000000000000041DE" title="420"></span><img alt="Diagrams illustrate hardware and corresponding pipeline diagrams." class="pcalibre1 pcalibre2 pcalibre164" data-uri="P700049702700000000000000000B6EB" id="P700049702700000000000000004246D" src="Images/chapter-04-image-27.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P700049702700000000000000004246E" id="P700049702700000000000000004246E"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P700049702700000000000000004246F" epub:type="title" id="P700049702700000000000000004246F"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.38 </span>Limitations of pipelining due to logical dependencies.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042470" id="P7000497027000000000000000042470"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042471" id="P7000497027000000000000000042471"> In going from an unpipelined system with feedback (a) to a pipelined one (c), we change its computational behavior, as can be seen by the two pipeline diagrams (b and d).</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042472" id="P7000497027000000000000000042472">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P700049702700000000000000002274B" id="P700049702700000000000000002274B">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter04.xhtml#P7000497027000000000000000042473" id="P7000497027000000000000000042473">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042474" id="P7000497027000000000000000042474"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042475" id="P7000497027000000000000000042475">Hardware: Unpipelined with feedback: Combinational logic to Reg, back to Combinational logic</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042476" id="P7000497027000000000000000042476"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042477" id="P7000497027000000000000000042477">Pipeline diagram: I1 to I2 to I3, with end of each looping to the beginning of the next</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042478" id="P7000497027000000000000000042478"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042479" id="P7000497027000000000000000042479">Hardware: Three-stage pipeline with feedback: series from Comb logic A to Comb logic B to Comb logic C, back to Comb logic A (each followed by Reg)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004247A" id="P700049702700000000000000004247A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004247B" id="P700049702700000000000000004247B">Pipeline diagram: I1, I2, I3, and I4 each composed of A, B, and C, with A below B above and B below C above; I1 C loops to I4 A.</p></li>
</ol>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004247C" id="P700049702700000000000000004247C">instruction is fed back around to the next instruction. This is illustrated by the pipeline diagram (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000041DD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.38</span></a>(b)), where the result of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004247D" id="P700049702700000000000000004247D">I1</code> becomes an input to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004247E" id="P700049702700000000000000004247E">I2</code>, and so on. If we attempt to convert this to a three-stage pipeline in the most straightforward manner (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000041DD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.38</span></a>(c)), we change the behavior of the system. As <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000041DD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.38</span></a>(c) shows, the result of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004247F" id="P700049702700000000000000004247F">I1</code> becomes an input to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042480" id="P7000497027000000000000000042480">I4</code>. In attempting to speed up the system via pipelining, we have changed the system behavior.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042481" id="P7000497027000000000000000042481"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000041EA" epub:type="pagebreak" id="P70004970270000000000000000041EA" title="421"></span>When we introduce pipelining into a Y86-64 processor, we must deal with feedback effects properly. Clearly, it would be unacceptable to alter the system behavior as occurred in the example of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000041DD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.38</span></a>. Somehow we must deal with the data and control dependencies between instructions so that the resulting behavior matches the model defined by the ISA.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>4.5 Pipelined Y86-64 Implementations</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000041EB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042482" epub:type="title" id="P7000497027000000000000000042482"><span class="pcalibre1 pcalibre21 pcalibre2">4.5 </span>Pipelined Y86-64 Implementations</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042483" id="P7000497027000000000000000042483">We are finally ready for the major task of this chapter—designing a pipelined Y86-64 processor. We start by making a small adaptation of the sequential processor SEQ to shift the computation of the PC into the fetch stage. We then add pipeline registers between the stages. Our first attempt at this does not handle the different data and control dependencies properly. By making some modifications, however, we achieve our goal of an efficient pipelined processor that implements the Y86-64 ISA.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000041EE" id="P70004970270000000000000000041EE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042484" epub:type="title" id="P7000497027000000000000000042484"><span class="pcalibre1 pcalibre21 pcalibre2">4.5.1 </span>SEQ+: Rearranging the Computation Stages</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042485" id="P7000497027000000000000000042485">As a transitional step toward a pipelined design, we must slightly rearrange the order of the five stages in SEQ so that the PC update stage comes at the beginning of the clock cycle, rather than at the end. This transformation requires only minimal change to the overall hardware structure, and it will work better with the sequencing of activities within the pipeline stages. We refer to this modified design as SEQ+.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042486" id="P7000497027000000000000000042486">We can move the PC update stage so that its logic is active at the beginning of the clock cycle by making it compute the PC value for the <i class="pcalibre17 pcalibre2 pcalibre1">current</i> instruction. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P70004970270000000000000000041F2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.39</span></a> shows how SEQ and SEQ+ differ in their PC computation. With SEQ (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P70004970270000000000000000041F2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.39</span></a>(a)), the PC computation takes place at the end of the clock cycle, computing the new value for the PC register based on the values of signals computed during the current clock cycle. With SEQ+ (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P70004970270000000000000000041F2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.39</span></a>(b)), we create state registers to hold the signals computed during an instruction. Then, as a new clock cycle begins, the values propagate through the exact same logic to compute the PC for the now-current instruction. We label the registers “pIcode,”</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P70004970270000000000000000041F2" id="P70004970270000000000000000041F2">
<img alt="Diagrams illustrate PC computations." class="pcalibre1 pcalibre2 pcalibre165" data-uri="P700049702700000000000000000B6EC" id="P7000497027000000000000000042487" src="Images/chapter-04-image-28.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042488" id="P7000497027000000000000000042488"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042489" epub:type="title" id="P7000497027000000000000000042489"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.39 </span>Shifting the timing of the PC computation.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P700049702700000000000000004248A" id="P700049702700000000000000004248A"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004248B" id="P700049702700000000000000004248B"> With SEQ+, we compute the value of the program counter for the current state as the first step in instruction execution.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004248C" id="P700049702700000000000000004248C">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000022765" id="P7000497027000000000000000022765">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter04.xhtml#P700049702700000000000000004248D" id="P700049702700000000000000004248D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004248E" id="P700049702700000000000000004248E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004248F" id="P700049702700000000000000004248F">SEQ new PC computation: New PC with inputs icode, Cnd, valC, valM, and valP and output PC</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042490" id="P7000497027000000000000000042490"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042491" id="P7000497027000000000000000042491">SEQ+ PC selection: PC with inputs picode, pCnd, pValM, pValC, and PValP and output PC.</p></li>
</ol>
</details>
</figcaption>
</figure>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000041F8" id="P70004970270000000000000000041F8"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000042492" epub:type="title" id="P7000497027000000000000000042492"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000041FA" epub:type="pagebreak" id="P70004970270000000000000000041FA" title="422"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Where is the PC in SEQ+?</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042493" id="P7000497027000000000000000042493">One curious feature of SEQ+ is that there is no hardware register storing the program counter. Instead, the PC is computed dynamically based on some state information stored from the previous instruction. This is a small illustration of the fact that we can implement a processor in a way that differs from the conceptual model implied by the ISA, as long as the processor correctly executes arbitrary machine-language programs. We need not encode the state in the form indicated by the programmer-visible state, as long as the processor can generate correct values for any part of the programmer-visible state (such as the program counter). We will exploit this principle even more in creating a pipelined design. Out-of-order processing techniques, as described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004B6C.xhtml#P7000497027000000000000000004B6C"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">5.7</span></a>, take this idea to an extreme by executing instructions in a completely different order than they occur in the machine-level program.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042494" id="P7000497027000000000000000042494">“pCnd,” and so on, to indicate that on any given cycle, they hold the control signals generated during the previous cycle.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042495" id="P7000497027000000000000000042495"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004209"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.40</span></a> shows a more detailed view of the SEQ+ hardware. We can see that it contains the exact same hardware units and control blocks that we had in SEQ (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FCB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.23</span></a>), but with the PC logic shifted from the top, where it was active at the end of the clock cycle, to the bottom, where it is active at the beginning.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042496" id="P7000497027000000000000000042496">The shift of state elements from SEQ to SEQ+ is an example of a general transformation known as <i class="pcalibre17 pcalibre2 pcalibre1">circuit retiming</i> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B42B">[68]</a>. Retiming changes the state representation for a system without changing its logical behavior. It is often used to balance the delays between the different stages of a pipelined system.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000041FF" id="P70004970270000000000000000041FF"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042497" epub:type="title" id="P7000497027000000000000000042497"><span class="pcalibre1 pcalibre21 pcalibre2">4.5.2 </span>Inserting Pipeline Registers</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042498" id="P7000497027000000000000000042498">In our first attempt at creating a pipelined Y86-64 processor, we insert pipeline registers between the stages of SEQ+ and rearrange signals somewhat, yielding the PIPE— processor, where the "-" in the name signifies that this processor has somewhat less performance than our ultimate processor design. The structure of PIPE— is illustrated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004210"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.41</span></a>. The pipeline registers are shown in this figure as blue boxes, each containing different fields that are shown as white boxes. As indicated by the multiple fields, each pipeline register holds multiple bytes and words. Unlike the labels shown in rounded boxes in the hardware structure of the two sequential processors (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P700049702700000000000000000403D"><span class="pcalibre1 pcalibre21 pcalibre2">Figures </span><span class="pcalibre1 pcalibre21 pcalibre2">4.23</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004273"><span class="pcalibre1 pcalibre21 pcalibre2">4.40</span></a>), these white boxes represent actual hardware components.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042499" id="P7000497027000000000000000042499">Observe that PIPE— uses nearly the same set of hardware units as our sequential design SEQ (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004209"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.40</span></a>), but with the pipeline registers separating the stages. The differences between the signals in the two systems is discussed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P700049702700000000000000000422D"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5.3</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004249A" id="P700049702700000000000000004249A">The pipeline registers are labeled as follows:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004249B" id="P700049702700000000000000004249B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004249C" id="P700049702700000000000000004249C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004249D" id="P700049702700000000000000004249D"><span class="pcalibre1 pcalibre2 pcalibre41">F </span>holds a <i class="pcalibre17 pcalibre2 pcalibre1">predicted</i> value of the program counter, as will be discussed shortly.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004249E" id="P700049702700000000000000004249E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004249F" id="P700049702700000000000000004249F"><span class="pcalibre1 pcalibre2 pcalibre41">D </span>sits between the fetch and decode stages. It holds information about the most recently fetched instruction for processing by the decode stage.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004209" id="P7000497027000000000000000004209">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000420A" epub:type="pagebreak" id="P700049702700000000000000000420A" title="423"></span><img alt="A diagram illustrates SEQ+ hardware structure." class="pcalibre1 pcalibre2 pcalibre166" data-uri="P700049702700000000000000000B6ED" id="P70004970270000000000000000424A0" src="Images/chapter-04-image-29.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P70004970270000000000000000424A1" id="P70004970270000000000000000424A1"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P70004970270000000000000000424A2" epub:type="title" id="P70004970270000000000000000424A2"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.40 </span>SEQ+ hardware structure.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P70004970270000000000000000424A3" id="P70004970270000000000000000424A3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424A4" id="P70004970270000000000000000424A4">Shifting the PC computation from the end of the clock cycle to the beginning makes it more suitable for pipelining.</p><p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter04.xhtml#P70004970270000000000000000424A5" id="P70004970270000000000000000424A5">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P700049702700000000000000002277E" id="P700049702700000000000000002277E">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424A6" id="P70004970270000000000000000424A6">A diagram shows a flow through elements, as summarized in order below, from bottom to top:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P70004970270000000000000000424A7" id="P70004970270000000000000000424A7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424A8" id="P70004970270000000000000000424A8"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424A9" id="P70004970270000000000000000424A9">PC: pC with output PC and the following inputs:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424AA" id="P70004970270000000000000000424AA">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424AB" id="P70004970270000000000000000424AB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424AC" id="P70004970270000000000000000424AC">Picode from instruction memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424AD" id="P70004970270000000000000000424AD"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424AE" id="P70004970270000000000000000424AE">pCnd from Cnd from ALU</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424AF" id="P70004970270000000000000000424AF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424B0" id="P70004970270000000000000000424B0">pValM from valM from Data memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424B1" id="P70004970270000000000000000424B1"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424B2" id="P70004970270000000000000000424B2">pValC from valC from instruction memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424B3" id="P70004970270000000000000000424B3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424B4" id="P70004970270000000000000000424B4">pValP from valP from PC increment</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424B5" id="P70004970270000000000000000424B5"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424B6" id="P70004970270000000000000000424B6">Fetch, with input from PC:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424B7" id="P70004970270000000000000000424B7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424B8" id="P70004970270000000000000000424B8"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424B9" id="P70004970270000000000000000424B9">Instruction memory, with instr_valid and Imem_error leading to Stat in PC update, with outputs:</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P70004970270000000000000000424BA" id="P70004970270000000000000000424BA">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424BB" id="P70004970270000000000000000424BB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424BC" id="P70004970270000000000000000424BC">icode, to Stat at PC update and picode in PC</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424BD" id="P70004970270000000000000000424BD"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424BE" id="P70004970270000000000000000424BE">ifun</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424BF" id="P70004970270000000000000000424BF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424C0" id="P70004970270000000000000000424C0">rA</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424C1" id="P70004970270000000000000000424C1"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424C2" id="P70004970270000000000000000424C2">rB</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424C3" id="P70004970270000000000000000424C3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424C4" id="P70004970270000000000000000424C4">valC, to PC and ALU A</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424C5" id="P70004970270000000000000000424C5"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424C6" id="P70004970270000000000000000424C6">PC increment with output valP, to Data in memory and PC</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424C7" id="P70004970270000000000000000424C7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424C8" id="P70004970270000000000000000424C8">Decode: Register file with outputs and inputs:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424C9" id="P70004970270000000000000000424C9">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424CA" id="P70004970270000000000000000424CA"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424CB" id="P70004970270000000000000000424CB">Outputs A and B to valA and valB, respectively</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P70004970270000000000000000424CC" id="P70004970270000000000000000424CC">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424CD" id="P70004970270000000000000000424CD"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424CE" id="P70004970270000000000000000424CE">valA to ALU A as well as Addr and Data in memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424CF" id="P70004970270000000000000000424CF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424D0" id="P70004970270000000000000000424D0">valB to ALU B</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424D1" id="P70004970270000000000000000424D1"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424D2" id="P70004970270000000000000000424D2">Inputs M and E</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P70004970270000000000000000424D3" id="P70004970270000000000000000424D3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424D4" id="P70004970270000000000000000424D4"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424D5" id="P70004970270000000000000000424D5">M from output valM from Data memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424D6" id="P70004970270000000000000000424D6"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424D7" id="P70004970270000000000000000424D7">E as write back from output valE from ALU</p></li>
</ul></li></ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424D8" id="P70004970270000000000000000424D8"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424D9" id="P70004970270000000000000000424D9">Execute: ALU with inputs and outputs:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424DA" id="P70004970270000000000000000424DA">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424DB" id="P70004970270000000000000000424DB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424DC" id="P70004970270000000000000000424DC">Input ALU A from valC and valA</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424DD" id="P70004970270000000000000000424DD"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424DE" id="P70004970270000000000000000424DE">Input ALU B from valB</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424DF" id="P70004970270000000000000000424DF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424E0" id="P70004970270000000000000000424E0">Input ALU fun.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424E1" id="P70004970270000000000000000424E1"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424E2" id="P70004970270000000000000000424E2">Output CC to Cnd, to dstE, dstM, srcA, and srcB, each with own outputs</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424E3" id="P70004970270000000000000000424E3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424E4" id="P70004970270000000000000000424E4">Output valE to Addr input to Data memory and to Register file E as write back</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424E5" id="P70004970270000000000000000424E5"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424E6" id="P70004970270000000000000000424E6">Memory: Data memory with inputs and outputs:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424E7" id="P70004970270000000000000000424E7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424E8" id="P70004970270000000000000000424E8"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424E9" id="P70004970270000000000000000424E9">Inputs read and write from Mem. Control</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424EA" id="P70004970270000000000000000424EA"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424EB" id="P70004970270000000000000000424EB">Input Addr from valE and valA</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424EC" id="P70004970270000000000000000424EC"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424ED" id="P70004970270000000000000000424ED">Input Data from valP and valA</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424EE" id="P70004970270000000000000000424EE"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424EF" id="P70004970270000000000000000424EF">Data out to valM, leading to Register file M and PC</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424F0" id="P70004970270000000000000000424F0"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424F1" id="P70004970270000000000000000424F1">Dmem_error to Stat</p></li></ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424F2" id="P70004970270000000000000000424F2"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424F3" id="P70004970270000000000000000424F3">Stat output from Stat, with inputs from Instruction memory, icode output of Instruction memory, and Data memory.</p></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004210" id="P7000497027000000000000000004210">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004211" epub:type="pagebreak" id="P7000497027000000000000000004211" title="424"></span><img alt="A diagram illustrates a hardware structure divided into a five-stage pipeline." class="pcalibre1 pcalibre2 pcalibre167" data-uri="P700049702700000000000000000B6EE" id="P70004970270000000000000000424F4" src="Images/chapter-04-image-30.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P70004970270000000000000000424F5" id="P70004970270000000000000000424F5"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P70004970270000000000000000424F6" epub:type="title" id="P70004970270000000000000000424F6"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.41 </span>Hardware structure of PIPE—, an initial pipelined implementation.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P70004970270000000000000000424F7" id="P70004970270000000000000000424F7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424F8" id="P70004970270000000000000000424F8"> By inserting pipeline registers into SEQ+ (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004209"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.40</span></a>), we create a five-stage pipeline. There are several shortcomings of this version that we will deal with shortly.</p><p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter04.xhtml#P70004970270000000000000000424F9" id="P70004970270000000000000000424F9">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000227D4" id="P70004970270000000000000000227D4">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424FA" id="P70004970270000000000000000424FA">The five pipelines in the structure are summarized below, from bottom to top.</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P70004970270000000000000000424FB" id="P70004970270000000000000000424FB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424FC" id="P70004970270000000000000000424FC"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P70004970270000000000000000424FD" id="P70004970270000000000000000424FD">F, below Fetch contains predPC with input form Predict PC and output to Select PC, which has:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424FE" id="P70004970270000000000000000424FE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P70004970270000000000000000424FF" id="P70004970270000000000000000424FF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042500" id="P7000497027000000000000000042500">Inputs M_valA from pipeline M and W_valM from pipeline W</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042501" id="P7000497027000000000000000042501"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042502" id="P7000497027000000000000000042502">Output f_pc to instruction memory and PC increment, each with output to Predict PC</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042503" id="P7000497027000000000000000042503"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042504" id="P7000497027000000000000000042504">D, between Fetch and Decode: includes the following, from left to right:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042505" id="P7000497027000000000000000042505">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042506" id="P7000497027000000000000000042506"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042507" id="P7000497027000000000000000042507">Stat: input f_stat from Stat, with input imem_error and instr_valid from Instruction memory; output to stat in pipeline E</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042508" id="P7000497027000000000000000042508"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042509" id="P7000497027000000000000000042509">Icode: input from instruction memory; output to icode in pipeline E</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004250A" id="P700049702700000000000000004250A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004250B" id="P700049702700000000000000004250B">Ifun: input from instruction memory; output ifun in pipeline E</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004250C" id="P700049702700000000000000004250C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004250D" id="P700049702700000000000000004250D">rA from instruction memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004250E" id="P700049702700000000000000004250E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004250F" id="P700049702700000000000000004250F">rB from instruction memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042510" id="P7000497027000000000000000042510"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042511" id="P7000497027000000000000000042511">valC: input from instruction memory; output valC in pipeline E</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042512" id="P7000497027000000000000000042512"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042513" id="P7000497027000000000000000042513">valP: input from PC increment; output Select A to valA in pipeline E</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042514" id="P7000497027000000000000000042514"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042515" id="P7000497027000000000000000042515">E, between Execute and Decode: includes the following, from left to right:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042516" id="P7000497027000000000000000042516">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042517" id="P7000497027000000000000000042517"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042518" id="P7000497027000000000000000042518">Stat: from stat in D; output E_stat to stat in M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042519" id="P7000497027000000000000000042519"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004251A" id="P700049702700000000000000004251A">Icode: from icode in D to icode in M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004251B" id="P700049702700000000000000004251B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004251C" id="P700049702700000000000000004251C">Ifun, from ifun in D</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004251D" id="P700049702700000000000000004251D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004251E" id="P700049702700000000000000004251E">valC, from valC in D; output ALU to ALU</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004251F" id="P700049702700000000000000004251F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042520" id="P7000497027000000000000000042520">valA: input from Select A, which receives input form valP and d_rvalA from Register file; output to ALU A and valA in pipeline M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042521" id="P7000497027000000000000000042521"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042522" id="P7000497027000000000000000042522">dstE: input dstE and output dstE to dstE in M, with input e_Cnd from CC from ALU</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042523" id="P7000497027000000000000000042523"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042524" id="P7000497027000000000000000042524">dstM: input dstM and output dstM in M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042525" id="P7000497027000000000000000042525"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042526" id="P7000497027000000000000000042526">srcA, with input d_srcA from srcA</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042527" id="P7000497027000000000000000042527"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042528" id="P7000497027000000000000000042528">srcB with input d_srcB from srcB</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042529" id="P7000497027000000000000000042529"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004252A" id="P700049702700000000000000004252A">M, between Memory and Execute: includes the following from left to right:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004252B" id="P700049702700000000000000004252B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004252C" id="P700049702700000000000000004252C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004252D" id="P700049702700000000000000004252D">Stat from stat in E with output M_stat to Stat, which has output m_stat in W</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004252E" id="P700049702700000000000000004252E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004252F" id="P700049702700000000000000004252F">Icode from E to W</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042530" id="P7000497027000000000000000042530"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042531" id="P7000497027000000000000000042531">Cnd: input e_Cnd from CC, from ALU (input from ALU A, ALU B, and ALU fun.); output M_Cnd to Select PC</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042532" id="P7000497027000000000000000042532"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042533" id="P7000497027000000000000000042533">valE: input from ALU; outputs Addr to Data memory and valE in W</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042534" id="P7000497027000000000000000042534"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042535" id="P7000497027000000000000000042535">valA: input from valA in E; output data in to Data memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042536" id="P7000497027000000000000000042536"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042537" id="P7000497027000000000000000042537">dstE: input from dstE, from dstE in E and e_Cnd from CC; output dstE in W</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042538" id="P7000497027000000000000000042538"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042539" id="P7000497027000000000000000042539">dstM: from E to W</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004253A" id="P700049702700000000000000004253A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004253B" id="P700049702700000000000000004253B">W, between Write back and Memory: includes the following from left to right:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004253C" id="P700049702700000000000000004253C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004253D" id="P700049702700000000000000004253D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004253E" id="P700049702700000000000000004253E">Stat: input m_stat from Stat, with input M_stat from M and dmem_error from Data memory; output W_stat to Stat in Write back</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004253F" id="P700049702700000000000000004253F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042540" id="P7000497027000000000000000042540">Icode from M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042541" id="P7000497027000000000000000042541"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042542" id="P7000497027000000000000000042542">valE: input from M; output W_valE to E in Register file</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042543" id="P7000497027000000000000000042543"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042544" id="P7000497027000000000000000042544">valM: input data out from Data memory; output W_valM to M in Register file and to Select PC</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042545" id="P7000497027000000000000000042545"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042546" id="P7000497027000000000000000042546">dstE from M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042547" id="P7000497027000000000000000042547"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042548" id="P7000497027000000000000000042548">dstM from M</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042549" id="P7000497027000000000000000042549"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004254A" id="P700049702700000000000000004254A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004219" epub:type="pagebreak" id="P7000497027000000000000000004219" title="425"></span><span class="pcalibre1 pcalibre2 pcalibre41">E </span>sits between the decode and execute stages. It holds information about the most recently decoded instruction and the values read from the register file for processing by the execute stage.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004254B" id="P700049702700000000000000004254B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004254C" id="P700049702700000000000000004254C"><span class="pcalibre1 pcalibre2 pcalibre41">M </span>sits between the execute and memory stages. It holds the results of the most recently executed instruction for processing by the memory stage. It also holds information about branch conditions and branch targets for processing conditional jumps.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P700049702700000000000000004254D" id="P700049702700000000000000004254D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004254E" id="P700049702700000000000000004254E"><span class="pcalibre1 pcalibre2 pcalibre41">W </span>sits between the memory stage and the feedback paths that supply the computed results to the register file for writing and the return address to the PC selection logic when completing a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004254F" id="P700049702700000000000000004254F">ret</code> instruction.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042550" id="P7000497027000000000000000042550"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004224"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.42</span></a> shows how the following code sequence would flow through our five-stage pipeline, where the comments identify the instructions as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042551" id="P7000497027000000000000000042551">I1</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042552" id="P7000497027000000000000000042552">I5</code> for reference:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042553" id="P7000497027000000000000000042553"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042554" id="P7000497027000000000000000042554">1	irmovq	$1,%rax # I1
2	irmovq	$2,%rbx # I2
3	irmovq	$3,%rcx # I3
4	irmovq	$4,%rdx # I4
5	halt		#I5
</code>
</pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004224" id="P7000497027000000000000000004224">
<img alt="A diagram illustrates instruction flow through a pipeline." class="pcalibre168 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B6EF" id="P7000497027000000000000000042555" src="Images/chapter-04-image-31.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042556" id="P7000497027000000000000000042556"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042557" epub:type="title" id="P7000497027000000000000000042557"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.42 </span>Example of instruction flow through pipeline.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000022833" id="P7000497027000000000000000022833">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042558" id="P7000497027000000000000000042558">A diagram illustrates a pipeline divided into cycles, as summarized in the following table.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042559" id="P7000497027000000000000000042559">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004255A" id="P700049702700000000000000004255A"></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004255B" id="P700049702700000000000000004255B"></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004255C" id="P700049702700000000000000004255C"></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004255D" id="P700049702700000000000000004255D">1</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004255E" id="P700049702700000000000000004255E">2</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004255F" id="P700049702700000000000000004255F">3</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042560" id="P7000497027000000000000000042560">4</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042561" id="P7000497027000000000000000042561">5</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042562" id="P7000497027000000000000000042562">6</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042563" id="P7000497027000000000000000042563">7</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042564" id="P7000497027000000000000000042564">8</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042565" id="P7000497027000000000000000042565">9</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042566" id="P7000497027000000000000000042566">irmovq</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042567" id="P7000497027000000000000000042567">$1, %rax</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042568" id="P7000497027000000000000000042568">#I1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042569" id="P7000497027000000000000000042569">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004256A" id="P700049702700000000000000004256A">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004256B" id="P700049702700000000000000004256B">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004256C" id="P700049702700000000000000004256C">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004256D" id="P700049702700000000000000004256D">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004256E" id="P700049702700000000000000004256E">irmovq</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004256F" id="P700049702700000000000000004256F">$2, %rbx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042570" id="P7000497027000000000000000042570">#I2</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042571" id="P7000497027000000000000000042571">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042572" id="P7000497027000000000000000042572">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042573" id="P7000497027000000000000000042573">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042574" id="P7000497027000000000000000042574">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042575" id="P7000497027000000000000000042575">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042576" id="P7000497027000000000000000042576">Irmovq</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042577" id="P7000497027000000000000000042577">$3, %rcx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042578" id="P7000497027000000000000000042578">#I3</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042579" id="P7000497027000000000000000042579">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004257A" id="P700049702700000000000000004257A">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004257B" id="P700049702700000000000000004257B">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004257C" id="P700049702700000000000000004257C">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004257D" id="P700049702700000000000000004257D">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004257E" id="P700049702700000000000000004257E">Irmovq</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004257F" id="P700049702700000000000000004257F"> $4, %rdx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042580" id="P7000497027000000000000000042580">#I4</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042581" id="P7000497027000000000000000042581">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042582" id="P7000497027000000000000000042582">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042583" id="P7000497027000000000000000042583">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042584" id="P7000497027000000000000000042584">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042585" id="P7000497027000000000000000042585">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042586" id="P7000497027000000000000000042586">halt</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042587" id="P7000497027000000000000000042587">#I5</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042588" id="P7000497027000000000000000042588">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042589" id="P7000497027000000000000000042589">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004258A" id="P700049702700000000000000004258A">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004258B" id="P700049702700000000000000004258B">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004258C" id="P700049702700000000000000004258C">W</td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004258D" id="P700049702700000000000000004258D">Cycle 5 is illustrated with W I1, MI2, EI3, DI4, and FI5.</p>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004258E" id="P700049702700000000000000004258E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004229" epub:type="pagebreak" id="P7000497027000000000000000004229" title="426"></span>The right side of the figure shows a pipeline diagram for this instruction sequence. As with the pipeline diagrams for the simple pipelined computation units of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004152.xhtml#P7000497027000000000000000004152"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.4</span></a>, this diagram shows the progression of each instruction through the pipeline stages, with time increasing from left to right. The numbers along the top identify the clock cycles at which the different stages occur. For example, in cycle 1, instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004258F" id="P700049702700000000000000004258F">I1</code> is fetched, and it then proceeds through the pipeline stages, with its result being written to the register file after the end of cycle 5. Instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042590" id="P7000497027000000000000000042590">I2</code> is fetched in cycle 2, and its result is written back after the end of cycle 6, and so on. At the bottom, we show an expanded view of the pipeline for cycle 5. At this point, there is an instruction in each of the pipeline stages.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042591" id="P7000497027000000000000000042591">From <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004224"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.42</span></a>, we can also justify our convention of drawing processors so that the instructions flow from bottom to top. The expanded view for cycle 5 shows the pipeline stages with the fetch stage on the bottom and the write-back stage on the top, just as do our diagrams of the pipeline hardware (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004210"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.41</span></a>). If we look at the ordering of instructions in the pipeline stages, we see that they appear in the same order as they do in the program listing. Since normal program flow goes from top to bottom of a listing, we preserve this ordering by having the pipeline flow go from bottom to top. This convention is particularly useful when working with the simulators that accompany this text.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000422D" id="P700049702700000000000000000422D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042592" epub:type="title" id="P7000497027000000000000000042592"><span class="pcalibre1 pcalibre21 pcalibre2">4.5.3 </span>Rearranging and Relabeling Signals</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042593" id="P7000497027000000000000000042593">Our sequential implementations SEQ and SEQ+ only process one instruction at a time, and so there are unique values for signals such as valC, srcA, and valE. In our pipelined design, there will be multiple versions of these values associated with the different instructions flowing through the system. For example, in the detailed structure of PIPE—, there are four white boxes labeled "Stat" that hold the status codes for four different instructions (see <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004210"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.41</span></a>). We need to take great care to make sure we use the proper version of a signal, or else we could have serious errors, such as storing the result computed for one instruction at the destination register specified by another instruction. We adopt a naming scheme where a signal stored in a pipeline register can be uniquely identified by prefixing its name with that of the pipe register written in uppercase. For example, the four status codes are named D_stat, E_stat, M_stat, and W_stat. We also need to refer to some signals that have just been computed within a stage. These are labeled by prefixing the signal name with the first character of the stage name, written in lowercase. Using the status codes as examples, we can see control logic blocks labeled "Stat" in the fetch and memory stages. The outputs of these blocks are therefore named f_stat and m_stat. We can also see that the actual status of the overall processor Stat is computed by a block in the write-back stage, based on the status value in pipeline register W.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042594" id="P7000497027000000000000000042594">The decode stages of SEQ+ and PIPE— both generate signals dstE and dstM indicating the destination register for values valE and valM. In SEQ+, we could connect these signals directly to the address inputs of the register file write ports. With PIPE-, these signals are carried along in the pipeline through the execute and memory stages and are directed to the register file only once they reach</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000004231" id="P7000497027000000000000000004231"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000042595" epub:type="title" id="P7000497027000000000000000042595"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004233" epub:type="pagebreak" id="P7000497027000000000000000004233" title="427"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>What is the difference between signals M_stat and m_stat?</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042596" id="P7000497027000000000000000042596">With our naming system, the uppercase prefixes `D', `E', `M', and `W refer to pipeline <i class="pcalibre17 pcalibre2 pcalibre1">registers</i>, and so M_stat refers to the status code field of pipeline register M. The lowercase prefixes `f', `d', `e', `m', and `w' refer to the pipeline <i class="pcalibre17 pcalibre2 pcalibre1">stages</i>, and so m_stat refers to the status signal generated in the memory stage by a control logic block.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042597" id="P7000497027000000000000000042597">Understanding this naming convention is critical to understanding the operation of our pipelined processors.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042598" id="P7000497027000000000000000042598">the write-back stage (shown in the more detailed views of the stages). We do this to make sure the write port address and data inputs hold values from the same instruction. Otherwise, the write back would be writing the values for the instruction in the write-back stage, but with register IDs from the instruction in the decode stage. As a general principle, we want to keep all of the information about a particular instruction contained within a single pipeline stage.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042599" id="P7000497027000000000000000042599">One block of PIPE— that is not present in SEQ+ in the exact same form is the block labeled "Select A" in the decode stage. We can see that this block generates the value valA for the pipeline register E by choosing either valP from pipeline register D or the value read from the A port of the register file. This block is included to reduce the amount of state that must be carried forward to pipeline registers E and M. Of all the different instructions, only the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004259A" id="P700049702700000000000000004259A">call</code> requires valP in the memory stage. Only the jump instructions require the value of valP in the execute stage (in the event the jump is not taken). None of these instructions requires a value read from the register file. Therefore, we can reduce the amount of pipeline register state by merging these two signals and carrying them through the pipeline as a single signal valA. This eliminates the need for the block labeled "Data" in SEQ (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003FCB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.23</span></a>) and SEQ+ (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004209"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.40</span></a>), which served a similar purpose. In hardware design, it is common to carefully identify how signals get used and then reduce the amount of register state and wiring by merging signals such as these.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004259B" id="P700049702700000000000000004259B">As shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004210"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.41</span></a>, our pipeline registers include a field for the status code stat, initially computed during the fetch stage and possibly modified during the memory stage. We will discuss how to implement the processing of exceptional events in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_001.xhtml#P700049702700000000000000000438D"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5.6</span></a>, after we have covered the implementation of normal instruction execution. Suffice it to say at this point that the most systematic approach is to associate a status code with each instruction as it passes through the pipeline, as we have indicated in the figure.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000423A" id="P700049702700000000000000000423A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004259C" epub:type="title" id="P700049702700000000000000004259C"><span class="pcalibre1 pcalibre21 pcalibre2">4.5.4 </span>Next PC Prediction</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004259D" id="P700049702700000000000000004259D">We have taken some measures in the design of PIPE— to properly handle control dependencies. Our goal in the pipelined design is to <i class="pcalibre17 pcalibre2 pcalibre1">issue</i> a new instruction on every clock cycle, meaning that on each clock cycle, a new instruction proceeds into the execute stage and will ultimately be completed. Achieving this goal would</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000000423D" id="P700049702700000000000000000423D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P700049702700000000000000004259E" epub:type="title" id="P700049702700000000000000004259E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000423F" epub:type="pagebreak" id="P700049702700000000000000000423F" title="428"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Other branch prediction strategies</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P700049702700000000000000004259F" id="P700049702700000000000000004259F">Our design uses an <i class="pcalibre17 pcalibre2 pcalibre1">always taken</i> branch prediction strategy. Studies show this strategy has around a 60% success rate <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3FA">[44,</a> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B499">122]</a>. Conversely, a <i class="pcalibre17 pcalibre2 pcalibre1">never taken</i> (NT) strategy has around a 40% success rate. A slightly more sophisticated strategy, known as <i class="pcalibre17 pcalibre2 pcalibre1">backward taken, forward not taken</i> (BTFNT), predicts that branches to lower addresses than the next instruction will be taken, while those to higher addresses will not be taken. This strategy has a success rate of around 65%. This improvement stems from the fact that loops are closed by backward branches and loops are generally executed multiple times. Forward branches are used for conditional operations, and these are less likely to be taken. In Problems 4.55 and 4.56, you can modify the Y86-64 pipeline processor to implement the NT and BTFNT branch prediction strategies.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000425A0" id="P70004970270000000000000000425A0">As we saw in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002578"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6.6</span></a>, mispredicted branches can degrade the performance of a program considerably, thus motivating the use of conditional data transfer rather than conditional control transfer when possible.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425A1" id="P70004970270000000000000000425A1">yield a throughput of one instruction per cycle. To do this, we must determine the location of the next instruction right after fetching the current instruction. Unfortunately, if the fetched instruction is a conditional branch, we will not know whether or not the branch should be taken until several cycles later, after the instruction has passed through the execute stage. Similarly, if the fetched instruction is a ret, we cannot determine the return location until the instruction has passed through the memory stage.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425A2" id="P70004970270000000000000000425A2">With the exception of conditional jump instructions and ret, we can determine the address of the next instruction based on information computed during the fetch stage. For <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425A3" id="P70004970270000000000000000425A3">call</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425A4" id="P70004970270000000000000000425A4">jmp</code> (unconditional jump), it will be valC, the constant word in the instruction, while for all others it will be valP, the address of the next instruction. We can therefore achieve our goal of issuing a new instruction every clock cycle in most cases by <i class="pcalibre17 pcalibre2 pcalibre1">predicting</i> the next value of the PC. For most instruction types, our prediction will be completely reliable. For conditional jumps, we can predict either that a jump will be taken, so that the new PC value would be valC, or that it will not be taken, so that the new PC value would be valP. In either case, we must somehow deal with the case where our prediction was incorrect and therefore we have fetched and partially executed the wrong instructions. We will return to this matter in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004435"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5.8</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425A5" id="P70004970270000000000000000425A5">This technique of guessing the branch direction and then initiating the fetching of instructions according to our guess is known as <i class="pcalibre17 pcalibre2 pcalibre1">branch prediction</i>. It is used in some form by virtually all processors. Extensive experiments have been conducted on effective strategies for predicting whether or not branches will be taken <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3FE">[46,</a> <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000000CB3_split_000.xhtml#P7000497027000000000000000000CB3"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">2.3</span></a>]. Some systems devote large amounts of hardware to this task. In our design, we will use the simple strategy of predicting that conditional branches are always taken, and so we predict the new value of the PC to be valC.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425A6" id="P70004970270000000000000000425A6">We are still left with predicting the new PC value resulting from a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425A7" id="P70004970270000000000000000425A7">ret</code> instruction. Unlike conditional jumps, we have a nearly unbounded set of possible</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000004249" id="P7000497027000000000000000004249"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P70004970270000000000000000425A8" epub:type="title" id="P70004970270000000000000000425A8"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000424B" epub:type="pagebreak" id="P700049702700000000000000000424B" title="429"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Return address prediction with a stack</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000425A9" id="P70004970270000000000000000425A9">With most programs, it is very easy to predict return addresses, since procedure calls and returns occur in matched pairs. Most of the time that a procedure is called, it returns to the instruction following the call. This property is exploited in high-performance processors by including a hardware stack within the instruction fetch unit that holds the return address generated by procedure call instructions. Every time a procedure call instruction is executed, its return address is pushed onto the stack. When a return instruction is fetched, the top value is popped from this stack and used as the predicted return address. Like branch prediction, a mechanism must be provided to recover when the prediction was incorrect, since there are times when calls and returns do not match. In general, the prediction is highly reliable. This hardware stack is not part of the programmer-visible state.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425AA" id="P70004970270000000000000000425AA">results, since the return address will be whatever word is on the top of the stack. In our design, we will not attempt to predict any value for the return address. Instead, we will simply hold off processing any more instructions until the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425AB" id="P70004970270000000000000000425AB">ret</code> instruction passes through the write-back stage. We will return to this part of the implementation in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004435"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5.8</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425AC" id="P70004970270000000000000000425AC">The PIPE— fetch stage, diagrammed at the bottom of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004210"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.41</span></a>, is responsible for both predicting the next value of the PC and selecting the actual PC for the instruction fetch. We can see the block labeled "Predict PC" can choose either valP (as computed by the PC incrementer) or valC (from the fetched instruction). This value is stored in pipeline register F as the <i class="pcalibre17 pcalibre2 pcalibre1">predicted</i> value of the program counter. The block labeled "Select PC" is similar to the block labeled "PC" in the SEQ+ PC selection stage (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004209"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.40</span></a>). It chooses one of three values to serve as the address for the instruction memory: the predicted PC, the value of valP for a not-taken branch instruction that reaches pipeline register M (stored in register M_valA), or the value of the return address when a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425AD" id="P70004970270000000000000000425AD">ret</code> instruction reaches pipeline register W (stored in W_valM).</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004251" id="P7000497027000000000000000004251"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425AE" epub:type="title" id="P70004970270000000000000000425AE"><span class="pcalibre1 pcalibre21 pcalibre2">4.5.5 </span>Pipeline Hazards</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425AF" id="P70004970270000000000000000425AF">Our structure PIPE— is a good start at creating a pipelined Y86-64 processor. Recall from our discussion in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004152.xhtml#P70004970270000000000000000041CB"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.4.4</span></a>, however, that introducing pipelining into a system with feedback can lead to problems when there are dependencies between successive instructions. We must resolve this issue before we can complete our design. These dependencies can take two forms: (1) <i class="pcalibre17 pcalibre2 pcalibre1">data</i> dependencies, where the results computed by one instruction are used as the data for a following instruction, and (2) <i class="pcalibre17 pcalibre2 pcalibre1">control</i> dependencies, where one instruction determines the location of the following instruction, such as when executing a jump, call, or return. When such dependencies have the potential to cause an erroneous computation by the pipeline, they are called <i class="pcalibre17 pcalibre2 pcalibre1">hazards</i>. Like dependencies, hazards can be classified as either <i class="pcalibre17 pcalibre2 pcalibre1">data hazards</i> or <i class="pcalibre17 pcalibre2 pcalibre1">control hazards</i>. We first concern ourselves with data hazards and then consider control hazards.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004254" id="P7000497027000000000000000004254">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004255" epub:type="pagebreak" id="P7000497027000000000000000004255" title="430"></span><img alt="A diagram illustrates a pipelined execution of prog1." class="pcalibre169 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6F0" id="P70004970270000000000000000425B0" src="Images/chapter-04-image-32.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P70004970270000000000000000425B1" id="P70004970270000000000000000425B1"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P70004970270000000000000000425B2" epub:type="title" id="P70004970270000000000000000425B2"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.43 </span>Pipelined execution of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425B3" id="P70004970270000000000000000425B3">prog1</code> without special pipeline control.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425B4" id="P70004970270000000000000000425B4"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425B5" id="P70004970270000000000000000425B5">In cycle 6, the second <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425B6" id="P70004970270000000000000000425B6">irmovq</code> writes its result to program register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425B7" id="P70004970270000000000000000425B7">%rax</code>. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425B8" id="P70004970270000000000000000425B8">addq</code> instruction reads its source operands in cycle 7, so it gets correct values for both <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425B9" id="P70004970270000000000000000425B9">%rdx</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425BA" id="P70004970270000000000000000425BA">%rax</code>.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000425BB" id="P70004970270000000000000000425BB">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000022897" id="P7000497027000000000000000022897">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425BC" id="P70004970270000000000000000425BC">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P70004970270000000000000000425BD" id="P70004970270000000000000000425BD">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425BE" id="P70004970270000000000000000425BE">Prog1</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425BF" id="P70004970270000000000000000425BF">1</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C0" id="P70004970270000000000000000425C0">2</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C1" id="P70004970270000000000000000425C1">3</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C2" id="P70004970270000000000000000425C2">4</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C3" id="P70004970270000000000000000425C3">5</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C4" id="P70004970270000000000000000425C4">6</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C5" id="P70004970270000000000000000425C5">7</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C6" id="P70004970270000000000000000425C6">8</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C7" id="P70004970270000000000000000425C7">9</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C8" id="P70004970270000000000000000425C8">10</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000425C9" id="P70004970270000000000000000425C9">11</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425CA" id="P70004970270000000000000000425CA">0x000: irmovq $10, %rdx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425CB" id="P70004970270000000000000000425CB">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425CC" id="P70004970270000000000000000425CC">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425CD" id="P70004970270000000000000000425CD">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425CE" id="P70004970270000000000000000425CE">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425CF" id="P70004970270000000000000000425CF">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D0" id="P70004970270000000000000000425D0">0x00a: irmovq $3, %rax</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D1" id="P70004970270000000000000000425D1">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D2" id="P70004970270000000000000000425D2">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D3" id="P70004970270000000000000000425D3">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D4" id="P70004970270000000000000000425D4">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D5" id="P70004970270000000000000000425D5">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D6" id="P70004970270000000000000000425D6">0x014: nop</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D7" id="P70004970270000000000000000425D7">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D8" id="P70004970270000000000000000425D8">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425D9" id="P70004970270000000000000000425D9">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425DA" id="P70004970270000000000000000425DA">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425DB" id="P70004970270000000000000000425DB">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425DC" id="P70004970270000000000000000425DC">0x015: nop</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425DD" id="P70004970270000000000000000425DD">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425DE" id="P70004970270000000000000000425DE">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425DF" id="P70004970270000000000000000425DF">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E0" id="P70004970270000000000000000425E0">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E1" id="P70004970270000000000000000425E1">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E2" id="P70004970270000000000000000425E2">0x016: nop</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E3" id="P70004970270000000000000000425E3">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E4" id="P70004970270000000000000000425E4">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E5" id="P70004970270000000000000000425E5">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E6" id="P70004970270000000000000000425E6">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E7" id="P70004970270000000000000000425E7">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E8" id="P70004970270000000000000000425E8">0x017: addq %rdx, %rax</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425E9" id="P70004970270000000000000000425E9">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425EA" id="P70004970270000000000000000425EA">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425EB" id="P70004970270000000000000000425EB">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425EC" id="P70004970270000000000000000425EC">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425ED" id="P70004970270000000000000000425ED">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425EE" id="P70004970270000000000000000425EE">0x019: halt</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425EF" id="P70004970270000000000000000425EF">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425F0" id="P70004970270000000000000000425F0">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425F1" id="P70004970270000000000000000425F1">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425F2" id="P70004970270000000000000000425F2">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000425F3" id="P70004970270000000000000000425F3">W</td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000425F4" id="P70004970270000000000000000425F4">Cycle 6 is illustrated with W R[%rax] ← 3. Cycle 7 is illustrated with D valA ← R[%rdx] = 10, valB ← R[%rax] = 3.</p>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425F5" id="P70004970270000000000000000425F5"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004254"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.43</span></a> illustrates the processing of a sequence of instructions we refer to as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425F6" id="P70004970270000000000000000425F6">prog1</code> by the PIPE— processor. Let us assume in this example and successive ones that the program registers initially all have value 0. The code loads values 10 and 3 into program registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425F7" id="P70004970270000000000000000425F7">%rdx</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425F8" id="P70004970270000000000000000425F8">%rax</code>, executes three <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425F9" id="P70004970270000000000000000425F9">nop</code> instructions, and then adds register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425FA" id="P70004970270000000000000000425FA">%rdx</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425FB" id="P70004970270000000000000000425FB">%rax</code>. We focus our attention on the potential data hazards resulting from the data dependencies between the two <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425FC" id="P70004970270000000000000000425FC">irmovq</code> instructions and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425FD" id="P70004970270000000000000000425FD">addq</code> instruction. On the right-hand side of the figure, we show a pipeline diagram for the instruction sequence. The pipeline stages for cycles 6 and 7 are shown highlighted in the pipeline diagram. Below this, we show an expanded view of the write-back activity in cycle 6 and the decode activity during cycle 7. After the start of cycle 7, both of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425FE" id="P70004970270000000000000000425FE">irmovq</code> instructions have passed through the write back stage, and so the register file holds the updated values of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000425FF" id="P70004970270000000000000000425FF">%rdx</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042600" id="P7000497027000000000000000042600">%rax</code>. As the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042601" id="P7000497027000000000000000042601">addq</code> instruction passes through the decode stage during cycle 7, it will therefore read the correct values for its source operands. The data dependencies between the two <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042602" id="P7000497027000000000000000042602">irmovq</code> instructions and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042603" id="P7000497027000000000000000042603">addq</code> instruction have not created data hazards in this example.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042604" id="P7000497027000000000000000042604">We saw that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042605" id="P7000497027000000000000000042605">prog1</code> will flow through our pipeline and get the correct results, because the three <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042606" id="P7000497027000000000000000042606">nop</code> instructions create a delay between instructions with data</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004273" id="P7000497027000000000000000004273">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004274" epub:type="pagebreak" id="P7000497027000000000000000004274" title="431"></span><img alt="A diagram illustrates a pipelined execution of prog2." class="pcalibre1 pcalibre170 pcalibre2" data-uri="P700049702700000000000000000B6F1" id="P7000497027000000000000000042607" src="Images/chapter-04-image-33.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042608" id="P7000497027000000000000000042608"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042609" epub:type="title" id="P7000497027000000000000000042609"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.44 </span>Pipelined execution of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004260A" id="P700049702700000000000000004260A">prog2</code> without special pipeline control.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P700049702700000000000000004260B" id="P700049702700000000000000004260B"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004260C" id="P700049702700000000000000004260C">The write to program register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004260D" id="P700049702700000000000000004260D">%rax</code> does not occur until the start of cycle 7, and so the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004260E" id="P700049702700000000000000004260E">addq</code> instruction gets the incorrect value for this register in the decode stage.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004260F" id="P700049702700000000000000004260F">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000228EB" id="P70004970270000000000000000228EB">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042610" id="P7000497027000000000000000042610">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042611" id="P7000497027000000000000000042611">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042612" id="P7000497027000000000000000042612">Prog2</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042613" id="P7000497027000000000000000042613">1</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042614" id="P7000497027000000000000000042614">2</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042615" id="P7000497027000000000000000042615">3</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042616" id="P7000497027000000000000000042616">4</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042617" id="P7000497027000000000000000042617">5</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042618" id="P7000497027000000000000000042618">6</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042619" id="P7000497027000000000000000042619">7</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004261A" id="P700049702700000000000000004261A">8</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004261B" id="P700049702700000000000000004261B">9</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004261C" id="P700049702700000000000000004261C">10</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004261D" id="P700049702700000000000000004261D">0x000: irmovq $10, %rdx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004261E" id="P700049702700000000000000004261E">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004261F" id="P700049702700000000000000004261F">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042620" id="P7000497027000000000000000042620">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042621" id="P7000497027000000000000000042621">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042622" id="P7000497027000000000000000042622">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042623" id="P7000497027000000000000000042623">0x00a: irmovq $3, %rax</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042624" id="P7000497027000000000000000042624">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042625" id="P7000497027000000000000000042625">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042626" id="P7000497027000000000000000042626">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042627" id="P7000497027000000000000000042627">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042628" id="P7000497027000000000000000042628">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042629" id="P7000497027000000000000000042629">0x014: nop</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004262A" id="P700049702700000000000000004262A">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004262B" id="P700049702700000000000000004262B">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004262C" id="P700049702700000000000000004262C">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004262D" id="P700049702700000000000000004262D">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004262E" id="P700049702700000000000000004262E">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004262F" id="P700049702700000000000000004262F">0x015: nop</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042630" id="P7000497027000000000000000042630">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042631" id="P7000497027000000000000000042631">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042632" id="P7000497027000000000000000042632">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042633" id="P7000497027000000000000000042633">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042634" id="P7000497027000000000000000042634">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042635" id="P7000497027000000000000000042635">0x016: addq %rdx, %rax</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042636" id="P7000497027000000000000000042636">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042637" id="P7000497027000000000000000042637">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042638" id="P7000497027000000000000000042638">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042639" id="P7000497027000000000000000042639">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004263A" id="P700049702700000000000000004263A">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004263B" id="P700049702700000000000000004263B">0x018: halt </td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004263C" id="P700049702700000000000000004263C">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004263D" id="P700049702700000000000000004263D">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004263E" id="P700049702700000000000000004263E">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004263F" id="P700049702700000000000000004263F">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042640" id="P7000497027000000000000000042640">W</td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042641" id="P7000497027000000000000000042641">Cycle 6 is illustrated with W R[%rax] ← 3 and D valA ← R[%rdx] = 10, valB ← R[%rax] = 0 (error).</p>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042642" id="P7000497027000000000000000042642">dependencies. Let us see what happens as these <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042643" id="P7000497027000000000000000042643">nop</code> instructions are removed. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004273"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.44</span></a> illustrates the pipeline flow of a program, named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042644" id="P7000497027000000000000000042644">prog2</code>, containing two <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042645" id="P7000497027000000000000000042645">nop</code> instructions between the two <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042646" id="P7000497027000000000000000042646">irmovq</code> instructions generating values for registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042647" id="P7000497027000000000000000042647">%rdx</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042648" id="P7000497027000000000000000042648">%rax</code> and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042649" id="P7000497027000000000000000042649">addq</code> instruction having these two registers as operands. In this case, the crucial step occurs in cycle 6, when the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004264A" id="P700049702700000000000000004264A">addq</code> instruction reads its operands from the register file. An expanded view of the pipeline activities during this cycle is shown at the bottom of the figure. The first <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004264B" id="P700049702700000000000000004264B">irmovq</code> instruction has passed through the write-back stage, and so program register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004264C" id="P700049702700000000000000004264C">%rdx</code> has been updated in the register file. The second <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004264D" id="P700049702700000000000000004264D">irmovq</code> instruction is in the write-back stage during this cycle, and so the write to program register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004264E" id="P700049702700000000000000004264E">%rax</code> only occurs at the start of cycle 7 as the clock rises. As a result, the incorrect value zero would be read for register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004264F" id="P700049702700000000000000004264F">%rax</code> (recall that we assume all registers are initially zero), since the pending write for this register has not yet occurred. Clearly, we will have to adapt our pipeline to handle this hazard properly.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042650" id="P7000497027000000000000000042650"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004291"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.45</span></a> shows what happens when we have only one <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042651" id="P7000497027000000000000000042651">nop</code> instruction between the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042652" id="P7000497027000000000000000042652">irmovq</code> instructions and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042653" id="P7000497027000000000000000042653">addq</code> instruction, yielding a program <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042654" id="P7000497027000000000000000042654">prog3</code>. Now we must examine the behavior of the pipeline during cycle 5 as the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042655" id="P7000497027000000000000000042655">addq</code> instruction passes through the decode stage. Unfortunately, the pending</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004291" id="P7000497027000000000000000004291">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004292" epub:type="pagebreak" id="P7000497027000000000000000004292" title="432"></span><img alt="A diagram illustrates a pipelined execution of prog3." class="pcalibre1 pcalibre2 pcalibre171" data-uri="P700049702700000000000000000B6F2" id="P7000497027000000000000000042656" src="Images/chapter-04-image-34.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042657" id="P7000497027000000000000000042657"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042658" epub:type="title" id="P7000497027000000000000000042658"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.45 </span>Pipelined execution of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042659" id="P7000497027000000000000000042659">prog3</code> without special pipeline control.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P700049702700000000000000004265A" id="P700049702700000000000000004265A"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004265B" id="P700049702700000000000000004265B">In cycle 5, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004265C" id="P700049702700000000000000004265C">addq</code> instruction reads its source operands from the register file. The pending write to register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004265D" id="P700049702700000000000000004265D">%rdx</code> is still in the write-back stage, and the pending write to register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004265E" id="P700049702700000000000000004265E">%rax</code> is still in the memory stage. Both operands valA and valB get incorrect values.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004265F" id="P700049702700000000000000004265F">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P700049702700000000000000002293B" id="P700049702700000000000000002293B">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042660" id="P7000497027000000000000000042660">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042661" id="P7000497027000000000000000042661">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042662" id="P7000497027000000000000000042662">Prog3</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042663" id="P7000497027000000000000000042663">1</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042664" id="P7000497027000000000000000042664">2</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042665" id="P7000497027000000000000000042665">3</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042666" id="P7000497027000000000000000042666">4</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042667" id="P7000497027000000000000000042667">5</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042668" id="P7000497027000000000000000042668">6</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042669" id="P7000497027000000000000000042669">7</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004266A" id="P700049702700000000000000004266A">8</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P700049702700000000000000004266B" id="P700049702700000000000000004266B">9</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004266C" id="P700049702700000000000000004266C">0x000: irmovq $10, %rdx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004266D" id="P700049702700000000000000004266D">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004266E" id="P700049702700000000000000004266E">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004266F" id="P700049702700000000000000004266F">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042670" id="P7000497027000000000000000042670">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042671" id="P7000497027000000000000000042671">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042672" id="P7000497027000000000000000042672">0x00a: irmovq $3, %rax</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042673" id="P7000497027000000000000000042673">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042674" id="P7000497027000000000000000042674">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042675" id="P7000497027000000000000000042675">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042676" id="P7000497027000000000000000042676">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042677" id="P7000497027000000000000000042677">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042678" id="P7000497027000000000000000042678">0x014: nop</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042679" id="P7000497027000000000000000042679">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004267A" id="P700049702700000000000000004267A">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004267B" id="P700049702700000000000000004267B">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004267C" id="P700049702700000000000000004267C">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004267D" id="P700049702700000000000000004267D">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004267E" id="P700049702700000000000000004267E">0x015: addq %rdx, %rax</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P700049702700000000000000004267F" id="P700049702700000000000000004267F">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042680" id="P7000497027000000000000000042680">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042681" id="P7000497027000000000000000042681">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042682" id="P7000497027000000000000000042682">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042683" id="P7000497027000000000000000042683">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042684" id="P7000497027000000000000000042684">0x017: halt</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042685" id="P7000497027000000000000000042685">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042686" id="P7000497027000000000000000042686">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042687" id="P7000497027000000000000000042687">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042688" id="P7000497027000000000000000042688">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042689" id="P7000497027000000000000000042689">W</td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P700049702700000000000000004268A" id="P700049702700000000000000004268A">Cycle 5 is illustrated with W R[%rdx] ← 10, M M_valE = 3, M_dstE = %rax, and D valA ← R[%rdx] = 0 (error), valB ← R[%rax] = 0 (error).</p>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004268B" id="P700049702700000000000000004268B">write to register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004268C" id="P700049702700000000000000004268C">%rdx</code> is still in the write-back stage, and the pending write to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004268D" id="P700049702700000000000000004268D">%rax</code> is still in the memory stage. Therefore, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004268E" id="P700049702700000000000000004268E">addq</code> instruction would get the incorrect values for both operands.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004268F" id="P700049702700000000000000004268F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P70004970270000000000000000042AA"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.46</span></a> shows what happens when we remove all of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042690" id="P7000497027000000000000000042690">nop</code> instructions between the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042691" id="P7000497027000000000000000042691">irmovq</code> instructions and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042692" id="P7000497027000000000000000042692">addq</code> instruction, yielding a program <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042693" id="P7000497027000000000000000042693">prog4</code>. Now we must examine the behavior of the pipeline during cycle 4 as the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042694" id="P7000497027000000000000000042694">addq</code> instruction passes through the decode stage. Unfortunately, the pending write to register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042695" id="P7000497027000000000000000042695">%rdx</code> is still in the memory stage, and the new value for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042696" id="P7000497027000000000000000042696">%rax</code> is just being computed in the execute stage. Therefore, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042697" id="P7000497027000000000000000042697">addq</code> instruction would get the incorrect values for both operands.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042698" id="P7000497027000000000000000042698">These examples illustrate that a data hazard can arise for an instruction when one of its operands is updated by any of the three preceding instructions. These hazards occur because our pipelined processor reads the operands for an instruction from the register file in the decode stage but does not write the results for the instruction to the register file until three cycles later, after the instruction passes through the write-back stage.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P70004970270000000000000000042AA" id="P70004970270000000000000000042AA">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000042AB" epub:type="pagebreak" id="P70004970270000000000000000042AB" title="433"></span><img alt="A diagram illustrates a pipelined execution of prog4." class="pcalibre172 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6F3" id="P7000497027000000000000000042699" src="Images/chapter-04-image-35.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P700049702700000000000000004269A" id="P700049702700000000000000004269A"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P700049702700000000000000004269B" epub:type="title" id="P700049702700000000000000004269B"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.46 </span>Pipelined execution of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004269C" id="P700049702700000000000000004269C">prog4</code> <b class="pcalibre1 pcalibre2 pcalibre12">without special pipeline control.</b></h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P700049702700000000000000004269D" id="P700049702700000000000000004269D"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004269E" id="P700049702700000000000000004269E">In cycle 4, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P700049702700000000000000004269F" id="P700049702700000000000000004269F">addq</code> instruction reads its source operands from the register file. The pending write to register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426A0" id="P70004970270000000000000000426A0">%rdx</code> is still in the memory stage, and the new value for register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426A1" id="P70004970270000000000000000426A1">%rax</code> is just being computed in the execute stage. Both operands valA and valB get incorrect values.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000426A2" id="P70004970270000000000000000426A2">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P700049702700000000000000002297E" id="P700049702700000000000000002297E">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426A3" id="P70004970270000000000000000426A3">A diagram illustrates a pipeline with cycles, as summarized in the following table.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P70004970270000000000000000426A4" id="P70004970270000000000000000426A4">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000426A5" id="P70004970270000000000000000426A5">Prog4</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000426A6" id="P70004970270000000000000000426A6">1</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000426A7" id="P70004970270000000000000000426A7">2</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000426A8" id="P70004970270000000000000000426A8">3</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000426A9" id="P70004970270000000000000000426A9">4</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000426AA" id="P70004970270000000000000000426AA">5</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000426AB" id="P70004970270000000000000000426AB">6</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000426AC" id="P70004970270000000000000000426AC">7</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P70004970270000000000000000426AD" id="P70004970270000000000000000426AD">8</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426AE" id="P70004970270000000000000000426AE">0x000: irmovq $10, %rdx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426AF" id="P70004970270000000000000000426AF">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B0" id="P70004970270000000000000000426B0">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B1" id="P70004970270000000000000000426B1">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B2" id="P70004970270000000000000000426B2">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B3" id="P70004970270000000000000000426B3">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B4" id="P70004970270000000000000000426B4">0x00a: irmovq $3, %rax</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B5" id="P70004970270000000000000000426B5">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B6" id="P70004970270000000000000000426B6">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B7" id="P70004970270000000000000000426B7">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B8" id="P70004970270000000000000000426B8">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426B9" id="P70004970270000000000000000426B9">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426BA" id="P70004970270000000000000000426BA">0x014: addq %rdx, %rax</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426BB" id="P70004970270000000000000000426BB">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426BC" id="P70004970270000000000000000426BC">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426BD" id="P70004970270000000000000000426BD">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426BE" id="P70004970270000000000000000426BE">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426BF" id="P70004970270000000000000000426BF">W</td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426C0" id="P70004970270000000000000000426C0">0x016: halt </td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426C1" id="P70004970270000000000000000426C1">F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426C2" id="P70004970270000000000000000426C2">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426C3" id="P70004970270000000000000000426C3">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426C4" id="P70004970270000000000000000426C4">M</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P70004970270000000000000000426C5" id="P70004970270000000000000000426C5">W</td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P70004970270000000000000000426C6" id="P70004970270000000000000000426C6">Cycle 4 is illustrated with M M_valE = 10, M_dstE = %rdx, E e_valE ← 0 + 3 = 3, E_dstE = %rax, and D valA ← R[%rdx] = 0 (error), valB ← R[%rax] = 0 (error).</p>
</details>
</figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000042B5" id="P70004970270000000000000000042B5"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426C7" epub:type="title" id="P70004970270000000000000000426C7">Avoiding Data Hazards by Stalling</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426C8" id="P70004970270000000000000000426C8">One very general technique for avoiding hazards involves <i class="pcalibre17 pcalibre2 pcalibre1">stalling</i>, where the processor holds back one or more instructions in the pipeline until the hazard condition no longer holds. Our processor can avoid data hazards by holding back an instruction in the decode stage until the instructions generating its source operands have passed through the write-back stage. The details of this mechanism will be discussed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004435"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5.8</span></a>. It involves simple enhancements to the pipeline control logic. The effect of stalling is diagrammed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P70004970270000000000000000042C2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.47</span></a> (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426C9" id="P70004970270000000000000000426C9">prog2</code>) and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_001.xhtml#P70004970270000000000000000042CF"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.48</span></a> (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426CA" id="P70004970270000000000000000426CA">prog4</code>). (We omit <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426CB" id="P70004970270000000000000000426CB">prog3</code> from this discussion, since it operates similarly to the other two examples.) When the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426CC" id="P70004970270000000000000000426CC">addq</code> instruction is in the decode stage, the pipeline control logic detects that at least one of the instructions in the execute, memory, or write-back stage will update either register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426CD" id="P70004970270000000000000000426CD">%rdx</code> or register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426CE" id="P70004970270000000000000000426CE">%rax</code>. Rather than letting the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426CF" id="P70004970270000000000000000426CF">addq</code> instruction pass through the stage with the incorrect results, it stalls the instruction, holding it back in the decode stage for either one (for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426D0" id="P70004970270000000000000000426D0">prog2</code>) or three (for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426D1" id="P70004970270000000000000000426D1">prog4</code>) extra cycles. For all three programs, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000426D2" id="P70004970270000000000000000426D2">addq</code> instruction finally gets correct values for its two source operands in cycle 7 and then proceeds down the pipeline.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P70004970270000000000000000042C2" id="P70004970270000000000000000042C2">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000042C3" epub:type="pagebreak" id="P70004970270000000000000000042C3" title="434"></span><img alt="A diagram illustrates a pipelined execution of prog2 using stalls." class="pcalibre173 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B6F4" id="P70004970270000000000000000426D3" src="Images/chapter-04-image-36.png"/>
</figure>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>4.6 Summary </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000045BA"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042D04" epub:type="title" id="P7000497027000000000000000042D04"><span class="pcalibre1 pcalibre21 pcalibre2">4.6 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D05" id="P7000497027000000000000000042D05">We have seen that the instruction set architecture, or ISA, provides a layer of abstraction between the behavior of a processor—in terms of the set of instructions and their encodings—and how the processor is implemented. The ISA provides a very sequential view of program execution, with one instruction executed to completion before the next one begins.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000045BD" id="P70004970270000000000000000045BD"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000042D06" epub:type="title" id="P7000497027000000000000000042D06"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000045BF" epub:type="pagebreak" id="P70004970270000000000000000045BF" title="471"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>State-of-the-art microprocessor design</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042D07" id="P7000497027000000000000000042D07">A five-stage pipeline, such as we have shown with the PIPE processor, represented the state of the art in processor design in the mid-1980s. The prototype RISC processor developed by Patterson's research group at Berkeley formed the basis for the first SPARC processor, developed by Sun Microsystems in 1987. The processor developed by Hennessy's research group at Stanford was commercialized by MIPS Technologies (a company founded by Hennessy) in 1986. Both of these used five-stage pipelines. The Intel i486 processor also uses a five-stage pipeline, although with a different partitioning of responsibilities among the stages, with two decode stages and a combined execute/memory stage <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3D7">[27]</a>.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042D08" id="P7000497027000000000000000042D08">These pipelined designs are limited to a throughput of at most one instruction per clock cycle. The CPI (for "cycles per instruction") measure described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004544"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5.9</span></a> can never be less than 1.0. The different stages can only process one instruction at a time. More recent processors support <i class="pcalibre17 pcalibre2 pcalibre1">superscalar</i> operation, meaning that they can achieve a CPI less than 1.0 by fetching, decoding, and executing multiple instructions in parallel. As superscalar processors have become widespread, the accepted performance measure has shifted from CPI to its reciprocal—the average number of instructions executed per cycle, or IPC. It can exceed 1.0 for superscalar processors. The most advanced designs use a technique known as <i class="pcalibre17 pcalibre2 pcalibre1">out-of-order</i> execution to execute multiple instructions in parallel, possibly in a totally different order than they occur in the program, while preserving the overall behavior implied by the sequential ISA model. This form of execution is described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004893.xhtml#P7000497027000000000000000004893"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">5</span></a> as part of our discussion of program optimization.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter04.xhtml#P7000497027000000000000000042D09" id="P7000497027000000000000000042D09">Pipelined processors are not just historical artifacts, however. The majority of processors sold are used in embedded systems, controlling automotive functions, consumer products, and other devices where the processor is not directly visible to the system user. In these applications, the simplicity of a pipelined processor, such as the one we have explored in this chapter, reduces its cost and power requirements compared to higher-performance models.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D0A" id="P7000497027000000000000000042D0A">More recently, as multicore processors have gained a following, some have argued that we could get more overall computing power by integrating many simple processors on a single chip rather than a smaller number of more complex ones. This strategy is sometimes referred to as "many-core" processors <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3B4">[10]</a>.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D0B" id="P7000497027000000000000000042D0B">We defined the Y86-64 instruction set by starting with the x86-64 instructions and simplifying the data types, address modes, and instruction encoding considerably. The resulting ISA has attributes of both RISC and CISC instruction sets. We then organized the processing required for the different instructions into a series of five stages, where the operations at each stage vary according to the instruction being executed. From this, we constructed the SEQ processor, in which an entire instruction is executed every clock cycle by having it flow through all five stages.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D0C" id="P7000497027000000000000000042D0C">Pipelining improves the throughput performance of a system by letting the different stages operate concurrently. At any given time, multiple operations are being processed by the different stages. In introducing this concurrency, we must be careful to provide the same program-level behavior as would a sequential execution of the program. We introduced pipelining by reordering parts of SEQ to get SEQ+ and then adding pipeline registers to create the PIPE— pipeline.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter04.xhtml#P70004970270000000000000000045C6" id="P70004970270000000000000000045C6"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter04.xhtml#P7000497027000000000000000042D0D" epub:type="title" id="P7000497027000000000000000042D0D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000045C8" epub:type="pagebreak" id="P70004970270000000000000000045C8" title="472"></span><span class="pcalibre1 pcalibre2 pcalibre34">Web Aside ARCH:HCL </span>HCL descriptions of Y86-64 processors</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D0E" id="P7000497027000000000000000042D0E">In this chapter, we have looked at portions of the HCL code for several simple logic designs and for the control logic for Y86-64 processors SEQ and PIPE. For reference, we provide documentation of the HCL language and complete HCL descriptions for the control logic of the two processors. Each of these descriptions requires only five to seven pages of HCL code, and it is worthwhile to study them in their entirety.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D0F" id="P7000497027000000000000000042D0F">We enhanced the pipeline performance by adding forwarding logic to speed the sending of a result from one instruction to another. Several special cases require additional pipeline control logic to stall or cancel some of the pipeline stages.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D10" id="P7000497027000000000000000042D10">Our design included rudimentary mechanisms to handle exceptions, where we make sure that only instructions up to the excepting instruction affect the programmer-visible state. Implementing a complete handling of exceptions would be significantly more challenging. Properly handling exceptions gets even more complex in systems that employ greater degrees of pipelining and parallelism.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D11" id="P7000497027000000000000000042D11">In this chapter, we have learned several important lessons about processor design:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D12" id="P7000497027000000000000000042D12">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D13" id="P7000497027000000000000000042D13"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D14" id="P7000497027000000000000000042D14"><span class="pcalibre1 pcalibre2 pcalibre41">Managing complexity is a top priority. </span>We want to make optimum use of the hardware resources to get maximum performance at minimum cost. We did this by creating a very simple and uniform framework for processing all of the different instruction types. With this framework, we could share the hardware units among the logic for processing the different instruction types.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D15" id="P7000497027000000000000000042D15"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D16" id="P7000497027000000000000000042D16"><span class="pcalibre1 pcalibre2 pcalibre41">We do not need to implement the ISA directly. </span>A direct implementation of the ISA would imply a very sequential design. To achieve higher performance, we want to exploit the ability in hardware to perform many operations simultaneously. This led to the use of a pipelined design. By careful design and analysis, we can handle the various pipeline hazards, so that the overall effect of running a program exactly matches what would be obtained with the ISA model.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D17" id="P7000497027000000000000000042D17"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D18" id="P7000497027000000000000000042D18"><span class="pcalibre1 pcalibre2 pcalibre41">Hardware designers must be meticulous. </span>Once a chip has been fabricated, it is nearly impossible to correct any errors. It is very important to get the design right on the first try. This means carefully analyzing different instruction types and combinations, even ones that do not seem to make sense, such as popping to the stack pointer. Designs must be thoroughly tested with systematic simulation test programs. In developing the control logic for PIPE, our design had a subtle bug that was uncovered only after a careful and systematic analysis of control combinations.</p></li>
</ul>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000045D4" id="P70004970270000000000000000045D4"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D19" epub:type="title" id="P7000497027000000000000000042D19"><span class="pcalibre1 pcalibre21 pcalibre2">4.6.1 </span>Y86-64 Simulators</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D1A" id="P7000497027000000000000000042D1A">The lab materials for this chapter include simulators for the SEQ and PIPE processors. Each simulator has two versions:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D1B" id="P7000497027000000000000000042D1B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D1C" id="P7000497027000000000000000042D1C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D1D" id="P7000497027000000000000000042D1D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000045DA" epub:type="pagebreak" id="P70004970270000000000000000045DA" title="473"></span>The GUI (graphic user interface) version displays the memory, program code, and processor state in graphic windows. This provides a way to readily see how the instructions flow through the processors. The control panel also allows you to reset, single-step, or run the simulator interactively.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D1E" id="P7000497027000000000000000042D1E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D1F" id="P7000497027000000000000000042D1F">The text version runs the same simulator, but it only displays information by printing to the terminal. This version is not as useful for debugging, but it allows automated testing of the processor.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D20" id="P7000497027000000000000000042D20">The control logic for the simulators is generated by translating the HCL declarations of the logic blocks into C code. This code is then compiled and linked with the rest of the simulation code. This combination makes it possible for you to test out variants of the original designs using the simulators. Testing scripts are also available that thoroughly exercise the different instructions and the different hazard possibilities.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Bibliographic Notes </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre83 pcalibre2" epub:type="bibliography" id="P70004970270000000000000000045DE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 title" data-uri="chapter04.xhtml#P7000497027000000000000000042D21" epub:type="title" id="P7000497027000000000000000042D21"><span class="pcalibre1 pcalibre21 pcalibre2">Bibliographic Notes </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D22" id="P7000497027000000000000000042D22">For those interested in learning more about logic design, the Katz and Borriello logic design textbook <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B416">[58]</a> is a standard introductory text, emphasizing the use of hardware description languages. Hennessy and Patterson's computer architecture textbook <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3FE">[46]</a> provides extensive coverage of processor design, including both simple pipelines, such as the one we have presented here, and advanced processors that execute more instructions in parallel. Shriver and Smith <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B46E">[101]</a> give a very thorough presentation of an Intel-compatible x86-64 processor manufactured by AMD.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Homework Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="practice" id="P70004970270000000000000000045E1"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042D23" epub:type="title" id="P7000497027000000000000000042D23"><span class="pcalibre1 pcalibre21 pcalibre2">Homework Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000045E3" id="P70004970270000000000000000045E3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D24" epub:type="title" id="P7000497027000000000000000042D24">4.45 </h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042D25" id="P7000497027000000000000000042D25"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D26" id="P7000497027000000000000000042D26">In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001FFB"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.4.2</span></a>, the x86-64 <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D27" id="P7000497027000000000000000042D27">pushq</code> instruction was described as decrementing the stack pointer and then storing the register at the stack pointer location. So, if we had an instruction of the form <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D28" id="P7000497027000000000000000042D28">pushq</code> <i class="pcalibre17 pcalibre2 pcalibre1">REG</i>, for some register <i class="pcalibre17 pcalibre2 pcalibre1">REG</i>, it would be equivalent to the code sequence</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D29" id="P7000497027000000000000000042D29"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D2A" id="P7000497027000000000000000042D2A">subq $8,%rsp		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Decrement stack pointer</i></b>
movq <i class="pcalibre17 pcalibre2 pcalibre1">REG</i>, (%rsp)	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Store REG on stack</i></b>
</code></pre></div>
<ol class="pcalibre1 pcalibre2 pcalibre128" data-uri="chapter04.xhtml#P7000497027000000000000000042D2B" id="P7000497027000000000000000042D2B">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000042D2C" id="P7000497027000000000000000042D2C">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042D2D" id="P7000497027000000000000000042D2D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D2E" id="P7000497027000000000000000042D2E">In light of analysis done in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C54"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.7</span></a>, does this code sequence correctly describe the behavior of the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D2F" id="P7000497027000000000000000042D2F">pushq</code> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D30" id="P7000497027000000000000000042D30">%rsp</code>? Explain.</p></div></li>
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter04.xhtml#P7000497027000000000000000042D31" id="P7000497027000000000000000042D31">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042D32" id="P7000497027000000000000000042D32"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D33" id="P7000497027000000000000000042D33">How could you rewrite the code sequence so that it correctly describes both the cases where <i class="pcalibre17 pcalibre2 pcalibre1">REG</i> is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D34" id="P7000497027000000000000000042D34">%rsp</code> as well as any other register?</p></div></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000045F2" id="P70004970270000000000000000045F2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D35" epub:type="title" id="P7000497027000000000000000042D35">4.46 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D36" id="P7000497027000000000000000042D36">In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001FFB"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.4.2</span></a>, the x86-64 <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D37" id="P7000497027000000000000000042D37">popq</code> instruction was described as copying the result from the top of the stack to the destination register and then incrementing the stack pointer. So, if we had an instruction of the form <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D38" id="P7000497027000000000000000042D38">popq</code> <i class="pcalibre17 pcalibre2 pcalibre1">REG</i>, it would be equivalent to the code sequence</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D39" id="P7000497027000000000000000042D39"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000045F8" epub:type="pagebreak" id="P70004970270000000000000000045F8" title="474"></span></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D3A" id="P7000497027000000000000000042D3A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D3B" id="P7000497027000000000000000042D3B">movq (%rsp), REG	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Read REG from stack</i></b>
addq $8,%rsp		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Increment stack pointer</i></b>
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter04.xhtml#P7000497027000000000000000042D3C" id="P7000497027000000000000000042D3C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D3D" id="P7000497027000000000000000042D3D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D3E" id="P7000497027000000000000000042D3E">In light of analysis done in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C64"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.8</span></a>, does this code sequence correctly describe the behavior of the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D3F" id="P7000497027000000000000000042D3F">popq</code> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D40" id="P7000497027000000000000000042D40">%rsp</code>? Explain.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D41" id="P7000497027000000000000000042D41"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D42" id="P7000497027000000000000000042D42">How could you rewrite the code sequence so that it correctly describes both the cases where <i class="pcalibre17 pcalibre2 pcalibre1">REG</i> is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D43" id="P7000497027000000000000000042D43">%rsp</code> as well as any other register?</p></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004603" id="P7000497027000000000000000004603"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D44" epub:type="title" id="P7000497027000000000000000042D44">4.47 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D45" id="P7000497027000000000000000042D45">Your assignment will be to write a Y86-64 program to perform bubblesort. For reference, the following C function implements bubblesort using array referencing:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D46" id="P7000497027000000000000000042D46"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D47" id="P7000497027000000000000000042D47">1	/* Bubble sort: Array version */
2	void bubble_a(long *data, long count) {
3	    long i, last ;
4	    for (last = count-1; last &gt; 0; last--) {
5	        for (i = 0; i &lt; last; i++)
6	            if (data[i+1] &lt; data[i]) {
7	                /* Swap adjacent elements */
8	                long t = data[i+1];
9	                data[i+1] = data[i];
10	                data[i] = t;
11	            }
12	       }
13	}
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter04.xhtml#P7000497027000000000000000042D48" id="P7000497027000000000000000042D48">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D49" id="P7000497027000000000000000042D49"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D4A" id="P7000497027000000000000000042D4A">Write and test a C version that references the array elements with pointers, rather than using array indexing.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D4B" id="P7000497027000000000000000042D4B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D4C" id="P7000497027000000000000000042D4C">Write and test a Y86-64 program consisting of the function and test code. You may find it useful to pattern your implementation after x86-64 code generated by compiling your C code. Although pointer comparisons are normally done using unsigned arithmetic, you can use signed arithmetic for this exercise.</p></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000460D" id="P700049702700000000000000000460D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D4D" epub:type="title" id="P7000497027000000000000000042D4D">4.48 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D4E" id="P7000497027000000000000000042D4E">Modify the code you wrote for <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004603"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.47</span></a> to implement the test and swap in the bubblesort function (lines 6-11) using no jumps and at most three conditional moves.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004610" id="P7000497027000000000000000004610"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D4F" epub:type="title" id="P7000497027000000000000000042D4F">4.49 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D50" id="P7000497027000000000000000042D50">Modify the code you wrote for <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004603"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.47</span></a> to implement the test and swap in the bubblesort function (lines 6-11) using no jumps and just one conditional move.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004613" id="P7000497027000000000000000004613"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D51" epub:type="title" id="P7000497027000000000000000042D51">4.50 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D52" id="P7000497027000000000000000042D52">In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002799"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6.8</span></a>, we saw that a common way to implement <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D53" id="P7000497027000000000000000042D53">switch</code> statements is to create a set of code blocks and then index those blocks using a jump table. Consider</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004617" id="P7000497027000000000000000004617">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D54" id="P7000497027000000000000000042D54"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D55" id="P7000497027000000000000000042D55"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter04.xhtml#P700049702700000000000000000461A" epub:type="pagebreak" id="P700049702700000000000000000461A" title="475"></span>#include &lt;stdio.h&gt;
/* Example use of switch statement */
long switchv(long idx) {
	long result = 0;
	switch(idx) {
	case 0:
		result = 0xaaa;
		break;
	case 2:
	case 5:
		result = 0xbbb;
		break;
	case 3:
		result = 0xccc;
		break;
	default :
		result = 0xddd;
	}
	return result;
}
/* Testing Code */
#define CNT 8
#define MINVAL -1

int main() {
	long vais [CNT];
	long i;
	for (i = 0; i &lt; CNT; i++) {
		vals[i] = switchv(i + MINVAL);
		printf ("idx = %ld, val = 0x%lx\n", i + MINVAL, vais [i] );
	}
	return 0;
}
</code>
</pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042D56" id="P7000497027000000000000000042D56"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042D57" epub:type="title" id="P7000497027000000000000000042D57"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.69 </span>Switch statements can be translated into Y86-64 code.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D58" id="P7000497027000000000000000042D58"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D59" id="P7000497027000000000000000042D59"> This requires implementation of a jump table.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D5A" id="P7000497027000000000000000042D5A">
</p></div>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D5B" id="P7000497027000000000000000042D5B">the C code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004617"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.69</span></a> for a function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D5C" id="P7000497027000000000000000042D5C">switchv</code>, along with associated test code.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D5D" id="P7000497027000000000000000042D5D">Implement <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D5E" id="P7000497027000000000000000042D5E">switchv</code> in Y86-64 using a jump table. Although the Y86-64 instruction set does not include an indirect jump instruction, you can get the same effect by pushing a computed address onto the stack and then executing the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D5F" id="P7000497027000000000000000042D5F">ret</code> <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004624" epub:type="pagebreak" id="P7000497027000000000000000004624" title="476"></span>instruction. Implement test code similar to what is shown in C to demonstrate that your implementation of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D60" id="P7000497027000000000000000042D60">switchv</code> will handle both the cases handled explicitly as well as those that trigger the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D61" id="P7000497027000000000000000042D61">default</code> case.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004627" id="P7000497027000000000000000004627"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D62" epub:type="title" id="P7000497027000000000000000042D62">4.51 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D63" id="P7000497027000000000000000042D63"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C23"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3</span></a> introduced the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D64" id="P7000497027000000000000000042D64">iaddq</code> instruction to add immediate data to a register. Describe the computations performed to implement this instruction. Use the computations for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D65" id="P7000497027000000000000000042D65">irmovq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D66" id="P7000497027000000000000000042D66">OPq</code> (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D82"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18</span></a>) as a guide.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000462D" id="P700049702700000000000000000462D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D67" epub:type="title" id="P7000497027000000000000000042D67">4.52 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D68" id="P7000497027000000000000000042D68">The file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D69" id="P7000497027000000000000000042D69">seq-full.hcl</code> contains the HCL description for SEQ, along with the declaration of a constant <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D6A" id="P7000497027000000000000000042D6A">IIADDQ</code> having hexadecimal value C, the instruction code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D6B" id="P7000497027000000000000000042D6B">iaddq</code>. Modify the HCL descriptions of the control logic blocks to implement the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D6C" id="P7000497027000000000000000042D6C">iaddq</code> instruction, as described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C23"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004627"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.51</span></a>. See the lab material for directions on how to generate a simulator for your solution and how to test it.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004634" id="P7000497027000000000000000004634"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D6D" epub:type="title" id="P7000497027000000000000000042D6D">4.53 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D6E" id="P7000497027000000000000000042D6E">Suppose we wanted to create a lower-cost pipelined processor based on the structure we devised for PIPE— (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_000.xhtml#P7000497027000000000000000004210"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.41</span></a>), without any bypassing. This design would handle all data dependencies by stalling until the instruction generating a needed value has passed through the write-back stage.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D6F" id="P7000497027000000000000000042D6F">The file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D70" id="P7000497027000000000000000042D70">pipe-stall.hcl</code> contains a modified version of the HCL code for PIPE in which the bypassing logic has been disabled. That is, the signals <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D71" id="P7000497027000000000000000042D71">e_valA</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D72" id="P7000497027000000000000000042D72">e_valB</code> are simply declared as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D73" id="P7000497027000000000000000042D73"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D74" id="P7000497027000000000000000042D74">## DO NOT MODIFY THE FOLLOWING CODE.
## No forwarding. valA is either valP or value from register file
word d_valA = [
	D_icode in { ICALL, IJXX } : D_valP; # Use incremented PC
	1 : d_rvalA; # Use value read from register file
];
## No forwarding. valB is value from register file
word d_valB = d_rvalB;
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D75" id="P7000497027000000000000000042D75">Modify the pipeline control logic at the end of this file so that it correctly handles all possible control and data hazards. As part of your design effort, you should analyze the different combinations of control cases, as we did in the design of the pipeline control logic for PIPE. You will find that many different combinations can occur, since many more conditions require the pipeline to stall. Make sure your control logic handles each combination correctly. See the lab material for directions on how to generate a simulator for your solution and how to test it.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000463E" id="P700049702700000000000000000463E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D76" epub:type="title" id="P7000497027000000000000000042D76">4.54 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D77" id="P7000497027000000000000000042D77">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D78" id="P7000497027000000000000000042D78">file pipe-full.hcl</code> contains a copy of the PIPE HCL description, along with a declaration of the constant value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D79" id="P7000497027000000000000000042D79">IIADDQ</code>. Modify this file to implement the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D7A" id="P7000497027000000000000000042D7A">iaddq</code> instruction, as described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C23"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004627"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.51</span></a>. See the lab <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004644" epub:type="pagebreak" id="P7000497027000000000000000004644" title="477"></span>material for directions on how to generate a simulator for your solution and how to test it.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004645" id="P7000497027000000000000000004645"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D7B" epub:type="title" id="P7000497027000000000000000042D7B">4.55 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D7C" id="P7000497027000000000000000042D7C">The file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D7D" id="P7000497027000000000000000042D7D">pipe-nt.hcl</code> contains a copy of the HCL code for PIPE, plus a declaration of the constant <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D7E" id="P7000497027000000000000000042D7E">J_YES</code> with value 0, the function code for an unconditional jump instruction. Modify the branch prediction logic so that it predicts conditional jumps as being not taken while continuing to predict unconditional jumps and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D7F" id="P7000497027000000000000000042D7F">call</code> as being taken. You will need to devise a way to get valC, the jump target address, to pipeline register M to recover from mispredicted branches. See the lab material for directions on how to generate a simulator for your solution and how to test it.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000464B" id="P700049702700000000000000000464B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D80" epub:type="title" id="P7000497027000000000000000042D80">4.56 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D81" id="P7000497027000000000000000042D81">The file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D82" id="P7000497027000000000000000042D82">pipe-btfnt.hcl</code> contains a copy of the HCL code for PIPE, plus a declaration of the constant <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D83" id="P7000497027000000000000000042D83">J_YES</code> with value 0, the function code for an unconditional jump instruction. Modify the branch prediction logic so that it predicts conditional jumps as being taken when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D84" id="P7000497027000000000000000042D84">valC &lt; valP</code> (backward branch) and as being not taken when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D85" id="P7000497027000000000000000042D85">valC ≥ valP</code> (forward branch). (Since Y86-64 does not support unsigned arithmetic, you should implement this test using a signed comparison.) Continue to predict unconditional jumps and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D86" id="P7000497027000000000000000042D86">call</code> as being taken. You will need to devise a way to get both <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D87" id="P7000497027000000000000000042D87">valC</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D88" id="P7000497027000000000000000042D88">vaIP</code> to pipeline register M to recover from mispredicted branches. See the lab material for directions on how to generate a simulator for your solution and how to test it.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004655" id="P7000497027000000000000000004655"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D89" epub:type="title" id="P7000497027000000000000000042D89">4.57 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D8A" id="P7000497027000000000000000042D8A">In our design of PIPE, we generate a stall whenever one instruction performs a <i class="pcalibre17 pcalibre2 pcalibre1">load</i>, reading a value from memory into a register, and the next instruction has this register as a source operand. When the source gets used in the execute stage, this stalling is the only way to avoid a hazard. For cases where the second instruction stores the source operand to memory, such as with an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D8B" id="P7000497027000000000000000042D8B">rmmovq</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D8C" id="P7000497027000000000000000042D8C">pushq</code> instruction, this stalling is not necessary. Consider the following code examples:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042D8D" id="P7000497027000000000000000042D8D">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D8E" id="P7000497027000000000000000042D8E">1	mrmovq 0(%rcx),%rdx	# Load 1
2	pushq %rdx		# Store 1
3	nop
4	popq %rdx		# Load 2
5	rmmovq %rax,0(%rdx)	# Store 2
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D8F" id="P7000497027000000000000000042D8F">In lines 1 and 2, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D90" id="P7000497027000000000000000042D90">mrmovq</code> instruction reads a value from memory into <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D91" id="P7000497027000000000000000042D91">%rdx</code>, and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D92" id="P7000497027000000000000000042D92">pushq</code> instruction then pushes this value onto the stack. Our design for PIPE would stall the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D93" id="P7000497027000000000000000042D93">pushq</code> instruction to avoid a load/use hazard. Observe, however, that the value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D94" id="P7000497027000000000000000042D94">%rdx</code> is not required by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D95" id="P7000497027000000000000000042D95">pushq</code> instruction until it reaches the memory stage. We can add an additional bypass path, as diagrammed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004665"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.70</span></a>, to forward the memory output (signal m_valM) to the valA field in pipeline register M. On the next clock cycle, this forwarded value can then be written to memory. This technique is known as <i class="pcalibre17 pcalibre2 pcalibre1">load forwarding.</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D96" id="P7000497027000000000000000042D96">Note that the second example (lines 4 and 5) in the code sequence above cannot make use of load forwarding. The value loaded by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D97" id="P7000497027000000000000000042D97">popq</code> instruction is</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004665" id="P7000497027000000000000000004665">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004666" epub:type="pagebreak" id="P7000497027000000000000000004666" title="478"></span><img alt="A diagram shows a structure with execute and memory stages capable of load forwarding." class="pcalibre1 pcalibre2 pcalibre187" data-uri="P700049702700000000000000000B709" id="P7000497027000000000000000042D98" src="Images/chapter-04-image-37.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042D99" id="P7000497027000000000000000042D99"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042D9A" epub:type="title" id="P7000497027000000000000000042D9A"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">4.70 </span>Execute and memory stages capable of load forwarding.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042D9B" id="P7000497027000000000000000042D9B"><p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D9C" id="P7000497027000000000000000042D9C"> By adding a bypass path from the memory output to the source of valA in pipeline register M, we can use forwarding rather than stalling for one form of load/use hazard. This is the subject of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004655"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">4.57</span></a>.</p><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042D9D" id="P7000497027000000000000000042D9D">
</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P7000497027000000000000000023075" id="P7000497027000000000000000023075">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042D9E" id="P7000497027000000000000000042D9E">A diagram shows pipelines E, M, and W, as summarized from bottom to top, left to right, below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P7000497027000000000000000042D9F" id="P7000497027000000000000000042D9F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DA0" id="P7000497027000000000000000042DA0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DA1" id="P7000497027000000000000000042DA1">E:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000042DA2" id="P7000497027000000000000000042DA2">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DA3" id="P7000497027000000000000000042DA3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DA4" id="P7000497027000000000000000042DA4">Stat to stat in M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DA5" id="P7000497027000000000000000042DA5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DA6" id="P7000497027000000000000000042DA6">Icode to:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DA7" id="P7000497027000000000000000042DA7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DA8" id="P7000497027000000000000000042DA8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DA9" id="P7000497027000000000000000042DA9">Icode in M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DAA" id="P7000497027000000000000000042DAA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DAB" id="P7000497027000000000000000042DAB">Set CC, with input from W_stat and m_stat, with output to CC, which has input from ALU, which receives input from ALU A, ALU B, and ALU fun</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DAC" id="P7000497027000000000000000042DAC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DAD" id="P7000497027000000000000000042DAD">ALU A</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DAE" id="P7000497027000000000000000042DAE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DAF" id="P7000497027000000000000000042DAF">ALU B</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DB0" id="P7000497027000000000000000042DB0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DB1" id="P7000497027000000000000000042DB1">ALU fun.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DB2" id="P7000497027000000000000000042DB2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DB3" id="P7000497027000000000000000042DB3">Cond., which has input from CC and output e_Cnd to dstE and to Cnd in M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DB4" id="P7000497027000000000000000042DB4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DB5" id="P7000497027000000000000000042DB5">E_icode to Fwd A, which sends output to valA in M</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DB6" id="P7000497027000000000000000042DB6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DB7" id="P7000497027000000000000000042DB7">Ifun, to ALU fun. and to cond.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DB8" id="P7000497027000000000000000042DB8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DB9" id="P7000497027000000000000000042DB9">valC, ALU A</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DBA" id="P7000497027000000000000000042DBA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DBB" id="P7000497027000000000000000042DBB">valA, to ALU A and Fwd A</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DBC" id="P7000497027000000000000000042DBC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DBD" id="P7000497027000000000000000042DBD">valB, to ALU B</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DBE" id="P7000497027000000000000000042DBE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DBF" id="P7000497027000000000000000042DBF">dstE, to dstE, which sends input to dstE in M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DC0" id="P7000497027000000000000000042DC0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DC1" id="P7000497027000000000000000042DC1">dstM to dstM in M</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DC2" id="P7000497027000000000000000042DC2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DC3" id="P7000497027000000000000000042DC3">srcA, with output E_srcA to Fwd A</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DC4" id="P7000497027000000000000000042DC4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DC5" id="P7000497027000000000000000042DC5">srcB</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DC6" id="P7000497027000000000000000042DC6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DC7" id="P7000497027000000000000000042DC7">M:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000042DC8" id="P7000497027000000000000000042DC8">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DC9" id="P7000497027000000000000000042DC9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DCA" id="P7000497027000000000000000042DCA">Sta, to Stat, which has output to stat in W and input dmem_error from data memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DCB" id="P7000497027000000000000000042DCB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DCC" id="P7000497027000000000000000042DCC">Icode to:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DCD" id="P7000497027000000000000000042DCD">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DCE" id="P7000497027000000000000000042DCE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DCF" id="P7000497027000000000000000042DCF">Icode in in W</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DD0" id="P7000497027000000000000000042DD0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DD1" id="P7000497027000000000000000042DD1">Mem read.,which sends output read to Data memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DD2" id="P7000497027000000000000000042DD2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DD3" id="P7000497027000000000000000042DD3">Mem. Write, which sends output write to Data memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DD4" id="P7000497027000000000000000042DD4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DD5" id="P7000497027000000000000000042DD5">Addr, which sends output to Data memory</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DD6" id="P7000497027000000000000000042DD6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DD7" id="P7000497027000000000000000042DD7">Cnd</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DD8" id="P7000497027000000000000000042DD8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DD9" id="P7000497027000000000000000042DD9">valE, to valE in W and Addrs</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DDA" id="P7000497027000000000000000042DDA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DDB" id="P7000497027000000000000000042DDB">valA: input to Addr and input data in to Data memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DDC" id="P7000497027000000000000000042DDC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DDD" id="P7000497027000000000000000042DDD">dstE to dstE in W</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DDE" id="P7000497027000000000000000042DDE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DDF" id="P7000497027000000000000000042DDF">dstM: output to dstM in W, and output M_dstM to Fwd A</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DE0" id="P7000497027000000000000000042DE0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DE1" id="P7000497027000000000000000042DE1">W:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter04.xhtml#P7000497027000000000000000042DE2" id="P7000497027000000000000000042DE2">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DE3" id="P7000497027000000000000000042DE3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DE4" id="P7000497027000000000000000042DE4">Stat</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DE5" id="P7000497027000000000000000042DE5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DE6" id="P7000497027000000000000000042DE6">Icode</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DE7" id="P7000497027000000000000000042DE7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DE8" id="P7000497027000000000000000042DE8">valE</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DE9" id="P7000497027000000000000000042DE9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DEA" id="P7000497027000000000000000042DEA">valM, with input from Data memory, which sends data out as m_valM to Fwd A</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DEB" id="P7000497027000000000000000042DEB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DEC" id="P7000497027000000000000000042DEC">dstE</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DED" id="P7000497027000000000000000042DED"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DEE" id="P7000497027000000000000000042DEE">dstM</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DEF" id="P7000497027000000000000000042DEF">used as part of the address computation by the next instruction, and this value is required in the execute stage rather than the memory stage.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter04.xhtml#P7000497027000000000000000042DF0" id="P7000497027000000000000000042DF0">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DF1" id="P7000497027000000000000000042DF1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DF2" id="P7000497027000000000000000042DF2">Write a logic formula describing the detection condition for a load/use hazard, similar to the one given in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004474"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.64</span></a>, except that it will not cause a stall in cases where load forwarding can be used.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042DF3" id="P7000497027000000000000000042DF3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042DF4" id="P7000497027000000000000000042DF4">The file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DF5" id="P7000497027000000000000000042DF5">pipe-lf.hcl</code> contains a modified version of the control logic for PIPE. It contains the definition of a signal <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DF6" id="P7000497027000000000000000042DF6">e_valA</code> to implement the block labeled "Fwd A" in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004665"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.70</span></a>. It also has the conditions for a load/use hazard in the pipeline control logic set to zero, and so the pipeline control logic will not detect any forms of load/use hazards. Modify this HCL description to implement load forwarding. See the lab material for directions on how to generate a simulator for your solution and how to test it.</p></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004674" id="P7000497027000000000000000004674"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DF7" epub:type="title" id="P7000497027000000000000000042DF7"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004676" epub:type="pagebreak" id="P7000497027000000000000000004676" title="479"></span>4.58 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DF8" id="P7000497027000000000000000042DF8">Our pipelined design is a bit unrealistic in that we have two write ports for the register file, but only the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DF9" id="P7000497027000000000000000042DF9">popq</code> instruction requires two simultaneous writes to the register file. The other instructions could therefore use a single write port, sharing this for writing <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DFA" id="P7000497027000000000000000042DFA">valE</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DFB" id="P7000497027000000000000000042DFB">valM</code>. The following figure shows a modified version of the write-back logic, in which we merge the write-back register IDs (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DFC" id="P7000497027000000000000000042DFC">W_dstE</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DFD" id="P7000497027000000000000000042DFD">W_dstM</code>) into a single signal <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DFE" id="P7000497027000000000000000042DFE">w_dstE</code> and the write-back values (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042DFF" id="P7000497027000000000000000042DFF">W_valE</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E00" id="P7000497027000000000000000042E00">W_valM</code>) into a single signal <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E01" id="P7000497027000000000000000042E01">w_valE</code>:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004681" id="P7000497027000000000000000004681">
<img alt="A diagram illustrates outputs of pipeline W." class="pcalibre1 pcalibre2 pcalibre188" data-uri="P700049702700000000000000000B70A" id="P7000497027000000000000000042E02" src="Images/chapter-04-image-38.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042E03" id="P7000497027000000000000000042E03">
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P70004970270000000000000000230DC" id="P70004970270000000000000000230DC">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E04" id="P7000497027000000000000000042E04">A diagram shows outputs of pipeline W, as summarized from left to right below:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E05" id="P7000497027000000000000000042E05">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E06" id="P7000497027000000000000000042E06"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E07" id="P7000497027000000000000000042E07">stat: output Stat</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E08" id="P7000497027000000000000000042E08"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E09" id="P7000497027000000000000000042E09">icode: output W_icode</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E0A" id="P7000497027000000000000000042E0A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E0B" id="P7000497027000000000000000042E0B">ValE and ValM: outputs to ValE, which has input from dstM and output w_ValE</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E0C" id="P7000497027000000000000000042E0C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E0D" id="P7000497027000000000000000042E0D">dstE and dstM: outputs to dstE, which has output w_dstE</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E0E" id="P7000497027000000000000000042E0E">The logic for performing the merges is written in HCL as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E0F" id="P7000497027000000000000000042E0F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E10" id="P7000497027000000000000000042E10">## Set E port register ID
word w_dstE = [
	  ## writing from valM
	  W_dstM != RNONE : W_dstM;
	  1: W_dstE;
];

## Set E port value
word w_valE = [
	  W_dstM != RNONE : W_valM;
	  1: W_valE;
];
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E11" id="P7000497027000000000000000042E11">The control for these multiplexors is determined by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E12" id="P7000497027000000000000000042E12">dstE</code>—when it indicates there is some register, then it selects the value for port E, and otherwise it selects the value for port M.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E13" id="P7000497027000000000000000042E13">In the simulation model, we can then disable register port M, as shown by the following HCL code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E14" id="P7000497027000000000000000042E14"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E15" id="P7000497027000000000000000042E15">## Disable register port M
## Set M port register ID
word w_dstM = RNONE;

## Set M port value
word w_valM = 0;
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E16" id="P7000497027000000000000000042E16">The challenge then becomes to devise a way to handle <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E17" id="P7000497027000000000000000042E17">popq</code>. One method is to use the control logic to dynamically process the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E18" id="P7000497027000000000000000042E18">popq</code> rA so that it has the same effect as the two-instruction sequence</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E19" id="P7000497027000000000000000042E19"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E1A" id="P7000497027000000000000000042E1A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004690" epub:type="pagebreak" id="P7000497027000000000000000004690" title="480"></span>iaddq $8, %rsp
mrmovq -8(%rsp), rA
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E1B" id="P7000497027000000000000000042E1B">(See <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C23"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3</span></a> for a description of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E1C" id="P7000497027000000000000000042E1C">iaddq</code> instruction.) Note the ordering of the two instructions to make sure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E1D" id="P7000497027000000000000000042E1D">popq</code> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E1E" id="P7000497027000000000000000042E1E">%rsp</code> works properly. You can do this by having the logic in the decode stage treat <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E1F" id="P7000497027000000000000000042E1F">popq</code> the same as it would the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E20" id="P7000497027000000000000000042E20">iaddq</code> listed above, except that it predicts the next PC to be equal to the current PC. On the next cycle, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E21" id="P7000497027000000000000000042E21">popq</code> instruction is refetched, but the instruction code is converted to a special value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E22" id="P7000497027000000000000000042E22">IP0P2</code>. This is treated as a special instruction that has the same behavior as the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E23" id="P7000497027000000000000000042E23">mrmovq</code> instruction listed above.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E24" id="P7000497027000000000000000042E24">The file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E25" id="P7000497027000000000000000042E25">pipe-lw.hcl</code> contains the modified write port logic described above. It contains a declaration of the constant <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E26" id="P7000497027000000000000000042E26">IP0P2</code> having hexadecimal value E. It also contains the definition of a signal f_icode that generates the icode field for pipeline register D. This definition can be modified to insert the instruction code <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E27" id="P7000497027000000000000000042E27">IP0P2</code> the second time the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E28" id="P7000497027000000000000000042E28">popq</code> instruction is fetched. The HCL file also contains a declaration of the signal f_pc, the value of the program counter generated in the fetch stage by the block labeled "Select PC" (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_001.xhtml#P70004970270000000000000000043B4"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.57</span></a>).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E29" id="P7000497027000000000000000042E29">Modify the control logic in this file to process <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E2A" id="P7000497027000000000000000042E2A">popq</code> instructions in the manner we have described. See the lab material for directions on how to generate a simulator for your solution and how to test it.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000046A1" id="P70004970270000000000000000046A1"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E2B" epub:type="title" id="P7000497027000000000000000042E2B">4.59 </h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E2C" id="P7000497027000000000000000042E2C">Compare the performance of the three versions of bubblesort (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004603"><span class="pcalibre1 pcalibre21 pcalibre2">Problems </span><span class="pcalibre1 pcalibre21 pcalibre2">4.47</span></a>, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000460D"><span class="pcalibre1 pcalibre21 pcalibre2">4.48</span></a>, and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004610"><span class="pcalibre1 pcalibre21 pcalibre2">4.49</span></a>). Explain why one version performs better than the other.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Solutions to Practice Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000046A4"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042E2D" epub:type="title" id="P7000497027000000000000000042E2D"><span class="pcalibre1 pcalibre21 pcalibre2">Solutions to Practice Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000046A6" id="P70004970270000000000000000046A6"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E2E" epub:type="title" id="P7000497027000000000000000042E2E"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003B7A"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.1 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003B77">360</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E2F" id="P7000497027000000000000000042E2F">Encoding instructions by hand is rather tedious, but it will solidify your understanding of the idea that assembly code gets turned into byte sequences by the assembler. In the following output from our Y86-64 assembler, each line shows an address and a byte sequence that starts at that address:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E30" id="P7000497027000000000000000042E30">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E31" id="P7000497027000000000000000042E31">1	0x100:				| .pos 0x100 # Start code at address 0x100
2	0x100: 30f30f00000000000000	|	irmovq $15,%rbx
3	0x10a: 2031			|	rrmovq %rbx,%rcx
4	0x10c:				| loop:
5	0x10c: 4013fdffffffffffffff	|	rmmovq %rcx,-3(%rbx)
6	0x116: 6031			|	addq %rbx,%rcx
7	0x118: 700c01000000000000	|	jmp loop
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E32" id="P7000497027000000000000000042E32">Several features of this encoding are worth noting:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E33" id="P7000497027000000000000000042E33">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E34" id="P7000497027000000000000000042E34"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E35" id="P7000497027000000000000000042E35">Decimal 15 (line 2) has hex representation <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E36" id="P7000497027000000000000000042E36">0x000000000000000f</code>. Writing the bytes in reverse order gives <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E37" id="P7000497027000000000000000042E37">Of 00 00 00 00 00 00 00</code>.</p>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E38" id="P7000497027000000000000000042E38"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E39" id="P7000497027000000000000000042E39"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000046B3" epub:type="pagebreak" id="P70004970270000000000000000046B3" title="481"></span>Decimal -3 (line 5) has hex representation <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E3A" id="P7000497027000000000000000042E3A">0xfffffffffffffffd</code>. Writing the bytes in reverse order gives <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E3B" id="P7000497027000000000000000042E3B">fd ff ff ff ff ff ff ff</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E3C" id="P7000497027000000000000000042E3C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E3D" id="P7000497027000000000000000042E3D">The code starts at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E3E" id="P7000497027000000000000000042E3E">0x100</code>. The first instruction requires 10 bytes, while the second requires 2. Thus, the loop target will be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E3F" id="P7000497027000000000000000042E3F">0x0000010c</code>. Writing these bytes in reverse order gives <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E40" id="P7000497027000000000000000042E40">0c 01 00 00 00 00 00 00</code>.</p></li>
</ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000046BB" id="P70004970270000000000000000046BB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E41" epub:type="title" id="P7000497027000000000000000042E41"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003B84"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003B77">360</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E42" id="P7000497027000000000000000042E42">Decoding a byte sequence by hand helps you understand the task faced by a processor. It must read byte sequences and determine what instructions are to be executed. In the following, we show the assembly code used to generate each of the byte sequences. To the left of the assembly code, you can see the address and byte sequence for each instruction.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter04.xhtml#P7000497027000000000000000042E43" id="P7000497027000000000000000042E43">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E44" id="P7000497027000000000000000042E44"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E45" id="P7000497027000000000000000042E45">Some operations with immediate data and address displacements:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E46" id="P7000497027000000000000000042E46"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E47" id="P7000497027000000000000000042E47">0x100: 30f3fcffffffffffffff	|	 irmovq $-4,%rbx
0x10a: 40630008000000000000	|	 rmmovq %rsi,0x800(%rbx)
0x114: 00			|	 halt
</code>
</pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E48" id="P7000497027000000000000000042E48"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E49" id="P7000497027000000000000000042E49">Code including a function call:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E4A" id="P7000497027000000000000000042E4A">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E4B" id="P7000497027000000000000000042E4B">0x200: a06f			|	pushq %rsi
0x202: 800c02000000000000	|	call proc
0x20b: 00			|	halt
0x20c:				| proc:
0x20c: 30f30a00000000000000	|	irmovq $10,%rbx
0x216: 90			|	ret
</code>
</pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E4C" id="P7000497027000000000000000042E4C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E4D" id="P7000497027000000000000000042E4D">Code containing illegal instruction specifier byte <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E4E" id="P7000497027000000000000000042E4E">0xf0</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E4F" id="P7000497027000000000000000042E4F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E50" id="P7000497027000000000000000042E50">0x300: 50540700000000000000		|	<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E51" id="P7000497027000000000000000042E51">mrmovq</code> 7(%rsp),%rbp
0x30a: 10				|	nop
0x30b: fO				| .byte OxfO # Invalid instruction code
0x30c: b01f				|	popq %rcx
</code>
</pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E52" id="P7000497027000000000000000042E52"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E53" id="P7000497027000000000000000042E53">Code containing a jump operation:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E54" id="P7000497027000000000000000042E54"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E55" id="P7000497027000000000000000042E55">0x400:				| loop:
0x400: 6113			|	subq %rcx, %rbx
0x402: 730004000000000000	|	je loop
0x40b: 00			|	halt
</code>
</pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E56" id="P7000497027000000000000000042E56"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E57" id="P7000497027000000000000000042E57">Code containing an invalid second byte in a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E58" id="P7000497027000000000000000042E58">pushq</code> instruction:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E59" id="P7000497027000000000000000042E59"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E5A" id="P7000497027000000000000000042E5A">0x500: 6362		|	 xorq %rsi,%rdx
0x502: a0		|	 .byte 0xa0 # pushq instruction code
0x503: f0		|	 .byte 0xf0 # Invalid register specifier byte
</code>
</pre>
</li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000046D6" id="P70004970270000000000000000046D6"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E5B" epub:type="title" id="P7000497027000000000000000042E5B"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000046D8" epub:type="pagebreak" id="P70004970270000000000000000046D8" title="482"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C23"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.3 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C1A">369</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E5C" id="P7000497027000000000000000042E5C">Using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E5D" id="P7000497027000000000000000042E5D">iaddq</code> instruction, we can rewrite the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E5E" id="P7000497027000000000000000042E5E">sum</code> function as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E5F" id="P7000497027000000000000000042E5F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E60" id="P7000497027000000000000000042E60"># long sum(long *start, long count)
# start in %rdi, count in %rsi
sum:
	xorq %rax,%rax		# sum = 0
	andq %rsi,%rsi		# Set condition codes
	jmp test
loop:
	mrmovq (%rdi),%r10	# Get *start
	addq %r10,%rax		# Add to sum
	iaddq $8,%rdi		# start++
	iaddq $-1,%rsi		# count--
test :
	jne loop		# Stop when 0
	ret
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000046DE" id="P70004970270000000000000000046DE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E61" epub:type="title" id="P7000497027000000000000000042E61"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C31"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.4 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C33">370</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E62" id="P7000497027000000000000000042E62">G<span class="pcalibre1 pcalibre29 pcalibre2">cc</span>, running on an x86-64 machine, produces the following code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E63" id="P7000497027000000000000000042E63">rsum</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E64" id="P7000497027000000000000000042E64"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E65" id="P7000497027000000000000000042E65"><i class="pcalibre17 pcalibre2 pcalibre1">long rsum(long * start, long count)</i>
<i class="pcalibre17 pcalibre2 pcalibre1">start in %rdi, count in %rsi</i>
rsum:
	movl	$0, %eax
	testq	%rsi, %rsi
	jle	.L9
	pushq	%rbx
	movq	(%rdi), %rbx
	subq	$1, %rsi
	addq	$8, %rdi
	call	rsum
	addq	%rbx, %rax
	popq	%rbx
.L9:
	rep; ret
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E66" id="P7000497027000000000000000042E66">This can easily be adapted to produce Y86-64 code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E67" id="P7000497027000000000000000042E67">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E68" id="P7000497027000000000000000042E68"># long rsum(long *start, long count)
# start in %rdi, count in %rsi
rsum:
	xorq %rax,%rax		# Set return value to 0
	andq %rsi,%rsi		# Set condition codes
	je return		# If count == 0, return 0
	pushq %rbx		# Save callee-saved register
	<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000046E7" epub:type="pagebreak" id="P70004970270000000000000000046E7" title="483"></span>mrmovq (%rdi), %rbx	# Get *start
	irmovq $-1,%r10
	addq %r10,%rsi		# count--
	irmovq $8,%r10
	addq %r10,%rdi		# start++
	call rsum
	addq %rbx,%rax		# Add *start to sum
	popq %rbx		# Restore callee-saved register
return:
	ret
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000046E8" id="P70004970270000000000000000046E8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E69" epub:type="title" id="P7000497027000000000000000042E69"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C3C"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C33">370</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E6A" id="P7000497027000000000000000042E6A">This problem gives you a chance to try your hand at writing assembly code.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E6B" id="P7000497027000000000000000042E6B">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E6C" id="P7000497027000000000000000042E6C">1	# long absSum(long *start, long count)
2	# start in %rdi, count in %rsi
3	absSum:
4		irmovq $8,%r8			# Constant 8
5		irmovq $1,%r9			# Constant 1
6		xorq %rax,%rax			# sum = 0
7		andq %rsi,%rsi			# Set condition codes
8		jmp test
9	loop :
10		mrmovq (%rdi),%r10		# x = *start
11		xorq %r11,%r11			# Constant 0
12		subq %r10,%r11			# -x
13		jle pos				# Skip if -x &lt;= 0
14		rrmovq %r11,%r10		# x = -x
15	pos:
16		addq %r10,%rax			# Add to sum
17		addq %r8,%rdi			# start++
18		subq %r9,%rsi			# count--
19	test:
20		jne loop			# Stop when 0
21		ret
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000046ED" id="P70004970270000000000000000046ED"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E6D" epub:type="title" id="P7000497027000000000000000042E6D"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C43"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.6 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C33">370</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E6E" id="P7000497027000000000000000042E6E">This problem gives you a chance to try your hand at writing assembly code with conditional moves. We show only the code for the loop. The rest is the same as for <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C3C"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.5</span></a>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E6F" id="P7000497027000000000000000042E6F">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E70" id="P7000497027000000000000000042E70">9	loop :
10		mrmovq (%rdi),%r10	# x = *start
11		xorq %r11,%r11		# Constant 0
12		subq %r10,%r11		# -x
13		cmovg %r11,%10		# If -x &gt; 0 then x = -x
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000046F2" epub:type="pagebreak" id="P70004970270000000000000000046F2" title="484"></span>14		addq %r10,%rax		# Add to sum
15		addq %r8,%rdi		# start++
16		subq %r9,%rsi		# count--
17	test:
18		jne loop		# Stop when 0
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000046F3" id="P70004970270000000000000000046F3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E71" epub:type="title" id="P7000497027000000000000000042E71"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C54"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.7 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C33">370</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E72" id="P7000497027000000000000000042E72">Although it is hard to imagine any practical use for this particular instruction, it is important when designing a system to avoid any ambiguities in the specification. We want to determine a reasonable convention for the instruction's behavior and to make sure each of our implementations adheres to this convention.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E73" id="P7000497027000000000000000042E73">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E74" id="P7000497027000000000000000042E74">subq</code> instruction in this test compares the starting value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E75" id="P7000497027000000000000000042E75">%rsp</code> to the value pushed onto the stack. The fact that the result of this subtraction is zero implies that the old value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E76" id="P7000497027000000000000000042E76">%rsp</code> gets pushed.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000046FA" id="P70004970270000000000000000046FA"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E77" epub:type="title" id="P7000497027000000000000000042E77"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C64"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.8 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C5B">371</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E78" id="P7000497027000000000000000042E78">It is even more difficult to imagine why anyone would want to pop to the stack pointer. Still, we should decide on a convention and stick with it. This code sequence pushes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E79" id="P7000497027000000000000000042E79">0xabcd</code> onto the stack, pops to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E7A" id="P7000497027000000000000000042E7A">%rsp</code>, and returns the popped value. Since the result equals <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E7B" id="P7000497027000000000000000042E7B">0xabcd</code>, we can deduce that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E7C" id="P7000497027000000000000000042E7C">popq %rsp</code> sets the stack pointer to the value read from memory. It is therefore equivalent to the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E7D" id="P7000497027000000000000000042E7D">mrmovq</code> (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E7E" id="P7000497027000000000000000042E7E">%rsp</code>),<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E7F" id="P7000497027000000000000000042E7F">%rsp</code>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004704" id="P7000497027000000000000000004704"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E80" epub:type="title" id="P7000497027000000000000000042E80"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003CAE"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.9 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003C99">374</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E81" id="P7000497027000000000000000042E81">The <span class="pcalibre1 pcalibre29 pcalibre2">exclusive-or </span>function requires that the 2 bits have opposite values:</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E82" id="P7000497027000000000000000042E82"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E83" id="P7000497027000000000000000042E83">bool xor = (!a &amp;&amp; b) || (a &amp;&amp; !b);</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E84" id="P7000497027000000000000000042E84">In general, the signals <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E85" id="P7000497027000000000000000042E85">eq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E86" id="P7000497027000000000000000042E86">xor</code> will be complements of each other. That is, one will equal 1 whenever the other is 0.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000470C" id="P700049702700000000000000000470C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E87" epub:type="title" id="P7000497027000000000000000042E87"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003CDD"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.10 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003CDC">377</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E88" id="P7000497027000000000000000042E88">The outputs of the <span class="pcalibre1 pcalibre29 pcalibre2">exclusive-or </span>circuits will be the complements of the bit equality values. Using DeMorgan's laws (Web Aside <span class="pcalibre1 pcalibre29 pcalibre2">data:bool </span>on page 52), we can implement <span class="pcalibre1 pcalibre29 pcalibre2">and </span>using <span class="pcalibre1 pcalibre29 pcalibre2">or </span>and <span class="pcalibre1 pcalibre29 pcalibre2">not</span>, yielding the circuit shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000004718"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.71</span></a>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000470F" id="P700049702700000000000000000470F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E89" epub:type="title" id="P7000497027000000000000000042E89"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003D08"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.11 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003CF5">379</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E8A" id="P7000497027000000000000000042E8A">We can see that the second part of the case expression can be written as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E8B" id="P7000497027000000000000000042E8B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E8C" id="P7000497027000000000000000042E8C">B &lt;= C	 : B;</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E8D" id="P7000497027000000000000000042E8D">Since the first line will detect the case where A is the minimum element, the second line need only determine whether B or C is minimum.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004715" id="P7000497027000000000000000004715"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E8E" epub:type="title" id="P7000497027000000000000000042E8E"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003D15"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.12 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003D0F">380</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E8F" id="P7000497027000000000000000042E8F">This design is a variant of the one to find the minimum of the three inputs:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter04.xhtml#P7000497027000000000000000004718" id="P7000497027000000000000000004718">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004719" epub:type="pagebreak" id="P7000497027000000000000000004719" title="485"></span><img alt="A diagram illustrates gates." class="pcalibre1 pcalibre189 pcalibre2" data-uri="P700049702700000000000000000B70B" id="P7000497027000000000000000042E90" src="Images/chapter-04-image-39.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter04.xhtml#P7000497027000000000000000042E91" id="P7000497027000000000000000042E91"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter04.xhtml#P7000497027000000000000000042E92" epub:type="title" id="P7000497027000000000000000042E92"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.71 </span>Solution for <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003C81.xhtml#P7000497027000000000000000003CDD"><span class="label pcalibre1 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">4.10</span></a>.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter04.xhtml#P700049702700000000000000002316C" id="P700049702700000000000000002316C">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E93" id="P7000497027000000000000000042E93">Four diagrams leda to an OR gate, which leads to a NOT and Eq:</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter04.xhtml#P7000497027000000000000000042E94" id="P7000497027000000000000000042E94">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E95" id="P7000497027000000000000000042E95"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E96" id="P7000497027000000000000000042E96">Xor with inputs a<sub class="pcalibre1 pcalibre2 calibre14">63</sub> and b<sub class="pcalibre1 pcalibre2 calibre14">63</sub> and output ! eq<sub class="pcalibre1 pcalibre2 calibre14">63</sub></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E97" id="P7000497027000000000000000042E97"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E98" id="P7000497027000000000000000042E98">Xor with inputs a<sub class="pcalibre1 pcalibre2 calibre14">62</sub> and b<sub class="pcalibre1 pcalibre2 calibre14">62</sub> and output ! eq<sub class="pcalibre1 pcalibre2 calibre14">62</sub></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E99" id="P7000497027000000000000000042E99"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E9A" id="P7000497027000000000000000042E9A">Xor with inputs a<sub class="pcalibre1 pcalibre2 calibre14">1</sub> and b<sub class="pcalibre1 pcalibre2 calibre14">1</sub> and output ! eq<sub class="pcalibre1 pcalibre2 calibre14">1</sub></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E9B" id="P7000497027000000000000000042E9B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042E9C" id="P7000497027000000000000000042E9C">Xor with inputs a<sub class="pcalibre1 pcalibre2 calibre14">0</sub> and b<sub class="pcalibre1 pcalibre2 calibre14">0</sub> and output ! eq<sub class="pcalibre1 pcalibre2 calibre14">0</sub></p></li>
</ul>
</details>
</figcaption>
</figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042E9D" id="P7000497027000000000000000042E9D">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E9E" id="P7000497027000000000000000042E9E">word Med3 = [
	A &lt;= B &amp;&amp; B &lt;= C : B;
	C &lt;= B &amp;&amp; B &lt;= A : B;
	B &lt;= A &amp;&amp; A &lt;= C : A;
	C &lt;= A &amp;&amp; A &lt;= B : A;
	1		 : C;
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000471F" id="P700049702700000000000000000471F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042E9F" epub:type="title" id="P7000497027000000000000000042E9F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003DAD"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.13 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003D85">387</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EA0" id="P7000497027000000000000000042EA0">These exercises help make the stage computations more concrete. We can see from the object code that this instruction is located at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EA1" id="P7000497027000000000000000042EA1">0x016</code>. It consists of 10 bytes, with the first two being <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EA2" id="P7000497027000000000000000042EA2">0x30</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EA3" id="P7000497027000000000000000042EA3">0xf4</code>. The last 8 bytes are a byte-reversed version of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EA4" id="P7000497027000000000000000042EA4">0x0000000000000080</code> (decimal 128).</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042EA5" id="P7000497027000000000000000042EA5">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042EA6" id="P7000497027000000000000000042EA6">Stage	</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042EA7" id="P7000497027000000000000000042EA7">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EA8" id="P7000497027000000000000000042EA8">irmovq</code> V, rB	</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042EA9" id="P7000497027000000000000000042EA9">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EAA" id="P7000497027000000000000000042EAA">irmovq</code> $128, <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EAB" id="P7000497027000000000000000042EAB">%rsp</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EAC" id="P7000497027000000000000000042EAC">Fetch	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EAD" id="P7000497027000000000000000042EAD">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EAE" id="P7000497027000000000000000042EAE">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EAF" id="P7000497027000000000000000042EAF">[0x016] = 3:0</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EB0" id="P7000497027000000000000000042EB0">rA:rB ← MfiTC + 1]	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EB1" id="P7000497027000000000000000042EB1">rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EB2" id="P7000497027000000000000000042EB2">0x017] = f:4</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7"></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EB3" id="P7000497027000000000000000042EB3">valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 2]	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EB4" id="P7000497027000000000000000042EB4">valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EB5" id="P7000497027000000000000000042EB5">[0x018] = 128</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7"></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EB6" id="P7000497027000000000000000042EB6">valP ← PC + 10	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EB7" id="P7000497027000000000000000042EB7">valP ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EB8" id="P7000497027000000000000000042EB8">0x016 + 10 = 0x020</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EB9" id="P7000497027000000000000000042EB9">Decode		</td><td class="pcalibre1 pcalibre2 calibre7" colspan="3"></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EBA" id="P7000497027000000000000000042EBA">Execute	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EBB" id="P7000497027000000000000000042EBB">valE ← 0 + valC	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EBC" id="P7000497027000000000000000042EBC">valE ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EBD" id="P7000497027000000000000000042EBD">0+128=128</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EBE" id="P7000497027000000000000000042EBE">Memory		</td><td class="pcalibre1 pcalibre2 calibre7" colspan="2"></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EBF" id="P7000497027000000000000000042EBF">Write back	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EC0" id="P7000497027000000000000000042EC0">R[rB] ← valE	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EC1" id="P7000497027000000000000000042EC1">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EC2" id="P7000497027000000000000000042EC2">%rsp</code>] ← valE=128</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EC3" id="P7000497027000000000000000042EC3">PC update	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EC4" id="P7000497027000000000000000042EC4">PC ← valP	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EC5" id="P7000497027000000000000000042EC5">PC ← valP = <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EC6" id="P7000497027000000000000000042EC6">0x020</code></td></tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EC7" id="P7000497027000000000000000042EC7">This instruction sets register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EC8" id="P7000497027000000000000000042EC8">%rsp</code> to 128 and increments the PC by 10.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000474A" id="P700049702700000000000000000474A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EC9" epub:type="title" id="P7000497027000000000000000042EC9"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000474C" epub:type="pagebreak" id="P700049702700000000000000000474C" title="486"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E52"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.14 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E26">390</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042ECA" id="P7000497027000000000000000042ECA">We can see that the instruction is located at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042ECB" id="P7000497027000000000000000042ECB">0x02c</code> and consists of 2 bytes with values <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042ECC" id="P7000497027000000000000000042ECC">0xb0</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042ECD" id="P7000497027000000000000000042ECD">0x00f</code>. Register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042ECE" id="P7000497027000000000000000042ECE">%rsp</code> was set to 120 by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042ECF" id="P7000497027000000000000000042ECF">pushq</code> instruction (line 6), which also stored 9 at this memory location.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042ED0" id="P7000497027000000000000000042ED0">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2"><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042ED1" id="P7000497027000000000000000042ED1">Stage</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042ED2" id="P7000497027000000000000000042ED2">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042ED3" id="P7000497027000000000000000042ED3">popq</code> rA</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042ED4" id="P7000497027000000000000000042ED4">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042ED5" id="P7000497027000000000000000042ED5">popq %rax</code></th></tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042ED6" id="P7000497027000000000000000042ED6">Fetch</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042ED7" id="P7000497027000000000000000042ED7">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]<br class="pcalibre1 pcalibre2 pcalibre7"/>rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042ED8" id="P7000497027000000000000000042ED8">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042ED9" id="P7000497027000000000000000042ED9">[0x02c] = b:0</code><br class="pcalibre1 pcalibre2 pcalibre7"/>rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EDA" id="P7000497027000000000000000042EDA">[0x02d] = 0:f</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EDB" id="P7000497027000000000000000042EDB">valP ← PC + 2</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EDC" id="P7000497027000000000000000042EDC">valP ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EDD" id="P7000497027000000000000000042EDD">0x02c + 2 = 0x02e</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EDE" id="P7000497027000000000000000042EDE">Decode</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EDF" id="P7000497027000000000000000042EDF">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EE0" id="P7000497027000000000000000042EE0">%rsp</code>]<br class="pcalibre1 pcalibre2 pcalibre7"/>valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EE1" id="P7000497027000000000000000042EE1">%rsp</code>]</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EE2" id="P7000497027000000000000000042EE2">valA ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EE3" id="P7000497027000000000000000042EE3">%rsp</code>] = <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EE4" id="P7000497027000000000000000042EE4">120</code> <br class="pcalibre1 pcalibre2 pcalibre7"/>valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EE5" id="P7000497027000000000000000042EE5">%rsp</code>] = <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EE6" id="P7000497027000000000000000042EE6">120</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EE7" id="P7000497027000000000000000042EE7">Execute</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EE8" id="P7000497027000000000000000042EE8">valE ← valB + 8</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EE9" id="P7000497027000000000000000042EE9">valE ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EEA" id="P7000497027000000000000000042EEA">120 + 8 = 128</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EEB" id="P7000497027000000000000000042EEB">Memory</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EEC" id="P7000497027000000000000000042EEC">valM ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valA]</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EED" id="P7000497027000000000000000042EED">valM ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EEE" id="P7000497027000000000000000042EEE">[120] = 9</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EEF" id="P7000497027000000000000000042EEF">Write back</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EF0" id="P7000497027000000000000000042EF0">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EF1" id="P7000497027000000000000000042EF1">%rsp</code>] ← valE <br class="pcalibre1 pcalibre2 pcalibre7"/>R[rA] ← valM</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EF2" id="P7000497027000000000000000042EF2">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EF3" id="P7000497027000000000000000042EF3">%rsp</code>] ← 128 <br class="pcalibre1 pcalibre2 pcalibre7"/>R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EF4" id="P7000497027000000000000000042EF4">%rax</code>] ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EF5" id="P7000497027000000000000000042EF5">9</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EF6" id="P7000497027000000000000000042EF6">PC update</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EF7" id="P7000497027000000000000000042EF7">PC ← valP</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042EF8" id="P7000497027000000000000000042EF8">PC ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EF9" id="P7000497027000000000000000042EF9">0x02e</code></td></tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EFA" id="P7000497027000000000000000042EFA">The instruction sets <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EFB" id="P7000497027000000000000000042EFB">%rax</code> to 9, sets <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EFC" id="P7000497027000000000000000042EFC">%rsp</code> to 128, and increments the PC by 2.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004780" id="P7000497027000000000000000004780"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EFD" epub:type="title" id="P7000497027000000000000000042EFD"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E9A"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.15 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E62">391</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EFE" id="P7000497027000000000000000042EFE">Tracing the steps listed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E5F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.20</span></a> with rA equal to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042EFF" id="P7000497027000000000000000042EFF">%rsp</code>, we can see that in the memory stage the instruction will store valA, the original value of the stack pointer, to memory, just as we found for x86-64.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004784" id="P7000497027000000000000000004784"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F00" epub:type="title" id="P7000497027000000000000000042F00"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003ED1"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.16 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003EA3">392</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F01" id="P7000497027000000000000000042F01">Tracing the steps listed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003E5F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.20</span></a> with rA equal to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F02" id="P7000497027000000000000000042F02">%rsp</code>, we can see that both of the write-back operations will update <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F03" id="P7000497027000000000000000042F03">%rsp</code>. Since the one writing valM would occur last, the net effect of the instruction will be to write the value read from memory to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F04" id="P7000497027000000000000000042F04">%rsp</code>, just as we saw for x86-64.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000478A" id="P700049702700000000000000000478A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F05" epub:type="title" id="P7000497027000000000000000042F05"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003F08"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.17 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003EE1">393</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F06" id="P7000497027000000000000000042F06">Implementing conditional moves requires only minor changes from register-to-register moves. We simply condition the write-back step on the outcome of the conditional test:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042F07" id="P7000497027000000000000000042F07">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042F08" id="P7000497027000000000000000042F08">Stage	</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042F09" id="P7000497027000000000000000042F09"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F0A" id="P7000497027000000000000000042F0A">cmovXX</code> rA, rB</th></tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F0B" id="P7000497027000000000000000042F0B">Fetch	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F0C" id="P7000497027000000000000000042F0C">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7"></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F0D" id="P7000497027000000000000000042F0D">rA:rB ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC + 1]</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7"></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F0E" id="P7000497027000000000000000042F0E">valP ← PC + 2</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F0F" id="P7000497027000000000000000042F0F">Decode	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F10" id="P7000497027000000000000000042F10">valA ← R[rA]</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F11" id="P7000497027000000000000000042F11"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004798" epub:type="pagebreak" id="P7000497027000000000000000004798" title="487"></span>Execute	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F12" id="P7000497027000000000000000042F12">valE ← 0 + valA</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7"></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F13" id="P7000497027000000000000000042F13">Cnd ← Cond(CC, ifun)</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F14" id="P7000497027000000000000000042F14">Memory	</td><td class="pcalibre1 pcalibre2 calibre7"></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F15" id="P7000497027000000000000000042F15">Write back	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F16" id="P7000497027000000000000000042F16"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F17" id="P7000497027000000000000000042F17">if</code> (Cnd) R[rB] ← valE</td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F18" id="P7000497027000000000000000042F18">PC update	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F19" id="P7000497027000000000000000042F19">PC ← valP</td></tr>
</tbody>
</table>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047A1" id="P70004970270000000000000000047A1"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F1A" epub:type="title" id="P7000497027000000000000000042F1A"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003F4A"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.18 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003F23">394</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F1B" id="P7000497027000000000000000042F1B">We can see that this instruction is located at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F1C" id="P7000497027000000000000000042F1C">0x037</code> and is 9 bytes long. The first byte has value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F1D" id="P7000497027000000000000000042F1D">0x80</code>, while the last 8 bytes are a byte-reversed version of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F1E" id="P7000497027000000000000000042F1E">0x0000000000000041</code>, the call target. The stack pointer was set to 128 by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F1F" id="P7000497027000000000000000042F1F">popq</code> instruction (line 7).</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter04.xhtml#P7000497027000000000000000042F20" id="P7000497027000000000000000042F20">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042F21" id="P7000497027000000000000000042F21">Stage</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042F22" id="P7000497027000000000000000042F22">Generic <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F23" id="P7000497027000000000000000042F23">call</code> Dest</th><th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter04.xhtml#P7000497027000000000000000042F24" id="P7000497027000000000000000042F24">Specific <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F25" id="P7000497027000000000000000042F25">call 0x041</code></th></tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F26" id="P7000497027000000000000000042F26">Fetch</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F27" id="P7000497027000000000000000042F27">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>[PC]</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F28" id="P7000497027000000000000000042F28">icode:ifun ← M<sub class="pcalibre97 pcalibre2 pcalibre1">1</sub><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F29" id="P7000497027000000000000000042F29">[0x037] = 8:0</code>
</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F2A" id="P7000497027000000000000000042F2A">valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[PC + 1]<br class="pcalibre1 pcalibre2 pcalibre7"/>valP ← PC + 9</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F2B" id="P7000497027000000000000000042F2B">valC ← M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F2C" id="P7000497027000000000000000042F2C">[0x038] = 0x041</code><br class="pcalibre1 pcalibre2 pcalibre7"/>
valP ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F2D" id="P7000497027000000000000000042F2D">0x037 + 9 = 0x040</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F2E" id="P7000497027000000000000000042F2E">Decode</td> <td class="pcalibre1 pcalibre2 calibre7" colspan="2"></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7"></td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F2F" id="P7000497027000000000000000042F2F">valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F30" id="P7000497027000000000000000042F30">%rsp</code>]	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F31" id="P7000497027000000000000000042F31">valB ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F32" id="P7000497027000000000000000042F32">%rsp</code>] = <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F33" id="P7000497027000000000000000042F33">128</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F34" id="P7000497027000000000000000042F34">Execute	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F35" id="P7000497027000000000000000042F35">valE ← valB + -8	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F36" id="P7000497027000000000000000042F36">valE ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F37" id="P7000497027000000000000000042F37">128+ -8 = 120</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F38" id="P7000497027000000000000000042F38">Memory	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F39" id="P7000497027000000000000000042F39">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[valE] ← valP	</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F3A" id="P7000497027000000000000000042F3A">M<sub class="pcalibre97 pcalibre2 pcalibre1">8</sub>[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F3B" id="P7000497027000000000000000042F3B">120</code>] ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F3C" id="P7000497027000000000000000042F3C">0x040</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F3D" id="P7000497027000000000000000042F3D">Write back</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F3E" id="P7000497027000000000000000042F3E">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F3F" id="P7000497027000000000000000042F3F">%rsp</code>] ← valE</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F40" id="P7000497027000000000000000042F40">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F41" id="P7000497027000000000000000042F41">%rsp</code>] ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F42" id="P7000497027000000000000000042F42">120</code></td></tr>
<tr class="pcalibre45 pcalibre1 pcalibre2"><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F43" id="P7000497027000000000000000042F43">PC update</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F44" id="P7000497027000000000000000042F44">PC ← valC</td><td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter04.xhtml#P7000497027000000000000000042F45" id="P7000497027000000000000000042F45">PC ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F46" id="P7000497027000000000000000042F46">0x041</code></td></tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F47" id="P7000497027000000000000000042F47">The effect of this instruction is to set <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F48" id="P7000497027000000000000000042F48">%rsp</code> to 120, to store <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F49" id="P7000497027000000000000000042F49">0x040</code> (the return address) at this memory address, and to set the PC to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F4A" id="P7000497027000000000000000042F4A">0x041</code> (the call target).</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047D3" id="P70004970270000000000000000047D3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F4B" epub:type="title" id="P7000497027000000000000000042F4B"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P70004970270000000000000000040D6"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.19 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_001.xhtml#P70004970270000000000000000040D3">406</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F4C" id="P7000497027000000000000000042F4C">All of the HCL code in this and other practice problems is straightforward, but trying to generate it yourself will help you think about the different instructions and how they are processed. For this problem, we can simply look at the set of Y86-64 instructions (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003ADE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.2</span></a>) and determine which have a constant field.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F4D" id="P7000497027000000000000000042F4D">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F4E" id="P7000497027000000000000000042F4E">bool need_valC =
	icode in { IIRMOVQ, IRMMOVQ, IMRMOVQ, IJXX, ICALL };
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047D8" id="P70004970270000000000000000047D8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F4F" epub:type="title" id="P7000497027000000000000000042F4F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000047DA" epub:type="pagebreak" id="P70004970270000000000000000047DA" title="488"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P70004970270000000000000000040F0"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.20 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_001.xhtml#P70004970270000000000000000040E5">407</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F50" id="P7000497027000000000000000042F50">This code is similar to the code for srcA.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F51" id="P7000497027000000000000000042F51">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F52" id="P7000497027000000000000000042F52">word srcB = [
	icode in { IOPQ, IRMMOVQ, IMRMOVQ } : rB; 
	icode in { IPUSHQ, IPOPQ, ICALL, IRET } : RRSP; 
	1 : RNONE; # Don't need register
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047DE" id="P70004970270000000000000000047DE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F53" epub:type="title" id="P7000497027000000000000000042F53"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P70004970270000000000000000040F7"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.21 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_001.xhtml#P70004970270000000000000000040F9">408</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F54" id="P7000497027000000000000000042F54">This code is similar to the code for dstE.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F55" id="P7000497027000000000000000042F55">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F56" id="P7000497027000000000000000042F56">word dstM = [
	icode in { IMRMOVQ, IPOPQ } : rA;
	1 : RNONE; # Don't write any register
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047E3" id="P70004970270000000000000000047E3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F57" epub:type="title" id="P7000497027000000000000000042F57"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P70004970270000000000000000040FB"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.22 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_001.xhtml#P70004970270000000000000000040F9">408</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F58" id="P7000497027000000000000000042F58">As we found in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_000.xhtml#P7000497027000000000000000003ED1"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.16</span></a>, we want the write via the M port to take priority over the write via the E port in order to store the value read from memory into <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F59" id="P7000497027000000000000000042F59">%rsp</code>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047E7" id="P70004970270000000000000000047E7"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F5A" epub:type="title" id="P7000497027000000000000000042F5A"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P7000497027000000000000000004111"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.23 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_001.xhtml#P700049702700000000000000000410E">409</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F5B" id="P7000497027000000000000000042F5B">This code is similar to the code for aluA.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F5C" id="P7000497027000000000000000042F5C">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F5D" id="P7000497027000000000000000042F5D">word aluB = [
	icode in { IRMMOVQ, IMRMOVQ, IOPQ, ICALL, IPUSHQ, IRET, IPOPQ } : valB;
	icode in { IRRMOVQ, IIRMOVQ } : 0;
	# Other instructions don't need ALU
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047EC" id="P70004970270000000000000000047EC"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F5E" epub:type="title" id="P7000497027000000000000000042F5E"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P700049702700000000000000000411D"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.24 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_001.xhtml#P700049702700000000000000000410E">409</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F5F" id="P7000497027000000000000000042F5F">Implementing conditional moves is surprisingly simple: we disable writing to the register file by setting the destination register to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F60" id="P7000497027000000000000000042F60">RNONE</code> when the condition does not hold.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F61" id="P7000497027000000000000000042F61">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F62" id="P7000497027000000000000000042F62">word dstE = [
	icode in { IRRMOVQ } &amp;&amp; Cnd : rB;
	icode in { IIRMOVQ, IOPQ} : rB;
	icode in { IPUSHQ, IPOPQ, ICALL, IRET } : RRSP;
	1 : RNONE; # Don't write any register
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047F2" id="P70004970270000000000000000047F2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F63" epub:type="title" id="P7000497027000000000000000042F63"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P7000497027000000000000000004130"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.25 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_001.xhtml#P7000497027000000000000000004126">410</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F64" id="P7000497027000000000000000042F64">This code is similar to the code for mem_addr.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F65" id="P7000497027000000000000000042F65">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F66" id="P7000497027000000000000000042F66"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P70004970270000000000000000047F7" epub:type="pagebreak" id="P70004970270000000000000000047F7" title="489"></span>word mem_data = [
	# Value from register
	icode in { IRMMOVQ, IPUSHQ } : valA;
	# Return PC
	icode == ICALL : valP;
	# Default: Don't write anything
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047F8" id="P70004970270000000000000000047F8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F67" epub:type="title" id="P7000497027000000000000000042F67"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P7000497027000000000000000004136"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.26 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_001.xhtml#P7000497027000000000000000004126">410</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F68" id="P7000497027000000000000000042F68">This code is similar to the code for mem_read.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F69" id="P7000497027000000000000000042F69"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F6A" id="P7000497027000000000000000042F6A">bool mem_write = icode in { IRMMOVQ, IPUSHQ, ICALL };</code></pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P70004970270000000000000000047FD" id="P70004970270000000000000000047FD"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F6B" epub:type="title" id="P7000497027000000000000000042F6B"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003D54_split_001.xhtml#P7000497027000000000000000004141"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.27 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000003D54_split_001.xhtml#P700049702700000000000000000413A">411</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F6C" id="P7000497027000000000000000042F6C">Computing the Stat field requires collecting status information from several stages:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F6D" id="P7000497027000000000000000042F6D">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F6E" id="P7000497027000000000000000042F6E">## Determine instruction status
word Stat = [
	imem_error | | dmem_error : SADR;
	!instr_valid: SINS;
	icode == IHALT : SHLT;
	1 : SAOK;
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004802" id="P7000497027000000000000000004802"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F6F" epub:type="title" id="P7000497027000000000000000042F6F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004152.xhtml#P70004970270000000000000000041A2"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.28 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000004152.xhtml#P700049702700000000000000000419B">417</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F70" id="P7000497027000000000000000042F70">This problem is an interesting exercise in trying to find the optimal balance among a set of partitions. It provides a number of opportunities to compute throughputs and latencies in pipelines.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter04.xhtml#P7000497027000000000000000042F71" id="P7000497027000000000000000042F71">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F72" id="P7000497027000000000000000042F72"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042F73" id="P7000497027000000000000000042F73">For a two-stage pipeline, the best partition would be to have blocks A, B, and C in the first stage and D, E, and F in the second. The first stage has a delay of 170 ps, giving a total cycle time of 170 + 20 = 190 ps. We therefore have a throughput of 5.26 GIPS and a latency of 380 ps.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F74" id="P7000497027000000000000000042F74"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042F75" id="P7000497027000000000000000042F75">For a three-stage pipeline, we should have blocks A and B in the first stage, blocks C and D in the second, and blocks E and F in the third. The first two stages have a delay of 110 ps, giving a total cycle time of 130 ps and a throughput of 7.69 GIPS. The latency is 390 ps.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F76" id="P7000497027000000000000000042F76"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042F77" id="P7000497027000000000000000042F77">For a four-stage pipeline, we should have block A in the first stage, blocks B and C in the second, block D in the third, and blocks E and F in the fourth. The second stage requires 90 ps, giving a total cycle time of 110 ps and a throughput of 9.09 GIPS. The latency is 440 ps.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F78" id="P7000497027000000000000000042F78"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042F79" id="P7000497027000000000000000042F79">The optimal design would be a five-stage pipeline, with each block in its own stage, except that the fifth stage has blocks E and F The cycle time is 80 + 20 = 100 ps, for a throughput of around 10.00 GIPS and a latency of <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000480E" epub:type="pagebreak" id="P700049702700000000000000000480E" title="490"></span>500 ps. Adding more stages would not help, since we cannot run the pipeline any faster than one cycle every 100 ps.</p></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000480F" id="P700049702700000000000000000480F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F7A" epub:type="title" id="P7000497027000000000000000042F7A"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004152.xhtml#P70004970270000000000000000041B9"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.29 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000004152.xhtml#P70004970270000000000000000041B0">418</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F7B" id="P7000497027000000000000000042F7B">Each stage would have combinational logic requiring 300/<var class="pcalibre17 pcalibre2 pcalibre1">k</var> ps and a pipeline register requiring 20 ps.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter04.xhtml#P7000497027000000000000000042F7C" id="P7000497027000000000000000042F7C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F7D" id="P7000497027000000000000000042F7D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042F7E" id="P7000497027000000000000000042F7E">The total latency would be 300 + 20<var class="pcalibre17 pcalibre2 pcalibre1">k</var> ps, while the throughput (in GIPS) would be</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter04.xhtml#P7000497027000000000000000042F7F" id="P7000497027000000000000000042F7F">
<m:math altimg="../images/ch04-eq4.png" altimg-height="39" altimg-width="140" alttext="" data-uri="" display="block"><m:mrow><m:mfrac><m:mrow><m:mn>1</m:mn><m:mo>,</m:mo><m:mn>000</m:mn></m:mrow><m:mrow><m:mfrac><m:mrow><m:mn>300</m:mn></m:mrow><m:mi>k</m:mi></m:mfrac><m:mo>+</m:mo><m:mn>20</m:mn></m:mrow></m:mfrac><m:mo>=</m:mo><m:mfrac><m:mrow><m:mn>1</m:mn><m:mo>,</m:mo><m:mn>000</m:mn><m:mi>k</m:mi></m:mrow><m:mrow><m:mn>300</m:mn><m:mo>+</m:mo><m:mn>20</m:mn><m:mi>k</m:mi></m:mrow></m:mfrac></m:mrow></m:math>
</div>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F80" id="P7000497027000000000000000042F80"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042F81" id="P7000497027000000000000000042F81">As we let <var class="pcalibre17 pcalibre2 pcalibre1">k</var> go to infinity, the throughput becomes 1,000/20 = 50 GIPS. Of course, the latency would approach infinity as well.</p>
</li>
</ol>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F82" id="P7000497027000000000000000042F82">This exercise quantifies the diminishing returns of deep pipelining. As we try to subdivide the logic into many stages, the latency of the pipeline registers becomes a limiting factor.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004819" id="P7000497027000000000000000004819"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F83" epub:type="title" id="P7000497027000000000000000042F83"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_001.xhtml#P70004970270000000000000000043C6"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.30 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_001.xhtml#P70004970270000000000000000043C1">449</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F84" id="P7000497027000000000000000042F84">This code is very similar to the corresponding code for SEQ, except that we cannot yet determine whether the data memory will generate an error signal for this instruction.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F85" id="P7000497027000000000000000042F85">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F86" id="P7000497027000000000000000042F86"># Determine status code for fetched instruction
word f_stat = [
	imem_error: SADR;
	!instr_valid : SINS;
	f_icode == IHALT : SHLT;
	1 : SAOK;
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000481E" id="P700049702700000000000000000481E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F87" epub:type="title" id="P7000497027000000000000000042F87"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000043CC"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.31 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_001.xhtml#P70004970270000000000000000043C1">449</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F88" id="P7000497027000000000000000042F88">This code simply involves prefixing the signal names in the code for SEQ with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F89" id="P7000497027000000000000000042F89">d_</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F8A" id="P7000497027000000000000000042F8A">D_</code>.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F8B" id="P7000497027000000000000000042F8B">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F8C" id="P7000497027000000000000000042F8C">word d_dstE = [
		D_icode in { IRRMOVQ, IIRMOVQ, IOPQ} : D_rB;
		D_icode in { IPUSHQ, IPOPQ, ICALL, IRET } : RRSP;
		1 : RNONE; # Don't write any register
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004825" id="P7000497027000000000000000004825"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F8D" epub:type="title" id="P7000497027000000000000000042F8D"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004405"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.32 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000043FE">452</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F8E" id="P7000497027000000000000000042F8E">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F8F" id="P7000497027000000000000000042F8F">rrmovq</code> instruction (line 5) would stall for one cycle due to a load/use hazard caused by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F90" id="P7000497027000000000000000042F90">popq</code> instruction (line 4). As it enters the decode stage, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F91" id="P7000497027000000000000000042F91">popq</code> instruction would be in the memory stage, giving both M_dstE and M_dstM equal to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F92" id="P7000497027000000000000000042F92">%rsp</code>. If the two cases were reversed, then the write back from M_valE would take priority, causing the incremented stack pointer to be passed as the argument <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000482C" epub:type="pagebreak" id="P700049702700000000000000000482C" title="491"></span>to the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F93" id="P7000497027000000000000000042F93">rrmovq</code> instruction. This would not be consistent with the convention for handling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F94" id="P7000497027000000000000000042F94">popq %rsp</code> determined in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003AB0.xhtml#P7000497027000000000000000003C64"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.8</span></a>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000482F" id="P700049702700000000000000000482F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F95" epub:type="title" id="P7000497027000000000000000042F95"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P700049702700000000000000000440D"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.33 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000043FE">452</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F96" id="P7000497027000000000000000042F96">This problem lets you experience one of the important tasks in processor design—devising test programs for a new processor. In general, we should have test programs that will exercise all of the different hazard possibilities and will generate incorrect results if some dependency is not handled properly.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F97" id="P7000497027000000000000000042F97">For this example, we can use a slightly modified version of the program shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004405"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.32</span></a>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042F98" id="P7000497027000000000000000042F98">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F99" id="P7000497027000000000000000042F99">1	irmovq $5, %rdx
2	irmovq $0x100,%rsp
3	rmmovq %rdx,0(%rsp) popq%rsp
5	nop
6	nop
7	rrmovq %rsp,%rax
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F9A" id="P7000497027000000000000000042F9A">The two <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F9B" id="P7000497027000000000000000042F9B">nop</code> instructions will cause the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F9C" id="P7000497027000000000000000042F9C">popq</code> instruction to be in the write-back stage when the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F9D" id="P7000497027000000000000000042F9D">rrmovq</code> instruction is in the decode stage. If the two forwarding sources in the write-back stage are given the wrong priority, then register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F9E" id="P7000497027000000000000000042F9E">%rax</code> will be set to the incremented program counter rather than the value read from memory.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000483A" id="P700049702700000000000000000483A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042F9F" epub:type="title" id="P7000497027000000000000000042F9F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004410"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.34 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004412">453</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FA0" id="P7000497027000000000000000042FA0">This logic only needs to check the five forwarding sources:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FA1" id="P7000497027000000000000000042FA1">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FA2" id="P7000497027000000000000000042FA2">word d_valB = [
	d_srcB == e_dstE : e_valE;	# Forward valE from execute
	d_srcB == M_dstM : m_valM;	# Forward valM from memory
	d_srcB == M_dstE : M_valE;	# Forward valE from memory
	d_srcB == W_dstM : W_valM;	# Forward valM from write back
	d_srcB == W_dstE : W_valE;	# Forward valE from write back
	1 : d_rvalB; # Use value read from register file
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000483F" id="P700049702700000000000000000483F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FA3" epub:type="title" id="P7000497027000000000000000042FA3"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P700049702700000000000000000442A"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.35 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004423">454</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FA4" id="P7000497027000000000000000042FA4">This change would not handle the case where a conditional move fails to satisfy the condition, and therefore sets the dstE value to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FA5" id="P7000497027000000000000000042FA5">RNONE</code>. The resulting value could get forwarded to the next instruction, even though the conditional transfer does not occur.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FA6" id="P7000497027000000000000000042FA6">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FA7" id="P7000497027000000000000000042FA7">1	irmovq $0x123,%rax	
2	irmovq $0x321,%rdx	
3	xorq %rcx/Zrcx		# CC = 100
4	cmovne %rax,%rdx	# Not transferred
5	addq %rdx,%rdx		# Should be 0x642
6	halt	
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FA8" id="P7000497027000000000000000042FA8"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004846" epub:type="pagebreak" id="P7000497027000000000000000004846" title="492"></span>This code initializes register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FA9" id="P7000497027000000000000000042FA9">%rdx</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FAA" id="P7000497027000000000000000042FAA">0x321</code>. The conditional data transfer does not take place, and so the final <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FAB" id="P7000497027000000000000000042FAB">addq</code> instruction should double the value in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FAC" id="P7000497027000000000000000042FAC">%rdx</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FAD" id="P7000497027000000000000000042FAD">0x642</code>. With the altered design, however, the conditional move source value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FAE" id="P7000497027000000000000000042FAE">0x321</code> gets forwarded into ALU input valA, while input valB correctly gets operand value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FAF" id="P7000497027000000000000000042FAF">0x123</code>. These inputs get added to produce result <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FB0" id="P7000497027000000000000000042FB0">0x444</code>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000484F" id="P700049702700000000000000000484F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FB1" epub:type="title" id="P7000497027000000000000000042FB1"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004431"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.36 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004433">455</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FB2" id="P7000497027000000000000000042FB2">This code completes the computation of the status code for this instruction.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FB3" id="P7000497027000000000000000042FB3">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FB4" id="P7000497027000000000000000042FB4">## Update the status
word m_stat = [
	dmem_error : SADR;
	1 : M_stat;
];
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004854" id="P7000497027000000000000000004854"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FB5" epub:type="title" id="P7000497027000000000000000042FB5"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000044CF"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.37 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000044BE">461</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FB6" id="P7000497027000000000000000042FB6">The following test program is designed to set up control combination A (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000044BD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.67</span></a>) and detect whether something goes wrong:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FB7" id="P7000497027000000000000000042FB7">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FB8" id="P7000497027000000000000000042FB8">1	# Code to generate a combination of not-taken branch and ret
2		irmovq Stack, %rsp
3		irmovq rtnp,%rax
4		pushq %rax		# Set up return pointer
5		xorq %rax,%rax		# Set Z condition code
6		jne target		# Not taken (First part of combination)
7		irmovq $1,%rax		# Should execute this
8		halt
9	target: ret			# Second part of combination
10		irmovq $2,%rbx		# Should not execute this
11		halt
12	rtnp: irmovq $3,%rdx		# Should not execute this
13		halt
14	.pos 0x40
15	Stack:
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FB9" id="P7000497027000000000000000042FB9">This program is designed so that if something goes wrong (for example, if the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FBA" id="P7000497027000000000000000042FBA">ret</code> instruction is actually executed), then the program will execute one of the extra <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FBB" id="P7000497027000000000000000042FBB">irmovq</code> instructions and then halt. Thus, an error in the pipeline would cause some register to be updated incorrectly. This code illustrates the care required to implement a test program. It must set up a potential error condition and then detect whether or not an error occurs.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000485C" id="P700049702700000000000000000485C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FBC" epub:type="title" id="P7000497027000000000000000042FBC"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000044F6"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.38 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000044F1">462</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FBD" id="P7000497027000000000000000042FBD">The following test program is designed to set up control combination B (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P70004970270000000000000000044BD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.67</span></a>). The simulator will detect a case where the bubble and stall control signals for a pipeline register are both set to zero, and so our test program need only set up the combination for it to be detected. The biggest challenge is to make the program do something sensible when handled correctly.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FBE" id="P7000497027000000000000000042FBE">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FBF" id="P7000497027000000000000000042FBF"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P7000497027000000000000000004861" epub:type="pagebreak" id="P7000497027000000000000000004861" title="493"></span>1	# Test instruction that modifies %esp followed by ret
2		irmovq mem,%rbx
3		mrmovq 0(<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FC0" id="P7000497027000000000000000042FC0">%rbx</code>),%rsp	# Sets %rsp to point to return point
4		ret			# Returns to return point
5		halt			#
6	rtnpt: irmovq $5,%rsi		# Return point
7		halt
8	.pos 0x40
9	mem:	.quad stack		# Holds desired stack pointer
10	.pos 0x50
11	stack:	.quad rtnpt		# Top of stack: Holds return point
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FC1" id="P7000497027000000000000000042FC1">This program uses two initialized words in memory. The first word (M<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FC2" id="P7000497027000000000000000042FC2">mem</code>) holds the address of the second (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FC3" id="P7000497027000000000000000042FC3">stack</code>--the desired stack pointer). The second word holds the address of the desired return point for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FC4" id="P7000497027000000000000000042FC4">ret</code> instruction. The program loads the stack pointer into <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FC5" id="P7000497027000000000000000042FC5">%rsp</code> and executes the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FC6" id="P7000497027000000000000000042FC6">ret</code> instruction.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004869" id="P7000497027000000000000000004869"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FC7" epub:type="title" id="P7000497027000000000000000042FC7"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004530"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.39 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004525">463</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FC8" id="P7000497027000000000000000042FC8">From <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004493"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.66</span></a>, we can see that pipeline register D must be stalled for a load/use hazard:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FC9" id="P7000497027000000000000000042FC9">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FCA" id="P7000497027000000000000000042FCA">bool D_stall =
	# Conditions for a load/use hazard
	E_icode in { IMRMOVQ, IPOPQ } &amp;&amp;
	E_dstM in { d_srcA, d_srcB };
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P700049702700000000000000000486E" id="P700049702700000000000000000486E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FCB" epub:type="title" id="P7000497027000000000000000042FCB"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004539"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.40 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004535">464</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FCC" id="P7000497027000000000000000042FCC">From <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004493"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">4.66</span></a>, we can see that pipeline register E must be set to bubble for a load/use hazard or for a mispredicted branch:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FCD" id="P7000497027000000000000000042FCD">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FCE" id="P7000497027000000000000000042FCE">bool E_bubble =
	# Mispredicted branch
	(E_icode == IJXX &amp;&amp; !e_Cnd) ||
	# Conditions for a load/use hazard
	E_icode in { IMRMOVQ, IPOPQ } &amp;&amp;
	 E_dstM in { d_srcA, d_srcB};
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004873" id="P7000497027000000000000000004873"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FCF" epub:type="title" id="P7000497027000000000000000042FCF"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P700049702700000000000000000453C"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.41 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004535">464</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FD0" id="P7000497027000000000000000042FD0">This control requires examining the code of the executing instruction and checking for exceptions further down the pipeline.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FD1" id="P7000497027000000000000000042FD1">
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FD2" id="P7000497027000000000000000042FD2">## Should the condition codes be updated?
bool set_cc = E_icode == IOPQ &amp;&amp;
	# State changes only during normal operation
	!m_stat in { SADR, SINS, SHLT } &amp;&amp; !W_stat in { SADR, SINS, SHLT };
</code>
</pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004878" id="P7000497027000000000000000004878"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FD3" epub:type="title" id="P7000497027000000000000000042FD3"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004540"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.42 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004535">464</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FD4" id="P7000497027000000000000000042FD4">Injecting a bubble into the memory stage on the next cycle involves checking for an exception in either the memory or the write-back stage during the current cycle.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FD5" id="P7000497027000000000000000042FD5"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter04.xhtml#P700049702700000000000000000487C" epub:type="pagebreak" id="P700049702700000000000000000487C" title="494"></span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FD6" id="P7000497027000000000000000042FD6"># Start injecting bubbles as soon as exception passes through memory stage<br class="pcalibre1 pcalibre2 pcalibre7"/>
bool M_bubble = m_stat in { SADR, SINS, SHLT } || W_stat in { SADR, SINS, SHLT };
</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FD7" id="P7000497027000000000000000042FD7">For stalling the write-back stage, we check only the status of the instruction in this stage. If we also stalled when an excepting instruction was in the memory stage, then this instruction would not be able to enter the write-back stage.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FD8" id="P7000497027000000000000000042FD8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FD9" id="P7000497027000000000000000042FD9">bool W_stall = W_stat in { SADR, SINS, SHLT };</code></pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004881" id="P7000497027000000000000000004881"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FDA" epub:type="title" id="P7000497027000000000000000042FDA"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P700049702700000000000000000459B"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.43 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004599">468</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FDB" id="P7000497027000000000000000042FDB">We would then have a misprediction frequency of 0.35, giving <i class="pcalibre17 pcalibre2 pcalibre1">mp</i> = 0.20 × 0.35 × 2 = 0.14, giving an overall CPI of 1.25. This seems like a fairly marginal gain, but it would be worthwhile if the cost of implementing the new branch prediction strategy were not too high.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter04.xhtml#P7000497027000000000000000004884" id="P7000497027000000000000000004884"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FDC" epub:type="title" id="P7000497027000000000000000042FDC"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000041EB_split_002.xhtml#P700049702700000000000000000459E"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">4.44 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000041EB_split_002.xhtml#P7000497027000000000000000004599">468</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FDD" id="P7000497027000000000000000042FDD">This simplified analysis, where we focus on the inner loop, is a useful way to estimate program performance. As long as the array is sufficiently large, the time spent in other parts of the code will be negligible.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter04.xhtml#P7000497027000000000000000042FDE" id="P7000497027000000000000000042FDE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FDF" id="P7000497027000000000000000042FDF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042FE0" id="P7000497027000000000000000042FE0">The inner loop of the code using the conditional jump has 11 instructions, all of which are executed when the array element is zero or negative, and 10 of which are executed when the array element is positive. The average is 10.5. The inner loop of the code using the conditional move has 10 instructions, all of which are executed every time.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FE1" id="P7000497027000000000000000042FE1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042FE2" id="P7000497027000000000000000042FE2">The loop-closing jump will be predicted correctly, except when the loop terminates. For a very long array, this one misprediction will have a negligible effect on the performance. The only other source of bubbles for the jump-based code is the conditional jump, depending on whether or not the array element is positive. This will cause two bubbles, but it only occurs 50% of the time, so the average is 1.0. There are no bubbles in the conditional move code.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter04.xhtml#P7000497027000000000000000042FE3" id="P7000497027000000000000000042FE3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter04.xhtml#P7000497027000000000000000042FE4" id="P7000497027000000000000000042FE4">Our conditional jump code requires an average of 10.5 + 1.0 = 11.5 cycles per array element (11 cycles in the best case and 12 cycles in the worst), while our conditional move code requires 10.0 cycles in all cases.</p></li>
</ol>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter04.xhtml#P7000497027000000000000000042FE5" id="P7000497027000000000000000042FE5">Our pipeline has a branch misprediction penalty of only two cycles—far better than those for the deep pipelines of higher-performance processors. As a result, using conditional moves does not affect program performance very much.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Chapter 6 The Memory Hierarchy</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="chapter" id="P7000497027000000000000000005190"><header class="pcalibre1 pcalibre2 pcalibre48"><h1 class="pcalibre1 pcalibre2 pcalibre49" data-uri="chapter06.xhtml#P700049702700000000000000004392B" epub:type="title" id="P700049702700000000000000004392B"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter06.xhtml#P7000497027000000000000000005192" epub:type="pagebreak" id="P7000497027000000000000000005192" title="579"></span><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre50 pcalibre2">6 </span>The Memory Hierarchy</h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" id="d9e116578">
<nav class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter06.xhtml#P700049702700000000000000004392C" epub:type="toc" id="P700049702700000000000000004392C">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter06.xhtml#P700049702700000000000000004392D" id="P700049702700000000000000004392D">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter06.xhtml#P700049702700000000000000004392E" id="P700049702700000000000000004392E">
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter06.xhtml#P700049702700000000000000004392F" id="P700049702700000000000000004392F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P7000497027000000000000000043930" id="P7000497027000000000000000043930"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000051B5.xhtml#P70004970270000000000000000051B5"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">6.1 </span>Storage Technologies </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">581</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter06.xhtml#P7000497027000000000000000043931" id="P7000497027000000000000000043931"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P7000497027000000000000000043932" id="P7000497027000000000000000043932"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000005435.xhtml#P7000497027000000000000000005435"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">6.2 </span>Locality </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">604</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter06.xhtml#P7000497027000000000000000043933" id="P7000497027000000000000000043933"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P7000497027000000000000000043934" id="P7000497027000000000000000043934"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000054EF.xhtml#P70004970270000000000000000054EF"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">6.3 </span>The Memory Hierarchy </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">609</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter06.xhtml#P7000497027000000000000000043935" id="P7000497027000000000000000043935"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P7000497027000000000000000043936" id="P7000497027000000000000000043936"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000556F.xhtml#P700049702700000000000000000556F"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">6.4 </span>Cache Memories </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">614</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter06.xhtml#P7000497027000000000000000043937" id="P7000497027000000000000000043937"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P7000497027000000000000000043938" id="P7000497027000000000000000043938"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000005915.xhtml#P7000497027000000000000000005915"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">6.5 </span>Writing Cache-Friendly Code </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">633</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter06.xhtml#P7000497027000000000000000043939" id="P7000497027000000000000000043939"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P700049702700000000000000004393A" id="P700049702700000000000000004393A"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000005A45.xhtml#P7000497027000000000000000005A45"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">6.6 </span>Putting It Together: The Impact of Caches on Program Performance </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">639</span></a></p></li>
</ol></div>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter06.xhtml#P700049702700000000000000004393B" id="P700049702700000000000000004393B">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter06.xhtml#P700049702700000000000000004393C" id="P700049702700000000000000004393C">
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter06.xhtml#P700049702700000000000000004393D" id="P700049702700000000000000004393D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P700049702700000000000000004393E" id="P700049702700000000000000004393E"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000005B21.xhtml#P7000497027000000000000000005B21"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">6.7 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary</span> </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">648</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter06.xhtml#P700049702700000000000000004393F" id="P700049702700000000000000004393F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P7000497027000000000000000043940" id="P7000497027000000000000000043940"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000005B27.xhtml#P7000497027000000000000000005B27"><span class="pcalibre1 pcalibre2" epub:type="title">Bibliographic Notes </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">648</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter06.xhtml#P7000497027000000000000000043941" id="P7000497027000000000000000043941"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P7000497027000000000000000043942" id="P7000497027000000000000000043942"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000005B2F.xhtml#P7000497027000000000000000005B2F"><span class="pcalibre1 pcalibre2" epub:type="title">Homework Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">649</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter06.xhtml#P7000497027000000000000000043943" id="P7000497027000000000000000043943"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter06.xhtml#P7000497027000000000000000043944" id="P7000497027000000000000000043944"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000005E52.xhtml#P7000497027000000000000000005E52"><span class="pcalibre1 pcalibre2" epub:type="title">Solutions to Practice Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">660</span></a></p></li>
</ol>
</div>
</nav>
<section class="pcalibre1 pcalibre2 pcalibre51" data-uri="chapter06.xhtml#P7000497027000000000000000043945" epub:type="introduction" id="P7000497027000000000000000043945">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter06.xhtml#P7000497027000000000000000043946" id="P7000497027000000000000000043946"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter06.xhtml#P70004970270000000000000000051AE" epub:type="pagebreak" id="P70004970270000000000000000051AE" title="580"></span>To this point in our study of systems, we have relied on a simple model of a computer system as a CPU that executes instructions and a memory system that holds instructions and data for the CPU. In our simple model, the memory system is a linear array of bytes, and the CPU can access each memory location in a constant amount of time. While this is an effective model up to a point, it does not reflect the way that modern systems really work.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter06.xhtml#P7000497027000000000000000043947" id="P7000497027000000000000000043947">In practice, a <i class="pcalibre17 pcalibre2 pcalibre1">memory system</i> is a hierarchy of storage devices with different capacities, costs, and access times. CPU registers hold the most frequently used data. Small, fast <i class="pcalibre17 pcalibre2 pcalibre1">cache memories</i> nearby the CPU act as staging areas for a subset of the data and instructions stored in the relatively slow main memory. The main memory stages data stored on large, slow disks, which in turn often serve as staging areas for data stored on the disks or tapes of other machines connected by networks.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter06.xhtml#P7000497027000000000000000043948" id="P7000497027000000000000000043948">Memory hierarchies work because well-written programs tend to access the storage at any particular level more frequently than they access the storage at the next lower level. So the storage at the next level can be slower, and thus larger and cheaper per bit. The overall effect is a large pool of memory that costs as much as the cheap storage near the bottom of the hierarchy but that serves data to programs at the rate of the fast storage near the top of the hierarchy.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter06.xhtml#P7000497027000000000000000043949" id="P7000497027000000000000000043949">As a programmer, you need to understand the memory hierarchy because it has a big impact on the performance of your applications. If the data your program needs are stored in a CPU register, then they can be accessed in 0 cycles during the execution of the instruction. If stored in a cache, 4 to 75 cycles. If stored in main memory, hundreds of cycles. And if stored in disk, tens of millions of cycles!</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter06.xhtml#P700049702700000000000000004394A" id="P700049702700000000000000004394A">Here, then, is a fundamental and enduring idea in computer systems: if you understand how the system moves data up and down the memory hierarchy, then you can write your application programs so that their data items are stored higher in the hierarchy, where the CPU can access them more quickly.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter06.xhtml#P700049702700000000000000004394B" id="P700049702700000000000000004394B">This idea centers around a fundamental property of computer programs known as <i class="pcalibre17 pcalibre2 pcalibre1">locality.</i> Programs with good locality tend to access the same set of data items over and over again, or they tend to access sets of nearby data items. Programs with good locality tend to access more data items from the upper levels of the memory hierarchy than programs with poor locality, and thus run faster. For example, on our Core i7 system, the running times of different matrix multiplication kernels that perform the same number of arithmetic operations, but have different degrees of locality, can vary by a factor of almost 40!</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter06.xhtml#P700049702700000000000000004394C" id="P700049702700000000000000004394C">In this chapter, we will look at the basic storage technologies—SRAM memory, DRAM memory, ROM memory, and rotating and solid state disks—and describe how they are organized into hierarchies. In particular, we focus on the cache memories that act as staging areas between the CPU and main memory, because they have the most impact on application program performance. We show you how to analyze your C programs for locality, and we introduce techniques for improving the locality in your programs. You will also learn an interesting way to characterize the performance of the memory hierarchy on a particular machine as a "memory mountain" that shows read access times as a function of locality.</p>
</section>
</section>
<!--EOF:P70004970270000000000000000051B5-->
<!--EOF:P7000497027000000000000000005435-->
<!--EOF:P70004970270000000000000000054EF-->
<!--EOF:P700049702700000000000000000556F-->
<!--EOF:P7000497027000000000000000005915-->
<!--EOF:P7000497027000000000000000005A45-->
<!--EOF:P7000497027000000000000000005B21-->
<!--EOF:P7000497027000000000000000005B27-->
<!--EOF:P7000497027000000000000000005B2F-->
<!--EOF:P7000497027000000000000000005E52-->
</section></body></html>
