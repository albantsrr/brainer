<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Chapter 10 System-Level I/O</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="chapter" id="P7000497027000000000000000007867"><header class="pcalibre1 pcalibre2 pcalibre48"><h1 class="pcalibre1 pcalibre2 pcalibre49" data-uri="chapter10.xhtml#P7000497027000000000000000046333" epub:type="title" id="P7000497027000000000000000046333"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007869" epub:type="pagebreak" id="P7000497027000000000000000007869" title="889"></span><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre50 pcalibre2">10 </span>System-Level I/O</h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" id="d9e163213">
<nav class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000046334" epub:type="toc" id="P7000497027000000000000000046334">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter10.xhtml#P7000497027000000000000000046335" id="P7000497027000000000000000046335">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046336" id="P7000497027000000000000000046336">
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P7000497027000000000000000046337" id="P7000497027000000000000000046337"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046338" id="P7000497027000000000000000046338"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007899.xhtml#P7000497027000000000000000007899"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.1 </span>Unix I/O </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">890</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P7000497027000000000000000046339" id="P7000497027000000000000000046339"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004633A" id="P700049702700000000000000004633A"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000078AD.xhtml#P70004970270000000000000000078AD"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.2 </span>Files </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">891</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P700049702700000000000000004633B" id="P700049702700000000000000004633B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004633C" id="P700049702700000000000000004633C"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000078E1.xhtml#P70004970270000000000000000078E1"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.3 </span>Opening and Closing Files </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">893</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P700049702700000000000000004633D" id="P700049702700000000000000004633D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004633E" id="P700049702700000000000000004633E"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007939.xhtml#P7000497027000000000000000007939"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.4 </span>Reading and Writing Files </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">895</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P700049702700000000000000004633F" id="P700049702700000000000000004633F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046340" id="P7000497027000000000000000046340"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007975.xhtml#P7000497027000000000000000007975"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.5 </span>Robust Reading and Writing with the Rio Package </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">897</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P7000497027000000000000000046341" id="P7000497027000000000000000046341"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046342" id="P7000497027000000000000000046342"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007A14.xhtml#P7000497027000000000000000007A14"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.6 </span>Reading File Metadata </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">903</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P7000497027000000000000000046343" id="P7000497027000000000000000046343"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046344" id="P7000497027000000000000000046344"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007A3E.xhtml#P7000497027000000000000000007A3E"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.7 </span>Reading Directory Contents </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">905</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P7000497027000000000000000046345" id="P7000497027000000000000000046345"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046346" id="P7000497027000000000000000046346"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007A61.xhtml#P7000497027000000000000000007A61"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.8 </span>Sharing Files </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">906</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P7000497027000000000000000046347" id="P7000497027000000000000000046347"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046348" id="P7000497027000000000000000046348"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007A9B.xhtml#P7000497027000000000000000007A9B"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.9 </span>I/O Redirection </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">909</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P7000497027000000000000000046349" id="P7000497027000000000000000046349"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004634A" id="P700049702700000000000000004634A"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007ACB.xhtml#P7000497027000000000000000007ACB"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.10 </span>Standard I/O</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">911</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter10.xhtml#P700049702700000000000000004634B" id="P700049702700000000000000004634B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004634C" id="P700049702700000000000000004634C"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007AE3.xhtml#P7000497027000000000000000007AE3"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.11 </span>Putting It Together: Which I/O Functions Should I Use? </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">911</span></a></p></li>
</ol></div>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter10.xhtml#P700049702700000000000000004634D" id="P700049702700000000000000004634D">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004634E" id="P700049702700000000000000004634E">
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter10.xhtml#P700049702700000000000000004634F" id="P700049702700000000000000004634F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046350" id="P7000497027000000000000000046350"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007975.xhtml#P7000497027000000000000000007975"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">10.12 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary</span> </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">913</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter10.xhtml#P7000497027000000000000000046351" id="P7000497027000000000000000046351"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046352" id="P7000497027000000000000000046352"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007B21.xhtml#P7000497027000000000000000007B21"><span class="pcalibre1 pcalibre2" epub:type="title">Bibliographic Notes </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">914</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter10.xhtml#P7000497027000000000000000046353" id="P7000497027000000000000000046353"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046354" id="P7000497027000000000000000046354"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007B24.xhtml#P7000497027000000000000000007B24"><span class="pcalibre1 pcalibre2" epub:type="title">Homework Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">914</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter10.xhtml#P7000497027000000000000000046355" id="P7000497027000000000000000046355"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046356" id="P7000497027000000000000000046356"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007B49.xhtml#P7000497027000000000000000007B49"><span class="pcalibre1 pcalibre2" epub:type="title">Solutions to Practice Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">915</span></a></p></li>
</ol></div>
</nav>
<section class="pcalibre1 pcalibre2 pcalibre51" data-uri="chapter10.xhtml#P7000497027000000000000000046357" epub:type="introduction" id="P7000497027000000000000000046357">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046358" id="P7000497027000000000000000046358"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P700049702700000000000000000788F" epub:type="pagebreak" id="P700049702700000000000000000788F" title="890"></span>I<i class="pcalibre17 pcalibre2 pcalibre1">nput/output (I/O)</i> is the process of copying data between main memory and external devices such as disk drives, terminals, and networks. An input operation copies data from an I/O device to main memory, and an output operation copies data from memory to a device.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046359" id="P7000497027000000000000000046359">All language run-time systems provide higher-level facilities for performing I/O. For example, ANSIC provides the <i class="pcalibre17 pcalibre2 pcalibre1">standard I/O</i> library, with functions such as <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004635A" id="P700049702700000000000000004635A">printf</code> and <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004635B" id="P700049702700000000000000004635B">scanf</code> that perform buffered I/O. The C++ language provides similar functionality with its overloaded &lt;&lt; ("put to") and &gt;&gt; ("get from") operators. On Linux systems, these higher-level I/O functions are implemented using system-level <i class="pcalibre17 pcalibre2 pcalibre1">Unix I/O</i> functions provided by the kernel. Most of the time, the higher-level I/O functions work quite well and there is no need to use Unix I/O directly. So why bother learning about Unix I/O?</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004635C" id="P700049702700000000000000004635C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004635D" id="P700049702700000000000000004635D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004635E" id="P700049702700000000000000004635E"><span class="pcalibre1 pcalibre2 pcalibre41">Understanding Unix I/O will help you understand other systems concepts. </span>I/O is integral to the operation of a system, and because of this, we often encounter circular dependencies between I/O and other systems ideas. For example, I/O plays a key role in process creation and execution. Conversely, process creation plays a key role in how files are shared by different processes. Thus, to really understand I/O, you need to understand processes, and vice versa. We have already touched on aspects of I/O in our discussions of the memory hierarchy, linking and loading, processes, and virtual memory. Now that you have a better understanding of these ideas, we can close the circle and delve into I/O in more detail.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004635F" id="P700049702700000000000000004635F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046360" id="P7000497027000000000000000046360"><span class="pcalibre1 pcalibre2 pcalibre41">Sometimes you have no choice but to use Unix I/O. </span>There are some important cases where using higher-level I/O functions is either impossible or inappropriate. For example, the standard I/O library provides no way to access file metadata such as file size or file creation time. Further, there are problems with the standard I/O library that make it risky to use for network programming.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046361" id="P7000497027000000000000000046361">This chapter introduces you to the general concepts of Unix I/O and standard I/O and shows you how to use them reliably from your C programs. Besides serving as a general introduction, this chapter lays a firm foundation for our subsequent study of network programming and concurrency.</p>
</section>
</section>
<!--EOF:P7000497027000000000000000007899-->
<!--EOF:P70004970270000000000000000078AD-->
<!--EOF:P70004970270000000000000000078E1-->
<!--EOF:P7000497027000000000000000007939-->
<!--EOF:P7000497027000000000000000007975-->
<!--EOF:P7000497027000000000000000007A14-->
<!--EOF:P7000497027000000000000000007A3E-->
<!--EOF:P7000497027000000000000000007A61-->
<!--EOF:P7000497027000000000000000007A9B-->
<!--EOF:P7000497027000000000000000007ACB-->
<!--EOF:P7000497027000000000000000007AE3-->
<!--EOF:P7000497027000000000000000007B1B-->
<!--EOF:P7000497027000000000000000007B21-->
<!--EOF:P7000497027000000000000000007B24-->
<!--EOF:P7000497027000000000000000007B49-->
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.1 Unix I/O</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007899"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046362" epub:type="title" id="P7000497027000000000000000046362"><span class="pcalibre1 pcalibre21 pcalibre2">10.1 </span>Unix I/O</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046363" id="P7000497027000000000000000046363">A Linux <i class="pcalibre17 pcalibre2 pcalibre1">file</i> is a sequence of <var class="pcalibre17 pcalibre2 pcalibre1">m</var> bytes:</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter10.xhtml#P7000497027000000000000000046364" id="P7000497027000000000000000046364">
<m:math altimg="../images/ch10-1.png" altimg-height="19" altimg-width="221" alttext="" data-uri="" display="block"><m:mrow><m:msub><m:mi>B</m:mi><m:mn>0</m:mn></m:msub><m:mo>,</m:mo><m:mtext> </m:mtext><m:msub><m:mi>B</m:mi><m:mn>1</m:mn></m:msub><m:mo>,</m:mo><m:mtext> </m:mtext><m:mo>…</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:msub><m:mi>B</m:mi><m:mi>k</m:mi></m:msub><m:mo>,</m:mo><m:mtext> </m:mtext><m:mo>…</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:msub><m:mi>B</m:mi><m:mrow><m:mi>m</m:mi><m:mo>-</m:mo><m:mn>1</m:mn></m:mrow></m:msub></m:mrow></m:math>
</div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046365" id="P7000497027000000000000000046365">All I/O devices, such as networks, disks, and terminals, are modeled as files, and all input and output is performed by reading and writing the appropriate files. This elegant mapping of devices to files allows the Linux kernel to export a simple, low-level application interface, known as <i class="pcalibre17 pcalibre2 pcalibre1">Unix I/O</i>, that enables all input and output to be performed in a uniform and consistent way:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046366" id="P7000497027000000000000000046366">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046367" id="P7000497027000000000000000046367"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046368" id="P7000497027000000000000000046368"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P70004970270000000000000000078A1" epub:type="pagebreak" id="P70004970270000000000000000078A1" title="891"></span><span class="pcalibre1 pcalibre2 pcalibre41">Opening files. </span>An application announces its intention to access an I/O device by asking the kernel to <i class="pcalibre17 pcalibre2 pcalibre1">open</i> the corresponding file. The kernel returns a small nonnegative integer, called a <i class="pcalibre17 pcalibre2 pcalibre1">descriptor</i>, that identifies the file in all subsequent operations on the file. The kernel keeps track of all information about the open file. The application only keeps track of the descriptor.</p>
<p class="pcalibre1 pcalibre2 pcalibre42" data-uri="chapter10.xhtml#P7000497027000000000000000046369" id="P7000497027000000000000000046369">Each process created by a Linux shell begins life with three open files: <i class="pcalibre17 pcalibre2 pcalibre1">standard input</i> (descriptor 0), <i class="pcalibre17 pcalibre2 pcalibre1">standard output</i> (descriptor 1), and <i class="pcalibre17 pcalibre2 pcalibre1">standard error</i> (descriptor 2). The header file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004636A" id="P700049702700000000000000004636A">&lt;unistd.h&gt;</code> defines constants <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004636B" id="P700049702700000000000000004636B">STDIN_FILENO, STDOUT_FILENO</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004636C" id="P700049702700000000000000004636C">STDERR_FILENO</code>, which can be used instead of the explicit descriptor values.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004636D" id="P700049702700000000000000004636D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P700049702700000000000000004636E" id="P700049702700000000000000004636E"><span class="pcalibre1 pcalibre2 pcalibre41">Changing the current file position. </span>The kernel maintains a <i class="pcalibre17 pcalibre2 pcalibre1">file position k</i>, initially 0, for each open file. The file position is a byte offset from the beginning of a file. An application can set the current file position <var class="pcalibre17 pcalibre2 pcalibre1">k</var> explicitly by performing a <i class="pcalibre17 pcalibre2 pcalibre1">seek</i> operation.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004636F" id="P700049702700000000000000004636F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046370" id="P7000497027000000000000000046370"><span class="pcalibre1 pcalibre2 pcalibre41">Reading and writing files. </span>A <i class="pcalibre17 pcalibre2 pcalibre1">read</i> operation copies <var class="pcalibre17 pcalibre2 pcalibre1">n</var> &gt; 0 bytes from a file to memory, starting at the current file position <var class="pcalibre17 pcalibre2 pcalibre1">k</var> and then incrementing <var class="pcalibre17 pcalibre2 pcalibre1">k</var> by <var class="pcalibre17 pcalibre2 pcalibre1">n</var>. Given a file with a size of <var class="pcalibre17 pcalibre2 pcalibre1">m</var> bytes, performing a read operation when <var class="pcalibre17 pcalibre2 pcalibre1">k</var> ≥ <var class="pcalibre17 pcalibre2 pcalibre1">m</var> triggers a condition known as <i class="pcalibre17 pcalibre2 pcalibre1">end-of-file (EOF)</i>, which can be detected by the application. There is no explicit "EOF character" at the end of a file.</p>
<p class="pcalibre1 pcalibre2 pcalibre42" data-uri="chapter10.xhtml#P7000497027000000000000000046371" id="P7000497027000000000000000046371">Similarly, a <i class="pcalibre17 pcalibre2 pcalibre1">write</i> operation copies <var class="pcalibre17 pcalibre2 pcalibre1">n</var> &gt; 0 bytes from memory to a file, starting at the current file position <var class="pcalibre17 pcalibre2 pcalibre1">k</var> and then updating <var class="pcalibre17 pcalibre2 pcalibre1">k</var>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046372" id="P7000497027000000000000000046372"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046373" id="P7000497027000000000000000046373"><span class="pcalibre1 pcalibre2 pcalibre41">Closing files. </span>When an application has finished accessing a file, it informs the kernel by asking it to <i class="pcalibre17 pcalibre2 pcalibre1">close</i> the file. The kernel responds by freeing the data structures it created when the file was opened and restoring the descriptor to a pool of available descriptors. When a process terminates for any reason, the kernel closes all open files and frees their memory resources.</p></li>
</ul>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.2 Files</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000078AD"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046374" epub:type="title" id="P7000497027000000000000000046374"><span class="pcalibre1 pcalibre21 pcalibre2">10.2 </span>Files</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046375" id="P7000497027000000000000000046375">Each Linux file has a <i class="pcalibre17 pcalibre2 pcalibre1">type</i> that indicates its role in the system:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046376" id="P7000497027000000000000000046376">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046377" id="P7000497027000000000000000046377"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046378" id="P7000497027000000000000000046378">A <i class="pcalibre17 pcalibre2 pcalibre1">regular file</i> contains arbitrary data. Application programs often distinguish between <i class="pcalibre17 pcalibre2 pcalibre1">text files</i>, which are regular files that contain only ASCII or Unicode characters, and <i class="pcalibre17 pcalibre2 pcalibre1">binary files</i>, which are everything else. To the kernel there is no difference between text and binary files.</p>
<p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter10.xhtml#P7000497027000000000000000046379" id="P7000497027000000000000000046379">A Linux text file consists of a sequence of <i class="pcalibre17 pcalibre2 pcalibre1">text lines</i>, where each line is a sequence of characters terminated by a <i class="pcalibre17 pcalibre2 pcalibre1">newline</i> character (`\n'). The newline character is the same as the ASCII line feed character (LF) and has a numeric value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004637A" id="P700049702700000000000000004637A">0x0a</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004637B" id="P700049702700000000000000004637B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004637C" id="P700049702700000000000000004637C">A <i class="pcalibre17 pcalibre2 pcalibre1">directory</i> is a file consisting of an array of <i class="pcalibre17 pcalibre2 pcalibre1">links</i>, where each link maps a <i class="pcalibre17 pcalibre2 pcalibre1">filename</i> to a file, which may be another directory. Each directory contains at</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000078B7" id="P70004970270000000000000000078B7"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter10.xhtml#P700049702700000000000000004637D" epub:type="title" id="P700049702700000000000000004637D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P70004970270000000000000000078B9" epub:type="pagebreak" id="P70004970270000000000000000078B9" title="892"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>End of line (EOL) indicators</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004637E" id="P700049702700000000000000004637E">One of the clumsy aspects of working with text files is that different systems use different characters to mark the end of a line. Linux and Mac OS X use `\n' (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004637F" id="P700049702700000000000000004637F">0xa</code>), which is the ASCII line feed (LF) character. However, MS Windows and Internet protocols such as HTTP use the sequence `\r\n' (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046380" id="P7000497027000000000000000046380">0xd 0xa</code>), which is the ASCII carriage return (CR) character followed by a line feed (LF). If you create a file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046381" id="P7000497027000000000000000046381">foo.txt</code> in Windows and then view it in a Linux text editor, you'll see an annoying <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046382" id="P7000497027000000000000000046382">⁁M</code> at the end of each line, which is how Linux tools display the CR character. You can remove these unwanted CR characters from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046383" id="P7000497027000000000000000046383">foo.txt</code> in place by running the following command:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046384" id="P7000497027000000000000000046384"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046385" id="P7000497027000000000000000046385">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">perl -pi -e "s/\r\n/\n/g" foo.txt</i></code></pre>
</aside>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046386" id="P7000497027000000000000000046386">least two entries: . (dot) is a link to the directory itself, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046387" id="P7000497027000000000000000046387">..</code> (dot-dot) is a link to the <i class="pcalibre17 pcalibre2 pcalibre1">parent directory</i> in the directory hierarchy (see below). You can create a directory with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046388" id="P7000497027000000000000000046388">mkdir</code> command, view its contents with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046389" id="P7000497027000000000000000046389">ls</code>, and delete it with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004638A" id="P700049702700000000000000004638A">rmdir</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004638B" id="P700049702700000000000000004638B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004638C" id="P700049702700000000000000004638C">A <i class="pcalibre17 pcalibre2 pcalibre1">socket</i> is a file that is used to communicate with another process across a network (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007CC1.xhtml#P7000497027000000000000000007CC1"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">11.4</span></a>).</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004638D" id="P700049702700000000000000004638D">Other file types include <i class="pcalibre17 pcalibre2 pcalibre1">named pipes</i>, <i class="pcalibre17 pcalibre2 pcalibre1">symbolic links</i>, and <i class="pcalibre17 pcalibre2 pcalibre1">character</i> and <i class="pcalibre17 pcalibre2 pcalibre1">block devices</i>, which are beyond our scope.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004638E" id="P700049702700000000000000004638E">The Linux kernel organizes all files in a single <i class="pcalibre17 pcalibre2 pcalibre1">directory hierarchy</i> anchored by the <i class="pcalibre17 pcalibre2 pcalibre1">root directory</i> named / (slash). Each file in the system is a direct or indirect descendant of the root directory. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000078CD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.1</span></a> shows a portion of the directory hierarchy on our Linux system.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004638F" id="P700049702700000000000000004638F">As part of its context, each process has a <i class="pcalibre17 pcalibre2 pcalibre1">current working directory</i> that identifies its current location in the directory hierarchy. You can change the shell's current working directory with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046390" id="P7000497027000000000000000046390">cd</code> command.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P70004970270000000000000000078CD" id="P70004970270000000000000000078CD">
<img alt="A diagram illustrates a portion of the Linux directory hierarchy." class="pcalibre1 calibre82 pcalibre2" data-uri="P700049702700000000000000000B7B3" id="P7000497027000000000000000046391" src="Images/chapter-09-image-01.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046392" id="P7000497027000000000000000046392"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P7000497027000000000000000046393" epub:type="title" id="P7000497027000000000000000046393"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.1 </span>Portion of the Linux directory hierarchy.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter10.xhtml#P7000497027000000000000000046394" id="P7000497027000000000000000046394"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046395" id="P7000497027000000000000000046395">A trailing slash denotes a directory.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter10.xhtml#P70004970270000000000000000266F4" id="P70004970270000000000000000266F4">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046396" id="P7000497027000000000000000046396">A diagram branches as per the following list.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter10.xhtml#P7000497027000000000000000046397" id="P7000497027000000000000000046397">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046398" id="P7000497027000000000000000046398"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046399" id="P7000497027000000000000000046399">/</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter10.xhtml#P700049702700000000000000004639A" id="P700049702700000000000000004639A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004639B" id="P700049702700000000000000004639B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004639C" id="P700049702700000000000000004639C">bin/</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004639D" id="P700049702700000000000000004639D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004639E" id="P700049702700000000000000004639E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004639F" id="P700049702700000000000000004639F">bash</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463A0" id="P70004970270000000000000000463A0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463A1" id="P70004970270000000000000000463A1">dev/</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463A2" id="P70004970270000000000000000463A2">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463A3" id="P70004970270000000000000000463A3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463A4" id="P70004970270000000000000000463A4">ttyl</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463A5" id="P70004970270000000000000000463A5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463A6" id="P70004970270000000000000000463A6">etc/</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463A7" id="P70004970270000000000000000463A7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463A8" id="P70004970270000000000000000463A8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463A9" id="P70004970270000000000000000463A9">group</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463AA" id="P70004970270000000000000000463AA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463AB" id="P70004970270000000000000000463AB">passwd</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463AC" id="P70004970270000000000000000463AC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463AD" id="P70004970270000000000000000463AD">home/</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463AE" id="P70004970270000000000000000463AE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463AF" id="P70004970270000000000000000463AF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463B0" id="P70004970270000000000000000463B0">droh/</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter10.xhtml#P70004970270000000000000000463B1" id="P70004970270000000000000000463B1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463B2" id="P70004970270000000000000000463B2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463B3" id="P70004970270000000000000000463B3">hello.c</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463B4" id="P70004970270000000000000000463B4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463B5" id="P70004970270000000000000000463B5">bryant</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463B6" id="P70004970270000000000000000463B6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463B7" id="P70004970270000000000000000463B7">usr/</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463B8" id="P70004970270000000000000000463B8">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463B9" id="P70004970270000000000000000463B9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463BA" id="P70004970270000000000000000463BA">include/</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter10.xhtml#P70004970270000000000000000463BB" id="P70004970270000000000000000463BB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463BC" id="P70004970270000000000000000463BC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463BD" id="P70004970270000000000000000463BD">stdio.h</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463BE" id="P70004970270000000000000000463BE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463BF" id="P70004970270000000000000000463BF">sys/</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter10.xhtml#P70004970270000000000000000463C0" id="P70004970270000000000000000463C0">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463C1" id="P70004970270000000000000000463C1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463C2" id="P70004970270000000000000000463C2">unistd.h</p></li>
</ul></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463C3" id="P70004970270000000000000000463C3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463C4" id="P70004970270000000000000000463C4">bin/</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter10.xhtml#P70004970270000000000000000463C5" id="P70004970270000000000000000463C5">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463C6" id="P70004970270000000000000000463C6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463C7" id="P70004970270000000000000000463C7">vim</p></li>
</ul></li>
</ul>
</li>
</ul>
</li></ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463C8" id="P70004970270000000000000000463C8"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P70004970270000000000000000078D4" epub:type="pagebreak" id="P70004970270000000000000000078D4" title="893"></span>Locations in the directory hierarchy are specified by <i class="pcalibre17 pcalibre2 pcalibre1">pathnames</i>. A pathname is a string consisting of an optional slash followed by a sequence of filenames separated by slashes. Pathnames have two forms:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463C9" id="P70004970270000000000000000463C9">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463CA" id="P70004970270000000000000000463CA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463CB" id="P70004970270000000000000000463CB">An <i class="pcalibre17 pcalibre2 pcalibre1">absolute pathname</i> starts with a slash and denotes a path from the root node. For example, in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000078CD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.1</span></a>, the absolute pathname for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463CC" id="P70004970270000000000000000463CC">hello.c</code> is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463CD" id="P70004970270000000000000000463CD">/home/droh/hello.c</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463CE" id="P70004970270000000000000000463CE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000463CF" id="P70004970270000000000000000463CF">A <i class="pcalibre17 pcalibre2 pcalibre1">relative pathname</i> starts with a filename and denotes a path from the current working directory. For example, in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000078CD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.1</span></a>, if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463D0" id="P70004970270000000000000000463D0">/home/droh</code> is the current working directory, then the relative pathname for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463D1" id="P70004970270000000000000000463D1">hello.c</code> is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463D2" id="P70004970270000000000000000463D2">./hello.c.</code> On the other hand, if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463D3" id="P70004970270000000000000000463D3">/home/bryant</code> is the current working directory, then the relative pathname is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463D4" id="P70004970270000000000000000463D4">../home/droh/hello.c.</code></p></li>
</ul>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.3 Opening and Closing Files</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000078E1"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P70004970270000000000000000463D5" epub:type="title" id="P70004970270000000000000000463D5"><span class="pcalibre1 pcalibre21 pcalibre2">10.3 </span>Opening and Closing Files</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463D6" id="P70004970270000000000000000463D6">A process opens an existing file or creates a new file by calling the open function.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463D7" id="P70004970270000000000000000463D7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463D8" id="P70004970270000000000000000463D8">
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
int open(char *filename, int flags, mode_t mode);
				Returns: new file descriptor if OK, −1 on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463D9" id="P70004970270000000000000000463D9">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463DA" id="P70004970270000000000000000463DA">open</code> function converts a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463DB" id="P70004970270000000000000000463DB">filename</code> to a file descriptor and returns the descriptor number. The descriptor returned is always the smallest descriptor that is not currently open in the process. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463DC" id="P70004970270000000000000000463DC">flags</code> argument indicates how the process intends to access the file:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463DD" id="P70004970270000000000000000463DD">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463DE" id="P70004970270000000000000000463DE"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P70004970270000000000000000463DF" id="P70004970270000000000000000463DF">O_RDONLY. Reading only</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463E0" id="P70004970270000000000000000463E0"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P70004970270000000000000000463E1" id="P70004970270000000000000000463E1">O_WRONLY. Writing only</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463E2" id="P70004970270000000000000000463E2"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P70004970270000000000000000463E3" id="P70004970270000000000000000463E3">O_RDWR. Reading and writing</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463E4" id="P70004970270000000000000000463E4">For example, here is how to open an existing file for reading:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463E5" id="P70004970270000000000000000463E5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463E6" id="P70004970270000000000000000463E6">fd = Open("foo.txt", O_RDONLY, 0);</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463E7" id="P70004970270000000000000000463E7">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463E8" id="P70004970270000000000000000463E8">flags</code> argument can also be <span class="pcalibre1 pcalibre29 pcalibre2">or</span>ed with one or more bit masks that provide additional instructions for writing:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000463E9" id="P70004970270000000000000000463E9">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463EA" id="P70004970270000000000000000463EA"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P70004970270000000000000000463EB" id="P70004970270000000000000000463EB">O_CREAT. If the file doesn't exist, then create a <i class="pcalibre17 pcalibre2 pcalibre1">truncated</i> (empty) version of it.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463EC" id="P70004970270000000000000000463EC"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P70004970270000000000000000463ED" id="P70004970270000000000000000463ED">O_TRUNC. If the file already exists, then truncate it.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000463EE" id="P70004970270000000000000000463EE"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P70004970270000000000000000463EF" id="P70004970270000000000000000463EF">O_APPEND. Before each write operation, set the file position to the end of the file.</p></li>
</ul>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P70004970270000000000000000078FD" id="P70004970270000000000000000078FD">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P70004970270000000000000000078FE" epub:type="pagebreak" id="P70004970270000000000000000078FE" title="894"></span>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter10.xhtml#P70004970270000000000000000463F0" id="P70004970270000000000000000463F0">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter10.xhtml#P70004970270000000000000000463F1" id="P70004970270000000000000000463F1">Mask</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter10.xhtml#P70004970270000000000000000463F2" id="P70004970270000000000000000463F2">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463F3" id="P70004970270000000000000000463F3">S_IRUSR</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463F4" id="P70004970270000000000000000463F4">User (owner) can read this file</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463F5" id="P70004970270000000000000000463F5">S_IWUSR</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463F6" id="P70004970270000000000000000463F6">User (owner) can write this file</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463F7" id="P70004970270000000000000000463F7">S_IXUSR</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463F8" id="P70004970270000000000000000463F8">User (owner) can execute this file</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463F9" id="P70004970270000000000000000463F9">S_IRGRP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463FA" id="P70004970270000000000000000463FA">Members of the owner's group can read this file</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463FB" id="P70004970270000000000000000463FB">S_IWGRP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463FC" id="P70004970270000000000000000463FC">Members of the owner's group can write this file</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463FD" id="P70004970270000000000000000463FD">S_IXGRP</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463FE" id="P70004970270000000000000000463FE">Members of the owner's group can execute this file</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P70004970270000000000000000463FF" id="P70004970270000000000000000463FF">S_IROTH</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P7000497027000000000000000046400" id="P7000497027000000000000000046400">Others (anyone) can read this file</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P7000497027000000000000000046401" id="P7000497027000000000000000046401">S_IWOTH</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P7000497027000000000000000046402" id="P7000497027000000000000000046402">Others (anyone) can write this file</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P7000497027000000000000000046403" id="P7000497027000000000000000046403">S_IXOTH</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter10.xhtml#P7000497027000000000000000046404" id="P7000497027000000000000000046404">Others (anyone) can execute this file</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046405" id="P7000497027000000000000000046405"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P7000497027000000000000000046406" epub:type="title" id="P7000497027000000000000000046406"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.2 </span>Access permission bits.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046407" id="P7000497027000000000000000046407"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046408" id="P7000497027000000000000000046408">Defined in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046409" id="P7000497027000000000000000046409">sys/stat.h.</code></p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004640A" id="P700049702700000000000000004640A">For example, here is how you might open an existing file with the intent of appending some data:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004640B" id="P700049702700000000000000004640B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004640C" id="P700049702700000000000000004640C">fd = Open("foo.txt", O_WRONLY|O_APPEND, 0);</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004640D" id="P700049702700000000000000004640D">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004640E" id="P700049702700000000000000004640E">mode</code> argument specifies the access permission bits of new files. The symbolic names for these bits are shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000078FD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.2</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004640F" id="P700049702700000000000000004640F">As part of its context, each process has a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046410" id="P7000497027000000000000000046410">umask</code> that is set by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046411" id="P7000497027000000000000000046411">umask</code> function. When a process creates a new file by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046412" id="P7000497027000000000000000046412">open</code> function with some <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046413" id="P7000497027000000000000000046413">mode</code> argument, then the access permission bits of the file are set to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046414" id="P7000497027000000000000000046414">mode &amp; ~umask</code>. For example, suppose we are given the following default values for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046415" id="P7000497027000000000000000046415">mode</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046416" id="P7000497027000000000000000046416">umask</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046417" id="P7000497027000000000000000046417"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046418" id="P7000497027000000000000000046418">
#define DEF_MODE S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP|S_IROTH|S_IWOTH
#define DEF_UMASK S_IWGRP|S_IWOTH
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046419" id="P7000497027000000000000000046419">Then the following code fragment creates a new file in which the owner of the file has read and write permissions, and all other users have read permissions:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004641A" id="P700049702700000000000000004641A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004641B" id="P700049702700000000000000004641B">
umask(DEF_UMASK);
fd = Open("foo.txt", O_CREAT|O_TRUNC|O_WRONLY, DEF_MODE);
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004641C" id="P700049702700000000000000004641C">Finally, a process closes an open file by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004641D" id="P700049702700000000000000004641D">close</code> function.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004641E" id="P700049702700000000000000004641E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004641F" id="P700049702700000000000000004641F">
#include &lt;unistd.h&gt;
int close(int fd);
							Returns: 0 if OK, −1 on error
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046420" id="P7000497027000000000000000046420"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007930" epub:type="pagebreak" id="P7000497027000000000000000007930" title="895"></span>Closing a descriptor that is already closed is an error.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007931" epub:type="practice" id="P7000497027000000000000000007931"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046421" epub:type="title" id="P7000497027000000000000000046421"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.1 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007B24.xhtml#P7000497027000000000000000007B41">915</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter10.xhtml#P7000497027000000000000000046422" id="P7000497027000000000000000046422">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter10.xhtml#P7000497027000000000000000046423" id="P7000497027000000000000000046423">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter10.xhtml#P7000497027000000000000000046424" id="P7000497027000000000000000046424"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046425" id="P7000497027000000000000000046425">What is the output of the following program?</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046426" id="P7000497027000000000000000046426"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046427" id="P7000497027000000000000000046427">
1	#include "csapp.h"
2	
3	int main()
4	{
5		int fd1, fd2;
6	
7		fd1 = Open("foo.txt", O_RDONLY, 0);
8		Close(fd1);
9		fd2 = Open("baz.txt", O_RDONLY, 0);
10		printf("fd2 = %d\n", fd2);
11		exit(0);
12	}
</code></pre>
</div></li>
</ol>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.4 Reading and Writing Files</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007939"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046428" epub:type="title" id="P7000497027000000000000000046428"><span class="pcalibre1 pcalibre21 pcalibre2">10.4 </span>Reading and Writing Files</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046429" id="P7000497027000000000000000046429">Applications perform input and output by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004642A" id="P700049702700000000000000004642A">read</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004642B" id="P700049702700000000000000004642B">write</code> functions, respectively.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004642C" id="P700049702700000000000000004642C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004642D" id="P700049702700000000000000004642D">
#include &lt;unistd.h&gt;
ssize_t read(int fd, void *buf, size_t n);
					Returns: number of bytes read if OK, 0 on EOF, −1 on error
ssize_t write(int fd, const void *buf, size_t n);
					Returns: number of bytes written if OK, −1 on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004642E" id="P700049702700000000000000004642E">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004642F" id="P700049702700000000000000004642F">read</code> function copies at most <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046430" id="P7000497027000000000000000046430">n</code> bytes from the current file position of descriptor <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046431" id="P7000497027000000000000000046431">fd</code> to memory location <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046432" id="P7000497027000000000000000046432">buf</code>. A return value of −1 indicates an error, and a return value of 0 indicates EOF. Otherwise, the return value indicates the number of bytes that were actually transferred.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046433" id="P7000497027000000000000000046433">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046434" id="P7000497027000000000000000046434">write</code> function copies at most <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046435" id="P7000497027000000000000000046435">n</code> bytes from memory location <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046436" id="P7000497027000000000000000046436">buf</code> to the current file position of descriptor <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046437" id="P7000497027000000000000000046437">fd</code>. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000795F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.3</span></a> shows a program that uses <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046438" id="P7000497027000000000000000046438">read</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046439" id="P7000497027000000000000000046439">write</code> calls to copy the standard input to the standard output, 1 byte at a time.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004643A" id="P700049702700000000000000004643A">Applications can explicitly modify the current file position by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004643B" id="P700049702700000000000000004643B">lseek</code> function, which is beyond our scope.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004643C" id="P700049702700000000000000004643C">In some situations, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004643D" id="P700049702700000000000000004643D">read</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004643E" id="P700049702700000000000000004643E">write</code> transfer fewer bytes than the application requests. Such <i class="pcalibre17 pcalibre2 pcalibre1">short counts</i> do <i class="pcalibre17 pcalibre2 pcalibre1">not</i> indicate an error. They occur for a number of reasons:</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000007951" id="P7000497027000000000000000007951"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter10.xhtml#P700049702700000000000000004643F" epub:type="title" id="P700049702700000000000000004643F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007953" epub:type="pagebreak" id="P7000497027000000000000000007953" title="896"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>What's the difference between <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter10.xhtml#P7000497027000000000000000046440" id="P7000497027000000000000000046440">ssize_t</code> and <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter10.xhtml#P7000497027000000000000000046441" id="P7000497027000000000000000046441">size_t?</code></h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046442" id="P7000497027000000000000000046442">You might have noticed that the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046443" id="P7000497027000000000000000046443">read</code> function has a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046444" id="P7000497027000000000000000046444">size_t</code> input argument and an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046445" id="P7000497027000000000000000046445">ssize_t</code> return value. So what's the difference between these two types? On x86-64 systems, a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046446" id="P7000497027000000000000000046446">size_t</code> is defined as an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046447" id="P7000497027000000000000000046447">unsigned long</code>, and an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046448" id="P7000497027000000000000000046448">ssize_t</code> (<i class="pcalibre17 pcalibre2 pcalibre1">signed size</i>) is defined as a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046449" id="P7000497027000000000000000046449">long</code>. The read function returns a signed size rather than an unsigned size because it must return a −1 on error. Interestingly, the possibility of returning a single −1 reduces the maximum size of a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004644A" id="P700049702700000000000000004644A">read</code> by a factor of 2.</p>
</aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P700049702700000000000000000795F" id="P700049702700000000000000000795F">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004644B" id="P700049702700000000000000004644B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004644C" id="P700049702700000000000000004644C">
1	#include "csapp.h"
2	
3	int main(void)
4	{
5		char c;
6	
7		while(Read(STDIN_FILENO, &amp;c, 1) != 0)
8			Write(STDOUT_FILENO, &amp;c, 1);
9		exit(0);
10	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P700049702700000000000000004644D" id="P700049702700000000000000004644D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P700049702700000000000000004644E" epub:type="title" id="P700049702700000000000000004644E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.3 </span>Using read and write to copy standard input to standard output 1 byte at a time.</h1></header>
</figcaption>
</figure>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004644F" id="P700049702700000000000000004644F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046450" id="P7000497027000000000000000046450"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046451" id="P7000497027000000000000000046451"><span class="pcalibre1 pcalibre2 pcalibre41">Encountering EOF on reads. </span>Suppose that we are ready to read from a file that contains only 20 more bytes from the current file position and that we are reading the file in 50-byte chunks. Then the next read will return a short count of 20, and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046452" id="P7000497027000000000000000046452">read</code> after that will signal EOF by returning a short count of 0.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046453" id="P7000497027000000000000000046453"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046454" id="P7000497027000000000000000046454"><span class="pcalibre1 pcalibre2 pcalibre41">Reading text lines from a terminal. </span>If the open file is associated with a terminal (i.e., a keyboard and display), then each <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046455" id="P7000497027000000000000000046455">read</code> function will transfer one text line at a time, returning a short count equal to the size of the text line.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046456" id="P7000497027000000000000000046456"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046457" id="P7000497027000000000000000046457"><span class="pcalibre1 pcalibre2 pcalibre41">Reading and writing network sockets. </span>If the open file corresponds to a network socket (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007CC1.xhtml#P7000497027000000000000000007CC1"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">11.4</span></a>), then internal buffering constraints and long network delays can cause <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046458" id="P7000497027000000000000000046458">read</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046459" id="P7000497027000000000000000046459">write</code> to return short counts. Short counts can also occur when you call <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004645A" id="P700049702700000000000000004645A">read</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004645B" id="P700049702700000000000000004645B">write</code> on a Linux <i class="pcalibre17 pcalibre2 pcalibre1">pipe</i>, an interprocess communication mechanism that is beyond our scope.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004645C" id="P700049702700000000000000004645C">In practice, you will never encounter short counts when you read from disk files except on EOF, and you will never encounter short counts when you write to disk files. However, if you want to build robust (reliable) network applications <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007972" epub:type="pagebreak" id="P7000497027000000000000000007972" title="897"></span>such as Web servers, then you must deal with short counts by repeatedly calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004645D" id="P700049702700000000000000004645D">read</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004645E" id="P700049702700000000000000004645E">write</code> until all requested bytes have been transferred.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.5 Robust Reading and Writing with the Rio Package</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007975"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P700049702700000000000000004645F" epub:type="title" id="P700049702700000000000000004645F"><span class="pcalibre1 pcalibre21 pcalibre2">10.5 </span>Robust Reading and Writing with the R<span class="pcalibre1 pcalibre29 pcalibre2">io</span> Package</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046460" id="P7000497027000000000000000046460">In this section, we will develop an I/O package, called the R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>(Robust I/O) package, that handles these short counts for you automatically. The R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>package provides convenient, robust, and efficient I/O in applications such as network programs that are subject to short counts. R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>provides two different kinds of functions:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046461" id="P7000497027000000000000000046461">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046462" id="P7000497027000000000000000046462"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046463" id="P7000497027000000000000000046463"><span class="pcalibre1 pcalibre2 pcalibre41">Unbuffered input and output functions. </span>These functions transfer data directly between memory and a file, with no application-level buffering. They are especially useful for reading and writing binary data to and from networks.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046464" id="P7000497027000000000000000046464"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046465" id="P7000497027000000000000000046465"><span class="pcalibre1 pcalibre2 pcalibre41">Buffered input functions. </span>These functions allow you to efficiently read text lines and binary data from a file whose contents are cached in an application-level buffer, similar to the one provided for standard I/O functions such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046466" id="P7000497027000000000000000046466">printf</code>. Unlike the buffered I/O routines presented in [110], the buffered R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>input functions are thread-safe (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000008577.xhtml#P700049702700000000000000000857A"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">12.7.1</span></a>) and can be interleaved arbitrarily on the same descriptor. For example, you can read some text lines from a descriptor, then some binary data, and then some more text lines.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046467" id="P7000497027000000000000000046467">We are presenting the R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>routines for two reasons. First, we will be using them in the network applications we develop in the next two chapters. Second, by studying the code for these routines, you will gain a deeper understanding of Unix I/O in general.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P700049702700000000000000000797F" id="P700049702700000000000000000797F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046468" epub:type="title" id="P7000497027000000000000000046468"><span class="pcalibre1 pcalibre21 pcalibre2">10.5.1 </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046469" id="P7000497027000000000000000046469">R<span class="pcalibre1 pcalibre29 pcalibre2">io</span></code> Unbuffered Input and Output Functions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004646A" id="P700049702700000000000000004646A">Applications can transfer data directly between memory and a file by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004646B" id="P700049702700000000000000004646B">rio_readn</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004646C" id="P700049702700000000000000004646C">rio_writen</code> functions.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004646D" id="P700049702700000000000000004646D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004646E" id="P700049702700000000000000004646E">
#include "csapp.h"
ssize_t rio_readn(int fd, void *usrbuf, size_t n);
ssize_t rio_writen(int fd, void *usrbuf, size_t n);
					Returns: number of bytes transferred if OK, 0 on EOF (rio_readn only), −1 on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004646F" id="P700049702700000000000000004646F">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046470" id="P7000497027000000000000000046470">rio_readn</code> function transfers up to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046471" id="P7000497027000000000000000046471">n</code> bytes from the current file position of descriptor <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046472" id="P7000497027000000000000000046472">fd</code> to memory location <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046473" id="P7000497027000000000000000046473">usrbuf</code>. Similarly, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046474" id="P7000497027000000000000000046474">rio_writen</code> function transfers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046475" id="P7000497027000000000000000046475">n</code> bytes from location <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046476" id="P7000497027000000000000000046476">usrbuf</code> to descriptor <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046477" id="P7000497027000000000000000046477">fd</code>. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046478" id="P7000497027000000000000000046478">rio_readn</code> function can only return a short count if it encounters EOF. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046479" id="P7000497027000000000000000046479">rio_writen</code> function never returns a short count. Calls to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004647A" id="P700049702700000000000000004647A">rio_readn</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004647B" id="P700049702700000000000000004647B">rio_writen</code> can be interleaved arbitrarily on the same descriptor.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004647C" id="P700049702700000000000000004647C"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007995" epub:type="pagebreak" id="P7000497027000000000000000007995" title="898"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000079BE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.4</span></a> shows the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004647D" id="P700049702700000000000000004647D">rio_readn</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004647E" id="P700049702700000000000000004647E">rio_writen</code>. Notice that each function manually restarts the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004647F" id="P700049702700000000000000004647F">read</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046480" id="P7000497027000000000000000046480">write</code> function if it is interrupted by the return from an application signal handler. To be as portable as possible, we allow for interrupted system calls and restart them when necessary.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P700049702700000000000000000799A" id="P700049702700000000000000000799A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046481" epub:type="title" id="P7000497027000000000000000046481"><span class="pcalibre1 pcalibre21 pcalibre2">10.5.2 </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046482" id="P7000497027000000000000000046482">R<span class="pcalibre1 pcalibre29 pcalibre2">io</span></code> Buffered Input Functions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046483" id="P7000497027000000000000000046483">Suppose we wanted to write a program that counts the number of lines in a text file. How might we do this? One approach is to use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046484" id="P7000497027000000000000000046484">read</code> function to transfer 1 byte at a time from the file to the user's memory, checking each byte for the newline character. The disadvantage of this approach is that it is inefficient, requiring a trap to the kernel to read each byte in the file.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046485" id="P7000497027000000000000000046485">A better approach is to call a wrapper function (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046486" id="P7000497027000000000000000046486">rio_readlineb</code>) that copies the text line from an internal <i class="pcalibre17 pcalibre2 pcalibre1">read buffer</i>, automatically making a read call to refill the buffer whenever it becomes empty. For files that contain both text lines and binary data (such as the HTTP responses described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007E82.xhtml#P7000497027000000000000000007ED4"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">11.5.3</span></a>), we also provide a buffered version of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046487" id="P7000497027000000000000000046487">rio_readn</code>, called <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046488" id="P7000497027000000000000000046488">rio_readn</code>b, that transfers raw bytes from the same read buffer as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046489" id="P7000497027000000000000000046489">rio_readlineb</code>.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004648A" id="P700049702700000000000000004648A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004648B" id="P700049702700000000000000004648B">
#include "csapp.h"
void rio_readinitb(rio_t *rp, int fd);
										Returns: nothing
ssize_t rio_readlineb(rio_t *rp, void *usrbuf, size_t maxlen);
ssize_t rio_readnb(rio_t *rp, void *usrbuf, size_t n);
					Returns: number of bytes read if OK, 0 on EOF, −1 on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004648C" id="P700049702700000000000000004648C">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004648D" id="P700049702700000000000000004648D">rio_readinitb</code> function is called once per open descriptor. It associates the descriptor <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004648E" id="P700049702700000000000000004648E">fd</code> with a read buffer of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004648F" id="P700049702700000000000000004648F">rio_t</code> at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046490" id="P7000497027000000000000000046490">rp</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046491" id="P7000497027000000000000000046491">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046492" id="P7000497027000000000000000046492">rio_readlineb</code> function reads the next text line from file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046493" id="P7000497027000000000000000046493">rp</code> (including the terminating newline character), copies it to memory location <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046494" id="P7000497027000000000000000046494">usrbuf</code>, and terminates the text line with the NULL (zero) character. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046495" id="P7000497027000000000000000046495">rio_readlineb</code> function reads at most <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046496" id="P7000497027000000000000000046496">maxlen-1</code> bytes, leaving room for the terminating NULL character. Text lines that exceed <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046497" id="P7000497027000000000000000046497">maxlen-1</code> bytes are truncated and terminated with a NULL character.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046498" id="P7000497027000000000000000046498">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046499" id="P7000497027000000000000000046499">rio_readn</code>b function reads up to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004649A" id="P700049702700000000000000004649A">n</code> bytes from file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004649B" id="P700049702700000000000000004649B">rp</code> to memory location <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004649C" id="P700049702700000000000000004649C">usrbuf</code>. Calls to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004649D" id="P700049702700000000000000004649D">rio_readlineb</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004649E" id="P700049702700000000000000004649E">rio_readnb</code> can be interleaved arbitrarily on the same descriptor. However, calls to these buffered functions should not be interleaved with calls to the unbuffered <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004649F" id="P700049702700000000000000004649F">rio_readn</code> function.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464A0" id="P70004970270000000000000000464A0">You will encounter numerous examples of the R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>functions in the remainder of this text. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000079C8"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.5</span></a> shows how to use the R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>functions to copy a text file from standard input to standard output, one line at a time.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464A1" id="P70004970270000000000000000464A1"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000079CF"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.6</span></a> shows the format of a read buffer, along with the code for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464A2" id="P70004970270000000000000000464A2">rio_readinitb</code> function that initializes it. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464A3" id="P70004970270000000000000000464A3">rio_readinitb</code> function sets up an empty read buffer and associates an open file descriptor with that buffer.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P70004970270000000000000000079BE" id="P70004970270000000000000000079BE">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P70004970270000000000000000079BF" epub:type="pagebreak" id="P70004970270000000000000000079BF" title="899"></span>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000464A4" id="P70004970270000000000000000464A4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464A5" id="P70004970270000000000000000464A5">
1	ssize_t rio_readn(int fd, void *usrbuf, size_t n)
2	{
3		size_t nleft = n;
4		ssize_t nread;
5		char *bufp = usrbuf;
6	
7		while (nleft &gt; 0) {
8			if ((nread = read(fd, bufp, nleft)) &lt; 0) {
9				if (errno == EINTR)	/* Interrupted by sig handler return */
10					nread = 0;		/* and call read() again */
11				else
12					return −1;	/* errno set by read() */
13			}
14			else if (nread == 0)
15				break;			/*EOF */
16			nleft -= nread;
17			bufp += nread;
18		}
19		return (n - nleft);			/* Return &gt;= 0 */
20	}
</code></pre>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000464A6" id="P70004970270000000000000000464A6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464A7" id="P70004970270000000000000000464A7">
1	ssize_t rio_writen(int fd, void *usrbuf, size_t n)
2	{
3		size_t nleft = n;
4		ssize_t nwritten;
5		char *bufp = usrbuf;
6	
7		while (nleft &gt; 0) {
8			if ((nwritten = write(fd, bufp, nleft)) &lt;= 0) {
9				if (errno == EINTR)	/* Interrupted by sig handler return */
10					nwritten = 0;	/* and call write() again */
11				else
12					return −1;	/* errno set by write() */
13			}
14			nleft -= nwritten;
15			bufp += nwritten;
16		}
17		return n;
18	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P70004970270000000000000000464A8" id="P70004970270000000000000000464A8"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P70004970270000000000000000464A9" epub:type="title" id="P70004970270000000000000000464A9"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.4 </span>The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464AA" id="P70004970270000000000000000464AA">rio_readn</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464AB" id="P70004970270000000000000000464AB">rio_writen</code> functions.</h1></header>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P70004970270000000000000000079C8" id="P70004970270000000000000000079C8">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464AC" id="P70004970270000000000000000464AC"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter10.xhtml#P70004970270000000000000000079CA" epub:type="pagebreak" id="P70004970270000000000000000079CA" title="900"></span></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000464AD" id="P70004970270000000000000000464AD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464AE" id="P70004970270000000000000000464AE">
1	#include "csapp.h"
2	
3	int main(int argc, char **argv)
4	{
5		int n;
6		rio_t rio;
7		char buf[MAXLINE];
8	
9		Rio_readinitb(&amp;rio, STDIN_FILENO);
10		while((n = Rio_readlineb(&amp;rio, buf, MAXLINE)) != 0)
11		Rio_writen(STDOUT_FILENO, buf, n);
12	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P70004970270000000000000000464AF" id="P70004970270000000000000000464AF"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P70004970270000000000000000464B0" epub:type="title" id="P70004970270000000000000000464B0"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.5 </span>Copying a text file from standard input to standard output.</h1></header>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P70004970270000000000000000079CF" id="P70004970270000000000000000079CF">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000464B1" id="P70004970270000000000000000464B1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464B2" id="P70004970270000000000000000464B2">
1	#define RIO_BUFSIZE 8192
2	typedef struct {
3		int rio_fd;			/* Descriptor for this internal buf */
4		int rio_cnt;			/* Unread bytes in internal buf */
5		char *rio_bufptr;		/* Next unread byte in internal buf */
6		char rio_buf[RIO_BUFSIZE];	/* Internal buffer */
7	} rio_t;
</code></pre>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000464B3" id="P70004970270000000000000000464B3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464B4" id="P70004970270000000000000000464B4">
1	void rio_readinitb(rio_t *rp, int fd)
2	{
3		rp-&gt;rio_fd = fd;
4		rp-&gt;rio_cnt = 0;
5		rp-&gt;rio_bufptr = rp-&gt;rio_buf;
6	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P70004970270000000000000000464B5" id="P70004970270000000000000000464B5"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P70004970270000000000000000464B6" epub:type="title" id="P70004970270000000000000000464B6"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.6 </span>A read buffer of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464B7" id="P70004970270000000000000000464B7">rio_t</code> and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464B8" id="P70004970270000000000000000464B8">rio_readinitb</code> function that initializes it.</h1></header>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464B9" id="P70004970270000000000000000464B9">The heart of the R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>read routines is the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464BA" id="P70004970270000000000000000464BA">rio_read</code> function shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000079E1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.7</span></a>. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464BB" id="P70004970270000000000000000464BB">rio_read</code> function is a buffered version of the Linux <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464BC" id="P70004970270000000000000000464BC">read</code> function. When <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464BD" id="P70004970270000000000000000464BD">rio_read</code> is called with a request to read <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464BE" id="P70004970270000000000000000464BE">n</code> bytes, there are <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464BF" id="P70004970270000000000000000464BF">rp-&gt;rio_cnt</code> unread bytes in the read buffer. If the buffer is empty, then it is replenished with a call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464C0" id="P70004970270000000000000000464C0">read</code>. Receiving a short count from this invocation of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464C1" id="P70004970270000000000000000464C1">read</code> is not an error; it simply has the effect of partially filling the read buffer. Once the buffer is</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P70004970270000000000000000079E1" id="P70004970270000000000000000079E1">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P70004970270000000000000000079E2" epub:type="pagebreak" id="P70004970270000000000000000079E2" title="901"></span>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000464C2" id="P70004970270000000000000000464C2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464C3" id="P70004970270000000000000000464C3">
1	static ssize_t rio_read(rio_t *rp, char *usrbuf, size_t n)
2	{
3		int cnt;
4	
5		while (rp-&gt;rio_cnt &lt;= 0) { /* Refill if buf is empty */
6			rp-&gt;rio_cnt = read(rp-&gt;rio_fd, rp-&gt;rio_buf,
7							sizeof(rp-&gt;rio_buf));
8			if (rp-&gt;rio_cnt &lt; 0) {
9				if (errno != EINTR) /* Interrupted by sig handler return */
10					return -1;
11			}
12			else if (rp-&gt;rio_cnt == 0) /* EOF */
13				return 0;
14			else
15				rp-&gt;rio_bufptr = rp-&gt;rio_buf; /* Reset buffer ptr */
16		}
17	
18		/* Copy min(n, rp-&gt;rio_cnt) bytes from internal buf to user buf */
19			cnt = n;
20		if (rp-&gt;rio_cnt &lt; n)
21		cnt = rp-&gt;rio_cnt;
22		memcpy(usrbuf, rp-&gt;rio_bufptr, cnt);
23		rp-&gt;rio_bufptr += cnt;
24		rp-&gt;rio_cnt -= cnt;
25		return cnt;
26	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P70004970270000000000000000464C4" id="P70004970270000000000000000464C4"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P70004970270000000000000000464C5" epub:type="title" id="P70004970270000000000000000464C5"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.7 </span>The internal <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464C6" id="P70004970270000000000000000464C6">rio_read</code> function.</h1></header>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464C7" id="P70004970270000000000000000464C7">nonempty, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464C8" id="P70004970270000000000000000464C8">rio_read</code> copies the minimum of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464C9" id="P70004970270000000000000000464C9">n</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464CA" id="P70004970270000000000000000464CA">rp-&gt;rio_cnt</code> bytes from the read buffer to the user buffer and returns the number of bytes copied.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464CB" id="P70004970270000000000000000464CB">To an application program, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464CC" id="P70004970270000000000000000464CC">rio_read</code> function has the same semantics as the Linux read function. On error, it returns −1 and sets <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464CD" id="P70004970270000000000000000464CD">errno</code> appropriately. On EOF, it returns 0. It returns a short count if the number of requested bytes exceeds the number of unread bytes in the read buffer. The similarity of the two functions makes it easy to build different kinds of buffered read functions by substituting <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464CE" id="P70004970270000000000000000464CE">rio_read</code> for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464CF" id="P70004970270000000000000000464CF">read</code>. For example, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464D0" id="P70004970270000000000000000464D0">rio_readnb</code> function in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000079F7"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.8</span></a> has the same structure as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464D1" id="P70004970270000000000000000464D1">rio_readn</code>, with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464D2" id="P70004970270000000000000000464D2">rio_read</code> substituted for read. Similarly, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464D3" id="P70004970270000000000000000464D3">rio_readlineb</code> routine in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000079F7"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.8</span></a> calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464D4" id="P70004970270000000000000000464D4">rio_read</code> at most <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464D5" id="P70004970270000000000000000464D5">maxlen-1</code> times. Each call returns 1 byte from the read buffer, which is then checked for being the terminating newline.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P70004970270000000000000000079F7" id="P70004970270000000000000000079F7">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P70004970270000000000000000079F8" epub:type="pagebreak" id="P70004970270000000000000000079F8" title="902"></span>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000464D6" id="P70004970270000000000000000464D6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464D7" id="P70004970270000000000000000464D7">
1	ssize_t rio_readlineb(rio_t *rp, void *usrbuf, size_t maxlen)
2	{
3		int n, rc;
4		char c, *bufp = usrbuf;
5	
6		for (n = 1; n &lt; maxlen; n++) {
7			if ((rc = rio_read(rp, &amp;c, 1)) == 1) {
8				*bufp++ = c;
9				if (c == '\n') {
10					n++;
11					break;
12				}
13			} else if (rc == 0) {
14				if (n == 1)
15					return 0;	/* EOF, no data read */
16				else
17					break;		/* EOF, some data was read */
18			} else
19				return −1;		/* Error */
20		}
21		*bufp = 0;
22		return n-1;
23	}
</code></pre>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000464D8" id="P70004970270000000000000000464D8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464D9" id="P70004970270000000000000000464D9">
1	ssize_t <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464DA" id="P70004970270000000000000000464DA">rio_readn</code>b(rio_t *rp, void *usrbuf, size_t n)
2	{
3		size_t nleft = n;
4		ssize_t nread;
5		char *bufp = usrbuf;
6	
7		while (nleft &gt; 0) {
8		if ((nread = rio_read(rp, bufp, nleft)) &lt; 0)
9			return −1;	/* errno set by read() */
10		else if (nread == 0)
11			break;		/*EOF */
12		nleft -= nread;
13		bufp += nread;
14		}
15		return (n - nleft);	/* Return &gt;= 0 */
16	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P70004970270000000000000000464DB" id="P70004970270000000000000000464DB"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P70004970270000000000000000464DC" epub:type="title" id="P70004970270000000000000000464DC"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.8 </span>The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464DD" id="P70004970270000000000000000464DD">rio_readlineb</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464DE" id="P70004970270000000000000000464DE">rio_readnb</code> functions.</h1></header>
</figcaption>
</figure>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000007A02" id="P7000497027000000000000000007A02"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter10.xhtml#P70004970270000000000000000464DF" epub:type="title" id="P70004970270000000000000000464DF"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007A04" epub:type="pagebreak" id="P7000497027000000000000000007A04" title="903"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Origins of the Rio package</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000464E0" id="P70004970270000000000000000464E0">The R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>functions are inspired by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464E1" id="P70004970270000000000000000464E1">readline, readn</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464E2" id="P70004970270000000000000000464E2">writen</code> functions described by W. Richard Stevens in his classic network programming text [110]. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464E3" id="P70004970270000000000000000464E3">rio_readn</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464E4" id="P70004970270000000000000000464E4">rio_writen</code> functions are identical to the Stevens <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464E5" id="P70004970270000000000000000464E5">readn</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464E6" id="P70004970270000000000000000464E6">writen</code> functions. However, the Stevens <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464E7" id="P70004970270000000000000000464E7">readline</code> function has some limitations that are corrected in R<span class="pcalibre1 pcalibre29 pcalibre2">io</span>. First, because <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464E8" id="P70004970270000000000000000464E8">readline</code> is buffered and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464E9" id="P70004970270000000000000000464E9">readn</code> is not, these two functions cannot be used together on the same descriptor. Second, because it uses a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464EA" id="P70004970270000000000000000464EA">static</code> buffer, the Stevens <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464EB" id="P70004970270000000000000000464EB">readline</code> function is not thread-safe, which required Stevens to introduce a different thread-safe version called <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464EC" id="P70004970270000000000000000464EC">readline_r</code>. We have corrected both of these flaws with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464ED" id="P70004970270000000000000000464ED">rio_readlineb</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464EE" id="P70004970270000000000000000464EE">rio_readnb</code> functions, which are mutually compatible and thread-safe.</p>
</aside>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.6 Reading File Metadata</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007A14"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P70004970270000000000000000464EF" epub:type="title" id="P70004970270000000000000000464EF"><span class="pcalibre1 pcalibre21 pcalibre2">10.6 </span>Reading File Metadata</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464F0" id="P70004970270000000000000000464F0">An application can retrieve information about a file (sometimes called the file's <i class="pcalibre17 pcalibre2 pcalibre1">metadata</i>) by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464F1" id="P70004970270000000000000000464F1">stat</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464F2" id="P70004970270000000000000000464F2">fstat</code> functions.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000464F3" id="P70004970270000000000000000464F3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464F4" id="P70004970270000000000000000464F4">
#include &lt;unistd.h&gt;
#include &lt;sys/stat.h&gt;
int stat(const char *filename, struct stat *buf);
int fstat(int fd, struct stat *buf);
					Returns: 0 if OK, −1 on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464F5" id="P70004970270000000000000000464F5">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464F6" id="P70004970270000000000000000464F6">stat</code> function takes as input a filename and fills in the members of a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464F7" id="P70004970270000000000000000464F7">stat</code> structure shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007A31"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.9</span></a>. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464F8" id="P70004970270000000000000000464F8">fstat</code> function is similar, but it takes a file descriptor instead of a filename. We will need the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464F9" id="P70004970270000000000000000464F9">st_mode</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464FA" id="P70004970270000000000000000464FA">st_size</code> members of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464FB" id="P70004970270000000000000000464FB">stat</code> structure when we discuss Web servers in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007E82.xhtml#P7000497027000000000000000007E82"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">11.5</span></a>. The other members are beyond our scope.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464FC" id="P70004970270000000000000000464FC">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464FD" id="P70004970270000000000000000464FD">st_size</code> member contains the file size in bytes. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464FE" id="P70004970270000000000000000464FE">st_mode</code> member encodes both the file permission bits (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000078E1.xhtml#P70004970270000000000000000078FD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.2</span></a>) and the file type (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000078AD.xhtml#P70004970270000000000000000078AD"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">10.2</span></a>). Linux defines macro predicates in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000464FF" id="P70004970270000000000000000464FF">sys/stat.h</code> for determining the file type from the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046500" id="P7000497027000000000000000046500">st_mode</code> member:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046501" id="P7000497027000000000000000046501">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046502" id="P7000497027000000000000000046502"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046503" id="P7000497027000000000000000046503">S_ISREG(m). Is this a regular file?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046504" id="P7000497027000000000000000046504"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046505" id="P7000497027000000000000000046505">S_ISDIR(m). Is this a directory file?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046506" id="P7000497027000000000000000046506"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046507" id="P7000497027000000000000000046507">S_ISSOCK(m). Is this a network socket?</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046508" id="P7000497027000000000000000046508"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007A38"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.10</span></a> shows how we might use these macros and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046509" id="P7000497027000000000000000046509">stat</code> function to read and interpret a file's <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004650A" id="P700049702700000000000000004650A">st_mode</code> bits.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P7000497027000000000000000007A31" id="P7000497027000000000000000007A31">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007A32" epub:type="pagebreak" id="P7000497027000000000000000007A32" title="904"></span>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004650B" id="P700049702700000000000000004650B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004650C" id="P700049702700000000000000004650C">
/* Metadata returned by the stat and fstat functions */
struct stat {
	dev_t		st_dev;		/* Device */
	ino_t		st_ino;		/* inode */
	mode_t		st_mode;	/* Protection and file type */
	nlink_t		st_nlink;	/* Number of hard links */
	uid_t		st_uid;		/* User ID of owner */
	gid_t		st_gid;		/* Group ID of owner */
	dev_t		st_rdev;	/* Device type (if inode device) */
	off_t		st_size;	/* Total size, in bytes */
	unsigned long	st_blksize;	/* Block size for filesystem I/O */
	unsigned long	st_blocks;	/* Number of blocks allocated */
	time_t		st_atime;	/* Time of last access */
	time_t		st_mtime;	/* Time of last modification */
	time_t		st_ctime;	/* Time of last change */
};
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P700049702700000000000000004650D" id="P700049702700000000000000004650D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P700049702700000000000000004650E" epub:type="title" id="P700049702700000000000000004650E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.9 </span>The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004650F" id="P700049702700000000000000004650F">stat</code> structure.</h1></header>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P7000497027000000000000000007A38" id="P7000497027000000000000000007A38">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046510" id="P7000497027000000000000000046510"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046511" id="P7000497027000000000000000046511">
1	#include "csapp.h"
2	
3	int main (int argc, char **argv)
4	{
5		struct stat stat;
6		char *type, *readok;
7	
8		Stat(argv[1], &amp;stat);
9		if (S_ISREG(stat.st_mode))	/* Determine file type */
10			type = "regular";
11		else if (S_ISDIR(stat.st_mode))
12			type = "directory";
13		else
14			type = "other";
15		if ((stat.st_mode &amp; S_IRUSR)) /* Check read access */
16			readok = "yes";
17		else
18			readok = "no";
19	
20		printf("type: %s, read: %s\n", type, readok);
21		exit(0);
22	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046512" id="P7000497027000000000000000046512"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P7000497027000000000000000046513" epub:type="title" id="P7000497027000000000000000046513"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.10 </span>Querying and manipulating a file's <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046514" id="P7000497027000000000000000046514">st_mode</code> bits.</h1></header>
</figcaption>
</figure>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.7 Reading Directory Contents</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007A3E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046515" epub:type="title" id="P7000497027000000000000000046515"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007A40" epub:type="pagebreak" id="P7000497027000000000000000007A40" title="905"></span><span class="pcalibre1 pcalibre21 pcalibre2">10.7 </span>Reading Directory Contents</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046516" id="P7000497027000000000000000046516">Applications can read the contents of a directory with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046517" id="P7000497027000000000000000046517">readdir</code> family of functions.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046518" id="P7000497027000000000000000046518"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046519" id="P7000497027000000000000000046519">
#include &lt;sys/types.h&gt;
#include &lt;dirent.h&gt;
DIR *opendir(const char *name);
					Returns: pointer to handle if OK, NULL on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004651A" id="P700049702700000000000000004651A">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004651B" id="P700049702700000000000000004651B">opendir</code> function takes a pathname and returns a pointer to a <i class="pcalibre17 pcalibre2 pcalibre1">directory stream</i>. A stream is an abstraction for an ordered list of items, in this case a list of directory entries.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004651C" id="P700049702700000000000000004651C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004651D" id="P700049702700000000000000004651D">
#include &lt;dirent.h&gt;
struct dirent *readdir(DIR *dirp);
					Returns: pointer to next directory entry if OK, NULL if no more entries or error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004651E" id="P700049702700000000000000004651E">Each call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004651F" id="P700049702700000000000000004651F">readdir</code> returns a pointer to the next directory entry in the stream <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046520" id="P7000497027000000000000000046520">dirp</code>, or NULL if there are no more entries. Each directory entry is a structure of the form</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046521" id="P7000497027000000000000000046521"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046522" id="P7000497027000000000000000046522">
struct dirent {
	ino_t d_ino;	/* inode number */
	char d_name[256];	/* Filename */
};
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046523" id="P7000497027000000000000000046523">Although some versions of Linux include other structure members, these are the only two that are standard across all systems. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046524" id="P7000497027000000000000000046524">d_name</code> member is the filename, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046525" id="P7000497027000000000000000046525">d_ino</code> is the file location.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046526" id="P7000497027000000000000000046526">On error, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046527" id="P7000497027000000000000000046527">readdir</code> returns NULL and sets <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046528" id="P7000497027000000000000000046528">errno</code>. Unfortunately, the only way to distinguish an error from the end-of-stream condition is to check if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046529" id="P7000497027000000000000000046529">errno</code> has been modified since the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004652A" id="P700049702700000000000000004652A">readdir</code>.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004652B" id="P700049702700000000000000004652B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004652C" id="P700049702700000000000000004652C">
#include &lt;dirent.h&gt;
int closedir(DIR *dirp);
Returns: 0 on success, −1 on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004652D" id="P700049702700000000000000004652D">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004652E" id="P700049702700000000000000004652E">closedir</code> function closes the stream and frees up any of its resources. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007A5B"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.11</span></a> shows how we might use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004652F" id="P700049702700000000000000004652F">readdir</code> to read the contents of a directory.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P7000497027000000000000000007A5B" id="P7000497027000000000000000007A5B">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007A5C" epub:type="pagebreak" id="P7000497027000000000000000007A5C" title="906"></span>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046530" id="P7000497027000000000000000046530"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046531" id="P7000497027000000000000000046531">
1	#include "csapp.h"
2	
3	int main(int argc, char **argv)
4	{
5		DIR *streamp;
6		struct dirent *dep; 7
8		streamp = Opendir(argv[1]);
9	
10		errno = 0;
11		while ((dep = readdir(streamp)) != NULL) {
12			printf("Found file: %s\n", dep-&gt;d_name);
13		}
14		if (errno != 0)
15			unix_error("readdir error");
16	
17		Closedir(streamp);
18		exit(0);
19	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046532" id="P7000497027000000000000000046532"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P7000497027000000000000000046533" epub:type="title" id="P7000497027000000000000000046533"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.11 </span>Reading the contents of a directory.</h1></header>
</figcaption>
</figure>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.8 Sharing Files</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007A61"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046534" epub:type="title" id="P7000497027000000000000000046534"><span class="pcalibre1 pcalibre21 pcalibre2">10.8 </span>Sharing Files</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046535" id="P7000497027000000000000000046535">Linux files can be shared in a number of different ways. Unless you have a clear picture of how the kernel represents open files, the idea of file sharing can be quite confusing. The kernel represents open files using three related data structures:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046536" id="P7000497027000000000000000046536">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046537" id="P7000497027000000000000000046537"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046538" id="P7000497027000000000000000046538"><span class="pcalibre1 pcalibre2 pcalibre41">Descriptor table. </span>Each process has its own separate <i class="pcalibre17 pcalibre2 pcalibre1">descriptor table</i> whose entries are indexed by the process's open file descriptors. Each open descriptor entry points to an entry in the <i class="pcalibre17 pcalibre2 pcalibre1">file table.</i></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046539" id="P7000497027000000000000000046539"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P700049702700000000000000004653A" id="P700049702700000000000000004653A"><span class="pcalibre1 pcalibre2 pcalibre41">File table. </span>The set of open files is represented by a file table that is shared by all processes. Each file table entry consists of (for our purposes) the current file position, a <i class="pcalibre17 pcalibre2 pcalibre1">reference count</i> of the number of descriptor entries that currently point to it, and a pointer to an entry in the <i class="pcalibre17 pcalibre2 pcalibre1">v-node table</i>. Closing a descriptor decrements the reference count in the associated file table entry. The kernel will not delete the file table entry until its reference count is zero.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004653B" id="P700049702700000000000000004653B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P700049702700000000000000004653C" id="P700049702700000000000000004653C"><span class="pcalibre1 pcalibre2 pcalibre41">v-node table. </span>Like the file table, the v-node table is shared by all processes. Each entry contains most of the information in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004653D" id="P700049702700000000000000004653D">stat</code> structure, including the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004653E" id="P700049702700000000000000004653E">st_mode</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004653F" id="P700049702700000000000000004653F">st_size</code> members.</p></li>
</ul>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P7000497027000000000000000007A6E" id="P7000497027000000000000000007A6E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007A6F" epub:type="pagebreak" id="P7000497027000000000000000007A6F" title="907"></span>
<img alt="A diagram shows paths through tables." class="pcalibre1 pcalibre2 pcalibre293" data-uri="P700049702700000000000000000B7B4" id="P7000497027000000000000000046540" src="Images/chapter-09-image-02.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046541" id="P7000497027000000000000000046541"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P7000497027000000000000000046542" epub:type="title" id="P7000497027000000000000000046542"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.12 </span>Typical kernel data structures for open files.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter10.xhtml#P7000497027000000000000000046543" id="P7000497027000000000000000046543"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046544" id="P7000497027000000000000000046544">In this example, two descriptors reference distinct files. There is no sharing.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter10.xhtml#P70004970270000000000000000268A4" id="P70004970270000000000000000268A4">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046545" id="P7000497027000000000000000046545">The tables are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter10.xhtml#P7000497027000000000000000046546" id="P7000497027000000000000000046546">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046547" id="P7000497027000000000000000046547"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046548" id="P7000497027000000000000000046548">Descriptor table (one table per process), with the following entries:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter10.xhtml#P7000497027000000000000000046549" id="P7000497027000000000000000046549">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004654A" id="P700049702700000000000000004654A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004654B" id="P700049702700000000000000004654B">Fd 0 (stdin)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004654C" id="P700049702700000000000000004654C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004654D" id="P700049702700000000000000004654D">Fd 1 (stdout), arrow to beginning of File A table</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004654E" id="P700049702700000000000000004654E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004654F" id="P700049702700000000000000004654F">Fd 2 (stderr)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046550" id="P7000497027000000000000000046550"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046551" id="P7000497027000000000000000046551">Fd 3</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046552" id="P7000497027000000000000000046552"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046553" id="P7000497027000000000000000046553">Fd 4, arrow to beginning of File B table</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046554" id="P7000497027000000000000000046554"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046555" id="P7000497027000000000000000046555">Open file table (shared by all processes), File A to File B, each with the following entries</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter10.xhtml#P7000497027000000000000000046556" id="P7000497027000000000000000046556">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046557" id="P7000497027000000000000000046557"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046558" id="P7000497027000000000000000046558">(blank)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046559" id="P7000497027000000000000000046559"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004655A" id="P700049702700000000000000004655A">File pos</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004655B" id="P700049702700000000000000004655B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004655C" id="P700049702700000000000000004655C">refcnt=1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004655D" id="P700049702700000000000000004655D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004655E" id="P700049702700000000000000004655E">…</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004655F" id="P700049702700000000000000004655F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046560" id="P7000497027000000000000000046560">V-node table (shared by all processes); arrows from open file tables to beginning of these two tables, respectively, with the following entries:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter10.xhtml#P7000497027000000000000000046561" id="P7000497027000000000000000046561">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046562" id="P7000497027000000000000000046562"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046563" id="P7000497027000000000000000046563">File access</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046564" id="P7000497027000000000000000046564"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046565" id="P7000497027000000000000000046565">File size</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046566" id="P7000497027000000000000000046566"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046567" id="P7000497027000000000000000046567">File type</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046568" id="P7000497027000000000000000046568"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046569" id="P7000497027000000000000000046569">…</p></li>
</ul>
</li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P7000497027000000000000000007A75" id="P7000497027000000000000000007A75">
<img alt="A diagram illustrates filing sharing with arrows from the blank entries in File A and File B each leading to beginning of one v-node table." class="pcalibre1 pcalibre2 pcalibre294" data-uri="P700049702700000000000000000B7B5" id="P700049702700000000000000004656A" src="Images/chapter-09-image-03.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P700049702700000000000000004656B" id="P700049702700000000000000004656B"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P700049702700000000000000004656C" epub:type="title" id="P700049702700000000000000004656C"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.13 </span>File sharing.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004656D" id="P700049702700000000000000004656D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004656E" id="P700049702700000000000000004656E">This example shows two descriptors sharing the same disk file through two open file table entries.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004656F" id="P700049702700000000000000004656F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007A6E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.12</span></a> shows an example where descriptors 1 and 4 reference two different files through distinct open file table entries. This is the typical situation, where files are not shared and where each descriptor corresponds to a distinct file.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046570" id="P7000497027000000000000000046570">Multiple descriptors can also reference the same file through different file table entries, as shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007A75"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.13</span></a>. This might happen, for example, if you were to call the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046571" id="P7000497027000000000000000046571">open</code> function twice with the same filename. The key idea is that each descriptor has its own distinct file position, so different reads on different descriptors can fetch data from different locations in the file.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046572" id="P7000497027000000000000000046572">We can also understand how parent and child processes share files. Suppose that before a call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046573" id="P7000497027000000000000000046573">fork</code>, the parent process has the open files shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007A6E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.12</span></a>. Then <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007A82"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.14</span></a> shows the situation after the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046574" id="P7000497027000000000000000046574">fork</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046575" id="P7000497027000000000000000046575">The child gets its own duplicate copy of the parent's descriptor table. Parent and child share the same set of open file tables and thus share the same file position. An important consequence is that the parent and child must both close their descriptors before the kernel will delete the corresponding file table entry.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P7000497027000000000000000007A82" id="P7000497027000000000000000007A82">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007A83" epub:type="pagebreak" id="P7000497027000000000000000007A83" title="908"></span>
<img alt="A diagram depicts tables with Parent and Child descriptor tables, each leading to File A and File B, which lead to separate v-node tables." class="pcalibre1 pcalibre295 pcalibre2" data-uri="P700049702700000000000000000B7B6" id="P7000497027000000000000000046576" src="Images/chapter-09-image-04.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P7000497027000000000000000046577" id="P7000497027000000000000000046577"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P7000497027000000000000000046578" epub:type="title" id="P7000497027000000000000000046578"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.14 </span>How a child process inherits the parent's open files.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046579" id="P7000497027000000000000000046579"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004657A" id="P700049702700000000000000004657A">The initial situation is in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007A6E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.12</span></a>.</p></div></figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007A89" epub:type="practice" id="P7000497027000000000000000007A89"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004657B" epub:type="title" id="P700049702700000000000000004657B"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.2 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007B24.xhtml#P7000497027000000000000000007B41">915</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter10.xhtml#P700049702700000000000000004657C" id="P700049702700000000000000004657C">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter10.xhtml#P700049702700000000000000004657D" id="P700049702700000000000000004657D">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter10.xhtml#P700049702700000000000000004657E" id="P700049702700000000000000004657E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P700049702700000000000000004657F" id="P700049702700000000000000004657F">Suppose the disk file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046580" id="P7000497027000000000000000046580">foobar.txt</code> consists of the six ASCII characters <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046581" id="P7000497027000000000000000046581">foobar</code>. Then what is the output of the following program?</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046582" id="P7000497027000000000000000046582"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046583" id="P7000497027000000000000000046583">
1	#include "csapp.h"
2	
3	int main()
4	{
5		int fd1, fd2;
6		char c;
7	
8		fd1 = Open("foobar.txt", O_RDONLY, 0);
9		fd2 = Open("foobar.txt", O_RDONLY, 0);
10		Read(fd1, &amp;c, 1);
11		Read(fd2, &amp;c, 1);
12		printf("c = %c\n", c);
13		exit(0);
14	}
</code></pre>
</div></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007A93" id="P7000497027000000000000000007A93"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046584" epub:type="title" id="P7000497027000000000000000046584"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.3 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007B24.xhtml#P7000497027000000000000000007B41">915</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046585" id="P7000497027000000000000000046585">As before, suppose the disk file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046586" id="P7000497027000000000000000046586">foobar.txt</code> consists of the six ASCII characters <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046587" id="P7000497027000000000000000046587">foobar</code>. Then what is the output of the following program?</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046588" id="P7000497027000000000000000046588"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046589" id="P7000497027000000000000000046589">
1	#include "csapp.h"
2	
3	int main()
4	{
5		int fd;
6		char c;
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007A9A" epub:type="pagebreak" id="P7000497027000000000000000007A9A" title="909"></span>7	
8		fd = Open("foobar.txt", O_RDONLY, 0);
9		if (Fork() == 0) {
10			Read(fd, &amp;c, 1);
11			exit(0);
12		}
13		Wait(NULL);
14		Read(fd, &amp;c, 1);
15		printf("c = %c\n", c);
16		exit(0);
17	}
</code></pre>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.9 I/O Redirection</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007A9B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P700049702700000000000000004658A" epub:type="title" id="P700049702700000000000000004658A"><span class="pcalibre1 pcalibre21 pcalibre2">10.9 </span>I/O Redirection</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004658B" id="P700049702700000000000000004658B">Linux shells provide <i class="pcalibre17 pcalibre2 pcalibre1">I/O redirection</i> operators that allow users to associate standard input and output with disk files. For example, typing</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004658C" id="P700049702700000000000000004658C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004658D" id="P700049702700000000000000004658D">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">ls &gt; foo.txt</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004658E" id="P700049702700000000000000004658E">causes the shell to load and execute the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004658F" id="P700049702700000000000000004658F">ls</code> program, with standard output redirected to disk file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046590" id="P7000497027000000000000000046590">foo.txt</code>. As we will see in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007E82.xhtml#P7000497027000000000000000007E82"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">11.5</span></a>, a Web server performs a similar kind of redirection when it runs a CGI program on behalf of the client. So how does I/O redirection work? One way is to use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046591" id="P7000497027000000000000000046591">dup2</code> function.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046592" id="P7000497027000000000000000046592"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046593" id="P7000497027000000000000000046593">
#include &lt;unistd.h&gt;
int dup2(int oldfd, int newfd);
					Returns: nonnegative descriptor if OK, −1 on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046594" id="P7000497027000000000000000046594">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046595" id="P7000497027000000000000000046595">dup2</code> function copies descriptor table entry <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046596" id="P7000497027000000000000000046596">oldfd</code> to descriptor table entry <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046597" id="P7000497027000000000000000046597">newfd</code>, overwriting the previous contents of descriptor table entry <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046598" id="P7000497027000000000000000046598">newfd</code>. If <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046599" id="P7000497027000000000000000046599">newfd</code> was already open, then <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004659A" id="P700049702700000000000000004659A">dup2</code> closes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004659B" id="P700049702700000000000000004659B">newfd</code> before it copies <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004659C" id="P700049702700000000000000004659C">oldfd</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004659D" id="P700049702700000000000000004659D">Suppose that before calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004659E" id="P700049702700000000000000004659E">dup2(4, 1)</code>, we have the situation in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007A61.xhtml#P7000497027000000000000000007A6E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.12</span></a>, where descriptor 1 (standard output) corresponds to file A (say, a terminal) and descriptor 4 corresponds to file B (say, a disk file). The reference counts for A and B are both equal to 1. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007ABD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.15</span></a> shows the situation after calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004659F" id="P700049702700000000000000004659F">dup2(4, 1)</code>. Both descriptors now point to file B; file A has been closed and its file table and v-node table entries deleted; and the reference count for file B has been incremented. From this point on, any data written to standard output are redirected to file B.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007AB2" epub:type="practice" id="P7000497027000000000000000007AB2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465A0" epub:type="title" id="P70004970270000000000000000465A0"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.4 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007B24.xhtml#P7000497027000000000000000007B41">915</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter10.xhtml#P70004970270000000000000000465A1" id="P70004970270000000000000000465A1">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter10.xhtml#P70004970270000000000000000465A2" id="P70004970270000000000000000465A2">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter10.xhtml#P70004970270000000000000000465A3" id="P70004970270000000000000000465A3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465A4" id="P70004970270000000000000000465A4">How would you use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465A5" id="P70004970270000000000000000465A5">dup2</code> to redirect standard input to descriptor 5?</p>
</div></li>
</ol>
</section>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000007AB9" id="P7000497027000000000000000007AB9"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter10.xhtml#P70004970270000000000000000465A6" epub:type="title" id="P70004970270000000000000000465A6"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007ABB" epub:type="pagebreak" id="P7000497027000000000000000007ABB" title="910"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Right and left hoinkies</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465A7" id="P70004970270000000000000000465A7">To avoid confusion with other bracket-type operators such as `]' and `[', we have always referred to the shell's `&gt;' operator as a "right hoinky" and the `&lt;' operator as a "left hoinky."</p>
</aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P7000497027000000000000000007ABD" id="P7000497027000000000000000007ABD">
<img alt="A diagram depicts arrows from descriptor table to open file table File B, which has entry refcnt=2. Arrows from File A and File B lead to separate v-node tables." class="pcalibre296 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B7B8" id="P70004970270000000000000000465A8" src="Images/chapter-09-image-05.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P70004970270000000000000000465A9" id="P70004970270000000000000000465A9"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P70004970270000000000000000465AA" epub:type="title" id="P70004970270000000000000000465AA"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.15 </span>Kernel data structures after redirecting standard output by calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465AB" id="P70004970270000000000000000465AB">dup2(4, 1)</code>.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465AC" id="P70004970270000000000000000465AC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465AD" id="P70004970270000000000000000465AD">The initial situation is shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007A61.xhtml#P7000497027000000000000000007A6E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">10.12</span></a>.</p></div></figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007AC4" id="P7000497027000000000000000007AC4"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465AE" epub:type="title" id="P70004970270000000000000000465AE"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.5 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007B49.xhtml#P7000497027000000000000000007B6D">916</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465AF" id="P70004970270000000000000000465AF">Assuming that the disk file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465B0" id="P70004970270000000000000000465B0">foobar.txt</code> consists of the six ASCII characters <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465B1" id="P70004970270000000000000000465B1">foobar</code>, what is the output of the following program?</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465B2" id="P70004970270000000000000000465B2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465B3" id="P70004970270000000000000000465B3">
1	#include "csapp.h"
2	
3	int main()
4	{
5		int fd1, fd2;
6		char c; 7
8		fd1 = Open("foobar.txt", O_RDONLY, 0);
9		fd2 = Open("foobar.txt", O_RDONLY, 0);
10		Read(fd2, &amp;c, 1);
11		Dup2(fd2, fd1);
12		Read(fd1, &amp;c, 1);
13		printf("c = %c\n", c);
14		exit(0);
15	}
</code></pre>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.10 Standard I/O</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007ACB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P70004970270000000000000000465B4" epub:type="title" id="P70004970270000000000000000465B4"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007ACD" epub:type="pagebreak" id="P7000497027000000000000000007ACD" title="911"></span><span class="pcalibre1 pcalibre21 pcalibre2">10.10 </span>Standard I/O</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465B5" id="P70004970270000000000000000465B5">The C language defines a set of higher-level input and output functions, called the <i class="pcalibre17 pcalibre2 pcalibre1">standard I/O library</i>, that provides programmers with a higher-level alternative to Unix I/O. The library (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465B6" id="P70004970270000000000000000465B6">libc</code>) provides functions for opening and closing files (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465B7" id="P70004970270000000000000000465B7">fopen</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465B8" id="P70004970270000000000000000465B8">fclose</code>), reading and writing bytes (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465B9" id="P70004970270000000000000000465B9">fread</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465BA" id="P70004970270000000000000000465BA">fwrite</code>), reading and writing strings (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465BB" id="P70004970270000000000000000465BB">fgets</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465BC" id="P70004970270000000000000000465BC">fputs</code>), and sophisticated formatted I/O (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465BD" id="P70004970270000000000000000465BD">scanf</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465BE" id="P70004970270000000000000000465BE">printf</code>).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465BF" id="P70004970270000000000000000465BF">The standard I/O library models an open file as a <i class="pcalibre17 pcalibre2 pcalibre1">stream</i>. To the programmer, a stream is a pointer to a structure of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465C0" id="P70004970270000000000000000465C0">FILE</code>. Every ANSI C program begins with three open streams, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465C1" id="P70004970270000000000000000465C1">stdin, stdout</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465C2" id="P70004970270000000000000000465C2">stderr</code>, which correspond to standard input, standard output, and standard error, respectively:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465C3" id="P70004970270000000000000000465C3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465C4" id="P70004970270000000000000000465C4">
#include &lt;stdio.h&gt;
extern FILE *stdin;		/* Standard input (descriptor 0) */
extern FILE *stdout;		/* Standard output (descriptor 1) */
extern FILE *stderr;		/* Standard error (descriptor 2) */
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465C5" id="P70004970270000000000000000465C5">A stream of type FILE is an abstraction for a file descriptor and a <i class="pcalibre17 pcalibre2 pcalibre1">stream buffer</i>. The purpose of the stream buffer is the same as the R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>read buffer: to minimize the number of expensive Linux I/O system calls. For example, suppose we have a program that makes repeated calls to the standard I/O <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465C6" id="P70004970270000000000000000465C6">getc</code> function, where each invocation returns the next character from a file. When <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465C7" id="P70004970270000000000000000465C7">getc</code> is called the first time, the library fills the stream buffer with a single call to the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465C8" id="P70004970270000000000000000465C8">read</code> function and then returns the first byte in the buffer to the application. As long as there are unread bytes in the buffer, subsequent calls to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465C9" id="P70004970270000000000000000465C9">getc</code> can be served directly from the stream buffer.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>10.11 Putting It Together: Which I/O Functions Should I Use?</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007AE3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P70004970270000000000000000465CA" epub:type="title" id="P70004970270000000000000000465CA"><span class="pcalibre1 pcalibre21 pcalibre2">10.11 </span>Putting It Together: Which I/O Functions Should I Use?</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465CB" id="P70004970270000000000000000465CB"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007AE6"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.16</span></a> summarizes the various I/O packages that we have discussed in this chapter.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter10.xhtml#P7000497027000000000000000007AE6" id="P7000497027000000000000000007AE6">
<img alt="A diagram illustrates relationships between various I/O packages." class="pcalibre297 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B7B9" id="P70004970270000000000000000465CC" src="Images/chapter-09-image-06.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter10.xhtml#P70004970270000000000000000465CD" id="P70004970270000000000000000465CD"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter10.xhtml#P70004970270000000000000000465CE" epub:type="title" id="P70004970270000000000000000465CE"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.16 </span>Relationship between Unix I/O, standard I/O, and R<span class="pcalibre1 pcalibre2 pcalibre84">io</span>.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter10.xhtml#P700049702700000000000000002692F" id="P700049702700000000000000002692F">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P70004970270000000000000000465CF" id="P70004970270000000000000000465CF">A diagram shows three functions within C application program, each leading to a list, as summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter10.xhtml#P70004970270000000000000000465D0" id="P70004970270000000000000000465D0">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465D1" id="P70004970270000000000000000465D1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465D2" id="P70004970270000000000000000465D2">Unix I/O functions:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter10.xhtml#P70004970270000000000000000465D3" id="P70004970270000000000000000465D3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465D4" id="P70004970270000000000000000465D4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465D5" id="P70004970270000000000000000465D5">Open</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465D6" id="P70004970270000000000000000465D6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465D7" id="P70004970270000000000000000465D7">Read</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465D8" id="P70004970270000000000000000465D8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465D9" id="P70004970270000000000000000465D9">Write</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465DA" id="P70004970270000000000000000465DA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465DB" id="P70004970270000000000000000465DB">Lseek</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465DC" id="P70004970270000000000000000465DC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465DD" id="P70004970270000000000000000465DD">Stat</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465DE" id="P70004970270000000000000000465DE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465DF" id="P70004970270000000000000000465DF">Close</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465E0" id="P70004970270000000000000000465E0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465E1" id="P70004970270000000000000000465E1">Standard I/O functions:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter10.xhtml#P70004970270000000000000000465E2" id="P70004970270000000000000000465E2">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465E3" id="P70004970270000000000000000465E3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465E4" id="P70004970270000000000000000465E4">Fopen</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465E5" id="P70004970270000000000000000465E5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465E6" id="P70004970270000000000000000465E6">Fdopen</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465E7" id="P70004970270000000000000000465E7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465E8" id="P70004970270000000000000000465E8">Fread</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465E9" id="P70004970270000000000000000465E9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465EA" id="P70004970270000000000000000465EA">Fwrite</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465EB" id="P70004970270000000000000000465EB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465EC" id="P70004970270000000000000000465EC">Fscanf</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465ED" id="P70004970270000000000000000465ED"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465EE" id="P70004970270000000000000000465EE">Fprintf</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465EF" id="P70004970270000000000000000465EF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465F0" id="P70004970270000000000000000465F0">Ascanf</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465F1" id="P70004970270000000000000000465F1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465F2" id="P70004970270000000000000000465F2">Aprintf</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465F3" id="P70004970270000000000000000465F3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465F4" id="P70004970270000000000000000465F4">Fgets</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465F5" id="P70004970270000000000000000465F5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465F6" id="P70004970270000000000000000465F6">Fputs</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465F7" id="P70004970270000000000000000465F7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465F8" id="P70004970270000000000000000465F8">Fflish</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465F9" id="P70004970270000000000000000465F9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465FA" id="P70004970270000000000000000465FA">Fseek</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465FB" id="P70004970270000000000000000465FB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465FC" id="P70004970270000000000000000465FC">Fclose</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P70004970270000000000000000465FD" id="P70004970270000000000000000465FD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P70004970270000000000000000465FE" id="P70004970270000000000000000465FE">Rio functions:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter10.xhtml#P70004970270000000000000000465FF" id="P70004970270000000000000000465FF">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046600" id="P7000497027000000000000000046600"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046601" id="P7000497027000000000000000046601">Rio_readn</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046602" id="P7000497027000000000000000046602"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046603" id="P7000497027000000000000000046603">Rio_writen</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046604" id="P7000497027000000000000000046604"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046605" id="P7000497027000000000000000046605">Rio_readinitb</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046606" id="P7000497027000000000000000046606"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046607" id="P7000497027000000000000000046607">Rio_readlineb</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046608" id="P7000497027000000000000000046608"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter10.xhtml#P7000497027000000000000000046609" id="P7000497027000000000000000046609">Rio_readnb</p></li>
</ul>
</li></ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004660A" id="P700049702700000000000000004660A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007AEB" epub:type="pagebreak" id="P7000497027000000000000000007AEB" title="912"></span>The Unix I/O model is implemented in the operating system kernel. It is available to applications through functions such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004660B" id="P700049702700000000000000004660B">open, close, lseek, read, write</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004660C" id="P700049702700000000000000004660C">stat</code>. The higher-level R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>and standard I/O functions are implemented "on top of" (using) the Unix I/O functions. The R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>functions are robust wrappers for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004660D" id="P700049702700000000000000004660D">read</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004660E" id="P700049702700000000000000004660E">write</code> that were developed specifically for this textbook. They automatically deal with short counts and provide an efficient buffered approach for reading text lines. The standard I/O functions provide a more complete buffered alternative to the Unix I/O functions, including formatted I/O routines such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004660F" id="P700049702700000000000000004660F">printf</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046610" id="P7000497027000000000000000046610">scanf</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046611" id="P7000497027000000000000000046611">So which of these functions should you use in your programs? Here are some basic guidelines:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046612" id="P7000497027000000000000000046612">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046613" id="P7000497027000000000000000046613"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046614" id="P7000497027000000000000000046614">G1: <span class="pcalibre1 pcalibre2 pcalibre41">Use the standard I/O functions whenever possible.</span> The standard I/O functions are the method of choice for I/O on disk and terminal devices. Most C programmers use standard I/O exclusively throughout their careers, never bothering with the lower-level Unix I/O functions (except possibly <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046615" id="P7000497027000000000000000046615">stat</code>, which has no counterpart in the standard I/O library). Whenever possible, we recommend that you do likewise.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046616" id="P7000497027000000000000000046616"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046617" id="P7000497027000000000000000046617">G2: <span class="pcalibre1 pcalibre2 pcalibre41">Don't use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046618" id="P7000497027000000000000000046618">scanf</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046619" id="P7000497027000000000000000046619">rio_readlineb</code> to read binary files.</span> Functions like <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004661A" id="P700049702700000000000000004661A">scanf</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004661B" id="P700049702700000000000000004661B">rio_readlineb</code> are designed specifically for reading text files. A common error that students make is to use these functions to read binary data, causing their programs to fail in strange and unpredictable ways. For example, binary files might be littered with many <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004661C" id="P700049702700000000000000004661C">0xa</code> bytes that have nothing to do with terminating text lines.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004661D" id="P700049702700000000000000004661D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P700049702700000000000000004661E" id="P700049702700000000000000004661E">G3: <span class="pcalibre1 pcalibre2 pcalibre41">Use the R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>functions for I/O on network sockets.</span> Unfortunately, standard I/O poses some nasty problems when we attempt to use it for input and output on networks. As we will see in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007CC1.xhtml#P7000497027000000000000000007CC1"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">11.4</span></a>, the Linux abstraction for a network is a type of file called a <i class="pcalibre17 pcalibre2 pcalibre1">socket</i>. Like any Linux file, sockets are referenced by file descriptors, known in this case as <i class="pcalibre17 pcalibre2 pcalibre1">socket descriptors</i>. Application processes communicate with processes running on other computers by reading and writing socket descriptors.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004661F" id="P700049702700000000000000004661F">Standard I/O streams are <i class="pcalibre17 pcalibre2 pcalibre1">full duplex</i> in the sense that programs can perform input and output on the same stream. However, there are poorly documented restrictions on streams that interact badly with restrictions on sockets:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046620" id="P7000497027000000000000000046620">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046621" id="P7000497027000000000000000046621"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046622" id="P7000497027000000000000000046622">Restriction 1: <span class="pcalibre1 pcalibre2 pcalibre41">Input functions following output functions.</span> An input function cannot follow an output function without an intervening call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046623" id="P7000497027000000000000000046623">fflush, fseek, fsetpos</code>, or rewind. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046624" id="P7000497027000000000000000046624">fflush</code> function empties the buffer associated with a stream. The latter three functions use the Unix I/O <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046625" id="P7000497027000000000000000046625">lseek</code> function to reset the current file position.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046626" id="P7000497027000000000000000046626"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter10.xhtml#P7000497027000000000000000046627" id="P7000497027000000000000000046627"><span class="pcalibre1 pcalibre2 pcalibre41">Restriction 2: Output functions following input functions.</span> An output function cannot follow an input function without an intervening call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046628" id="P7000497027000000000000000046628">fseek, fsetpos</code>, or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046629" id="P7000497027000000000000000046629">rewind</code>, unless the input function encounters an end-of-file.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004662A" id="P700049702700000000000000004662A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007B0C" epub:type="pagebreak" id="P7000497027000000000000000007B0C" title="913"></span>These restrictions pose a problem for network applications because it is illegal to use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004662B" id="P700049702700000000000000004662B">lseek</code> function on a socket. The first restriction on stream I/O can be worked around by adopting a discipline of flushing the buffer before every input operation. However, the only way to work around the second restriction is to open two streams on the same open socket descriptor, one for reading and one for writing:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004662C" id="P700049702700000000000000004662C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004662D" id="P700049702700000000000000004662D">
FILE *fpin, *fpout;
fpin = fdopen(sockfd, "r");
 fpout = fdopen(sockfd, "w");
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004662E" id="P700049702700000000000000004662E">But this approach has problems as well, because it requires the application to call <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004662F" id="P700049702700000000000000004662F">fclose</code> on both streams in order to free the memory resources associated with each stream and avoid a memory leak:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046630" id="P7000497027000000000000000046630"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046631" id="P7000497027000000000000000046631">
fclose(fpin);
fclose(fpout);
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046632" id="P7000497027000000000000000046632">Each of these operations attempts to close the same underlying socket descriptor, so the second <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046633" id="P7000497027000000000000000046633">close</code> operation will fail. This is not a problem for sequential programs, but closing an already closed descriptor in a threaded program is a recipe for disaster (see <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000008577.xhtml#P7000497027000000000000000008610"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">12.7.4</span></a>).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046634" id="P7000497027000000000000000046634">Thus, we recommend that you not use the standard I/O functions for input and output on network sockets. Use the robust R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>functions instead. If you need formatted output, use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046635" id="P7000497027000000000000000046635">sprintf</code> function to format a string in memory, and then send it to the socket using <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046636" id="P7000497027000000000000000046636">rio_writen</code>. If you need formatted input, use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046637" id="P7000497027000000000000000046637">rio_readlineb</code> to read an entire text line, and then use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046638" id="P7000497027000000000000000046638">sscanf</code> to extract different fields from the text line.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Bibliographic Notes </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre83 pcalibre2" epub:type="bibliography" id="P7000497027000000000000000007B21"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 title" data-uri="chapter10.xhtml#P700049702700000000000000004663D" epub:type="title" id="P700049702700000000000000004663D"><span class="pcalibre1 pcalibre21 pcalibre2">Bibliographic Notes </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004663E" id="P700049702700000000000000004663E">Kerrisk gives a comprehensive treatment of Unix I/O and the Linux file system <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B41E">[62]</a>. Stevens wrote the original standard reference text for Unix I/O [111]. Kernighan and Ritchie give a clear and complete discussion of the standard I/O functions <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B41C">[61]</a>.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Homework Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007B24"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P700049702700000000000000004663F" epub:type="title" id="P700049702700000000000000004663F"><span class="pcalibre1 pcalibre21 pcalibre2">Homework Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B26" id="P7000497027000000000000000007B26"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046640" epub:type="title" id="P7000497027000000000000000046640"><span class="pcalibre1 pcalibre21 pcalibre2">10.6 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046641" id="P7000497027000000000000000046641">What is the output of the following program?</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046642" id="P7000497027000000000000000046642"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046643" id="P7000497027000000000000000046643">
1	#include "csapp.h"
2	
3	int main()
4	{
5		int fd1, fd2; 6
7		fd1 = Open("foo.txt", O_RDONLY, 0);
8		fd2 = Open("bar.txt", O_RDONLY, 0);
9		Close(fd2);
10		fd2 = Open("baz.txt", O_RDONLY, 0);
11		printf("fd2 = %d\n", fd2);
12		exit(0);
13	}
</code></pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B2B" id="P7000497027000000000000000007B2B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046644" epub:type="title" id="P7000497027000000000000000046644"><span class="pcalibre1 pcalibre21 pcalibre2">10.7 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046645" id="P7000497027000000000000000046645">Modify the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046646" id="P7000497027000000000000000046646">cpfile</code> program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007975.xhtml#P70004970270000000000000000079C8"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.5</span></a> so that it uses the R<span class="pcalibre1 pcalibre29 pcalibre2">io </span>functions to copy standard input to standard output, MAXBUF bytes at a time.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B2F" id="P7000497027000000000000000007B2F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046647" epub:type="title" id="P7000497027000000000000000046647"><span class="pcalibre1 pcalibre21 pcalibre2">10.8 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046648" id="P7000497027000000000000000046648">Write a version of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046649" id="P7000497027000000000000000046649">statcheck</code> program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007A14.xhtml#P7000497027000000000000000007A38"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.10</span></a>, called <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004664A" id="P700049702700000000000000004664A">fstatcheck</code>, that takes a descriptor number on the command line rather than a filename.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B34" id="P7000497027000000000000000007B34"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004664B" epub:type="title" id="P700049702700000000000000004664B"><span class="pcalibre1 pcalibre21 pcalibre2">10.9 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004664C" id="P700049702700000000000000004664C">Consider the following invocation of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004664D" id="P700049702700000000000000004664D">fstatcheck</code> program from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007B2F"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.8</span></a>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004664E" id="P700049702700000000000000004664E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004664F" id="P700049702700000000000000004664F">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">fstatcheck 3 &lt; foo.txt</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046650" id="P7000497027000000000000000046650">You might expect that this invocation of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046651" id="P7000497027000000000000000046651">fstatcheck</code> would fetch and display metadata for file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046652" id="P7000497027000000000000000046652">foo.txt</code>. However, when we run it on our system, it fails with a "bad file descriptor." Given this behavior, fill in the pseudocode that the shell must be executing between the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046653" id="P7000497027000000000000000046653">fork</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046654" id="P7000497027000000000000000046654">execve</code> calls:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046655" id="P7000497027000000000000000046655"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046656" id="P7000497027000000000000000046656">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007B41" epub:type="pagebreak" id="P7000497027000000000000000007B41" title="915"></span>if (Fork() == 0) { /* child */
	/* What code is the shell executing right here? */
	Execve("fstatcheck", argv, envp);
}
</code></pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B42" id="P7000497027000000000000000007B42"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046657" epub:type="title" id="P7000497027000000000000000046657"><span class="pcalibre1 pcalibre21 pcalibre2">10.10 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046658" id="P7000497027000000000000000046658">Modify the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046659" id="P7000497027000000000000000046659">cpfile</code> program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007975.xhtml#P70004970270000000000000000079C8"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">10.5</span></a> so that it takes an optional command-line argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004665A" id="P700049702700000000000000004665A">infile</code>. If <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004665B" id="P700049702700000000000000004665B">infile</code> is given, then copy <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004665C" id="P700049702700000000000000004665C">infile</code> to standard output; otherwise, copy standard input to standard output as before. The twist is that your solution must use the original copy loop (lines 9−11) for both cases. You are only allowed to insert code, and you are not allowed to change any of the existing code.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Solutions to Practice Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007B49"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter10.xhtml#P700049702700000000000000004665D" epub:type="title" id="P700049702700000000000000004665D"><span class="pcalibre1 pcalibre21 pcalibre2">Solutions to Practice Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B4B" id="P7000497027000000000000000007B4B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004665E" epub:type="title" id="P700049702700000000000000004665E"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000078E1.xhtml#P7000497027000000000000000007931"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.1 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000078E1.xhtml#P7000497027000000000000000007930">895</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004665F" id="P700049702700000000000000004665F">Unix processes begin life with open descriptors assigned to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046660" id="P7000497027000000000000000046660">stdin</code> (descriptor 0), <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046661" id="P7000497027000000000000000046661">stdout</code> (descriptor 1), and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046662" id="P7000497027000000000000000046662">stderr</code> (descriptor 2). The open function always returns the lowest unopened descriptor, so the first call to open returns descriptor 3. The call to the close function frees up descriptor 3. The final call to open returns descriptor 3, and thus the output of the program is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046663" id="P7000497027000000000000000046663">fd2 = 3</code>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B52" id="P7000497027000000000000000007B52"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046664" epub:type="title" id="P7000497027000000000000000046664"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007A61.xhtml#P7000497027000000000000000007A89"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.2 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007A61.xhtml#P7000497027000000000000000007A83">908</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046665" id="P7000497027000000000000000046665">The descriptors <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046666" id="P7000497027000000000000000046666">fd1</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046667" id="P7000497027000000000000000046667">fd2</code> each have their own open file table entry, so each descriptor has its own file position for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046668" id="P7000497027000000000000000046668">foobar.txt</code>. Thus, the read from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046669" id="P7000497027000000000000000046669">fd2</code> reads the first byte of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004666A" id="P700049702700000000000000004666A">foobar.txt</code>, and the output is</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004666B" id="P700049702700000000000000004666B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004666C" id="P700049702700000000000000004666C">
c = f
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004666D" id="P700049702700000000000000004666D">and not</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004666E" id="P700049702700000000000000004666E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004666F" id="P700049702700000000000000004666F">
c = o
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046670" id="P7000497027000000000000000046670">as you might have thought initially.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B60" id="P7000497027000000000000000007B60"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046671" epub:type="title" id="P7000497027000000000000000046671"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007A61.xhtml#P7000497027000000000000000007A93"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.3 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007A61.xhtml#P7000497027000000000000000007A83">908</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046672" id="P7000497027000000000000000046672">Recall that the child inherits the parent's descriptor table and that all processes shared the same open file table. Thus, the descriptor <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046673" id="P7000497027000000000000000046673">fd</code> in both the parent and child points to the same open file table entry. When the child reads the first byte of the file, the file position increases by 1. Thus, the parent reads the second byte, and the output is</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046674" id="P7000497027000000000000000046674"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046675" id="P7000497027000000000000000046675">c = o</code></pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B66" id="P7000497027000000000000000007B66"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046676" epub:type="title" id="P7000497027000000000000000046676"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007A9B.xhtml#P7000497027000000000000000007AB2"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.4 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007A61.xhtml#P7000497027000000000000000007A9A">909</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046677" id="P7000497027000000000000000046677">To redirect standard input (descriptor 0) to descriptor 5, we would call <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046678" id="P7000497027000000000000000046678">dup2(5,0)</code>, or equivalently, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046679" id="P7000497027000000000000000046679">dup2(5,STDIN_FILENO)</code>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter10.xhtml#P7000497027000000000000000007B6B" id="P7000497027000000000000000007B6B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004667A" epub:type="title" id="P700049702700000000000000004667A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter10.xhtml#P7000497027000000000000000007B6D" epub:type="pagebreak" id="P7000497027000000000000000007B6D" title="916"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007A9B.xhtml#P7000497027000000000000000007AC4"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">10.5 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007A9B.xhtml#P7000497027000000000000000007ABB">910</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004667B" id="P700049702700000000000000004667B">At first glance, you might think the output would be</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P700049702700000000000000004667C" id="P700049702700000000000000004667C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004667D" id="P700049702700000000000000004667D">c = f</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004667E" id="P700049702700000000000000004667E">but because we are redirecting <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P700049702700000000000000004667F" id="P700049702700000000000000004667F">fd1</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046680" id="P7000497027000000000000000046680">fd2</code>, the output is really</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter10.xhtml#P7000497027000000000000000046681" id="P7000497027000000000000000046681"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter10.xhtml#P7000497027000000000000000046682" id="P7000497027000000000000000046682">c = o</code></pre>
</section>
</section></body></html>
