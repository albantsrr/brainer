<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Chapter 9 Virtual Memory</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="chapter" id="P7000497027000000000000000006FF7"><header class="pcalibre1 pcalibre2 pcalibre48"><h1 class="pcalibre1 pcalibre2 pcalibre49" data-uri="chapter09.xhtml#P70004970270000000000000000457BB" epub:type="title" id="P70004970270000000000000000457BB"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000006FF9" epub:type="pagebreak" id="P7000497027000000000000000006FF9" title="801"></span><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre50 pcalibre2">9 </span>Virtual Memory</h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" id="d9e150648">
<nav class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000457BC" epub:type="toc" id="P70004970270000000000000000457BC">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000457BD" id="P70004970270000000000000000457BD">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457BE" id="P70004970270000000000000000457BE">
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457BF" id="P70004970270000000000000000457BF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457C0" id="P70004970270000000000000000457C0"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000702F.xhtml#P700049702700000000000000000702F"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.1 </span>Physical and Virtual Addressing </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">803</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457C1" id="P70004970270000000000000000457C1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457C2" id="P70004970270000000000000000457C2"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000703D.xhtml#P700049702700000000000000000703D"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.2 </span>Address Spaces </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">804</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457C3" id="P70004970270000000000000000457C3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457C4" id="P70004970270000000000000000457C4"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007062.xhtml#P7000497027000000000000000007062"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.3 </span>VM as a Tool for Caching </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">805</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457C5" id="P70004970270000000000000000457C5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457C6" id="P70004970270000000000000000457C6"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000070D3.xhtml#P70004970270000000000000000070D3"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.4 </span>VM as a Tool for Memory Management </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">811</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457C7" id="P70004970270000000000000000457C7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457C8" id="P70004970270000000000000000457C8"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000070EA.xhtml#P70004970270000000000000000070EA"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.5 </span>VM as a Tool for Memory Protection </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">812</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457C9" id="P70004970270000000000000000457C9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457CA" id="P70004970270000000000000000457CA"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000070F6.xhtml#P70004970270000000000000000070F6"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.6 </span>Address Translation </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">813</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457CB" id="P70004970270000000000000000457CB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457CC" id="P70004970270000000000000000457CC"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007216.xhtml#P7000497027000000000000000007216"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.7 </span>Case Study: The Intel Core i7/Linux Memory System </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">825</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457CD" id="P70004970270000000000000000457CD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457CE" id="P70004970270000000000000000457CE"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000072B5.xhtml#P70004970270000000000000000072B5"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.8 </span>Memory Mapping </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">833</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457CF" id="P70004970270000000000000000457CF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457D0" id="P70004970270000000000000000457D0"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000733C.xhtml#P700049702700000000000000000733C"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.9 </span>Dynamic Memory Allocation </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">839</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457D1" id="P70004970270000000000000000457D1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457D2" id="P70004970270000000000000000457D2"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007565.xhtml#P7000497027000000000000000007565"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.10 </span>Garbage Collection </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">865</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter09.xhtml#P70004970270000000000000000457D3" id="P70004970270000000000000000457D3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457D4" id="P70004970270000000000000000457D4"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000075E8.xhtml#P70004970270000000000000000075E8"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.11 </span>Common Memory-Related Bugs in C Programs </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">870</span></a></p></li>
</ol>
</div>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000457D5" id="P70004970270000000000000000457D5">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457D6" id="P70004970270000000000000000457D6">
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter09.xhtml#P70004970270000000000000000457D7" id="P70004970270000000000000000457D7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457D8" id="P70004970270000000000000000457D8"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007654.xhtml#P7000497027000000000000000007654"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">9.12 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary</span> </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">875</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter09.xhtml#P70004970270000000000000000457D9" id="P70004970270000000000000000457D9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457DA" id="P70004970270000000000000000457DA"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000765E.xhtml#P700049702700000000000000000765E"><span class="pcalibre1 pcalibre2" epub:type="title">Bibliographic Notes</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">876</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter09.xhtml#P70004970270000000000000000457DB" id="P70004970270000000000000000457DB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457DC" id="P70004970270000000000000000457DC"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000007663.xhtml#P7000497027000000000000000007663"><span class="pcalibre1 pcalibre2" epub:type="title">Homework Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">876</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter09.xhtml#P70004970270000000000000000457DD" id="P70004970270000000000000000457DD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457DE" id="P70004970270000000000000000457DE"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000777C.xhtml#P700049702700000000000000000777C"><span class="pcalibre1 pcalibre2" epub:type="title">Solutions to Practice Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">880</span></a></p></li>
</ol></div>
</nav>
<section class="pcalibre1 pcalibre2 pcalibre51" data-uri="chapter09.xhtml#P70004970270000000000000000457DF" epub:type="introduction" id="P70004970270000000000000000457DF">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457E0" id="P70004970270000000000000000457E0"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000701F" epub:type="pagebreak" id="P700049702700000000000000000701F" title="802"></span>Processes in a system share the CPU and main memory with other processes. However, sharing the main memory poses some special challenges. As demand on the CPU increases, processes slow down in some reasonably smooth way. But if too many processes need too much memory, then some of them will simply not be able to run. When a program is out of space, it is out of luck. Memory is also vulnerable to corruption. If some process inadvertently writes to the memory used by another process, that process might fail in some bewildering fashion totally unrelated to the program logic.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457E1" id="P70004970270000000000000000457E1">In order to manage memory more efficiently and with fewer errors, modern systems provide an abstraction of main memory known as <i class="pcalibre17 pcalibre2 pcalibre1">virtual memory (VM).</i> Virtual memory is an elegant interaction of hardware exceptions, hardware address translation, main memory, disk files, and kernel software that provides each process with a large, uniform, and private address space. With one clean mechanism, virtual memory provides three important capabilities: (1) It uses main memory efficiently by treating it as a cache for an address space stored on disk, keeping only the active areas in main memory and transferring data back and forth between disk and memory as needed. (2) It simplifies memory management by providing each process with a uniform address space. (3) It protects the address space of each process from corruption by other processes.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457E2" id="P70004970270000000000000000457E2">Virtual memory is one of the great ideas in computer systems. A major reason for its success is that it works silently and automatically, without any intervention from the application programmer. Since virtual memory works so well behind the scenes, why would a programmer need to understand it? There are several reasons.</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457E3" id="P70004970270000000000000000457E3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000457E4" id="P70004970270000000000000000457E4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457E5" id="P70004970270000000000000000457E5"><span class="pcalibre1 pcalibre2 pcalibre41">Virtual memory is central. </span>Virtual memory pervades all levels of computer systems, playing key roles in the design of hardware exceptions, assemblers, linkers, loaders, shared objects, files, and processes. Understanding virtual memory will help you better understand how systems work in general.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000457E6" id="P70004970270000000000000000457E6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457E7" id="P70004970270000000000000000457E7"><span class="pcalibre1 pcalibre2 pcalibre41">Virtual memory is powerful. </span>Virtual memory gives applications powerful capabilities to create and destroy chunks of memory, map chunks of memory to portions of disk files, and share memory with other processes. For example, did you know that you can read or modify the contents of a disk file by reading and writing memory locations? Or that you can load the contents of a file into memory without doing any explicit copying? Understanding virtual memory will help you harness its powerful capabilities in your applications.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000457E8" id="P70004970270000000000000000457E8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457E9" id="P70004970270000000000000000457E9"><span class="pcalibre1 pcalibre2 pcalibre41">Virtual memory is dangerous. </span>Applications interact with virtual memory every time they reference a variable, dereference a pointer, or make a call to a dynamic allocation package such as <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457EA" id="P70004970270000000000000000457EA">malloc</code>. If virtual memory is used improperly, applications can suffer from perplexing and insidious memory-related bugs. For example, a program with a bad pointer can crash immediately with a "segmentation fault" or a "protection fault," run silently for hours before crashing, or scariest of all, run to completion with incorrect results. Understanding virtual memory, and the allocation packages such as <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457EB" id="P70004970270000000000000000457EB">malloc</code> that manage it, can help you avoid these errors.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457EC" id="P70004970270000000000000000457EC"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000702C" epub:type="pagebreak" id="P700049702700000000000000000702C" title="803"></span>This chapter looks at virtual memory from two angles. The first half of the chapter describes how virtual memory works. The second half describes how virtual memory is used and managed by applications. There is no avoiding the fact that VM is complicated, and the discussion reflects this in places. The good news is that if you work through the details, you will be able to simulate the virtual memory mechanism of a small system by hand, and the virtual memory idea will be forever demystified.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457ED" id="P70004970270000000000000000457ED">The second half builds on this understanding, showing you how to use and manage virtual memory in your programs. You will learn how to manage virtual memory via explicit memory mapping and calls to dynamic storage allocators such as the <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457EE" id="P70004970270000000000000000457EE">malloc</code> package. You will also learn about a host of common memory-related errors in C programs and how to avoid them.</p>
</section>
</section>
<!--EOF:P700049702700000000000000000702F-->
<!--EOF:P700049702700000000000000000703D-->
<!--EOF:P7000497027000000000000000007062-->
<!--EOF:P70004970270000000000000000070D3-->
<!--EOF:P70004970270000000000000000070EA-->
<!--EOF:P70004970270000000000000000070F6-->
<!--EOF:P7000497027000000000000000007216-->
<!--EOF:P70004970270000000000000000072B5-->
<!--EOF:P700049702700000000000000000733C-->
<!--EOF:P7000497027000000000000000007565-->
<!--EOF:P70004970270000000000000000075E8-->
<!--EOF:P7000497027000000000000000007654-->
<!--EOF:P700049702700000000000000000765E-->
<!--EOF:P7000497027000000000000000007663-->
<!--EOF:P700049702700000000000000000777C-->
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.1 Physical and Virtual Addressing</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P700049702700000000000000000702F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P70004970270000000000000000457EF" epub:type="title" id="P70004970270000000000000000457EF"><span class="pcalibre1 pcalibre21 pcalibre2">9.1 </span>Physical and Virtual Addressing</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457F0" id="P70004970270000000000000000457F0">The main memory of a computer system is organized as an array of <var class="pcalibre17 pcalibre2 pcalibre1">M</var> contiguous byte-size cells. Each byte has a unique <i class="pcalibre17 pcalibre2 pcalibre1">physical address (PA).</i> The first byte has an address of 0, the next byte an address of 1, the next byte an address of 2, and so on. Given this simple organization, the most natural way for a CPU to access memory would be to use physical addresses. We call this approach <i class="pcalibre17 pcalibre2 pcalibre1">physical addressing.</i> <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007033"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.1</span></a> shows an example of physical addressing in the context of a load instruction that reads the 4-byte word starting at physical address 4. When the CPU executes the load instruction, it generates an effective physical address and passes it to main memory over the memory bus. The main memory fetches the 4-byte word starting at physical address 4 and returns it to the CPU, which stores it in a register.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457F1" id="P70004970270000000000000000457F1">Early PCs used physical addressing, and systems such as digital signal processors, embedded microcontrollers, and Cray supercomputers continue to do so. However, modern processors use a form of addressing known as <i class="pcalibre17 pcalibre2 pcalibre1">virtual addressing</i>, as shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007037"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.2</span></a>.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007033" id="P7000497027000000000000000007033">
<img alt="A diagram shows a cycle: from CPU, physical address (PA) 4 is sent to main memory, where registers 4 through 7 are highlighted, from which data word is sent back to CPU." class="pcalibre1 pcalibre2 pcalibre258" data-uri="P700049702700000000000000000B779" id="P70004970270000000000000000457F2" src="Images/chapter-08-image-01.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000457F3" id="P70004970270000000000000000457F3"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000457F4" epub:type="title" id="P70004970270000000000000000457F4"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.1 </span>A system that uses physical addressing.</h1></header>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007037" id="P7000497027000000000000000007037">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007038" epub:type="pagebreak" id="P7000497027000000000000000007038" title="804"></span>
<img alt="A diagram shows a cycle between CPU chip and main memory." class="pcalibre1 pcalibre259 pcalibre2" data-uri="P700049702700000000000000000B77A" id="P70004970270000000000000000457F5" src="Images/chapter-08-image-02.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000457F6" id="P70004970270000000000000000457F6"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000457F7" epub:type="title" id="P70004970270000000000000000457F7"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.2 </span>A system that uses virtual addressing.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025B2A" id="P7000497027000000000000000025B2A">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000457F8" id="P70004970270000000000000000457F8">A diagram shows a cycle: within CPU chip, virtual address (VA) 4100 flows from CPU to MMU (address translation); physical address (PA) 4 flows from CPU chip to main memory, where registers 4 through 7 are highlighted, from which data word is sent back to CPU.</p>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457F9" id="P70004970270000000000000000457F9">With virtual addressing, the CPU accesses main memory by generating a <i class="pcalibre17 pcalibre2 pcalibre1">virtual address (VA)</i>, which is converted to the appropriate physical address before being sent to main memory. The task of converting a virtual address to a physical one is known as <i class="pcalibre17 pcalibre2 pcalibre1">address translation.</i> Like exception handling, address translation requires close cooperation between the CPU hardware and the operating system. Dedicated hardware on the CPU chip called the <i class="pcalibre17 pcalibre2 pcalibre1">memory management unit (MMU)</i> translates virtual addresses on the fly, using a lookup table stored in main memory whose contents are managed by the operating system.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.2 Address Spaces</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P700049702700000000000000000703D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P70004970270000000000000000457FA" epub:type="title" id="P70004970270000000000000000457FA"><span class="pcalibre1 pcalibre21 pcalibre2">9.2 </span>Address Spaces</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457FB" id="P70004970270000000000000000457FB">An <i class="pcalibre17 pcalibre2 pcalibre1">address space</i> is an ordered set of nonnegative integer addresses</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P70004970270000000000000000457FC" id="P70004970270000000000000000457FC"><m:math altimg="../images/ch09-eq1.png" altimg-height="19" altimg-width="105" alttext="" data-uri="" display="block"><m:mrow><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>0</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mn>1</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mn>2</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mo>…</m:mo></m:mrow> <m:mo>}</m:mo></m:mrow></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457FD" id="P70004970270000000000000000457FD">If the integers in the address space are consecutive, then we say that it is a <i class="pcalibre17 pcalibre2 pcalibre1">linear address space.</i> To simplify our discussion, we will always assume linear address spaces. In a system with virtual memory, the CPU generates virtual addresses from an address space of <var class="pcalibre17 pcalibre2 pcalibre1">N</var> = 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 pcalibre85">n</sup></i> addresses called the <i class="pcalibre17 pcalibre2 pcalibre1">virtual address space:</i></p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P70004970270000000000000000457FE" id="P70004970270000000000000000457FE"><m:math altimg="../images/ch09-eq2.png" altimg-height="19" altimg-width="173" alttext="" data-uri="" display="block"><m:mrow><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>0</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mn>1</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mn>2</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mo>…</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:mi>N</m:mi><m:mo>−</m:mo><m:mn>1</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000457FF" id="P70004970270000000000000000457FF">The size of an address space is characterized by the number of bits that are needed to represent the largest address. For example, a virtual address space with <var class="pcalibre17 pcalibre2 pcalibre1">N</var> = 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 pcalibre85">n</sup></i> addresses is called an <var class="pcalibre17 pcalibre2 pcalibre1">n</var>-bit address space. Modern systems typically support either 32-bit or 64-bit virtual address spaces.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045800" id="P7000497027000000000000000045800">A system also has <i class="pcalibre17 pcalibre2 pcalibre1">a physical address space</i> that corresponds to the <var class="pcalibre17 pcalibre2 pcalibre1">M</var> bytes of physical memory in the system:</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000045801" id="P7000497027000000000000000045801"><m:math altimg="../images/ch09-eq3.png" altimg-height="19" altimg-width="176" alttext="" data-uri="" display="block"><m:mrow><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>0</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mn>1</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mn>2</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mo>…</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:mi>M</m:mi><m:mo>−</m:mo><m:mn>1</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045802" id="P7000497027000000000000000045802"><var class="pcalibre17 pcalibre2 pcalibre1">M</var> is not required to be a power of 2, but to simplify the discussion, we will assume that <var class="pcalibre17 pcalibre2 pcalibre1">M</var> = 2<sup class="pcalibre1 pcalibre2 pcalibre85"><var class="pcalibre17 pcalibre2 pcalibre1">m</var></sup>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045803" id="P7000497027000000000000000045803"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007048" epub:type="pagebreak" id="P7000497027000000000000000007048" title="805"></span>The concept of an address space is important because it makes a clean distinction between data objects (bytes) and their attributes (addresses). Once we recognize this distinction, then we can generalize and allow each data object to have multiple independent addresses, each chosen from a different address space. This is the basic idea of virtual memory. Each byte of main memory has a virtual address chosen from the virtual address space, and a physical address chosen from the physical address space.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007049" epub:type="practice" id="P7000497027000000000000000007049"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045804" epub:type="title" id="P7000497027000000000000000045804"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.1 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007663.xhtml#P700049702700000000000000000774C">880</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000045805" id="P7000497027000000000000000045805">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000045806" id="P7000497027000000000000000045806">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045807" id="P7000497027000000000000000045807"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045808" id="P7000497027000000000000000045808">Complete the following table, filling in the missing entries and replacing each question mark with the appropriate integer. Use the following units: K = 2<sup class="pcalibre1 pcalibre2 pcalibre85">10</sup> (kilo), M = 2<sup class="pcalibre1 pcalibre2 pcalibre85">20</sup> (mega), G = 2<sup class="pcalibre1 pcalibre2 pcalibre85">30</sup> (giga), T = 2<sup class="pcalibre1 pcalibre2 pcalibre85">40</sup> (tera), P = 2<sup class="pcalibre1 pcalibre2 pcalibre85">50</sup> (peta), or E = 2<sup class="pcalibre1 pcalibre2 pcalibre85">60</sup> (exa).</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045809" id="P7000497027000000000000000045809">
<thead class="pcalibre44 pcalibre2 pcalibre1"><tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004580A" id="P700049702700000000000000004580A">Number of virtual address bits <i class="pcalibre17 pcalibre2 pcalibre1">(n)</i></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004580B" id="P700049702700000000000000004580B">Number of virtual addresses <i class="pcalibre17 pcalibre2 pcalibre1">(N)</i></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004580C" id="P700049702700000000000000004580C">Largest possible virtual address</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004580D" id="P700049702700000000000000004580D">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004580E" id="P700049702700000000000000004580E">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004580F" id="P700049702700000000000000004580F">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045810" id="P7000497027000000000000000045810">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045811" id="P7000497027000000000000000045811">2<sup class="pcalibre1 pcalibre2 calibre8">?</sup> = 64 K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045812" id="P7000497027000000000000000045812">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045813" id="P7000497027000000000000000045813">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045814" id="P7000497027000000000000000045814">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045815" id="P7000497027000000000000000045815">2<sup class="pcalibre1 pcalibre2 calibre8">32</sup> -- 1 =? G -- 1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045816" id="P7000497027000000000000000045816">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045817" id="P7000497027000000000000000045817">2<sup class="pcalibre1 pcalibre2 calibre8">?</sup> = 256 T</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045818" id="P7000497027000000000000000045818">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045819" id="P7000497027000000000000000045819">64</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004581A" id="P700049702700000000000000004581A">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004581B" id="P700049702700000000000000004581B">_____</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.3 VM as a Tool for Caching</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007062"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P700049702700000000000000004581C" epub:type="title" id="P700049702700000000000000004581C"><span class="pcalibre1 pcalibre21 pcalibre2">9.3 </span>VM as a Tool for Caching</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004581D" id="P700049702700000000000000004581D">Conceptually, a virtual memory is organized as an array of <var class="pcalibre17 pcalibre2 pcalibre1">N</var> contiguous byte-size cells stored on disk. Each byte has a unique virtual address that serves as an index into the array. The contents of the array on disk are cached in main memory. As with any other cache in the memory hierarchy, the data on disk (the lower level) is partitioned into blocks that serve as the transfer units between the disk and the main memory (the upper level). VM systems handle this by partitioning the virtual memory into fixed-size blocks called <i class="pcalibre17 pcalibre2 pcalibre1">virtual pages (VPs).</i> Each virtual page is <var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 2<sup class="pcalibre1 pcalibre2 pcalibre85"><var class="pcalibre17 pcalibre2 pcalibre1">P</var></sup> bytes in size. Similarly, physical memory is partitioned into <i class="pcalibre17 pcalibre2 pcalibre1">physical pages (PPs)</i>, also <var class="pcalibre17 pcalibre2 pcalibre1">P</var> bytes in size. (Physical pages are also referred to as <i class="pcalibre17 pcalibre2 pcalibre1">page frames.)</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004581E" id="P700049702700000000000000004581E">At any point in time, the set of virtual pages is partitioned into three disjoint subsets:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004581F" id="P700049702700000000000000004581F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045820" id="P7000497027000000000000000045820"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045821" id="P7000497027000000000000000045821"><span class="pcalibre1 pcalibre2 pcalibre41">Unallocated. </span>Pages that have not yet been allocated (or created) by the VM system. Unallocated blocks do not have any data associated with them, and thus do not occupy any space on disk.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045822" id="P7000497027000000000000000045822"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045823" id="P7000497027000000000000000045823"><span class="pcalibre1 pcalibre2 pcalibre41">Cached. </span>Allocated pages that are currently cached in physical memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045824" id="P7000497027000000000000000045824"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045825" id="P7000497027000000000000000045825"><span class="pcalibre1 pcalibre2 pcalibre41">Uncached. </span>Allocated pages that are not cached in physical memory.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045826" id="P7000497027000000000000000045826">The example in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000706E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.3</span></a> shows a small virtual memory with eight virtual pages. Virtual pages 0 and 3 have not been allocated yet, and thus do not yet exist</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000706E" id="P700049702700000000000000000706E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000706F" epub:type="pagebreak" id="P700049702700000000000000000706F" title="806"></span>
<img alt="A diagram shows links from pages of virtual memory to pages of physical memory." class="pcalibre1 pcalibre2 pcalibre260" data-uri="P700049702700000000000000000B77B" id="P7000497027000000000000000045827" src="Images/chapter-08-image-03.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045828" id="P7000497027000000000000000045828"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045829" epub:type="title" id="P7000497027000000000000000045829"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.3 </span>How a VM system uses main memory as a cache.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025B5D" id="P7000497027000000000000000025B5D">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004582A" id="P700049702700000000000000004582A">A diagram shows virtual memory, with virtual pages (VPs) stored on disk, and physical memory, with physical pages (PPs) cached in DRAM. The pages within each, and the interactions, are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P700049702700000000000000004582B" id="P700049702700000000000000004582B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004582C" id="P700049702700000000000000004582C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004582D" id="P700049702700000000000000004582D">Virtual memory (from 0 to N minus 1)</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P700049702700000000000000004582E" id="P700049702700000000000000004582E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004582F" id="P700049702700000000000000004582F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045830" id="P7000497027000000000000000045830">VP 0: Unallocated</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045831" id="P7000497027000000000000000045831"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045832" id="P7000497027000000000000000045832">VP 1: Cached (arrow to PP1 in physical memory)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045833" id="P7000497027000000000000000045833"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045834" id="P7000497027000000000000000045834">Uncached</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045835" id="P7000497027000000000000000045835"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045836" id="P7000497027000000000000000045836">Unallocated</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045837" id="P7000497027000000000000000045837"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045838" id="P7000497027000000000000000045838">Cached (arrow to PP 2<sup class="pcalibre1 pcalibre2 pcalibre85">m-p</sup> minus 1)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045839" id="P7000497027000000000000000045839"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004583A" id="P700049702700000000000000004583A">Uncached</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004583B" id="P700049702700000000000000004583B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004583C" id="P700049702700000000000000004583C">Cached (arrow between empty cells in physical memory)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004583D" id="P700049702700000000000000004583D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004583E" id="P700049702700000000000000004583E">VP 2<sup class="pcalibre1 pcalibre2 pcalibre85">n-p</sup> minus 1: Uncached</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004583F" id="P700049702700000000000000004583F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045840" id="P7000497027000000000000000045840">Physical memory (from 0 to M minus 1)</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045841" id="P7000497027000000000000000045841">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045842" id="P7000497027000000000000000045842"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045843" id="P7000497027000000000000000045843">PP 0: Empty</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045844" id="P7000497027000000000000000045844"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045845" id="P7000497027000000000000000045845">PP 1 (arrow from cached VP 1)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045846" id="P7000497027000000000000000045846"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045847" id="P7000497027000000000000000045847">Empty</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045848" id="P7000497027000000000000000045848"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045849" id="P7000497027000000000000000045849">(Arrow from third cache in viritual memory)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004584A" id="P700049702700000000000000004584A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004584B" id="P700049702700000000000000004584B">VP 2<sup class="pcalibre1 pcalibre2 pcalibre85">n-p</sup> minus 1 (arrow from second cache in virtual memory)</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004584C" id="P700049702700000000000000004584C">on disk. Virtual pages 1,4, and 6 are cached in physical memory. Pages 2,5, and 7 are allocated but are not currently cached in physical memory.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007074" id="P7000497027000000000000000007074"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004584D" epub:type="title" id="P700049702700000000000000004584D"><span class="pcalibre1 pcalibre21 pcalibre2">9.3.1 </span>DRAM Cache Organization</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004584E" id="P700049702700000000000000004584E">To help us keep the different caches in the memory hierarchy straight, we will use the term <i class="pcalibre17 pcalibre2 pcalibre1">SRAM cache</i> to denote the L1, L2, and L3 cache memories between the CPU and main memory, and the term <i class="pcalibre17 pcalibre2 pcalibre1">DRAM cache</i> to denote the VM system's cache that caches virtual pages in main memory.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004584F" id="P700049702700000000000000004584F">The position of the DRAM cache in the memory hierarchy has a big impact on the way that it is organized. Recall that a DRAM is at least 10 times slower than an SRAM and that disk is about 100,000 times slower than a DRAM. Thus, misses in DRAM caches are very expensive compared to misses in SRAM caches because DRAM cache misses are served from disk, while SRAM cache misses are usually served from DRAM-based main memory. Further, the cost of reading the first byte from a disk sector is about 100,000 times slower than reading successive bytes in the sector. The bottom line is that the organization of the DRAM cache is driven entirely by the enormous cost of misses.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045850" id="P7000497027000000000000000045850">Because of the large miss penalty and the expense of accessing the first byte, virtual pages tend to be large—typically 4 KB to 2 MB. Due to the large miss penalty, DRAM caches are fully associative; that is, any virtual page can be placed in any physical page. The replacement policy on misses also assumes greater importance, because the penalty associated with replacing the wrong virtual page is so high. Thus, operating systems use much more sophisticated replacement algorithms for DRAM caches than the hardware does for SRAM caches. (These replacement algorithms are beyond our scope here.) Finally, because of the large access time of disk, DRAM caches always use write-back instead of write-through.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007079" id="P7000497027000000000000000007079"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045851" epub:type="title" id="P7000497027000000000000000045851"><span class="pcalibre1 pcalibre21 pcalibre2">9.3.2 </span>Page Tables</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045852" id="P7000497027000000000000000045852">As with any cache, the VM system must have some way to determine if a virtual page is cached somewhere in DRAM. If so, the system must determine which physical page it is cached in. If there is a miss, the system must determine</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000707C" id="P700049702700000000000000000707C">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000707D" epub:type="pagebreak" id="P700049702700000000000000000707D" title="807"></span>
<img alt="A diagram shows a page table, linked to physical memory and virtual memory." class="pcalibre1 pcalibre2 pcalibre261" data-uri="P700049702700000000000000000B77C" id="P7000497027000000000000000045853" src="Images/chapter-08-image-04.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045854" id="P7000497027000000000000000045854"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045855" epub:type="title" id="P7000497027000000000000000045855"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.4 </span>Page table.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025B8A" id="P7000497027000000000000000025B8A">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045856" id="P7000497027000000000000000045856">A diagram shows a page table, linked to physical memory and virtual memory, each with pages summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045857" id="P7000497027000000000000000045857">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045858" id="P7000497027000000000000000045858"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045859" id="P7000497027000000000000000045859">Memory-resident page table (DRAM), with physical page number or disk address from PTE 0 through PTE 7:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P700049702700000000000000004585A" id="P700049702700000000000000004585A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004585B" id="P700049702700000000000000004585B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004585C" id="P700049702700000000000000004585C">PTE 0: Valid 0: Null</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004585D" id="P700049702700000000000000004585D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004585E" id="P700049702700000000000000004585E">PTE 1: Valid 1: Arrow to VP 1 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004585F" id="P700049702700000000000000004585F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045860" id="P7000497027000000000000000045860">PTE 2: Valid 1: Arrow to VP 2 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045861" id="P7000497027000000000000000045861"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045862" id="P7000497027000000000000000045862">PTE 3: Valid 0: Arrow to VP 3 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045863" id="P7000497027000000000000000045863"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045864" id="P7000497027000000000000000045864">PTE 4: Valid 1: Arrow to VP 4 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045865" id="P7000497027000000000000000045865"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045866" id="P7000497027000000000000000045866">PTE 5: Valid 0: Null</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045867" id="P7000497027000000000000000045867"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045868" id="P7000497027000000000000000045868">PTE 6: Valid 0: Arrow to VP 6 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045869" id="P7000497027000000000000000045869"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004586A" id="P700049702700000000000000004586A">PTE 7: Valid 1: Arrow to VP 7 (between VP 2 and 4) in physical memory</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004586B" id="P700049702700000000000000004586B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004586C" id="P700049702700000000000000004586C">Physical memory (DRAM): VP 1 (PP 0), VP 2, VP 7, and VP 4 (PP3)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004586D" id="P700049702700000000000000004586D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004586E" id="P700049702700000000000000004586E">Virtual memory (disk): VP 1, VP 2, VP 3, BP 4, VP 6, and VP 7</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004586F" id="P700049702700000000000000004586F">where the virtual page is stored on disk, select a victim page in physical memory, and copy the virtual page from disk to DRAM, replacing the victim page.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045870" id="P7000497027000000000000000045870">These capabilities are provided by a combination of operating system software, address translation hardware in the MMU (memory management unit), and a data structure stored in physical memory known as a <i class="pcalibre17 pcalibre2 pcalibre1">page table</i> that maps virtual pages to physical pages. The address translation hardware reads the page table each time it converts a virtual address to a physical address. The operating system is responsible for maintaining the contents of the page table and transferring pages back and forth between disk and DRAM.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045871" id="P7000497027000000000000000045871"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000707C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.4</span></a> shows the basic organization of a page table. A page table is an array of <i class="pcalibre17 pcalibre2 pcalibre1">page table entries (PTEs).</i> Each page in the virtual address space has a PTE at a fixed offset in the page table. For our purposes, we will assume that each PTE consists of a <i class="pcalibre17 pcalibre2 pcalibre1">valid bit</i> and an <var class="pcalibre17 pcalibre2 pcalibre1">n</var>-bit address field. The valid bit indicates whether the virtual page is currently cached in DRAM. If the valid bit is set, the address field indicates the start of the corresponding physical page in DRAM where the virtual page is cached. If the valid bit is not set, then a null address indicates that the virtual page has not yet been allocated. Otherwise, the address points to the start of the virtual page on disk.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045872" id="P7000497027000000000000000045872">The example in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000707C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.4</span></a> shows a page table for a system with eight virtual pages and four physical pages. Four virtual pages (VP 1, VP 2, VP 4, and VP 7) are currently cached in DRAM. Two pages (VP 0 and VP 5) have not yet been allocated, and the rest (VP 3 and VP 6) have been allocated but are not currently cached. An important point to notice about <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000707C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.4</span></a> is that because the DRAM cache is fully associative, any physical page can contain any virtual page.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007085" epub:type="practice" id="P7000497027000000000000000007085"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045873" epub:type="title" id="P7000497027000000000000000045873"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.2 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000777C.xhtml#P7000497027000000000000000007785">881</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000045874" id="P7000497027000000000000000045874">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000045875" id="P7000497027000000000000000045875">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045876" id="P7000497027000000000000000045876"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045877" id="P7000497027000000000000000045877">Determine the number of page table entries (PTEs) that are needed for the following combinations of virtual address size (<var class="pcalibre17 pcalibre2 pcalibre1">n</var>) and page size (<var class="pcalibre17 pcalibre2 pcalibre1">P</var>):</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045878" id="P7000497027000000000000000045878">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045879" id="P7000497027000000000000000045879"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000708D" epub:type="pagebreak" id="P700049702700000000000000000708D" title="808"></span><var class="pcalibre17 pcalibre2 pcalibre1">n</var></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004587A" id="P700049702700000000000000004587A"><var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 calibre8">p</sup></i></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004587B" id="P700049702700000000000000004587B">Number of PTEs</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004587C" id="P700049702700000000000000004587C">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004587D" id="P700049702700000000000000004587D">4K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004587E" id="P700049702700000000000000004587E">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004587F" id="P700049702700000000000000004587F">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045880" id="P7000497027000000000000000045880">8K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045881" id="P7000497027000000000000000045881">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045882" id="P7000497027000000000000000045882">32</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045883" id="P7000497027000000000000000045883">4K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045884" id="P7000497027000000000000000045884">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045885" id="P7000497027000000000000000045885">32</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045886" id="P7000497027000000000000000045886">8K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045887" id="P7000497027000000000000000045887">_____</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000709C" id="P700049702700000000000000000709C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045888" epub:type="title" id="P7000497027000000000000000045888"><span class="pcalibre1 pcalibre21 pcalibre2">9.3.3 </span>Page Hits</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045889" id="P7000497027000000000000000045889">Consider what happens when the CPU reads a word of virtual memory contained in VP 2, which is cached in DRAM (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000070A2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.5</span></a>). Using a technique we will describe in detail in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000070F6.xhtml#P70004970270000000000000000070F6"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.6</span></a>, the address translation hardware uses the virtual address as an index to locate PTE 2 and read it from memory. Since the valid bit is set, the address translation hardware knows that VP 2 is cached in memory. So it uses the physical memory address in the PTE (which points to the start of the cached page in PP 1) to construct the physical address of the word.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000709F" id="P700049702700000000000000000709F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004588A" epub:type="title" id="P700049702700000000000000004588A"><span class="pcalibre1 pcalibre21 pcalibre2">9.3.4 </span>Page Faults</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004588B" id="P700049702700000000000000004588B">In virtual memory parlance, a DRAM cache miss is known as a <i class="pcalibre17 pcalibre2 pcalibre1">page fault.</i> <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000070A8"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.6</span></a> shows the state of our example page table before the fault. The CPU has referenced a word in VP 3, which is not cached in DRAM. The address translation hardware reads PTE 3 from memory, infers from the valid bit that VP 3 is not cached, and triggers a page fault exception. The page fault exception invokes a page fault exception handler in the kernel, which selects a victim page—in this case, VP 4 stored in PP 3. If VP 4 has been modified, then the kernel copies it back to disk. In either case, the kernel modifies the page table entry for VP 4 to reflect the fact that VP 4 is no longer cached in main memory.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000070A2" id="P70004970270000000000000000070A2">
<img alt="A diagram shows a page table, linked to physical memory and virtual memory, with input from virtual address." class="pcalibre1 pcalibre2 pcalibre262" data-uri="P700049702700000000000000000B77D" id="P700049702700000000000000004588C" src="Images/chapter-08-image-05.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P700049702700000000000000004588D" id="P700049702700000000000000004588D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P700049702700000000000000004588E" epub:type="title" id="P700049702700000000000000004588E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.5 </span>VM page hit.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P700049702700000000000000004588F" id="P700049702700000000000000004588F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045890" id="P7000497027000000000000000045890">The reference to a word in VP 2 is a hit.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025BC6" id="P7000497027000000000000000025BC6">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045891" id="P7000497027000000000000000045891">A diagram shows a page table, with virtual address to PTE 2, linked to physical memory and virtual memory, each with pages summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045892" id="P7000497027000000000000000045892">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045893" id="P7000497027000000000000000045893"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045894" id="P7000497027000000000000000045894">Memory-resident page table (DRAM), with physical page number or disk address from PTE 0 through PTE 7:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045895" id="P7000497027000000000000000045895">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045896" id="P7000497027000000000000000045896"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045897" id="P7000497027000000000000000045897">PTE 0: Valid 0: Null</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045898" id="P7000497027000000000000000045898"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045899" id="P7000497027000000000000000045899">PTE 1: Valid 1: Arrow to VP 1 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004589A" id="P700049702700000000000000004589A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004589B" id="P700049702700000000000000004589B">PTE 2: Valid 1: Arrow to VP 2 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004589C" id="P700049702700000000000000004589C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004589D" id="P700049702700000000000000004589D">PTE 3: Valid 0: Arrow to VP 3 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004589E" id="P700049702700000000000000004589E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004589F" id="P700049702700000000000000004589F">PTE 4: Valid 1: Arrow to VP 4 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458A0" id="P70004970270000000000000000458A0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458A1" id="P70004970270000000000000000458A1">PTE 5: Valid 0: Null</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458A2" id="P70004970270000000000000000458A2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458A3" id="P70004970270000000000000000458A3">PTE 6: Valid 0: Arrow to VP 6 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458A4" id="P70004970270000000000000000458A4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458A5" id="P70004970270000000000000000458A5">PTE 7: Valid 1: Arrow to VP 7 (between VP 2 and 4) in physical memory</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458A6" id="P70004970270000000000000000458A6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458A7" id="P70004970270000000000000000458A7">Physical memory (DRAM): VP 1 (PP 0), VP 2, VP 7, and VP 4 (PP3)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458A8" id="P70004970270000000000000000458A8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458A9" id="P70004970270000000000000000458A9">Virtual memory (disk): VP 1, VP 2, VP 3, BP 4, VP 6, and VP 7</p></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000070A8" id="P70004970270000000000000000070A8">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000070A9" epub:type="pagebreak" id="P70004970270000000000000000070A9" title="809"></span>
<img alt="A diagram shows a page table, linked to physical memory and virtual memory, with input from virtual address." class="pcalibre1 pcalibre2 pcalibre262" data-uri="P700049702700000000000000000B77E" id="P70004970270000000000000000458AA" src="Images/chapter-08-image-06.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000458AB" id="P70004970270000000000000000458AB"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000458AC" epub:type="title" id="P70004970270000000000000000458AC"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.6 </span>VM page fault (before).</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000458AD" id="P70004970270000000000000000458AD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458AE" id="P70004970270000000000000000458AE">The reference to a word in VP 3 is a miss and triggers a page fault.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025BE5" id="P7000497027000000000000000025BE5">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000458AF" id="P70004970270000000000000000458AF">A diagram shows a page table, with virtual address to PTE 3, linked to physical memory and virtual memory, each with pages summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P70004970270000000000000000458B0" id="P70004970270000000000000000458B0">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458B1" id="P70004970270000000000000000458B1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458B2" id="P70004970270000000000000000458B2">Memory-resident page table (DRAM), with physical page number or disk address from PTE 0 through PTE 7:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P70004970270000000000000000458B3" id="P70004970270000000000000000458B3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458B4" id="P70004970270000000000000000458B4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458B5" id="P70004970270000000000000000458B5">PTE 0: Valid 0: Null</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458B6" id="P70004970270000000000000000458B6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458B7" id="P70004970270000000000000000458B7">PTE 1: Valid 1: Arrow to VP 1 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458B8" id="P70004970270000000000000000458B8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458B9" id="P70004970270000000000000000458B9">PTE 2: Valid 1: Arrow to VP 2 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458BA" id="P70004970270000000000000000458BA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458BB" id="P70004970270000000000000000458BB">PTE 3: Valid 0: Arrow to VP 3 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458BC" id="P70004970270000000000000000458BC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458BD" id="P70004970270000000000000000458BD">PTE 4: Valid 1: Arrow to VP 4 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458BE" id="P70004970270000000000000000458BE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458BF" id="P70004970270000000000000000458BF">PTE 5: Valid 0: Null</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458C0" id="P70004970270000000000000000458C0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458C1" id="P70004970270000000000000000458C1">PTE 6: Valid 0: Arrow to VP 6 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458C2" id="P70004970270000000000000000458C2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458C3" id="P70004970270000000000000000458C3">PTE 7: Valid 1: Arrow to VP 7 (between VP 2 and 4) in physical memory</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458C4" id="P70004970270000000000000000458C4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458C5" id="P70004970270000000000000000458C5">Physical memory (DRAM): VP 1 (PP 0), VP 2, VP 7, and VP 4 (PP3)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458C6" id="P70004970270000000000000000458C6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458C7" id="P70004970270000000000000000458C7">Virtual memory (disk): VP 1, VP 2, VP 3, BP 4, VP 6, and VP 7</p></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000070AF" id="P70004970270000000000000000070AF">
<img alt="A diagram shows a page table, linked to physical memory and virtual memory, with input from virtual address." class="pcalibre1 pcalibre2 pcalibre262" data-uri="P700049702700000000000000000B77F" id="P70004970270000000000000000458C8" src="Images/chapter-08-image-07.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000458C9" id="P70004970270000000000000000458C9"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000458CA" epub:type="title" id="P70004970270000000000000000458CA"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.7 </span>VM page fault (after).</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000458CB" id="P70004970270000000000000000458CB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458CC" id="P70004970270000000000000000458CC">The page fault handler selects VP 4 as the victim and replaces it with a copy of VP 3 from disk. After the page fault handler restarts the faulting instruction, it will read the word from memory normally, without generating an exception.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025C04" id="P7000497027000000000000000025C04">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000458CD" id="P70004970270000000000000000458CD">A diagram shows a page table, with virtual address to PTE 3, linked to physical memory and virtual memory, each with pages summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P70004970270000000000000000458CE" id="P70004970270000000000000000458CE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458CF" id="P70004970270000000000000000458CF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458D0" id="P70004970270000000000000000458D0">Memory-resident page table (DRAM), with physical page number or disk address from PTE 0 through PTE 7:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P70004970270000000000000000458D1" id="P70004970270000000000000000458D1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458D2" id="P70004970270000000000000000458D2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458D3" id="P70004970270000000000000000458D3">PTE 0: Valid 0: Null</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458D4" id="P70004970270000000000000000458D4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458D5" id="P70004970270000000000000000458D5">PTE 1: Valid 1: Arrow to VP 1 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458D6" id="P70004970270000000000000000458D6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458D7" id="P70004970270000000000000000458D7">PTE 2: Valid 1: Arrow to VP 2 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458D8" id="P70004970270000000000000000458D8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458D9" id="P70004970270000000000000000458D9">PTE 3: Valid 1: Arrow to VP 3 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458DA" id="P70004970270000000000000000458DA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458DB" id="P70004970270000000000000000458DB">PTE 4: Valid 1: Arrow to VP 4 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458DC" id="P70004970270000000000000000458DC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458DD" id="P70004970270000000000000000458DD">PTE 5: Valid 0: Null</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458DE" id="P70004970270000000000000000458DE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458DF" id="P70004970270000000000000000458DF">PTE 6: Valid 0: Arrow to VP 6 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458E0" id="P70004970270000000000000000458E0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458E1" id="P70004970270000000000000000458E1">PTE 7: Valid 1: Arrow to VP 7 (between VP 2 and 4) in physical memory</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458E2" id="P70004970270000000000000000458E2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458E3" id="P70004970270000000000000000458E3">Physical memory (DRAM): VP 1 (PP 0), VP 2, VP 7, and VP 4 (PP3)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458E4" id="P70004970270000000000000000458E4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458E5" id="P70004970270000000000000000458E5">Virtual memory (disk): VP 1, VP 2, VP 3, BP 4, VP 6, and VP 7</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000458E6" id="P70004970270000000000000000458E6">Next, the kernel copies VP 3 from disk to PP 3 in memory, updates PTE 3, and then returns. When the handler returns, it restarts the faulting instruction, which resends the faulting virtual address to the address translation hardware. But now, VP 3 is cached in main memory, and the page hit is handled normally by the address translation hardware. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000070AF"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.7</span></a> shows the state of our example page table after the page fault.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000458E7" id="P70004970270000000000000000458E7">Virtual memory was invented in the early 1960s, long before the widening CPU-memory gap spawned SRAM caches. As a result, virtual memory systems use a different terminology from SRAM caches, even though many of the ideas are similar. In virtual memory parlance, blocks are known as pages. The activity of transferring a page between disk and memory is known as <i class="pcalibre17 pcalibre2 pcalibre1">swapping</i> or <i class="pcalibre17 pcalibre2 pcalibre1">paging.</i> Pages are <i class="pcalibre17 pcalibre2 pcalibre1">swapped in (paged in)</i> from disk to DRAM, and <i class="pcalibre17 pcalibre2 pcalibre1">swapped out (paged out)</i> from DRAM to disk. The strategy of waiting until the last moment to swap</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000070B7" id="P70004970270000000000000000070B7">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000070B8" epub:type="pagebreak" id="P70004970270000000000000000070B8" title="810"></span>
<img alt="A diagram shows a page table, linked to physical memory and virtual memory." class="pcalibre1 pcalibre2 pcalibre263" data-uri="P700049702700000000000000000B780" id="P70004970270000000000000000458E8" src="Images/chapter-08-image-08.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000458E9" id="P70004970270000000000000000458E9"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000458EA" epub:type="title" id="P70004970270000000000000000458EA"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.8 </span>Allocating a new virtual page.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000458EB" id="P70004970270000000000000000458EB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458EC" id="P70004970270000000000000000458EC">The kernel allocates VP 5 on disk and points PTE 5 to this new location.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025C25" id="P7000497027000000000000000025C25">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000458ED" id="P70004970270000000000000000458ED">A diagram shows a page table, linked to physical memory and virtual memory, each with pages summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P70004970270000000000000000458EE" id="P70004970270000000000000000458EE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458EF" id="P70004970270000000000000000458EF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458F0" id="P70004970270000000000000000458F0">Memory-resident page table (DRAM), with physical page number or disk address from PTE 0 through PTE 7:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P70004970270000000000000000458F1" id="P70004970270000000000000000458F1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458F2" id="P70004970270000000000000000458F2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458F3" id="P70004970270000000000000000458F3">PTE 0: Valid 0: Null</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458F4" id="P70004970270000000000000000458F4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458F5" id="P70004970270000000000000000458F5">PTE 1: Valid 1: Arrow to VP 1 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458F6" id="P70004970270000000000000000458F6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458F7" id="P70004970270000000000000000458F7">PTE 2: Valid 1: Arrow to VP 2 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458F8" id="P70004970270000000000000000458F8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458F9" id="P70004970270000000000000000458F9">PTE 3: Valid 1: Arrow to VP 3 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458FA" id="P70004970270000000000000000458FA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458FB" id="P70004970270000000000000000458FB">PTE 4: Valid 0: Arrow to VP 4 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458FC" id="P70004970270000000000000000458FC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458FD" id="P70004970270000000000000000458FD">PTE 5: Valid 0: Arrow to VP 5 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000458FE" id="P70004970270000000000000000458FE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000458FF" id="P70004970270000000000000000458FF">PTE 6: Valid 0: Arrow to VP 6 in virtual memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045900" id="P7000497027000000000000000045900"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045901" id="P7000497027000000000000000045901">PTE 7: Valid 1: Arrow to VP 7 (between VP 2 and 4) in physical memory</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045902" id="P7000497027000000000000000045902"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045903" id="P7000497027000000000000000045903">Physical memory (DRAM): VP 1 (PP 0), VP 2, VP 7, and VP 4 (PP3)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045904" id="P7000497027000000000000000045904"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045905" id="P7000497027000000000000000045905">Virtual memory (disk): VP 1 through VP 7</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045906" id="P7000497027000000000000000045906">in a page, when a miss occurs, is known as <i class="pcalibre17 pcalibre2 pcalibre1">demand paging.</i> Other approaches, such as trying to predict misses and swap pages in before they are actually referenced, are possible. However, all modern systems use demand paging.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000070BF" id="P70004970270000000000000000070BF"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045907" epub:type="title" id="P7000497027000000000000000045907"><span class="pcalibre1 pcalibre21 pcalibre2">9.3.5 </span>Allocating Pages</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045908" id="P7000497027000000000000000045908"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000070B7"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.8</span></a> shows the effect on our example page table when the operating system allocates a new page of virtual memory—for example, as a result of calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045909" id="P7000497027000000000000000045909">malloc</code>. In the example, VP 5 is allocated by creating room on disk and updating PTE 5 to point to the newly created page on disk.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000070C3" id="P70004970270000000000000000070C3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004590A" epub:type="title" id="P700049702700000000000000004590A"><span class="pcalibre1 pcalibre21 pcalibre2">9.3.6 </span>Locality to the Rescue Again</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004590B" id="P700049702700000000000000004590B">When many of us learn about the idea of virtual memory, our first impression is often that it must be terribly inefficient. Given the large miss penalties, we worry that paging will destroy program performance. In practice, virtual memory works well, mainly because of our old friend <i class="pcalibre17 pcalibre2 pcalibre1">locality.</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004590C" id="P700049702700000000000000004590C">Although the total number of distinct pages that programs reference during an entire run might exceed the total size of physical memory, the principle of locality promises that at any point in time they will tend to work on a smaller set of <i class="pcalibre17 pcalibre2 pcalibre1">active pages</i> known as the <i class="pcalibre17 pcalibre2 pcalibre1">working set</i> or <i class="pcalibre17 pcalibre2 pcalibre1">resident set.</i> After an initial overhead where the working set is paged into memory, subsequent references to the working set result in hits, with no additional disk traffic.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004590D" id="P700049702700000000000000004590D">As long as our programs have good temporal locality, virtual memory systems work quite well. But of course, not all programs exhibit good temporal locality. If the working set size exceeds the size of physical memory, then the program can produce an unfortunate situation known as <i class="pcalibre17 pcalibre2 pcalibre1">thrashing</i>, where pages are swapped in and out continuously. Although virtual memory is usually efficient, if a program's performance slows to a crawl, the wise programmer will consider the possibility that it is thrashing.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000070C8" id="P70004970270000000000000000070C8"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter09.xhtml#P700049702700000000000000004590E" epub:type="title" id="P700049702700000000000000004590E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000070CA" epub:type="pagebreak" id="P70004970270000000000000000070CA" title="811"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Counting page faults</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004590F" id="P700049702700000000000000004590F">You can monitor the number of page faults (and lots of other information) with the Linux <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045910" id="P7000497027000000000000000045910">getrusage</code> function.</p>
</aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000070CD" id="P70004970270000000000000000070CD">
<img alt="A diagram illustrates connections between virtual address spaces and physical memory for two processes." class="pcalibre1 pcalibre264 pcalibre2" data-uri="P700049702700000000000000000B781" id="P7000497027000000000000000045911" src="Images/chapter-08-image-09.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045912" id="P7000497027000000000000000045912"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045913" epub:type="title" id="P7000497027000000000000000045913"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.9 </span>How VM provides processes with separate address spaces.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045914" id="P7000497027000000000000000045914"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045915" id="P7000497027000000000000000045915">The operating system maintains a separate page table for each process in the system.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025C4F" id="P7000497027000000000000000025C4F">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045916" id="P7000497027000000000000000045916">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045917" id="P7000497027000000000000000045917"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045918" id="P7000497027000000000000000045918">Process i: address translation from VP 1 address space to PP 2 in physical memory, and from VP 2 to PP 7.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045919" id="P7000497027000000000000000045919"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004591A" id="P700049702700000000000000004591A">Process j: translation from VP 1 to PP 7 (shared page), and from VP 2 to PP 10.</p></li>
</ul>
</details>
</figcaption>
</figure>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.4 VM as a Tool for Memory Management</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000070D3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P700049702700000000000000004591B" epub:type="title" id="P700049702700000000000000004591B"><span class="pcalibre1 pcalibre21 pcalibre2">9.4 </span>VM as a Tool for Memory Management</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004591C" id="P700049702700000000000000004591C">In the last section, we saw how virtual memory provides a mechanism for using the DRAM to cache pages from a typically larger virtual address space. Interestingly, some early systems such as the DEC PDP-11/70 supported a virtual address space that was <i class="pcalibre17 pcalibre2 pcalibre1">smaller</i> than the available physical memory. Yet virtual memory was still a useful mechanism because it greatly simplified memory management and provided a natural way to protect memory.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004591D" id="P700049702700000000000000004591D">Thus far, we have assumed a single page table that maps a single virtual address space to the physical address space. In fact, operating systems provide a separate page table, and thus a separate virtual address space, for each process. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007062.xhtml#P70004970270000000000000000070CD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9</span></a> shows the basic idea. In the example, the page table for process <var class="pcalibre17 pcalibre2 pcalibre1">i</var> maps VP 1 to PP 2 and VP 2 to PP 7. Similarly, the page table for process <var class="pcalibre17 pcalibre2 pcalibre1">j</var> maps VP 1 to PP 7 and VP 2 to PP 10. Notice that multiple virtual pages can be mapped to the same shared physical page.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004591E" id="P700049702700000000000000004591E">The combination of demand paging and separate virtual address spaces has a profound impact on the way that memory is used and managed in a system. In particular, VM simplifies linking and loading, the sharing of code and data, and allocating memory to applications.</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004591F" id="P700049702700000000000000004591F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045920" id="P7000497027000000000000000045920"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045921" id="P7000497027000000000000000045921"><span class="pcalibre1 pcalibre2 pcalibre41">Simplifying linking. </span>A separate address space allows each process to use the same basic format for its memory image, regardless of where the code and data actually reside in physical memory. For example, as we saw in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000070F6.xhtml#P700049702700000000000000000713C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">8.13</span></a>, every process on a given Linux system has a similar memory format. For 64-bit address spaces, the code segment <i class="pcalibre17 pcalibre2 pcalibre1">always</i> starts at virtual address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045922" id="P7000497027000000000000000045922">0x400000</code>. The data segment follows the code segment after a suitable alignment gap. The stack occupies the highest portion of the user process address space and <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000070DC" epub:type="pagebreak" id="P70004970270000000000000000070DC" title="812"></span>grows downward. Such uniformity greatly simplifies the design and implementation of linkers, allowing them to produce fully linked executables that are independent of the ultimate location of the code and data in physical memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045923" id="P7000497027000000000000000045923"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045924" id="P7000497027000000000000000045924"><span class="pcalibre1 pcalibre2 pcalibre41">Simplifying loading. </span>Virtual memory also makes it easy to load executable and shared object files into memory. To load the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045925" id="P7000497027000000000000000045925">.text</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045926" id="P7000497027000000000000000045926">.data</code> sections of an object file into a newly created process, the Linux loader allocates virtual pages for the code and data segments, marks them as invalid (i.e., not cached), and points their page table entries to the appropriate locations in the object file. The interesting point is that the loader never actually copies any data from disk into memory. The data are paged in automatically and on demand by the virtual memory system the first time each page is referenced, either by the CPU when it fetches an instruction or by an executing instruction when it references a memory location.</p>
<p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter09.xhtml#P7000497027000000000000000045927" id="P7000497027000000000000000045927">This notion of mapping a set of contiguous virtual pages to an arbitrary location in an arbitrary file is known as <i class="pcalibre17 pcalibre2 pcalibre1">memory mapping.</i> Linux provides a system call called <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045928" id="P7000497027000000000000000045928">mmap</code> that allows application programs to do their own memory mapping. We will describe application-level memory mapping in more detail in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000072B5.xhtml#P70004970270000000000000000072B5"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.8</span></a>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045929" id="P7000497027000000000000000045929"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004592A" id="P700049702700000000000000004592A"><span class="pcalibre1 pcalibre2 pcalibre41">Simplifying sharing. </span>Separate address spaces provide the operating system with a consistent mechanism for managing sharing between user processes and the operating system itself. In general, each process has its own private code, data, heap, and stack areas that are not shared with any other process. In this case, the operating system creates page tables that map the corresponding virtual pages to disjoint physical pages.</p>
<p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter09.xhtml#P700049702700000000000000004592B" id="P700049702700000000000000004592B">However, in some instances it is desirable for processes to share code and data. For example, every process must call the same operating system kernel code, and every C program makes calls to routines in the standard C library such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004592C" id="P700049702700000000000000004592C">printf</code>. Rather than including separate copies of the kernel and standard C library in each process, the operating system can arrange for multiple processes to share a single copy of this code by mapping the appropriate virtual pages in different processes to the same physical pages, as we saw in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007062.xhtml#P70004970270000000000000000070CD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9</span></a>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004592D" id="P700049702700000000000000004592D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004592E" id="P700049702700000000000000004592E"><span class="pcalibre1 pcalibre2 pcalibre41">Simplifying memory allocation. </span>Virtual memory provides a simple mechanism for allocating additional memory to user processes. When a program running in a user process requests additional heap space (e.g., as a result of calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004592F" id="P700049702700000000000000004592F">malloc</code>), the operating system allocates an appropriate number, say, <var class="pcalibre17 pcalibre2 pcalibre1">k</var>, of contiguous virtual memory pages, and maps them to <var class="pcalibre17 pcalibre2 pcalibre1">k</var> arbitrary physical pages located anywhere in physical memory. Because of the way page tables work, there is no need for the operating system to locate <var class="pcalibre17 pcalibre2 pcalibre1">k</var> contiguous pages of physical memory. The pages can be scattered randomly in physical memory.</p></li>
</ul>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.5 VM as a Tool for Memory Protection</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000070EA"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045930" epub:type="title" id="P7000497027000000000000000045930"><span class="pcalibre1 pcalibre21 pcalibre2">9.5 </span>VM as a Tool for Memory Protection</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045931" id="P7000497027000000000000000045931">Any modern computer system must provide the means for the operating system to control access to the memory system. A user process should not be allowed</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000070ED" id="P70004970270000000000000000070ED">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000070EE" epub:type="pagebreak" id="P70004970270000000000000000070EE" title="813"></span>
<img alt="A diagram illustrates connections from pages tables with permission bits to physical memory, for two processes." class="calibre67 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B782" id="P7000497027000000000000000045932" src="Images/chapter-08-image-10.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045933" id="P7000497027000000000000000045933"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045934" epub:type="title" id="P7000497027000000000000000045934"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.10 </span>Using VM to provide page-level memory protection.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025C6F" id="P7000497027000000000000000025C6F">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045935" id="P7000497027000000000000000045935">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045936" id="P7000497027000000000000000045936"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045937" id="P7000497027000000000000000045937">Process i: page tables with permission bits is summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045938" id="P7000497027000000000000000045938">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045939" id="P7000497027000000000000000045939"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004593A" id="P700049702700000000000000004593A">VP 0: Sup No, Read Yes, Write No, Address PP 6, leading to PP 6 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004593B" id="P700049702700000000000000004593B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004593C" id="P700049702700000000000000004593C">VP 1: Sup No, Read Yes, Write Yes, Address PP 4, leading to PP 4 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004593D" id="P700049702700000000000000004593D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004593E" id="P700049702700000000000000004593E">VP 2: Sup Yes, Read, Yes, Write Yes, Address PP 2, leading to PP 2 in physical memory</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004593F" id="P700049702700000000000000004593F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045940" id="P7000497027000000000000000045940">Process j:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045941" id="P7000497027000000000000000045941">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045942" id="P7000497027000000000000000045942"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045943" id="P7000497027000000000000000045943">VP 0: Sup No, Read Yes, Write No, Address PP 9, leading to PP 9 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045944" id="P7000497027000000000000000045944"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045945" id="P7000497027000000000000000045945">VP 1: Sup Yes, Read Yes, Write Yes, Address PP 6, leading to PP 6 in physical memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045946" id="P7000497027000000000000000045946"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045947" id="P7000497027000000000000000045947">VP 2: Sup No, Read, Yes, Write Yes, Address PP 11, leading to PP 11 in physical memory</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045948" id="P7000497027000000000000000045948">to modify its read-only code section. Nor should it be allowed to read or modify any of the code and data structures in the kernel. It should not be allowed to read or write the private memory of other processes, and it should not be allowed to modify any virtual pages that are shared with other processes, unless all parties explicitly allow it (via calls to explicit interprocess communication system calls).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045949" id="P7000497027000000000000000045949">As we have seen, providing separate virtual address spaces makes it easy to isolate the private memories of different processes. But the address translation mechanism can be extended in a natural way to provide even finer access control. Since the address translation hardware reads a PTE each time the CPU generates an address, it is straightforward to control access to the contents of a virtual page by adding some additional permission bits to the PTE. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000070ED"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.10</span></a> shows the general idea.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004594A" id="P700049702700000000000000004594A">In this example, we have added three permission bits to each PTE. The SUP bit indicates whether processes must be running in kernel (supervisor) mode to access the page. Processes running in kernel mode can access any page, but processes running in user mode are only allowed to access pages for which SUP is 0. The READ and WRITE bits control read and write access to the page. For example, if process <var class="pcalibre17 pcalibre2 pcalibre1">i</var> is running in user mode, then it has permission to read VP 0 and to read or write VP 1. However, it is not allowed to access VP 2.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004594B" id="P700049702700000000000000004594B">If an instruction violates these permissions, then the CPU triggers a general protection fault that transfers control to an exception handler in the kernel, which sends a SIGSEGV signal to the offending process. Linux shells typically report this exception as a "segmentation fault."</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.6 Address Translation</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000070F6"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P700049702700000000000000004594C" epub:type="title" id="P700049702700000000000000004594C"><span class="pcalibre1 pcalibre21 pcalibre2">9.6 </span>Address Translation</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004594D" id="P700049702700000000000000004594D">This section covers the basics of address translation. Our aim is to give you an appreciation of the hardware's role in supporting virtual memory, with enough detail so that you can work through some concrete examples by hand. However, keep in mind that we are omitting a number of details, especially related to timing,</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000070F9" id="P70004970270000000000000000070F9">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P700049702700000000000000004594E" id="P700049702700000000000000004594E">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004594F" id="P700049702700000000000000004594F"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter09.xhtml#P70004970270000000000000000070FC" epub:type="pagebreak" id="P70004970270000000000000000070FC" title="814"></span>Symbol</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045950" id="P7000497027000000000000000045950">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" colspan="2" data-uri="chapter09.xhtml#P7000497027000000000000000045951" id="P7000497027000000000000000045951">Basic parameters</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045952" id="P7000497027000000000000000045952"><var class="pcalibre17 pcalibre2 pcalibre1">N</var> = 2<sup class="pcalibre1 pcalibre2 calibre8"><var class="pcalibre17 pcalibre2 pcalibre1">n</var></sup></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045953" id="P7000497027000000000000000045953">Number of addresses in virtual address space</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045954" id="P7000497027000000000000000045954"><var class="pcalibre17 pcalibre2 pcalibre1">M</var> = 2<sup class="pcalibre1 pcalibre2 calibre8"><var class="pcalibre17 pcalibre2 pcalibre1">m</var></sup></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045955" id="P7000497027000000000000000045955">Number of addresses in physical address space</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045956" id="P7000497027000000000000000045956"><var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 calibre8">p</sup></i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045957" id="P7000497027000000000000000045957">Page size (bytes)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" colspan="2" data-uri="chapter09.xhtml#P7000497027000000000000000045958" id="P7000497027000000000000000045958">Components of a virtual address (VA)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045959" id="P7000497027000000000000000045959">VPO</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004595A" id="P700049702700000000000000004595A">Virtual page offset (bytes)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004595B" id="P700049702700000000000000004595B">VPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004595C" id="P700049702700000000000000004595C">Virtual page number</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004595D" id="P700049702700000000000000004595D">TLBI</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004595E" id="P700049702700000000000000004595E">TLB index</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004595F" id="P700049702700000000000000004595F">TLBT</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045960" id="P7000497027000000000000000045960">TLB tag</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" colspan="2" data-uri="chapter09.xhtml#P7000497027000000000000000045961" id="P7000497027000000000000000045961">Components of a physical address (PA)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045962" id="P7000497027000000000000000045962">PPO</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045963" id="P7000497027000000000000000045963">Physical page offset (bytes)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045964" id="P7000497027000000000000000045964">PPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045965" id="P7000497027000000000000000045965">Physical page number</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045966" id="P7000497027000000000000000045966">CO</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045967" id="P7000497027000000000000000045967">Byte offset within cache block</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045968" id="P7000497027000000000000000045968">CI</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045969" id="P7000497027000000000000000045969">Cache index</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004596A" id="P700049702700000000000000004596A">CT</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004596B" id="P700049702700000000000000004596B">Cache tag</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P700049702700000000000000004596C" id="P700049702700000000000000004596C"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P700049702700000000000000004596D" epub:type="title" id="P700049702700000000000000004596D"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.11 </span>Summary of address translation symbols.</h1></header></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004596E" id="P700049702700000000000000004596E">that are important to hardware designers but are beyond our scope. For your reference, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000070F9"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.11</span></a> summarizes the symbols that we will be using throughout this section.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004596F" id="P700049702700000000000000004596F">Formally, address translation is a mapping between the elements of an <var class="pcalibre17 pcalibre2 pcalibre1">N</var>-element virtual address space (VAS) and an M-element physical address space (PAS),</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000045970" id="P7000497027000000000000000045970"><m:math altimg="../images/ch09-eq4.png" altimg-height="16" altimg-width="206" alttext="" data-uri="" display="block"><m:mrow><m:mtext>MAP</m:mtext><m:mo>:</m:mo><m:mtext> </m:mtext><m:mi>V</m:mi><m:mi>A</m:mi><m:mi>S</m:mi><m:mo>→</m:mo><m:mi>P</m:mi><m:mi>A</m:mi><m:mi>S</m:mi><m:mo>∪</m:mo><m:mi>ϕ</m:mi></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045971" id="P7000497027000000000000000045971">where</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000045972" id="P7000497027000000000000000045972"><m:math altimg="../images/ch09-eq5.png" altimg-height="50" altimg-width="728" alttext="" data-uri="" display="block"><m:mrow><m:mtext>MAP</m:mtext><m:mo stretchy="false">(</m:mo><m:mi>A</m:mi><m:mo stretchy="false">)</m:mo><m:mo>=</m:mo><m:mrow><m:mo>{</m:mo> <m:mrow><m:mtable columnalign="left"><m:mtr columnalign="left"><m:mtd columnalign="left"><m:mrow><m:mi>A</m:mi><m:mo>'</m:mo></m:mrow></m:mtd><m:mtd columnalign="left"><m:mrow><m:mtext>if data at virtual addr</m:mtext><m:mtext>. </m:mtext><m:mi>A</m:mi><m:mtext> are present at physical addr</m:mtext><m:mtext>. </m:mtext><m:mi>A</m:mi><m:mo>'</m:mo><m:mtext> in PAS</m:mtext></m:mrow></m:mtd></m:mtr><m:mtr columnalign="left"><m:mtd columnalign="left"><m:mi>ϕ</m:mi></m:mtd><m:mtd columnalign="left"><m:mrow><m:mtext>if data at virtual addr</m:mtext><m:mtext>. </m:mtext><m:mi>A</m:mi><m:mtext> are not present in physical memory</m:mtext></m:mrow></m:mtd></m:mtr></m:mtable></m:mrow> </m:mrow></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045973" id="P7000497027000000000000000045973"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007121"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.12</span></a> shows how the MMU uses the page table to perform this mapping. A control register in the CPU, the <i class="pcalibre17 pcalibre2 pcalibre1">page table base register (PTBR)</i> points to the current page table. The <var class="pcalibre17 pcalibre2 pcalibre1">n</var>-bit virtual address has two components: a <var class="pcalibre17 pcalibre2 pcalibre1">p</var>-bit <i class="pcalibre17 pcalibre2 pcalibre1">virtual page offset (VPO)</i> and an <i class="pcalibre17 pcalibre2 pcalibre1">(n -- p)</i>-bit <i class="pcalibre17 pcalibre2 pcalibre1">virtual page number (VPN).</i> The MMU uses the VPN to select the appropriate PTE. For example, VPN 0 selects PTE 0, VPN 1 selects PTE 1, and so on. The corresponding physical address is the concatenation of the <i class="pcalibre17 pcalibre2 pcalibre1">physical page number (PPN)</i> from the page table entry and the VPO from the virtual address. Notice that since the physical and virtual pages are both <var class="pcalibre17 pcalibre2 pcalibre1">P</var> bytes, the <i class="pcalibre17 pcalibre2 pcalibre1">physical page offset (PPO)</i> is identical to the VPO.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007121" id="P7000497027000000000000000007121">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007122" epub:type="pagebreak" id="P7000497027000000000000000007122" title="815"></span>
<img alt="A diagram illustrates address translation with a page table." class="pcalibre1 pcalibre2 calibre68" data-uri="P700049702700000000000000000B783" id="P7000497027000000000000000045974" src="Images/chapter-08-image-11.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045975" id="P7000497027000000000000000045975"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045976" epub:type="title" id="P7000497027000000000000000045976"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.12 </span>Address translation with a page table.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025CB2" id="P7000497027000000000000000025CB2">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045977" id="P7000497027000000000000000045977">A diagram shows a page table with four registers, each with columns for Valid and Physical page number (PPN). The first register is the page table base register (PTBR). The second register is highlighted, with details summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045978" id="P7000497027000000000000000045978">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045979" id="P7000497027000000000000000045979"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004597A" id="P700049702700000000000000004597A">Valid: if valid = 0, then page not in memory (page fault)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004597B" id="P700049702700000000000000004597B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004597C" id="P700049702700000000000000004597C">Virtual address:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P700049702700000000000000004597D" id="P700049702700000000000000004597D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004597E" id="P700049702700000000000000004597E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004597F" id="P700049702700000000000000004597F">From n minus 1 to p is virtual page number (VPN). The VPN acts as an index into the page table.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045980" id="P7000497027000000000000000045980"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045981" id="P7000497027000000000000000045981">From p minus 1 to 0 is virtual page offset (VPO).</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045982" id="P7000497027000000000000000045982"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045983" id="P7000497027000000000000000045983">Physical address:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045984" id="P7000497027000000000000000045984">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045985" id="P7000497027000000000000000045985"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045986" id="P7000497027000000000000000045986">From m minus 1 to p is physical page number (PPN), from page table</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045987" id="P7000497027000000000000000045987"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045988" id="P7000497027000000000000000045988">From p minus 1 to 0 is physical page offset (PPO), from VPO in virtual address</p></li>
</ul></li>
</ul></details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045989" id="P7000497027000000000000000045989"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000713C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.13(a)</span></a> shows the steps that the CPU hardware performs when there is a page hit.</p>
<ol class="pcalibre1 pcalibre2 pcalibre235" data-uri="chapter09.xhtml#P700049702700000000000000004598A" id="P700049702700000000000000004598A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004598B" id="P700049702700000000000000004598B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004598C" id="P700049702700000000000000004598C"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">1. </span>The processor generates a virtual address and sends it to the MMU.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004598D" id="P700049702700000000000000004598D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004598E" id="P700049702700000000000000004598E"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">2. </span>The MMU generates the PTE address and requests it from the cache/main memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004598F" id="P700049702700000000000000004598F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045990" id="P7000497027000000000000000045990"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">3. </span>The cache/main memory returns the PTE to the MMU.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045991" id="P7000497027000000000000000045991"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045992" id="P7000497027000000000000000045992"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">4. </span>The MMU constructs the physical address and sends it to the cache/main memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045993" id="P7000497027000000000000000045993"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045994" id="P7000497027000000000000000045994"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">5. </span>The cache/main memory returns the requested data word to the processor.</p></li>
</ol>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045995" id="P7000497027000000000000000045995">Unlike a page hit, which is handled entirely by hardware, handling a page fault requires cooperation between hardware and the operating system kernel (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000713C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.13(b)</span></a>).</p>
<ol class="pcalibre1 pcalibre2 pcalibre235" data-uri="chapter09.xhtml#P7000497027000000000000000045996" id="P7000497027000000000000000045996">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045997" id="P7000497027000000000000000045997"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045998" id="P7000497027000000000000000045998"><span class="pcalibre1 pcalibre21 pcalibre2">Steps </span><span class="pcalibre1 pcalibre21 pcalibre2">1 to 3. </span>The same as steps 1 to 3 in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000713C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.13(a)</span></a>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045999" id="P7000497027000000000000000045999"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004599A" id="P700049702700000000000000004599A"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">4. </span>The valid bit in the PTE is zero, so the MMU triggers an exception, which transfers control in the CPU to a page fault exception handler in the operating system kernel.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004599B" id="P700049702700000000000000004599B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004599C" id="P700049702700000000000000004599C"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">5. </span>The fault handler identifies a victim page in physical memory, and if that page has been modified, pages it out to disk.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004599D" id="P700049702700000000000000004599D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004599E" id="P700049702700000000000000004599E"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">6. </span>The fault handler pages in the new page and updates the PTE in memory.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000713C" id="P700049702700000000000000000713C">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000713D" epub:type="pagebreak" id="P700049702700000000000000000713D" title="816"></span>
<img alt="Diagrams illustrate page hit and page fault." class="pcalibre1 pcalibre2 pcalibre265" data-uri="P700049702700000000000000000B784" id="P700049702700000000000000004599F" src="Images/chapter-08-image-12.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000459A0" id="P70004970270000000000000000459A0"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000459A1" epub:type="title" id="P70004970270000000000000000459A1"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.13 </span>Operational view of page hits and page faults.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459A2" id="P70004970270000000000000000459A2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459A3" id="P70004970270000000000000000459A3">VA: virtual address. PTEA: page table entry address. PTE: page table entry. PA: physical address.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025CE0" id="P7000497027000000000000000025CE0">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter09.xhtml#P70004970270000000000000000459A4" id="P70004970270000000000000000459A4">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459A5" id="P70004970270000000000000000459A5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459A6" id="P70004970270000000000000000459A6">Page hit:</p>
<ol class="pcalibre75 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459A7" id="P70004970270000000000000000459A7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459A8" id="P70004970270000000000000000459A8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459A9" id="P70004970270000000000000000459A9">VA from processor to MMU within CPU chip</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459AA" id="P70004970270000000000000000459AA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459AB" id="P70004970270000000000000000459AB">PTEA from MMU to cache/memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459AC" id="P70004970270000000000000000459AC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459AD" id="P70004970270000000000000000459AD">PTE from cache/memory to MMU</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459AE" id="P70004970270000000000000000459AE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459AF" id="P70004970270000000000000000459AF">PA from MMU to cache/memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459B0" id="P70004970270000000000000000459B0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459B1" id="P70004970270000000000000000459B1">Data from cache/memory to processor</p></li>
</ol></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459B2" id="P70004970270000000000000000459B2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459B3" id="P70004970270000000000000000459B3">Page fault:</p>
<ol class="pcalibre75 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459B4" id="P70004970270000000000000000459B4">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459B5" id="P70004970270000000000000000459B5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459B6" id="P70004970270000000000000000459B6">VA from processor to MMU within CPU chip</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459B7" id="P70004970270000000000000000459B7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459B8" id="P70004970270000000000000000459B8">PTEA from MMU to cache/memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459B9" id="P70004970270000000000000000459B9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459BA" id="P70004970270000000000000000459BA">PTE from cache/memory to MMU</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459BB" id="P70004970270000000000000000459BB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459BC" id="P70004970270000000000000000459BC">Exception from MMU to page fault exception handler (to victim page below)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459BD" id="P70004970270000000000000000459BD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459BE" id="P70004970270000000000000000459BE">Victim page from cache/memory to disk</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459BF" id="P70004970270000000000000000459BF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459C0" id="P70004970270000000000000000459C0">New page from disk to cache/memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459C1" id="P70004970270000000000000000459C1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459C2" id="P70004970270000000000000000459C2">VA from processor to MMU</p></li>
</ol></li></ol>
</details>
</figcaption>
</figure></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459C3" id="P70004970270000000000000000459C3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459C4" id="P70004970270000000000000000459C4"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">7. </span>The fault handler returns to the original process, causing the faulting instruction to be restarted. The CPU resends the offending virtual address to the MMU. Because the virtual page is now cached in physical memory, there is a hit, and after the MMU performs the steps in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000713C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.13(a)</span></a>, the main memory returns the requested word to the processor.</p></li>
</ol>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007145" epub:type="practice" id="P7000497027000000000000000007145"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000459C5" epub:type="title" id="P70004970270000000000000000459C5"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.3 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000777C.xhtml#P7000497027000000000000000007785">881</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P70004970270000000000000000459C6" id="P70004970270000000000000000459C6">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P70004970270000000000000000459C7" id="P70004970270000000000000000459C7">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459C8" id="P70004970270000000000000000459C8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459C9" id="P70004970270000000000000000459C9">Given a 32-bit virtual address space and a 24-bit physical address, determine the number of bits in the VPN, VPO, PPN, and PPO for the following page sizes <i class="pcalibre17 pcalibre2 pcalibre1">P:</i></p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P70004970270000000000000000459CA" id="P70004970270000000000000000459CA">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000459CB" id="P70004970270000000000000000459CB" rowspan="2"><var class="pcalibre17 pcalibre2 pcalibre1">P</var></th>
<th class="pcalibre1 pcalibre2 calibre5" colspan="4" data-uri="chapter09.xhtml#P70004970270000000000000000459CC" id="P70004970270000000000000000459CC">Number of</th>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000459CD" id="P70004970270000000000000000459CD">VPN bits</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000459CE" id="P70004970270000000000000000459CE">VPO bits</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000459CF" id="P70004970270000000000000000459CF">PPN bits</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000459D0" id="P70004970270000000000000000459D0">PPO bits</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459D1" id="P70004970270000000000000000459D1">1 KB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459D2" id="P70004970270000000000000000459D2">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459D3" id="P70004970270000000000000000459D3">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459D4" id="P70004970270000000000000000459D4">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459D5" id="P70004970270000000000000000459D5">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459D6" id="P70004970270000000000000000459D6">2 KB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459D7" id="P70004970270000000000000000459D7">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459D8" id="P70004970270000000000000000459D8">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459D9" id="P70004970270000000000000000459D9">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459DA" id="P70004970270000000000000000459DA">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459DB" id="P70004970270000000000000000459DB">4 KB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459DC" id="P70004970270000000000000000459DC">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459DD" id="P70004970270000000000000000459DD">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459DE" id="P70004970270000000000000000459DE">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459DF" id="P70004970270000000000000000459DF">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459E0" id="P70004970270000000000000000459E0">8 KB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459E1" id="P70004970270000000000000000459E1">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459E2" id="P70004970270000000000000000459E2">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459E3" id="P70004970270000000000000000459E3">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459E4" id="P70004970270000000000000000459E4">_____</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007166" id="P7000497027000000000000000007166">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007167" epub:type="pagebreak" id="P7000497027000000000000000007167" title="817"></span>
<img alt="A diagram illustrates integrating VM with a physically addressed cache." class="pcalibre266 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B785" id="P70004970270000000000000000459E5" src="Images/chapter-08-image-13.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000459E6" id="P70004970270000000000000000459E6"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000459E7" epub:type="title" id="P70004970270000000000000000459E7"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.14 </span>Integrating VM with a physically addressed cache.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000459E8" id="P70004970270000000000000000459E8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459E9" id="P70004970270000000000000000459E9">VA: virtual address. PTEA: page table entry address. PTE: page table entry. PA: physical address.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025D27" id="P7000497027000000000000000025D27">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000459EA" id="P70004970270000000000000000459EA">A diagram shows paths, as summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P70004970270000000000000000459EB" id="P70004970270000000000000000459EB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459EC" id="P70004970270000000000000000459EC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459ED" id="P70004970270000000000000000459ED">VA from processor to MMU within CPU chip</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459EE" id="P70004970270000000000000000459EE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459EF" id="P70004970270000000000000000459EF">PTEA and PA from MMU to L1 cache</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459F0" id="P70004970270000000000000000459F0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459F1" id="P70004970270000000000000000459F1">From L1 cache, PTEA miss and PA miss to Memory, which sends back PTE and Data, respectively</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000459F2" id="P70004970270000000000000000459F2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000459F3" id="P70004970270000000000000000459F3">From L1 cache, PTE from PTEA hit to MMU and Data from PA hit to processor</p></li>
</ul>
</details>
</figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000716D" id="P700049702700000000000000000716D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000459F4" epub:type="title" id="P70004970270000000000000000459F4"><span class="pcalibre1 pcalibre21 pcalibre2">9.6.1 </span>Integrating Caches and VM</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000459F5" id="P70004970270000000000000000459F5">In any system that uses both virtual memory and SRAM caches, there is the issue of whether to use virtual or physical addresses to access the SRAM cache. Although a detailed discussion of the trade-offs is beyond our scope here, most systems opt for physical addressing. With physical addressing, it is straightforward for multiple processes to have blocks in the cache at the same time and to share blocks from the same virtual pages. Further, the cache does not have to deal with protection issues, because access rights are checked as part of the address translation process.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000459F6" id="P70004970270000000000000000459F6"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007166"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.14</span></a> shows how a physically addressed cache might be integrated with virtual memory. The main idea is that the address translation occurs before the cache lookup. Notice that page table entries can be cached, just like any other data words.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007171" id="P7000497027000000000000000007171"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000459F7" epub:type="title" id="P70004970270000000000000000459F7"><span class="pcalibre1 pcalibre21 pcalibre2">9.6.2 </span>Speeding Up Address Translation with a TLB</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000459F8" id="P70004970270000000000000000459F8">As we have seen, every time the CPU generates a virtual address, the MMU must refer to a PTE in order to translate the virtual address into a physical address. In the worst case, this requires an additional fetch from memory, at a cost of tens to hundreds of cycles. If the PTE happens to be cached in L1, then the cost goes down to a handful of cycles. However, many systems try to eliminate even this cost by including a small cache of PTEs in the MMU called a <i class="pcalibre17 pcalibre2 pcalibre1">translation lookaside buffer (TLB).</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000459F9" id="P70004970270000000000000000459F9">A TLB is a small, virtually addressed cache where each line holds a block consisting of a single PTE. A TLB usually has a high degree of associativity. As shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007175"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.15</span></a>, the index and tag fields that are used for set selection and line matching are extracted from the virtual page number in the virtual address. If the TLB has <var class="pcalibre17 pcalibre2 pcalibre1">T</var> = 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 pcalibre85">t</sup></i> sets, then the <i class="pcalibre17 pcalibre2 pcalibre1">TLB index (TLBI)</i> consists of the <var class="pcalibre17 pcalibre2 pcalibre1">t</var> least significant bits of the VPN, and the <i class="pcalibre17 pcalibre2 pcalibre1">TLB tag (TLBT)</i> consists of the remaining bits in the VPN.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007175" id="P7000497027000000000000000007175">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007176" epub:type="pagebreak" id="P7000497027000000000000000007176" title="818"></span>
<img alt="Virtual address components include: VPN, divided into TLB tag (TLBT) from n minus 1 to p+t and TLB index (TLBI) from p+t minus 1 to p; and VPO from p minus 1 to 0." class="pcalibre1 pcalibre2 calibre69" data-uri="P700049702700000000000000000B786" id="P70004970270000000000000000459FA" src="Images/chapter-08-image-14.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000459FB" id="P70004970270000000000000000459FB"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000459FC" epub:type="title" id="P70004970270000000000000000459FC"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.15 </span>Components of a virtual address that are used to access the TLB.</h1></header></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000717A" id="P700049702700000000000000000717A">
<img alt="Diagrams illustrate TLB hit and TLB miss." class="calibre70 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B787" id="P70004970270000000000000000459FD" src="Images/chapter-08-image-15.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000459FE" id="P70004970270000000000000000459FE"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000459FF" epub:type="title" id="P70004970270000000000000000459FF"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.16 </span>Operational view of a TLB hit and miss.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025D3E" id="P7000497027000000000000000025D3E">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter09.xhtml#P7000497027000000000000000045A00" id="P7000497027000000000000000045A00">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A01" id="P7000497027000000000000000045A01"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A02" id="P7000497027000000000000000045A02">TLB hit:</p>
<ol class="pcalibre75 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A03" id="P7000497027000000000000000045A03">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A04" id="P7000497027000000000000000045A04"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A05" id="P7000497027000000000000000045A05">VA from processor to translation within CPU chip</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A06" id="P7000497027000000000000000045A06"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A07" id="P7000497027000000000000000045A07">VPN from translation to TLB in CPU chip</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A08" id="P7000497027000000000000000045A08"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A09" id="P7000497027000000000000000045A09">PTE from TLB to translation</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A0A" id="P7000497027000000000000000045A0A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A0B" id="P7000497027000000000000000045A0B">PA from translation to cache/memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A0C" id="P7000497027000000000000000045A0C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A0D" id="P7000497027000000000000000045A0D">Data from cache/memory to processor</p></li>
</ol></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A0E" id="P7000497027000000000000000045A0E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A0F" id="P7000497027000000000000000045A0F">TLB miss</p>
<ol class="pcalibre75 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A10" id="P7000497027000000000000000045A10">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A11" id="P7000497027000000000000000045A11"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A12" id="P7000497027000000000000000045A12">VA from processor to translation within CPU chip</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A13" id="P7000497027000000000000000045A13"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A14" id="P7000497027000000000000000045A14">VPN from translation to TLB in CPU chip</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A15" id="P7000497027000000000000000045A15"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A16" id="P7000497027000000000000000045A16">PTEA from translation to cache/memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A17" id="P7000497027000000000000000045A17"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A18" id="P7000497027000000000000000045A18">PTE from cache/memory to between TLB and translation</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A19" id="P7000497027000000000000000045A19"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A1A" id="P7000497027000000000000000045A1A">PA from translation to cache/memory</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A1B" id="P7000497027000000000000000045A1B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A1C" id="P7000497027000000000000000045A1C">Data from cache/memory to processor</p></li>
</ol></li>
</ol>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A1D" id="P7000497027000000000000000045A1D"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000717A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.16(a)</span></a> shows the steps involved when there is a TLB hit (the usual case). The key point here is that all of the address translation steps are performed inside the on-chip MMU and thus are fast.</p>
<ol class="pcalibre1 pcalibre2 pcalibre235" data-uri="chapter09.xhtml#P7000497027000000000000000045A1E" id="P7000497027000000000000000045A1E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A1F" id="P7000497027000000000000000045A1F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A20" id="P7000497027000000000000000045A20"><span class="pcalibre1 pcalibre21 pcalibre2">Step 1. </span>The CPU generates a virtual address.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A21" id="P7000497027000000000000000045A21"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A22" id="P7000497027000000000000000045A22"><span class="pcalibre1 pcalibre21 pcalibre2">Steps 2 and 3. </span>The MMU fetches the appropriate PTE from the TLB.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A23" id="P7000497027000000000000000045A23"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A24" id="P7000497027000000000000000045A24"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007186" epub:type="pagebreak" id="P7000497027000000000000000007186" title="819"></span><span class="pcalibre1 pcalibre21 pcalibre2">Step 4. </span>The MMU translates the virtual address to a physical address and sends it to the cache/main memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A25" id="P7000497027000000000000000045A25"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A26" id="P7000497027000000000000000045A26"><span class="pcalibre1 pcalibre21 pcalibre2">Step 5. </span>The cache/main memory returns the requested data word to the CPU.</p></li>
</ol>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A27" id="P7000497027000000000000000045A27">When there is a TLB miss, then the MMU must fetch the PTE from the L1 cache, as shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000717A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.16(b)</span></a>. The newly fetched PTE is stored in the TLB, possibly overwriting an existing entry.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000718A" id="P700049702700000000000000000718A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A28" epub:type="title" id="P7000497027000000000000000045A28"><span class="pcalibre1 pcalibre21 pcalibre2">9.6.3 </span>Multi-Level Page Tables</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A29" id="P7000497027000000000000000045A29">Thus far, we have assumed that the system uses a single page table to do address translation. But if we had a 32-bit address space, 4 KB pages, and a 4-byte PTE, then we would need a 4 MB page table resident in memory at all times, even if the application referenced only a small chunk of the virtual address space. The problem is compounded for systems with 64-bit address spaces.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A2A" id="P7000497027000000000000000045A2A">The common approach for compacting the page table is to use a hierarchy of page tables instead. The idea is easiest to understand with a concrete example. Consider a 32-bit virtual address space partitioned into 4 KB pages, with page table entries that are 4 bytes each. Suppose also that at this point in time the virtual address space has the following form: The first 2 K pages of memory are allocated for code and data, the next 6 K pages are unallocated, the next 1,023 pages are also unallocated, and the next page is allocated for the user stack. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007192"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.17</span></a> shows how we might construct a two-level page table hierarchy for this virtual address space.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A2B" id="P7000497027000000000000000045A2B">Each PTE in the level 1 table is responsible for mapping a 4 MB chunk of the virtual address space, where each chunk consists of 1,024 contiguous pages. For example, PTE 0 maps the first chunk, PTE 1 the next chunk, and so on. Given that the address space is 4 GB, 1,024 PTEs are sufficient to cover the entire space.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A2C" id="P7000497027000000000000000045A2C">If every page in chunk <var class="pcalibre17 pcalibre2 pcalibre1">i</var> is unallocated, then level 1 PTE <var class="pcalibre17 pcalibre2 pcalibre1">i</var> is null. For example, in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007192"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.17</span></a>, chunks 2--7 are unallocated. However, if at least one page in chunk <var class="pcalibre17 pcalibre2 pcalibre1">i</var> is allocated, then level 1 PTE <var class="pcalibre17 pcalibre2 pcalibre1">i</var> points to the base of a level 2 page table. For example, in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007192"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.17</span></a>, all or portions of chunks 0,1, and 8 are allocated, so their level 1 PTEs point to level 2 page tables.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A2D" id="P7000497027000000000000000045A2D">Each PTE in a level 2 page table is responsible for mapping a 4-KB page of virtual memory, just as before when we looked at single-level page tables. Notice that with 4-byte PTEs, each level 1 and level 2 page table is 4 kilobytes, which conveniently is the same size as a page.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A2E" id="P7000497027000000000000000045A2E">This scheme reduces memory requirements in two ways. First, if a PTE in the level 1 table is null, then the corresponding level 2 page table does not even have to exist. This represents a significant potential savings, since most of the 4 GB virtual address space for a typical program is unallocated. Second, only the level 1 table needs to be in main memory at all times. The level 2 page tables can be created and paged in and out by the VM system as they are needed, which reduces pressure on main memory. Only the most heavily used level 2 page tables need to be cached in main memory.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007192" id="P7000497027000000000000000007192">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007193" epub:type="pagebreak" id="P7000497027000000000000000007193" title="820"></span>
<img alt="A diagram illustrates a two-level page table hierarchy." class="pcalibre267 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B788" id="P7000497027000000000000000045A2F" src="Images/chapter-08-image-16.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045A30" id="P7000497027000000000000000045A30"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045A31" epub:type="title" id="P7000497027000000000000000045A31"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.17 </span>A two-level page table hierarchy.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045A32" id="P7000497027000000000000000045A32"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A33" id="P7000497027000000000000000045A33">Notice that addresses increase from top to bottom.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025D73" id="P7000497027000000000000000025D73">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A34" id="P7000497027000000000000000045A34">A diagram illustrates connections from level 1 page table to level 2 page tables to virtual memory, as summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045A35" id="P7000497027000000000000000045A35">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A36" id="P7000497027000000000000000045A36"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A37" id="P7000497027000000000000000045A37">Level 1 page table, registers from top to bottom:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045A38" id="P7000497027000000000000000045A38">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A39" id="P7000497027000000000000000045A39"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A3A" id="P7000497027000000000000000045A3A">PTE 0, to PTE 0 in first table of level 2</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A3B" id="P7000497027000000000000000045A3B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A3C" id="P7000497027000000000000000045A3C">PTE 1, to PTE 0 in second table of level 2</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A3D" id="P7000497027000000000000000045A3D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A3E" id="P7000497027000000000000000045A3E">PTE 2 (null) through PTE 7 (null)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A3F" id="P7000497027000000000000000045A3F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A40" id="P7000497027000000000000000045A40">PTE 8 to 1,023 null PTEs in third table of level 2</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A41" id="P7000497027000000000000000045A41"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A42" id="P7000497027000000000000000045A42">(1 K minus 9) null PTEs</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A43" id="P7000497027000000000000000045A43"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A44" id="P7000497027000000000000000045A44">Level 2 page tables:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045A45" id="P7000497027000000000000000045A45">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A46" id="P7000497027000000000000000045A46"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A47" id="P7000497027000000000000000045A47">First:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A48" id="P7000497027000000000000000045A48">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A49" id="P7000497027000000000000000045A49"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A4A" id="P7000497027000000000000000045A4A">PTE 0, to VP 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A4B" id="P7000497027000000000000000045A4B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A4C" id="P7000497027000000000000000045A4C">…</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A4D" id="P7000497027000000000000000045A4D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A4E" id="P7000497027000000000000000045A4E">PTE 1,023, to VP 1,023</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A4F" id="P7000497027000000000000000045A4F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A50" id="P7000497027000000000000000045A50">Second:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A51" id="P7000497027000000000000000045A51">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A52" id="P7000497027000000000000000045A52"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A53" id="P7000497027000000000000000045A53">PTE 0, to VP 1,024</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A54" id="P7000497027000000000000000045A54"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A55" id="P7000497027000000000000000045A55">…</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A56" id="P7000497027000000000000000045A56"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A57" id="P7000497027000000000000000045A57">PTE 1,023 to VP 2,047</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A58" id="P7000497027000000000000000045A58"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A59" id="P7000497027000000000000000045A59">Third:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A5A" id="P7000497027000000000000000045A5A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A5B" id="P7000497027000000000000000045A5B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A5C" id="P7000497027000000000000000045A5C">1,023 null PTEs</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A5D" id="P7000497027000000000000000045A5D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A5E" id="P7000497027000000000000000045A5E">PTE 1,023, to VP 9,215</p></li>
</ul></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A5F" id="P7000497027000000000000000045A5F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A60" id="P7000497027000000000000000045A60">Virtual memory:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045A61" id="P7000497027000000000000000045A61">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A62" id="P7000497027000000000000000045A62"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A63" id="P7000497027000000000000000045A63">VP 0, from 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A64" id="P7000497027000000000000000045A64"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A65" id="P7000497027000000000000000045A65">…</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A66" id="P7000497027000000000000000045A66"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A67" id="P7000497027000000000000000045A67">VP 1,023</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A68" id="P7000497027000000000000000045A68"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A69" id="P7000497027000000000000000045A69">VP 1,024</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A6A" id="P7000497027000000000000000045A6A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A6B" id="P7000497027000000000000000045A6B">…</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A6C" id="P7000497027000000000000000045A6C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A6D" id="P7000497027000000000000000045A6D">VP 2,047 (2 K allocated VM pages, from VP 0 to VP 2,047, for code and data)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A6E" id="P7000497027000000000000000045A6E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A6F" id="P7000497027000000000000000045A6F">Gap (6 K allocated VM pages)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A70" id="P7000497027000000000000000045A70"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A71" id="P7000497027000000000000000045A71">1,023 unallocated pages</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A72" id="P7000497027000000000000000045A72"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A73" id="P7000497027000000000000000045A73">VP 9,215 (1 allocated VM page for the stack)</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007199" id="P7000497027000000000000000007199">
<img alt="A diagram illustrates address translation with a k-level page table." class="pcalibre1 pcalibre2 pcalibre268" data-uri="P700049702700000000000000000B789" id="P7000497027000000000000000045A74" src="Images/chapter-08-image-17.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045A75" id="P7000497027000000000000000045A75"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045A76" epub:type="title" id="P7000497027000000000000000045A76"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.18 </span>Address translation with a <var class="pcalibre17 pcalibre2 pcalibre1">k</var>-level page table.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025DB7" id="P7000497027000000000000000025DB7">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A77" id="P7000497027000000000000000045A77">A diagram shows connections between pages in virtual address and physical address, as summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045A78" id="P7000497027000000000000000045A78">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A79" id="P7000497027000000000000000045A79"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A7A" id="P7000497027000000000000000045A7A">VPN 1 (extending to n minus 1), to second register in level 1 page table, which then moves to first register in level 2 page table</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A7B" id="P7000497027000000000000000045A7B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A7C" id="P7000497027000000000000000045A7C">VPN 2 to second register in level 2 page table, which then moves to first register in level k page table</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A7D" id="P7000497027000000000000000045A7D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A7E" id="P7000497027000000000000000045A7E">VPN k to PPN in level k page table, which then translates to PPN (m minus 1 to p) in physical address</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A7F" id="P7000497027000000000000000045A7F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A80" id="P7000497027000000000000000045A80">VPO (p minus 1 to 0) to PPO in physical address (p minus 1 to 0)</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A81" id="P7000497027000000000000000045A81"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007199"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.18</span></a> summarizes address translation with a <var class="pcalibre17 pcalibre2 pcalibre1">k</var>-level page table hierarchy. The virtual address is partitioned into <var class="pcalibre17 pcalibre2 pcalibre1">k</var> VPNs and a VPO. Each VPN <var class="pcalibre17 pcalibre2 pcalibre1">i</var>, 1 ≤ <var class="pcalibre17 pcalibre2 pcalibre1">i</var> ≤ <var class="pcalibre17 pcalibre2 pcalibre1">k</var>, is an index into a page table at level <i class="pcalibre17 pcalibre2 pcalibre1">i.</i> Each PTE in a level <var class="pcalibre17 pcalibre2 pcalibre1">j</var> table, 1 ≤ <var class="pcalibre17 pcalibre2 pcalibre1">j</var> ≤ <var class="pcalibre17 pcalibre2 pcalibre1">k</var> − 1, points to the base of some page table at level <var class="pcalibre17 pcalibre2 pcalibre1">j</var> + 1. Each PTE in a level <var class="pcalibre17 pcalibre2 pcalibre1">k</var> table contains either the PPN of some physical page or the address of a disk block. To construct the physical address, the MMU must access <var class="pcalibre17 pcalibre2 pcalibre1">k</var> PTEs before it can <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000719E" epub:type="pagebreak" id="P700049702700000000000000000719E" title="821"></span>determine the PPN. As with a single-level hierarchy, the PPO is identical to the VPO.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A82" id="P7000497027000000000000000045A82">Accessing <var class="pcalibre17 pcalibre2 pcalibre1">k</var> PTEs may seem expensive and impractical at first glance. However, the TLB comes to the rescue here by caching PTEs from the page tables at the different levels. In practice, address translation with multi-level page tables is not significantly slower than with single-level page tables.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000071A0" id="P70004970270000000000000000071A0"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A83" epub:type="title" id="P7000497027000000000000000045A83"><span class="pcalibre1 pcalibre21 pcalibre2">9.6.4 </span>Putting It Together: End-to-End Address Translation</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A84" id="P7000497027000000000000000045A84">In this section, we put it all together with a concrete example of end-to-end address translation on a small system with a TLB and L1 d-cache. To keep things manageable, we make the following assumptions:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A85" id="P7000497027000000000000000045A85">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A86" id="P7000497027000000000000000045A86"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A87" id="P7000497027000000000000000045A87">The memory is byte addressable.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A88" id="P7000497027000000000000000045A88"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A89" id="P7000497027000000000000000045A89">Memory accesses are to <i class="pcalibre17 pcalibre2 pcalibre1">1-byte words</i> (not 4-byte words).</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A8A" id="P7000497027000000000000000045A8A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A8B" id="P7000497027000000000000000045A8B">Virtual addresses are 14 bits wide (<var class="pcalibre17 pcalibre2 pcalibre1">n</var> = 14).</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A8C" id="P7000497027000000000000000045A8C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A8D" id="P7000497027000000000000000045A8D">Physical addresses are 12 bits wide (<var class="pcalibre17 pcalibre2 pcalibre1">m</var> = 12).</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A8E" id="P7000497027000000000000000045A8E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A8F" id="P7000497027000000000000000045A8F">The page size is 64 bytes (<var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 64).</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A90" id="P7000497027000000000000000045A90"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A91" id="P7000497027000000000000000045A91">The TLB is 4-way set associative with 16 total entries.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045A92" id="P7000497027000000000000000045A92"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A93" id="P7000497027000000000000000045A93">The L1 d-cache is physically addressed and direct mapped, with a 4-byte line size and 16 total sets.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A94" id="P7000497027000000000000000045A94"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000071B4"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.19</span></a> shows the formats of the virtual and physical addresses. Since each page is 2<sup class="pcalibre1 pcalibre2 pcalibre85">6</sup> = 64 bytes, the low-order 6 bits of the virtual and physical addresses serve as the VPO and PPO, respectively. The high-order 8 bits of the virtual address serve as the VPN. The high-order 6 bits of the physical address serve as the PPN.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045A95" id="P7000497027000000000000000045A95"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000071BA"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.20</span></a> shows a snapshot of our little memory system, including the TLB (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000071BA"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.20</span>(a)</a>), a portion of the page table (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000071BA"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.20(b)</span></a>), and the L1 cache (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000071BA"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.20(c)</span></a>). Above the figures of the TLB and cache, we have also shown how the bits of the virtual and physical addresses are partitioned by the hardware as it accesses these devices.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000071B4" id="P70004970270000000000000000071B4">
<img alt="A diagram illustrates bits in virtual address and physical address." class="pcalibre1 pcalibre2 pcalibre269" data-uri="P700049702700000000000000000B78A" id="P7000497027000000000000000045A96" src="Images/chapter-08-image-18.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045A97" id="P7000497027000000000000000045A97"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045A98" epub:type="title" id="P7000497027000000000000000045A98"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.19 </span>Addressing for small memory system.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045A99" id="P7000497027000000000000000045A99"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A9A" id="P7000497027000000000000000045A9A">Assume 14-bit virtual addresses (<var class="pcalibre17 pcalibre2 pcalibre1">n</var> = 14), 12-bit physical addresses (<var class="pcalibre17 pcalibre2 pcalibre1">m</var> = 12), and 64-byte pages (<var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 64).</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025DDC" id="P7000497027000000000000000025DDC">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045A9B" id="P7000497027000000000000000045A9B">A diagram shows bits in the virtual address divided into VPN (virtual page number) for bits 13 to 6 and VPO (virtual page offset) from 5 to 0. Physical address is divided into PPN (physical page number) from bit 11 to 6, and PPO (physical page offset) from 5 to 0.</p>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000071BA" id="P70004970270000000000000000071BA">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000071BB" epub:type="pagebreak" id="P70004970270000000000000000071BB" title="822"></span>
<img alt="Diagrams illustrate TLB, page table, and cache." class="pcalibre1 pcalibre2 pcalibre270" data-uri="P700049702700000000000000000B78B" id="P7000497027000000000000000045A9C" src="Images/chapter-08-image-19.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045A9D" id="P7000497027000000000000000045A9D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045A9E" epub:type="title" id="P7000497027000000000000000045A9E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.20 </span>TLB, page table, and cache for small memory system.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045A9F" id="P7000497027000000000000000045A9F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045AA0" id="P7000497027000000000000000045AA0">All values in the TLB, page table, and cache are in hexadecimal notation.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025DE3" id="P7000497027000000000000000025DE3">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<ol class="pcalibre75 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045AA1" id="P7000497027000000000000000045AA1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045AA2" id="P7000497027000000000000000045AA2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045AA3" id="P7000497027000000000000000045AA3">TLB: 4 sets, 16 entries, 4-way set associative: virtual address has bits 13 to 6 as VPN, with TLBT from 13 to 8 and TLBI from 7 to 6. VPO is bits 5 to 0. Sets 0 through 3 each have entries within four sets of tag, PPN, and valid, as reproduced in the following table:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045AA4" id="P7000497027000000000000000045AA4">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AA5" id="P7000497027000000000000000045AA5">Set</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AA6" id="P7000497027000000000000000045AA6">Tag</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AA7" id="P7000497027000000000000000045AA7">PPN</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AA8" id="P7000497027000000000000000045AA8">Valid</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AA9" id="P7000497027000000000000000045AA9">Tag</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AAA" id="P7000497027000000000000000045AAA">PPN</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AAB" id="P7000497027000000000000000045AAB">Valid</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AAC" id="P7000497027000000000000000045AAC">Tag</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AAD" id="P7000497027000000000000000045AAD">PPN</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AAE" id="P7000497027000000000000000045AAE">Valid</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AAF" id="P7000497027000000000000000045AAF">Tag</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AB0" id="P7000497027000000000000000045AB0">PPN</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AB1" id="P7000497027000000000000000045AB1">Valid</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AB2" id="P7000497027000000000000000045AB2">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AB3" id="P7000497027000000000000000045AB3">03</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AB4" id="P7000497027000000000000000045AB4">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AB5" id="P7000497027000000000000000045AB5">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AB6" id="P7000497027000000000000000045AB6">09</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AB7" id="P7000497027000000000000000045AB7">0D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AB8" id="P7000497027000000000000000045AB8">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AB9" id="P7000497027000000000000000045AB9">00</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ABA" id="P7000497027000000000000000045ABA">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ABB" id="P7000497027000000000000000045ABB">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ABC" id="P7000497027000000000000000045ABC">07</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ABD" id="P7000497027000000000000000045ABD">02</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ABE" id="P7000497027000000000000000045ABE">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ABF" id="P7000497027000000000000000045ABF">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC0" id="P7000497027000000000000000045AC0">03</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC1" id="P7000497027000000000000000045AC1">2D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC2" id="P7000497027000000000000000045AC2">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC3" id="P7000497027000000000000000045AC3">02</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC4" id="P7000497027000000000000000045AC4">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC5" id="P7000497027000000000000000045AC5">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC6" id="P7000497027000000000000000045AC6">04</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC7" id="P7000497027000000000000000045AC7">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC8" id="P7000497027000000000000000045AC8">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AC9" id="P7000497027000000000000000045AC9">0A</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ACA" id="P7000497027000000000000000045ACA">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ACB" id="P7000497027000000000000000045ACB">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ACC" id="P7000497027000000000000000045ACC">2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ACD" id="P7000497027000000000000000045ACD">02</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ACE" id="P7000497027000000000000000045ACE">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ACF" id="P7000497027000000000000000045ACF">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD0" id="P7000497027000000000000000045AD0">08</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD1" id="P7000497027000000000000000045AD1">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD2" id="P7000497027000000000000000045AD2">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD3" id="P7000497027000000000000000045AD3">06</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD4" id="P7000497027000000000000000045AD4">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD5" id="P7000497027000000000000000045AD5">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD6" id="P7000497027000000000000000045AD6">03</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD7" id="P7000497027000000000000000045AD7">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD8" id="P7000497027000000000000000045AD8">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AD9" id="P7000497027000000000000000045AD9">3</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ADA" id="P7000497027000000000000000045ADA">07</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ADB" id="P7000497027000000000000000045ADB">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ADC" id="P7000497027000000000000000045ADC">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ADD" id="P7000497027000000000000000045ADD">03</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ADE" id="P7000497027000000000000000045ADE">0D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045ADF" id="P7000497027000000000000000045ADF">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AE0" id="P7000497027000000000000000045AE0">0A</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AE1" id="P7000497027000000000000000045AE1">34</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AE2" id="P7000497027000000000000000045AE2">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AE3" id="P7000497027000000000000000045AE3">02</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AE4" id="P7000497027000000000000000045AE4">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AE5" id="P7000497027000000000000000045AE5">0</td>
</tr>
</tbody>
</table></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045AE6" id="P7000497027000000000000000045AE6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045AE7" id="P7000497027000000000000000045AE7">Page table: only the first 16 PTEs are shown: PPN and Valid are listed for VPN 00 through 0F, as reproduced in the following table:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045AE8" id="P7000497027000000000000000045AE8">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AE9" id="P7000497027000000000000000045AE9">VPN</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AEA" id="P7000497027000000000000000045AEA">PPN</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045AEB" id="P7000497027000000000000000045AEB">Valid</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AEC" id="P7000497027000000000000000045AEC">00</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AED" id="P7000497027000000000000000045AED">28</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AEE" id="P7000497027000000000000000045AEE">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AEF" id="P7000497027000000000000000045AEF">01</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF0" id="P7000497027000000000000000045AF0">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF1" id="P7000497027000000000000000045AF1">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF2" id="P7000497027000000000000000045AF2">02</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF3" id="P7000497027000000000000000045AF3">33</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF4" id="P7000497027000000000000000045AF4">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF5" id="P7000497027000000000000000045AF5">03</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF6" id="P7000497027000000000000000045AF6">02</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF7" id="P7000497027000000000000000045AF7">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF8" id="P7000497027000000000000000045AF8">04</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AF9" id="P7000497027000000000000000045AF9">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AFA" id="P7000497027000000000000000045AFA">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AFB" id="P7000497027000000000000000045AFB">05</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AFC" id="P7000497027000000000000000045AFC">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AFD" id="P7000497027000000000000000045AFD">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AFE" id="P7000497027000000000000000045AFE">06</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045AFF" id="P7000497027000000000000000045AFF">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B00" id="P7000497027000000000000000045B00">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B01" id="P7000497027000000000000000045B01">07</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B02" id="P7000497027000000000000000045B02">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B03" id="P7000497027000000000000000045B03">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B04" id="P7000497027000000000000000045B04">08</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B05" id="P7000497027000000000000000045B05">13</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B06" id="P7000497027000000000000000045B06">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B07" id="P7000497027000000000000000045B07">09</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B08" id="P7000497027000000000000000045B08">17</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B09" id="P7000497027000000000000000045B09">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B0A" id="P7000497027000000000000000045B0A">0A</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B0B" id="P7000497027000000000000000045B0B">09</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B0C" id="P7000497027000000000000000045B0C">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B0D" id="P7000497027000000000000000045B0D">0B</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B0E" id="P7000497027000000000000000045B0E">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B0F" id="P7000497027000000000000000045B0F">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B10" id="P7000497027000000000000000045B10">0C</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B11" id="P7000497027000000000000000045B11">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B12" id="P7000497027000000000000000045B12">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B13" id="P7000497027000000000000000045B13">0D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B14" id="P7000497027000000000000000045B14">2D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B15" id="P7000497027000000000000000045B15">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B16" id="P7000497027000000000000000045B16">0E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B17" id="P7000497027000000000000000045B17">11</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B18" id="P7000497027000000000000000045B18">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B19" id="P7000497027000000000000000045B19">0F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B1A" id="P7000497027000000000000000045B1A">0D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B1B" id="P7000497027000000000000000045B1B">1</td>
</tr>
</tbody>
</table>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045B1C" id="P7000497027000000000000000045B1C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045B1D" id="P7000497027000000000000000045B1D">Cache: 16 sets, 4-byte blocks, direct mapped: physical address has bits 11 to 6 as PPN (and CT) and PPO from 5 to 0, with CI from 5 to 2 and CO from 1 to 0. Idx 0 through F has Tag, Valid, Blk 0, Blk 1, Blk 2, and Blk3 listed, as reproduced in the following table:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045B1E" id="P7000497027000000000000000045B1E">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045B1F" id="P7000497027000000000000000045B1F">Idk</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045B20" id="P7000497027000000000000000045B20">Tag</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045B21" id="P7000497027000000000000000045B21">Valid</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045B22" id="P7000497027000000000000000045B22">Blk 0</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045B23" id="P7000497027000000000000000045B23">Blk 1</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045B24" id="P7000497027000000000000000045B24">Blk 2</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045B25" id="P7000497027000000000000000045B25">Blk 3</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B26" id="P7000497027000000000000000045B26">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B27" id="P7000497027000000000000000045B27">19</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B28" id="P7000497027000000000000000045B28">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B29" id="P7000497027000000000000000045B29">99</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B2A" id="P7000497027000000000000000045B2A">11</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B2B" id="P7000497027000000000000000045B2B">23</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B2C" id="P7000497027000000000000000045B2C">11</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B2D" id="P7000497027000000000000000045B2D">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B2E" id="P7000497027000000000000000045B2E">15</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B2F" id="P7000497027000000000000000045B2F">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B30" id="P7000497027000000000000000045B30">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B31" id="P7000497027000000000000000045B31">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B32" id="P7000497027000000000000000045B32">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B33" id="P7000497027000000000000000045B33">-</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B34" id="P7000497027000000000000000045B34">2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B35" id="P7000497027000000000000000045B35">1B</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B36" id="P7000497027000000000000000045B36">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B37" id="P7000497027000000000000000045B37">00</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B38" id="P7000497027000000000000000045B38">02</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B39" id="P7000497027000000000000000045B39">04</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B3A" id="P7000497027000000000000000045B3A">08</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B3B" id="P7000497027000000000000000045B3B">3</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B3C" id="P7000497027000000000000000045B3C">36</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B3D" id="P7000497027000000000000000045B3D">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B3E" id="P7000497027000000000000000045B3E">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B3F" id="P7000497027000000000000000045B3F">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B40" id="P7000497027000000000000000045B40">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B41" id="P7000497027000000000000000045B41">-</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B42" id="P7000497027000000000000000045B42">4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B43" id="P7000497027000000000000000045B43">32</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B44" id="P7000497027000000000000000045B44">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B45" id="P7000497027000000000000000045B45">43</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B46" id="P7000497027000000000000000045B46">6D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B47" id="P7000497027000000000000000045B47">8F</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B48" id="P7000497027000000000000000045B48">09</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B49" id="P7000497027000000000000000045B49">5</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B4A" id="P7000497027000000000000000045B4A">0D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B4B" id="P7000497027000000000000000045B4B">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B4C" id="P7000497027000000000000000045B4C">36</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B4D" id="P7000497027000000000000000045B4D">72</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B4E" id="P7000497027000000000000000045B4E">F0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B4F" id="P7000497027000000000000000045B4F">1D</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B50" id="P7000497027000000000000000045B50">6</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B51" id="P7000497027000000000000000045B51">31</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B52" id="P7000497027000000000000000045B52">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B53" id="P7000497027000000000000000045B53">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B54" id="P7000497027000000000000000045B54">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B55" id="P7000497027000000000000000045B55">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B56" id="P7000497027000000000000000045B56">-</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B57" id="P7000497027000000000000000045B57">7</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B58" id="P7000497027000000000000000045B58">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B59" id="P7000497027000000000000000045B59">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B5A" id="P7000497027000000000000000045B5A">11</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B5B" id="P7000497027000000000000000045B5B">C2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B5C" id="P7000497027000000000000000045B5C">DF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B5D" id="P7000497027000000000000000045B5D">03</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B5E" id="P7000497027000000000000000045B5E">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B5F" id="P7000497027000000000000000045B5F">24</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B60" id="P7000497027000000000000000045B60">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B61" id="P7000497027000000000000000045B61">3A</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B62" id="P7000497027000000000000000045B62">00</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B63" id="P7000497027000000000000000045B63">51</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B64" id="P7000497027000000000000000045B64">89</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B65" id="P7000497027000000000000000045B65">9</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B66" id="P7000497027000000000000000045B66">2D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B67" id="P7000497027000000000000000045B67">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B68" id="P7000497027000000000000000045B68">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B69" id="P7000497027000000000000000045B69">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B6A" id="P7000497027000000000000000045B6A">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B6B" id="P7000497027000000000000000045B6B">-</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B6C" id="P7000497027000000000000000045B6C">A</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B6D" id="P7000497027000000000000000045B6D">2D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B6E" id="P7000497027000000000000000045B6E">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B6F" id="P7000497027000000000000000045B6F">93</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B70" id="P7000497027000000000000000045B70">15</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B71" id="P7000497027000000000000000045B71">DA</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B72" id="P7000497027000000000000000045B72">3B</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B73" id="P7000497027000000000000000045B73">B</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B74" id="P7000497027000000000000000045B74">0B</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B75" id="P7000497027000000000000000045B75">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B76" id="P7000497027000000000000000045B76">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B77" id="P7000497027000000000000000045B77">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B78" id="P7000497027000000000000000045B78">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B79" id="P7000497027000000000000000045B79">-</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B7A" id="P7000497027000000000000000045B7A">C</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B7B" id="P7000497027000000000000000045B7B">12</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B7C" id="P7000497027000000000000000045B7C">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B7D" id="P7000497027000000000000000045B7D">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B7E" id="P7000497027000000000000000045B7E">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B7F" id="P7000497027000000000000000045B7F">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B80" id="P7000497027000000000000000045B80">-</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B81" id="P7000497027000000000000000045B81">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B82" id="P7000497027000000000000000045B82">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B83" id="P7000497027000000000000000045B83">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B84" id="P7000497027000000000000000045B84">04</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B85" id="P7000497027000000000000000045B85">96</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B86" id="P7000497027000000000000000045B86">34</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B87" id="P7000497027000000000000000045B87">15</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B88" id="P7000497027000000000000000045B88">E</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B89" id="P7000497027000000000000000045B89">13</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B8A" id="P7000497027000000000000000045B8A">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B8B" id="P7000497027000000000000000045B8B">83</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B8C" id="P7000497027000000000000000045B8C">77</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B8D" id="P7000497027000000000000000045B8D">1B</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B8E" id="P7000497027000000000000000045B8E">D3</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B8F" id="P7000497027000000000000000045B8F">f</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B90" id="P7000497027000000000000000045B90">14</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B91" id="P7000497027000000000000000045B91">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B92" id="P7000497027000000000000000045B92">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B93" id="P7000497027000000000000000045B93">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B94" id="P7000497027000000000000000045B94">-</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045B95" id="P7000497027000000000000000045B95">-</td>
</tr>
</tbody>
</table>
</li>
</ol>
</details>
</figcaption>
</figure>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045B96" id="P7000497027000000000000000045B96">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045B97" id="P7000497027000000000000000045B97"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045B98" id="P7000497027000000000000000045B98"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000071C4" epub:type="pagebreak" id="P70004970270000000000000000071C4" title="823"></span><span class="pcalibre1 pcalibre2 pcalibre41">TLB. </span>The TLB is virtually addressed using the bits of the VPN. Since the TLB has four sets, the 2 low-order bits of the VPN serve as the set index (TLBI). The remaining 6 high-order bits serve as the tag (TLBT) that distinguishes the different VPNs that might map to the same TLB set.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045B99" id="P7000497027000000000000000045B99"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045B9A" id="P7000497027000000000000000045B9A"><span class="pcalibre1 pcalibre2 pcalibre41">Page table. </span>The page table is a single-level design with a total of 2<sup class="pcalibre1 pcalibre2 pcalibre85">8</sup> = 256 page table entries (PTEs). However, we are only interested in the first 16 of these. For convenience, we have labeled each PTE with the VPN that indexes it; but keep in mind that these VPNs are not part of the page table and not stored in memory. Also, notice that the PPN of each invalid PTE is denoted with a dash to reinforce the idea that whatever bit values might happen to be stored there are not meaningful.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045B9B" id="P7000497027000000000000000045B9B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045B9C" id="P7000497027000000000000000045B9C"><span class="pcalibre1 pcalibre2 pcalibre41">Cache. </span>The direct-mapped cache is addressed by the fields in the physical address. Since each block is 4 bytes, the low-order 2 bits of the physical address serve as the block offset (CO). Since there are 16 sets, the next 4 bits serve as the set index (CI). The remaining 6 bits serve as the tag (CT).</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045B9D" id="P7000497027000000000000000045B9D">Given this initial setup, let's see what happens when the CPU executes a load instruction that reads the byte at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045B9E" id="P7000497027000000000000000045B9E">0x03d4</code>. (Recall that our hypothetical CPU reads 1-byte words rather than 4-byte words.) To begin this kind of manual simulation, we find it helpful to write down the bits in the virtual address, identify the various fields we will need, and determine their hex values. The hardware performs a similar task when it decodes the address.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000071CB" id="P70004970270000000000000000071CB">
<img alt="A diagram has virtual address values listed in bit positions 13 through 0." class="pcalibre1 pcalibre2 pcalibre271" data-uri="P700049702700000000000000000B78C" id="P7000497027000000000000000045B9F" src="Images/chapter-08-image-20.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045BA0" id="P7000497027000000000000000045BA0">
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025EE4" id="P7000497027000000000000000025EE4">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BA1" id="P7000497027000000000000000045BA1">A diagram has bit positions 13 through 6 labeled VPN 0x0f, with 13 through 8 as TLBT 0x03 and 7 and 6 as 0x03. Positions 5 through 0 are labeled VPO 0x14. The values listed in the positions are reproduced in the following table:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045BA2" id="P7000497027000000000000000045BA2">
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BA3" id="P7000497027000000000000000045BA3">Bit position</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BA4" id="P7000497027000000000000000045BA4">13</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BA5" id="P7000497027000000000000000045BA5">12</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BA6" id="P7000497027000000000000000045BA6">11</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BA7" id="P7000497027000000000000000045BA7">10</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BA8" id="P7000497027000000000000000045BA8">9</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BA9" id="P7000497027000000000000000045BA9">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BAA" id="P7000497027000000000000000045BAA">7</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BAB" id="P7000497027000000000000000045BAB">6</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BAC" id="P7000497027000000000000000045BAC">5</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BAD" id="P7000497027000000000000000045BAD">4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BAE" id="P7000497027000000000000000045BAE">3</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BAF" id="P7000497027000000000000000045BAF">2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB0" id="P7000497027000000000000000045BB0">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB1" id="P7000497027000000000000000045BB1">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB2" id="P7000497027000000000000000045BB2">VA = 0x03d4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB3" id="P7000497027000000000000000045BB3">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB4" id="P7000497027000000000000000045BB4">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB5" id="P7000497027000000000000000045BB5">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB6" id="P7000497027000000000000000045BB6">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB7" id="P7000497027000000000000000045BB7">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB8" id="P7000497027000000000000000045BB8">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BB9" id="P7000497027000000000000000045BB9">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BBA" id="P7000497027000000000000000045BBA">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BBB" id="P7000497027000000000000000045BBB">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BBC" id="P7000497027000000000000000045BBC">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BBD" id="P7000497027000000000000000045BBD">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BBE" id="P7000497027000000000000000045BBE">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BBF" id="P7000497027000000000000000045BBF">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BC0" id="P7000497027000000000000000045BC0">0</td>
</tr>
</tbody>
</table>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BC1" id="P7000497027000000000000000045BC1">To begin, the MMU extracts the VPN (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BC2" id="P7000497027000000000000000045BC2">0x0F</code>) from the virtual address and checks with the TLB to see if it has cached a copy of PTE <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BC3" id="P7000497027000000000000000045BC3">0x0F</code> from some previous memory reference. The TLB extracts the TLB index (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BC4" id="P7000497027000000000000000045BC4">0x03</code>) and the TLB tag (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BC5" id="P7000497027000000000000000045BC5">0x3</code>) from the VPN, hits on a valid match in the second entry of set <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BC6" id="P7000497027000000000000000045BC6">0x3</code>, and returns the cached PPN (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BC7" id="P7000497027000000000000000045BC7">0x0D</code>) to the MMU.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BC8" id="P7000497027000000000000000045BC8">If the TLB had missed, then the MMU would need to fetch the PTE from main memory. However, in this case, we got lucky and had a TLB hit. The MMU now has everything it needs to form the physical address. It does this by concatenating the PPN (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BC9" id="P7000497027000000000000000045BC9">0x0D</code>) from the PTE with the VPO (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BCA" id="P7000497027000000000000000045BCA">0x14</code>) from the virtual address, which forms the physical address (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BCB" id="P7000497027000000000000000045BCB">0x354</code>).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BCC" id="P7000497027000000000000000045BCC">Next, the MMU sends the physical address to the cache, which extracts the cache offset CO (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BCD" id="P7000497027000000000000000045BCD">0x0</code>), the cache set index CI (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BCE" id="P7000497027000000000000000045BCE">0x5</code>), and the cache tag CT (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BCF" id="P7000497027000000000000000045BCF">0x0D</code>) from the physical address.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000071DC" id="P70004970270000000000000000071DC">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000071DD" epub:type="pagebreak" id="P70004970270000000000000000071DD" title="824"></span>
<img alt="A diagram has physical address values listed in bit positions 11 through 0." class="pcalibre1 pcalibre2 pcalibre272" data-uri="P700049702700000000000000000B78D" id="P7000497027000000000000000045BD0" src="Images/chapter-08-image-21.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045BD1" id="P7000497027000000000000000045BD1">
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025F16" id="P7000497027000000000000000025F16">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BD2" id="P7000497027000000000000000045BD2">A diagram has bit positions 11 through 6 labeled PPN 0x0d and CT 0x0d. Positions 5 through 0 are labeled PPO 0x14 , with 5 through 2 as CI 0x05 and 1 and 0 as CO 0x0. The values listed in the positions are reproduced in the following table:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045BD3" id="P7000497027000000000000000045BD3">
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BD4" id="P7000497027000000000000000045BD4">Bit position</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BD5" id="P7000497027000000000000000045BD5">11</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BD6" id="P7000497027000000000000000045BD6">10</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BD7" id="P7000497027000000000000000045BD7">9</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BD8" id="P7000497027000000000000000045BD8">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BD9" id="P7000497027000000000000000045BD9">7</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BDA" id="P7000497027000000000000000045BDA">6</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BDB" id="P7000497027000000000000000045BDB">5</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BDC" id="P7000497027000000000000000045BDC">4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BDD" id="P7000497027000000000000000045BDD">3</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BDE" id="P7000497027000000000000000045BDE">2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BDF" id="P7000497027000000000000000045BDF">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE0" id="P7000497027000000000000000045BE0">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE1" id="P7000497027000000000000000045BE1">PA = 0x354</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE2" id="P7000497027000000000000000045BE2">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE3" id="P7000497027000000000000000045BE3">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE4" id="P7000497027000000000000000045BE4">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE5" id="P7000497027000000000000000045BE5">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE6" id="P7000497027000000000000000045BE6">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE7" id="P7000497027000000000000000045BE7">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE8" id="P7000497027000000000000000045BE8">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BE9" id="P7000497027000000000000000045BE9">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BEA" id="P7000497027000000000000000045BEA">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BEB" id="P7000497027000000000000000045BEB">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BEC" id="P7000497027000000000000000045BEC">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BED" id="P7000497027000000000000000045BED">0</td>
</tr>
</tbody>
</table>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BEE" id="P7000497027000000000000000045BEE">Since the tag in set <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BEF" id="P7000497027000000000000000045BEF">0x5</code> matches CT, the cache detects a hit, reads out the data byte (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BF0" id="P7000497027000000000000000045BF0">0x36</code>) at offset CO, and returns it to the MMU, which then passes it back to the CPU.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BF1" id="P7000497027000000000000000045BF1">Other paths through the translation process are also possible. For example, if the TLB misses, then the MMU must fetch the PPN from a PTE in the page table. If the resulting PTE is invalid, then there is a page fault and the kernel must page in the appropriate page and rerun the load instruction. Another possibility is that the PTE is valid, but the necessary memory block misses in the cache.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000071E3" epub:type="practice" id="P70004970270000000000000000071E3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BF2" epub:type="title" id="P7000497027000000000000000045BF2"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.4 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000777C.xhtml#P7000497027000000000000000007785">881</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000045BF3" id="P7000497027000000000000000045BF3">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000045BF4" id="P7000497027000000000000000045BF4">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045BF5" id="P7000497027000000000000000045BF5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045BF6" id="P7000497027000000000000000045BF6">Show how the example memory system in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000071A0"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.6.4</span></a> translates a virtual address into a physical address and accesses the cache. For the given virtual address, indicate the TLB entry accessed, physical address, and cache byte value returned. Indicate whether the TLB misses, whether a page fault occurs, and whether a cache miss occurs. If there is a cache miss, enter "—" for "Cache byte returned." If there is a page fault, enter "—" for "PPN" and leave parts C and D blank.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045BF7" id="P7000497027000000000000000045BF7">Virtual address: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045BF8" id="P7000497027000000000000000045BF8">0x03d7</code></p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter09.xhtml#P7000497027000000000000000045BF9" id="P7000497027000000000000000045BF9">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045BFA" id="P7000497027000000000000000045BFA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045BFB" id="P7000497027000000000000000045BFB">Virtual address format</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000071EE" id="P70004970270000000000000000071EE">
<img alt="Boxes are numbered 13 through 0." class="calibre71 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B78E" id="P7000497027000000000000000045BFC" src="Images/chapter-08-image-22.png"/>
</figure></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045BFD" id="P7000497027000000000000000045BFD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045BFE" id="P7000497027000000000000000045BFE">Address translation</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045BFF" id="P7000497027000000000000000045BFF">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045C00" id="P7000497027000000000000000045C00">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045C01" id="P7000497027000000000000000045C01">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C02" id="P7000497027000000000000000045C02">VPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C03" id="P7000497027000000000000000045C03">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C04" id="P7000497027000000000000000045C04">TLB index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C05" id="P7000497027000000000000000045C05">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C06" id="P7000497027000000000000000045C06">TLB tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C07" id="P7000497027000000000000000045C07">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C08" id="P7000497027000000000000000045C08">TLB hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C09" id="P7000497027000000000000000045C09">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C0A" id="P7000497027000000000000000045C0A">Page fault? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C0B" id="P7000497027000000000000000045C0B">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C0C" id="P7000497027000000000000000045C0C">PPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C0D" id="P7000497027000000000000000045C0D">_____</td>
</tr>
</tbody>
</table><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C0E" id="P7000497027000000000000000045C0E"> </p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C0F" id="P7000497027000000000000000045C0F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C10" id="P7000497027000000000000000045C10">Physical address format</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007204" id="P7000497027000000000000000007204">
<img alt="Boxes are numbered 11 through 0." class="pcalibre1 pcalibre2 calibre72" data-uri="P700049702700000000000000000B78F" id="P7000497027000000000000000045C11" src="Images/chapter-08-image-23.png"/>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C12" id="P7000497027000000000000000045C12"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C13" id="P7000497027000000000000000045C13"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007208" epub:type="pagebreak" id="P7000497027000000000000000007208" title="825"></span>Physical memory reference</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045C14" id="P7000497027000000000000000045C14">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045C15" id="P7000497027000000000000000045C15">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045C16" id="P7000497027000000000000000045C16">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C17" id="P7000497027000000000000000045C17">Byte offset</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C18" id="P7000497027000000000000000045C18">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C19" id="P7000497027000000000000000045C19">Cache index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C1A" id="P7000497027000000000000000045C1A">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C1B" id="P7000497027000000000000000045C1B">Cache tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C1C" id="P7000497027000000000000000045C1C">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C1D" id="P7000497027000000000000000045C1D">Cache hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C1E" id="P7000497027000000000000000045C1E">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C1F" id="P7000497027000000000000000045C1F">Cache byte returned</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C20" id="P7000497027000000000000000045C20">_____</td>
</tr>
</tbody>
</table>
</li></ol></div></li></ol>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.7 Case Study: The Intel Core i7/Linux Memory System</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007216"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045C21" epub:type="title" id="P7000497027000000000000000045C21"><span class="pcalibre1 pcalibre21 pcalibre2">9.7 </span>Case Study: The Intel Core i7/Linux Memory System</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C22" id="P7000497027000000000000000045C22">We conclude our discussion of virtual memory mechanisms with a case study of a real system: an Intel Core i7 running Linux. Although the underlying Haswell microarchitecture allows for full 64-bit virtual and physical address spaces, the current Core i7 implementations (and those for the foreseeable future) support a 48-bit (256 TB) virtual address space and a 52-bit (4 PB) physical address space, along with a compatibility mode that supports 32-bit (4 GB) virtual and physical address spaces.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C23" id="P7000497027000000000000000045C23"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000721A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.21</span></a> gives the highlights of the Core i7 memory system. The <i class="pcalibre17 pcalibre2 pcalibre1">processor package</i> (chip) includes four cores, a large L3 cache shared by all of the cores, and</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000721A" id="P700049702700000000000000000721A">
<img alt="A diagram illustrates the Core I7 memory system." class="pcalibre1 calibre73 pcalibre2" data-uri="P700049702700000000000000000B790" id="P7000497027000000000000000045C24" src="Images/chapter-08-image-24.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045C25" id="P7000497027000000000000000045C25"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045C26" epub:type="title" id="P7000497027000000000000000045C26"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.21 </span>The Core i7 memory system.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025F6C" id="P7000497027000000000000000025F6C">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C27" id="P7000497027000000000000000045C27">A diagram shows a processor package interacting with main memory, as well other cores and I/O bridge. The components of the package are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045C28" id="P7000497027000000000000000045C28">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C29" id="P7000497027000000000000000045C29"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C2A" id="P7000497027000000000000000045C2A">Core x4</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045C2B" id="P7000497027000000000000000045C2B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C2C" id="P7000497027000000000000000045C2C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C2D" id="P7000497027000000000000000045C2D">Registers and Instruction fetch interact with L1 d-cache (32 KB, 8-way) and L1 i-cache (32 KB, 8-way), respectively, which interact with L2 unified cache (256 KB, 8-way)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C2E" id="P7000497027000000000000000045C2E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C2F" id="P7000497027000000000000000045C2F">MMU (addr translation) interacts with L1 d-TLB (64 entries, 4-way) and L1 i-TLB (128 entries, 4-way), which interact with L2 unified TLB (512 entries, 4-way)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C30" id="P7000497027000000000000000045C30"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C31" id="P7000497027000000000000000045C31">QuickPath interconnect interacts with other cores, I/O bridge, and DDR3 memory controller</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C32" id="P7000497027000000000000000045C32"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C33" id="P7000497027000000000000000045C33">L3 unified cache 8 MB, 16-way (shared by all cores), interacts with L2 unified cache and DDR3 memory controller</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C34" id="P7000497027000000000000000045C34"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C35" id="P7000497027000000000000000045C35">DDR3 memory controller (shared by all cores), interacts with main memory, L3 unified cache, L3 unified TLB, and QuickPath.</p></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000721E" id="P700049702700000000000000000721E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000721F" epub:type="pagebreak" id="P700049702700000000000000000721F" title="826"></span>
<img alt="A diagram summarizes Core I7 address translation." class="pcalibre1 pcalibre2 calibre74" data-uri="P700049702700000000000000000B791" id="P7000497027000000000000000045C36" src="Images/chapter-08-image-25.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045C37" id="P7000497027000000000000000045C37"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045C38" epub:type="title" id="P7000497027000000000000000045C38"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.22 </span>Summary of Core i7 address translation.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C39" id="P7000497027000000000000000045C39"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C3A" id="P7000497027000000000000000045C3A">For simplicity, the i-caches, i-TLB, and L2 unified TLB are not shown.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025F81" id="P7000497027000000000000000025F81">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C3B" id="P7000497027000000000000000045C3B">A diagram shows a flow through elements, as summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045C3C" id="P7000497027000000000000000045C3C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C3D" id="P7000497027000000000000000045C3D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C3E" id="P7000497027000000000000000045C3E">CPU</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C3F" id="P7000497027000000000000000045C3F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C40" id="P7000497027000000000000000045C40">Virtual address (VA) including 36-bit VPN and 12-bit VPO</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C41" id="P7000497027000000000000000045C41"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C42" id="P7000497027000000000000000045C42">Page tables, with PTEs in second register from VPN1 through VPN 4 (each 9 bits); PTE from one table to first register of next, with CR3 at first</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C43" id="P7000497027000000000000000045C43"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C44" id="P7000497027000000000000000045C44">L1 TLB (16 sets, 4 entries/set), with columns from TLBT (32 bits) from VPN and rows from TLBI (4 bits) from VPN</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C45" id="P7000497027000000000000000045C45"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C46" id="P7000497027000000000000000045C46">Physical address (PA) including PPN (40-bits, from TLB hit and PTE in last page table) and PPO (12 bits, from VPO)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C47" id="P7000497027000000000000000045C47"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C48" id="P7000497027000000000000000045C48">Physial address translated to CT (40 bits), CI (6 bits) and CO (6 bits)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C49" id="P7000497027000000000000000045C49"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C4A" id="P7000497027000000000000000045C4A">L1 d-cache (64 sets, 8 lines/set), with columns from CT and CO and rows from CI</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C4B" id="P7000497027000000000000000045C4B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C4C" id="P7000497027000000000000000045C4C">L2, l3, and main memory, with L1 miss from physical address translation</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C4D" id="P7000497027000000000000000045C4D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C4E" id="P7000497027000000000000000045C4E">Result (32/64) from L1 hit form L1 d-cache and from L2, L3, and main memory.</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C4F" id="P7000497027000000000000000045C4F">a DDR3 memory controller. Each core contains a hierarchy of TLBs, a hierarchy of data and instruction caches, and a set of fast point-to-point links, based on the QuickPath technology, for communicating directly with the other cores and the external I/O bridge. The TLBs are virtually addressed, and 4-way set associative. The L1, L2, and L3 caches are physically addressed, with a block size of 64 bytes. L1 and L2 are 8-way set associative, and L3 is 16-way set associative. The page size can be configured at start-up time as either 4 KB or 4 MB. Linux uses 4 KB pages.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007226" id="P7000497027000000000000000007226"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C50" epub:type="title" id="P7000497027000000000000000045C50"><span class="pcalibre1 pcalibre21 pcalibre2">9.7.1 </span>Core i7 Address Translation</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C51" id="P7000497027000000000000000045C51"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000721E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.22</span></a> summarizes the entire Core i7 address translation process, from the time the CPU generates a virtual address until a data word arrives from memory. The Core i7 uses a four-level page table hierarchy. Each process has its own private page table hierarchy. When a Linux process is running, the page tables associated with allocated pages are all memory-resident, although the Core i7 architecture allows these page tables to be swapped in and out. The <i class="pcalibre17 pcalibre2 pcalibre1">CR3</i> control register contains the physical address of the beginning of the level 1 (L1) page table. The value of CR3 is part of each process context, and is restored during each context switch.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007229" id="P7000497027000000000000000007229">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000722A" epub:type="pagebreak" id="P700049702700000000000000000722A" title="827"></span>
<img alt="A diagram and table summarize format of level 2, level 2, and level 3 page table entries." class="pcalibre1 pcalibre2 pcalibre273" data-uri="P700049702700000000000000000B792" id="P7000497027000000000000000045C52" src="Images/chapter-08-image-26.png"/>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045C53" id="P7000497027000000000000000045C53">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045C54" id="P7000497027000000000000000045C54">Field</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045C55" id="P7000497027000000000000000045C55">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C56" id="P7000497027000000000000000045C56">P</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C57" id="P7000497027000000000000000045C57">Child page table present in physical memory (1) or not (0).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C58" id="P7000497027000000000000000045C58">R/W</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C59" id="P7000497027000000000000000045C59">Read-only or read-write access permission for all reachable pages.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C5A" id="P7000497027000000000000000045C5A">U/S</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C5B" id="P7000497027000000000000000045C5B">User or supervisor (kernel) mode access permission for all reachable pages.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C5C" id="P7000497027000000000000000045C5C">WT</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C5D" id="P7000497027000000000000000045C5D">Write-through or write-back cache policy for the child page table.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C5E" id="P7000497027000000000000000045C5E">CD</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C5F" id="P7000497027000000000000000045C5F">Caching disabled or enabled for the child page table.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C60" id="P7000497027000000000000000045C60">A</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C61" id="P7000497027000000000000000045C61">Reference bit (set by MMU on reads and writes, cleared by software).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C62" id="P7000497027000000000000000045C62">PS</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C63" id="P7000497027000000000000000045C63">Page size either 4 KB or 4 MB (defined for level 1 PTEs only).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C64" id="P7000497027000000000000000045C64">Base addr</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C65" id="P7000497027000000000000000045C65">40 most significant bits of physical base address of child page table.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C66" id="P7000497027000000000000000045C66">XD</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C67" id="P7000497027000000000000000045C67">Disable or enable instruction fetches from all pages reachable from this PTE.</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045C68" id="P7000497027000000000000000045C68"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045C69" epub:type="title" id="P7000497027000000000000000045C69"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.23 </span>Format of level 1, level 2, and level 3 page table entries.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C6A" id="P7000497027000000000000000045C6A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C6B" id="P7000497027000000000000000045C6B">Each entry references a 4 KB child page table.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000025FB3" id="P7000497027000000000000000025FB3">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C6C" id="P7000497027000000000000000045C6C">A diagram shows bits 63 through 0, with 63 to 1 available for OS (page table location on disk) and bit 0 as P=0. Elements within the bits are summarized below.</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C6D" id="P7000497027000000000000000045C6D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C6E" id="P7000497027000000000000000045C6E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C6F" id="P7000497027000000000000000045C6F">63: XD</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C70" id="P7000497027000000000000000045C70"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C71" id="P7000497027000000000000000045C71">62 to 52: Unused</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C72" id="P7000497027000000000000000045C72"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C73" id="P7000497027000000000000000045C73">51 to 12: Page table physical base addr</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C74" id="P7000497027000000000000000045C74"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C75" id="P7000497027000000000000000045C75">11 to 9: Unused</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C76" id="P7000497027000000000000000045C76"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C77" id="P7000497027000000000000000045C77">8: G</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C78" id="P7000497027000000000000000045C78"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C79" id="P7000497027000000000000000045C79">7: PS</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C7A" id="P7000497027000000000000000045C7A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C7B" id="P7000497027000000000000000045C7B">6 (blank)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C7C" id="P7000497027000000000000000045C7C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C7D" id="P7000497027000000000000000045C7D">5: A</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C7E" id="P7000497027000000000000000045C7E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C7F" id="P7000497027000000000000000045C7F">4: CD</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C80" id="P7000497027000000000000000045C80"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C81" id="P7000497027000000000000000045C81">3: WT</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C82" id="P7000497027000000000000000045C82"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C83" id="P7000497027000000000000000045C83">2: U/S</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C84" id="P7000497027000000000000000045C84"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C85" id="P7000497027000000000000000045C85">1: R/W</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045C86" id="P7000497027000000000000000045C86"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045C87" id="P7000497027000000000000000045C87">0: P=1</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C88" id="P7000497027000000000000000045C88">These fields are described in the table, as reproduced below.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045C89" id="P7000497027000000000000000045C89">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045C8A" id="P7000497027000000000000000045C8A">Field</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045C8B" id="P7000497027000000000000000045C8B">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C8C" id="P7000497027000000000000000045C8C">P</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C8D" id="P7000497027000000000000000045C8D">Child page table present in physical memory (1) or not (0).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C8E" id="P7000497027000000000000000045C8E">R/W</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C8F" id="P7000497027000000000000000045C8F">Read-only or read-write access permission for all reachable pages.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C90" id="P7000497027000000000000000045C90">U/S</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C91" id="P7000497027000000000000000045C91">User or supervisor (kernel) mode access permission for all reachable pages.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C92" id="P7000497027000000000000000045C92">WT</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C93" id="P7000497027000000000000000045C93">Write-through or write-back cache policy for the child page table.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C94" id="P7000497027000000000000000045C94">CD</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C95" id="P7000497027000000000000000045C95">Caching disabled or enabled for the child page table.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C96" id="P7000497027000000000000000045C96">A</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C97" id="P7000497027000000000000000045C97">Reference bit (set by MMU on reads and writes, cleared by software).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C98" id="P7000497027000000000000000045C98">PS</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C99" id="P7000497027000000000000000045C99">Page size either 4 KB or 4 MB (defined for level 1 PTEs only).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C9A" id="P7000497027000000000000000045C9A">Base addr</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C9B" id="P7000497027000000000000000045C9B">40 most significant bits of physical base address of child page table.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C9C" id="P7000497027000000000000000045C9C">XD</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045C9D" id="P7000497027000000000000000045C9D">Disable or enable instruction fetches from all pages reachable from this PTE.</td>
</tr>
</tbody>
</table>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C9E" id="P7000497027000000000000000045C9E"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007229"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.23</span></a> shows the format of an entry in a level 1, level 2, or level 3 page table. When <var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 1 (which is always the case with Linux), the address field contains a 40-bit physical page number (PPN) that points to the beginning of the appropriate page table. Notice that this imposes a 4 KB alignment requirement on page tables.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045C9F" id="P7000497027000000000000000045C9F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007249"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.24</span></a> shows the format of an entry in a level 4 page table. When <var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 1, the address field contains a 40-bit PPN that points to the base of some page in physical memory. Again, this imposes a 4 KB alignment requirement on physical pages.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CA0" id="P7000497027000000000000000045CA0">The PTE has three permission bits that control access to the page. The <i class="pcalibre17 pcalibre2 pcalibre1">R/W</i> bit determines whether the contents of a page are read/write or read-only. The <i class="pcalibre17 pcalibre2 pcalibre1">U/S</i> bit, which determines whether the page can be accessed in user mode, protects code and data in the operating system kernel from user programs. The <i class="pcalibre17 pcalibre2 pcalibre1">XD</i> (execute disable) bit, which was introduced in 64-bit systems, can be used to disable instruction fetches from individual memory pages. This is an important new feature that allows the operating system kernel to reduce the risk of buffer overflow attacks by restricting execution to the read-only code segment.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CA1" id="P7000497027000000000000000045CA1">As the MMU translates each virtual address, it also updates two other bits that can be used by the kernel's page fault handler. The MMU sets the <var class="pcalibre17 pcalibre2 pcalibre1">A</var> bit, which is known as a <i class="pcalibre17 pcalibre2 pcalibre1">reference bit</i>, each time a page is accessed. The kernel can use the reference bit to implement its page replacement algorithm. The MMU sets the <var class="pcalibre17 pcalibre2 pcalibre1">D</var> bit, or <i class="pcalibre17 pcalibre2 pcalibre1">dirty bit</i>, each time the page is written to. A page that has been modified is sometimes called a <i class="pcalibre17 pcalibre2 pcalibre1">dirty page.</i> The dirty bit tells the kernel whether or not it must</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007249" id="P7000497027000000000000000007249">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000724A" epub:type="pagebreak" id="P700049702700000000000000000724A" title="828"></span>
<img alt="A diagram and table summarize format of level 4 page table entries." class="pcalibre274 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B793" id="P7000497027000000000000000045CA2" src="Images/chapter-08-image-27.png"/>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045CA3" id="P7000497027000000000000000045CA3">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045CA4" id="P7000497027000000000000000045CA4">Field</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045CA5" id="P7000497027000000000000000045CA5">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CA6" id="P7000497027000000000000000045CA6">P</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CA7" id="P7000497027000000000000000045CA7">Child page present in physical memory (1) or not (0).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CA8" id="P7000497027000000000000000045CA8">R/W</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CA9" id="P7000497027000000000000000045CA9">Read-only or read/write access permission for child page.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CAA" id="P7000497027000000000000000045CAA">U/S</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CAB" id="P7000497027000000000000000045CAB">User or supervisor mode (kernel mode) access permission for child page.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CAC" id="P7000497027000000000000000045CAC">WT</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CAD" id="P7000497027000000000000000045CAD">Write-through or write-back cache policy for the child page.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CAE" id="P7000497027000000000000000045CAE">CD</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CAF" id="P7000497027000000000000000045CAF">Cache disabled or enabled.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB0" id="P7000497027000000000000000045CB0">A</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB1" id="P7000497027000000000000000045CB1">Reference bit (set by MMU on reads and writes, cleared by software).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB2" id="P7000497027000000000000000045CB2">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB3" id="P7000497027000000000000000045CB3">Dirty bit (set by MMU on writes, cleared by software).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB4" id="P7000497027000000000000000045CB4">G</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB5" id="P7000497027000000000000000045CB5">Global page (don't evict from TLB on task switch).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB6" id="P7000497027000000000000000045CB6">Base addr</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB7" id="P7000497027000000000000000045CB7">40 most significant bits of physical base address of child page.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB8" id="P7000497027000000000000000045CB8">XD</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CB9" id="P7000497027000000000000000045CB9">Disable or enable instruction fetches from the child page.</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045CBA" id="P7000497027000000000000000045CBA"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045CBB" epub:type="title" id="P7000497027000000000000000045CBB"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.24 </span>Format of level 4 page table entries.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CBC" id="P7000497027000000000000000045CBC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CBD" id="P7000497027000000000000000045CBD">Each entry references a 4 KB child page.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000026006" id="P7000497027000000000000000026006">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CBE" id="P7000497027000000000000000045CBE">A diagram shows bits 63 through 0, with 63 to 1 available for OS (page table location on disk) and bit 0 as P=0. Elements within the bits are summarized below.</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CBF" id="P7000497027000000000000000045CBF">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CC0" id="P7000497027000000000000000045CC0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CC1" id="P7000497027000000000000000045CC1">63: XD</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CC2" id="P7000497027000000000000000045CC2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CC3" id="P7000497027000000000000000045CC3">62 to 52: Unused</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CC4" id="P7000497027000000000000000045CC4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CC5" id="P7000497027000000000000000045CC5">51 to 12: Page physical base addr</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CC6" id="P7000497027000000000000000045CC6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CC7" id="P7000497027000000000000000045CC7">11 to 9: Unused</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CC8" id="P7000497027000000000000000045CC8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CC9" id="P7000497027000000000000000045CC9">8: G</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CCA" id="P7000497027000000000000000045CCA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CCB" id="P7000497027000000000000000045CCB">7: 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CCC" id="P7000497027000000000000000045CCC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CCD" id="P7000497027000000000000000045CCD">6: D</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CCE" id="P7000497027000000000000000045CCE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CCF" id="P7000497027000000000000000045CCF">5: A</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CD0" id="P7000497027000000000000000045CD0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CD1" id="P7000497027000000000000000045CD1">4: CD</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CD2" id="P7000497027000000000000000045CD2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CD3" id="P7000497027000000000000000045CD3">3: WT</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CD4" id="P7000497027000000000000000045CD4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CD5" id="P7000497027000000000000000045CD5">2: U/S</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CD6" id="P7000497027000000000000000045CD6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CD7" id="P7000497027000000000000000045CD7">1: R/W</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CD8" id="P7000497027000000000000000045CD8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CD9" id="P7000497027000000000000000045CD9">0: P=1</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CDA" id="P7000497027000000000000000045CDA">These fields are described in the table, as reproduced below.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045CDB" id="P7000497027000000000000000045CDB">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045CDC" id="P7000497027000000000000000045CDC">Field</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045CDD" id="P7000497027000000000000000045CDD">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CDE" id="P7000497027000000000000000045CDE">P</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CDF" id="P7000497027000000000000000045CDF">Child page table present in physical memory (1) or not (0).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE0" id="P7000497027000000000000000045CE0">R/W</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE1" id="P7000497027000000000000000045CE1">Read-only or read-write access permission for all child page.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE2" id="P7000497027000000000000000045CE2">U/S</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE3" id="P7000497027000000000000000045CE3">User or supervisor mode (kernel mode) access permission for child page.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE4" id="P7000497027000000000000000045CE4">WT</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE5" id="P7000497027000000000000000045CE5">Write-through or write-back cache policy for the child page.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE6" id="P7000497027000000000000000045CE6">CD</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE7" id="P7000497027000000000000000045CE7">Caching disabled or enabled.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE8" id="P7000497027000000000000000045CE8">A</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CE9" id="P7000497027000000000000000045CE9">Reference bit (set by MMU on reads and writes, cleared by software).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CEA" id="P7000497027000000000000000045CEA">D</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CEB" id="P7000497027000000000000000045CEB">Dirty bit (set by MMU on writes, cleared by softwaref).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CEC" id="P7000497027000000000000000045CEC">G</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CED" id="P7000497027000000000000000045CED">Global page (don't evict from TLB on task switch).</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CEE" id="P7000497027000000000000000045CEE">Base addr</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CEF" id="P7000497027000000000000000045CEF">40 most significant bits of physical base address of child page table.</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CF0" id="P7000497027000000000000000045CF0">XD</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CF1" id="P7000497027000000000000000045CF1">Disable or enable instruction fetches from the child page.</td>
</tr>
</tbody>
</table>
</details>
</figcaption></figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CF2" id="P7000497027000000000000000045CF2">write back a victim page before it copies in a replacement page. The kernel can call a special kernel-mode instruction to clear the reference or dirty bits.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CF3" id="P7000497027000000000000000045CF3"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000726E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.25</span></a> shows how the Core i7 MMU uses the four levels of page tables to translate a virtual address to a physical address. The 36-bit VPN is partitioned into four 9-bit chunks, each of which is used as an offset into a page table. The CR3 register contains the physical address of the L1 page table. VPN 1 provides an offset to an L1 PTE, which contains the base address of the L2 page table. VPN 2 provides an offset to an L2 PTE, and so on.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007269" id="P7000497027000000000000000007269"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CF4" epub:type="title" id="P7000497027000000000000000045CF4"><span class="pcalibre1 pcalibre21 pcalibre2">9.7.2 </span>Linux Virtual Memory System</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CF5" id="P7000497027000000000000000045CF5">A virtual memory system requires close cooperation between the hardware and the kernel. Details vary from version to version, and a complete description is beyond our scope. Nonetheless, our aim in this section is to describe enough of the Linux virtual memory system to give you a sense of how a real operating system organizes virtual memory and how it handles page faults.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CF6" id="P7000497027000000000000000045CF6">Linux maintains a separate virtual address space for each process of the form shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007275"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.26</span></a>. We have seen this picture a number of times already, with its familiar code, data, heap, shared library, and stack segments. Now that we understand address translation, we can fill in some more details about the kernel virtual memory that lies above the user stack.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CF7" id="P7000497027000000000000000045CF7">The kernel virtual memory contains the code and data structures in the kernel. Some regions of the kernel virtual memory are mapped to physical pages that</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000726E" id="P700049702700000000000000000726E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000726F" epub:type="pagebreak" id="P700049702700000000000000000726F" title="829"></span>
<img alt="A diagram illustrates Core I7 page table translation." class="pcalibre275 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B794" id="P7000497027000000000000000045CF8" src="Images/chapter-08-image-28.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045CF9" id="P7000497027000000000000000045CF9"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045CFA" epub:type="title" id="P7000497027000000000000000045CFA"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.25 </span>Core i7 page table translation.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045CFB" id="P7000497027000000000000000045CFB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045CFC" id="P7000497027000000000000000045CFC">PT: page table; PTE: page table entry; VPN: virtual page number; VPO: virtual page offset; PPN: physical page number; PPO: physical page offset. The Linux names for the four levels of page tables are also shown.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000026046" id="P7000497027000000000000000026046">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CFD" id="P7000497027000000000000000045CFD">A diagram shows a virtual address with 9 bits each for VPN 1 through VPN 4, and 12 bits for VPO. A physical address has 40 bits for PPN and 12 for PPO. Translations from VPN 1 through VPN 4 are through tables, as summarized below.</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045CFE" id="P7000497027000000000000000045CFE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045CFF" id="P7000497027000000000000000045CFF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D00" id="P7000497027000000000000000045D00">VPN 1 to L1` PTE in L1 PT page global directory (512 GB region per entry); CR3 sends 40 bits physical address of L1 PT</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D01" id="P7000497027000000000000000045D01"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D02" id="P7000497027000000000000000045D02">VPN 2 to L2` PTE in L2 PT page upper directory (1 GB region per entry); L1 PTE sends 40 bits</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D03" id="P7000497027000000000000000045D03"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D04" id="P7000497027000000000000000045D04">VPN 3 to L3` PTE in L2 PT page middle directory (2 MB region per entry); L2 PTE sends 40 bits</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D05" id="P7000497027000000000000000045D05"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D06" id="P7000497027000000000000000045D06">VPN 4 to L4` PTE in L4 PT page table (4 KB region per entry); L3 PTE sends 40 bits</p></li>
</ul>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D07" id="P7000497027000000000000000045D07">The physical address of page (40 bits) is translated to PPN, which VPO (12 bits) translated as offset into physical and virtual page to PPO.</p>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007275" id="P7000497027000000000000000007275">
<img alt="A diagram illustrates the virtual memory of a Linux process" class="pcalibre1 pcalibre2 pcalibre276" data-uri="P700049702700000000000000000B795" id="P7000497027000000000000000045D08" src="Images/chapter-08-image-29.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045D09" id="P7000497027000000000000000045D09"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045D0A" epub:type="title" id="P7000497027000000000000000045D0A"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.26 </span>The virtual memory of a Linux process.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000026055" id="P7000497027000000000000000026055">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D0B" id="P7000497027000000000000000045D0B">A diagram illustrates a stack, with registered summarized from bottom to top below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045D0C" id="P7000497027000000000000000045D0C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D0D" id="P7000497027000000000000000045D0D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D0E" id="P7000497027000000000000000045D0E">Process virtual memory:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045D0F" id="P7000497027000000000000000045D0F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D10" id="P7000497027000000000000000045D10"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D11" id="P7000497027000000000000000045D11">Gap from 0 to 0x400000</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D12" id="P7000497027000000000000000045D12"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D13" id="P7000497027000000000000000045D13">Code (.text)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D14" id="P7000497027000000000000000045D14"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D15" id="P7000497027000000000000000045D15">Initialized data (.data)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D16" id="P7000497027000000000000000045D16"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D17" id="P7000497027000000000000000045D17">Uninitialized data (.bss)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D18" id="P7000497027000000000000000045D18"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D19" id="P7000497027000000000000000045D19">Run-time heap (via malloc), to brk</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D1A" id="P7000497027000000000000000045D1A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D1B" id="P7000497027000000000000000045D1B">Gap</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D1C" id="P7000497027000000000000000045D1C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D1D" id="P7000497027000000000000000045D1D">Memory-mapped region for shared libraries</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D1E" id="P7000497027000000000000000045D1E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D1F" id="P7000497027000000000000000045D1F">Gap to %rsp</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D20" id="P7000497027000000000000000045D20"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D21" id="P7000497027000000000000000045D21">User stack</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D22" id="P7000497027000000000000000045D22"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D23" id="P7000497027000000000000000045D23">Kernel virtual memory:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045D24" id="P7000497027000000000000000045D24">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D25" id="P7000497027000000000000000045D25"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D26" id="P7000497027000000000000000045D26">Kernel code and data, Physical memory (identical for each process)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D27" id="P7000497027000000000000000045D27"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D28" id="P7000497027000000000000000045D28">Process-specific data structures (e.g., page tables, task and mm structs, kernel stack) (different for each process)</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000007279" id="P7000497027000000000000000007279"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter09.xhtml#P7000497027000000000000000045D29" epub:type="title" id="P7000497027000000000000000045D29"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000727B" epub:type="pagebreak" id="P700049702700000000000000000727B" title="830"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Optimizing address translation</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D2A" id="P7000497027000000000000000045D2A">In our discussion of address translation, we have described a sequential two-step process where the MMU (1) translates the virtual address to a physical address and then (2) passes the physical address to the L1 cache. However, real hardware implementations use a neat trick that allows these steps to be partially overlapped, thus speeding up accesses to the L1 cache. For example, a virtual address on a Core i7 with 4 KB pages has 12 bits of VPO, and these bits are identical to the 12 bits of PPO in the corresponding physical address. Since the 8-way set associative physically addressed L1 caches have 64 sets and 64-byte cache blocks, each physical address has 6 (log<sub class="pcalibre1 pcalibre2 calibre14">2</sub> 64) cache offset bits and 6 (log<sub class="pcalibre1 pcalibre2 calibre14">2</sub> 64) index bits. These 12 bits fit exactly in the 12-bit VPO of a virtual address, which is no accident! When the CPU needs a virtual address translated, it sends the VPN to the MMU and the VPO to the L1 cache. While the MMU is requesting a page table entry from the TLB, the L1 cache is busy using the VPO bits to find the appropriate set and read out the eight tags and corresponding data words in that set. When the MMU gets the PPN back from the TLB, the cache is ready to try to match the PPN to one of these eight tags.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D2B" id="P7000497027000000000000000045D2B">are shared by all processes. For example, each process shares the kernel's code and global data structures. Interestingly, Linux also maps a set of contiguous virtual pages (equal in size to the total amount of DRAM in the system) to the corresponding set of contiguous physical pages. This provides the kernel with a convenient way to access any specific location in physical memory—for example, when it needs to access page tables or to perform memory-mapped I/O operations on devices that are mapped to particular physical memory locations.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D2C" id="P7000497027000000000000000045D2C">Other regions of kernel virtual memory contain data that differ for each process. Examples include page tables, the stack that the kernel uses when it is executing code in the context of the process, and various data structures that keep track of the current organization of the virtual address space.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000727F" id="P700049702700000000000000000727F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D2D" epub:type="title" id="P7000497027000000000000000045D2D">Linux Virtual Memory Areas</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D2E" id="P7000497027000000000000000045D2E">Linux organizes the virtual memory as a collection of <i class="pcalibre17 pcalibre2 pcalibre1">areas</i> (also called <i class="pcalibre17 pcalibre2 pcalibre1">segments).</i> An area is a contiguous chunk of existing (allocated) virtual memory whose pages are related in some way. For example, the code segment, data segment, heap, shared library segment, and user stack are all distinct areas. Each existing virtual page is contained in some area, and any virtual page that is not part of some area does not exist and cannot be referenced by the process. The notion of an area is important because it allows the virtual address space to have gaps. The kernel does not keep track of virtual pages that do not exist, and such pages do not consume any additional resources in memory, on disk, or in the kernel itself.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D2F" id="P7000497027000000000000000045D2F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007284"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.27</span></a> highlights the kernel data structures that keep track of the virtual memory areas in a process. The kernel maintains a distinct task structure (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D30" id="P7000497027000000000000000045D30">task_struct</code> in the source code) for each process in the system. The elements of the task structure either contain or point to all of the information that the kernel needs to</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007284" id="P7000497027000000000000000007284">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007285" epub:type="pagebreak" id="P7000497027000000000000000007285" title="831"></span>
<img alt="A diagram illustrates how Linux organizes virtual memory." class="pcalibre1 pcalibre277 pcalibre2" data-uri="P700049702700000000000000000B796" id="P7000497027000000000000000045D31" src="Images/chapter-08-image-30.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045D32" id="P7000497027000000000000000045D32"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045D33" epub:type="title" id="P7000497027000000000000000045D33"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.27 </span>How Linux organizes virtual memory.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P700049702700000000000000002607F" id="P700049702700000000000000002607F">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D34" id="P7000497027000000000000000045D34">A diagram shows stacks of elements, with arrows pointing through them, as summarized in order below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045D35" id="P7000497027000000000000000045D35">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D36" id="P7000497027000000000000000045D36"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D37" id="P7000497027000000000000000045D37">Task_struct contains mm, with arrow to pgd below</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D38" id="P7000497027000000000000000045D38"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D39" id="P7000497027000000000000000045D39">Mm_struct contains pgd and map, with arrow from map to first va_end below</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D3A" id="P7000497027000000000000000045D3A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D3B" id="P7000497027000000000000000045D3B">Vm_area_struct: three tables, each with entries va_end, vm_start, vm_prot, vm_flags, and va_next; the first two have gaps before va_next; arrows flow from va_next to va_end in table below it.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D3C" id="P7000497027000000000000000045D3C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D3D" id="P7000497027000000000000000045D3D">Process virtual memory, with the following entries:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045D3E" id="P7000497027000000000000000045D3E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D3F" id="P7000497027000000000000000045D3F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D40" id="P7000497027000000000000000045D40">Shared libraries, from first va_end and vm_start</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D41" id="P7000497027000000000000000045D41"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D42" id="P7000497027000000000000000045D42">Data, from second va_end and vm_start</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D43" id="P7000497027000000000000000045D43"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D44" id="P7000497027000000000000000045D44">Test, from third va_end and vm_start.</p></li>
</ul>
</li></ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D45" id="P7000497027000000000000000045D45">run the process (e.g., the PID, pointer to the user stack, name of the executable object file, and program counter).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D46" id="P7000497027000000000000000045D46">One of the entries in the task structure points to an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D47" id="P7000497027000000000000000045D47">mm_struct</code> that characterizes the current state of the virtual memory. The two fields of interest to us are <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D48" id="P7000497027000000000000000045D48">pgd</code>, which points to the base of the level 1 table (the page global directory), and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D49" id="P7000497027000000000000000045D49">mmap</code>, which points to a list of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D4A" id="P7000497027000000000000000045D4A">vm_area_structs</code> (area structs), each of which characterizes an area of the current virtual address space. When the kernel runs this process, it stores <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D4B" id="P7000497027000000000000000045D4B">pgd</code> in the CR3 control register.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D4C" id="P7000497027000000000000000045D4C">For our purposes, the area struct for a particular area contains the following fields:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D4D" id="P7000497027000000000000000045D4D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D4E" id="P7000497027000000000000000045D4E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045D4F" id="P7000497027000000000000000045D4F"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D50" id="P7000497027000000000000000045D50">fvm_start</code>. </span>Points to the beginning of the area.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D51" id="P7000497027000000000000000045D51"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045D52" id="P7000497027000000000000000045D52"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D53" id="P7000497027000000000000000045D53">vm_end</code>. </span>Points to the end of the area.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D54" id="P7000497027000000000000000045D54"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045D55" id="P7000497027000000000000000045D55"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D56" id="P7000497027000000000000000045D56">vm_prot</code>. </span>Describes the read/write permissions for all of the pages contained in the area.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D57" id="P7000497027000000000000000045D57"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045D58" id="P7000497027000000000000000045D58"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D59" id="P7000497027000000000000000045D59">vm_flags</code>. </span>Describes (among other things) whether the pages in the area are shared with other processes or private to this process.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D5A" id="P7000497027000000000000000045D5A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045D5B" id="P7000497027000000000000000045D5B"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D5C" id="P7000497027000000000000000045D5C">vm_next</code>. </span>Points to the next area struct in the list.</p></li>
</ul>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000072A1" id="P70004970270000000000000000072A1">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000072A2" epub:type="pagebreak" id="P70004970270000000000000000072A2" title="832"></span>
<img alt="A diagram illustrates Linux page fault handling." class="pcalibre1 pcalibre2 pcalibre278" data-uri="P700049702700000000000000000B797" id="P7000497027000000000000000045D5D" src="Images/chapter-08-image-31.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045D5E" id="P7000497027000000000000000045D5E"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045D5F" epub:type="title" id="P7000497027000000000000000045D5F"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.28 </span>Linux page fault handling.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P70004970270000000000000000260AC" id="P70004970270000000000000000260AC">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D60" id="P7000497027000000000000000045D60">A diagram shows stacks for vm_area_struct and process virtual memory. The three tables in vm_area_struct have five registers: vm_end, vm_start, r/o (for first and third) or r/w (second), gap, and vm_next. Steps with the process virtual memory are listed below.</p>
<ol class="pcalibre75 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D61" id="P7000497027000000000000000045D61">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D62" id="P7000497027000000000000000045D62"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D63" id="P7000497027000000000000000045D63">Segmentation fault: accessing a nonexistent page (gap between shared libraries and data registers)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D64" id="P7000497027000000000000000045D64"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D65" id="P7000497027000000000000000045D65">Protection exception (e.g., violating permission by writing to a read-only page) (Code register)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D66" id="P7000497027000000000000000045D66"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D67" id="P7000497027000000000000000045D67">Normal page fault (Data register)</p></li>
</ol>
</details>
</figcaption>
</figure>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000072A6" id="P70004970270000000000000000072A6"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D68" epub:type="title" id="P7000497027000000000000000045D68">Linux Page Fault Exception Handling</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D69" id="P7000497027000000000000000045D69">Suppose the MMU triggers a page fault while trying to translate some virtual address <i class="pcalibre17 pcalibre2 pcalibre1">A.</i> The exception results in a transfer of control to the kernel's page fault handler, which then performs the following steps:</p>
<ol class="pcalibre1 calibre19 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D6A" id="P7000497027000000000000000045D6A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D6B" id="P7000497027000000000000000045D6B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D6C" id="P7000497027000000000000000045D6C">Is virtual address <var class="pcalibre17 pcalibre2 pcalibre1">A</var> legal? In other words, does <var class="pcalibre17 pcalibre2 pcalibre1">A</var> lie within an area defined by some area struct? To answer this question, the fault handler searches the list of area structs, comparing <var class="pcalibre17 pcalibre2 pcalibre1">A</var> with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D6D" id="P7000497027000000000000000045D6D">vm_start</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D6E" id="P7000497027000000000000000045D6E">vm_end</code> in each area struct. If the instruction is not legal, then the fault handler triggers a segmentation fault, which terminates the process. This situation is labeled "1" in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000072A1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.28</span></a>.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D6F" id="P7000497027000000000000000045D6F">Because a process can create an arbitrary number of new virtual memory areas (using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D70" id="P7000497027000000000000000045D70">mmap</code> function described in the next section), a sequential search of the list of area structs might be very costly. So in practice, Linux superimposes a tree on the list, using some fields that we have not shown, and performs the search on this tree.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D71" id="P7000497027000000000000000045D71"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D72" id="P7000497027000000000000000045D72">Is the attempted memory access legal? In other words, does the process have permission to read, write, or execute the pages in this area? For example, was the page fault the result of a store instruction trying to write to a read-only page in the code segment? Is the page fault the result of a process running in user mode that is attempting to read a word from kernel virtual memory? If the attempted access is not legal, then the fault handler triggers a protection exception, which terminates the process. This situation is labeled "2" in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000072A1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.28</span></a>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D73" id="P7000497027000000000000000045D73"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D74" id="P7000497027000000000000000045D74">At this point, the kernel knows that the page fault resulted from a legal operation on a legal virtual address. It handles the fault by selecting a victim page, swapping out the victim page if it is dirty, swapping in the new page, <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000072B4" epub:type="pagebreak" id="P70004970270000000000000000072B4" title="833"></span>and updating the page table. When the page fault handler returns, the CPU restarts the faulting instruction, which sends <var class="pcalibre17 pcalibre2 pcalibre1">A</var> to the MMU again. This time, the MMU translates <var class="pcalibre17 pcalibre2 pcalibre1">A</var> normally, without generating a page fault.</p></li>
</ol>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.8 Memory Mapping</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000072B5"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045D75" epub:type="title" id="P7000497027000000000000000045D75"><span class="pcalibre1 pcalibre21 pcalibre2">9.8 </span>Memory Mapping</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D76" id="P7000497027000000000000000045D76">Linux initializes the contents of a virtual memory area by associating it with an <i class="pcalibre17 pcalibre2 pcalibre1">object</i> on disk, a process known as <i class="pcalibre17 pcalibre2 pcalibre1">memory mapping.</i> Areas can be mapped to one of two types of objects:</p>
<ol class="pcalibre1 calibre19 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D77" id="P7000497027000000000000000045D77">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D78" id="P7000497027000000000000000045D78"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D79" id="P7000497027000000000000000045D79"><span class="pcalibre1 pcalibre2 pcalibre41">Regular file in the Linux file system: </span>An area can be mapped to a contiguous section of a regular disk file, such as an executable object file. The file section is divided into page-size pieces, with each piece containing the initial contents of a virtual page. Because of demand paging, none of these virtual pages is actually swapped into physical memory until the CPU first <i class="pcalibre17 pcalibre2 pcalibre1">touches</i> the page (i.e., issues a virtual address that falls within that page's region of the address space). If the area is larger than the file section, then the area is padded with zeros.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D7A" id="P7000497027000000000000000045D7A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D7B" id="P7000497027000000000000000045D7B"><span class="pcalibre1 pcalibre2 pcalibre41">Anonymous file: </span>An area can also be mapped to an anonymous file, created by the kernel, that contains all binary zeros. The first time the CPU touches a virtual page in such an area, the kernel finds an appropriate victim page in physical memory, swaps out the victim page if it is dirty, overwrites the victim page with binary zeros, and updates the page table to mark the page as resident. Notice that no data are actually transferred between disk and memory. For this reason, pages in areas that are mapped to anonymous files are sometimes called <i class="pcalibre17 pcalibre2 pcalibre1">demand-zero pages.</i></p></li>
</ol>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D7C" id="P7000497027000000000000000045D7C">In either case, once a virtual page is initialized, it is swapped back and forth between a special <i class="pcalibre17 pcalibre2 pcalibre1">swap file</i> maintained by the kernel. The swap file is also known as the <i class="pcalibre17 pcalibre2 pcalibre1">swap space</i> or the <i class="pcalibre17 pcalibre2 pcalibre1">swap area.</i> An important point to realize is that at any point in time, the swap space bounds the total amount of virtual pages that can be allocated by the currently running processes.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000072BE" id="P70004970270000000000000000072BE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D7D" epub:type="title" id="P7000497027000000000000000045D7D"><span class="pcalibre1 pcalibre21 pcalibre2">9.8.1 </span>Shared Objects Revisited</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D7E" id="P7000497027000000000000000045D7E">The idea of memory mapping resulted from a clever insight that if the virtual memory system could be integrated into the conventional file system, then it could provide a simple and efficient way to load programs and data into memory.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D7F" id="P7000497027000000000000000045D7F">As we have seen, the process abstraction promises to provide each process with its own private virtual address space that is protected from errant writes or reads by other processes. However, many processes have identical read-only code areas. For example, each process that runs the Linux shell program bash has the same code area. Further, many programs need to access identical copies of read-only run-time library code. For example, every C program requires functions from the standard C library such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D80" id="P7000497027000000000000000045D80">printf</code>. It would be extremely wasteful for each process to keep duplicate copies of these commonly used codes in physical <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000072C3" epub:type="pagebreak" id="P70004970270000000000000000072C3" title="834"></span>memory. Fortunately, memory mapping provides us with a clean mechanism for controlling how objects are shared by multiple processes.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D81" id="P7000497027000000000000000045D81">An object can be mapped into an area of virtual memory as either a <i class="pcalibre17 pcalibre2 pcalibre1">shared object</i> or <i class="pcalibre17 pcalibre2 pcalibre1">a private object.</i> If a process maps a shared object into an area of its virtual address space, then any writes that the process makes to that area are visible to any other processes that have also mapped the shared object into their virtual memory. Further, the changes are also reflected in the original object on disk.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D82" id="P7000497027000000000000000045D82">Changes made to an area mapped to a private object, on the other hand, are not visible to other processes, and any writes that the process makes to the area are <i class="pcalibre17 pcalibre2 pcalibre1">not</i> reflected back to the object on disk. A virtual memory area into which a shared object is mapped is often called a <i class="pcalibre17 pcalibre2 pcalibre1">shared area.</i> Similarly for <i class="pcalibre17 pcalibre2 pcalibre1">a private area.</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D83" id="P7000497027000000000000000045D83">Suppose that process 1 maps a shared object into an area of its virtual memory, as shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000072C7"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.29(a)</span></a>. Now suppose that process 2 maps the same shared object</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000072C7" id="P70004970270000000000000000072C7">
<img alt="Diagram (a) shows shared object mapped to process 1 virtual memory (shared with physical memory). Diagram (b) shows shared object mapped to process 1 and process 2 virtual memory." class="pcalibre1 pcalibre2 calibre75" data-uri="P700049702700000000000000000B798" id="P7000497027000000000000000045D84" src="Images/chapter-08-image-32.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045D85" id="P7000497027000000000000000045D85"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045D86" epub:type="title" id="P7000497027000000000000000045D86"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.29 </span>A shared object.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D87" id="P7000497027000000000000000045D87"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D88" id="P7000497027000000000000000045D88">(a) After process 1 maps the shared object, (b) After process 2 maps the same shared object. (Note that the physical pages are not necessarily contiguous.)</p></div></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000072CD" id="P70004970270000000000000000072CD">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000072CE" epub:type="pagebreak" id="P70004970270000000000000000072CE" title="835"></span>
<img alt="Diagrams illustrate a private copy-on-write object." class="pcalibre1 pcalibre2 calibre76" data-uri="P700049702700000000000000000B799" id="P7000497027000000000000000045D89" src="Images/chapter-08-image-33.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045D8A" id="P7000497027000000000000000045D8A"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045D8B" epub:type="title" id="P7000497027000000000000000045D8B"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.30 </span>A private copy-on-write object.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045D8C" id="P7000497027000000000000000045D8C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D8D" id="P7000497027000000000000000045D8D">(a) After both processes have mapped the private copy-on-write object, (b) After process 2 writes to a page in the private area.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P70004970270000000000000000260DB" id="P70004970270000000000000000260DB">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045D8E" id="P7000497027000000000000000045D8E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D8F" id="P7000497027000000000000000045D8F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D90" id="P7000497027000000000000000045D90">Diagram (a) shows private copy-on-write object mapped to process 1 and process 2 virtual memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045D91" id="P7000497027000000000000000045D91"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045D92" id="P7000497027000000000000000045D92">Diagram (b) shows private copy-on-write object mapped to process 1 and process 2 virtual memory. The copy-on-write segment is repeated in physical memory, which is then mapped as write to private copy-on-write page on process 2 virtual memory.</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D93" id="P7000497027000000000000000045D93">into its address space (not necessarily at the same virtual address as process 1), as shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000072C7"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.29(b)</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D94" id="P7000497027000000000000000045D94">Since each object has a unique filename, the kernel can quickly determine that process 1 has already mapped this object and can point the page table entries in process 2 to the appropriate physical pages. The key point is that only a single copy of the shared object needs to be stored in physical memory, even though the object is mapped into multiple shared areas. For convenience, we have shown the physical pages as being contiguous, but of course this is not true in general.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D95" id="P7000497027000000000000000045D95">Private objects are mapped into virtual memory using a clever technique known as <i class="pcalibre17 pcalibre2 pcalibre1">copy-on-write.</i> A private object begins life in exactly the same way as a shared object, with only one copy of the private object stored in physical memory. For example, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000072CD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.30(a)</span></a> shows a case where two processes have mapped a private object into different areas of their virtual memories but share the same <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000072D7" epub:type="pagebreak" id="P70004970270000000000000000072D7" title="836"></span>physical copy of the object. For each process that maps the private object, the page table entries for the corresponding private area are flagged as read-only, and the area struct is flagged <i class="pcalibre17 pcalibre2 pcalibre1">as private copy-on-write.</i> So long as neither process attempts to write to its respective private area, they continue to share a single copy of the object in physical memory. However, as soon as a process attempts to write to some page in the private area, the write triggers a protection fault.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D96" id="P7000497027000000000000000045D96">When the fault handler notices that the protection exception was caused by the process trying to write to a page in a private copy-on-write area, it creates a new copy of the page in physical memory, updates the page table entry to point to the new copy, and then restores write permissions to the page, as shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000072CD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.30(b)</span></a>. When the fault handler returns, the CPU re-executes the write, which now proceeds normally on the newly created page.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D97" id="P7000497027000000000000000045D97">By deferring the copying of the pages in private objects until the last possible moment, copy-on-write makes the most efficient use of scarce physical memory.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000072DA" id="P70004970270000000000000000072DA"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D98" epub:type="title" id="P7000497027000000000000000045D98"><span class="pcalibre1 pcalibre21 pcalibre2">9.8.2 </span>The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D99" id="P7000497027000000000000000045D99">fork</code> Function Revisited</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D9A" id="P7000497027000000000000000045D9A">Now that we understand virtual memory and memory mapping, we can get a clear idea of how the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D9B" id="P7000497027000000000000000045D9B">fork</code> function creates a new process with its own independent virtual address space.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D9C" id="P7000497027000000000000000045D9C">When the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D9D" id="P7000497027000000000000000045D9D">fork</code> function is called by the <i class="pcalibre17 pcalibre2 pcalibre1">current process</i>, the kernel creates various data structures for the <i class="pcalibre17 pcalibre2 pcalibre1">new process</i> and assigns it a unique PID. To create the virtual memory for the new process, it creates exact copies of the current process's <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D9E" id="P7000497027000000000000000045D9E">mm_struct</code>, area structs, and page tables. It flags each page in both processes as read-only, and flags each area struct in both processes as private copy-on-write.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045D9F" id="P7000497027000000000000000045D9F">When the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DA0" id="P7000497027000000000000000045DA0">fork</code> returns in the new process, the new process now has an exact copy of the virtual memory as it existed when the fork was called. When either of the processes performs any subsequent writes, the copy-on-write mechanism creates new pages, thus preserving the abstraction of a private address space for each process.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000072E4" id="P70004970270000000000000000072E4"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DA1" epub:type="title" id="P7000497027000000000000000045DA1"><span class="pcalibre1 pcalibre21 pcalibre2">9.8.3 </span>The execve Function Revisited</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DA2" id="P7000497027000000000000000045DA2">Virtual memory and memory mapping also play key roles in the process of loading programs into memory. Now that we understand these concepts, we can understand how the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DA3" id="P7000497027000000000000000045DA3">execve</code> function really loads and executes programs. Suppose that the program running in the current process makes the following call:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DA4" id="P7000497027000000000000000045DA4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DA5" id="P7000497027000000000000000045DA5">
execve("a.out", NULL, NULL);
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DA6" id="P7000497027000000000000000045DA6">As you learned in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000666E.xhtml#P700049702700000000000000000666E"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">8</span></a>, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DA7" id="P7000497027000000000000000045DA7">execve</code> function loads and runs the program contained in the executable object file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DA8" id="P7000497027000000000000000045DA8">a.out</code> within the current process, effectively replacing the current program with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DA9" id="P7000497027000000000000000045DA9">a.out</code> program. Loading and running <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DAA" id="P7000497027000000000000000045DAA">a.out</code> requires the following steps:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000072EF" id="P70004970270000000000000000072EF">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000072F0" epub:type="pagebreak" id="P70004970270000000000000000072F0" title="837"></span>
<img alt="A diagram illustrates how the loader maps the areas of the user address space." class="pcalibre1 pcalibre2 pcalibre279" data-uri="P700049702700000000000000000B79A" id="P7000497027000000000000000045DAB" src="Images/chapter-08-image-34.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045DAC" id="P7000497027000000000000000045DAC"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045DAD" epub:type="title" id="P7000497027000000000000000045DAD"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.31 </span>How the loader maps the areas of the user address space.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P70004970270000000000000000260FC" id="P70004970270000000000000000260FC">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DAE" id="P7000497027000000000000000045DAE">A diagram of a stack has the following areas, listed from bottom to top:</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045DAF" id="P7000497027000000000000000045DAF">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DB0" id="P7000497027000000000000000045DB0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DB1" id="P7000497027000000000000000045DB1">Gap from 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DB2" id="P7000497027000000000000000045DB2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DB3" id="P7000497027000000000000000045DB3">Code (.text) and Initialized data (.data); together part of a.out and private, file-backed</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DB4" id="P7000497027000000000000000045DB4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DB5" id="P7000497027000000000000000045DB5">Uninitialized data (.bss) (private, demand-zero)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DB6" id="P7000497027000000000000000045DB6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DB7" id="P7000497027000000000000000045DB7">Run-time heap (via malloc) (private, demand-zero)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DB8" id="P7000497027000000000000000045DB8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DB9" id="P7000497027000000000000000045DB9">Gap</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DBA" id="P7000497027000000000000000045DBA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DBB" id="P7000497027000000000000000045DBB">Memory-mapped region for shared libraries (libc.so containing .data and .text; shared, file-backed)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DBC" id="P7000497027000000000000000045DBC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DBD" id="P7000497027000000000000000045DBD">Gap</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DBE" id="P7000497027000000000000000045DBE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DBF" id="P7000497027000000000000000045DBF">User stack (private, demand-zero).</p></li>
</ul>
</details>
</figcaption>
</figure>
<ol class="pcalibre1 calibre19 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DC0" id="P7000497027000000000000000045DC0">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DC1" id="P7000497027000000000000000045DC1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DC2" id="P7000497027000000000000000045DC2"><span class="pcalibre1 pcalibre2 pcalibre41">Delete existing user areas. </span>Delete the existing area structs in the user portion of the current process's virtual address.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DC3" id="P7000497027000000000000000045DC3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DC4" id="P7000497027000000000000000045DC4"><span class="pcalibre1 pcalibre2 pcalibre41">Map private areas. </span>Create new area structs for the code, data, bss, and stack areas of the new program. All of these new areas are private copy-on-write. The code and data areas are mapped to the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DC5" id="P7000497027000000000000000045DC5">.text</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DC6" id="P7000497027000000000000000045DC6">.data</code> sections of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DC7" id="P7000497027000000000000000045DC7">a.out</code> file. The bss area is demand-zero, mapped to an anonymous file whose size is contained in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DC8" id="P7000497027000000000000000045DC8">a.out</code>. The stack and heap area are also demand-zero, initially of zero length. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000072EF"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.31</span></a> summarizes the different mappings of the private areas.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DC9" id="P7000497027000000000000000045DC9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DCA" id="P7000497027000000000000000045DCA"><span class="pcalibre1 pcalibre2 pcalibre41">Map shared areas. </span>If the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DCB" id="P7000497027000000000000000045DCB">a.out</code> program was linked with shared objects, such as the standard C library <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DCC" id="P7000497027000000000000000045DCC">libc.so</code>, then these objects are dynamically linked into the program, and then mapped into the shared region of the user's virtual address space.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DCD" id="P7000497027000000000000000045DCD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DCE" id="P7000497027000000000000000045DCE"><span class="pcalibre1 pcalibre2 pcalibre41">Set the program counter (PC). </span>The last thing that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DCF" id="P7000497027000000000000000045DCF">execve</code> does is to set the program counter in the current process's context to point to the entry point in the code area.</p></li>
</ol>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DD0" id="P7000497027000000000000000045DD0">The next time this process is scheduled, it will begin execution from the entry point. Linux will swap in code and data pages as needed.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007305" id="P7000497027000000000000000007305"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DD1" epub:type="title" id="P7000497027000000000000000045DD1"><span class="pcalibre1 pcalibre21 pcalibre2">9.8.4 </span>User-Level Memory Mapping with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DD2" id="P7000497027000000000000000045DD2">mmap</code> Function</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DD3" id="P7000497027000000000000000045DD3">Linux processes can use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DD4" id="P7000497027000000000000000045DD4">mmap</code> function to create new areas of virtual memory and to map objects into these areas.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000730A" id="P700049702700000000000000000730A">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000730B" epub:type="pagebreak" id="P700049702700000000000000000730B" title="838"></span>
<img alt="A diagram shows a mapping of a section between the following: disk file specified by file descriptor fd, with length (bytes) beginning at offset (bytes); process virtual memory with length (bytes) beginning at start (or address chosen by the kernel), higher than offset." class="pcalibre280 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B79B" id="P7000497027000000000000000045DD5" src="Images/chapter-08-image-35.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045DD6" id="P7000497027000000000000000045DD6"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045DD7" epub:type="title" id="P7000497027000000000000000045DD7"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.32 </span>Visual interpretation of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DD8" id="P7000497027000000000000000045DD8">mmap</code> arguments.</h1></header></figcaption>
</figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DD9" id="P7000497027000000000000000045DD9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DDA" id="P7000497027000000000000000045DDA">
#include &lt;unistd.h&gt;
#include &lt;sys/mman.h&gt;

void *mmap(void *start, size_t length, int prot, int flags,
			 int fd, off_t offset);
				Returns: pointer to mapped area if OK, MAP_FAILED (–1) on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DDB" id="P7000497027000000000000000045DDB">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DDC" id="P7000497027000000000000000045DDC">mmap</code> function asks the kernel to create a new virtual memory area, preferably one that starts at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DDD" id="P7000497027000000000000000045DDD">start</code>, and to map a contiguous chunk of the object specified by file descriptor <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DDE" id="P7000497027000000000000000045DDE">fd</code> to the new area. The contiguous object chunk has a size of length bytes and starts at an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DDF" id="P7000497027000000000000000045DDF">offset</code> of offset bytes from the beginning of the file. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DE0" id="P7000497027000000000000000045DE0">start</code> address is merely a hint, and is usually specified as NULL. For our purposes, we will always assume a NULL start address. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000730A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.32</span></a> depicts the meaning of these arguments.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DE1" id="P7000497027000000000000000045DE1">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DE2" id="P7000497027000000000000000045DE2">prot</code> argument contains bits that describe the access permissions of the newly mapped virtual memory area (i.e., the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DE3" id="P7000497027000000000000000045DE3">vm_prot</code> bits in the corresponding area struct).</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DE4" id="P7000497027000000000000000045DE4">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DE5" id="P7000497027000000000000000045DE5"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045DE6" id="P7000497027000000000000000045DE6"><span class="pcalibre1 pcalibre2 pcalibre41">PROT_EXEC. </span>Pages in the area consist of instructions that may be executed by the CPU.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DE7" id="P7000497027000000000000000045DE7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045DE8" id="P7000497027000000000000000045DE8"><span class="pcalibre1 pcalibre2 pcalibre41">PROT_READ. </span>Pages in the area may be read.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DE9" id="P7000497027000000000000000045DE9"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045DEA" id="P7000497027000000000000000045DEA"><span class="pcalibre1 pcalibre2 pcalibre41">PROT_WRITE. </span>Pages in the area may be written.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DEB" id="P7000497027000000000000000045DEB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045DEC" id="P7000497027000000000000000045DEC"><span class="pcalibre1 pcalibre2 pcalibre41">PROT_NONE. </span>Pages in the area cannot be accessed.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DED" id="P7000497027000000000000000045DED">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DEE" id="P7000497027000000000000000045DEE">flags</code> argument consists of bits that describe the type of the mapped object. If the MAP_ANON flag bit is set, then the backing store is an anonymous object and the corresponding virtual pages are demand-zero. MAP_PRIVATE indicates a private copy-on-write object, and MAP_SHARED indicates a shared object. For example,</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DEF" id="P7000497027000000000000000045DEF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DF0" id="P7000497027000000000000000045DF0">
bufp = Mmap(NULL, size, PROT_READ, MAP_PRIVATEIMAP_ANON, 0, 0);
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DF1" id="P7000497027000000000000000045DF1"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007329" epub:type="pagebreak" id="P7000497027000000000000000007329" title="839"></span>asks the kernel to create a new read-only, private, demand-zero area of virtual memory containing size bytes. If the call is successful, then <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DF2" id="P7000497027000000000000000045DF2">bufp</code> contains the address of the new area.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DF3" id="P7000497027000000000000000045DF3">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DF4" id="P7000497027000000000000000045DF4">munmap</code> function deletes regions of virtual memory:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045DF5" id="P7000497027000000000000000045DF5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DF6" id="P7000497027000000000000000045DF6">
#include &lt;unistd.h&gt;
#include &lt;sys/mman.h&gt;

int munmap(void *start, size_t length);
											Returns: 0 if OK, –1 on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DF7" id="P7000497027000000000000000045DF7">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DF8" id="P7000497027000000000000000045DF8">munmap</code> function deletes the area starting at virtual address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DF9" id="P7000497027000000000000000045DF9">start</code> and consisting of the next <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DFA" id="P7000497027000000000000000045DFA">length</code> bytes. Subsequent references to the deleted region result in segmentation faults.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007333" epub:type="practice" id="P7000497027000000000000000007333"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045DFB" epub:type="title" id="P7000497027000000000000000045DFB"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.5 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000777C.xhtml#P70004970270000000000000000077D5">882</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000045DFC" id="P7000497027000000000000000045DFC">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000045DFD" id="P7000497027000000000000000045DFD">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045DFE" id="P7000497027000000000000000045DFE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045DFF" id="P7000497027000000000000000045DFF">Write a C program <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E00" id="P7000497027000000000000000045E00">mmapcopy.c</code> that uses <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E01" id="P7000497027000000000000000045E01">mmap</code> to copy an arbitrary-size disk file to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E02" id="P7000497027000000000000000045E02">stdout</code>. The name of the input file should be passed as a command-line argument.</p></div></li></ol>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.9 Dynamic Memory Allocation</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P700049702700000000000000000733C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045E03" epub:type="title" id="P7000497027000000000000000045E03"><span class="pcalibre1 pcalibre21 pcalibre2">9.9 </span>Dynamic Memory Allocation</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E04" id="P7000497027000000000000000045E04">While it is certainly possible to use the low-level <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E05" id="P7000497027000000000000000045E05">mmap</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E06" id="P7000497027000000000000000045E06">munmap</code> functions to create and delete areas of virtual memory, C programmers typically find it more convenient and more portable to use a <i class="pcalibre17 pcalibre2 pcalibre1">dynamic memory allocator</i> when they need to acquire additional virtual memory at run time.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E07" id="P7000497027000000000000000045E07">A dynamic memory allocator maintains an area of a process's virtual memory known as the <i class="pcalibre17 pcalibre2 pcalibre1">heap</i> (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000734A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.33</span></a>). Details vary from system to system, but without loss of generality, we will assume that the heap is an area of demand-zero memory that begins immediately after the uninitialized data area and grows upward (toward higher addresses). For each process, the kernel maintains a variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E08" id="P7000497027000000000000000045E08">brk</code> (pronounced "break") that points to the top of the heap.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E09" id="P7000497027000000000000000045E09">An allocator maintains the heap as a collection of various-size <i class="pcalibre17 pcalibre2 pcalibre1">blocks.</i> Each block is a contiguous chunk of virtual memory that is either <i class="pcalibre17 pcalibre2 pcalibre1">allocated</i> or <i class="pcalibre17 pcalibre2 pcalibre1">free.</i> An allocated block has been explicitly reserved for use by the application. A free block is available to be allocated. A free block remains free until it is explicitly allocated by the application. An allocated block remains allocated until it is freed, either explicitly by the application or implicitly by the memory allocator itself.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E0A" id="P7000497027000000000000000045E0A">Allocators come in two basic styles. Both styles require the application to explicitly allocate blocks. They differ about which entity is responsible for freeing allocated blocks.</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E0B" id="P7000497027000000000000000045E0B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E0C" id="P7000497027000000000000000045E0C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E0D" id="P7000497027000000000000000045E0D"><span class="pcalibre1 pcalibre2 pcalibre41">Explicit allocators </span>require the application to explicitly free any allocated blocks. For example, the C standard library provides an explicit allocator called the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E0E" id="P7000497027000000000000000045E0E">malloc</code> package. C programs allocate a block by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E0F" id="P7000497027000000000000000045E0F">malloc</code></p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000734A" id="P700049702700000000000000000734A">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000734B" epub:type="pagebreak" id="P700049702700000000000000000734B" title="840"></span>
<img alt="A diagram illustrates areas in the heap." class="pcalibre1 pcalibre2 calibre77" data-uri="P700049702700000000000000000B79C" id="P7000497027000000000000000045E10" src="Images/chapter-08-image-36.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045E11" id="P7000497027000000000000000045E11"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045E12" epub:type="title" id="P7000497027000000000000000045E12"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.33 </span>The heap.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000026162" id="P7000497027000000000000000026162">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E13" id="P7000497027000000000000000045E13">A diagram of a stack has the following areas, listed from bottom to top:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045E14" id="P7000497027000000000000000045E14">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E15" id="P7000497027000000000000000045E15"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E16" id="P7000497027000000000000000045E16">Gap from 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E17" id="P7000497027000000000000000045E17"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E18" id="P7000497027000000000000000045E18">Code (.text)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E19" id="P7000497027000000000000000045E19"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E1A" id="P7000497027000000000000000045E1A">Initialized data (.data)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E1B" id="P7000497027000000000000000045E1B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E1C" id="P7000497027000000000000000045E1C">Uninitialized data (.bss)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E1D" id="P7000497027000000000000000045E1D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E1E" id="P7000497027000000000000000045E1E">Heap (growing upward from top of the heap (brk ptr)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E1F" id="P7000497027000000000000000045E1F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E20" id="P7000497027000000000000000045E20">Gap</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E21" id="P7000497027000000000000000045E21"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E22" id="P7000497027000000000000000045E22">Memory-mapped region for shared libraries</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E23" id="P7000497027000000000000000045E23"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E24" id="P7000497027000000000000000045E24">Gap</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E25" id="P7000497027000000000000000045E25"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E26" id="P7000497027000000000000000045E26">User stack</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E27" id="P7000497027000000000000000045E27">function, and free a block by calling the free function. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E28" id="P7000497027000000000000000045E28">new</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E29" id="P7000497027000000000000000045E29">delete</code> calls in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E2A" id="P7000497027000000000000000045E2A">C++</code> are comparable.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E2B" id="P7000497027000000000000000045E2B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E2C" id="P7000497027000000000000000045E2C"><span class="pcalibre1 pcalibre2 pcalibre41">Implicit allocators, </span>on the other hand, require the allocator to detect when an allocated block is no longer being used by the program and then free the block. Implicit allocators are also known as <i class="pcalibre17 pcalibre2 pcalibre1">garbage collectors</i>, and the process of automatically freeing unused allocated blocks is known as <i class="pcalibre17 pcalibre2 pcalibre1">garbage collection.</i> For example, higher-level languages such as Lisp, ML, and Java rely on garbage collection to free allocated blocks.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E2D" id="P7000497027000000000000000045E2D">The remainder of this section discusses the design and implementation of explicit allocators. We will discuss implicit allocators in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007565.xhtml#P7000497027000000000000000007565"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.10</span></a>. For concrete -ness, our discussion focuses on allocators that manage heap memory. However, you should be aware that memory allocation is a general idea that arises in a variety of contexts. For example, applications that do intensive manipulation of graphs will often use the standard allocator to acquire a large block of virtual memory and then use an application-specific allocator to manage the memory within that block as the nodes of the graph are created and destroyed.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007356" id="P7000497027000000000000000007356"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E2E" epub:type="title" id="P7000497027000000000000000045E2E"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.1 </span>The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E2F" id="P7000497027000000000000000045E2F">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E30" id="P7000497027000000000000000045E30">free</code> Functions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E31" id="P7000497027000000000000000045E31">The C standard library provides an explicit allocator known as the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E32" id="P7000497027000000000000000045E32">malloc</code> package. Programs allocate blocks from the heap by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E33" id="P7000497027000000000000000045E33">malloc</code> function.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E34" id="P7000497027000000000000000045E34"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E35" id="P7000497027000000000000000045E35">
#include &lt;stdlib.h&gt;

void *malloc(size_t size);
			Returns: pointer to allocated block if OK, NULL on error
</code></pre>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000000735F" id="P700049702700000000000000000735F"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter09.xhtml#P7000497027000000000000000045E36" epub:type="title" id="P7000497027000000000000000045E36"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007361" epub:type="pagebreak" id="P7000497027000000000000000007361" title="841"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>How big is a word?</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E37" id="P7000497027000000000000000045E37">Recall from our discussion of machine code in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001DCE.xhtml#P7000497027000000000000000001DCE"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">3</span></a> that Intel refers to 4-byte objects as <i class="pcalibre17 pcalibre2 pcalibre1">double words.</i> However, throughout this section, we will assume that <i class="pcalibre17 pcalibre2 pcalibre1">words</i> are 4-byte objects and that <i class="pcalibre17 pcalibre2 pcalibre1">double words</i> are 8-byte objects, which is consistent with conventional terminology.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E38" id="P7000497027000000000000000045E38">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E39" id="P7000497027000000000000000045E39">malloc</code> function returns a pointer to a block of memory of at least size bytes that is suitably aligned for any kind of data object that might be contained in the block. In practice, the alignment depends on whether the code is compiled to run in 32-bit mode (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E3A" id="P7000497027000000000000000045E3A">gcc –m32</code>) or 64-bit mode (the default). In 32-bit mode, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E3B" id="P7000497027000000000000000045E3B">malloc</code> returns a block whose address is always a multiple of 8. In 64-bit mode, the address is always a multiple of 16.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E3C" id="P7000497027000000000000000045E3C">If <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E3D" id="P7000497027000000000000000045E3D">malloc</code> encounters a problem (e.g., the program requests a block of memory that is larger than the available virtual memory), then it returns NULL and sets <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E3E" id="P7000497027000000000000000045E3E">errno</code>. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E3F" id="P7000497027000000000000000045E3F">Malloc</code> does not initialize the memory it returns. Applications that want initialized dynamic memory can use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E40" id="P7000497027000000000000000045E40">calloc</code>, a thin wrapper around the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E41" id="P7000497027000000000000000045E41">malloc</code> function that initializes the allocated memory to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E42" id="P7000497027000000000000000045E42">zero</code>. Applications that want to change the size of a previously allocated block can use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E43" id="P7000497027000000000000000045E43">realloc</code> function.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E44" id="P7000497027000000000000000045E44">Dynamic memory allocators such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E45" id="P7000497027000000000000000045E45">malloc</code> can allocate or deallocate heap memory explicitly by using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E46" id="P7000497027000000000000000045E46">mmap</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E47" id="P7000497027000000000000000045E47">munmap</code> functions, or they can use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E48" id="P7000497027000000000000000045E48">sbrk</code> function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E49" id="P7000497027000000000000000045E49"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E4A" id="P7000497027000000000000000045E4A">
#include &lt;unistd.h&gt;

void *sbrk(intptr_t incr);
				Returns: old brk pointer on success, –1 on error
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E4B" id="P7000497027000000000000000045E4B">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E4C" id="P7000497027000000000000000045E4C">sbrk</code> function grows or shrinks the heap by adding <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E4D" id="P7000497027000000000000000045E4D">incr</code> to the kernel's <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E4E" id="P7000497027000000000000000045E4E">brk</code> pointer. If successful, it returns the old value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E4F" id="P7000497027000000000000000045E4F">brk</code>, otherwise it returns –1 and sets <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E50" id="P7000497027000000000000000045E50">errno</code> to ENOMEM. If <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E51" id="P7000497027000000000000000045E51">incr</code> is zero, then <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E52" id="P7000497027000000000000000045E52">sbrk</code> returns the current value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E53" id="P7000497027000000000000000045E53">brk</code>. Calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E54" id="P7000497027000000000000000045E54">sbrk</code> with a negative <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E55" id="P7000497027000000000000000045E55">incr</code> is legal but tricky because the return value (the old value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E56" id="P7000497027000000000000000045E56">brk</code>) points to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E57" id="P7000497027000000000000000045E57">abs (incr)</code> bytes past the new top of the heap.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E58" id="P7000497027000000000000000045E58">Programs free allocated heap blocks by calling the free function.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E59" id="P7000497027000000000000000045E59"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E5A" id="P7000497027000000000000000045E5A">
#include &lt;stdlib.h&gt;

void free(void *ptr);

					Returns: nothing
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E5B" id="P7000497027000000000000000045E5B">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E5C" id="P7000497027000000000000000045E5C">ptr</code> argument must point to the beginning of an allocated block that was obtained from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E5D" id="P7000497027000000000000000045E5D">malloc, calloc</code>, or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E5E" id="P7000497027000000000000000045E5E">realloc</code>. If not, then the behavior of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E5F" id="P7000497027000000000000000045E5F">free</code> is undefined. Even worse, since it returns nothing, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E60" id="P7000497027000000000000000045E60">free</code> gives no indication to the application that something is wrong. As we shall see in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000075E8.xhtml#P70004970270000000000000000075E8"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.11</span></a>, this can produce some baffling run-time errors.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000738C" id="P700049702700000000000000000738C">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000738D" epub:type="pagebreak" id="P700049702700000000000000000738D" title="842"></span>
<img alt="Diagrams illustrate allocating and freeing block with malloc and free." class="calibre78 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B79D" id="P7000497027000000000000000045E61" src="Images/chapter-08-image-37.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045E62" id="P7000497027000000000000000045E62"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045E63" epub:type="title" id="P7000497027000000000000000045E63"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34 </span>Allocating and freeing blocks with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E64" id="P7000497027000000000000000045E64">malloc</code> <b class="pcalibre1 pcalibre2 pcalibre12">and</b> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E65" id="P7000497027000000000000000045E65">free</code>.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045E66" id="P7000497027000000000000000045E66"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E67" id="P7000497027000000000000000045E67">Each square corresponds to a word. Each heavy rectangle corresponds to a block. Allocated blocks are shaded. Padded regions of allocated blocks are shaded with a darker blue. Free blocks are unshaded. Heap addresses increase from left to right.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P70004970270000000000000000261B8" id="P70004970270000000000000000261B8">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E68" id="P7000497027000000000000000045E68">Five diagrams each have a row of 18 squares, shaded and labeled as summarized below.</p>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter09.xhtml#P7000497027000000000000000045E69" id="P7000497027000000000000000045E69">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E6A" id="P7000497027000000000000000045E6A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E6B" id="P7000497027000000000000000045E6B">P1 = malloc(4*sizeof(int)): first four squareas shaded, beginning at p1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E6C" id="P7000497027000000000000000045E6C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E6D" id="P7000497027000000000000000045E6D">P2 = malloc(5*sizeof(int)): first four shaded from p1 and p2, with next five shaded light and sixth shaded dark</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E6E" id="P7000497027000000000000000045E6E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E6F" id="P7000497027000000000000000045E6F">P3 = malloc (6*sizeof(int)): first four shaded from p1 to p2; next 6 shaded (last one dark) from p2 to p3; next 6 shaded</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E70" id="P7000497027000000000000000045E70"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E71" id="P7000497027000000000000000045E71">Free(p2): first four shaded from p1 to p2; no shading for 6 between p2 and p3; 6 shaded from p3</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E72" id="P7000497027000000000000000045E72"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045E73" id="P7000497027000000000000000045E73">P4 = malloc (2*sizeof(int)): first four shaded from p1; next two shaded, with first labeled p2 and p4; next four not shaded; next six shaded from p3.</p></li>
</ol>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E74" id="P7000497027000000000000000045E74"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000738C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34</span></a> shows how an implementation of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E75" id="P7000497027000000000000000045E75">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E76" id="P7000497027000000000000000045E76">free</code> might manage a (very) small heap of 16 words for a C program. Each box represents a 4-byte word. The heavy-lined rectangles correspond to allocated blocks (shaded) and free blocks (unshaded). Initially, the heap consists of a single 16-word double-word-aligned free block.<a class="pcalibre1 pcalibre2 pcalibre56 pcalibre16 pcalibre14 pcalibre15" epub:type="noteref" href="#P7000497027000000000000000007861" id="r__P7000497027000000000000000007861"><sup class="pcalibre1 pcalibre2 calibre8">1</sup></a></p><aside class="pcalibre2 pcalibre32 pcalibre57" data-uri="chapter09.xhtml#P7000497027000000000000000007861" epub:type="footnote" id="P7000497027000000000000000007861"><p class="pcalibre1 pcalibre2 pcalibre10"><span class="pcalibre1 pcalibre58 pcalibre2"><a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="#r__P7000497027000000000000000007861">1. </a></span>Throughout this section, we will assume that the allocator returns blocks aligned to 8-byte double-word boundaries.</p></aside>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E77" id="P7000497027000000000000000045E77">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E78" id="P7000497027000000000000000045E78"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045E79" id="P7000497027000000000000000045E79"><span class="pcalibre1 pcalibre2 pcalibre41"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000738C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34(a)</span></a>. </span>The program asks for a four-word block. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E7A" id="P7000497027000000000000000045E7A">Malloc</code> responds by carving out a four-word block from the front of the free block and returning a pointer to the first word of the block.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E7B" id="P7000497027000000000000000045E7B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045E7C" id="P7000497027000000000000000045E7C"><span class="pcalibre1 pcalibre2 pcalibre41"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000738C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34(b)</span></a>. </span>The program requests a five-word block. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E7D" id="P7000497027000000000000000045E7D">Malloc</code> responds by allocating a six-word block from the front of the free block. In this example, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E7E" id="P7000497027000000000000000045E7E">malloc</code> pads the block with an extra word in order to keep the free block aligned on a double-word boundary.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E7F" id="P7000497027000000000000000045E7F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045E80" id="P7000497027000000000000000045E80"><span class="pcalibre1 pcalibre2 pcalibre41"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000738C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34(c)</span></a>. </span>The program requests a six-word block and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E81" id="P7000497027000000000000000045E81">malloc</code> responds by carving out a six-word block from the free block.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E82" id="P7000497027000000000000000045E82"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045E83" id="P7000497027000000000000000045E83"><span class="pcalibre1 pcalibre2 pcalibre41"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000738C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34(d)</span></a>. </span>The program frees the six-word block that was allocated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000738C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34(b)</span></a>. Notice that after the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E84" id="P7000497027000000000000000045E84">free</code> returns, the pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E85" id="P7000497027000000000000000045E85">p2</code> <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000073A7" epub:type="pagebreak" id="P70004970270000000000000000073A7" title="843"></span>still points to the freed block. It is the responsibility of the application not to use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E86" id="P7000497027000000000000000045E86">p2</code> again until it is reinitialized by a new call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E87" id="P7000497027000000000000000045E87">malloc</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E88" id="P7000497027000000000000000045E88"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045E89" id="P7000497027000000000000000045E89"><span class="pcalibre1 pcalibre2 pcalibre41"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000738C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34(e)</span></a>. </span>The program requests a two-word block. In this case, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E8A" id="P7000497027000000000000000045E8A">malloc</code> allocates a portion of the block that was freed in the previous step and returns a pointer to this new block.</p></li>
</ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000073AD" id="P70004970270000000000000000073AD"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E8B" epub:type="title" id="P7000497027000000000000000045E8B"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.2 </span>Why Dynamic Memory Allocation?</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E8C" id="P7000497027000000000000000045E8C">The most important reason that programs use dynamic memory allocation is that often they do not know the sizes of certain data structures until the program actually runs. For example, suppose we are asked to write a C program that reads a list of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> ASCII integers, one integer per line, from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E8D" id="P7000497027000000000000000045E8D">stdin</code> into a C array. The input consists of the integer <var class="pcalibre17 pcalibre2 pcalibre1">n</var>, followed by the <var class="pcalibre17 pcalibre2 pcalibre1">n</var> integers to be read and stored into the array. The simplest approach is to define the array statically with some hard-coded maximum array size:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E8E" id="P7000497027000000000000000045E8E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E8F" id="P7000497027000000000000000045E8F">
1	#include "csapp.h"
2	#define MAXN 15213
3	
4	int array [MAXN];
5	
6	int main()
7	{
8		int i, n;
9	
10		scanf(%d", &amp;n);
11		if (n &gt; MAXN)
12			app_error("Input file too big");
13		for (i = 0; i &lt; n; i++)
14			scanf (%d", &amp;array[i]);
15		exit(0);
16	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E90" id="P7000497027000000000000000045E90">Allocating arrays with hard-coded sizes like this is often a bad idea. The value of MAXN is arbitrary and has no relation to the actual amount of available virtual memory on the machine. Further, if the user of this program wanted to read a file that was larger than MAXN, the only recourse would be to recompile the program with a larger value of MAXN. While not a problem for this simple example, the presence of hard-coded array bounds can become a maintenance nightmare for large software products with millions of lines of code and numerous users.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E91" id="P7000497027000000000000000045E91">A better approach is to allocate the array dynamically, at run time, after the value of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> becomes known. With this approach, the maximum size of the array is limited only by the amount of available virtual memory.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E92" id="P7000497027000000000000000045E92"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E93" id="P7000497027000000000000000045E93">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000073B7" epub:type="pagebreak" id="P70004970270000000000000000073B7" title="844"></span>1	#include "csapp.h"
2	
3	int main()
4	{
5		int *array, i, n;
6	
7		scanf ("%d", &amp;n);
8		array = (int *)Malloc(n * sizeof(int));
9		for (i = 0; i &lt; n; i++)
10			scanf ("%d", &amp;array[i]);
11		free(array);
12		exit(0);
13	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E94" id="P7000497027000000000000000045E94">Dynamic memory allocation is a useful and important programming technique. However, in order to use allocators correctly and efficiently, programmers need to have an understanding of how they work. We will discuss some of the gruesome errors that can result from the improper use of allocators in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000075E8.xhtml#P70004970270000000000000000075E8"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.11</span></a>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000073B9" id="P70004970270000000000000000073B9"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E95" epub:type="title" id="P7000497027000000000000000045E95"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.3 </span>Allocator Requirements and Goals</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E96" id="P7000497027000000000000000045E96">Explicit allocators must operate within some rather stringent constraints:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045E97" id="P7000497027000000000000000045E97">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E98" id="P7000497027000000000000000045E98"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045E99" id="P7000497027000000000000000045E99"><span class="pcalibre1 pcalibre2 pcalibre41">Handling arbitrary request sequences. </span>An application can make an arbitrary sequence of allocate and free requests, subject to the constraint that each free request must correspond to a currently allocated block obtained from a previous allocate request. Thus, the allocator cannot make any assumptions about the ordering of allocate and free requests. For example, the allocator cannot assume that all allocate requests are accompanied by a matching free request, or that matching allocate and free requests are nested.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E9A" id="P7000497027000000000000000045E9A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045E9B" id="P7000497027000000000000000045E9B"><span class="pcalibre1 pcalibre2 pcalibre41">Making immediate responses to requests. </span>The allocator must respond immediately to allocate requests. Thus, the allocator is not allowed to reorder or buffer requests in order to improve performance.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E9C" id="P7000497027000000000000000045E9C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045E9D" id="P7000497027000000000000000045E9D"><span class="pcalibre1 pcalibre2 pcalibre41">Using only the heap. </span>In order for the allocator to be scalable, any nonscalar data structures used by the allocator must be stored in the heap itself.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045E9E" id="P7000497027000000000000000045E9E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045E9F" id="P7000497027000000000000000045E9F"><span class="pcalibre1 pcalibre2 pcalibre41">Aligning blocks (alignment requirement). </span>The allocator must align blocks in such a way that they can hold any type of data object.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EA0" id="P7000497027000000000000000045EA0"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045EA1" id="P7000497027000000000000000045EA1"><span class="pcalibre1 pcalibre2 pcalibre41">Not modifying allocated blocks. </span>Allocators can only manipulate or change free blocks. In particular, they are not allowed to modify or move blocks once they are allocated. Thus, techniques such as compaction of allocated blocks are not permitted.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EA2" id="P7000497027000000000000000045EA2"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000073C8" epub:type="pagebreak" id="P70004970270000000000000000073C8" title="845"></span>Working within these constraints, the author of an allocator attempts to meet the often conflicting performance goals of maximizing throughput and memory utilization.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EA3" id="P7000497027000000000000000045EA3"><span class="pcalibre1 pcalibre2 pcalibre41">Goal 1: Maximizing throughput.</span> Given some sequence of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> allocate and free requests</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000045EA4" id="P7000497027000000000000000045EA4"><m:math altimg="../images/ch09-eq6.png" altimg-height="19" altimg-width="228" alttext="" data-uri="" display="block"><m:mrow><m:msub><m:mi>R</m:mi><m:mn>0</m:mn></m:msub><m:mo>,</m:mo><m:mtext> </m:mtext><m:msub><m:mi>R</m:mi><m:mn>1</m:mn></m:msub><m:mo>,</m:mo><m:mo>…</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:msub><m:mi>R</m:mi><m:mi>k</m:mi></m:msub><m:mo>,</m:mo><m:mo>…</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:msub><m:mi>R</m:mi><m:mrow><m:mi>n</m:mi><m:mo>−</m:mo><m:mn>1</m:mn></m:mrow></m:msub></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EA5" id="P7000497027000000000000000045EA5">we would like to maximize an allocator's <i class="pcalibre17 pcalibre2 pcalibre1">throughput</i>, which is defined as the number of requests that it completes per unit time. For example, if an allocator completes 500 allocate requests and 500 free requests in 1 second, then its throughput is 1,000 operations per second. In general, we can maximize throughput by minimizing the average time to satisfy allocate and free requests. As we'll see, it is not too difficult to develop allocators with reasonably good performance where the worst-case running time of an allocate request is linear in the number of free blocks and the running time of a free request is constant.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EA6" id="P7000497027000000000000000045EA6"><span class="pcalibre1 pcalibre2 pcalibre41">Goal 2: Maximizing memory utilization.</span> Naive programmers often incorrectly assume that virtual memory is an unlimited resource. In fact, the total amount of virtual memory allocated by all of the processes in a system is limited by the amount of swap space on disk. Good programmers know that virtual memory is a finite resource that must be used efficiently. This is especially true for a dynamic memory allocator that might be asked to allocate and free large blocks of memory.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EA7" id="P7000497027000000000000000045EA7">There are a number of ways to characterize how efficiently an allocator uses the heap. In our experience, the most useful metric is <i class="pcalibre17 pcalibre2 pcalibre1">peak utilization.</i> As before, we are given some sequence of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> allocate and free requests</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000045EA8" id="P7000497027000000000000000045EA8"><m:math altimg="../images/ch09-eq7.png" altimg-height="19" altimg-width="228" alttext="" data-uri="" display="block"><m:mrow><m:msub><m:mi>R</m:mi><m:mn>0</m:mn></m:msub><m:mo>,</m:mo><m:mtext> </m:mtext><m:msub><m:mi>R</m:mi><m:mn>1</m:mn></m:msub><m:mo>,</m:mo><m:mo>…</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:msub><m:mi>R</m:mi><m:mi>k</m:mi></m:msub><m:mo>,</m:mo><m:mo>…</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:msub><m:mi>R</m:mi><m:mrow><m:mi>n</m:mi><m:mo>−</m:mo><m:mn>1</m:mn></m:mrow></m:msub></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EA9" id="P7000497027000000000000000045EA9">If an application requests a block of <var class="pcalibre17 pcalibre2 pcalibre1">p</var> bytes, then the resulting allocated block has a <i class="pcalibre17 pcalibre2 pcalibre1">payload</i> of <var class="pcalibre17 pcalibre2 pcalibre1">p</var> bytes. After request <i class="pcalibre17 pcalibre2 pcalibre1">R<sub class="pcalibre1 pcalibre2 calibre14">k</sub></i> has completed, let the <i class="pcalibre17 pcalibre2 pcalibre1">aggregate payload</i>, denoted <i class="pcalibre17 pcalibre2 pcalibre1">P<sub class="pcalibre1 pcalibre2 calibre14">k</sub></i>, be the sum of the pay loads of the currently allocated blocks, and let <i class="pcalibre17 pcalibre2 pcalibre1">H<sub class="pcalibre1 pcalibre2 calibre14">k</sub></i> denote the current (monotonically nondecreasing) size of the heap.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EAA" id="P7000497027000000000000000045EAA">Then the peak utilization over the first <var class="pcalibre17 pcalibre2 pcalibre1">k</var> + 1 requests, denoted by <i class="pcalibre17 pcalibre2 pcalibre1">U<sub class="pcalibre1 pcalibre2 calibre14">k</sub></i>, is given by</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000045EAB" id="P7000497027000000000000000045EAB"><m:math altimg="../images/ch09-eq8.png" altimg-height="51" altimg-width="139" alttext="" data-uri="" display="block"><m:mrow><m:msub><m:mi>U</m:mi><m:mi>k</m:mi></m:msub><m:mo>=</m:mo><m:mfrac><m:mrow><m:msub><m:mrow><m:mi>max</m:mi></m:mrow><m:mrow><m:mi>i</m:mi><m:mo>≤</m:mo><m:mi>k</m:mi></m:mrow></m:msub><m:mtext> </m:mtext><m:msub><m:mi>P</m:mi><m:mi>i</m:mi></m:msub></m:mrow><m:mrow><m:msub><m:mi>H</m:mi><m:mi>k</m:mi></m:msub></m:mrow></m:mfrac></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EAC" id="P7000497027000000000000000045EAC">The objective of the allocator, then, is to maximize the peak utilization <var class="pcalibre17 pcalibre2 pcalibre1">U</var><sub class="pcalibre1 pcalibre2 calibre14"><var class="pcalibre17 pcalibre2 pcalibre1">n</var>–1</sub> over the entire sequence. As we will see, there is a tension between maximizing throughput and utilization. In particular, it is easy to write an allocator that maximizes throughput at the expense of heap utilization. One of the interesting challenges in any allocator design is finding an appropriate balance between the two goals.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000073D3" id="P70004970270000000000000000073D3"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter09.xhtml#P7000497027000000000000000045EAD" epub:type="title" id="P7000497027000000000000000045EAD"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000073D5" epub:type="pagebreak" id="P70004970270000000000000000073D5" title="846"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Relaxing the monotonicity assumption</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045EAE" id="P7000497027000000000000000045EAE">We could relax the monotonically nondecreasing assumption in our definition of <i class="pcalibre17 pcalibre2 pcalibre1">U<sub class="pcalibre1 pcalibre2 calibre14">k</sub></i> and allow the heap to grow up and down by letting <i class="pcalibre17 pcalibre2 pcalibre1">H<sub class="pcalibre1 pcalibre2 calibre14">k</sub></i> be the high-water mark over the first <var class="pcalibre17 pcalibre2 pcalibre1">k</var> + 1 requests.</p>
</aside>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000073D7" id="P70004970270000000000000000073D7"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EAF" epub:type="title" id="P7000497027000000000000000045EAF"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.4 </span>Fragmentation</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB0" id="P7000497027000000000000000045EB0">The primary cause of poor heap utilization is a phenomenon known as <i class="pcalibre17 pcalibre2 pcalibre1">fragmentation</i>, which occurs when otherwise unused memory is not available to satisfy allocate requests. There are two forms of fragmentation: <i class="pcalibre17 pcalibre2 pcalibre1">internal fragmentation</i> and <i class="pcalibre17 pcalibre2 pcalibre1">external fragmentation.</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB1" id="P7000497027000000000000000045EB1"><i class="pcalibre17 pcalibre2 pcalibre1">Internal fragmentation</i> occurs when an allocated block is larger than the pay-load. This might happen for a number of reasons. For example, the implementation of an allocator might impose a minimum size on allocated blocks that is greater than some requested payload. Or, as we saw in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000738C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34(b)</span></a>, the allocator might increase the block size in order to satisfy alignment constraints.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB2" id="P7000497027000000000000000045EB2">Internal fragmentation is straightforward to quantify. It is simply the sum of the differences between the sizes of the allocated blocks and their payloads. Thus, at any point in time, the amount of internal fragmentation depends only on the pattern of previous requests and the allocator implementation.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB3" id="P7000497027000000000000000045EB3"><i class="pcalibre17 pcalibre2 pcalibre1">External fragmentation</i> occurs when there <i class="pcalibre17 pcalibre2 pcalibre1">is</i> enough aggregate free memory to satisfy an allocate request, but no single free block is large enough to handle the request. For example, if the request in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000738C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.34(e)</span></a> were for eight words rather than two words, then the request could not be satisfied without requesting additional virtual memory from the kernel, even though there are eight free words remaining in the heap. The problem arises because these eight words are spread over two free blocks.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB4" id="P7000497027000000000000000045EB4">External fragmentation is much more difficult to quantify than internal fragmentation because it depends not only on the pattern of previous requests and the allocator implementation but also on the pattern of <i class="pcalibre17 pcalibre2 pcalibre1">future</i> requests. For example, suppose that after <var class="pcalibre17 pcalibre2 pcalibre1">k</var> requests all of the free blocks are exactly four words in size. Does this heap suffer from external fragmentation? The answer depends on the pattern of future requests. If all of the future allocate requests are for blocks that are smaller than or equal to four words, then there is no external fragmentation. On the other hand, if one or more requests ask for blocks larger than four words, then the heap does suffer from external fragmentation.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB5" id="P7000497027000000000000000045EB5">Since external fragmentation is difficult to quantify and impossible to predict, allocators typically employ heuristics that attempt to maintain small numbers of larger free blocks rather than large numbers of smaller free blocks.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000073DF" id="P70004970270000000000000000073DF"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB6" epub:type="title" id="P7000497027000000000000000045EB6"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.5 </span>Implementation Issues</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB7" id="P7000497027000000000000000045EB7">The simplest imaginable allocator would organize the heap as a large array of bytes and a pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB8" id="P7000497027000000000000000045EB8">p</code> that initially points to the first byte of the array. To allocate <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000073E3" epub:type="pagebreak" id="P70004970270000000000000000073E3" title="847"></span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EB9" id="P7000497027000000000000000045EB9">size</code> bytes, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EBA" id="P7000497027000000000000000045EBA">malloc</code> would save the current value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EBB" id="P7000497027000000000000000045EBB">p</code> on the stack, increment <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EBC" id="P7000497027000000000000000045EBC">p</code> by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EBD" id="P7000497027000000000000000045EBD">size</code>, and return the old value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EBE" id="P7000497027000000000000000045EBE">p</code> to the caller. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EBF" id="P7000497027000000000000000045EBF">Free</code> would simply return to the caller without doing anything.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EC0" id="P7000497027000000000000000045EC0">This naive allocator is an extreme point in the design space. Since each <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EC1" id="P7000497027000000000000000045EC1">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EC2" id="P7000497027000000000000000045EC2">free</code> execute only a handful of instructions, throughput would be extremely good. However, since the allocator never reuses any blocks, memory utilization would be extremely bad. A practical allocator that strikes a better balance between throughput and utilization must consider the following issues:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EC3" id="P7000497027000000000000000045EC3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EC4" id="P7000497027000000000000000045EC4"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045EC5" id="P7000497027000000000000000045EC5"><span class="pcalibre1 pcalibre2 pcalibre41">Free block organization. </span>How do we keep track of free blocks?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EC6" id="P7000497027000000000000000045EC6"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045EC7" id="P7000497027000000000000000045EC7"><span class="pcalibre1 pcalibre2 pcalibre41">Placement. </span>How do we choose an appropriate free block in which to place a newly allocated block?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EC8" id="P7000497027000000000000000045EC8"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045EC9" id="P7000497027000000000000000045EC9"><span class="pcalibre1 pcalibre2 pcalibre41">Splitting. </span>After we place a newly allocated block in some free block, what do we do with the remainder of the free block?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045ECA" id="P7000497027000000000000000045ECA"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000045ECB" id="P7000497027000000000000000045ECB"><span class="pcalibre1 pcalibre2 pcalibre41">Coalescing. </span>What do we do with a block that has just been freed?</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045ECC" id="P7000497027000000000000000045ECC">The rest of this section looks at these issues in more detail. Since the basic techniques of placement, splitting, and coalescing cut across many different free block organizations, we will introduce them in the context of a simple free block organization known as an implicit free list.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000073F8" id="P70004970270000000000000000073F8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045ECD" epub:type="title" id="P7000497027000000000000000045ECD"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.6 </span>Implicit Free Lists</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045ECE" id="P7000497027000000000000000045ECE">Any practical allocator needs some data structure that allows it to distinguish block boundaries and to distinguish between allocated and free blocks. Most allocators embed this information in the blocks themselves. One simple approach is shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000073FC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.35</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045ECF" id="P7000497027000000000000000045ECF">In this case, a block consists of a one-word <i class="pcalibre17 pcalibre2 pcalibre1">header</i>, the payload, and possibly some additional <i class="pcalibre17 pcalibre2 pcalibre1">padding.</i> The header encodes the block size (including the header and any padding) as well as whether the block is allocated or free. If we impose a double-word alignment constraint, then the block size is always a multiple of 8 and the 3 low-order bits of the block size are always zero. Thus, we need to store only the 29 high-order bits of the block size, freeing the remaining 3 bits to encode other information. In this case, we are using the least significant of these bits</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000073FC" id="P70004970270000000000000000073FC">
<img alt="A diagram illustrates the format of a simple heap block." class="pcalibre281 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B79E" id="P7000497027000000000000000045ED0" src="Images/chapter-08-image-38.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045ED1" id="P7000497027000000000000000045ED1"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045ED2" epub:type="title" id="P7000497027000000000000000045ED2"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.35 </span>Format of a simple heap block.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000026224" id="P7000497027000000000000000026224">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045ED3" id="P7000497027000000000000000045ED3">A diagram has three sections, each from 31 to 0 bits, from top to bottom as follows:</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045ED4" id="P7000497027000000000000000045ED4">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045ED5" id="P7000497027000000000000000045ED5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045ED6" id="P7000497027000000000000000045ED6">Header: block size from bit 31 to 3, with 0 under bits 2 and 1 and a under bit 0 (a = 1: Allocated; a = 0: Free)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045ED7" id="P7000497027000000000000000045ED7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045ED8" id="P7000497027000000000000000045ED8">Payload (allocated block only); malloc returns a pointer to the beginning of the payload</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045ED9" id="P7000497027000000000000000045ED9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045EDA" id="P7000497027000000000000000045EDA">Padding (optional)</p></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007400" id="P7000497027000000000000000007400">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007401" epub:type="pagebreak" id="P7000497027000000000000000007401" title="848"></span>
<img alt="A diagram illustrates organizing the heap with an implicit free list." class="pcalibre1 pcalibre282 pcalibre2" data-uri="P700049702700000000000000000B79F" id="P7000497027000000000000000045EDB" src="Images/chapter-08-image-39.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045EDC" id="P7000497027000000000000000045EDC"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045EDD" epub:type="title" id="P7000497027000000000000000045EDD"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.36 </span>Organizing the heap with an implicit free list.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045EDE" id="P7000497027000000000000000045EDE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045EDF" id="P7000497027000000000000000045EDF">Allocated blocks are shaded. Free blocks are unshaded. Headers are labeled with (size (bytes)/allocated bit).</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000026232" id="P7000497027000000000000000026232">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EE0" id="P7000497027000000000000000045EE0">A diagram has a row of shaded and unshaded blocks, from start of heap on the left to double-word aligned on the right. Arrows jump between groups of shaded blocks. The blocks are summarized from left to right below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045EE1" id="P7000497027000000000000000045EE1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EE2" id="P7000497027000000000000000045EE2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045EE3" id="P7000497027000000000000000045EE3">Shaded, labeled unused</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EE4" id="P7000497027000000000000000045EE4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045EE5" id="P7000497027000000000000000045EE5">Two unshaded, first labeled 8/0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EE6" id="P7000497027000000000000000045EE6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045EE7" id="P7000497027000000000000000045EE7">Four shaded, the first labeled 16/1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EE8" id="P7000497027000000000000000045EE8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045EE9" id="P7000497027000000000000000045EE9">Eight unshaded, first labeled 32/0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EEA" id="P7000497027000000000000000045EEA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045EEB" id="P7000497027000000000000000045EEB">Five shaded, first labeled 16/1 and last labeled 0/1</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EEC" id="P7000497027000000000000000045EEC">(the <i class="pcalibre17 pcalibre2 pcalibre1">allocated bit)</i> to indicate whether the block is allocated or free. For example, suppose we have an allocated block with a block size of 24 (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EED" id="P7000497027000000000000000045EED">0x18</code>) bytes. Then its header would be</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EEE" id="P7000497027000000000000000045EEE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EEF" id="P7000497027000000000000000045EEF">
0x00000018 | 0x1 = 0x00000019
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EF0" id="P7000497027000000000000000045EF0">Similarly, a free block with a block size of 40 (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EF1" id="P7000497027000000000000000045EF1">0x28</code>) bytes would have a header of</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045EF2" id="P7000497027000000000000000045EF2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EF3" id="P7000497027000000000000000045EF3">
0x00000028 | 0x0 = 0x00000028
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EF4" id="P7000497027000000000000000045EF4">The header is followed by the payload that the application requested when it called <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EF5" id="P7000497027000000000000000045EF5">malloc</code>. The payload is followed by a chunk of unused padding that can be any size. There are a number of reasons for the padding. For example, the padding might be part of an allocator's strategy for combating external fragmentation. Or it might be needed to satisfy the alignment requirement.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EF6" id="P7000497027000000000000000045EF6">Given the block format in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000073FC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.35</span></a>, we can organize the heap as a sequence of contiguous allocated and free blocks, as shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007400"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.36</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EF7" id="P7000497027000000000000000045EF7">We call this organization an <i class="pcalibre17 pcalibre2 pcalibre1">implicit free list</i> because the free blocks are linked implicitly by the size fields in the headers. The allocator can indirectly traverse the entire set of free blocks by traversing <i class="pcalibre17 pcalibre2 pcalibre1">all</i> of the blocks in the heap. Notice that we need some kind of specially marked end block—in this example, a terminating header with the allocated bit set and a size of zero. (As we will see in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000748F"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9.12</span></a>, setting the allocated bit simplifies the coalescing of free blocks.)</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EF8" id="P7000497027000000000000000045EF8">The advantage of an implicit free list is simplicity. A significant disadvantage is that the cost of any operation that requires a search of the free list, such as placing allocated blocks, will be linear in the <i class="pcalibre17 pcalibre2 pcalibre1">total</i> number of allocated and free blocks in the heap.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EF9" id="P7000497027000000000000000045EF9">It is important to realize that the system's alignment requirement and the allocator's choice of block format impose a <i class="pcalibre17 pcalibre2 pcalibre1">minimum block size</i> on the allocator. No allocated or free block may be smaller than this minimum. For example, if we assume a double-word alignment requirement, then the size of each block must be a multiple of two words (8 bytes). Thus, the block format in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000073FC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.35</span></a> induces a minimum block size of two words: one word for the header and another to maintain the alignment requirement. Even if the application were to request a single byte, the allocator would still create a two-word block.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007415" epub:type="practice" id="P7000497027000000000000000007415"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EFA" epub:type="title" id="P7000497027000000000000000045EFA"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007417" epub:type="pagebreak" id="P7000497027000000000000000007417" title="849"></span><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.6 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000777C.xhtml#P700049702700000000000000000780C">883</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000045EFB" id="P7000497027000000000000000045EFB">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000045EFC" id="P7000497027000000000000000045EFC">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045EFD" id="P7000497027000000000000000045EFD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045EFE" id="P7000497027000000000000000045EFE">Determine the block sizes and header values that would result from the following sequence of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045EFF" id="P7000497027000000000000000045EFF">malloc</code> requests. Assumptions: (1) The allocator maintains double-word alignment and uses an implicit free list with the block format from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000073FC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.35</span></a>. (2) Block sizes are rounded up to the nearest multiple of 8 bytes.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045F00" id="P7000497027000000000000000045F00">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045F01" id="P7000497027000000000000000045F01">Request</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045F02" id="P7000497027000000000000000045F02">Block size (decimal bytes)</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045F03" id="P7000497027000000000000000045F03">Block header (hex)</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F04" id="P7000497027000000000000000045F04"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F05" id="P7000497027000000000000000045F05">malloc(1)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F06" id="P7000497027000000000000000045F06">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F07" id="P7000497027000000000000000045F07">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F08" id="P7000497027000000000000000045F08"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F09" id="P7000497027000000000000000045F09">malloc(5)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F0A" id="P7000497027000000000000000045F0A">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F0B" id="P7000497027000000000000000045F0B">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F0C" id="P7000497027000000000000000045F0C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F0D" id="P7000497027000000000000000045F0D">malloc(12)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F0E" id="P7000497027000000000000000045F0E">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F0F" id="P7000497027000000000000000045F0F">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F10" id="P7000497027000000000000000045F10"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F11" id="P7000497027000000000000000045F11">malloc(13)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F12" id="P7000497027000000000000000045F12">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F13" id="P7000497027000000000000000045F13">_____</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007431" id="P7000497027000000000000000007431"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F14" epub:type="title" id="P7000497027000000000000000045F14"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.7 </span>Placing Allocated Blocks</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F15" id="P7000497027000000000000000045F15">When an application requests a block of <var class="pcalibre17 pcalibre2 pcalibre1">k</var> bytes, the allocator searches the free list for a free block that is large enough to hold the requested block. The manner in which the allocator performs this search is determined by the <i class="pcalibre17 pcalibre2 pcalibre1">placement policy.</i> Some common policies are first fit, next fit, and best fit.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F16" id="P7000497027000000000000000045F16"><i class="pcalibre17 pcalibre2 pcalibre1">First fit</i> searches the free list from the beginning and chooses the first free block that fits. <i class="pcalibre17 pcalibre2 pcalibre1">Next fit</i> is similar to first fit, but instead of starting each search at the beginning of the list, it starts each search where the previous search left off. <i class="pcalibre17 pcalibre2 pcalibre1">Best fit</i> examines every free block and chooses the free block with the smallest size that fits.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F17" id="P7000497027000000000000000045F17">An advantage of first fit is that it tends to retain large free blocks at the end of the list. A disadvantage is that it tends to leave "splinters" of small free blocks toward the beginning of the list, which will increase the search time for larger blocks. Next fit was first proposed by Donald Knuth as an alternative to first fit, motivated by the idea that if we found a fit in some free block the last time, there is a good chance that we will find a fit the next time in the remainder of the block. Next fit can run significantly faster than first fit, especially if the front of the list becomes littered with many small splinters. However, some studies suggest that next fit suffers from worse memory utilization than first fit. Studies have found that best fit generally enjoys better memory utilization than either first fit or next fit. However, the disadvantage of using best fit with simple free list organizations such as the implicit free list is that it requires an exhaustive search of the heap. Later, we will look at more sophisticated segregated free list organizations that approximate a best-fit policy without an exhaustive search of the heap.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007436" id="P7000497027000000000000000007436"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F18" epub:type="title" id="P7000497027000000000000000045F18"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.8 </span>Splitting Free Blocks</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F19" id="P7000497027000000000000000045F19">Once the allocator has located a free block that fits, it must make another policy decision about how much of the free block to allocate. One option is to use the entire free block. Although simple and fast, the main disadvantage is that it</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007439" id="P7000497027000000000000000007439">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000743A" epub:type="pagebreak" id="P700049702700000000000000000743A" title="850"></span>
<img alt="A diagram illustrates splitting a free block to satisfy a three-word allocation request." class="pcalibre1 pcalibre2 pcalibre283" data-uri="P700049702700000000000000000B7A1" id="P7000497027000000000000000045F1A" src="Images/chapter-08-image-40.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045F1B" id="P7000497027000000000000000045F1B"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045F1C" epub:type="title" id="P7000497027000000000000000045F1C"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.37 </span>Splitting a free block to satisfy a three-word allocation request.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F1D" id="P7000497027000000000000000045F1D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F1E" id="P7000497027000000000000000045F1E">Allocated blocks are shaded. Free blocks are unshaded. Headers are labeled with (size (bytes)/allocated bit).</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000026272" id="P7000497027000000000000000026272">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F1F" id="P7000497027000000000000000045F1F">A diagram has a row of shaded and unshaded blocks, from start of heap on the left to double-word aligned on the right. Arrows jump between groups of shaded blocks. The blocks are summarized from left to right below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045F20" id="P7000497027000000000000000045F20">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F21" id="P7000497027000000000000000045F21"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F22" id="P7000497027000000000000000045F22">Shaded, labeled unused</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F23" id="P7000497027000000000000000045F23"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F24" id="P7000497027000000000000000045F24">Two unshaded, first labeled 8/0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F25" id="P7000497027000000000000000045F25"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F26" id="P7000497027000000000000000045F26">Four shaded, the first labeled 16/1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F27" id="P7000497027000000000000000045F27"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F28" id="P7000497027000000000000000045F28">Four shaded, the first labeled 16/1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F29" id="P7000497027000000000000000045F29"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F2A" id="P7000497027000000000000000045F2A">Four unshaded, first labeled 16/0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F2B" id="P7000497027000000000000000045F2B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F2C" id="P7000497027000000000000000045F2C">Five shaded, first labeled 16/1 and last labeled 0/1</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F2D" id="P7000497027000000000000000045F2D">introduces internal fragmentation. If the placement policy tends to produce good fits, then some additional internal fragmentation might be acceptable.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F2E" id="P7000497027000000000000000045F2E">However, if the fit is not good, then the allocator will usually opt to <i class="pcalibre17 pcalibre2 pcalibre1">split</i> the free block into two parts. The first part becomes the allocated block, and the remainder becomes a new free block. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007439"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.37</span></a> shows how the allocator might split the eight-word free block in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007400"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.36</span></a> to satisfy an application's request for three words of heap memory.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007442" id="P7000497027000000000000000007442"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F2F" epub:type="title" id="P7000497027000000000000000045F2F"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.9 </span>Getting Additional Heap Memory</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F30" id="P7000497027000000000000000045F30">What happens if the allocator is unable to find a fit for the requested block? One option is to try to create some larger free blocks by merging (coalescing) free blocks that are physically adjacent in memory (next section). However, if this does not yield a sufficiently large block, or if the free blocks are already maximally coalesced, then the allocator asks the kernel for additional heap memory by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F31" id="P7000497027000000000000000045F31">sbrk</code> function. The allocator transforms the additional memory into one large free block, inserts the block into the free list, and then places the requested block in this new free block.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007446" id="P7000497027000000000000000007446"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F32" epub:type="title" id="P7000497027000000000000000045F32"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.10 </span>Coalescing Free Blocks</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F33" id="P7000497027000000000000000045F33">When the allocator frees an allocated block, there might be other free blocks that are adjacent to the newly freed block. Such adjacent free blocks can cause a phenomenon known as, <i class="pcalibre17 pcalibre2 pcalibre1">false fragmentation</i>, where there is a lot of available free memory chopped up into small, unusable free blocks. For example, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000744A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.38</span></a> shows the result of freeing the block that was allocated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007439"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.37</span></a>. The result is two adjacent free blocks with payloads of three words each. As a result, a subsequent request for a payload of four words would fail, even though the aggregate size of the two free blocks is large enough to satisfy the request.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F34" id="P7000497027000000000000000045F34">To combat false fragmentation, any practical allocator must merge adjacent free blocks in a process known as <i class="pcalibre17 pcalibre2 pcalibre1">coalescing.</i> This raises an important policy decision about when to perform coalescing. The allocator can opt for <i class="pcalibre17 pcalibre2 pcalibre1">immediate coalescing</i> by merging any adjacent blocks each time a block is freed. Or it can opt for <i class="pcalibre17 pcalibre2 pcalibre1">deferred coalescing</i> by waiting to coalesce free blocks at some later time. For example, the allocator might defer coalescing until some allocation request fails, and then scan the entire heap, coalescing all free blocks.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000744A" id="P700049702700000000000000000744A">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000744B" epub:type="pagebreak" id="P700049702700000000000000000744B" title="851"></span>
<img alt="A diagram illustrates an example of false fragmentation." class="pcalibre1 pcalibre2 pcalibre283" data-uri="P700049702700000000000000000B7A2" id="P7000497027000000000000000045F35" src="Images/chapter-08-image-41.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045F36" id="P7000497027000000000000000045F36"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045F37" epub:type="title" id="P7000497027000000000000000045F37"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.38 </span>An example of false fragmentation.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F38" id="P7000497027000000000000000045F38"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F39" id="P7000497027000000000000000045F39">Allocated blocks are shaded. Free blocks are unshaded. Headers are labeled with (size (bytes)/allocated bit).</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P700049702700000000000000002628E" id="P700049702700000000000000002628E">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F3A" id="P7000497027000000000000000045F3A">A diagram has a row of shaded and unshaded blocks, from start of heap on the left to double-word aligned on the right. Arrows jump between groups of blocks. The blocks are summarized from left to right below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045F3B" id="P7000497027000000000000000045F3B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F3C" id="P7000497027000000000000000045F3C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F3D" id="P7000497027000000000000000045F3D">Shaded, labeled unused</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F3E" id="P7000497027000000000000000045F3E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F3F" id="P7000497027000000000000000045F3F">Two unshaded, first labeled 8/0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F40" id="P7000497027000000000000000045F40"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F41" id="P7000497027000000000000000045F41">Four shaded, the first labeled 16/1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F42" id="P7000497027000000000000000045F42"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F43" id="P7000497027000000000000000045F43">Four unshaded, the first labeled 16/1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F44" id="P7000497027000000000000000045F44"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F45" id="P7000497027000000000000000045F45">Four unshaded, the first labeled 16/1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F46" id="P7000497027000000000000000045F46"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F47" id="P7000497027000000000000000045F47">Five shaded, first labeled 16/1 and last labeled 0/1</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F48" id="P7000497027000000000000000045F48">Immediate coalescing is straightforward and can be performed in constant time, but with some request patterns it can introduce a form of thrashing where a block is repeatedly coalesced and then split soon thereafter. For example, in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000744A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.38</span></a>, a repeated pattern of allocating and freeing a three-word block would introduce a lot of unnecessary splitting and coalescing. In our discussion of allocators, we will assume immediate coalescing, but you should be aware that fast allocators often opt for some form of deferred coalescing.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007452" id="P7000497027000000000000000007452"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F49" epub:type="title" id="P7000497027000000000000000045F49"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.11 </span>Coalescing with Boundary Tags</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F4A" id="P7000497027000000000000000045F4A">How does an allocator implement coalescing? Let us refer to the block we want to free as the <i class="pcalibre17 pcalibre2 pcalibre1">current block.</i> Then coalescing the next free block (in memory) is straightforward and efficient. The header of the current block points to the header of the next block, which can be checked to determine if the next block is free. If so, its size is simply added to the size of the current header and the blocks are coalesced in constant time.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F4B" id="P7000497027000000000000000045F4B">But how would we coalesce the previous block? Given an implicit free list of blocks with headers, the only option would be to search the entire list, remembering the location of the previous block, until we reached the current block. With an implicit free list, this means that each call to free would require time linear in the size of the heap. Even with more sophisticated free list organizations, the search time would not be constant.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F4C" id="P7000497027000000000000000045F4C">Knuth developed a clever and general technique, known as <i class="pcalibre17 pcalibre2 pcalibre1">boundary tags</i>, that allows for constant-time coalescing of the previous block. The idea, which is shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007461"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.39</span></a>, is to add <i class="pcalibre17 pcalibre2 pcalibre1">&amp; footer</i> (the boundary tag) at the end of each block, where the footer is a replica of the header. If each block includes such a footer, then the allocator can determine the starting location and status of the previous block by inspecting its footer, which is always one word away from the start of the current block.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F4D" id="P7000497027000000000000000045F4D">Consider all the cases that can exist when the allocator frees the current block:</p>
<ol class="pcalibre1 calibre19 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F4E" id="P7000497027000000000000000045F4E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F4F" id="P7000497027000000000000000045F4F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F50" id="P7000497027000000000000000045F50">The previous and next blocks are both allocated.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F51" id="P7000497027000000000000000045F51"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F52" id="P7000497027000000000000000045F52">The previous block is allocated and the next block is free.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F53" id="P7000497027000000000000000045F53"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F54" id="P7000497027000000000000000045F54">The previous block is free and the next block is allocated.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F55" id="P7000497027000000000000000045F55"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F56" id="P7000497027000000000000000045F56">The previous and next blocks are both free.</p></li>
</ol>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007461" id="P7000497027000000000000000007461">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007462" epub:type="pagebreak" id="P7000497027000000000000000007462" title="852"></span>
<img alt="A diagram illustrates the format of a heap block that uses a boundary tab." class="pcalibre1 pcalibre2 pcalibre284" data-uri="P700049702700000000000000000B7A3" id="P7000497027000000000000000045F57" src="Images/chapter-08-image-42.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045F58" id="P7000497027000000000000000045F58"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045F59" epub:type="title" id="P7000497027000000000000000045F59"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.39 </span>Format of heap block that uses a boundary tag.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P70004970270000000000000000262AF" id="P70004970270000000000000000262AF">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F5A" id="P7000497027000000000000000045F5A">A diagram has three sections, each from 31 to 0 bits, from top to bottom as follows:</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045F5B" id="P7000497027000000000000000045F5B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F5C" id="P7000497027000000000000000045F5C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F5D" id="P7000497027000000000000000045F5D">Header: Block size from bit 31 to 3, with a/f under bits 2 to 0 (a = 001: Allocated; a = 000: Free)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F5E" id="P7000497027000000000000000045F5E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F5F" id="P7000497027000000000000000045F5F">Payload (allocated block only)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F60" id="P7000497027000000000000000045F60"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F61" id="P7000497027000000000000000045F61">Padding (optional)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F62" id="P7000497027000000000000000045F62"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F63" id="P7000497027000000000000000045F63">Foot: block size from bit 31 to 3, with a/f under bits 2 to 0</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F64" id="P7000497027000000000000000045F64"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007472"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.40</span></a> shows how we would coalesce each of the four cases.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F65" id="P7000497027000000000000000045F65">In case 1, both adjacent blocks are allocated and thus no coalescing is possible. So the status of the current block is simply changed from allocated to free. In case 2, the current block is merged with the next block. The header of the current block and the footer of the next block are updated with the combined sizes of the current and next blocks. In case 3, the previous block is merged with the current block. The header of the previous block and the footer of the current block are updated with the combined sizes of the two blocks. In case 4, all three blocks are merged to form a single free block, with the header of the previous block and the footer of the next block updated with the combined sizes of the three blocks. In each case, the coalescing is performed in constant time.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F66" id="P7000497027000000000000000045F66">The idea of boundary tags is a simple and elegant one that generalizes to many different types of allocators and free list organizations. However, there is a potential disadvantage. Requiring each block to contain both a header and a footer can introduce significant memory overhead if an application manipulates many small blocks. For example, if a graph application dynamically creates and destroys graph nodes by making repeated calls to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F67" id="P7000497027000000000000000045F67">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F68" id="P7000497027000000000000000045F68">free</code>, and each graph node requires only a couple of words of memory, then the header and the footer will consume half of each allocated block.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F69" id="P7000497027000000000000000045F69">Fortunately, there is a clever optimization of boundary tags that eliminates the need for a footer in allocated blocks. Recall that when we attempt to coalesce the current block with the previous and next blocks in memory, the size field in the footer of the previous block is only needed if the previous block is <i class="pcalibre17 pcalibre2 pcalibre1">free.</i> If we were to store the allocated/free bit of the previous block in one of the excess low-order bits of the current block, then allocated blocks would not need footers, and we could use that extra space for payload. Note, however, that free blocks would still need footers.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000746C" epub:type="practice" id="P700049702700000000000000000746C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045F6A" epub:type="title" id="P7000497027000000000000000045F6A"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.7 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000777C.xhtml#P700049702700000000000000000780C">883</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000045F6B" id="P7000497027000000000000000045F6B">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000045F6C" id="P7000497027000000000000000045F6C">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F6D" id="P7000497027000000000000000045F6D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F6E" id="P7000497027000000000000000045F6E">Determine the minimum block size for each of the following combinations of alignment requirements and block formats. Assumptions: Implicit free list, zero-size payloads are not allowed, and headers and footers are stored in 4-byte words.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007472" id="P7000497027000000000000000007472">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007473" epub:type="pagebreak" id="P7000497027000000000000000007473" title="853"></span>
<img alt="A diagram illustrates four cases of coalescing with boundary tags." class="pcalibre1 pcalibre2 pcalibre285" data-uri="P700049702700000000000000000B7A4" id="P7000497027000000000000000045F6F" src="Images/chapter-08-image-43.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045F70" id="P7000497027000000000000000045F70"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045F71" epub:type="title" id="P7000497027000000000000000045F71"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.40 </span>Coalescing with boundary tags.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F72" id="P7000497027000000000000000045F72"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F73" id="P7000497027000000000000000045F73">Case 1 : prev and next allocated. Case 2: prev allocated, next free. Case 3: prev free, next allocated. Case 4: next and prev free.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P70004970270000000000000000262CA" id="P70004970270000000000000000262CA">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F74" id="P7000497027000000000000000045F74">A diagram illustrates four cases as heap blocks, beginning with a block with sections summarized below, from top to bottom:</p>
<ul class="pcalibre1 pcalibre2 pcalibre117" data-uri="chapter09.xhtml#P7000497027000000000000000045F75" id="P7000497027000000000000000045F75">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F76" id="P7000497027000000000000000045F76"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F77" id="P7000497027000000000000000045F77">M1 and a</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F78" id="P7000497027000000000000000045F78"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F79" id="P7000497027000000000000000045F79">Blank</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F7A" id="P7000497027000000000000000045F7A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F7B" id="P7000497027000000000000000045F7B">M1 and a</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F7C" id="P7000497027000000000000000045F7C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F7D" id="P7000497027000000000000000045F7D">N and a</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F7E" id="P7000497027000000000000000045F7E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F7F" id="P7000497027000000000000000045F7F">Blank shaded</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F80" id="P7000497027000000000000000045F80"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F81" id="P7000497027000000000000000045F81">N and a</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F82" id="P7000497027000000000000000045F82"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F83" id="P7000497027000000000000000045F83">M2 and a</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F84" id="P7000497027000000000000000045F84"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F85" id="P7000497027000000000000000045F85">Blank</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F86" id="P7000497027000000000000000045F86"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F87" id="P7000497027000000000000000045F87">M2 and a</p></li>
</ul>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F88" id="P7000497027000000000000000045F88">The changed blocks for each case are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter09.xhtml#P7000497027000000000000000045F89" id="P7000497027000000000000000045F89">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F8A" id="P7000497027000000000000000045F8A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F8B" id="P7000497027000000000000000045F8B">Case 1: above and below shaded blank, a is changed to f</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F8C" id="P7000497027000000000000000045F8C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F8D" id="P7000497027000000000000000045F8D">Case 2: shaded blank now extends down to bottom blank; above and below this blank is n+m2 and f</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F8E" id="P7000497027000000000000000045F8E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F8F" id="P7000497027000000000000000045F8F">Case 3: shaded blank now extends up to top blank; above and below this blank is n+m1 and f</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045F90" id="P7000497027000000000000000045F90"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045F91" id="P7000497027000000000000000045F91">Case 4: shaded blank now extends between the top and bottom blanks; above and below this blank is n+m1+m2 and f</p></li>
</ul>
</details>
</figcaption>
</figure>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000045F92" id="P7000497027000000000000000045F92">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045F93" id="P7000497027000000000000000045F93"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000747B" epub:type="pagebreak" id="P700049702700000000000000000747B" title="854"></span>Alignment</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045F94" id="P7000497027000000000000000045F94">Allocated block</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045F95" id="P7000497027000000000000000045F95">Free block</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000045F96" id="P7000497027000000000000000045F96">Minimum block size (bytes)</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F97" id="P7000497027000000000000000045F97">Single word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F98" id="P7000497027000000000000000045F98">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F99" id="P7000497027000000000000000045F99">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F9A" id="P7000497027000000000000000045F9A">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F9B" id="P7000497027000000000000000045F9B">Single word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F9C" id="P7000497027000000000000000045F9C">Header, but no footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F9D" id="P7000497027000000000000000045F9D">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F9E" id="P7000497027000000000000000045F9E">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045F9F" id="P7000497027000000000000000045F9F">Double word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045FA0" id="P7000497027000000000000000045FA0">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045FA1" id="P7000497027000000000000000045FA1">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045FA2" id="P7000497027000000000000000045FA2">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045FA3" id="P7000497027000000000000000045FA3">Double word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045FA4" id="P7000497027000000000000000045FA4">Header, but no footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045FA5" id="P7000497027000000000000000045FA5">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000045FA6" id="P7000497027000000000000000045FA6">_____</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000748F" id="P700049702700000000000000000748F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FA7" epub:type="title" id="P7000497027000000000000000045FA7"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.12 </span>Putting It Together: Implementing a Simple Allocator</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FA8" id="P7000497027000000000000000045FA8">Building an allocator is a challenging task. The design space is large, with numerous alternatives for block format and free list format, as well as placement, splitting, and coalescing policies. Another challenge is that you are often forced to program outside the safe, familiar confines of the type system, relying on the error-prone pointer casting and pointer arithmetic that is typical of low-level systems programming.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FA9" id="P7000497027000000000000000045FA9">While allocators do not require enormous amounts of code, they are subtle and unforgiving. Students familiar with higher-level languages such as C++ or Java often hit a conceptual wall when they first encounter this style of programming. To help you clear this hurdle, we will work through the implementation of a simple allocator based on an implicit free list with immediate boundary-tag coalescing. The maximum block size is 2<sup class="pcalibre1 pcalibre2 pcalibre85">32</sup> = 4 GB. The code is 64-bit clean, running without modification in 32-bit (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FAA" id="P7000497027000000000000000045FAA">gcc -m32</code>) or 64-bit (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FAB" id="P7000497027000000000000000045FAB">gcc -m64</code>) processes.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007495" id="P7000497027000000000000000007495"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FAC" epub:type="title" id="P7000497027000000000000000045FAC">General Allocator Design</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FAD" id="P7000497027000000000000000045FAD">Our allocator uses a model of the memory system provided by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FAE" id="P7000497027000000000000000045FAE">memlib.c</code> package shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000074A9"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.41</span></a>. The purpose of the model is to allow us to run our allocator without interfering with the existing system-level <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FAF" id="P7000497027000000000000000045FAF">malloc</code> package.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FB0" id="P7000497027000000000000000045FB0">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FB1" id="P7000497027000000000000000045FB1">mem_init</code> function models the virtual memory available to the heap as a large double-word aligned array of bytes. The bytes between <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FB2" id="P7000497027000000000000000045FB2">mem_heap</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FB3" id="P7000497027000000000000000045FB3">mem_brk</code> represent allocated virtual memory. The bytes following <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FB4" id="P7000497027000000000000000045FB4">mem_brk</code> represent unallocated virtual memory. The allocator requests additional heap memory by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FB5" id="P7000497027000000000000000045FB5">mem_sbrk</code> function, which has the same interface as the system's <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FB6" id="P7000497027000000000000000045FB6">sbrk</code> function, as well as the same semantics, except that it rejects requests to shrink the heap.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FB7" id="P7000497027000000000000000045FB7">The allocator itself is contained in a source file (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FB8" id="P7000497027000000000000000045FB8">mm. c</code>) that users can compile and link into their applications. The allocator exports three functions to application programs:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FB9" id="P7000497027000000000000000045FB9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FBA" id="P7000497027000000000000000045FBA">
1	extern int mm_init(void);
2	extern void *mm_malloc (size_t size);
3	extern void mm_free (void *ptr);
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FBB" id="P7000497027000000000000000045FBB">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FBC" id="P7000497027000000000000000045FBC">mm_init</code> function initializes the allocator, returning 0 if successful and –1 otherwise. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FBD" id="P7000497027000000000000000045FBD">mm_malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FBE" id="P7000497027000000000000000045FBE">mm_free</code> functions have the same interfaces and semantics as their system counterparts. The allocator uses the block format</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000074A9" id="P70004970270000000000000000074A9">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FBF" id="P7000497027000000000000000045FBF"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000074AB" epub:type="pagebreak" id="P70004970270000000000000000074AB" title="855"></span>_______________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/memlib.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FC0" id="P7000497027000000000000000045FC0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FC1" id="P7000497027000000000000000045FC1">

1	/* Private global variables */
2	static char *mem_heap;		/* Points to first byte of heap */
3	static char *mem_brk;		/* Points to last byte of heap plus 1 */
4	static char *mem_max_addr;	/* Max legal heap addr plus 1*/
5	
6	/*
7	* mem_init - Initialize the memory system model
8	*/
9	void mem_init(void)
10	{
11		mem_heap = (char *)Malloc(MAX_HEAP);
12		mem_brk = (char *)mem_heap;
13		mem_max_addr = (char *)(mem_heap + MAX_HEAP);
14	}
15	
16	/*
17	* mem_sbrk - Simple model of the sbrk function. Extends the heap
18	*	by incr bytes and returns the start address of the new area. In
19	*	this model, the heap cannot be shrunk.
20	*/
21	void *mem_sbrk(int incr)
22	{
23		char *old_brk = mem_brk;
24	
25		if ( (incr &lt; 0)|| ((mem_brk + incr) &gt; mem_max_addr)) {
26			errno = ENOMEM;
27			fprintf(stderr, "ERROR: mem_sbrk failed. Ran out of memory...\n");
28			return (void *)–1l;
29		}
30		mem_brk += incr;
31		return (void *)old_brk;
32	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FC2" id="P7000497027000000000000000045FC2">___________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/memlib.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045FC3" id="P7000497027000000000000000045FC3"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045FC4" epub:type="title" id="P7000497027000000000000000045FC4"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.41 </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FC5" id="P7000497027000000000000000045FC5">memlib. c</code>: Memory system model.</h1></header></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FC6" id="P7000497027000000000000000045FC6">shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007461"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.39</span></a>. The minimum block size is 16 bytes. The free list is organized as an implicit free list, with the invariant form shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000074B6"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.42</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FC7" id="P7000497027000000000000000045FC7">The first word is an unused padding word aligned to a double-word boundary. The padding is followed by a special <i class="pcalibre17 pcalibre2 pcalibre1">prologue block</i>, which is an 8-byte allocated block consisting of only a header and a footer. The prologue block is created during initialization and is never freed. Following the prologue block are zero or more regular blocks that are created by calls to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FC8" id="P7000497027000000000000000045FC8">malloc</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FC9" id="P7000497027000000000000000045FC9">free</code>. The heap always ends with a special <i class="pcalibre17 pcalibre2 pcalibre1">epilogue block</i>, which is a zero-size allocated block</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000074B6" id="P70004970270000000000000000074B6">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000074B7" epub:type="pagebreak" id="P70004970270000000000000000074B7" title="856"></span>
<img alt="A diagram illustrates an invarian t form of the implicit free list." class="pcalibre1 pcalibre2 pcalibre286" data-uri="P700049702700000000000000000B7A5" id="P7000497027000000000000000045FCA" src="Images/chapter-08-image-44.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045FCB" id="P7000497027000000000000000045FCB"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045FCC" epub:type="title" id="P7000497027000000000000000045FCC"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.42 </span>Invariant form of the implicit free list.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P7000497027000000000000000026324" id="P7000497027000000000000000026324">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FCD" id="P7000497027000000000000000045FCD">A diagram has a row of shaded and unshaded blocks, from start of heap on the left to double-word aligned on the right, as summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P7000497027000000000000000045FCE" id="P7000497027000000000000000045FCE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FCF" id="P7000497027000000000000000045FCF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045FD0" id="P7000497027000000000000000045FD0">Three shaded blocks, beginning at static, the second two each labeled 8/1, together representing prologue block with char *heap_listp between.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FD1" id="P7000497027000000000000000045FD1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045FD2" id="P7000497027000000000000000045FD2">Three unshaded, together as regular block 1, the first containing hdr and the third ftr</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FD3" id="P7000497027000000000000000045FD3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045FD4" id="P7000497027000000000000000045FD4">Three unshaded, together as regular block 2, the first containing hdr and the third ftr</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FD5" id="P7000497027000000000000000045FD5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045FD6" id="P7000497027000000000000000045FD6">…</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FD7" id="P7000497027000000000000000045FD7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045FD8" id="P7000497027000000000000000045FD8">Three unshaded, together as regular block n, the first containing hdr and the third ftr</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FD9" id="P7000497027000000000000000045FD9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000045FDA" id="P7000497027000000000000000045FDA">One shaded as epilogue block hdr, containing 0/1</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FDB" id="P7000497027000000000000000045FDB">that consists of only a header. The prologue and epilogue blocks are tricks that eliminate the edge conditions during coalescing. The allocator uses a single private (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FDC" id="P7000497027000000000000000045FDC">static</code>) global variable (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FDD" id="P7000497027000000000000000045FDD">heap_listp</code>) that always points to the prologue block. (As a minor optimization, we could make it point to the next block instead of the prologue block.)</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000074BE" id="P70004970270000000000000000074BE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FDE" epub:type="title" id="P7000497027000000000000000045FDE">Basic Constants and Macros for Manipulating the Free List</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FDF" id="P7000497027000000000000000045FDF"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000074D0"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.43</span></a> shows some basic constants and macros that we will use throughout the allocator code. Lines 2–4 define some basic size constants: the sizes of words (WSIZE) and double words (DSIZE), and the size of the initial free block and the default size for expanding the heap (CHUNKSIZE).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE0" id="P7000497027000000000000000045FE0">Manipulating the headers and footers in the free list can be troublesome because it demands extensive use of casting and pointer arithmetic. Thus, we find it helpful to define a small set of macros for accessing and traversing the free list (lines 9–25). The PACK macro (line 9) combines a size and an allocate bit and returns a value that can be stored in a header or footer.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE1" id="P7000497027000000000000000045FE1">The GET macro (line 12) reads and returns the word referenced by argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE2" id="P7000497027000000000000000045FE2">p</code>. The casting here is crucial. The argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE3" id="P7000497027000000000000000045FE3">p</code> is typically a (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE4" id="P7000497027000000000000000045FE4">void *</code>) pointer, which cannot be dereferenced directly. Similarly, the PUT macro (line 13) stores <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE5" id="P7000497027000000000000000045FE5">val</code> in the word pointed at by argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE6" id="P7000497027000000000000000045FE6">p</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE7" id="P7000497027000000000000000045FE7">The GET_SIZE and GET_ALLOC macros (lines 16–17) return the size and allocated bit, respectively, from a header or footer at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE8" id="P7000497027000000000000000045FE8">p</code>. The remaining macros operate on <i class="pcalibre17 pcalibre2 pcalibre1">block pointers</i> (denoted <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FE9" id="P7000497027000000000000000045FE9">bp</code>) that point to the first payload byte. Given a block pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FEA" id="P7000497027000000000000000045FEA">bp</code>, the HDRP and FTRP macros (lines 20–21) return pointers to the block header and footer, respectively. The NEXT_BLKP and PREV_BLKP macros (lines 24–25) return the block pointers of the next and previous blocks, respectively.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FEB" id="P7000497027000000000000000045FEB">The macros can be composed in various ways to manipulate the free list. For example, given a pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FEC" id="P7000497027000000000000000045FEC">bp</code> to the current block, we could use the following line of code to determine the size of the next block in memory:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FED" id="P7000497027000000000000000045FED"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FEE" id="P7000497027000000000000000045FEE">
size_t size = GET_SIZE(HDRP(NEXT_BLKP(bp)));
</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000074D0" id="P70004970270000000000000000074D0">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FEF" id="P7000497027000000000000000045FEF"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000074D2" epub:type="pagebreak" id="P70004970270000000000000000074D2" title="857"></span>_________________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000045FF0" id="P7000497027000000000000000045FF0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FF1" id="P7000497027000000000000000045FF1">
1	/* Basic constants and macros */
2	#define WSIZE	4	 /* Word and header/footer size (bytes) */
3	#define DSIZE	8	/* Double word size (bytes) */
4	#define CHUNKSIZE (1&lt;&lt;12) /* Extend heap by this amount (bytes) */
5	
6	#define MAX(x, y) ((x) &gt; (y)? (x) : (y))
7	
8	/* Pack a size and allocated bit into a word */
9	#define PACK(size, alloc) ((size)	|	(alloc))
10	
11	/* Read and write a word at address p */
12	#define GET(p)	(* (unsigned int *)(p))
13	#define PUT(p, val)		(*(unsigned int *)(p) = (val))
14	
15	/* Read the size and allocated fields from address p */
16	#define GET_SIZE(p)	(GET(p) &amp; ~0x7)
17	#define GET_ALL0C(p)	(GET(p) &amp; 0x1)
18	
19	/* Given block ptr bp, compute address of its header and footer */
20	#define HDRP(bp)	((char *) (bp) - WSIZE)
21	#define FTRP(bp)	((char *)(bp) + GET_SIZE(HDRP(bp)) - DSIZE)
22	
23	/* Given block ptr bp, compute address of next and previous blocks */
24	#define NEXT_BLKP(bp)	((char *)(bp) + GET_SIZE(((char *)(bp) - WSIZE)))
25	#define PREV_BLKP(bp)	((char *)(bp) - GET_SIZE(((char *)(bp) - DSIZE)))
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FF2" id="P7000497027000000000000000045FF2">________________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000045FF3" id="P7000497027000000000000000045FF3"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000045FF4" epub:type="title" id="P7000497027000000000000000045FF4"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.43 </span>Basic constants and macros for manipulating the free list.</h1></header></figcaption>
</figure>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000074D8" id="P70004970270000000000000000074D8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FF5" epub:type="title" id="P7000497027000000000000000045FF5">Creating the Initial Free List</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FF6" id="P7000497027000000000000000045FF6">Before calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FF7" id="P7000497027000000000000000045FF7">mm_malloc</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FF8" id="P7000497027000000000000000045FF8">mm_free</code>, the application must initialize the heap by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FF9" id="P7000497027000000000000000045FF9">mm_init</code> function (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000074E5"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.44</span></a>).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FFA" id="P7000497027000000000000000045FFA">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FFB" id="P7000497027000000000000000045FFB">mm_init</code> function gets four words from the memory system and initializes them to create the empty free list (lines 4–10). It then calls the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FFC" id="P7000497027000000000000000045FFC">extend_heap</code> function (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000074EE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.45</span></a>), which extends the heap by CHUNKSIZE bytes and creates the initial free block. At this point, the allocator is initialized and ready to accept allocate and free requests from the application.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FFD" id="P7000497027000000000000000045FFD">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FFE" id="P7000497027000000000000000045FFE">extend_heap</code> function is invoked in two different circumstances: (1) when the heap is initialized and (2) when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000045FFF" id="P7000497027000000000000000045FFF">mm_malloc</code> is unable to find a suitable fit. To maintain alignment, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046000" id="P7000497027000000000000000046000">extend_heap</code> rounds up the requested size to the nearest</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000074E5" id="P70004970270000000000000000074E5">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046001" id="P7000497027000000000000000046001"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000074E7" epub:type="pagebreak" id="P70004970270000000000000000074E7" title="858"></span>_________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046002" id="P7000497027000000000000000046002"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046003" id="P7000497027000000000000000046003">
1	int mm_init(void)
2	{
3		/* Create the initial empty heap */
4		if ((heap_listp = mem_sbrk(4*WSIZE)) == (void *)–1)
5			return –1;
6		PUT(heap_listp, 0);				/* Alignment padding */
7		PUT(heap_listp + (1*WSIZE), PACK(DSIZE, 1));	/* Prologue header */
8		PUT(heap_listp + (2*WSIZE), PACK(DSIZE, 1));	/* Prologue footer */
9		PUT(heap_listp + (3*WSIZE), PACK(0, 1));	/* Epilogue header */
10		heap_listp += (2*WSIZE);
11	
12		/* Extend the empty heap with a free block of CHUMSIZE bytes */
13		if (extend_heap(CHUMSIZE/WSIZE) == NULL)
14			return –1;
15		return 0;
16	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046004" id="P7000497027000000000000000046004">_______________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000046005" id="P7000497027000000000000000046005"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000046006" epub:type="title" id="P7000497027000000000000000046006"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.44 </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046007" id="P7000497027000000000000000046007">mm_init</code> creates a heap with an initial free block.</h1></header></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000074EE" id="P70004970270000000000000000074EE">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046008" id="P7000497027000000000000000046008">____________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046009" id="P7000497027000000000000000046009"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004600A" id="P700049702700000000000000004600A">
1	static void *extend_heap(size_t words)
2	{
3		char *bp;
4		size_t size;
5	
6		/* Allocate an even number of words to maintain alignment */
7		size = (words % 2) ? (words+1) * WSIZE : words * WSIZE;
8		if ((long)(bp = mem_sbrk(size)) == –1)
9			return NULL;
10	
11		/* Initialize free block header/footer and the epilogue header */
12		PUT(HDRP(bp), PACK(size, 0));		/* Free block header */
13		PUT(FTRP(bp), PACK(size, 0));		/* Free block footer */
14		PUT(HDRP(NEXT_BLKP(bp)), PACK(0, 1));	/* New epilogue header */
15	
16		/* Coalesce if the previous block was free */
17		return coalesce(bp);
18	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004600B" id="P700049702700000000000000004600B">_______________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P700049702700000000000000004600C" id="P700049702700000000000000004600C"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P700049702700000000000000004600D" epub:type="title" id="P700049702700000000000000004600D"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.45 </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004600E" id="P700049702700000000000000004600E">extend_heap</code> extends the heap with a new free block.</h1></header></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004600F" id="P700049702700000000000000004600F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000074F7" epub:type="pagebreak" id="P70004970270000000000000000074F7" title="859"></span>multiple of 2 words (8 bytes) and then requests the additional heap space from the memory system (lines 7–9).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046010" id="P7000497027000000000000000046010">The remainder of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046011" id="P7000497027000000000000000046011">extend_heap</code> function (lines 12–17) is somewhat subtle. The heap begins on a double-word aligned boundary, and every call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046012" id="P7000497027000000000000000046012">extend_heap</code> returns a block whose size is an integral number of double words. Thus, every call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046013" id="P7000497027000000000000000046013">mem_sbrk</code> returns a double-word aligned chunk of memory immediately following the header of the epilogue block. This header becomes the header of the new free block (line 12), and the last word of the chunk becomes the new epilogue block header (line 14). Finally, in the likely case that the previous heap was terminated by a free block, we call the coalesce function to merge the two free blocks and return the block pointer of the merged blocks (line 17).</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000074FC" id="P70004970270000000000000000074FC"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046014" epub:type="title" id="P7000497027000000000000000046014">Freeing and Coalescing Blocks</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046015" id="P7000497027000000000000000046015">An application frees a previously allocated block by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046016" id="P7000497027000000000000000046016">mm_free</code> function (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007509"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.46</span></a>), which frees the requested block (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046017" id="P7000497027000000000000000046017">bp</code>) and then merges adjacent free blocks using the boundary-tags coalescing technique described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007452"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9.11</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046018" id="P7000497027000000000000000046018">The code in the coalesce helper function is a straightforward implementation of the four cases outlined in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007472"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.40</span></a>. There is one somewhat subtle aspect. The free list format we have chosen—with its prologue and epilogue blocks that are always marked as allocated—allows us to ignore the potentially troublesome edge conditions where the requested block <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046019" id="P7000497027000000000000000046019">bp</code> is at the beginning or end of the heap. Without these special blocks, the code would be messier, more error prone, and slower because we would have to check for these rare edge conditions on each and every free request.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007503" id="P7000497027000000000000000007503"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004601A" epub:type="title" id="P700049702700000000000000004601A">Allocating Blocks</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004601B" id="P700049702700000000000000004601B">An application requests a block of size bytes of memory by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004601C" id="P700049702700000000000000004601C">mm_malloc</code> function (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007512"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.47</span></a>). After checking for spurious requests, the allocator must adjust the requested block size to allow room for the header and the footer, and to satisfy the double-word alignment requirement. Lines 12–13 enforce the minimum block size of 16 bytes: 8 bytes to satisfy the alignment requirement and 8 more bytes for the overhead of the header and footer. For requests over 8 bytes (line 15), the general rule is to add in the overhead bytes and then round up to the nearest multiple of 8.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004601D" id="P700049702700000000000000004601D">Once the allocator has adjusted the requested size, it searches the free list for a suitable free block (line 18). If there is a fit, then the allocator places the requested block and optionally splits the excess (line 19) and then returns the address of the newly allocated block.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004601E" id="P700049702700000000000000004601E">If the allocator cannot find a fit, it extends the heap with a new free block (lines 24–26), places the requested block in the new free block, optionally splitting the block (line 27), and then returns a pointer to the newly allocated block.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007509" id="P7000497027000000000000000007509">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004601F" id="P700049702700000000000000004601F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000750B" epub:type="pagebreak" id="P700049702700000000000000000750B" title="860"></span>______________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046020" id="P7000497027000000000000000046020"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046021" id="P7000497027000000000000000046021">
1	void mm_free(void *bp)
2	{
3		size_t size = GET_SIZE(HDRP(bp));
4	
5		PUT(HDRP(bp), PACKCsize, 0));
6		PUT(FTRPCbp), PACKCsize, 0));
7		coalesce(bp);
8	}
9	
10	static void *coalesce(void *bp)
11	{
12		size_t prev_alloc = GET_ALLOC(FTRP(PREV_BLKP(bp)));
13		size_t next_alloc = GET_ALLOC(HDRP(NEXT_BLKP(bp)));
14		size_t size = GET_SIZE(HDRP(bp));
15	
16		if (prev_alloc &amp;&amp; next_alloc) {			/* Case 1 */
17			return bp;
18		}
19	
20		else if (prev_alloc &amp;&amp; !next_alloc) {		/* Case 2 */
21			size += GET_SIZE(HDRP(NEXT_BLKP(bp)));
22			PUT(HDRP(bp), PACK(size, 0));
23			PUT (FTRP(bp), PACK(size,0));
24		}
25	
26		else if (!prev_alloc &amp;&amp; next_alloc) {		/* Case 3 */
27			size += GET_SIZE(HDRP(PREV_BLKP(bp)));
28			PUT(FTRPCbp), PACKCsize, 0));
29			PUT(HDRP(PREV_BLKP(bp)), PACKCsize, 0));
30			bp = PREV_BLKP(bp);
31		}
32	
33		else {						/* Case 4 */
34			size += GET_SIZE(HDRP(PREV_BLKP(bp))) +
35				GET_SIZE(FTRP(NEXT_BLKP(bp)));
36			PUT(HDRP(PREV_BLKP(bp)), PACKCsize, 0));
37			PUT(FTRP(NEXT_BLKP(bp)), PACKCsize, 0));
38			bp = PREV_BLKP(bp);
39		}
40		return bp;
41	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046022" id="P7000497027000000000000000046022">__________________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000046023" id="P7000497027000000000000000046023"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000046024" epub:type="title" id="P7000497027000000000000000046024"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.46 </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046025" id="P7000497027000000000000000046025">mm_free</code> frees a block and uses boundary-tag coalescing to merge it with any adjacent free blocks in constant time.</h1></header></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007512" id="P7000497027000000000000000007512">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046026" id="P7000497027000000000000000046026"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007514" epub:type="pagebreak" id="P7000497027000000000000000007514" title="861"></span>____________________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046027" id="P7000497027000000000000000046027"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046028" id="P7000497027000000000000000046028">
1	void *mm_malloc(size_t size)
2	{
3		size_t asize;	/* Adjusted block size */
4		size_t extendsize;	/* Amount to extend heap if no fit */
5		char *bp;
6	
7		/* Ignore spurious requests */
8		if (size == 0)
9			return NULL;
10	
11		/* Adjust block size to include overhead and alignment reqs. */
12		if (size &lt;= DSIZE)
13			asize = 2*DSIZE;
14		else
15			asize = DSIZE * ((size + (DSIZE) + (DSIZE-1)) / DSIZE);
16	
17		/* Search the free list for a fit */
18		if ((bp = find_fit(asize)) != NULL) {
19			place(bp, asize);
20			return bp;
21		}
22	
23		/* No fit found. Get more memory and place the block */
24		extendsize = MAX(asize,CHUNKSIZE);
25		if ((bp = extend_heap(extendsize/WSIZE)) == NULL)
26		return NULL;
27		place(bp, asize);
28		return bp;
29	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046029" id="P7000497027000000000000000046029">____________________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P700049702700000000000000004602A" id="P700049702700000000000000004602A"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P700049702700000000000000004602B" epub:type="title" id="P700049702700000000000000004602B"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.47 </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004602C" id="P700049702700000000000000004602C">mm_malloc</code> allocates a block from the free list.</h1></header></figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000751B" epub:type="practice" id="P700049702700000000000000000751B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre127 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004602D" epub:type="title" id="P700049702700000000000000004602D"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.8 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000777C.xhtml#P7000497027000000000000000007849">884</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P700049702700000000000000004602E" id="P700049702700000000000000004602E">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P700049702700000000000000004602F" id="P700049702700000000000000004602F">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046030" id="P7000497027000000000000000046030"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046031" id="P7000497027000000000000000046031">Implement a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046032" id="P7000497027000000000000000046032">find_fit</code> function for the simple allocator described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000748F"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9.12</span></a>.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046033" id="P7000497027000000000000000046033"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046034" id="P7000497027000000000000000046034">
static void *find_fit(size_t asize)
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046035" id="P7000497027000000000000000046035">Your solution should perform a first-fit search of the implicit free list.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007525" epub:type="practice" id="P7000497027000000000000000007525"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre127 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046036" epub:type="title" id="P7000497027000000000000000046036"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000777C.xhtml#P7000497027000000000000000007849">884</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000046037" id="P7000497027000000000000000046037">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000046038" id="P7000497027000000000000000046038">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046039" id="P7000497027000000000000000046039"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004603A" id="P700049702700000000000000004603A">Implement a place function for the example allocator.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004603B" id="P700049702700000000000000004603B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004603C" id="P700049702700000000000000004603C">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000752D" epub:type="pagebreak" id="P700049702700000000000000000752D" title="862"></span>static void place(void *bp, size_t asize)
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004603D" id="P700049702700000000000000004603D">Your solution should place the requested block at the beginning of the free block, splitting only if the size of the remainder would equal or exceed the minimum block size.</p>
</div></li></ol>
</section>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000752F" id="P700049702700000000000000000752F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004603E" epub:type="title" id="P700049702700000000000000004603E"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.13 </span>Explicit Free Lists</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004603F" id="P700049702700000000000000004603F">The implicit free list provides us with a simple way to introduce some basic allocator concepts. However, because block allocation time is linear in the total number of heap blocks, the implicit free list is not appropriate for a general-purpose allocator (although it might be fine for a special-purpose allocator where the number of heap blocks is known beforehand to be small).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046040" id="P7000497027000000000000000046040">A better approach is to organize the free blocks into some form of explicit data structure. Since by definition the body of a free block is not needed by the program, the pointers that implement the data structure can be stored within the bodies of the free blocks. For example, the heap can be organized as a doubly linked free list by including a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046041" id="P7000497027000000000000000046041">pred</code> (predecessor) and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046042" id="P7000497027000000000000000046042">succ</code> (successor) pointer in each free block, as shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007536"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.48</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046043" id="P7000497027000000000000000046043">Using a doubly linked list instead of an implicit free list reduces the first-fit allocation time from linear in the total number of blocks to linear in the number of <i class="pcalibre17 pcalibre2 pcalibre1">free</i> blocks. However, the time to free a block can be either linear or constant, depending on the policy we choose for ordering the blocks in the free list.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007536" id="P7000497027000000000000000007536">
<img alt="Diagrams illustrate allocated block and free block." class="calibre79 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B7A6" id="P7000497027000000000000000046044" src="Images/chapter-08-image-45.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000046045" id="P7000497027000000000000000046045"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P7000497027000000000000000046046" epub:type="title" id="P7000497027000000000000000046046"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.48 </span>Format of heap blocks that use doubly linked free lists.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P700049702700000000000000002639F" id="P700049702700000000000000002639F">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046047" id="P7000497027000000000000000046047">Two diagrams each show a block, from 31 to 0 bits. Diagram (a), of the allocated block, has the following from top to bottom:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046048" id="P7000497027000000000000000046048">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046049" id="P7000497027000000000000000046049"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004604A" id="P700049702700000000000000004604A">Header, with block size from 31 to 3 bits and a/f from 2 to 0 bits</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004604B" id="P700049702700000000000000004604B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004604C" id="P700049702700000000000000004604C">Payload</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004604D" id="P700049702700000000000000004604D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004604E" id="P700049702700000000000000004604E">Padding (optional)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004604F" id="P700049702700000000000000004604F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046050" id="P7000497027000000000000000046050">Footer, with block size and a/f as in the header</p></li>
</ul>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046051" id="P7000497027000000000000000046051">Diagram (b), of the free block, has the old payload section divided into pred (predecessor) and succ (successor) at the top, with a blank section below.</p>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046052" id="P7000497027000000000000000046052"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000753B" epub:type="pagebreak" id="P700049702700000000000000000753B" title="863"></span>One approach is to maintain the list in <i class="pcalibre17 pcalibre2 pcalibre1">last-in first-out</i> (LIFO) order by inserting newly freed blocks at the beginning of the list. With a LIFO ordering and a first-fit placement policy, the allocator inspects the most recently used blocks first. In this case, freeing a block can be performed in constant time. If boundary tags are used, then coalescing can also be performed in constant time.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046053" id="P7000497027000000000000000046053">Another approach is to maintain the list in <i class="pcalibre17 pcalibre2 pcalibre1">address order</i>, where the address of each block in the list is less than the address of its successor. In this case, freeing a block requires a linear-time search to locate the appropriate predecessor. The trade-off is that address-ordered first fit enjoys better memory utilization than LIFO-ordered first fit, approaching the utilization of best fit.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046054" id="P7000497027000000000000000046054">A disadvantage of explicit lists in general is that free blocks must be large enough to contain all of the necessary pointers, as well as the header and possibly a footer. This results in a larger minimum block size and increases the potential for internal fragmentation.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000753E" id="P700049702700000000000000000753E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046055" epub:type="title" id="P7000497027000000000000000046055"><span class="pcalibre1 pcalibre21 pcalibre2">9.9.14 </span>Segregated Free Lists</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046056" id="P7000497027000000000000000046056">As we have seen, an allocator that uses a single linked list of free blocks requires time linear in the number of free blocks to allocate a block. A popular approach for reducing the allocation time, known generally as <i class="pcalibre17 pcalibre2 pcalibre1">segregated storage</i>, is to maintain multiple free lists, where each list holds blocks that are roughly the same size. The general idea is to partition the set of all possible block sizes into equivalence classes called <i class="pcalibre17 pcalibre2 pcalibre1">size classes.</i> There are many ways to define the size classes. For example, we might partition the block sizes by powers of 2:</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000046057" id="P7000497027000000000000000046057"><m:math altimg="../images/ch09-eq9.png" altimg-height="19" altimg-width="592" alttext="" data-uri="" display="block"><m:mrow><m:mrow><m:mo>{</m:mo> <m:mn>1</m:mn> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mn>2</m:mn> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>3</m:mn><m:mo>,</m:mo><m:mn>4</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>5</m:mn><m:mo>−</m:mo><m:mn>8</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mo>⋯</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>1</m:mn><m:mo>,</m:mo><m:mn>025</m:mn><m:mo>−</m:mo><m:mn>2</m:mn><m:mo>,</m:mo><m:mn>048</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>2</m:mn><m:mo>,</m:mo><m:mn>049</m:mn><m:mo>−</m:mo><m:mn>4</m:mn><m:mo>,</m:mo><m:mn>096</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>4</m:mn><m:mo>,</m:mo><m:mn>097</m:mn><m:mo>−</m:mo><m:mi>∞</m:mi></m:mrow> <m:mo>}</m:mo></m:mrow></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046058" id="P7000497027000000000000000046058">Or we might assign small blocks to their own size classes and partition large blocks by powers of 2:</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000046059" id="P7000497027000000000000000046059"><m:math altimg="../images/ch09-eq10.png" altimg-height="19" altimg-width="661" alttext="" data-uri="" display="block"><m:mrow><m:mrow><m:mo>{</m:mo> <m:mn>1</m:mn> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mn>2</m:mn> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mn>3</m:mn> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mo>⋯</m:mo><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>1</m:mn><m:mo>,</m:mo><m:mn>023</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>1</m:mn><m:mo>,</m:mo><m:mn>024</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>1</m:mn><m:mo>,</m:mo><m:mn>025</m:mn><m:mo>−</m:mo><m:mn>2</m:mn><m:mo>,</m:mo><m:mn>048</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>2</m:mn><m:mo>,</m:mo><m:mn>049</m:mn><m:mo>−</m:mo><m:mn>4</m:mn><m:mo>,</m:mo><m:mn>096</m:mn></m:mrow> <m:mo>}</m:mo></m:mrow><m:mo>,</m:mo><m:mtext> </m:mtext><m:mtext> </m:mtext><m:mrow><m:mo>{</m:mo> <m:mrow><m:mn>4</m:mn><m:mo>,</m:mo><m:mn>097</m:mn><m:mo>−</m:mo><m:mi>∞</m:mi></m:mrow> <m:mo>}</m:mo></m:mrow></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004605A" id="P700049702700000000000000004605A">The allocator maintains an array of free lists, with one free list per size class, ordered by increasing size. When the allocator needs a block of size <var class="pcalibre17 pcalibre2 pcalibre1">n</var>, it searches the appropriate free list. If it cannot find a block that fits, it searches the next list, and so on.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004605B" id="P700049702700000000000000004605B">The dynamic storage allocation literature describes dozens of variants of segregated storage that differ in how they define size classes, when they perform coalescing, when they request additional heap memory from the operating system, whether they allow splitting, and so forth. To give you a sense of what is possible, we will describe two of the basic approaches: <i class="pcalibre17 pcalibre2 pcalibre1">simple segregated storage</i> and <i class="pcalibre17 pcalibre2 pcalibre1">segregated fits.</i></p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007546" id="P7000497027000000000000000007546"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004605C" epub:type="title" id="P700049702700000000000000004605C"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007548" epub:type="pagebreak" id="P7000497027000000000000000007548" title="864"></span>Simple Segregated Storage</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004605D" id="P700049702700000000000000004605D">With simple segregated storage, the free list for each size class contains same-size blocks, each the size of the largest element of the size class. For example, if some size class is defined as {17–32}, then the free list for that class consists entirely of blocks of size 32.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004605E" id="P700049702700000000000000004605E">To allocate a block of some given size, we check the appropriate free list. If the list is not empty, we simply allocate the first block in its entirety. Free blocks are never split to satisfy allocation requests. If the list is empty, the allocator requests a fixed-size chunk of additional memory from the operating system (typically a multiple of the page size), divides the chunk into equal-size blocks, and links the blocks together to form the new free list. To free a block, the allocator simply inserts the block at the front of the appropriate free list.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004605F" id="P700049702700000000000000004605F">There are a number of advantages to this simple scheme. Allocating and freeing blocks are both fast constant-time operations. Further, the combination of the same-size blocks in each chunk, no splitting, and no coalescing means that there is very little per-block memory overhead. Since each chunk has only same-size blocks, the size of an allocated block can be inferred from its address. Since there is no coalescing, allocated blocks do not need an allocated/free flag in the header. Thus, allocated blocks require no headers, and since there is no coalescing, they do not require any footers either. Since allocate and free operations insert and delete blocks at the beginning of the free list, the list need only be singly linked instead of doubly linked. The bottom line is that the only required field in any block is a one-word <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046060" id="P7000497027000000000000000046060">succ</code> pointer in each free block, and thus the minimum block size is only one word.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046061" id="P7000497027000000000000000046061">A significant disadvantage is that simple segregated storage is susceptible to internal and external fragmentation. Internal fragmentation is possible because free blocks are never split. Worse, certain reference patterns can cause extreme external fragmentation because free blocks are never coalesced (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000754E"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.10</span></a>).</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000754E" epub:type="practice" id="P700049702700000000000000000754E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre127 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046062" epub:type="title" id="P7000497027000000000000000046062"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.10 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000777C.xhtml#P700049702700000000000000000785C">885</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000046063" id="P7000497027000000000000000046063">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000046064" id="P7000497027000000000000000046064">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046065" id="P7000497027000000000000000046065"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046066" id="P7000497027000000000000000046066">Describe a reference pattern that results in severe external fragmentation in an allocator based on simple segregated storage.</p>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007554" id="P7000497027000000000000000007554"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046067" epub:type="title" id="P7000497027000000000000000046067">Segregated Fits</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046068" id="P7000497027000000000000000046068">With this approach, the allocator maintains an array of free lists. Each free list is associated with a size class and is organized as some kind of explicit or implicit list. Each list contains potentially different-size blocks whose sizes are members of the size class. There are many variants of segregated fits allocators. Here we describe a simple version.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046069" id="P7000497027000000000000000046069">To allocate a block, we determine the size class of the request and do a first-fit search of the appropriate free list for a block that fits. If we find one, then we (optionally) split it and insert the fragment in the appropriate free list. If we cannot find a block that fits, then we search the free list for the next larger size class. We <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007558" epub:type="pagebreak" id="P7000497027000000000000000007558" title="865"></span>repeat until we find a block that fits. If none of the free lists yields a block that fits, then we request additional heap memory from the operating system, allocate the block out of this new heap memory, and place the remainder in the appropriate size class. To free a block, we coalesce and place the result on the appropriate free list.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004606A" id="P700049702700000000000000004606A">The segregated fits approach is a popular choice with production-quality allocators such as the GNU <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004606B" id="P700049702700000000000000004606B">malloc</code> package provided in the C standard library because it is both fast and memory efficient. Search times are reduced because searches are limited to particular parts of the heap instead of the entire heap. Memory utilization can improve because of the interesting fact that a simple first-fit search of a segregated free list approximates a best-fit search of the entire heap.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000755B" id="P700049702700000000000000000755B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004606C" epub:type="title" id="P700049702700000000000000004606C">Buddy Systems</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004606D" id="P700049702700000000000000004606D">A <i class="pcalibre17 pcalibre2 pcalibre1">buddy system</i> is a special case of segregated fits where each size class is a power of 2. The basic idea is that, given a heap of 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 pcalibre85">m</sup></i> words, we maintain a separate free list for each block size <i class="pcalibre17 pcalibre2 pcalibre1">2<sup class="pcalibre1 pcalibre2 pcalibre85">k</sup></i>, where 0 ≤ <var class="pcalibre17 pcalibre2 pcalibre1">k</var> ≤ <var class="pcalibre17 pcalibre2 pcalibre1">m</var>. Requested block sizes are rounded up to the nearest power of 2. Originally, there is one free block of size 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 pcalibre85">m</sup></i> words.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004606E" id="P700049702700000000000000004606E">To allocate a block of size 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 pcalibre85">k</sup></i>, we find the first available block of size 2<sup class="pcalibre1 pcalibre2 pcalibre85"><var class="pcalibre17 pcalibre2 pcalibre1">j</var></sup>, such that <var class="pcalibre17 pcalibre2 pcalibre1">k</var> ≤ <var class="pcalibre17 pcalibre2 pcalibre1">j</var> ≤ <var class="pcalibre17 pcalibre2 pcalibre1">m</var>. If <var class="pcalibre17 pcalibre2 pcalibre1">j</var> = <var class="pcalibre17 pcalibre2 pcalibre1">k</var>, then we are done. Otherwise, we recursively split the block in half until <var class="pcalibre17 pcalibre2 pcalibre1">j</var> = <i class="pcalibre17 pcalibre2 pcalibre1">k.</i> As we perform this splitting, each remaining half (known as a <i class="pcalibre17 pcalibre2 pcalibre1">buddy</i>) is placed on the appropriate free list. To free a block of size 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 pcalibre85">k</sup></i>, we continue coalescing with the free buddies. When we encounter an allocated buddy, we stop the coalescing.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004606F" id="P700049702700000000000000004606F">A key fact about buddy systems is that, given the address and size of a block, it is easy to compute the address of its buddy. For example, a block of size 32 bytes with address</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000046070" id="P7000497027000000000000000046070"><m:math altimg="../images/ch09-eq11.png" altimg-height="15" altimg-width="134" alttext="" data-uri="" display="block"><m:mrow><m:mi>x</m:mi><m:mi>x</m:mi><m:mi>x</m:mi><m:mtext> </m:mtext><m:mo>…</m:mo><m:mi>x</m:mi><m:mn>00000</m:mn></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046071" id="P7000497027000000000000000046071">has its buddy at address</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter09.xhtml#P7000497027000000000000000046072" id="P7000497027000000000000000046072"><m:math altimg="../images/ch09-eq12.png" altimg-height="16" altimg-width="134" alttext="" data-uri="" display="block"><m:mrow><m:mi>x</m:mi><m:mi>x</m:mi><m:mi>x</m:mi><m:mtext> </m:mtext><m:mo>…</m:mo><m:mi>x</m:mi><m:mn>10000</m:mn></m:mrow></m:math></div>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046073" id="P7000497027000000000000000046073">In other words, the addresses of a block and its buddy differ in exactly one bit position.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046074" id="P7000497027000000000000000046074">The major advantage of a buddy system allocator is its fast searching and coalescing. The major disadvantage is that the power-of-2 requirement on the block size can cause significant internal fragmentation. For this reason, buddy system allocators are not appropriate for general-purpose workloads. However, for certain application-specific workloads, where the block sizes are known in advance to be powers of 2, buddy system allocators have a certain appeal.</p>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.10 Garbage Collection</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007565"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P7000497027000000000000000046075" epub:type="title" id="P7000497027000000000000000046075"><span class="pcalibre1 pcalibre21 pcalibre2">9.10 </span>Garbage Collection</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046076" id="P7000497027000000000000000046076">With an explicit allocator such as the C <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046077" id="P7000497027000000000000000046077">malloc</code> package, an application allocates and frees heap blocks by making calls to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046078" id="P7000497027000000000000000046078">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046079" id="P7000497027000000000000000046079">free</code>. It is the application's responsibility to free any allocated blocks that it no longer needs.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004607A" id="P700049702700000000000000004607A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000756C" epub:type="pagebreak" id="P700049702700000000000000000756C" title="866"></span>Failing to free allocated blocks is a common programming error. For example, consider the following C function that allocates a block of temporary storage as part of its processing:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004607B" id="P700049702700000000000000004607B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004607C" id="P700049702700000000000000004607C">
1	void garbage()
2	{
3		int *p = (int *)Malloc(15213);
4	
5		return; /* Array p is garbage at this point */
6	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004607D" id="P700049702700000000000000004607D">Since <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004607E" id="P700049702700000000000000004607E">p</code> is no longer needed by the program, it should have been freed before garbage returned. Unfortunately, the programmer has forgotten to free the block. It remains allocated for the lifetime of the program, needlessly occupying heap space that could be used to satisfy subsequent allocation requests.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004607F" id="P700049702700000000000000004607F">A <i class="pcalibre17 pcalibre2 pcalibre1">garbage collector</i> is a dynamic storage allocator that automatically frees allocated blocks that are no longer needed by the program. Such blocks are known as <i class="pcalibre17 pcalibre2 pcalibre1">garbage</i> (hence the term "garbage collector"). The process of automatically reclaiming heap storage is known as <i class="pcalibre17 pcalibre2 pcalibre1">garbage collection.</i> In a system that supports garbage collection, applications explicitly allocate heap blocks but never explicitly free them. In the context of a C program, the application calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046080" id="P7000497027000000000000000046080">malloc</code> but never calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046081" id="P7000497027000000000000000046081">free</code>. Instead, the garbage collector periodically identifies the garbage blocks and makes the appropriate calls to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046082" id="P7000497027000000000000000046082">free</code> to place those blocks back on the free list.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046083" id="P7000497027000000000000000046083">Garbage collection dates back to Lisp systems developed by John McCarthy at MIT in the early 1960s. It is an important part of modern language systems such as Java, ML, Perl, and Mathematica, and it remains an active and important area of research. The literature describes an amazing number of approaches for garbage collection. We will limit our discussion to McCarthy's original <i class="pcalibre17 pcalibre2 pcalibre1">Mark&amp;Sweep</i> algorithm, which is interesting because it can be built on top of an existing <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046084" id="P7000497027000000000000000046084">malloc</code> package to provide garbage collection for C and C++ programs.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007577" id="P7000497027000000000000000007577"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046085" epub:type="title" id="P7000497027000000000000000046085"><span class="pcalibre1 pcalibre21 pcalibre2">9.10.1 </span>Garbage Collector Basics</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046086" id="P7000497027000000000000000046086">A garbage collector views memory as a directed <i class="pcalibre17 pcalibre2 pcalibre1">reachability graph</i> of the form shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000757B"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.49</span></a>. The nodes of the graph are partitioned into a set of <i class="pcalibre17 pcalibre2 pcalibre1">root nodes</i> and a set of <i class="pcalibre17 pcalibre2 pcalibre1">heap nodes.</i> Each heap node corresponds to an allocated block in the heap. A directed edge <var class="pcalibre17 pcalibre2 pcalibre1">p</var>→ <var class="pcalibre17 pcalibre2 pcalibre1">q</var> means that some location in block <var class="pcalibre17 pcalibre2 pcalibre1">p</var> points to some location in block <i class="pcalibre17 pcalibre2 pcalibre1">q.</i> Root nodes correspond to locations not in the heap that contain pointers into the heap. These locations can be registers, variables on the stack, or global variables in the read/write data area of virtual memory.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046087" id="P7000497027000000000000000046087">We say that a node <var class="pcalibre17 pcalibre2 pcalibre1">p</var> is <i class="pcalibre17 pcalibre2 pcalibre1">reachable</i> if there exists a directed path from any root node to <i class="pcalibre17 pcalibre2 pcalibre1">p.</i> At any point in time, the unreachable nodes correspond to garbage that can never be used again by the application. The role of a garbage collector is to maintain some representation of the reachability graph and periodically reclaim the unreachable nodes by freeing them and returning them to the free list.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P700049702700000000000000000757B" id="P700049702700000000000000000757B">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000757C" epub:type="pagebreak" id="P700049702700000000000000000757C" title="867"></span>
<img alt="A directed graph has arrows from three reachable root nodes to reachable heap nodes below: one branching to two reachable nodes; one above a circle of three unreachable (garbage) nodes; and one to a reachable node beside an unreachable." class="calibre80 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B7A7" id="P7000497027000000000000000046088" src="Images/chapter-08-image-46.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P7000497027000000000000000046089" id="P7000497027000000000000000046089"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P700049702700000000000000004608A" epub:type="title" id="P700049702700000000000000004608A"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.49 </span>A garbage collector's view of memory as a directed graph.</h1></header></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007580" id="P7000497027000000000000000007580">
<img alt="A diagram shows an interaction with a C application program and malloc() within a dynamic storage allocator, within which a conservative garbage collector interacts with malloc() and free()." class="pcalibre1 pcalibre2 pcalibre287" data-uri="P700049702700000000000000000B7A8" id="P700049702700000000000000004608B" src="Images/chapter-08-image-47.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P700049702700000000000000004608C" id="P700049702700000000000000004608C"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P700049702700000000000000004608D" epub:type="title" id="P700049702700000000000000004608D"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.50 </span>Integrating a conservative garbage collector and a C <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004608E" id="P700049702700000000000000004608E">malloc</code> package.</h1></header></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004608F" id="P700049702700000000000000004608F">Garbage collectors for languages like ML and Java, which exert tight control over how applications create and use pointers, can maintain an exact representation of the reachability graph and thus can reclaim all garbage. However, collectors for languages like C and C++ cannot in general maintain exact representations of the reachability graph. Such collectors are known as <i class="pcalibre17 pcalibre2 pcalibre1">conservative garbage collectors.</i> They are conservative in the sense that each reachable block is correctly identified as reachable, while some unreachable nodes might be incorrectly identified as reachable.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046090" id="P7000497027000000000000000046090">Collectors can provide their service on demand, or they can run as separate threads in parallel with the application, continuously updating the reachability graph and reclaiming garbage. For example, consider how we might incorporate a conservative collector for C programs into an existing <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046091" id="P7000497027000000000000000046091">malloc</code> package, as shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007580"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.50</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046092" id="P7000497027000000000000000046092">The application calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046093" id="P7000497027000000000000000046093">malloc</code> in the usual manner whenever it needs heap space. If <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046094" id="P7000497027000000000000000046094">malloc</code> is unable to find a free block that fits, then it calls the garbage collector in hopes of reclaiming some garbage to the free list. The collector identifies the garbage blocks and returns them to the heap by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046095" id="P7000497027000000000000000046095">free</code> function. The key idea is that the collector calls free instead of the application. When the call to the collector returns, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046096" id="P7000497027000000000000000046096">malloc</code> tries again to find a free block that fits. If that fails, then it can ask the operating system for additional memory. Eventually, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046097" id="P7000497027000000000000000046097">malloc</code> returns a pointer to the requested block (if successful) or the NULL pointer (if unsuccessful).</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000758E" id="P700049702700000000000000000758E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046098" epub:type="title" id="P7000497027000000000000000046098"><span class="pcalibre1 pcalibre21 pcalibre2">9.10.2 </span>Mark&amp;Sweep Garbage Collectors</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046099" id="P7000497027000000000000000046099">A Mark&amp;Sweep garbage collector consists of a <i class="pcalibre17 pcalibre2 pcalibre1">mark phase</i>, which marks all reachable and allocated descendants of the root nodes, followed by a <i class="pcalibre17 pcalibre2 pcalibre1">sweep phase</i>, which frees each unmarked allocated block. Typically, one of the spare low-order bits in the block header is used to indicate whether a block is marked or not.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007591" id="P7000497027000000000000000007591">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004609A" id="P700049702700000000000000004609A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007593" epub:type="pagebreak" id="P7000497027000000000000000007593" title="868"></span>(a) <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004609B" id="P700049702700000000000000004609B">mark</code> function</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004609C" id="P700049702700000000000000004609C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004609D" id="P700049702700000000000000004609D">
void mark (ptr p) {
	if ((b = isPtr(p)) == NULL)
		return;
	if (blockMarked(b))
		return;
	markBlock(b);
	len = length(b);
	for (i=0; i &lt; len; i++)
		mark(b[i]);
	return;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004609E" id="P700049702700000000000000004609E">(b) <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004609F" id="P700049702700000000000000004609F">sweep</code> function</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460A0" id="P70004970270000000000000000460A0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460A1" id="P70004970270000000000000000460A1">
void sweep(ptr b, ptr end) {
	while (b &lt; end) {
		if (blockMarked(b))
			unmarkBlock(b);
		else if (blockAllocated(b))
			free(b);
		b = nextBlock(b);
	}
	return;
}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000460A2" id="P70004970270000000000000000460A2"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000460A3" epub:type="title" id="P70004970270000000000000000460A3"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.51 </span>Pseudocode for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460A4" id="P70004970270000000000000000460A4">mark</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460A5" id="P70004970270000000000000000460A5">sweep</code> functions.</h1></header></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460A6" id="P70004970270000000000000000460A6">Our description of Mark&amp;Sweep will assume the following functions, where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460A7" id="P70004970270000000000000000460A7">ptr</code> is defined as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460A8" id="P70004970270000000000000000460A8">typedef void *ptr</code>:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460A9" id="P70004970270000000000000000460A9">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460AA" id="P70004970270000000000000000460AA"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000460AB" id="P70004970270000000000000000460AB"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460AC" id="P70004970270000000000000000460AC">ptr isPtr (ptr p).</code> </span>If <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460AD" id="P70004970270000000000000000460AD">p</code> points to some word in an allocated block, it returns a pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460AE" id="P70004970270000000000000000460AE">b</code> to the beginning of that block. Returns NULL otherwise.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460AF" id="P70004970270000000000000000460AF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000460B0" id="P70004970270000000000000000460B0"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460B1" id="P70004970270000000000000000460B1">int blockMarked(ptr b)</code>. </span>Returns true if block <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460B2" id="P70004970270000000000000000460B2">b</code> is already marked.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460B3" id="P70004970270000000000000000460B3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000460B4" id="P70004970270000000000000000460B4"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460B5" id="P70004970270000000000000000460B5">int blockAllocated(ptr b)</code>. </span>Returns true if block <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460B6" id="P70004970270000000000000000460B6">b</code> is allocated.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460B7" id="P70004970270000000000000000460B7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000460B8" id="P70004970270000000000000000460B8"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460B9" id="P70004970270000000000000000460B9">void markBlock(ptr b)</code>. </span>Marks block <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460BA" id="P70004970270000000000000000460BA">b</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460BB" id="P70004970270000000000000000460BB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000460BC" id="P70004970270000000000000000460BC"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460BD" id="P70004970270000000000000000460BD">int length (ptr b)</code>. </span>Returns the length in words (excluding the header) of block <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460BE" id="P70004970270000000000000000460BE">b</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460BF" id="P70004970270000000000000000460BF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000460C0" id="P70004970270000000000000000460C0"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460C1" id="P70004970270000000000000000460C1">void unmarkBlock (ptr b)</code>. </span>Changes the status of block <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460C2" id="P70004970270000000000000000460C2">b</code> from marked to unmarked.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460C3" id="P70004970270000000000000000460C3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000460C4" id="P70004970270000000000000000460C4"><span class="pcalibre1 pcalibre2 pcalibre41"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460C5" id="P70004970270000000000000000460C5">ptr nextBlock(ptr b)</code>. </span>Returns the successor of block <var class="pcalibre17 pcalibre2 pcalibre1">b</var> in the heap.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460C6" id="P70004970270000000000000000460C6">The mark phase calls the mark function shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007591"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.51(a)</span></a> once for each root node. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460C7" id="P70004970270000000000000000460C7">mark</code> function returns immediately if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460C8" id="P70004970270000000000000000460C8">p</code> does not point to an allocated and unmarked heap block. Otherwise, it marks the block and calls itself recursively on each word in block. Each call to the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460C9" id="P70004970270000000000000000460C9">mark</code> function marks any unmarked and reachable descendants of some root node. At the end of the mark phase, any allocated block that is not marked is guaranteed to be unreachable and, hence, garbage that can be reclaimed in the sweep phase.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460CA" id="P70004970270000000000000000460CA">The sweep phase is a single call to the sweep function shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007591"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.51(b)</span></a>. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460CB" id="P70004970270000000000000000460CB">sweep</code> function iterates over each block in the heap, freeing any unmarked allocated blocks (i.e., garbage) that it encounters.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460CC" id="P70004970270000000000000000460CC"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000075C6"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.52</span></a> shows a graphical interpretation of Mark&amp;Sweep for a small heap. Block boundaries are indicated by heavy lines. Each square corresponds to a word of memory. Each block has a one-word header, which is either marked or unmarked.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000075C6" id="P70004970270000000000000000075C6">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000075C7" epub:type="pagebreak" id="P70004970270000000000000000075C7" title="869"></span>
<img alt="A diagram illustrates mark&amp;sweep." class="pcalibre288 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B7A9" id="P70004970270000000000000000460CD" src="Images/chapter-08-image-48.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000460CE" id="P70004970270000000000000000460CE"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000460CF" epub:type="title" id="P70004970270000000000000000460CF"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.52 </span>Mark&amp;Sweep example.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000460D0" id="P70004970270000000000000000460D0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000460D1" id="P70004970270000000000000000460D1">Note that the arrows in this example denote memory references, not free list pointers.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter09.xhtml#P700049702700000000000000002642B" id="P700049702700000000000000002642B">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460D2" id="P70004970270000000000000000460D2">A diagram of a mark&amp;sweep example has three rows of 16 blocks each, with arrows and labels summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter09.xhtml#P70004970270000000000000000460D3" id="P70004970270000000000000000460D3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460D4" id="P70004970270000000000000000460D4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000460D5" id="P70004970270000000000000000460D5">Before mark: unmarked block headers 1 through 4 are separated by blank blocks, followed by the root block. Unmarked block header 5 is second from the root, followed by three blank blocks and unmarked block header 6. Arrows point from root to the end of block 3; from block before block 4 to end of block 1; from block after root to end of block 6</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460D6" id="P70004970270000000000000000460D6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000460D7" id="P70004970270000000000000000460D7">After mark: blocks 1, 3, 4, and 6 are now marked block headers</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460D8" id="P70004970270000000000000000460D8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000460D9" id="P70004970270000000000000000460D9">After sweep: the third and fourth blocks, as well as marked blocks 5 to 6 are now free unmarked block headers.</p></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000075CD" id="P70004970270000000000000000075CD">
<img alt="A diagram shows an allocated block header followed by the remainder of the block. The allocated block header contains size, left and right, with an arrow from left labeled &lt; and an arrow from right labeled &gt;." class="pcalibre289 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B7AA" id="P70004970270000000000000000460DA" src="Images/chapter-08-image-49.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter09.xhtml#P70004970270000000000000000460DB" id="P70004970270000000000000000460DB"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter09.xhtml#P70004970270000000000000000460DC" epub:type="title" id="P70004970270000000000000000460DC"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">9.53 </span>Left and right pointers in a balanced tree of allocated blocks.</h1></header></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460DD" id="P70004970270000000000000000460DD">Initially, the heap in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000075C6"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.52</span></a> consists of six allocated blocks, each of which is unmarked. Block 3 contains a pointer to block 1. Block 4 contains pointers to blocks 3 and 6. The root points to block 4. After the mark phase, blocks 1,3,4, and 6 are marked because they are reachable from the root. Blocks 2 and 5 are unmarked because they are unreachable. After the sweep phase, the two unreachable blocks are reclaimed to the free list.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000075D2" id="P70004970270000000000000000075D2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460DE" epub:type="title" id="P70004970270000000000000000460DE"><span class="pcalibre1 pcalibre21 pcalibre2">9.10.3 </span>Conservative Mark&amp;Sweep for C Programs</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460DF" id="P70004970270000000000000000460DF">Mark&amp;Sweep is an appropriate approach for garbage collecting C programs because it works in place without moving any blocks. However, the C language poses some interesting challenges for the implementation of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E0" id="P70004970270000000000000000460E0">isPtr</code> function.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E1" id="P70004970270000000000000000460E1">First, C does not tag memory locations with any type information. Thus, there is no obvious way for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E2" id="P70004970270000000000000000460E2">isPtr</code> to determine if its input parameter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E3" id="P70004970270000000000000000460E3">p</code> is a pointer or not. Second, even if we were to know that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E4" id="P70004970270000000000000000460E4">p</code> was a pointer, there would be no obvious way for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E5" id="P70004970270000000000000000460E5">isPtr</code> to determine whether <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E6" id="P70004970270000000000000000460E6">p</code> points to some location in the payload of an allocated block.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E7" id="P70004970270000000000000000460E7">One solution to the latter problem is to maintain the set of allocated blocks as a balanced binary tree that maintains the invariant that all blocks in the left subtree are located at smaller addresses and all blocks in the right subtree are located in larger addresses. As shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000075CD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.53</span></a>, this requires two additional fields (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E8" id="P70004970270000000000000000460E8">left</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460E9" id="P70004970270000000000000000460E9">right</code>) in the header of each allocated block. Each field points to the header of some allocated block. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460EA" id="P70004970270000000000000000460EA">isPtr (ptr p)</code> function uses the tree to perform a binary search of the allocated blocks. At each step, it relies on the size field in the block header to determine if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460EB" id="P70004970270000000000000000460EB">p</code> falls within the extent of the block.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460EC" id="P70004970270000000000000000460EC"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000075E2" epub:type="pagebreak" id="P70004970270000000000000000075E2" title="870"></span>The balanced tree approach is correct in the sense that it is guaranteed to mark all of the nodes that are reachable from the roots. This is a necessary guarantee, as application users would certainly not appreciate having their allocated blocks prematurely returned to the free list. However, it is conservative in the sense that it may incorrectly mark blocks that are actually unreachable, and thus it may fail to free some garbage. While this does not affect the correctness of application programs, it can result in unnecessary external fragmentation.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460ED" id="P70004970270000000000000000460ED">The fundamental reason that Mark&amp;Sweep collectors for C programs must be conservative is that the C language does not tag memory locations with type information. Thus, scalars like <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460EE" id="P70004970270000000000000000460EE">ints</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460EF" id="P70004970270000000000000000460EF">floats</code> can masquerade as pointers. For example, suppose that some reachable allocated block contains an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460F0" id="P70004970270000000000000000460F0">int</code> in its payload whose value happens to correspond to an address in the payload of some other allocated block <i class="pcalibre17 pcalibre2 pcalibre1">b.</i> There is no way for the collector to infer that the data is really an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460F1" id="P70004970270000000000000000460F1">int</code> and not a pointer. Therefore, the allocator must conservatively mark block <var class="pcalibre17 pcalibre2 pcalibre1">b</var> as reachable, when in fact it might not be.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.11 Common Memory-Related Bugs in C Programs</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000075E8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P70004970270000000000000000460F2" epub:type="title" id="P70004970270000000000000000460F2"><span class="pcalibre1 pcalibre21 pcalibre2">9.11 </span>Common Memory-Related Bugs in C Programs</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460F3" id="P70004970270000000000000000460F3">Managing and using virtual memory can be a difficult and error-prone task for C programmers. Memory-related bugs are among the most frightening because they often manifest themselves at a distance, in both time and space, from the source of the bug. Write the wrong data to the wrong location, and your program can run for hours before it finally fails in some distant part of the program. We conclude our discussion of virtual memory with a look at of some of the common memory-related bugs.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000075EB" id="P70004970270000000000000000075EB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460F4" epub:type="title" id="P70004970270000000000000000460F4"><span class="pcalibre1 pcalibre21 pcalibre2">9.11.1 </span>Dereferencing Bad Pointers</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460F5" id="P70004970270000000000000000460F5">As we learned in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007216.xhtml#P7000497027000000000000000007269"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.7.2</span></a>, there are large holes in the virtual address space of a process that are not mapped to any meaningful data. If we attempt to dereference a pointer into one of these holes, the operating system will terminate our program with a segmentation exception. Also, some areas of virtual memory are read-only. Attempting to write to one of these areas terminates the program with a protection exception.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460F6" id="P70004970270000000000000000460F6">A common example of dereferencing a bad pointer is the classic <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460F7" id="P70004970270000000000000000460F7">scanf</code> bug. Suppose we want to use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460F8" id="P70004970270000000000000000460F8">scanf</code> to read an integer from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460F9" id="P70004970270000000000000000460F9">stdin</code> into a variable. The correct way to do this is to pass <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460FA" id="P70004970270000000000000000460FA">scanf</code> a format string and the <i class="pcalibre17 pcalibre2 pcalibre1">address</i> of the variable:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460FB" id="P70004970270000000000000000460FB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460FC" id="P70004970270000000000000000460FC">
scanf ("%d", &amp;val)
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460FD" id="P70004970270000000000000000460FD">However, it is easy for new C programmers (and experienced ones too!) to pass the <i class="pcalibre17 pcalibre2 pcalibre1">contents</i> of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000460FE" id="P70004970270000000000000000460FE">val</code> instead of its address:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000460FF" id="P70004970270000000000000000460FF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046100" id="P7000497027000000000000000046100">
scanf ("%d", val)
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046101" id="P7000497027000000000000000046101"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000075FA" epub:type="pagebreak" id="P70004970270000000000000000075FA" title="871"></span>In this case, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046102" id="P7000497027000000000000000046102">scanf</code> will interpret the contents of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046103" id="P7000497027000000000000000046103">val</code> as an address and attempt to write a word to that location. In the best case, the program terminates immediately with an exception. In the worst case, the contents of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046104" id="P7000497027000000000000000046104">val</code> correspond to some valid read/write area of virtual memory, and we overwrite memory, usually with disastrous and baffling consequences much later.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000075FE" id="P70004970270000000000000000075FE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046105" epub:type="title" id="P7000497027000000000000000046105"><span class="pcalibre1 pcalibre21 pcalibre2">9.11.2 </span>Reading Uninitialized Memory</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046106" id="P7000497027000000000000000046106">While bss memory locations (such as uninitialized global C variables) are always initialized to zeros by the loader, this is not true for heap memory. A common error is to assume that heap memory is initialized to zero:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046107" id="P7000497027000000000000000046107"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046108" id="P7000497027000000000000000046108">
1	/* Return y = Ax */
2	int *matvec(int **A, int *x, int n)
3	{
4		int i, j;
5	
6		int *y = (int *)Malloc(n * sizeof(int));
7	
8		for (i = 0; i &lt; n; i++)
9			for (j = 0; j &lt; n; j++)
10				y[i] += A[i] [j] * x[j];
11		return y;
12	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046109" id="P7000497027000000000000000046109">In this example, the programmer has incorrectly assumed that vector <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004610A" id="P700049702700000000000000004610A">y</code> has been initialized to zero. A correct implementation would explicitly zero <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004610B" id="P700049702700000000000000004610B">y[i]</code> or use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004610C" id="P700049702700000000000000004610C">calloc</code>.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007607" id="P7000497027000000000000000007607"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004610D" epub:type="title" id="P700049702700000000000000004610D"><span class="pcalibre1 pcalibre21 pcalibre2">9.11.3 </span>Allowing Stack Buffer Overflows</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004610E" id="P700049702700000000000000004610E">As we saw in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002185"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10.3</span></a>, a program has a <i class="pcalibre17 pcalibre2 pcalibre1">buffer overflow bug</i> if it writes to a target buffer on the stack without examining the size of the input string. For example, the following function has a buffer overflow bug because the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004610F" id="P700049702700000000000000004610F">gets</code> function copies an arbitrary-length string to the buffer. To fix this, we would need to use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046110" id="P7000497027000000000000000046110">fgets</code> function, which limits the size of the input string.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046111" id="P7000497027000000000000000046111"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046112" id="P7000497027000000000000000046112">
1	void bufoverflow()
2	{
3		char buf [64];
4	
5		gets(buf); /* Here is the stack buffer overflow bug */
6		return;
7	}
</code></pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000760E" id="P700049702700000000000000000760E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046113" epub:type="title" id="P7000497027000000000000000046113"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007610" epub:type="pagebreak" id="P7000497027000000000000000007610" title="872"></span><span class="pcalibre1 pcalibre21 pcalibre2">9.11.4 </span>Assuming That Pointers and the Objects They Point to Are the Same Size</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046114" id="P7000497027000000000000000046114">One common mistake is to assume that pointers to objects are the same size as the objects they point to:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046115" id="P7000497027000000000000000046115"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046116" id="P7000497027000000000000000046116">
1	/* Create an nxm array */
2	int **makeArray1(int n, int m)
3	{
4		int i;
5		int **A = (int **)Malloc(n * sizeof(int));
6	
7		for (i = 0; i &lt; n; i++)
8			A[i] = (int *)Malloc(m * sizeof(int));
9		return A;
10	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046117" id="P7000497027000000000000000046117">The intent here is to create an array of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> pointers, each of which points to an array of <var class="pcalibre17 pcalibre2 pcalibre1">m</var> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046118" id="P7000497027000000000000000046118">ints</code>. However, because the programmer has written <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046119" id="P7000497027000000000000000046119">sizeof (int)</code> instead of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004611A" id="P700049702700000000000000004611A">sizeof (int *)</code> in line 5, the code actually creates an array of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004611B" id="P700049702700000000000000004611B">ints</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004611C" id="P700049702700000000000000004611C">This code will run fine on machines where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004611D" id="P700049702700000000000000004611D">ints</code> and pointers to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004611E" id="P700049702700000000000000004611E">ints</code> are the same size. But if we run this code on a machine like the Core i7, where a pointer is larger than an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004611F" id="P700049702700000000000000004611F">int</code>, then the loop in lines 7–8 will write past the end of the A array. Since one of these words will likely be the boundary-tag footer of the allocated block, we may not discover the error until we free the block much later in the program, at which point the coalescing code in the allocator will fail dramatically and for no apparent reason. This is an insidious example of the kind of "action at a distance" that is so typical of memory-related programming bugs.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000761D" id="P700049702700000000000000000761D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046120" epub:type="title" id="P7000497027000000000000000046120"><span class="pcalibre1 pcalibre21 pcalibre2">9.11.5 </span>Making Off-by-One Errors</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046121" id="P7000497027000000000000000046121">Off-by-one errors are another common source of overwriting bugs:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046122" id="P7000497027000000000000000046122"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046123" id="P7000497027000000000000000046123">
1	/* Create an nxm array */
2	int **makeArray2(int n, int m)
3	{
4		int i;
5		int **A = (int **)Malloc(n * sizeof(int *));
6	
7		for (i = 0; i &lt;= n; i++)
8			A[i] = (int *)Malloc(m * sizeof(int));
9		return A;
10	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046124" id="P7000497027000000000000000046124">This is another version of the program in the previous section. Here we have created an <var class="pcalibre17 pcalibre2 pcalibre1">n</var>-element array of pointers in line 5 but then tried to initialize <var class="pcalibre17 pcalibre2 pcalibre1">n</var> + 1 of its elements in lines 7 and 8, in the process overwriting some memory that follows the A array.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007623" id="P7000497027000000000000000007623"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046125" epub:type="title" id="P7000497027000000000000000046125"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007625" epub:type="pagebreak" id="P7000497027000000000000000007625" title="873"></span><span class="pcalibre1 pcalibre21 pcalibre2">9.11.6 </span>Referencing a Pointer Instead of the Object It Points To</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046126" id="P7000497027000000000000000046126">If we are not careful about the precedence and associativity of C operators, then we incorrectly manipulate a pointer instead of the object it points to. For example, consider the following function, whose purpose is to remove the first item in a binary heap of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046127" id="P7000497027000000000000000046127">*size</code> items and then reheapify the remaining <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046128" id="P7000497027000000000000000046128">*size</code> - 1 items:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046129" id="P7000497027000000000000000046129"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004612A" id="P700049702700000000000000004612A">
1	int *binheapDelete(int **binheap, int *size)
2	{
3		int *packet = binheap[0];
4	
5		binheap [0] = binheap [*size - 1];
6		*size--; /* This should be (*size)-- */
7		heapify(binheap, *size, 0);
8		return(packet);
9	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004612B" id="P700049702700000000000000004612B">In line 6, the intent is to decrement the integer value pointed to by the size pointer. However, because the unary -- and * operators have the same precedence and associate from right to left, the code in line 6 actually decrements the pointer itself instead of the integer value that it points to. If we are lucky, the program will crash immediately. But more likely we will be left scratching our heads when the program produces an incorrect answer much later in its execution. The moral here is to use parentheses whenever in doubt about precedence and associativity. For example, in line 6, we should have clearly stated our intent by using the expression (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004612C" id="P700049702700000000000000004612C">*size</code>)--.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000762D" id="P700049702700000000000000000762D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004612D" epub:type="title" id="P700049702700000000000000004612D"><span class="pcalibre1 pcalibre21 pcalibre2">9.11.7 </span>Misunderstanding Pointer Arithmetic</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004612E" id="P700049702700000000000000004612E">Another common mistake is to forget that arithmetic operations on pointers are performed in units that are the size of the objects they point to, which are not necessarily bytes. For example, the intent of the following function is to scan an array of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004612F" id="P700049702700000000000000004612F">ints</code> and return a pointer to the first occurrence of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046130" id="P7000497027000000000000000046130">val</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046131" id="P7000497027000000000000000046131"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046132" id="P7000497027000000000000000046132">
1	int *search(int *p, int val)
2	{
3		while (*p &amp;&amp; *p != val)
4			p += sizeof(int); /* Should be p++ */
5		return p;
6	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046133" id="P7000497027000000000000000046133">However, because line 4 increments the pointer by 4 (the number of bytes in an integer) each time through the loop, the function incorrectly scans every fourth integer in the array.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007635" id="P7000497027000000000000000007635"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046134" epub:type="title" id="P7000497027000000000000000046134"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007637" epub:type="pagebreak" id="P7000497027000000000000000007637" title="874"></span><span class="pcalibre1 pcalibre21 pcalibre2">9.11.8 </span>Referencing Nonexistent Variables</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046135" id="P7000497027000000000000000046135">Naive C programmers who do not understand the stack discipline will sometimes reference local variables that are no longer valid, as in the following example:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046136" id="P7000497027000000000000000046136"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046137" id="P7000497027000000000000000046137">
1	int *stackref ()
2	{
3		int val;
4	
5		return &amp;val;
6	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046138" id="P7000497027000000000000000046138">This function returns a pointer (say, p) to a local variable on the stack and then pops its stack frame. Although <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046139" id="P7000497027000000000000000046139">p</code> still points to a valid memory address, it no longer points to a valid variable. When other functions are called later in the program, the memory will be reused for their stack frames. Later, if the program assigns some value to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004613A" id="P700049702700000000000000004613A">*p</code>, then it might actually be modifying an entry in another function's stack frame, with potentially disastrous and baffling consequences.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000763E" id="P700049702700000000000000000763E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004613B" epub:type="title" id="P700049702700000000000000004613B"><span class="pcalibre1 pcalibre21 pcalibre2">9.11.9 </span>Referencing Data in Free Heap Blocks</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004613C" id="P700049702700000000000000004613C">A similar error is to reference data in heap blocks that have already been freed. Consider the following example, which allocates an integer array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004613D" id="P700049702700000000000000004613D">x</code> in line 6, prematurely frees block <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004613E" id="P700049702700000000000000004613E">x</code> in line 10, and then later references it in line 14:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004613F" id="P700049702700000000000000004613F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046140" id="P7000497027000000000000000046140">
1	int *heapref(int n, int m)
2	{
3		int i;
4		int *x, *y;
5	
6		x = (int *)Malloc(n * sizeof(int));
7	
8		⋮ // <i class="pcalibre17 pcalibre2 pcalibre1">Other calls to malloc and free go here</i>
9	
10		free(x); 11
12		y = (int *)Malloc(m * sizeof(int));
13		for (i = 0; i &lt; m; i++)
14			y[i] = x[i]++; /* Oops! x[i] is a word in a free block */
15	
16		return y;
17	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046141" id="P7000497027000000000000000046141">Depending on the pattern of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046142" id="P7000497027000000000000000046142">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046143" id="P7000497027000000000000000046143">fre</code>e calls that occur between lines 6 and 10, when the program references <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046144" id="P7000497027000000000000000046144">x[i]</code> in line 14, the array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046145" id="P7000497027000000000000000046145">x</code> might be part of some other allocated heap block and may have been overwritten. As with many <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000764A" epub:type="pagebreak" id="P700049702700000000000000000764A" title="875"></span>memory-related bugs, the error will only become evident later in the program when we notice that the values in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046146" id="P7000497027000000000000000046146">y</code> are corrupted.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000764C" id="P700049702700000000000000000764C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046147" epub:type="title" id="P7000497027000000000000000046147"><span class="pcalibre1 pcalibre21 pcalibre2">9.11.10 </span>Introducing Memory Leaks</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046148" id="P7000497027000000000000000046148">Memory leaks are slow, silent killers that occur when programmers inadvertently create garbage in the heap by forgetting to free allocated blocks. For example, the following function allocates a heap block <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046149" id="P7000497027000000000000000046149">x</code> and then returns without freeing it:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004614A" id="P700049702700000000000000004614A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004614B" id="P700049702700000000000000004614B">
1	void leak(int n)
2	{
3		int *x = (int *)Malloc(n * sizeof(int));
4	
5		return; /* x is garbage at this point */
6	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004614C" id="P700049702700000000000000004614C">If <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004614D" id="P700049702700000000000000004614D">leak</code> is called frequently, then the heap will gradually fill up with garbage, in the worst case consuming the entire virtual address space. Memory leaks are particularly serious for programs such as daemons and servers, which by definition never terminate.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>9.12 Summary </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000007654"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P700049702700000000000000004614E" epub:type="title" id="P700049702700000000000000004614E"><span class="pcalibre1 pcalibre21 pcalibre2">9.12 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004614F" id="P700049702700000000000000004614F">Virtual memory is an abstraction of main memory. Processors that support virtual memory reference main memory using a form of indirection known as virtual addressing. The processor generates a virtual address, which is translated into a physical address before being sent to the main memory. The translation of addresses from a virtual address space to a physical address space requires close cooperation between hardware and software. Dedicated hardware translates virtual addresses using page tables whose contents are supplied by the operating system.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046150" id="P7000497027000000000000000046150">Virtual memory provides three important capabilities. First, it automatically caches recently used contents of the virtual address space stored on disk in main memory. The block in a virtual memory cache is known as a page. A reference to a page on disk triggers a page fault that transfers control to a fault handler in the operating system. The fault handler copies the page from disk to the main memory cache, writing back the evicted page if necessary. Second, virtual memory simplifies memory management, which in turn simplifies linking, sharing data between processes, the allocation of memory for processes, and program loading. Finally, virtual memory simplifies memory protection by incorporating protection bits into every page table entry.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046151" id="P7000497027000000000000000046151">The process of address translation must be integrated with the operation of any hardware caches in the system. Most page table entries are located in the L1 cache, but the cost of accessing page table entries from L1 is usually eliminated by an on-chip cache of page table entries called a TLB.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046152" id="P7000497027000000000000000046152"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000765A" epub:type="pagebreak" id="P700049702700000000000000000765A" title="876"></span>Modern systems initialize chunks of virtual memory by associating them with chunks of files on disk, a process known as memory mapping. Memory mapping provides an efficient mechanism for sharing data, creating new processes, and loading programs. Applications can manually create and delete areas of the virtual address space using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046153" id="P7000497027000000000000000046153">mmap</code> function. However, most programs rely on a dynamic memory allocator such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046154" id="P7000497027000000000000000046154">malloc</code>, which manages memory in an area of the virtual address space called the heap. Dynamic memory allocators are application-level programs with a system-level feel, directly manipulating memory without much help from the type system. Allocators come in two flavors. Explicit allocators require applications to explicitly free their memory blocks. Implicit allocators (garbage collectors) free any unused and unreachable blocks automatically.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046155" id="P7000497027000000000000000046155">Managing and using memory is a difficult and error-prone task for C programmers. Examples of common errors include dereferencing bad pointers, reading uninitialized memory, allowing stack buffer overflows, assuming that pointers and the objects they point to are the same size, referencing a pointer instead of the object it points to, misunderstanding pointer arithmetic, referencing nonexistent variables, and introducing memory leaks.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Bibliographic Notes </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre83 pcalibre2" epub:type="bibliography" id="P700049702700000000000000000765E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 title" data-uri="chapter09.xhtml#P7000497027000000000000000046156" epub:type="title" id="P7000497027000000000000000046156"><span class="pcalibre1 pcalibre21 pcalibre2">Bibliographic Notes </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046157" id="P7000497027000000000000000046157">Kilburn and his colleagues published the first description of virtual memory [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B420">63</a>]. Architecture texts contain additional details about the hardware's role in virtual memory [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3FE">46</a>]. Operating systems texts contain additional information about the operating system's role [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B470">102</a>,<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B478">106</a>,<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B486">113</a>]. Bovet and Cesati [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3B6">11</a>] give a detailed description of the Linux virtual memory system. Intel Corporation provides detailed documentation on 32-bit and 64-bit address translation on IA processors [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B40A">52</a>].</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046158" id="P7000497027000000000000000046158">Knuth wrote the classic work on storage allocation in 1968 [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B423">64</a>]. Since that time, there has been a tremendous amount of work in the area. Wilson, Johnstone, Neely, and Boles have written a beautiful survey and performance evaluation of explicit allocators [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B491">118</a>]. The general comments in this book about the throughput and utilization of different allocator strategies are paraphrased from their survey. Jones and Lins provide a comprehensive survey of garbage collection [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B412">56</a>]. Kernighan and Ritchie [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B41C">61</a>] show the complete code for a simple allocator based on an explicit free list with a block size and successor pointer in each free block. The code is interesting in that it uses unions to eliminate a lot of the complicated pointer arithmetic, but at the expense of a linear-time (rather than constant-time) free operation. Doug Lea developed a widely used open-source malloc package called <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046159" id="P7000497027000000000000000046159">dlmalloc</code> [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B429">67</a>].</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Homework Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="practice" id="P7000497027000000000000000007663"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P700049702700000000000000004615A" epub:type="title" id="P700049702700000000000000004615A"><span class="pcalibre1 pcalibre21 pcalibre2">Homework Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007665" id="P7000497027000000000000000007665"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004615B" epub:type="title" id="P700049702700000000000000004615B"><span class="pcalibre1 pcalibre21 pcalibre2">9.11 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P700049702700000000000000004615C" id="P700049702700000000000000004615C">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P700049702700000000000000004615D" id="P700049702700000000000000004615D">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P700049702700000000000000004615E" id="P700049702700000000000000004615E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004615F" id="P700049702700000000000000004615F">In the following series of problems, you are to show how the example memory system in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000070F6.xhtml#P70004970270000000000000000071A0"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.6.4</span></a> translates a virtual address into a physical address and accesses the cache. For the given virtual address, indicate the TLB entry accessed, <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000766B" epub:type="pagebreak" id="P700049702700000000000000000766B" title="877"></span>the physical address, and the cache byte value returned. Indicate whether the TLB misses, whether a page fault occurs, and whether a cache miss occurs. If there is a cache miss, enter "—" for "Cache byte returned." If there is a page fault, enter "—" for "PPN" and leave parts C and D blank.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046160" id="P7000497027000000000000000046160">Virtual address: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046161" id="P7000497027000000000000000046161">0x027c</code></p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter09.xhtml#P7000497027000000000000000046162" id="P7000497027000000000000000046162">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046163" id="P7000497027000000000000000046163"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046164" id="P7000497027000000000000000046164">Virtual address format</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007671" id="P7000497027000000000000000007671">
<img alt="Block boxes are numbered 13 through 0." class="pcalibre1 pcalibre2 pcalibre290" data-uri="P700049702700000000000000000B7AC" id="P7000497027000000000000000046165" src="Images/chapter-08-image-50.png"/>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046166" id="P7000497027000000000000000046166"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046167" id="P7000497027000000000000000046167">Address translation</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000046168" id="P7000497027000000000000000046168">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046169" id="P7000497027000000000000000046169">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004616A" id="P700049702700000000000000004616A">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004616B" id="P700049702700000000000000004616B">VPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004616C" id="P700049702700000000000000004616C">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004616D" id="P700049702700000000000000004616D">TLB index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004616E" id="P700049702700000000000000004616E">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004616F" id="P700049702700000000000000004616F">TLB tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046170" id="P7000497027000000000000000046170">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046171" id="P7000497027000000000000000046171">TLB hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046172" id="P7000497027000000000000000046172">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046173" id="P7000497027000000000000000046173">Page fault? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046174" id="P7000497027000000000000000046174">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046175" id="P7000497027000000000000000046175">PPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046176" id="P7000497027000000000000000046176">_____</td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046177" id="P7000497027000000000000000046177"> </p>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046178" id="P7000497027000000000000000046178"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046179" id="P7000497027000000000000000046179">Physical address format</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P7000497027000000000000000007687" id="P7000497027000000000000000007687">
<img alt="Block boxes are numbered 11 through 0." class="pcalibre1 pcalibre2 pcalibre291" data-uri="P700049702700000000000000000B7AD" id="P700049702700000000000000004617A" src="Images/chapter-08-image-51.png"/>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004617B" id="P700049702700000000000000004617B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004617C" id="P700049702700000000000000004617C">Physical memory reference</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P700049702700000000000000004617D" id="P700049702700000000000000004617D">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004617E" id="P700049702700000000000000004617E">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004617F" id="P700049702700000000000000004617F">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046180" id="P7000497027000000000000000046180">Byte offset</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046181" id="P7000497027000000000000000046181">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046182" id="P7000497027000000000000000046182">Cache index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046183" id="P7000497027000000000000000046183">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046184" id="P7000497027000000000000000046184">Cache tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046185" id="P7000497027000000000000000046185">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046186" id="P7000497027000000000000000046186">Cache hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046187" id="P7000497027000000000000000046187">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046188" id="P7000497027000000000000000046188">Cache byte returned</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046189" id="P7000497027000000000000000046189">_____</td>
</tr>
</tbody>
</table>
</li>
</ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007698" id="P7000497027000000000000000007698"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004618A" epub:type="title" id="P700049702700000000000000004618A"><span class="pcalibre1 pcalibre21 pcalibre2">9.12 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P700049702700000000000000004618B" id="P700049702700000000000000004618B">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P700049702700000000000000004618C" id="P700049702700000000000000004618C">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P700049702700000000000000004618D" id="P700049702700000000000000004618D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004618E" id="P700049702700000000000000004618E">Repeat <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007665"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.11</span></a> for the following address.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004618F" id="P700049702700000000000000004618F">Virtual address: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046190" id="P7000497027000000000000000046190">0x03a9</code></p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter09.xhtml#P7000497027000000000000000046191" id="P7000497027000000000000000046191">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046192" id="P7000497027000000000000000046192"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046193" id="P7000497027000000000000000046193">Virtual address format</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000076A3" id="P70004970270000000000000000076A3">
<img alt="Block boxes are numbered 13 through 0." class="pcalibre1 pcalibre2 pcalibre292" data-uri="P700049702700000000000000000B7AE" id="P7000497027000000000000000046194" src="Images/chapter-08-image-52.png"/>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046195" id="P7000497027000000000000000046195"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046196" id="P7000497027000000000000000046196"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000076A7" epub:type="pagebreak" id="P70004970270000000000000000076A7" title="878"></span>Address translation</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000046197" id="P7000497027000000000000000046197">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046198" id="P7000497027000000000000000046198">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046199" id="P7000497027000000000000000046199">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004619A" id="P700049702700000000000000004619A">VPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004619B" id="P700049702700000000000000004619B">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004619C" id="P700049702700000000000000004619C">TLB index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004619D" id="P700049702700000000000000004619D">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004619E" id="P700049702700000000000000004619E">TLB tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004619F" id="P700049702700000000000000004619F">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461A0" id="P70004970270000000000000000461A0">TLB hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461A1" id="P70004970270000000000000000461A1">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461A2" id="P70004970270000000000000000461A2">Page fault? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461A3" id="P70004970270000000000000000461A3">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461A4" id="P70004970270000000000000000461A4">PPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461A5" id="P70004970270000000000000000461A5">_____</td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461A6" id="P70004970270000000000000000461A6"> </p>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000461A7" id="P70004970270000000000000000461A7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461A8" id="P70004970270000000000000000461A8">Physical address format</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000076BA" id="P70004970270000000000000000076BA">
<img alt="Block boxes are numbered 11 through 0." class="pcalibre1 pcalibre2 calibre72" data-uri="P700049702700000000000000000B7AF" id="P70004970270000000000000000461A9" src="Images/chapter-08-image-53.png"/>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000461AA" id="P70004970270000000000000000461AA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461AB" id="P70004970270000000000000000461AB">Physical memory reference</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P70004970270000000000000000461AC" id="P70004970270000000000000000461AC">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000461AD" id="P70004970270000000000000000461AD">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000461AE" id="P70004970270000000000000000461AE">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461AF" id="P70004970270000000000000000461AF">Byte offset</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461B0" id="P70004970270000000000000000461B0">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461B1" id="P70004970270000000000000000461B1">Cache index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461B2" id="P70004970270000000000000000461B2">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461B3" id="P70004970270000000000000000461B3">Cache tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461B4" id="P70004970270000000000000000461B4">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461B5" id="P70004970270000000000000000461B5">Cache hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461B6" id="P70004970270000000000000000461B6">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461B7" id="P70004970270000000000000000461B7">Cache byte returned</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461B8" id="P70004970270000000000000000461B8">_____</td>
</tr>
</tbody>
</table>
</li></ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000076CB" id="P70004970270000000000000000076CB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461B9" epub:type="title" id="P70004970270000000000000000461B9"><span class="pcalibre1 pcalibre21 pcalibre2">9.13 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P70004970270000000000000000461BA" id="P70004970270000000000000000461BA">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P70004970270000000000000000461BB" id="P70004970270000000000000000461BB">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461BC" id="P70004970270000000000000000461BC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461BD" id="P70004970270000000000000000461BD">Repeat <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000007665"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.11</span></a> for the following address.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461BE" id="P70004970270000000000000000461BE">Virtual address: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461BF" id="P70004970270000000000000000461BF">0x0040</code></p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000076D3" id="P70004970270000000000000000076D3">
<img alt="Block boxes are numbered 13 through 0." class="calibre71 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B7B0" id="P70004970270000000000000000461C0" src="Images/chapter-08-image-54.png"/>
</figure>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter09.xhtml#P70004970270000000000000000461C1" id="P70004970270000000000000000461C1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000461C2" id="P70004970270000000000000000461C2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461C3" id="P70004970270000000000000000461C3">Address translation</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P70004970270000000000000000461C4" id="P70004970270000000000000000461C4">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000461C5" id="P70004970270000000000000000461C5">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000461C6" id="P70004970270000000000000000461C6">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461C7" id="P70004970270000000000000000461C7">VPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461C8" id="P70004970270000000000000000461C8">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461C9" id="P70004970270000000000000000461C9">TLB index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461CA" id="P70004970270000000000000000461CA">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461CB" id="P70004970270000000000000000461CB">TLB tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461CC" id="P70004970270000000000000000461CC">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461CD" id="P70004970270000000000000000461CD">TLB hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461CE" id="P70004970270000000000000000461CE">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461CF" id="P70004970270000000000000000461CF">Page fault? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461D0" id="P70004970270000000000000000461D0">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461D1" id="P70004970270000000000000000461D1">PPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461D2" id="P70004970270000000000000000461D2">_____</td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461D3" id="P70004970270000000000000000461D3"> </p>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000461D4" id="P70004970270000000000000000461D4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461D5" id="P70004970270000000000000000461D5">Physical address format</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter09.xhtml#P70004970270000000000000000076EA" id="P70004970270000000000000000076EA">
<img alt="Block boxes are numbered 11 through 0." class="calibre81 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B7B1" id="P70004970270000000000000000461D6" src="Images/chapter-08-image-55.png"/>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000461D7" id="P70004970270000000000000000461D7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461D8" id="P70004970270000000000000000461D8"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000076EE" epub:type="pagebreak" id="P70004970270000000000000000076EE" title="879"></span>Physical memory reference</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P70004970270000000000000000461D9" id="P70004970270000000000000000461D9">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000461DA" id="P70004970270000000000000000461DA">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000461DB" id="P70004970270000000000000000461DB">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461DC" id="P70004970270000000000000000461DC">Byte offset</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461DD" id="P70004970270000000000000000461DD">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461DE" id="P70004970270000000000000000461DE">Cache index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461DF" id="P70004970270000000000000000461DF">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461E0" id="P70004970270000000000000000461E0">Cache tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461E1" id="P70004970270000000000000000461E1">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461E2" id="P70004970270000000000000000461E2">Cache hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461E3" id="P70004970270000000000000000461E3">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461E4" id="P70004970270000000000000000461E4">Cache byte returned</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461E5" id="P70004970270000000000000000461E5">_____</td>
</tr>
</tbody>
</table>
</li></ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000076FC" id="P70004970270000000000000000076FC"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461E6" epub:type="title" id="P70004970270000000000000000461E6"><span class="pcalibre1 pcalibre21 pcalibre2">9.14 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P70004970270000000000000000461E7" id="P70004970270000000000000000461E7">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P70004970270000000000000000461E8" id="P70004970270000000000000000461E8">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461E9" id="P70004970270000000000000000461E9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461EA" id="P70004970270000000000000000461EA">Given an input file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461EB" id="P70004970270000000000000000461EB">hello.txt</code> that consists of the string <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461EC" id="P70004970270000000000000000461EC">Hello, world!\n</code>, write a C program that uses <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461ED" id="P70004970270000000000000000461ED">mmap</code> to change the contents of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461EE" id="P70004970270000000000000000461EE">hello.txt to Jello, world!\n</code>.</p></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007706" id="P7000497027000000000000000007706"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461EF" epub:type="title" id="P70004970270000000000000000461EF"><span class="pcalibre1 pcalibre21 pcalibre2">9.15 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P70004970270000000000000000461F0" id="P70004970270000000000000000461F0">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P70004970270000000000000000461F1" id="P70004970270000000000000000461F1">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461F2" id="P70004970270000000000000000461F2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P70004970270000000000000000461F3" id="P70004970270000000000000000461F3">Determine the block sizes and header values that would result from the following sequence of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461F4" id="P70004970270000000000000000461F4">malloc</code> requests. Assumptions: (1) The allocator maintains double-word alignment and uses an implicit free list with the block format from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000733C.xhtml#P70004970270000000000000000073FC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">9.35</span></a>. (2) Block sizes are rounded up to the nearest multiple of 8 bytes.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P70004970270000000000000000461F5" id="P70004970270000000000000000461F5">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000461F6" id="P70004970270000000000000000461F6">Request</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000461F7" id="P70004970270000000000000000461F7">Block size (decimal bytes)</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000461F8" id="P70004970270000000000000000461F8">Block header (hex)</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461F9" id="P70004970270000000000000000461F9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461FA" id="P70004970270000000000000000461FA">malloc(3)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461FB" id="P70004970270000000000000000461FB">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461FC" id="P70004970270000000000000000461FC">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461FD" id="P70004970270000000000000000461FD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000461FE" id="P70004970270000000000000000461FE">malloc(11)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000461FF" id="P70004970270000000000000000461FF">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046200" id="P7000497027000000000000000046200">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046201" id="P7000497027000000000000000046201"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046202" id="P7000497027000000000000000046202">malloc(20)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046203" id="P7000497027000000000000000046203">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046204" id="P7000497027000000000000000046204">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046205" id="P7000497027000000000000000046205"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046206" id="P7000497027000000000000000046206">malloc(21)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046207" id="P7000497027000000000000000046207">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046208" id="P7000497027000000000000000046208">_____</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007721" id="P7000497027000000000000000007721"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046209" epub:type="title" id="P7000497027000000000000000046209"><span class="pcalibre1 pcalibre21 pcalibre2">9.16 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P700049702700000000000000004620A" id="P700049702700000000000000004620A">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P700049702700000000000000004620B" id="P700049702700000000000000004620B">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P700049702700000000000000004620C" id="P700049702700000000000000004620C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004620D" id="P700049702700000000000000004620D">Determine the minimum block size for each of the following combinations of alignment requirements and block formats. Assumptions: Explicit free list, 4-byte <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004620E" id="P700049702700000000000000004620E">pred</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004620F" id="P700049702700000000000000004620F">succ</code> pointers in each free block, zero-size payloads are not allowed, and headers and footers are stored in 4-byte words.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000046210" id="P7000497027000000000000000046210">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046211" id="P7000497027000000000000000046211">Alignment</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046212" id="P7000497027000000000000000046212">Allocated block</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046213" id="P7000497027000000000000000046213">Free block</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046214" id="P7000497027000000000000000046214">Minimum block size (bytes)</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046215" id="P7000497027000000000000000046215">Single word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046216" id="P7000497027000000000000000046216">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046217" id="P7000497027000000000000000046217">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046218" id="P7000497027000000000000000046218">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046219" id="P7000497027000000000000000046219">Single word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004621A" id="P700049702700000000000000004621A">Header, but no footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004621B" id="P700049702700000000000000004621B">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004621C" id="P700049702700000000000000004621C">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004621D" id="P700049702700000000000000004621D">Double word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004621E" id="P700049702700000000000000004621E">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004621F" id="P700049702700000000000000004621F">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046220" id="P7000497027000000000000000046220">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046221" id="P7000497027000000000000000046221">Double word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046222" id="P7000497027000000000000000046222">Header, but no footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046223" id="P7000497027000000000000000046223">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046224" id="P7000497027000000000000000046224">_____</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000773E" id="P700049702700000000000000000773E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046225" epub:type="title" id="P7000497027000000000000000046225"><span class="pcalibre1 pcalibre21 pcalibre2">9.17 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000046226" id="P7000497027000000000000000046226">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000046227" id="P7000497027000000000000000046227">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046228" id="P7000497027000000000000000046228"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046229" id="P7000497027000000000000000046229">Develop a version of the allocator in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000733C.xhtml#P700049702700000000000000000748F"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9.12</span></a> that performs a next-fit search instead of a first-fit search.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007744" id="P7000497027000000000000000007744"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004622A" epub:type="title" id="P700049702700000000000000004622A"><span class="pcalibre1 pcalibre21 pcalibre2">9.18 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P700049702700000000000000004622B" id="P700049702700000000000000004622B">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P700049702700000000000000004622C" id="P700049702700000000000000004622C">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P700049702700000000000000004622D" id="P700049702700000000000000004622D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004622E" id="P700049702700000000000000004622E">The allocator in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000733C.xhtml#P700049702700000000000000000748F"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9.12</span></a> requires both a header and a footer for each block in order to perform constant-time coalescing. Modify the allocator so that free blocks require a header and a footer, but allocated blocks require only a header.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000774A" id="P700049702700000000000000000774A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004622F" epub:type="title" id="P700049702700000000000000004622F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000774C" epub:type="pagebreak" id="P700049702700000000000000000774C" title="880"></span><span class="pcalibre1 pcalibre21 pcalibre2">9.19 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000046230" id="P7000497027000000000000000046230">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000046231" id="P7000497027000000000000000046231">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046232" id="P7000497027000000000000000046232"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046233" id="P7000497027000000000000000046233">You are given three groups of statements relating to memory management and garbage collection below. In each group, only one statement is true. Your task is to indicate which statement is true.</p>
<ol class="pcalibre1 calibre19 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046234" id="P7000497027000000000000000046234">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046235" id="P7000497027000000000000000046235"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046236" id="P7000497027000000000000000046236"></p>
<ol class="pcalibre1 pcalibre2 pcalibre118" data-uri="chapter09.xhtml#P7000497027000000000000000046237" id="P7000497027000000000000000046237">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046238" id="P7000497027000000000000000046238"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046239" id="P7000497027000000000000000046239">In a buddy system, up to 50% of the space can be wasted due to internal fragmentation.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004623A" id="P700049702700000000000000004623A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004623B" id="P700049702700000000000000004623B">The first-fit memory allocation algorithm is slower than the best-fit algorithm (on average).</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004623C" id="P700049702700000000000000004623C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004623D" id="P700049702700000000000000004623D">Deallocation using boundary tags is fast only when the list of free blocks is ordered according to increasing memory addresses.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004623E" id="P700049702700000000000000004623E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004623F" id="P700049702700000000000000004623F">The buddy system suffers from internal fragmentation, but not from external fragmentation.</p></li>
</ol></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046240" id="P7000497027000000000000000046240"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046241" id="P7000497027000000000000000046241"></p>
<ol class="pcalibre1 pcalibre2 pcalibre118" data-uri="chapter09.xhtml#P7000497027000000000000000046242" id="P7000497027000000000000000046242">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046243" id="P7000497027000000000000000046243"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046244" id="P7000497027000000000000000046244">Using the first-fit algorithm on a free list that is ordered according to decreasing block sizes results in low performance for allocations, but avoids external fragmentation.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046245" id="P7000497027000000000000000046245"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046246" id="P7000497027000000000000000046246">For the best-fit method, the list of free blocks should be ordered according to increasing memory addresses.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046247" id="P7000497027000000000000000046247"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046248" id="P7000497027000000000000000046248">The best-fit method chooses the largest free block into which the requested segment fits.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046249" id="P7000497027000000000000000046249"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004624A" id="P700049702700000000000000004624A">Using the first-fit algorithm on a free list that is ordered according to increasing block sizes is equivalent to using the best-fit algorithm.</p></li>
</ol></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004624B" id="P700049702700000000000000004624B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004624C" id="P700049702700000000000000004624C">Mark&amp;Sweep garbage collectors are called conservative if</p>
<ol class="pcalibre1 pcalibre2 pcalibre118" data-uri="chapter09.xhtml#P700049702700000000000000004624D" id="P700049702700000000000000004624D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004624E" id="P700049702700000000000000004624E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004624F" id="P700049702700000000000000004624F">They coalesce freed memory only when a memory request cannot be satisfied.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046250" id="P7000497027000000000000000046250"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046251" id="P7000497027000000000000000046251">They treat everything that looks like a pointer as a pointer.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046252" id="P7000497027000000000000000046252"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046253" id="P7000497027000000000000000046253">They perform garbage collection only when they run out of memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046254" id="P7000497027000000000000000046254"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P7000497027000000000000000046255" id="P7000497027000000000000000046255">They do not free memory blocks forming a cyclic list.</p></li>
</ol></li></ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007773" id="P7000497027000000000000000007773"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046256" epub:type="title" id="P7000497027000000000000000046256"><span class="pcalibre1 pcalibre21 pcalibre2">9.20 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter09.xhtml#P7000497027000000000000000046257" id="P7000497027000000000000000046257">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter09.xhtml#P7000497027000000000000000046258" id="P7000497027000000000000000046258">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046259" id="P7000497027000000000000000046259"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter09.xhtml#P700049702700000000000000004625A" id="P700049702700000000000000004625A">Write your own version of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004625B" id="P700049702700000000000000004625B">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004625C" id="P700049702700000000000000004625C">free</code>, and compare its running time and space utilization to the version of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004625D" id="P700049702700000000000000004625D">malloc</code> provided in the standard C library.</p>
</div></li></ol>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Solutions to Practice Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P700049702700000000000000000777C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter09.xhtml#P700049702700000000000000004625E" epub:type="title" id="P700049702700000000000000004625E"><span class="pcalibre1 pcalibre21 pcalibre2">Solutions to Practice Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000777E" id="P700049702700000000000000000777E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004625F" epub:type="title" id="P700049702700000000000000004625F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000703D.xhtml#P7000497027000000000000000007049"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.1 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000703D.xhtml#P7000497027000000000000000007048">805</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046260" id="P7000497027000000000000000046260">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046261" id="P7000497027000000000000000046261"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000046262" id="P7000497027000000000000000046262">This problem gives you some appreciation for the sizes of different address spaces. At one point in time, a 32-bit address space seemed impossibly large. But now there are database and scientific applications that need more, and you can expect this trend to continue. At some point in your lifetime, expect to find yourself complaining about the cramped 64-bit address space on your personal computer!</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000046263" id="P7000497027000000000000000046263">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046264" id="P7000497027000000000000000046264"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007785" epub:type="pagebreak" id="P7000497027000000000000000007785" title="881"></span>Number of address bits <i class="pcalibre17 pcalibre2 pcalibre1">(n)</i></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046265" id="P7000497027000000000000000046265">Number of virtual addresses <i class="pcalibre17 pcalibre2 pcalibre1">(N)</i></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046266" id="P7000497027000000000000000046266">Largest possible virtual address</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046267" id="P7000497027000000000000000046267">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046268" id="P7000497027000000000000000046268"><i class="pcalibre17 pcalibre2 pcalibre1">2<sup class="pcalibre1 pcalibre2 calibre8">s</sup></i> = 256</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046269" id="P7000497027000000000000000046269">2<sup class="pcalibre1 pcalibre2 calibre8">8</sup> - 1 = 255</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004626A" id="P700049702700000000000000004626A">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004626B" id="P700049702700000000000000004626B">2<sup class="pcalibre1 pcalibre2 calibre8">16</sup> = 64 K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004626C" id="P700049702700000000000000004626C">2<sup class="pcalibre1 pcalibre2 calibre8">16</sup> – 1 = 64 K – 1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004626D" id="P700049702700000000000000004626D">32</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004626E" id="P700049702700000000000000004626E">2<sup class="pcalibre1 pcalibre2 calibre8">32</sup> = 4 G</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004626F" id="P700049702700000000000000004626F">2<sup class="pcalibre1 pcalibre2 calibre8">32</sup> – 1 = 4 G – 1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046270" id="P7000497027000000000000000046270">48</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046271" id="P7000497027000000000000000046271">2<sup class="pcalibre1 pcalibre2 calibre8">48</sup> = 256 T</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046272" id="P7000497027000000000000000046272">2<sup class="pcalibre1 pcalibre2 calibre8">48</sup> – 1 = 256 T – 1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046273" id="P7000497027000000000000000046273">64</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046274" id="P7000497027000000000000000046274">2<sup class="pcalibre1 pcalibre2 calibre8">64</sup> = 16,384 P</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046275" id="P7000497027000000000000000046275">2<sup class="pcalibre1 pcalibre2 calibre8">64</sup> – 1 = 16,384P – 1</td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007797" id="P7000497027000000000000000007797"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046276" epub:type="title" id="P7000497027000000000000000046276"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007062.xhtml#P7000497027000000000000000007085"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.2 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000007062.xhtml#P700049702700000000000000000707D">807</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046277" id="P7000497027000000000000000046277">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046278" id="P7000497027000000000000000046278"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000046279" id="P7000497027000000000000000046279">Since each virtual page is <var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 pcalibre85">P</sup></i> bytes, there are a total of 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 pcalibre85">n</sup></i>/2<sup class="pcalibre1 pcalibre2 pcalibre85"><var class="pcalibre17 pcalibre2 pcalibre1">p</var></sup> = 2<sup class="pcalibre1 pcalibre2 pcalibre85"><i class="pcalibre17 pcalibre2 pcalibre1">n–p</i></sup>possible pages in the system, each of which needs a page table entry (PTE).</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P700049702700000000000000004627A" id="P700049702700000000000000004627A">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004627B" id="P700049702700000000000000004627B"><var class="pcalibre17 pcalibre2 pcalibre1">n</var></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004627C" id="P700049702700000000000000004627C"><var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 2<i class="pcalibre17 pcalibre2 pcalibre1"><sup class="pcalibre1 pcalibre2 calibre8">p</sup></i></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004627D" id="P700049702700000000000000004627D">Number of PTEs</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004627E" id="P700049702700000000000000004627E">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004627F" id="P700049702700000000000000004627F">4 K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046280" id="P7000497027000000000000000046280">16</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046281" id="P7000497027000000000000000046281">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046282" id="P7000497027000000000000000046282">8 K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046283" id="P7000497027000000000000000046283">8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046284" id="P7000497027000000000000000046284">32</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046285" id="P7000497027000000000000000046285">4 K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046286" id="P7000497027000000000000000046286">1 M</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046287" id="P7000497027000000000000000046287">32</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046288" id="P7000497027000000000000000046288">8 K</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046289" id="P7000497027000000000000000046289">512 K</td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000077AC" id="P70004970270000000000000000077AC"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004628A" epub:type="title" id="P700049702700000000000000004628A"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000070F6.xhtml#P7000497027000000000000000007145"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.3 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000070F6.xhtml#P700049702700000000000000000713D">816</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004628B" id="P700049702700000000000000004628B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004628C" id="P700049702700000000000000004628C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P700049702700000000000000004628D" id="P700049702700000000000000004628D">You need to understand this kind of problem well in order to fully grasp address translation. Here is how to solve the first subproblem: We are given <var class="pcalibre17 pcalibre2 pcalibre1">n</var> = 32 virtual address bits and <var class="pcalibre17 pcalibre2 pcalibre1">m</var> = 24 physical address bits. A page size of <var class="pcalibre17 pcalibre2 pcalibre1">P</var> = 1 KB means we need log<sub class="pcalibre1 pcalibre2 calibre14">2</sub> (1 K) = 10 bits for both the VPO and PPO. (Recall that the VPO and PPO are identical.) The remaining address bits are the VPN and PPN, respectively.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P700049702700000000000000004628E" id="P700049702700000000000000004628E">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004628F" id="P700049702700000000000000004628F"></th>
<th class="pcalibre1 pcalibre2 calibre5" colspan="4" data-uri="chapter09.xhtml#P7000497027000000000000000046290" id="P7000497027000000000000000046290">Number of</th>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046291" id="P7000497027000000000000000046291"><var class="pcalibre17 pcalibre2 pcalibre1">p</var></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046292" id="P7000497027000000000000000046292">VPN bits</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046293" id="P7000497027000000000000000046293">VPO bits</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046294" id="P7000497027000000000000000046294">PPN bits</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P7000497027000000000000000046295" id="P7000497027000000000000000046295">PPO bits</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046296" id="P7000497027000000000000000046296">1 KB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046297" id="P7000497027000000000000000046297">22</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046298" id="P7000497027000000000000000046298">10</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046299" id="P7000497027000000000000000046299">14</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004629A" id="P700049702700000000000000004629A">10</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004629B" id="P700049702700000000000000004629B">2 KB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004629C" id="P700049702700000000000000004629C">21</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004629D" id="P700049702700000000000000004629D">11</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004629E" id="P700049702700000000000000004629E">13</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004629F" id="P700049702700000000000000004629F">11</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A0" id="P70004970270000000000000000462A0">4 KB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A1" id="P70004970270000000000000000462A1">20</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A2" id="P70004970270000000000000000462A2">12</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A3" id="P70004970270000000000000000462A3">12</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A4" id="P70004970270000000000000000462A4">12</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A5" id="P70004970270000000000000000462A5">8 KB</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A6" id="P70004970270000000000000000462A6">19</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A7" id="P70004970270000000000000000462A7">13</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A8" id="P70004970270000000000000000462A8">11</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462A9" id="P70004970270000000000000000462A9">13</td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P70004970270000000000000000077CD" id="P70004970270000000000000000077CD"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462AA" epub:type="title" id="P70004970270000000000000000462AA"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000070F6.xhtml#P70004970270000000000000000071E3"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.4 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000070F6.xhtml#P70004970270000000000000000071DD">824</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462AB" id="P70004970270000000000000000462AB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000462AC" id="P70004970270000000000000000462AC"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000462AD" id="P70004970270000000000000000462AD">Doing a few of these manual simulations is a great way to firm up your understanding of address translation. You might find it helpful to write out all the bits in the addresses and then draw boxes around the different bit fields, such as VPN, TLBI, and so on. In this particular problem, there are no misses of any kind: the TLB has a copy of the PTE and the cache has a copy of the requested data words. See <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007663.xhtml#P7000497027000000000000000007665"><span class="pcalibre1 pcalibre21 pcalibre2">Problems </span><span class="pcalibre1 pcalibre21 pcalibre2">9.11</span></a>, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007663.xhtml#P7000497027000000000000000007698"><span class="pcalibre1 pcalibre21 pcalibre2">9.12</span></a>, and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007663.xhtml#P70004970270000000000000000076CB"><span class="pcalibre1 pcalibre21 pcalibre2">9.13</span></a> for some different combinations of hits and misses.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter09.xhtml#P70004970270000000000000000462AE" id="P70004970270000000000000000462AE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000462AF" id="P70004970270000000000000000462AF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000462B0" id="P70004970270000000000000000462B0"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P70004970270000000000000000077D5" epub:type="pagebreak" id="P70004970270000000000000000077D5" title="882"></span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462B1" id="P70004970270000000000000000462B1">00 0011 1101 Olli</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000462B2" id="P70004970270000000000000000462B2"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000462B3" id="P70004970270000000000000000462B3"></p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P70004970270000000000000000462B4" id="P70004970270000000000000000462B4">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000462B5" id="P70004970270000000000000000462B5">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000462B6" id="P70004970270000000000000000462B6">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462B7" id="P70004970270000000000000000462B7">VPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462B8" id="P70004970270000000000000000462B8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462B9" id="P70004970270000000000000000462B9">0xf</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462BA" id="P70004970270000000000000000462BA">TLB index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462BB" id="P70004970270000000000000000462BB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462BC" id="P70004970270000000000000000462BC">0x3</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462BD" id="P70004970270000000000000000462BD">TLB tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462BE" id="P70004970270000000000000000462BE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462BF" id="P70004970270000000000000000462BF">0x3</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462C0" id="P70004970270000000000000000462C0">TLB hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462C1" id="P70004970270000000000000000462C1">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462C2" id="P70004970270000000000000000462C2">Page fault? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462C3" id="P70004970270000000000000000462C3">N</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462C4" id="P70004970270000000000000000462C4">PPN</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462C5" id="P70004970270000000000000000462C5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462C6" id="P70004970270000000000000000462C6">0xd</code></td>
</tr>
</tbody>
</table>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000462C7" id="P70004970270000000000000000462C7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000462C8" id="P70004970270000000000000000462C8"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462C9" id="P70004970270000000000000000462C9">0011 0101 Olli</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000462CA" id="P70004970270000000000000000462CA"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000462CB" id="P70004970270000000000000000462CB"></p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P70004970270000000000000000462CC" id="P70004970270000000000000000462CC">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000462CD" id="P70004970270000000000000000462CD">Parameter</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000462CE" id="P70004970270000000000000000462CE">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462CF" id="P70004970270000000000000000462CF">Byte offset</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462D0" id="P70004970270000000000000000462D0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462D1" id="P70004970270000000000000000462D1">0x3</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462D2" id="P70004970270000000000000000462D2">Cache index</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462D3" id="P70004970270000000000000000462D3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462D4" id="P70004970270000000000000000462D4">0x5</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462D5" id="P70004970270000000000000000462D5">Cache tag</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462D6" id="P70004970270000000000000000462D6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462D7" id="P70004970270000000000000000462D7">0xd</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462D8" id="P70004970270000000000000000462D8">Cache hit? (Y/N)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462D9" id="P70004970270000000000000000462D9">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462DA" id="P70004970270000000000000000462DA">Cache byte returned</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462DB" id="P70004970270000000000000000462DB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462DC" id="P70004970270000000000000000462DC">0x1d</code></td>
</tr>
</tbody>
</table>
</li></ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007802" id="P7000497027000000000000000007802"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462DD" epub:type="title" id="P70004970270000000000000000462DD"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000072B5.xhtml#P7000497027000000000000000007333"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.5 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000072B5.xhtml#P7000497027000000000000000007329">839</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462DE" id="P70004970270000000000000000462DE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000462DF" id="P70004970270000000000000000462DF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000462E0" id="P70004970270000000000000000462E0">Solving this problem will give you a good feel for the idea of memory mapping. Try it yourself. We haven't discussed the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462E1" id="P70004970270000000000000000462E1">open, fstat</code>, or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462E2" id="P70004970270000000000000000462E2">write</code> functions, so you'll need to read their man pages to see how they work.</p>
<p class="pcalibre1 pcalibre2 pcalibre42" data-uri="chapter09.xhtml#P70004970270000000000000000462E3" id="P70004970270000000000000000462E3">____________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/mmapcopy.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000462E4" id="P70004970270000000000000000462E4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462E5" id="P70004970270000000000000000462E5">
1	#include "csapp.h"
2	
3	/*
4		* mmapcopy - uses mmap to copy file fd to stdout
5		*/
6	void mmapcopy(int fd, int size)
7	{
8			char *bufp; /* ptr to memory-mapped VM area */
9	
10			bufp = MmapCNULL, size, PROT_READ, MAP_PRIVATE, fd, 0);
11			Write(1, bufp, size);
12			return;
13	}
14	
15	/* mmapcopy driver */
16	int main(int argc, char **argv)
17	{
18			struct stat stat;
19			int fd;
20	
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000780C" epub:type="pagebreak" id="P700049702700000000000000000780C" title="883"></span>21		/* Check for required command-line argument */
22		if (argc != 2) {
23			printf("usage : %s &lt;filename&gt;\n", argv[0]);
24			exit(0);
25		}
26	
27		/* Copy the input argument to stdout */
28		fd = Open(argv[1], O_RDONLY, 0);
29		fstat(fd, festat);
30		mmapcopy(fd, stat.st_size);
31		exit(0);
32	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000462E6" id="P70004970270000000000000000462E6">__________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/mmapcopy.c</i></p>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000780E" id="P700049702700000000000000000780E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462E7" epub:type="title" id="P70004970270000000000000000462E7"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000733C.xhtml#P7000497027000000000000000007415"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.6 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000733C.xhtml#P7000497027000000000000000007417">849</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462E8" id="P70004970270000000000000000462E8">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P70004970270000000000000000462E9" id="P70004970270000000000000000462E9"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P70004970270000000000000000462EA" id="P70004970270000000000000000462EA">This problem touches on some core ideas such as alignment requirements, minimum block sizes, and header encodings. The general approach for determining the block size is to round the sum of the requested payload and the header size to the nearest multiple of the alignment requirement (in this case, 8 bytes). For example, the block size for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462EB" id="P70004970270000000000000000462EB">malloc (1)</code> request is 4 + 1 = 5 rounded up to 8. The block size for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462EC" id="P70004970270000000000000000462EC">malloc (13)</code> request is 13 + 4 = 17 rounded up to 24.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P70004970270000000000000000462ED" id="P70004970270000000000000000462ED">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000462EE" id="P70004970270000000000000000462EE">Request</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000462EF" id="P70004970270000000000000000462EF">Block size (decimal bytes)</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P70004970270000000000000000462F0" id="P70004970270000000000000000462F0">Block header (hex)</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462F1" id="P70004970270000000000000000462F1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462F2" id="P70004970270000000000000000462F2">malloc(1)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462F3" id="P70004970270000000000000000462F3">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462F4" id="P70004970270000000000000000462F4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462F5" id="P70004970270000000000000000462F5">0x9</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462F6" id="P70004970270000000000000000462F6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462F7" id="P70004970270000000000000000462F7">malloc(5)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462F8" id="P70004970270000000000000000462F8">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462F9" id="P70004970270000000000000000462F9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462FA" id="P70004970270000000000000000462FA">0x11</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462FB" id="P70004970270000000000000000462FB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462FC" id="P70004970270000000000000000462FC">malloc(12)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462FD" id="P70004970270000000000000000462FD">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P70004970270000000000000000462FE" id="P70004970270000000000000000462FE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P70004970270000000000000000462FF" id="P70004970270000000000000000462FF">0x11</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046300" id="P7000497027000000000000000046300"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046301" id="P7000497027000000000000000046301">malloc(13)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046302" id="P7000497027000000000000000046302">24</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046303" id="P7000497027000000000000000046303"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046304" id="P7000497027000000000000000046304">0x19</code></td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000782D" id="P700049702700000000000000000782D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046305" epub:type="title" id="P7000497027000000000000000046305"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000733C.xhtml#P700049702700000000000000000746C"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.7 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000733C.xhtml#P7000497027000000000000000007462">852</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046306" id="P7000497027000000000000000046306">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046307" id="P7000497027000000000000000046307"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000046308" id="P7000497027000000000000000046308">The minimum block size can have a significant effect on internal fragmentation. Thus, it is good to understand the minimum block sizes associated with different allocator designs and alignment requirements. The tricky part is to realize that the same block can be allocated or free at different points in time. Thus, the minimum block size is the maximum of the minimum allocated block size and the minimum free block size. For example, in the last subproblem, the minimum allocated block size is a 4-byte header and a 1-byte payload rounded up to 8 bytes. The minimum free block size is a 4-byte header and 4-byte footer, which is already a multiple of 8 and doesn't need to be rounded. So the minimum block size for this allocator is 8 bytes.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter09.xhtml#P7000497027000000000000000046309" id="P7000497027000000000000000046309">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004630A" id="P700049702700000000000000004630A">Alignment</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004630B" id="P700049702700000000000000004630B">Allocated block</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004630C" id="P700049702700000000000000004630C">Free block</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter09.xhtml#P700049702700000000000000004630D" id="P700049702700000000000000004630D">Minimum block size (bytes)</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004630E" id="P700049702700000000000000004630E">Single word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004630F" id="P700049702700000000000000004630F">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046310" id="P7000497027000000000000000046310">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046311" id="P7000497027000000000000000046311">12</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046312" id="P7000497027000000000000000046312">Single word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046313" id="P7000497027000000000000000046313">Header, but no footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046314" id="P7000497027000000000000000046314">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046315" id="P7000497027000000000000000046315">8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046316" id="P7000497027000000000000000046316">Double word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046317" id="P7000497027000000000000000046317">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046318" id="P7000497027000000000000000046318">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P7000497027000000000000000046319" id="P7000497027000000000000000046319">16</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004631A" id="P700049702700000000000000004631A">Double word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004631B" id="P700049702700000000000000004631B">Header, but no footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004631C" id="P700049702700000000000000004631C">Header and footer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter09.xhtml#P700049702700000000000000004631D" id="P700049702700000000000000004631D">8</td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007847" id="P7000497027000000000000000007847"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004631E" epub:type="title" id="P700049702700000000000000004631E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007849" epub:type="pagebreak" id="P7000497027000000000000000007849" title="884"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000733C.xhtml#P700049702700000000000000000751B"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.8 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000733C.xhtml#P7000497027000000000000000007514">861</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004631F" id="P700049702700000000000000004631F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046320" id="P7000497027000000000000000046320"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000046321" id="P7000497027000000000000000046321">There is nothing very tricky here. But the solution requires you to understand how the rest of our simple implicit-list allocator works and how to manipulate and traverse blocks.</p>
<p class="pcalibre1 pcalibre2 pcalibre42" data-uri="chapter09.xhtml#P7000497027000000000000000046322" id="P7000497027000000000000000046322">_______________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046323" id="P7000497027000000000000000046323"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046324" id="P7000497027000000000000000046324">
1	static void *find_fit(size_t asize)
2	{
3		/* First-fit search */
4		void *bp;
5	
6		for (bp = heap_listp; GET_SIZE(HDRP(bp)) &gt; 0; bp = NEXT_BLKP(bp)) {
7			if (!GET_ALLOC(HDRP(bp)) &amp;&amp; (asize &lt;= GET_SIZE(HDRP(bp)))) {
8				return bp;
9			}
10		}
11		return NULL; /* No fit */
12	#endif
13	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000046325" id="P7000497027000000000000000046325">______________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P7000497027000000000000000007851" id="P7000497027000000000000000007851"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046326" epub:type="title" id="P7000497027000000000000000046326"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000733C.xhtml#P7000497027000000000000000007525"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000733C.xhtml#P7000497027000000000000000007514">861</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P7000497027000000000000000046327" id="P7000497027000000000000000046327">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046328" id="P7000497027000000000000000046328"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000046329" id="P7000497027000000000000000046329">This is another warm-up exercise to help you become familiar with allocators. Notice that for this allocator the minimum block size is 16 bytes. If the remainder of the block after splitting would be greater than or equal to the minimum block size, then we go ahead and split the block (lines 6–10). The only tricky part here is to realize that you need to place the new allocated block (lines 6 and 7) before moving to the next block (line 8).</p>
<p class="pcalibre1 pcalibre2 pcalibre42" data-uri="chapter09.xhtml#P700049702700000000000000004632A" id="P700049702700000000000000004632A">___________________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P700049702700000000000000004632B" id="P700049702700000000000000004632B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004632C" id="P700049702700000000000000004632C">
1	static void place(void *bp, size_t asize)
2	{
3		size_t csize = GET_SIZE(HDRP(bp));
4	
5		if ((csize - asize) &gt;= (2*DSIZE)) {
6			PUT(HDRP(bp), PACK(asize, 1));
7			PUT(FTRP(bp), PACK(asize, 1));
8			bp = NEXT_BLKP(bp);
9			PUT(HDRP(bp), PACK(csize-asize, 0));
10			PUT(FTRP(bp), PACK(csize-asize, 0));
11		}
12		else {
13			PUT(HDRP(bp), PACK(csize, 1));
14			PUT(FTRP(bp), PACK(csize, 1));
15		}
16	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P700049702700000000000000004632D" id="P700049702700000000000000004632D">_____________________________________________________________________________<i class="pcalibre17 pcalibre2 pcalibre1">code/vm/malloc/mm.c</i></p>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter09.xhtml#P700049702700000000000000000785A" id="P700049702700000000000000000785A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004632E" epub:type="title" id="P700049702700000000000000004632E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P700049702700000000000000000785C" epub:type="pagebreak" id="P700049702700000000000000000785C" title="885"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000733C.xhtml#P700049702700000000000000000754E"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">9.10 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000733C.xhtml#P7000497027000000000000000007548">864</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter09.xhtml#P700049702700000000000000004632F" id="P700049702700000000000000004632F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter09.xhtml#P7000497027000000000000000046330" id="P7000497027000000000000000046330"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter09.xhtml#P7000497027000000000000000046331" id="P7000497027000000000000000046331">Here is one pattern that will cause external fragmentation: The application makes numerous allocation and free requests to the first size class, followed by numerous allocation and free requests to the second size class, followed by numerous allocation and free requests to the third size class, and so on. For each size class, the allocator creates a lot of memory that is never reclaimed because the allocator doesn't coalesce, and because the application never requests blocks from that size class again.<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter09.xhtml#P7000497027000000000000000007860" epub:type="pagebreak" id="P7000497027000000000000000007860" title="886"></span></p></li></ul>
</section>
</section></body></html>
