<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Chapter 3 Machine-Level Representation of Programs</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="chapter" id="P7000497027000000000000000001DCE"><header class="pcalibre1 pcalibre2 pcalibre48"><h1 class="pcalibre1 pcalibre2 pcalibre49" data-uri="chapter03.xhtml#P700049702700000000000000004004A" epub:type="title" id="P700049702700000000000000004004A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001DD0" epub:type="pagebreak" id="P7000497027000000000000000001DD0" title="163"></span><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre50 pcalibre2">3 </span>Machine-Level Representation of Programs</h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" id="d9e52564">
<nav class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000004004B" epub:type="toc" id="P700049702700000000000000004004B">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004004C" id="P700049702700000000000000004004C">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004004D" id="P700049702700000000000000004004D">
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P700049702700000000000000004004E" id="P700049702700000000000000004004E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004004F" id="P700049702700000000000000004004F"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000001E06.xhtml#P7000497027000000000000000001E06"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.1 </span>A Historical Perspective </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">166</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P7000497027000000000000000040050" id="P7000497027000000000000000040050"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040051" id="P7000497027000000000000000040051"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000001E38.xhtml#P7000497027000000000000000001E38"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.2 </span>Program Encodings</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">169</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P7000497027000000000000000040052" id="P7000497027000000000000000040052"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040053" id="P7000497027000000000000000040053"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000001EF2.xhtml#P7000497027000000000000000001EF2"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.3 </span>Data Formats</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">177</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P7000497027000000000000000040054" id="P7000497027000000000000000040054"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040055" id="P7000497027000000000000000040055"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001F3C"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.4 </span>Accessing Information</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">179</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P7000497027000000000000000040056" id="P7000497027000000000000000040056"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040057" id="P7000497027000000000000000040057"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002185"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.5 </span>Arithmetic and Logical Operations</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">191</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P7000497027000000000000000040058" id="P7000497027000000000000000040058"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040059" id="P7000497027000000000000000040059"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002339"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.6 </span>Control</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">200</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P700049702700000000000000004005A" id="P700049702700000000000000004005A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004005B" id="P700049702700000000000000004005B"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000281F.xhtml#P700049702700000000000000000281F"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.7 </span>Procedures</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">238</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P700049702700000000000000004005C" id="P700049702700000000000000004005C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004005D" id="P700049702700000000000000004005D"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002B19"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.8 </span>Array Allocation and Access</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">255</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P700049702700000000000000004005E" id="P700049702700000000000000004005E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004005F" id="P700049702700000000000000004005F"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000002CDB.xhtml#P7000497027000000000000000002CDB"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.9 </span>Heterogeneous Data Structures</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">265</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P7000497027000000000000000040060" id="P7000497027000000000000000040060"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040061" id="P7000497027000000000000000040061"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000002E6D"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.10 </span>Combining Control and Data in Machine-Level Programs</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">276</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter03.xhtml#P7000497027000000000000000040062" id="P7000497027000000000000000040062"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040063" id="P7000497027000000000000000040063"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003080"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.11 </span>Floating-Point Code</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">293</span></a></p></li>
</ol>
</div>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040064" id="P7000497027000000000000000040064">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040065" id="P7000497027000000000000000040065">
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter03.xhtml#P7000497027000000000000000040066" id="P7000497027000000000000000040066"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040067" id="P7000497027000000000000000040067"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000032D2.xhtml#P70004970270000000000000000032D2"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">3.12 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary</span> </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">309</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter03.xhtml#P7000497027000000000000000040068" id="P7000497027000000000000000040068"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040069" id="P7000497027000000000000000040069"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000032D9.xhtml#P70004970270000000000000000032D9"><span class="pcalibre1 pcalibre2" epub:type="title">Bibliographic Notes </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">310</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter03.xhtml#P700049702700000000000000004006A" id="P700049702700000000000000004006A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004006B" id="P700049702700000000000000004006B"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000032E1.xhtml#P70004970270000000000000000032E1"><span class="pcalibre1 pcalibre2" epub:type="title">Homework Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">311</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter03.xhtml#P700049702700000000000000004006C" id="P700049702700000000000000004006C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004006D" id="P700049702700000000000000004006D"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000344D_split_000.xhtml#P700049702700000000000000000344D"><span class="pcalibre1 pcalibre2" epub:type="title">Solutions to Practice Problems</span> <span class="pcalibre1 pcalibre2" epub:type="pagebreak">325</span></a></p></li>
</ol>
</div></nav>
<section class="pcalibre1 pcalibre2 pcalibre51" data-uri="chapter03.xhtml#P700049702700000000000000004006E" epub:type="introduction" id="P700049702700000000000000004006E">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004006F" id="P700049702700000000000000004006F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001DF6" epub:type="pagebreak" id="P7000497027000000000000000001DF6" title="164"></span>Computers execute <i class="pcalibre17 pcalibre2 pcalibre1">machine code</i>, sequences of bytes encoding the low-level operations that manipulate data, manage memory, read and write data on storage devices, and communicate over networks. A compiler generates machine code through a series of stages, based on the rules of the programming language, the instruction set of the target machine, and the conventions followed by the operating system. The <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>C compiler generates its output in the form of <i class="pcalibre17 pcalibre2 pcalibre1">assembly code</i>, a textual representation of the machine code giving the individual instructions in the program. <span class="pcalibre1 pcalibre29 pcalibre2">Gcc </span>then invokes both an <i class="pcalibre17 pcalibre2 pcalibre1">assembler</i> and a <i class="pcalibre17 pcalibre2 pcalibre1">linker</i> to generate the executable machine code from the assembly code. In this chapter, we will take a close look at machine code and its human-readable representation as assembly code.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040070" id="P7000497027000000000000000040070">When programming in a high-level language such as C, and even more so in Java, we are shielded from the detailed machine-level implementation of our program. In contrast, when writing programs in assembly code (as was done in the early days of computing) a programmer must specify the low-level instructions the program uses to carry out a computation. Most of the time, it is much more productive and reliable to work at the higher level of abstraction provided by a high-level language. The type checking provided by a compiler helps detect many program errors and makes sure we reference and manipulate data in consistent ways. With modern optimizing compilers, the generated code is usually at least as efficient as what a skilled assembly-language programmer would write by hand. Best of all, a program written in a high-level language can be compiled and executed on a number of different machines, whereas assembly code is highly machine specific.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040071" id="P7000497027000000000000000040071">So why should we spend our time learning machine code? Even though compilers do most of the work in generating assembly code, being able to read and understand it is an important skill for serious programmers. By invoking the compiler with appropriate command-line parameters, the compiler will generate a file showing its output in assembly-code form. By reading this code, we can understand the optimization capabilities of the compiler and analyze the underlying inefficiencies in the code. As we will experience in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004893.xhtml#P7000497027000000000000000004893"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">5</span></a>, programmers seeking to maximize the performance of a critical section of code often try different variations of the source code, each time compiling and examining the generated assembly code to get a sense of how efficiently the program will run. Furthermore, there are times when the layer of abstraction provided by a high-level language hidesinformationabouttherun-timebehaviorofaprogramthatweneedtounder-stand. For example, when writing concurrent programs using a thread package, as covered in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000008060.xhtml#P7000497027000000000000000008060"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">12</span></a>, it is important to understand how program data are shared or kept private by the different threads and precisely how and where shared data are accessed. Such information is visible at the machine-code level. As another example, many of the ways programs can be attacked, allowing malware to infest a system, involve nuances of the way programs store their run-time control information. Many attacks involve exploiting weaknesses in system programs to overwrite information and thereby take control of the system. Understanding how these vulnerabilities arise and how to guard against them requires a knowledge of the machine-level representation of programs. The need for programmers to learn <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E01" epub:type="pagebreak" id="P7000497027000000000000000001E01" title="165"></span>machine code has shifted over the years from one of being able to write programs directly in assembly code to one of being able to read and understand the code generated by compilers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040072" id="P7000497027000000000000000040072">In this chapter, we will learn the details of one particular assembly language and see how C programs get compiled into this form of machine code. Reading the assembly code generated by a compiler involves a different set of skills than writing assembly code by hand. We must understand the transformations typical compilers make in converting the constructs of C into machine code. Relative to the computations expressed in the C code, optimizing compilers can rearrange execution order, eliminate unneeded computations, replace slow operations with faster ones, and even change recursive computations into iterative ones. Understanding the relation between source code and the generated assembly can often be a challenge—it's much like putting together a puzzle having a slightly different design than the picture on the box. It is a form of <i class="pcalibre17 pcalibre2 pcalibre1">reverse engineering</i>—trying to understand the process by which a system was created by studying the system and working backward. In this case, the system is a machine-generated assembly-language program, rather than something designed by a human. This simplifies the task of reverse engineering because the generated code follows fairly regular patterns and we can run experiments, having the compiler generate code for many different programs. In our presentation, we give many examples and provide a number of exercises illustrating different aspects of assembly language and compilers. This is a subject where mastering the details is a prerequisite to under-standing the deeper and more fundamental concepts. Those who say "I understand the general principles, I don't want to bother learning the details" are deluding themselves. It is critical for you to spend time studying the examples, working through the exercises, and checking your solutions with those provided.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040073" id="P7000497027000000000000000040073">Our presentation is based on x86-64, the machine language for most of the processors found in today's laptop and desktop machines, as well as those that power very large data centers and supercomputers. This language has evolved over a long history, starting with Intel Corporation's first 16-bit processor in 1978, through to the expansion to 32 bits, and most recently to 64 bits. Along the way, features have been added to make better use of the available semiconductor technology, and to satisfy the demands of the marketplace. Much of the development has been driven by Intel, but its rival Advanced Micro Devices (AMD) has also made important contributions. The result is a rather peculiar design with features that make sense only when viewed from a historical perspective. It is also laden with features providing backward compatibility that are not used by modern compilers and operating systems. We will focus on the subset of the features used by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>and Linux. This allows us to avoid much of the complexity and many of the arcane features of x86-64.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040074" id="P7000497027000000000000000040074">Our technical presentation starts with a quick tour to show the relation between C, assembly code, and machine code. We then proceed to the details of x86-64, starting with the representation and manipulation of data and the implementation of control. We see how control constructs in C, such as <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040075" id="P7000497027000000000000000040075">if</code>, <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040076" id="P7000497027000000000000000040076">while</code>, and <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040077" id="P7000497027000000000000000040077">switch</code> statements, are implemented. We then cover the implementation of procedures, including how the program maintains a run-time stack to support the</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000001DFF" id="P7000497027000000000000000001DFF"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 title1" data-uri="chapter03.xhtml#P7000497027000000000000000040078" epub:type="title" id="P7000497027000000000000000040078"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E09" epub:type="pagebreak" id="P7000497027000000000000000001E09" title="166"></span><span class="label1 pcalibre1 pcalibre2">Web Aside ASM:IA32 </span>IA32 programming</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040079" id="P7000497027000000000000000040079">IA32, the 32-bit predecessor to x86-64, was introduced by Intel in 1985. It served as the machine language of choice for several decades. Most x86 microprocessors sold today, and most operating systems installed on these machines, are designed to run x86-64. However, they can also execute IA32 programs in a backward compatibility mode. As a result, many application programs are still based on IA32. In addition, many existing systems cannot execute x86-64, due to limitations of their hardware or system software. IA32 continues to be an important machine language. You will find that having a background in x86-64 will enable you to learn the IA32 machine language quite readily.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004007A" id="P700049702700000000000000004007A">passing of data and control between procedures, as well as storage for local variables. Next, we consider how data structures such as arrays, structures, and unions are implemented at the machine level. With this background in machine-level programming, we can examine the problems of out-of-bounds memory references and the vulnerability of systems to buffer overflow attacks. We finish this part of the presentation with some tips on using the <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>debugger for examining the run-time behavior of a machine-level program. The chapter concludes with a presentation on machine-program representations of code involving floating-point data and operations.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004007B" id="P700049702700000000000000004007B">The computer industry has recently made the transition from 32-bit to 64-bit machines. A 32-bit machine can only make use of around 4 gigabytes (2<sup class="pcalibre1 pcalibre2 calibre21">32</sup> bytes) of random access memory, With memory prices dropping at dramatic rates, and our computational demands and data sizes increasing, it has become both economically feasible and technically desirable to go beyond this limitation. Current 64-bit machines can use up to 256 terabytes (2<sup class="pcalibre1 pcalibre2 calibre21">48</sup> bytes) of memory, and could readily be extended to use up to 16 exabytes (2<sup class="pcalibre1 pcalibre2 calibre21">64</sup> bytes). Although it is hard to imagine having a machine with that much memory, keep in mind that 4 gigabytes seemed like an extreme amount of memory when 32-bit machines became commonplace in the 1970s and 1980s.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004007C" id="P700049702700000000000000004007C">Our presentation focuses on the types of machine-level programs generated when compiling C and similar programming languages targeting modern operating systems. As a consequence, we make no attempt to describe many of the features of x86-64 that arise out of its legacy support for the styles of programs written in the early days of microprocessors, when much of the code was written manually and where programmers had to struggle with the limited range of addresses allowed by 16-bit machines.</p>
</section>
</section>
<!--EOF:P7000497027000000000000000001E06-->
<!--EOF:P7000497027000000000000000001E38-->
<!--EOF:P7000497027000000000000000001EF2-->
<!--EOF:P7000497027000000000000000001F3C-->
<!--EOF:P7000497027000000000000000002185-->
<!--EOF:P7000497027000000000000000002339-->
<!--EOF:P700049702700000000000000000281F-->
<!--EOF:P7000497027000000000000000002B19-->
<!--EOF:P7000497027000000000000000002CDB-->
<!--EOF:P7000497027000000000000000002E6D-->
<!--EOF:P7000497027000000000000000003080-->
<!--EOF:P70004970270000000000000000032D2-->
<!--EOF:P70004970270000000000000000032D9-->
<!--EOF:P70004970270000000000000000032E1-->
<!--EOF:P700049702700000000000000000344D-->
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.1 A Historical Perspective</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000001E06"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P700049702700000000000000004007D" epub:type="title" id="P700049702700000000000000004007D"><span class="pcalibre1 pcalibre21 pcalibre2">3.1 </span>A Historical Perspective</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004007E" id="P700049702700000000000000004007E">The Intel processor line, colloquially referred to as <i class="pcalibre17 pcalibre2 pcalibre1">x86</i>, has followed a long evolutionary development. It started with one of the first single-chip 16-bit microprocessors, where many compromises had to be made due to the limited capabilities of integrated circuit technology at the time. Since then, it has grown to take advantage <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E1E" epub:type="pagebreak" id="P7000497027000000000000000001E1E" title="167"></span>of technology improvements as well as to satisfy the demands for higher performance and for supporting more advanced operating systems.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004007F" id="P700049702700000000000000004007F">The list that follows shows some models of Intel processors and some of their key features, especially those affecting machine-level programming. We use the number of transistors required to implement the processors as an indication of how they have evolved in complexity. In this table, "K" denotes 1,000 (10<sup class="pcalibre1 pcalibre2 pcalibre85">3</sup>), "M" denotes 1,000,000 (10<sup class="pcalibre1 pcalibre2 pcalibre85">6</sup>), and "G" denotes 1,000,000,000 (10<sup class="pcalibre1 pcalibre2 pcalibre85">9</sup>).</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040080" id="P7000497027000000000000000040080">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040081" id="P7000497027000000000000000040081"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040082" id="P7000497027000000000000000040082"><span class="pcalibre1 pcalibre2 pcalibre41">8086 (1978, 29 K transistors). </span>One of the first single-chip, 16-bit microprocessors. The 8088, a variant of the 8086 with an 8-bit external bus, formed the heart of the original IBM personal computers. IBM contracted with then-tiny Microsoft to develop the MS-DOS operating system. The original models came with 32,768 bytes of memory and two floppy drives (no hard drive). Architecturally, the machines were limited to a 655,360-byte address space—addresses were only 20 bits long (1,048,576 bytes addressable), and the operating system reserved 393,216 bytes for its own use. In 1980, Intel introduced the 8087 floating-point coprocessor (45 K transistors) to operate alongside an 8086 or 8088 processor, executing the floating-point instructions. The 8087 established the floating-point model for the x86 line, often referred to as "x87."</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040083" id="P7000497027000000000000000040083"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040084" id="P7000497027000000000000000040084"><span class="pcalibre1 pcalibre2 pcalibre41">80286 (1982, 134 K transistors). </span>Added more (and now obsolete) addressing modes. Formed the basis of the IBM PC-AT personal computer, the original platform for MS Windows.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040085" id="P7000497027000000000000000040085"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040086" id="P7000497027000000000000000040086"><span class="pcalibre1 pcalibre2 pcalibre41">i386 (1985, 275 K transistors). </span>Expanded the architecture to 32 bits. Added the flat addressing model used by Linux and recent versions of the Windows operating system. This was the first machine in the series that could fully support a Unix operating system.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040087" id="P7000497027000000000000000040087"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040088" id="P7000497027000000000000000040088"><span class="pcalibre1 pcalibre2 pcalibre41">i486 (1989, 1.2 M transistors). </span>Improved performance and integrated the floating-point unit onto the processor chip but did not significantly change the instruction set.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040089" id="P7000497027000000000000000040089"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004008A" id="P700049702700000000000000004008A"><span class="pcalibre1 pcalibre2 pcalibre41">Pentium (1993, 3.1 M transistors). </span>Improved performance but only added minor extensions to the instruction set.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004008B" id="P700049702700000000000000004008B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004008C" id="P700049702700000000000000004008C"><span class="pcalibre1 pcalibre2 pcalibre41">PentiumPro (1995, 5.5 M transistors). </span>Introduced a radically new processor design, internally known as the <i class="pcalibre17 pcalibre2 pcalibre1">P6</i> microarchitecture. Added a class of "conditional move" instructions to the instruction set.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004008D" id="P700049702700000000000000004008D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004008E" id="P700049702700000000000000004008E"><span class="pcalibre1 pcalibre2 pcalibre41">Pentium/MMX (1997, 4.5 M transistors). </span>Added new class of instructions to the Pentium processor for manipulating vectors of integers. Each datum can be 1, 2, or 4 bytes long. Each vector totals 64 bits.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004008F" id="P700049702700000000000000004008F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040090" id="P7000497027000000000000000040090"><span class="pcalibre1 pcalibre2 pcalibre41">Pentium II (1997, 7 M transistors). </span>Continuation of the P6 microarchitecture.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040091" id="P7000497027000000000000000040091"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040092" id="P7000497027000000000000000040092"><span class="pcalibre1 pcalibre2 pcalibre41">Pentium III (1999, 8.2 M transistors). </span>Introduced SSE, a class of instructions for manipulating vectors of integer or floating-point data. Each datum can be 1, 2, or 4 bytes, packed into vectors of 128 bits. Later versions of this chip <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E30" epub:type="pagebreak" id="P7000497027000000000000000001E30" title="168"></span>went up to 24 M transistors, due to the incorporation of the level-2 cache on chip.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040093" id="P7000497027000000000000000040093"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040094" id="P7000497027000000000000000040094"><span class="pcalibre1 pcalibre2 pcalibre41">Pentium 4 (2000, 42 M transistors). </span>Extended SSE to SSE2, adding new data types (including double-precision floating point), along with 144 new instructions for these formats. With these extensions, compilers can use SSE instructions, rather than x87 instructions, to compile floating-point code.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040095" id="P7000497027000000000000000040095"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040096" id="P7000497027000000000000000040096"><span class="pcalibre1 pcalibre2 pcalibre41">Pentium 4E (2004, 125 M transistors). </span>Added <i class="pcalibre17 pcalibre2 pcalibre1">hyperthreading</i>, a method to run two programs simultaneously on a single processor, as well as EM64T, Intel's implementation of a 64-bit extension to IA32 developed by Advanced Micro Devices (AMD), which we refer to as x86-64.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040097" id="P7000497027000000000000000040097"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040098" id="P7000497027000000000000000040098"><span class="pcalibre1 pcalibre2 pcalibre41">Core 2 (2006, 291 M transistors). </span>Returned to a microarchitecture similar to P6. First <i class="pcalibre17 pcalibre2 pcalibre1">multi-core</i> Intel microprocessor, where multiple processors are implemented on a single chip. Did not support hyperthreading.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040099" id="P7000497027000000000000000040099"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004009A" id="P700049702700000000000000004009A"><span class="pcalibre1 pcalibre2 pcalibre41">Core i7, Nehalem (2008, 781 M transistors). </span>Incorporated both hyperthreading and multi-core, with the initial version supporting two executing programs on each core and up to four cores on each chip.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004009B" id="P700049702700000000000000004009B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004009C" id="P700049702700000000000000004009C"><span class="pcalibre1 pcalibre2 pcalibre41">Core i7, Sandy Bridge (2011, 1.17 G transistors). </span>Introduced AVX, an extension of the SSE to support data packed into 256-bit vectors.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004009D" id="P700049702700000000000000004009D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004009E" id="P700049702700000000000000004009E"><span class="pcalibre1 pcalibre2 pcalibre41">Core i7, Haswell (2013, 1.4 G transistors). </span>Extended AVX to AVX2, adding more instructions and instruction formats.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004009F" id="P700049702700000000000000004009F">Each successive processor has been designed to be backward compatible—able to run code compiled for any earlier version. As we will see, there are many strange artifacts in the instruction set due to this evolutionary heritage. Intel has had several names for their processor line, including <i class="pcalibre17 pcalibre2 pcalibre1">IA32</i>, for "Intel Architecture 32-bit" and most recently <i class="pcalibre17 pcalibre2 pcalibre1">Intel64</i>, the 64-bit extension to IA32, which we will refer to as <i class="pcalibre17 pcalibre2 pcalibre1">x86-64</i>. We will refer to the overall line by the commonly used colloquial name "x86," reflecting the processor naming conventions up through the i486.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400A0" id="P70004970270000000000000000400A0">Over the years, several companies have produced processors that are compatible with Intel processors, capable of running the exact same machine-level programs. Chief among these is Advanced Micro Devices (AMD). For years, AMD lagged just behind Intel in technology, forcing a marketing strategy where they produced processors that were less expensive although somewhat lower in performance. They became more competitive around 2002, being the first to break the 1-gigahertz clock-speed barrier for a commercially available microprocessor, and introducing x86-64, the widely adopted 64-bit extension to Intel's IA32. Although we will talk about Intel processors, our presentation holds just as well for the compatible processors produced by Intel's rivals.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400A1" id="P70004970270000000000000000400A1">Much of the complexity of x86 is not of concern to those interested in programs for the Linux operating system as generated by the <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>compiler. The memory model provided in the original 8086 and its extensions in the 80286 became obsolete with the i386. The original x87 floating-point instructions became obsolete</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000001E2E" id="P7000497027000000000000000001E2E"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P70004970270000000000000000400A2" epub:type="title" id="P70004970270000000000000000400A2"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E32" epub:type="pagebreak" id="P7000497027000000000000000001E32" title="169"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Moore's Law</h1></header>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000001E31" id="P7000497027000000000000000001E31">
<img alt="A graph of Intel microprocessor complexity shows an increase in transistors over time, between 1975 and 2015." class="calibre22 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6AE" id="P70004970270000000000000000400A3" src="Images/chapter-03-image-01.png"/>
</figure>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000400A4" id="P70004970270000000000000000400A4">If we plot the number of transistors in the different Intel processors versus the year of introduction, and use a logarithmic scale for the <var class="pcalibre17 pcalibre2 pcalibre1">y</var>-axis, we can see that the growth has been phenomenal. Fitting a line through the data, we see that the number of transistors increases at an annual rate of approximately 37%, meaning that the number of transistors doubles about every 26 months. This growth has been sustained over the multiple-decade history of x86 microprocessors.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000400A5" id="P70004970270000000000000000400A5">In 1965, Gordon Moore, a founder of Intel Corporation, extrapolated from the chip technology of the day (by which they could fabricate circuits with around 64 transistors on a single chip) to predict that the number of transistors per chip would double every year for the next 10 years. This prediction became known as <i class="pcalibre17 pcalibre2 pcalibre1">Moore's Law</i>. As it turns out, his prediction was just a little bit optimistic, but also too short-sighted. Over more than 50 years, the semiconductor industry has been able to double transistor counts on average every 18 months.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000400A6" id="P70004970270000000000000000400A6">Similar exponential growth rates have occurred for other aspects of computer technology, including the storage capacities of magnetic disks and semiconductor memories. These remarkable growth rates have been the major driving forces of the computer revolution.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400A7" id="P70004970270000000000000000400A7">with the introduction of SSE2. Although we see vestiges of the historical evolution of x86 in x86-64 programs, many of the most arcane features of x86 do not appear.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.2 Program Encodings</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000001E38"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P70004970270000000000000000400A8" epub:type="title" id="P70004970270000000000000000400A8"><span class="pcalibre1 pcalibre21 pcalibre2">3.2 </span>Program Encodings</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400A9" id="P70004970270000000000000000400A9">Suppose we write a C program as two files <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400AA" id="P70004970270000000000000000400AA">p1.c</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400AB" id="P70004970270000000000000000400AB">p2.c.</code> We can then compile this code using a Unix command line:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400AC" id="P70004970270000000000000000400AC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400AD" id="P70004970270000000000000000400AD">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E3F" epub:type="pagebreak" id="P7000497027000000000000000001E3F" title="170"></span>linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Og -o p p1.c p2.c</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400AE" id="P70004970270000000000000000400AE">The command <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400AF" id="P70004970270000000000000000400AF">gcc</code> indicates the <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>C compiler. Since this is the default compiler on Linux, we could also invoke it as simply <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B0" id="P70004970270000000000000000400B0">cc</code>. The command-line option –<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B1" id="P70004970270000000000000000400B1">0g</code><a class="pcalibre1 pcalibre2 pcalibre56 pcalibre16 pcalibre14 pcalibre15" epub:type="noteref" href="#P7000497027000000000000000003A68" id="r__P7000497027000000000000000003A68"><sup class="pcalibre1 pcalibre2 calibre8">1</sup></a> instructs the compiler to apply a level of optimization that yields machine code that follows the overall structure of the original C code. Invoking higher levels of optimization can generate code that is so heavily transformed that the relationship between the generated machine code and the original source code is difficult to understand. We will therefore use –<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B2" id="P70004970270000000000000000400B2">0g</code> optimization as a learning tool and then see what happens as we increase the level of optimization. In practice, higher levels of optimization (e.g., specified with the option –<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B3" id="P70004970270000000000000000400B3">01</code> or –<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B4" id="P70004970270000000000000000400B4">02</code>) are considered a better choice in terms of the resulting program performance.</p><aside class="pcalibre2 pcalibre32 pcalibre57" data-uri="chapter03.xhtml#P7000497027000000000000000003A68" epub:type="footnote" id="P7000497027000000000000000003A68"><p class="pcalibre1 pcalibre2 pcalibre10"><span class="pcalibre1 pcalibre58 pcalibre2"><a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="#r__P7000497027000000000000000003A68">1. </a></span>This optimization level was introduced in <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>version 4.8. Earlier versions of <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>, as well as non-GNU compilers, will not recognize this option. For these, using optimization level one (specified with the command-line flag <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041C30" id="P7000497027000000000000000041C30">-O1</code>) is probably the best choice for generating code that follows the original program structure.</p></aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B5" id="P70004970270000000000000000400B5">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B6" id="P70004970270000000000000000400B6">gcc</code> command invokes an entire sequence of programs to turn the source code into executable code. First, the C <i class="pcalibre17 pcalibre2 pcalibre1">preprocessor</i> expands the source code to include any files specified with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B7" id="P70004970270000000000000000400B7">#include</code> commands and to expand any macros, specified with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B8" id="P70004970270000000000000000400B8">#define</code> declarations. Second, the <i class="pcalibre17 pcalibre2 pcalibre1">compiler</i> generates assembly-code versions of the two source files having names <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400B9" id="P70004970270000000000000000400B9">p1.s</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400BA" id="P70004970270000000000000000400BA">p2.s.</code> Next, the <i class="pcalibre17 pcalibre2 pcalibre1">assembler</i> converts the assembly code into binary <i class="pcalibre17 pcalibre2 pcalibre1">object-code</i> files <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400BB" id="P70004970270000000000000000400BB">p1.o</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400BC" id="P70004970270000000000000000400BC">p2.o.</code> Object code is one form of machine code—it contains binary representations of all of the instructions, but the addresses of global values are not yet filled in. Finally, the <i class="pcalibre17 pcalibre2 pcalibre1">linker</i> merges these two object-code files along with code implementing library functions (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400BD" id="P70004970270000000000000000400BD">printf</code>) and generates the final executable code file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400BE" id="P70004970270000000000000000400BE">p</code> (as specified by the command-line directive <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400BF" id="P70004970270000000000000000400BF">-o p</code>). Executable code is the second form of machine code we will consider—it is the exact form of code that is executed by the processor. The relation between these different forms of machine code and the linking process is described in more detail in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000005FB4.xhtml#P7000497027000000000000000005FB4"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">7</span></a>.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000001E52" id="P7000497027000000000000000001E52"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400C0" epub:type="title" id="P70004970270000000000000000400C0"><span class="pcalibre1 pcalibre21 pcalibre2">3.2.1 </span>Machine-Level Code</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400C1" id="P70004970270000000000000000400C1">As described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000001FF.xhtml#P7000497027000000000000000000248"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">1.9.3</span></a>, computer systems employ several different forms of abstraction, hiding details of an implementation through the use of a simpler abstract model. Two of these are especially important for machine-level programming. First, the format and behavior of a machine-level program is defined by the <i class="pcalibre17 pcalibre2 pcalibre1">instruction set architecture</i>, or ISA, defining the processor state, the format of the instructions, and the effect each of these instructions will have on the state. Most ISAs, including x86-64, describe the behavior of a program as if each instruction is executed in sequence, with one instruction completing before the next one begins. The processor hardware is far more elaborate, executing many instructions concurrently, but it employs safeguards to ensure that the overall behavior matches the sequential operation dictated by the ISA. Second, the memory addresses used by a machine-level program are <i class="pcalibre17 pcalibre2 pcalibre1">virtual addresses</i>, providing a memory model that <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E55" epub:type="pagebreak" id="P7000497027000000000000000001E55" title="171"></span>appears to be a very large byte array. The actual implementation of the memory system involves a combination of multiple hardware memories and operating system software, as described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006FF7.xhtml#P7000497027000000000000000006FF7"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">9</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400C2" id="P70004970270000000000000000400C2">The compiler does most of the work in the overall compilation sequence, transforming programs expressed in the relatively abstract execution model provided by C into the very elementary instructions that the processor executes. The assembly-code representation is very close to machine code. Its main feature is that it is in a more readable textual format, as compared to the binary format of machine code. Being able to understand assembly code and how it relates to the original C code is a key step in understanding how computers execute programs.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400C3" id="P70004970270000000000000000400C3">The machine code for x86-64 differs greatly from the original C code. Parts of the processor state are visible that normally are hidden from the C programmer:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400C4" id="P70004970270000000000000000400C4">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400C5" id="P70004970270000000000000000400C5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000400C6" id="P70004970270000000000000000400C6">The <i class="pcalibre17 pcalibre2 pcalibre1">program counter</i> (commonly referred to as the PC, and called <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400C7" id="P70004970270000000000000000400C7">%rip</code> in x86-64) indicates the address in memory of the next instruction to be executed.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400C8" id="P70004970270000000000000000400C8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000400C9" id="P70004970270000000000000000400C9">The integer <i class="pcalibre17 pcalibre2 pcalibre1">register file</i> contains 16 named locations storing 64-bit values. These registers can hold addresses (corresponding to C pointers) or integer data. Some registers are used to keep track of critical parts of the program state, while others are used to hold temporary data, such as the arguments and local variables of a procedure, as well as the value to be returned by a function.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400CA" id="P70004970270000000000000000400CA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000400CB" id="P70004970270000000000000000400CB">The condition code registers hold status information about the most recently executed arithmetic or logical instruction. These are used to implement conditional changes in the control or data flow, such as is required to implement if and while statements.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400CC" id="P70004970270000000000000000400CC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000400CD" id="P70004970270000000000000000400CD">A set of vector registers can each hold one or more integer or floating-point values.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400CE" id="P70004970270000000000000000400CE">Whereas C provides a model in which objects of different data types can be declared and allocated in memory, machine code views the memory as simply a large byte-addressable array. Aggregate data types in C such as arrays and structures are represented in machine code as contiguous collections of bytes. Even for scalar data types, assembly code makes no distinctions between signed or unsigned integers, between different types of pointers, or even between pointers and integers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400CF" id="P70004970270000000000000000400CF">The program memory contains the executable machine code for the program, some information required by the operating system, a run-time stack for managing procedure calls and returns, and blocks of memory allocated by the user (e.g., by using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400D0" id="P70004970270000000000000000400D0">malloc</code> library function). As mentioned earlier, the program memory is addressed using virtual addresses. At any given time, only limited subranges of virtual addresses are considered valid. For example, x86-64 virtual addresses are represented by 64-bit words. In current implementations of these machines, the upper 16 bits must be set to zero, and so an address can potentially specify a byte over a range of 2<sup class="pcalibre1 pcalibre2 pcalibre85">48</sup>, or 64 terabytes. More typical programs will only have access to a few megabytes, or perhaps several gigabytes. The operating system manages</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000001E65" id="P7000497027000000000000000001E65"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P70004970270000000000000000400D1" epub:type="title" id="P70004970270000000000000000400D1"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E67" epub:type="pagebreak" id="P7000497027000000000000000001E67" title="172"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>The ever-changing forms of generated code</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000400D2" id="P70004970270000000000000000400D2">In our presentation, we will show the code generated by a particular version of <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>with particular settings of the command-line options. If you compile code on your own machine, chances are you will be using a different compiler or a different version of <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>and hence will generate different code. The open-source community supporting <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>keeps changing the code generator, attempting to generate more efficient code according to changing code guidelines provided by the microprocessor manufacturers.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000400D3" id="P70004970270000000000000000400D3">Our goal in studying the examples shown in our presentation is to demonstrate how to examine assembly code and map it back to the constructs found in high-level programming languages. You will need to adapt these techniques to the style of code generated by your particular compiler.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400D4" id="P70004970270000000000000000400D4">this virtual address space, translating virtual addresses into the physical addresses of values in the actual processor memory.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400D5" id="P70004970270000000000000000400D5">A single machine instruction performs only a very elementary operation. For example, it might add two numbers stored in registers, transfer data between memory and a register, or conditionally branch to a new instruction address. The compiler must generate sequences of such instructions to implement program constructs such as arithmetic expression evaluation, loops, or procedure calls and returns.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000001E6C" id="P7000497027000000000000000001E6C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400D6" epub:type="title" id="P70004970270000000000000000400D6"><span class="pcalibre1 pcalibre21 pcalibre2">3.2.2 </span>Code Examples</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400D7" id="P70004970270000000000000000400D7">Suppose we write a C code file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400D8" id="P70004970270000000000000000400D8">mstore.c</code> containing the following function definition:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400D9" id="P70004970270000000000000000400D9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400DA" id="P70004970270000000000000000400DA">
long mult2(long, long);

void multstore(long x, long y, long *dest) {
	long t = mult2(x, y);
	*dest = t;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400DB" id="P70004970270000000000000000400DB">To see the assembly code generated by the C compiler, we can use the -S option on the command line:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400DC" id="P70004970270000000000000000400DC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400DD" id="P70004970270000000000000000400DD">
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Og -S mstore.c</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400DE" id="P70004970270000000000000000400DE">This will cause <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>to run the compiler, generating an assembly file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400DF" id="P70004970270000000000000000400DF">mstore.s</code>, and go no further. (Normally it would then invoke the assembler to generate an object-code file.)</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400E0" id="P70004970270000000000000000400E0">The assembly-code file contains various declarations, including the following set of lines:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400E1" id="P70004970270000000000000000400E1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400E2" id="P70004970270000000000000000400E2">
multstore:
	pushq	%rbx
</code></pre>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000001E7A" id="P7000497027000000000000000001E7A"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P70004970270000000000000000400E3" epub:type="title" id="P70004970270000000000000000400E3"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E7C" epub:type="pagebreak" id="P7000497027000000000000000001E7C" title="173"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>How do I display the byte representation of a program?</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000400E4" id="P70004970270000000000000000400E4">To display the binary object code for a program (say, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400E5" id="P70004970270000000000000000400E5">mstore</code>), we use a <i class="pcalibre17 pcalibre2 pcalibre1">disassembler</i> (described below) to determine that the code for the procedure is 14 bytes long. Then we run the GNU debugging tool <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>on file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400E6" id="P70004970270000000000000000400E6">mstore.o</code> and give it the command</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400E7" id="P70004970270000000000000000400E7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400E8" id="P70004970270000000000000000400E8">
(gdb) <i class="pcalibre17 pcalibre2 pcalibre1">x/14xb multstore</i>
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000400E9" id="P70004970270000000000000000400E9">telling it to display (abbreviated `x') 14 hex-formatted (also `x') bytes (`b') starting at the address where function multstore is located. You will find that <span class="pcalibre1 pcalibre29 pcalibre2">gdb</span> has many useful features for analyzing machine-level programs, as will be discussed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000002EC0"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10.2</span></a>.</p>
</aside>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400EA" id="P70004970270000000000000000400EA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400EB" id="P70004970270000000000000000400EB">
movq	%rdx, %rbx
call	mult2
movq	%rax, (%rbx)
popq	%rbx
ret	
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400EC" id="P70004970270000000000000000400EC">Each indented line in the code corresponds to a single machine instruction. For example, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400ED" id="P70004970270000000000000000400ED">pushq</code> instruction indicates that the contents of register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400EE" id="P70004970270000000000000000400EE">%rbx</code> should be pushed onto the program stack. All information about local variable names or data types has been stripped away.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400EF" id="P70004970270000000000000000400EF">If we use the -c command-line option, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>will both compile and assemble the code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400F0" id="P70004970270000000000000000400F0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400F1" id="P70004970270000000000000000400F1">
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Og -c mstore.c</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400F2" id="P70004970270000000000000000400F2">This will generate an object-code file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400F3" id="P70004970270000000000000000400F3">mstore.o</code> that is in binary format and hence cannot be viewed directly. Embedded within the 1,368 bytes of the file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400F4" id="P70004970270000000000000000400F4">mstore.o</code> is a 14-byte sequence with the hexadecimal representation</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400F5" id="P70004970270000000000000000400F5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400F6" id="P70004970270000000000000000400F6">
53 48 89 d3 e8 00 00 00 00 48 89 03 5b c3
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400F7" id="P70004970270000000000000000400F7">This is the object code corresponding to the assembly instructions listed previously. A key lesson to learn from this is that the program executed by the machine is simply a sequence of bytes encoding a series of instructions. The machine has very little information about the source code from which these instructions were generated.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400F8" id="P70004970270000000000000000400F8">To inspect the contents of machine-code files, a class of programs known as <i class="pcalibre17 pcalibre2 pcalibre1">disassemblers</i> can be invaluable. These programs generate a format similar to assembly code from the machine code. With Linux systems, the program <span class="pcalibre1 pcalibre29 pcalibre2">objdump </span>(for "object dump") can serve this role given the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400F9" id="P70004970270000000000000000400F9">-d</code> command-line flag:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400FA" id="P70004970270000000000000000400FA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400FB" id="P70004970270000000000000000400FB">
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">objdump -d mstore.o</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400FC" id="P70004970270000000000000000400FC">The result (where we have added line numbers on the left and annotations in italicized text) is as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000400FD" id="P70004970270000000000000000400FD">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001E97" epub:type="pagebreak" id="P7000497027000000000000000001E97" title="174"></span><b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Disassembly of function</i></b> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400FE" id="P70004970270000000000000000400FE">sum</code> <b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">in binary file</i></b> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000400FF" id="P70004970270000000000000000400FF">mstore.o</code>
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040100" id="P7000497027000000000000000040100">
1	0000000000000000 &lt;multstore&gt;:
</code></pre>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040101" id="P7000497027000000000000000040101">    <i class="pcalibre17 pcalibre2 pcalibre1">Offset</i>   <i class="pcalibre17 pcalibre2 pcalibre1">Bytes</i>		<i class="pcalibre17 pcalibre2 pcalibre1">Equivalent assembly language</i>
<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040102" id="P7000497027000000000000000040102">
2	0:	53			push	%rbx
3	1:	48 89 d3		mov	%rdx,%rbx
4	4:	e8 00 00 00 00		callq	9 &lt;multstore+0x9&gt;
5	9:	48 89 03		mov	%rax,(%rbx)
6	c:	5b			pop	%rbx
7	d:	c3			retq	
</code>
</pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040103" id="P7000497027000000000000000040103">On the left we see the 14 hexadecimal byte values, listed in the byte sequence shown earlier, partitioned into groups of 1 to 5 bytes each. Each of these groups is a single instruction, with the assembly-language equivalent shown on the right.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040104" id="P7000497027000000000000000040104">Several features about machine code and its disassembled representation are worth noting:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040105" id="P7000497027000000000000000040105">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040106" id="P7000497027000000000000000040106"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040107" id="P7000497027000000000000000040107">x86-64 instructions can range in length from 1 to 15 bytes. The instruction encoding is designed so that commonly used instructions and those with fewer operands require a smaller number of bytes than do less common ones or ones with more operands.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040108" id="P7000497027000000000000000040108"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040109" id="P7000497027000000000000000040109">The instruction format is designed in such a way that from a given starting position, there is a unique decoding of the bytes into machine instructions. For example, only the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004010A" id="P700049702700000000000000004010A">pushq %rbx</code> can start with byte value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004010B" id="P700049702700000000000000004010B">53</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004010C" id="P700049702700000000000000004010C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004010D" id="P700049702700000000000000004010D">The disassembler determines the assembly code based purely on the byte sequences in the machine-code file. It does not require access to the source or assembly-code versions of the program.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004010E" id="P700049702700000000000000004010E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004010F" id="P700049702700000000000000004010F">The disassembler uses a slightly different naming convention for the instructions than does the assembly code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>. In our example, it has omitted the suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040110" id="P7000497027000000000000000040110">q</code>' from many of the instructions. These suffixes are size designators and can be omitted in most cases. Conversely, the disassembler adds the suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040111" id="P7000497027000000000000000040111">q</code>' to the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040112" id="P7000497027000000000000000040112">call</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040113" id="P7000497027000000000000000040113">ret</code> instructions. Again, these suffixes can safely be omitted.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040114" id="P7000497027000000000000000040114">Generating the actual executable code requires running a linker on the set of object-code files, one of which must contain a function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040115" id="P7000497027000000000000000040115">main</code>. Suppose in file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040116" id="P7000497027000000000000000040116">main.c</code> we had the following function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040117" id="P7000497027000000000000000040117"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040118" id="P7000497027000000000000000040118">
#include &lt;stdio.h&gt;

void multstore(long, long, long *);

int main() {
	long d;
	multstore(2, 3, &amp;d);
	printf("2 * 3 –&gt; %ld\n", d);
	return 0;
}

<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001EB3" epub:type="pagebreak" id="P7000497027000000000000000001EB3" title="175"></span>long mult2(long a, long b) {
	long s = a * b;
	return s;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040119" id="P7000497027000000000000000040119">Then we could generate an executable program prog as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004011A" id="P700049702700000000000000004011A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004011B" id="P700049702700000000000000004011B">
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Og -o prog main.c mstore.c</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004011C" id="P700049702700000000000000004011C">The file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004011D" id="P700049702700000000000000004011D">prog</code> has grown to 8,655 bytes, since it contains not just the machine code for the procedures we provided but also code used to start and terminate the program as well as to interact with the operating system.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004011E" id="P700049702700000000000000004011E">We can disassemble the file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004011F" id="P700049702700000000000000004011F">prog:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040120" id="P7000497027000000000000000040120"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040121" id="P7000497027000000000000000040121">
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">objdump -d prog</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040122" id="P7000497027000000000000000040122">The disassembler will extract various code sequences, including the following:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040123" id="P7000497027000000000000000040123"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040124" id="P7000497027000000000000000040124"><i class="pcalibre17 pcalibre2 pcalibre1">Disassembly of function</i> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040125" id="P7000497027000000000000000040125">sum</code> <i class="pcalibre17 pcalibre2 pcalibre1">in binary file</i> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040126" id="P7000497027000000000000000040126">prog</code>
1 0000000000400540 &lt;multstore&gt;:
2	400540:	53			push	%rbx
3	400541:	48 89 d3		mov	%rdx,%rbx
4	400544:	e8 42 00 00 00		callq	40058b &lt;mult2&gt;
5	400549:	48 89 03		mov	%rax,(%rbx)
6	40054c:	5b			pop	%rbx
7	40054d:	c3			retq	
8	40054e:	90			nop	
9	40054f:	90			nop	
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040127" id="P7000497027000000000000000040127">This code is almost identical to that generated by the disassembly of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040128" id="P7000497027000000000000000040128">mstore.c.</code> One important difference is that the addresses listed along the left are different—the linker has shifted the location of this code to a different range of addresses. A second difference is that the linker has filled in the address that the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040129" id="P7000497027000000000000000040129">callq</code> instruction should use in calling the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004012A" id="P700049702700000000000000004012A">mult2</code> (line 4 of the disassembly). One task for the linker is to match function calls with the locations of the executable code for those functions. A final difference is that we see two additional lines of code (lines 8-9). These instructions will have no effect on the program, since they occur after the return instruction (line 7). They have been inserted to grow the code for the function to 16 bytes, enabling a better placement of the next block of code in terms of memory system performance.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000001EC6" id="P7000497027000000000000000001EC6"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004012B" epub:type="title" id="P700049702700000000000000004012B"><span class="pcalibre1 pcalibre21 pcalibre2">3.2.3 </span>Notes on Formatting</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004012C" id="P700049702700000000000000004012C">The assembly code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>is difficult for a human to read. On one hand, it contains information with which we need not be concerned, while on the other hand, it does not provide any description of the program or how it works. For example, suppose we give the command</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004012D" id="P700049702700000000000000004012D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004012E" id="P700049702700000000000000004012E">
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Og -S mstore.c</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004012F" id="P700049702700000000000000004012F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001ECC" epub:type="pagebreak" id="P7000497027000000000000000001ECC" title="176"></span>to generate the file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040130" id="P7000497027000000000000000040130">mstore.s.</code> The full content of the file is as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040131" id="P7000497027000000000000000040131"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040132" id="P7000497027000000000000000040132">
	.file	"010–mstore.c"
	.text
	.globl	multstore
	.type	multstore, @function
multstore:
	pushq	%rbx
	movq	%rdx, %rbx
	call	mult2
	movq	%rax, (%rbx)
	popq	%rbx
	ret
	.size	multstore, .–multstore
	.ident	"GCC: (Ubuntu 4.8.1–2ubuntu1~12.04) 4.8.1"
	.section		.note.GNU-stack,"",@progbits
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040133" id="P7000497027000000000000000040133">All of the lines beginning with `.' are directives to guide the assembler and linker. We can generally ignore these. On the other hand, there are no explanatory remarks about what the instructions do or how they relate to the source code.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040134" id="P7000497027000000000000000040134">To provide a clearer presentation of assembly code, we will show it in a form that omits most of the directives, while including line numbers and explanatory annotations. For our example, an annotated version would appear as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040135" id="P7000497027000000000000000040135"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040136" id="P7000497027000000000000000040136">
	<i class="pcalibre17 pcalibre2 pcalibre1">void multstore(long x, long y, long *dest)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, dest in %rdx</i>
1	multstore:
2	pushq	%rbx		<i class="pcalibre17 pcalibre2 pcalibre1">Save %rbx</i>
3	movq	%rdx, %rbx	<i class="pcalibre17 pcalibre2 pcalibre1">Copy dest to %rbx</i>
4	call	mult2		<i class="pcalibre17 pcalibre2 pcalibre1">Call mult2(x, y)</i>
5	movq	%rax, (%rbx)	<i class="pcalibre17 pcalibre2 pcalibre1">Store result at *dest</i>
6	popq	%rbx		<i class="pcalibre17 pcalibre2 pcalibre1">Restore %rbx</i>
7	ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040137" id="P7000497027000000000000000040137">We typically show only the lines of code relevant to the point being discussed. Each line is numbered on the left for reference and annotated on the right by a brief description of the effect of the instruction and how it relates to the computations of the original C code. This is a stylized version of the way assembly-language programmers format their code.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040138" id="P7000497027000000000000000040138">We also provide Web asides to cover material intended for dedicated machine-language enthusiasts. One Web aside describes IA32 machine code. Having a background in x86-64 makes learning IA32 fairly simple. Another Web aside gives a brief presentation of ways to incorporate assembly code into C programs. For some applications, the programmer must drop down to assembly code to access low-level features of the machine. One approach is to write entire functions in assembly code and combine them with C functions during the linking stage. A</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000001ED6" id="P7000497027000000000000000001ED6"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P7000497027000000000000000040139" epub:type="title" id="P7000497027000000000000000040139"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001ED8" epub:type="pagebreak" id="P7000497027000000000000000001ED8" title="177"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>ATT versus Intel assembly-code formats</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004013A" id="P700049702700000000000000004013A">In our presentation, we show assembly code in ATT format (named after AT&amp;T, the company that operated Bell Laboratories for many years), the default format for <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>, <span class="pcalibre1 pcalibre29 pcalibre2">objdump</span>, and the other tools we will consider. Other programming tools, including those from Microsoft as well as the documentation from Intel, show assembly code in <i class="pcalibre17 pcalibre2 pcalibre1">Intel</i> format. The two formats differ in a number of ways. As an example, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>can generate code in Intel format for the sum function using the following command line:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004013B" id="P700049702700000000000000004013B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004013C" id="P700049702700000000000000004013C">
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Og -S -masm=intel mstore.c</i>
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004013D" id="P700049702700000000000000004013D">This gives the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004013E" id="P700049702700000000000000004013E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004013F" id="P700049702700000000000000004013F">
multstore:
	push	rbx
	mov	rbx, rdx
	call	mult2
	mov	QWORD PTR [rbx], rax
	pop	rbx
	ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040140" id="P7000497027000000000000000040140">We see that the Intel and ATT formats differ in the following ways:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040141" id="P7000497027000000000000000040141">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040142" id="P7000497027000000000000000040142"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040143" id="P7000497027000000000000000040143">The Intel code omits the size designation suffixes. We see instruction push and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040144" id="P7000497027000000000000000040144">mov</code> instead of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040145" id="P7000497027000000000000000040145">pushq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040146" id="P7000497027000000000000000040146">movq</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040147" id="P7000497027000000000000000040147"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040148" id="P7000497027000000000000000040148">The Intel code omits the `%' character in front of register names, using <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040149" id="P7000497027000000000000000040149">rbx</code> instead of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004014A" id="P700049702700000000000000004014A">%rbx</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004014B" id="P700049702700000000000000004014B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004014C" id="P700049702700000000000000004014C">The Intel code has a different way of describing locations in memory—for example, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004014D" id="P700049702700000000000000004014D">QWORD PTR [rbx]</code> rather than <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004014E" id="P700049702700000000000000004014E">(%rbx)</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004014F" id="P700049702700000000000000004014F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040150" id="P7000497027000000000000000040150">Instructions with multiple operands list them in the reverse order. This can be very confusing when switching between the two formats.</p></li>
</ul>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040151" id="P7000497027000000000000000040151">Although we will not be using Intel format in our presentation, you will encounter it in documentation from Intel and Microsoft.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040152" id="P7000497027000000000000000040152">second is to use <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>'s support for embedding assembly code directly within C programs.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.3 Data Formats</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000001EF2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040153" epub:type="title" id="P7000497027000000000000000040153"><span class="pcalibre1 pcalibre21 pcalibre2">3.3 </span>Data Formats</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040154" id="P7000497027000000000000000040154">Due to its origins as a 16-bit architecture that expanded into a 32-bit one, Intel uses the term "word" to refer to a 16-bit data type. Based on this, they refer to 32-bit quantities as "double words," and 64-bit quantities as "quad words." <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001EFD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1</span></a> shows the x86-64 representations used for the primitive data types of C. Standard <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040155" id="P7000497027000000000000000040155">int</code> values are stored as double words (32 bits). Pointers (shown here as char *) are stored as 8-byte quad words, as would be expected in a 64-bit machine. With x86-64, data type long is implemented with 64 bits, allowing a very wide range of values. Most of our code examples in this chapter use pointers and long data</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000001EF6" id="P7000497027000000000000000001EF6"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P7000497027000000000000000040156" epub:type="title" id="P7000497027000000000000000040156"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001EF8" epub:type="pagebreak" id="P7000497027000000000000000001EF8" title="178"></span><span class="pcalibre1 pcalibre2 pcalibre34">Web Aside ASM:EASM </span>Combining assembly code with C programs</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040157" id="P7000497027000000000000000040157">Although a C compiler does a good job of converting the computations expressed in a program into machine code, there are some features of a machine that cannot be accessed by a C program. For example, every time an x86-64 processor executes an arithmetic or logical operation, it sets a 1-bit <i class="pcalibre17 pcalibre2 pcalibre1">condition code</i> flag, named <span class="pcalibre1 pcalibre29 pcalibre2">pf </span>(for "parity flag"), to 1 when the lower 8 bits in the resulting computation have an even number of ones and to 0 otherwise. Computing this information in C requires at least seven shifting, masking, and <span class="pcalibre1 pcalibre29 pcalibre2">exclusive-or </span>operations (see <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001498.xhtml#P7000497027000000000000000001543"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">2.65</span></a>). Even though the hardware performs this computation as part of every arithmetic or logical operation, there is no way for a C program to determine the value of the <span class="pcalibre1 pcalibre29 pcalibre2">pf </span>condition code flag. This task can readily be performed by incorporating a small number of assembly-code instructions into the program.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040158" id="P7000497027000000000000000040158">There are two ways to incorporate assembly code into C programs. First, we can write an entire function as a separate assembly-code file and let the assembler and linker combine this with code we have written in C. Second, we can use the <i class="pcalibre17 pcalibre2 pcalibre1">inline assembly</i> feature of <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>, where brief sections of assembly code can be incorporated into a C program using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040159" id="P7000497027000000000000000040159">asm</code> directive. This approach has the advantage that it minimizes the amount of machine-specific code.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004015A" id="P700049702700000000000000004015A">Of course, including assembly code in a C program makes the code specific to a particular class of machines (such as x86-64), and so it should only be used when the desired feature can only be accessed in this way.</p>
</aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000001EFD" id="P7000497027000000000000000001EFD">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P700049702700000000000000004015B" id="P700049702700000000000000004015B">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004015C" id="P700049702700000000000000004015C">C declaration</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004015D" id="P700049702700000000000000004015D">Intel data type</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004015E" id="P700049702700000000000000004015E">Assembly-code suffix</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004015F" id="P700049702700000000000000004015F">Size (bytes)</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040160" id="P7000497027000000000000000040160"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040161" id="P7000497027000000000000000040161">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040162" id="P7000497027000000000000000040162">Byte</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040163" id="P7000497027000000000000000040163"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040164" id="P7000497027000000000000000040164">b</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040165" id="P7000497027000000000000000040165">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040166" id="P7000497027000000000000000040166"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040167" id="P7000497027000000000000000040167">short</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040168" id="P7000497027000000000000000040168">Word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040169" id="P7000497027000000000000000040169"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004016A" id="P700049702700000000000000004016A">w</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004016B" id="P700049702700000000000000004016B">2</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004016C" id="P700049702700000000000000004016C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004016D" id="P700049702700000000000000004016D">int</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004016E" id="P700049702700000000000000004016E">Double word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004016F" id="P700049702700000000000000004016F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040170" id="P7000497027000000000000000040170">l</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040171" id="P7000497027000000000000000040171">4</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040172" id="P7000497027000000000000000040172"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040173" id="P7000497027000000000000000040173">long</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040174" id="P7000497027000000000000000040174">Quad word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040175" id="P7000497027000000000000000040175"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040176" id="P7000497027000000000000000040176">q</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040177" id="P7000497027000000000000000040177">8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040178" id="P7000497027000000000000000040178"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040179" id="P7000497027000000000000000040179">char</code> *</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004017A" id="P700049702700000000000000004017A">Quad word</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004017B" id="P700049702700000000000000004017B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004017C" id="P700049702700000000000000004017C">q</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004017D" id="P700049702700000000000000004017D">8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004017E" id="P700049702700000000000000004017E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004017F" id="P700049702700000000000000004017F">float</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040180" id="P7000497027000000000000000040180">Single precision</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040181" id="P7000497027000000000000000040181"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040182" id="P7000497027000000000000000040182">s</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040183" id="P7000497027000000000000000040183">4</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040184" id="P7000497027000000000000000040184"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040185" id="P7000497027000000000000000040185">double</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040186" id="P7000497027000000000000000040186">Double precision</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040187" id="P7000497027000000000000000040187"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040188" id="P7000497027000000000000000040188">l</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040189" id="P7000497027000000000000000040189">8</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P700049702700000000000000004018A" id="P700049702700000000000000004018A"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P700049702700000000000000004018B" epub:type="title" id="P700049702700000000000000004018B"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.1 </span>Sizes of C data types in x86-64.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004018C" id="P700049702700000000000000004018C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004018D" id="P700049702700000000000000004018D">With a 64-bit machine, pointers are 8 bytes long.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004018E" id="P700049702700000000000000004018E">types, and so they will operate on quad words. The x86-64 instruction set includes a full complement of instructions for bytes, words, and double words as well.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004018F" id="P700049702700000000000000004018F">Floating-point numbers come in two principal formats: single-precision (4-byte) values, corresponding to C data type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040190" id="P7000497027000000000000000040190">float</code>, and double-precision (8-byte) values, corresponding to C data type double. Microprocessors in the x86 family historically implemented all floating-point operations with a special 80-bit (10-byte) floating-point format (see <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001498.xhtml#P700049702700000000000000000167D"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">2.86</span></a>). This format can be specified in C programs using the declaration long double. We recommend against using this format, however. It is not portable to other classes of machines, and it is typically <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001F34" epub:type="pagebreak" id="P7000497027000000000000000001F34" title="179"></span>not implemented with the same high-performance hardware as is the case for single- and double-precision arithmetic.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040191" id="P7000497027000000000000000040191">As the table of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001EFD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1</span></a> indicates, most assembly-code instructions generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>have a single-character suffix denoting the size of the operand. For example, the data movement instruction has four variants: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040192" id="P7000497027000000000000000040192">movb</code> (move byte), <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040193" id="P7000497027000000000000000040193">movw</code> (move word), <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040194" id="P7000497027000000000000000040194">movl</code> (move double word), and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040195" id="P7000497027000000000000000040195">movq</code> (move quad word). The suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040196" id="P7000497027000000000000000040196">l</code>' is used for double words, since 32-bit quantities are considered to be "long words." The assembly code uses the suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040197" id="P7000497027000000000000000040197">l</code>' to denote a 4-byte integer as well as an 8-byte double-precision floating-point number. This causes no ambiguity, since floating-point code involves an entirely different set of instructions and registers.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.4 Accessing Information</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000001F3C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040198" epub:type="title" id="P7000497027000000000000000040198"><span class="pcalibre1 pcalibre21 pcalibre2">3.4 </span>Accessing Information</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040199" id="P7000497027000000000000000040199">An x86-64 central processing unit (CPU) contains a set of 16 <i class="pcalibre17 pcalibre2 pcalibre1">general-purpose registers</i> storing 64-bit values. These registers are used to store integer data as well as pointers. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001F4C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.2</span></a> diagrams the 16 registers. Their names all begin with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004019A" id="P700049702700000000000000004019A">%r</code>, but otherwise follow multiple different naming conventions, owing to the historical evolution of the instruction set. The original 8086 had eight 16-bit registers, shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001F4C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.2</span></a> as registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004019B" id="P700049702700000000000000004019B">%ax</code> through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004019C" id="P700049702700000000000000004019C">%bp</code>. Each had a specific purpose, and hence they were given names that reflected how they were to be used. With the extension to IA32, these registers were expanded to 32-bit registers, labeled <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004019D" id="P700049702700000000000000004019D">%eax</code> through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004019E" id="P700049702700000000000000004019E">%ebp</code>. In the extension to x86-64, the original eight registers were expanded to 64 bits, labeled <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004019F" id="P700049702700000000000000004019F">%rax</code> through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000401A0" id="P70004970270000000000000000401A0">%rbp</code>. In addition, eight new registers were added, and these were given labels according to a new naming convention: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000401A1" id="P70004970270000000000000000401A1">%r8</code> through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000401A2" id="P70004970270000000000000000401A2">%r15</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000401A3" id="P70004970270000000000000000401A3">As the nested boxes in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001F4C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.2</span></a> indicate, instructions can operate on data of different sizes stored in the low-order bytes of the 16 registers. Byte-level operations can access the least significant byte, 16-bit operations can access the least significant 2 bytes, 32-bit operations can access the least significant 4 bytes, and 64-bit operations can access entire registers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000401A4" id="P70004970270000000000000000401A4">In later sections, we will present a number of instructions for copying and generating 1-, 2-, 4-, and 8-byte values. When these instructions have registers as destinations, two conventions arise for what happens to the remaining bytes in the register for instructions that generate less than 8 bytes: Those that generate 1-or 2-byte quantities leave the remaining bytes unchanged. Those that generate 4-byte quantities set the upper 4 bytes of the register to zero. The latter convention was adopted as part of the expansion from IA32 to x86-64.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000401A5" id="P70004970270000000000000000401A5">As the annotations along the right-hand side of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001F4C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.2</span></a> indicate, different registers serve different roles in typical programs. Most unique among them is the stack pointer, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000401A6" id="P70004970270000000000000000401A6">%rsp</code>, used to indicate the end position in the run-time stack. Some instructions specifically read and write this register. The other 15 registers have more flexibility in their uses. A small number of instructions make specific use of certain registers. More importantly, a set of standard programming conventions governs how the registers are to be used for managing the stack, passing function</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000001F4C" id="P7000497027000000000000000001F4C">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001F4D" epub:type="pagebreak" id="P7000497027000000000000000001F4D" title="180"></span>
<img alt="A diagram lists 16 integer registers." class="pcalibre1 pcalibre2 pcalibre121" data-uri="P700049702700000000000000000B6B1" id="P70004970270000000000000000401A7" src="Images/chapter-03-image-02.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P70004970270000000000000000401A8" id="P70004970270000000000000000401A8"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P70004970270000000000000000401A9" epub:type="title" id="P70004970270000000000000000401A9"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.2 </span>Integer registers.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401AA" id="P70004970270000000000000000401AA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000401AB" id="P70004970270000000000000000401AB">The low-order portions of all 16 registers can be accessed as byte, word (16-bit), double word (32-bit), and quad word (64-bit) quantities.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P7000497027000000000000000020490" id="P7000497027000000000000000020490">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000401AC" id="P70004970270000000000000000401AC">A diagram lists 16 registers, each with concentric values within 63, 31, 16, and 7, as summarized in the following table.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000401AD" id="P70004970270000000000000000401AD">
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401AE" id="P70004970270000000000000000401AE">Register</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401AF" id="P70004970270000000000000000401AF">7</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B0" id="P70004970270000000000000000401B0">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B1" id="P70004970270000000000000000401B1">31</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B2" id="P70004970270000000000000000401B2">63</td></tr><tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B3" id="P70004970270000000000000000401B3">Return value</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B4" id="P70004970270000000000000000401B4">%al</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B5" id="P70004970270000000000000000401B5">%ax</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B6" id="P70004970270000000000000000401B6">%eax</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B7" id="P70004970270000000000000000401B7">%rax</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B8" id="P70004970270000000000000000401B8">Callee saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401B9" id="P70004970270000000000000000401B9">%bl</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401BA" id="P70004970270000000000000000401BA">%bx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401BB" id="P70004970270000000000000000401BB">%ebx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401BC" id="P70004970270000000000000000401BC">%rbx</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401BD" id="P70004970270000000000000000401BD">4th argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401BE" id="P70004970270000000000000000401BE">%cl</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401BF" id="P70004970270000000000000000401BF">%cx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C0" id="P70004970270000000000000000401C0">%ecx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C1" id="P70004970270000000000000000401C1">%rcx</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C2" id="P70004970270000000000000000401C2">3rd argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C3" id="P70004970270000000000000000401C3">%dl</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C4" id="P70004970270000000000000000401C4">%dx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C5" id="P70004970270000000000000000401C5">%edx</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C6" id="P70004970270000000000000000401C6">%rdx</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C7" id="P70004970270000000000000000401C7">2nd argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C8" id="P70004970270000000000000000401C8">%sil</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401C9" id="P70004970270000000000000000401C9">%si</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401CA" id="P70004970270000000000000000401CA">%esi</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401CB" id="P70004970270000000000000000401CB">%rsi</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401CC" id="P70004970270000000000000000401CC">1st argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401CD" id="P70004970270000000000000000401CD">%dil</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401CE" id="P70004970270000000000000000401CE">%di</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401CF" id="P70004970270000000000000000401CF">%edi</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D0" id="P70004970270000000000000000401D0">%rdi</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D1" id="P70004970270000000000000000401D1">Callee saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D2" id="P70004970270000000000000000401D2">%bpl</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D3" id="P70004970270000000000000000401D3">%bp</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D4" id="P70004970270000000000000000401D4">%ebp</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D5" id="P70004970270000000000000000401D5">%rbp</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D6" id="P70004970270000000000000000401D6">Stack pointer</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D7" id="P70004970270000000000000000401D7">%spl</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D8" id="P70004970270000000000000000401D8">%sp</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401D9" id="P70004970270000000000000000401D9">%esp</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401DA" id="P70004970270000000000000000401DA">%rsp</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401DB" id="P70004970270000000000000000401DB">5th argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401DC" id="P70004970270000000000000000401DC">%r8b</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401DD" id="P70004970270000000000000000401DD">%r8w</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401DE" id="P70004970270000000000000000401DE">%r8d</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401DF" id="P70004970270000000000000000401DF">%r8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E0" id="P70004970270000000000000000401E0">6th argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E1" id="P70004970270000000000000000401E1">%r9b</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E2" id="P70004970270000000000000000401E2">%r9w</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E3" id="P70004970270000000000000000401E3">%r9d</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E4" id="P70004970270000000000000000401E4">%r9</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E5" id="P70004970270000000000000000401E5">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E6" id="P70004970270000000000000000401E6">%r10b</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E7" id="P70004970270000000000000000401E7">%r10w</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E8" id="P70004970270000000000000000401E8">%r10d</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401E9" id="P70004970270000000000000000401E9">%r10</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401EA" id="P70004970270000000000000000401EA">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401EB" id="P70004970270000000000000000401EB">%r11b</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401EC" id="P70004970270000000000000000401EC">%r11w</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401ED" id="P70004970270000000000000000401ED">%r11d</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401EE" id="P70004970270000000000000000401EE">%r11</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401EF" id="P70004970270000000000000000401EF">Callee saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F0" id="P70004970270000000000000000401F0">%r12b</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F1" id="P70004970270000000000000000401F1">%r12w</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F2" id="P70004970270000000000000000401F2">%r12d</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F3" id="P70004970270000000000000000401F3">%r12</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F4" id="P70004970270000000000000000401F4">Callee saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F5" id="P70004970270000000000000000401F5">%r13b</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F6" id="P70004970270000000000000000401F6">%r13w</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F7" id="P70004970270000000000000000401F7">%r13d</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F8" id="P70004970270000000000000000401F8">%r13</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401F9" id="P70004970270000000000000000401F9">Callee saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401FA" id="P70004970270000000000000000401FA">%r14b</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401FB" id="P70004970270000000000000000401FB">%r14w</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401FC" id="P70004970270000000000000000401FC">%r14d</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401FD" id="P70004970270000000000000000401FD">%r14</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401FE" id="P70004970270000000000000000401FE">Callee saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000401FF" id="P70004970270000000000000000401FF">%r15b</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040200" id="P7000497027000000000000000040200">%r15w</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040201" id="P7000497027000000000000000040201">%r15d</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040202" id="P7000497027000000000000000040202">%r15</td>
</tr>
</tbody>
</table>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040203" id="P7000497027000000000000000040203">arguments, returning values from functions, and storing local and temporary data. We will cover these conventions in our presentation, especially in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000281F.xhtml#P700049702700000000000000000281F"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.7</span></a>, where we describe the implementation of procedures.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000001F54" id="P7000497027000000000000000001F54"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040204" epub:type="title" id="P7000497027000000000000000040204"><span class="pcalibre1 pcalibre21 pcalibre2">3.4.1 </span>Operand Specifiers</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040205" id="P7000497027000000000000000040205">Most instructions have one or more <i class="pcalibre17 pcalibre2 pcalibre1">operands</i> specifying the source values to use in performing an operation and the destination location into which to place the</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000001F57" id="P7000497027000000000000000001F57">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001F58" epub:type="pagebreak" id="P7000497027000000000000000001F58" title="181"></span>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040206" id="P7000497027000000000000000040206">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040207" id="P7000497027000000000000000040207">Type</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040208" id="P7000497027000000000000000040208">Form</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040209" id="P7000497027000000000000000040209">Operand value</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004020A" id="P700049702700000000000000004020A">Name</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004020B" id="P700049702700000000000000004020B">Immediate</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004020C" id="P700049702700000000000000004020C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004020D" id="P700049702700000000000000004020D">$</code><i class="pcalibre17 pcalibre2 pcalibre1">Imm</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004020E" id="P700049702700000000000000004020E"><i class="pcalibre17 pcalibre2 pcalibre1">Imm</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004020F" id="P700049702700000000000000004020F">Immediate</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040210" id="P7000497027000000000000000040210">Register</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040211" id="P7000497027000000000000000040211"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040212" id="P7000497027000000000000000040212">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">a</var></sub></code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040213" id="P7000497027000000000000000040213">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040214" id="P7000497027000000000000000040214">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">a</var></sub></code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040215" id="P7000497027000000000000000040215">Register</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040216" id="P7000497027000000000000000040216">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040217" id="P7000497027000000000000000040217"><i class="pcalibre17 pcalibre2 pcalibre1">Imm</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040218" id="P7000497027000000000000000040218">M[<i class="pcalibre17 pcalibre2 pcalibre1">Imm</i>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040219" id="P7000497027000000000000000040219">Absolute</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004021A" id="P700049702700000000000000004021A">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004021B" id="P700049702700000000000000004021B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004021C" id="P700049702700000000000000004021C">(r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">a</var></sub>)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004021D" id="P700049702700000000000000004021D">M[R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004021E" id="P700049702700000000000000004021E">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">a</var></sub></code>]]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004021F" id="P700049702700000000000000004021F">Indirect</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040220" id="P7000497027000000000000000040220">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040221" id="P7000497027000000000000000040221"><i class="pcalibre17 pcalibre2 pcalibre1">Imm</i> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040222" id="P7000497027000000000000000040222">(r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub>)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040223" id="P7000497027000000000000000040223">M[<i class="pcalibre17 pcalibre2 pcalibre1">Imm</i> + R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040224" id="P7000497027000000000000000040224">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub></code>]]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040225" id="P7000497027000000000000000040225">Base + displacement</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040226" id="P7000497027000000000000000040226">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040227" id="P7000497027000000000000000040227"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040228" id="P7000497027000000000000000040228">(r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub>,r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub>)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040229" id="P7000497027000000000000000040229">M[R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004022A" id="P700049702700000000000000004022A">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub></code>] + R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004022B" id="P700049702700000000000000004022B">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub>]</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004022C" id="P700049702700000000000000004022C">Indexed</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004022D" id="P700049702700000000000000004022D">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004022E" id="P700049702700000000000000004022E"><i class="pcalibre17 pcalibre2 pcalibre1">Imm</i><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004022F" id="P700049702700000000000000004022F">(r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub>,r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub>)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040230" id="P7000497027000000000000000040230">M[<i class="pcalibre17 pcalibre2 pcalibre1">Imm</i> + R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040231" id="P7000497027000000000000000040231">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub></code>] + R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040232" id="P7000497027000000000000000040232">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub></code>]]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040233" id="P7000497027000000000000000040233">Indexed</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040234" id="P7000497027000000000000000040234">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040235" id="P7000497027000000000000000040235"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040236" id="P7000497027000000000000000040236">(,r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub>,<var class="pcalibre17 pcalibre2 pcalibre1">s</var>)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040237" id="P7000497027000000000000000040237">M[R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040238" id="P7000497027000000000000000040238">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub></code>] <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040239" id="P7000497027000000000000000040239">· <var class="pcalibre17 pcalibre2 pcalibre1">s</var></code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004023A" id="P700049702700000000000000004023A">Scaled indexed</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004023B" id="P700049702700000000000000004023B">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004023C" id="P700049702700000000000000004023C"><i class="pcalibre17 pcalibre2 pcalibre1">Imm</i> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004023D" id="P700049702700000000000000004023D">(,r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub>,<var class="pcalibre17 pcalibre2 pcalibre1">s</var>)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004023E" id="P700049702700000000000000004023E">M[<i class="pcalibre17 pcalibre2 pcalibre1">Imm</i> + R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004023F" id="P700049702700000000000000004023F">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub></code>] <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040240" id="P7000497027000000000000000040240">· <var class="pcalibre17 pcalibre2 pcalibre1">s</var></code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040241" id="P7000497027000000000000000040241">Scaled indexed</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040242" id="P7000497027000000000000000040242">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040243" id="P7000497027000000000000000040243"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040244" id="P7000497027000000000000000040244">(r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub>,r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub>,<var class="pcalibre17 pcalibre2 pcalibre1">s</var>)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040245" id="P7000497027000000000000000040245">M[R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040246" id="P7000497027000000000000000040246">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub></code>] + R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040247" id="P7000497027000000000000000040247">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub></code>] <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040248" id="P7000497027000000000000000040248">· <var class="pcalibre17 pcalibre2 pcalibre1">s</var></code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040249" id="P7000497027000000000000000040249">Scaled indexed</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004024A" id="P700049702700000000000000004024A">Memory</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004024B" id="P700049702700000000000000004024B"><i class="pcalibre17 pcalibre2 pcalibre1">Imm</i> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004024C" id="P700049702700000000000000004024C">(r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub>,r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub>,<var class="pcalibre17 pcalibre2 pcalibre1">s</var>)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004024D" id="P700049702700000000000000004024D">M[<i class="pcalibre17 pcalibre2 pcalibre1">Imm</i> + R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004024E" id="P700049702700000000000000004024E">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub></code>] + R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004024F" id="P700049702700000000000000004024F">r<sub class="pcalibre1 pcalibre2 pcalibre122"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub></code>] <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040250" id="P7000497027000000000000000040250">· <var class="pcalibre17 pcalibre2 pcalibre1">s</var></code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040251" id="P7000497027000000000000000040251">Scaled indexed</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040252" id="P7000497027000000000000000040252"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040253" epub:type="title" id="P7000497027000000000000000040253"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.3 </span>Operand forms.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040254" id="P7000497027000000000000000040254"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040255" id="P7000497027000000000000000040255">Operands can denote immediate (constant) values, register values, or values from memory. The scaling factor <var class="pcalibre17 pcalibre2 pcalibre1">s</var> must be either 1, 2, 4, or 8.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040256" id="P7000497027000000000000000040256">result. x86-64 supports a number of operand forms (see <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001F57"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.3</span></a>). Source values can be given as constants or read from registers or memory. Results can be stored in either registers or memory. Thus, the different operand possibilities can be classified into three types. The first type, <i class="pcalibre17 pcalibre2 pcalibre1">immediate</i>, is for constant values. In ATT-format assembly code, these are written with a `$' followed by an integer using standard C notation—for example, $-577 or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040257" id="P7000497027000000000000000040257">$0x1F</code>. Different instructions allow different ranges of immediate values; the assembler will automatically select the most compact way of encoding a value. The second type, <i class="pcalibre17 pcalibre2 pcalibre1">register</i>, denotes the contents of a register, one of the sixteen 8-, 4-, 2-, or 1-byte low-order portions of the registers for operands having 64, 32, 16, or 8 bits, respectively. In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001F57"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.3</span></a>, we use the notation <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040258" id="P7000497027000000000000000040258">r<sub class="pcalibre97 pcalibre2 pcalibre1"><var class="pcalibre17 pcalibre2 pcalibre1">a</var></sub></code> to denote an arbitrary register <var class="pcalibre17 pcalibre2 pcalibre1">a</var> and indicate its value with the reference <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040259" id="P7000497027000000000000000040259">R[r<sub class="pcalibre97 pcalibre2 pcalibre1"><var class="pcalibre17 pcalibre2 pcalibre1">a</var></sub>]</code>, viewing the set of registers as an array R indexed by register identifiers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004025A" id="P700049702700000000000000004025A">The third type of operand is a <i class="pcalibre17 pcalibre2 pcalibre1">memory</i> reference, in which we access some memory location according to a computed address, often called the <i class="pcalibre17 pcalibre2 pcalibre1">effective address</i>. Since we view the memory as a large array of bytes, we use the notation M<sub class="pcalibre1 pcalibre2 calibre14"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub>[<i class="pcalibre17 pcalibre2 pcalibre1">Addr</i>] to denote a reference to the <var class="pcalibre17 pcalibre2 pcalibre1">b</var>-byte value stored in memory starting at address <i class="pcalibre17 pcalibre2 pcalibre1">Addr</i>. To simplify things, we will generally drop the subscript <var class="pcalibre17 pcalibre2 pcalibre1">b</var>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004025B" id="P700049702700000000000000004025B">As <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001F57"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.3</span></a> shows, there are many different <i class="pcalibre17 pcalibre2 pcalibre1">addressing modes</i> allowing different forms of memory references. The most general form is shown at the bottom of the table with syntax <i class="pcalibre17 pcalibre2 pcalibre1">Imm</i>(<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004025C" id="P700049702700000000000000004025C">r<sub class="pcalibre97 pcalibre2 pcalibre1"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub>,r<sub class="pcalibre97 pcalibre2 pcalibre1"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub>,<var class="pcalibre17 pcalibre2 pcalibre1">s</var></code>). Such a reference has four components: an immediate offset <i class="pcalibre17 pcalibre2 pcalibre1">Imm</i>, a base register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004025D" id="P700049702700000000000000004025D">r<sub class="pcalibre97 pcalibre2 pcalibre1"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub></code>, an index register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004025E" id="P700049702700000000000000004025E">r<sub class="pcalibre97 pcalibre2 pcalibre1"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub></code>, and a scale factor <var class="pcalibre17 pcalibre2 pcalibre1">s</var>, where <var class="pcalibre17 pcalibre2 pcalibre1">s</var> must be 1, 2, 4, or 8. Both the base and index must be 64-bit registers. The effective address is computed as <i class="pcalibre17 pcalibre2 pcalibre1">Imm</i> + <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004025F" id="P700049702700000000000000004025F">R[r<sub class="pcalibre97 pcalibre2 pcalibre1"><var class="pcalibre17 pcalibre2 pcalibre1">b</var></sub>]+ R[r<sub class="pcalibre97 pcalibre2 pcalibre1"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></sub>] · <i class="pcalibre17 pcalibre2 pcalibre1">s.</i></code> This general form is often seen when referencing elements of arrays. The other forms are simply special cases of this general form where some of the components are omitted. As we <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000001FB3" epub:type="pagebreak" id="P7000497027000000000000000001FB3" title="182"></span>will see, the more complex addressing modes are useful when referencing array and structure elements.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000001FB4" epub:type="practice" id="P7000497027000000000000000001FB4"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040260" epub:type="title" id="P7000497027000000000000000040260"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000032E1.xhtml#P7000497027000000000000000003443">325</a>)</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040261" id="P7000497027000000000000000040261">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040262" id="P7000497027000000000000000040262">Assume the following values are stored at the indicated memory addresses and registers:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040263" id="P7000497027000000000000000040263">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040264" id="P7000497027000000000000000040264">Address</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040265" id="P7000497027000000000000000040265">Value</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040266" id="P7000497027000000000000000040266">Register</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040267" id="P7000497027000000000000000040267">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040268" id="P7000497027000000000000000040268"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040269" id="P7000497027000000000000000040269">0x100</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004026A" id="P700049702700000000000000004026A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004026B" id="P700049702700000000000000004026B">0xFF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004026C" id="P700049702700000000000000004026C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004026D" id="P700049702700000000000000004026D">%rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004026E" id="P700049702700000000000000004026E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004026F" id="P700049702700000000000000004026F">0x100</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040270" id="P7000497027000000000000000040270"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040271" id="P7000497027000000000000000040271">0x104</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040272" id="P7000497027000000000000000040272"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040273" id="P7000497027000000000000000040273">0xAB</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040274" id="P7000497027000000000000000040274"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040275" id="P7000497027000000000000000040275">%rcx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040276" id="P7000497027000000000000000040276"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040277" id="P7000497027000000000000000040277">0x1</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040278" id="P7000497027000000000000000040278"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040279" id="P7000497027000000000000000040279">0x108</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004027A" id="P700049702700000000000000004027A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004027B" id="P700049702700000000000000004027B">0x13</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004027C" id="P700049702700000000000000004027C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004027D" id="P700049702700000000000000004027D">%rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004027E" id="P700049702700000000000000004027E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004027F" id="P700049702700000000000000004027F">0x3</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040280" id="P7000497027000000000000000040280"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040281" id="P7000497027000000000000000040281">0x10C</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040282" id="P7000497027000000000000000040282"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040283" id="P7000497027000000000000000040283">0x11</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
</tbody>
</table>
</div>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040284" id="P7000497027000000000000000040284">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040285" id="P7000497027000000000000000040285">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040286" id="P7000497027000000000000000040286"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040287" id="P7000497027000000000000000040287">Fill in the following table showing the values for the indicated operands:</p></div>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040288" id="P7000497027000000000000000040288">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040289" id="P7000497027000000000000000040289">Operand</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004028A" id="P700049702700000000000000004028A">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004028B" id="P700049702700000000000000004028B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004028C" id="P700049702700000000000000004028C">%rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004028D" id="P700049702700000000000000004028D">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004028E" id="P700049702700000000000000004028E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004028F" id="P700049702700000000000000004028F">0x104</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040290" id="P7000497027000000000000000040290">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040291" id="P7000497027000000000000000040291"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040292" id="P7000497027000000000000000040292">$0x108</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040293" id="P7000497027000000000000000040293">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040294" id="P7000497027000000000000000040294"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040295" id="P7000497027000000000000000040295">(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040296" id="P7000497027000000000000000040296">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040297" id="P7000497027000000000000000040297"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040298" id="P7000497027000000000000000040298">4(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040299" id="P7000497027000000000000000040299">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004029A" id="P700049702700000000000000004029A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004029B" id="P700049702700000000000000004029B">9(%rax,%rdx)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004029C" id="P700049702700000000000000004029C">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004029D" id="P700049702700000000000000004029D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004029E" id="P700049702700000000000000004029E">260(%rcx,%rdx)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004029F" id="P700049702700000000000000004029F">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402A0" id="P70004970270000000000000000402A0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402A1" id="P70004970270000000000000000402A1">0xFC(,%rcx,4)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402A2" id="P70004970270000000000000000402A2">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402A3" id="P70004970270000000000000000402A3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402A4" id="P70004970270000000000000000402A4">(%rax,%rdx,4)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402A5" id="P70004970270000000000000000402A5">__________</td>
</tr>
</tbody>
</table>
</li>
</ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000001FFB" id="P7000497027000000000000000001FFB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402A6" epub:type="title" id="P70004970270000000000000000402A6"><span class="pcalibre1 pcalibre21 pcalibre2">3.4.2 </span>Data Movement Instructions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402A7" id="P70004970270000000000000000402A7">Among the most heavily used instructions are those that copy data from one location to another. The generality of the operand notation allows a simple data movement instruction to express a range of possibilities that in many machines would require a number of different instructions. We present a number of different data movement instructions, differing in their source and destination types, what conversions they perform, and other side effects they may have. In our presentation, we group the many different instructions into <i class="pcalibre17 pcalibre2 pcalibre1">instruction classes</i>, where the instructions in a class perform the same operation but with different operand sizes.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402A8" id="P70004970270000000000000000402A8"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002001"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.4</span></a> lists the simplest form of data movement instructions—<span class="pcalibre1 pcalibre29 pcalibre2">mov </span>class. These instructions copy data from a source location to a destination location, without any transformation. The class consists of four instructions: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402A9" id="P70004970270000000000000000402A9">movb, movw, movl</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402AA" id="P70004970270000000000000000402AA">movq</code>. All four of these instructions have similar effects; they differ primarily in that they operate on data of different sizes: 1, 2, 4, and 8 bytes, respectively.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002001" id="P7000497027000000000000000002001">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000402AB" id="P70004970270000000000000000402AB">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000402AC" id="P70004970270000000000000000402AC"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002004" epub:type="pagebreak" id="P7000497027000000000000000002004" title="183"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000402AD" id="P70004970270000000000000000402AD"></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000402AE" id="P70004970270000000000000000402AE">Effect</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000402AF" id="P70004970270000000000000000402AF">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402B0" id="P70004970270000000000000000402B0"><span class="pcalibre1 pcalibre2 pcalibre84">mov</span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402B1" id="P70004970270000000000000000402B1"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402B2" id="P70004970270000000000000000402B2"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402B3" id="P70004970270000000000000000402B3">Move</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402B4" id="P70004970270000000000000000402B4"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402B5" id="P70004970270000000000000000402B5">movb</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402B6" id="P70004970270000000000000000402B6">Move byte</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402B7" id="P70004970270000000000000000402B7"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402B8" id="P70004970270000000000000000402B8">movw</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402B9" id="P70004970270000000000000000402B9">Move word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402BA" id="P70004970270000000000000000402BA"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402BB" id="P70004970270000000000000000402BB">movl</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402BC" id="P70004970270000000000000000402BC">Move double word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402BD" id="P70004970270000000000000000402BD"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402BE" id="P70004970270000000000000000402BE">moivq</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402BF" id="P70004970270000000000000000402BF">Move quad word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402C0" id="P70004970270000000000000000402C0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402C1" id="P70004970270000000000000000402C1">movabsq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402C2" id="P70004970270000000000000000402C2"><var class="pcalibre17 pcalibre2 pcalibre1">I</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402C3" id="P70004970270000000000000000402C3"><var class="pcalibre17 pcalibre2 pcalibre1">R</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">I</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402C4" id="P70004970270000000000000000402C4">Move absolute quad word</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P70004970270000000000000000402C5" id="P70004970270000000000000000402C5"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P70004970270000000000000000402C6" epub:type="title" id="P70004970270000000000000000402C6"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.4 </span>Simple data movement instructions.</h1></header></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402C7" id="P70004970270000000000000000402C7">The source operand designates a value that is immediate, stored in a register, or stored in memory. The destination operand designates a location that is either a register or a memory address. x86-64 imposes the restriction that a move instruction cannot have both operands refer to memory locations. Copying a value from one memory location to another requires two instructions—the first to load the source value into a register, and the second to write this register value to the destination. Referring to <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000001F4C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.2</span></a>, register operands for these instructions can be the labeled portions of any of the 16 registers, where the size of the register must match the size designated by the last character of the instruction (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402C8" id="P70004970270000000000000000402C8">'b', `w', `l'</code>, or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402C9" id="P70004970270000000000000000402C9">`q'</code>). For most cases, the <span class="pcalibre1 pcalibre29 pcalibre2">mov </span>instructions will only update the specific register bytes or memory locations indicated by the destination operand. The only exception is that when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402CA" id="P70004970270000000000000000402CA">movl</code> has a register as the destination, it will also set the high-order 4 bytes of the register to 0. This exception arises from the convention, adopted in x86-64, that any instruction that generates a 32-bit value for a register also sets the high-order portion of the register to 0.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402CB" id="P70004970270000000000000000402CB">The following <span class="pcalibre1 pcalibre29 pcalibre2">mov </span>instruction examples show the five possible combinations of source and destination types. Recall that the source operand comes first and the destination second.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000402CC" id="P70004970270000000000000000402CC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402CD" id="P70004970270000000000000000402CD">
1	movl $0x4050,%eax	<i class="pcalibre17 pcalibre2 pcalibre1">Immediate--Register, 4 bytes</i>
2	movw %bp,%sp		<i class="pcalibre17 pcalibre2 pcalibre1">Register--Register, 2 bytes</i>
3	movb (%rdi,%rcx),%al	<i class="pcalibre17 pcalibre2 pcalibre1">Memory--Register, 1 byte</i>
4	movb $-17,( %esp)	<i class="pcalibre17 pcalibre2 pcalibre1">Immediate--Memory, 1 byte</i>
5	movq %rax,–12(%rbp)	<i class="pcalibre17 pcalibre2 pcalibre1">Register--Memory, 8 bytes</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402CE" id="P70004970270000000000000000402CE">A final instruction documented in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002001"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.4</span></a> is for dealing with 64-bit immediate data. The regular <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402CF" id="P70004970270000000000000000402CF">movq</code> instruction can only have immediate source operands that can be represented as 32-bit two's-complement numbers. This value is then sign extended to produce the 64-bit value for the destination. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402D0" id="P70004970270000000000000000402D0">movabsq</code> instruction can have an arbitrary 64-bit immediate value as its source operand and can only have a register as a destination.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402D1" id="P70004970270000000000000000402D1"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000203C"><span class="pcalibre1 pcalibre21 pcalibre2">Figures </span><span class="pcalibre1 pcalibre21 pcalibre2">3.5</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000203C"><span class="pcalibre1 pcalibre21 pcalibre2">3.6</span></a> document two classes of data movement instructions for use when copying a smaller source value to a larger destination. All of these instructions copy data from a source, which can be either a register or stored</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000000202A" id="P700049702700000000000000000202A"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P70004970270000000000000000402D2" epub:type="title" id="P70004970270000000000000000402D2"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000202C" epub:type="pagebreak" id="P700049702700000000000000000202C" title="184"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Understanding how data movement changes a destination register</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000402D3" id="P70004970270000000000000000402D3">As described, there are two different conventions regarding whether and how data movement instructions modify the upper bytes of a destination register. This distinction is illustrated by the following code sequence:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000402D4" id="P70004970270000000000000000402D4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402D5" id="P70004970270000000000000000402D5">
1	movabsq	$0x0011223344556677, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">%rax = 0011223344556677</i>
2	movb	$-1, %al			<i class="pcalibre17 pcalibre2 pcalibre1">%rax = 00112233445566FF</i>
3	movw	$-1, %ax			<i class="pcalibre17 pcalibre2 pcalibre1">%rax = 001122334455FFFF</i>
4	movl	$-1, %eax			<i class="pcalibre17 pcalibre2 pcalibre1">%rax = 00000000FFFFFFFF</i>
5	movq	$-1, %rax			<i class="pcalibre17 pcalibre2 pcalibre1">%rax = FFFFFFFFFFFFFFFF</i>
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000402D6" id="P70004970270000000000000000402D6">In the following discussion, we use hexadecimal notation. In the example, the instruction on line 1 initializes register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402D7" id="P70004970270000000000000000402D7">%rax</code> to the pattern <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402D8" id="P70004970270000000000000000402D8">0011223344556677</code>. The remaining instructions have immediate value –1 as their source values. Recall that the hexadecimal representation of –1 is of the form <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402D9" id="P70004970270000000000000000402D9">FF···F</code>, where the number of <span class="pcalibre1 pcalibre29 pcalibre2">f's </span>is twice the number of bytes in the representation. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402DA" id="P70004970270000000000000000402DA">movb</code> instruction (line 2) therefore sets the low-order byte of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402DB" id="P70004970270000000000000000402DB">%rax</code> to <span class="pcalibre1 pcalibre29 pcalibre2">ff</span>, while the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402DC" id="P70004970270000000000000000402DC">movw</code> instruction (line 3) sets the low-order 2 bytes to <span class="pcalibre1 pcalibre29 pcalibre2">ffff</span>, with the remaining bytes unchanged. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402DD" id="P70004970270000000000000000402DD">movl</code> instruction (line 4) sets the low-order 4 bytes to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402DE" id="P70004970270000000000000000402DE">FFFFFFFF</code>, but it also sets the high-order 4 bytes to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402DF" id="P70004970270000000000000000402DF">00000000</code>. Finally, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402E0" id="P70004970270000000000000000402E0">movq</code> instruction (line 5) sets the complete register to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402E1" id="P70004970270000000000000000402E1">FFFFFFFFFFFFFFFF</code>.</p>
</aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P700049702700000000000000000203C" id="P700049702700000000000000000203C">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000402E2" id="P70004970270000000000000000402E2">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000402E3" id="P70004970270000000000000000402E3">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000402E4" id="P70004970270000000000000000402E4">Effect</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000402E5" id="P70004970270000000000000000402E5">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402E6" id="P70004970270000000000000000402E6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402E7" id="P70004970270000000000000000402E7"><span class="pcalibre1 pcalibre29 pcalibre2">movz </span><var class="pcalibre17 pcalibre2 pcalibre1">S</var>,<var class="pcalibre17 pcalibre2 pcalibre1">R</var></code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402E8" id="P70004970270000000000000000402E8"><var class="pcalibre17 pcalibre2 pcalibre1">R</var> ← ZeroExtend<i class="pcalibre17 pcalibre2 pcalibre1">(S)</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402E9" id="P70004970270000000000000000402E9">Move with zero extension</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402EA" id="P70004970270000000000000000402EA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402EB" id="P70004970270000000000000000402EB">movzbw</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402EC" id="P70004970270000000000000000402EC">Move zero-extended byte to word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402ED" id="P70004970270000000000000000402ED"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402EE" id="P70004970270000000000000000402EE">movzbl</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402EF" id="P70004970270000000000000000402EF">Move zero-extended byte to double word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402F0" id="P70004970270000000000000000402F0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402F1" id="P70004970270000000000000000402F1">movzwl</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402F2" id="P70004970270000000000000000402F2">Move zero-extended word to double word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402F3" id="P70004970270000000000000000402F3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402F4" id="P70004970270000000000000000402F4">movzbq</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402F5" id="P70004970270000000000000000402F5">Move zero-extended byte to quad word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402F6" id="P70004970270000000000000000402F6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402F7" id="P70004970270000000000000000402F7">movzwq</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000402F8" id="P70004970270000000000000000402F8">Move zero-extended word to quad word</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P70004970270000000000000000402F9" id="P70004970270000000000000000402F9"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P70004970270000000000000000402FA" epub:type="title" id="P70004970270000000000000000402FA"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.5 </span>Zero-extending data movement instructions.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402FB" id="P70004970270000000000000000402FB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000402FC" id="P70004970270000000000000000402FC">These instructions have a register or memory location as the source and a register as the destination.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000402FD" id="P70004970270000000000000000402FD">in memory, to a register destination. Instructions in the <span class="pcalibre1 pcalibre29 pcalibre2">movz </span>class fill out the remaining bytes of the destination with zeros, while those in the <span class="pcalibre1 pcalibre29 pcalibre2">movs </span>class fill them out by sign extension, replicating copies of the most significant bit of the source operand. Observe that each instruction name has size designators as its final two characters—the first specifying the source size, and the second specifying the destination size. As can be seen, there are three instructions in each of these classes, covering all cases of 1-and 2-byte source sizes and 2- and 4-byte destination sizes, considering only cases where the destination is larger than the source, of course.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002059" id="P7000497027000000000000000002059">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000402FE" id="P70004970270000000000000000402FE">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000402FF" id="P70004970270000000000000000402FF"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P700049702700000000000000000205C" epub:type="pagebreak" id="P700049702700000000000000000205C" title="185"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040300" id="P7000497027000000000000000040300">Effect</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040301" id="P7000497027000000000000000040301">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040302" id="P7000497027000000000000000040302"><span class="pcalibre1 pcalibre29 pcalibre2">movs </span><var class="pcalibre17 pcalibre2 pcalibre1">S</var>,<var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040303" id="P7000497027000000000000000040303"><var class="pcalibre17 pcalibre2 pcalibre1">R</var> ← SignExtend<i class="pcalibre17 pcalibre2 pcalibre1">(S)</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040304" id="P7000497027000000000000000040304">Move with sign extension</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040305" id="P7000497027000000000000000040305"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040306" id="P7000497027000000000000000040306">movsbw</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040307" id="P7000497027000000000000000040307">Move sign-extended byte to word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040308" id="P7000497027000000000000000040308"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040309" id="P7000497027000000000000000040309">movsbl</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004030A" id="P700049702700000000000000004030A">Move sign-extended byte to double word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004030B" id="P700049702700000000000000004030B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004030C" id="P700049702700000000000000004030C">movswl</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004030D" id="P700049702700000000000000004030D">Move sign-extended word to double word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004030E" id="P700049702700000000000000004030E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004030F" id="P700049702700000000000000004030F">movsbq</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040310" id="P7000497027000000000000000040310">Move sign-extended byte to quad word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040311" id="P7000497027000000000000000040311"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040312" id="P7000497027000000000000000040312">movswq</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040313" id="P7000497027000000000000000040313">Move sign-extended word to quad word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040314" id="P7000497027000000000000000040314"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040315" id="P7000497027000000000000000040315">movslq</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040316" id="P7000497027000000000000000040316">Move sign-extended double word to quad word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040317" id="P7000497027000000000000000040317"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040318" id="P7000497027000000000000000040318">cltq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040319" id="P7000497027000000000000000040319">%rax ← SignExtend(%eax)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004031A" id="P700049702700000000000000004031A">Sign-extend %eax to %rax</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P700049702700000000000000004031B" id="P700049702700000000000000004031B"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P700049702700000000000000004031C" epub:type="title" id="P700049702700000000000000004031C"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.6 </span>Sign-extending data movement instructions.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004031D" id="P700049702700000000000000004031D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004031E" id="P700049702700000000000000004031E">The <span class="pcalibre1 pcalibre29 pcalibre2">movs </span>instructions have a register or memory location as the source and a register as the destination. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004031F" id="P700049702700000000000000004031F">cltq</code> instruction is specific to registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040320" id="P7000497027000000000000000040320">%eax</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040321" id="P7000497027000000000000000040321">%rax</code>.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040322" id="P7000497027000000000000000040322">Note the absence of an explicit instruction to zero-extend a 4-byte source value to an 8-byte destination in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000203C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.5</span></a>. Such an instruction would logically be named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040323" id="P7000497027000000000000000040323">movzlq</code>, but this instruction does not exist. Instead, this type of data movement can be implemented using a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040324" id="P7000497027000000000000000040324">movl</code> instruction having a register as the destination. This technique takes advantage of the property that an instruction generating a 4-byte value with a register as the destination will fill the upper 4 bytes with zeros. Otherwise, for 64-bit destinations, moving with sign extension is supported for all three source types, and moving with zero extension is supported for the two smaller source types.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040325" id="P7000497027000000000000000040325"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002059"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6</span></a> also documents the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040326" id="P7000497027000000000000000040326">cltq</code> instruction. This instruction has no operands—it always uses register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040327" id="P7000497027000000000000000040327">%eax</code> as its source and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040328" id="P7000497027000000000000000040328">%rax</code> as the destination for the sign-extended result. It therefore has the exact same effect as the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040329" id="P7000497027000000000000000040329">movslq %eax, %rax</code>, but it has a more compact encoding.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002087" epub:type="practice" id="P7000497027000000000000000002087"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004032A" epub:type="title" id="P700049702700000000000000004032A"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.2 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000032E1.xhtml#P7000497027000000000000000003443">325</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004032B" id="P700049702700000000000000004032B">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004032C" id="P700049702700000000000000004032C">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004032D" id="P700049702700000000000000004032D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004032E" id="P700049702700000000000000004032E">For each of the following lines of assembly language, determine the appropriate instruction suffix based on the operands. (For example, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004032F" id="P700049702700000000000000004032F">mov</code> can be rewritten as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040330" id="P7000497027000000000000000040330">movb, movw, movl, or movq.</code>)</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040331" id="P7000497027000000000000000040331"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040332" id="P7000497027000000000000000040332">
mov___	%eax, (%rsp)
mov___	(%rax), %dx
mov___	$0xFF, %bl
mov___	(%rsp,%rdx,4), %dl
mov___	(%rdx), %rax
mov___	%dx, (%rax)
</code></pre>
</div>
</li></ol>
</section>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000002091" id="P7000497027000000000000000002091"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P7000497027000000000000000040333" epub:type="title" id="P7000497027000000000000000040333"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002093" epub:type="pagebreak" id="P7000497027000000000000000002093" title="186"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Comparing byte movement instructions</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040334" id="P7000497027000000000000000040334">The following example illustrates how different data movement instructions either do or do not change the high-order bytes of the destination. Observe that the three byte-movement instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040335" id="P7000497027000000000000000040335">movb, movsbq</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040336" id="P7000497027000000000000000040336">movzbq</code> differ from each other in subtle ways. Here is an example:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040337" id="P7000497027000000000000000040337"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040338" id="P7000497027000000000000000040338">
1	movabsq $0x0011223344556677, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">%rax = 0011223344556677</i>
2	movb $0xAA, %dl				<i class="pcalibre17 pcalibre2 pcalibre1">%dl = AA</i>
3	movb %dl,%al				<i class="pcalibre17 pcalibre2 pcalibre1">%rax = 00112233445566AA</i>
4	movsbq %dl,%rax				<i class="pcalibre17 pcalibre2 pcalibre1">%rax = FFFFFFFFFFFFFFAA</i>
5	movzbq %dl,%rax				<i class="pcalibre17 pcalibre2 pcalibre1">%rax = 00000000000000AA</i>
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040339" id="P7000497027000000000000000040339">In the following discussion, we use hexadecimal notation for all of the values. The first two lines of the code initialize registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004033A" id="P700049702700000000000000004033A">%rax</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004033B" id="P700049702700000000000000004033B">%dl</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004033C" id="P700049702700000000000000004033C">0011223344556677</code> and AA, respectively. The remaining instructions all copy the low-order byte of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004033D" id="P700049702700000000000000004033D">%rdx</code> to the low-order byte of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004033E" id="P700049702700000000000000004033E">%rax</code>. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004033F" id="P700049702700000000000000004033F">movb</code> instruction (line 3) does not change the other bytes. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040340" id="P7000497027000000000000000040340">movsbq</code> instruction (line 4) sets the other 7 bytes to either all ones or all zeros depending on the high-order bit of the source byte. Since hexadecimal A represents binary value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040341" id="P7000497027000000000000000040341">1010</code>, sign extension causes the higher-order bytes to each be set to FF. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040342" id="P7000497027000000000000000040342">movzbq</code> instruction (line 5) always sets the other 7 bytes to zero.</p>
</aside>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000020A3" epub:type="practice" id="P70004970270000000000000000020A3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040343" epub:type="title" id="P7000497027000000000000000040343"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.3 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003490">326</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040344" id="P7000497027000000000000000040344">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040345" id="P7000497027000000000000000040345">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040346" id="P7000497027000000000000000040346"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040347" id="P7000497027000000000000000040347">Each of the following lines of code generates an error message when we invoke the assembler. Explain what is wrong with each line.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040348" id="P7000497027000000000000000040348"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040349" id="P7000497027000000000000000040349">
movb $0xF, (%ebx)
movl %rax, (%rsp)
movw (%rax),4(%rsp)
movb %al,%sl
movq %rax,$0x123
movl %eax,%rdx
movb %si, 8(%rbp)
</code></pre>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000020AB" id="P70004970270000000000000000020AB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004034A" epub:type="title" id="P700049702700000000000000004034A"><span class="pcalibre1 pcalibre21 pcalibre2">3.4.3 </span>Data Movement Example</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004034B" id="P700049702700000000000000004034B">As an example of code that uses data movement instructions, consider the data exchange routine shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000020B2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.7</span></a>, both as C code and as assembly code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004034C" id="P700049702700000000000000004034C">As <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000020B2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.7(b)</span></a> shows, function exchange is implemented with just three instructions: two data movements (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004034D" id="P700049702700000000000000004034D">movq</code>) plus an instruction to return back to the point from which the function was called (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004034E" id="P700049702700000000000000004034E">ret</code>). We will cover the details of function call and return in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000281F.xhtml#P700049702700000000000000000281F"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.7</span></a>. Until then, it suffices to say that arguments are passed to functions in registers. Our annotated assembly code documents these. A function returns a value by storing it in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004034F" id="P700049702700000000000000004034F">%rax</code>, or in one of the low-order portions of this register.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P70004970270000000000000000020B2" id="P70004970270000000000000000020B2">
<ol class="pcalibre1 pcalibre2 pcalibre118" data-uri="chapter03.xhtml#P7000497027000000000000000040350" id="P7000497027000000000000000040350">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040351" id="P7000497027000000000000000040351"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040352" id="P7000497027000000000000000040352"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P70004970270000000000000000020B6" epub:type="pagebreak" id="P70004970270000000000000000020B6" title="187"></span>C code</p>
<pre class="pcalibre124 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040353" id="P7000497027000000000000000040353"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040354" id="P7000497027000000000000000040354">
long exchange(long *xp, long y)
{
	long x = *xp;
	*xp = y;
	return x;
}
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040355" id="P7000497027000000000000000040355"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040356" id="P7000497027000000000000000040356">Assembly code</p>
<pre class="pcalibre124 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040357" id="P7000497027000000000000000040357"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040358" id="P7000497027000000000000000040358">
<i class="pcalibre17 pcalibre2 pcalibre1">long exchange(long *xp, long y)</i>
<i class="pcalibre17 pcalibre2 pcalibre1">xp in %rdi, y in %rsi</i>
1	exchange:
2	movq	(%rdi), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Get x at xp. Set as return value.</i>
3	movq	%rsi, (%rdi)	<i class="pcalibre17 pcalibre2 pcalibre1">Store y at xp.</i>
4	ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return.</i>
</code></pre>
</li></ol>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040359" id="P7000497027000000000000000040359"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P700049702700000000000000004035A" epub:type="title" id="P700049702700000000000000004035A"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.7 </span>C and assembly code for exchange routine.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004035B" id="P700049702700000000000000004035B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004035C" id="P700049702700000000000000004035C">Registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004035D" id="P700049702700000000000000004035D">%rdi</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004035E" id="P700049702700000000000000004035E">%rsi</code> hold parameters <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004035F" id="P700049702700000000000000004035F">xp</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040360" id="P7000497027000000000000000040360">y</code>, respectively.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040361" id="P7000497027000000000000000040361">When the procedure begins execution, procedure parameters <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040362" id="P7000497027000000000000000040362">xp</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040363" id="P7000497027000000000000000040363">y</code> are stored in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040364" id="P7000497027000000000000000040364">%rdi</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040365" id="P7000497027000000000000000040365">%rsi</code>, respectively. Instruction 2 then reads <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040366" id="P7000497027000000000000000040366">x</code> from memory and stores the value in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040367" id="P7000497027000000000000000040367">%rax</code>, a direct implementation of the operation <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040368" id="P7000497027000000000000000040368">x = *xp</code> in the C program. Later, register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040369" id="P7000497027000000000000000040369">%rax</code> will be used to return a value from the function, and so the return value will be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004036A" id="P700049702700000000000000004036A">x</code>. Instruction 3 writes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004036B" id="P700049702700000000000000004036B">y</code> to the memory location designated by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004036C" id="P700049702700000000000000004036C">xp</code> in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004036D" id="P700049702700000000000000004036D">%rdi</code>, a direct implementation of the operation <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004036E" id="P700049702700000000000000004036E">*xp = y</code>. This example illustrates how the <span class="pcalibre1 pcalibre29 pcalibre2">mov </span>instructions can be used to read from memory to a register (line 2), and to write from a register to memory (line 3).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004036F" id="P700049702700000000000000004036F">Two features about this assembly code are worth noting. First, we see that what we call "pointers" in C are simply addresses. Dereferencing a pointer involves copying that pointer into a register, and then using this register in a memory reference. Second, local variables such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040370" id="P7000497027000000000000000040370">x</code> are often kept in registers rather than stored in memory locations. Register access is much faster than memory access.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000020D5" epub:type="practice" id="P70004970270000000000000000020D5"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040371" epub:type="title" id="P7000497027000000000000000040371"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.4 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003490">326</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040372" id="P7000497027000000000000000040372">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040373" id="P7000497027000000000000000040373">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040374" id="P7000497027000000000000000040374"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040375" id="P7000497027000000000000000040375">Assume variables sp and dp are declared with types</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040376" id="P7000497027000000000000000040376"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040377" id="P7000497027000000000000000040377">
src_t *sp;
dest_t *dp;
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040378" id="P7000497027000000000000000040378">where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040379" id="P7000497027000000000000000040379">src_t</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004037A" id="P700049702700000000000000004037A">dest_t</code> are data types declared with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004037B" id="P700049702700000000000000004037B">typedef</code>. We wish to use the appropriate pair of data movement instructions to implement the operation</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004037C" id="P700049702700000000000000004037C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004037D" id="P700049702700000000000000004037D">
*dp = (dest_t) *sp;
</code></pre>
</div>
</li>
</ol>
</section>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000020E3" id="P70004970270000000000000000020E3"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P700049702700000000000000004037E" epub:type="title" id="P700049702700000000000000004037E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000020E5" epub:type="pagebreak" id="P70004970270000000000000000020E5" title="188"></span><span class="pcalibre1 pcalibre2 pcalibre34">New to C? </span>Some examples of pointers</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004037F" id="P700049702700000000000000004037F">Function exchange (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000020B2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.7(a)</span></a>) provides a good illustration of the use of pointers in C. Argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040380" id="P7000497027000000000000000040380">xp</code> is a pointer to a long integer, while <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040381" id="P7000497027000000000000000040381">y</code> is a long integer itself. The statement</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040382" id="P7000497027000000000000000040382"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040383" id="P7000497027000000000000000040383">
long x = *xp;
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040384" id="P7000497027000000000000000040384">indicates that we should read the value stored in the location designated by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040385" id="P7000497027000000000000000040385">xp</code> and store it as a local variable named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040386" id="P7000497027000000000000000040386">x</code>. This read operation is known as pointer <i class="pcalibre17 pcalibre2 pcalibre1">dereferencing</i>. The C operator `*' performs pointer dereferencing. The statement</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040387" id="P7000497027000000000000000040387"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040388" id="P7000497027000000000000000040388">
*xp = y;
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040389" id="P7000497027000000000000000040389">does the reverse—it writes the value of parameter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004038A" id="P700049702700000000000000004038A">y</code> at the location designated by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004038B" id="P700049702700000000000000004038B">xp</code>. This is also a form of pointer dereferencing (and hence the operator *), but it indicates a write operation since it is on the left-hand side of the assignment.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004038C" id="P700049702700000000000000004038C">The following is an example of exchange in action:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004038D" id="P700049702700000000000000004038D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004038E" id="P700049702700000000000000004038E">
long a = 4;
long b = exchange(&amp;a, 3);
printf("a = %ld, b = %ld\verb@\@n", a, b);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004038F" id="P700049702700000000000000004038F">This code will print</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040390" id="P7000497027000000000000000040390"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040391" id="P7000497027000000000000000040391">
a = 3, b = 4
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040392" id="P7000497027000000000000000040392">The C operator `&amp;' (called the "address of" operator) <i class="pcalibre17 pcalibre2 pcalibre1">creates</i> a pointer, in this case to the location holding local variable a. Function exchange overwrites the value stored in a with 3 but returns the previous value, 4, as the function value. Observe how by passing a pointer to exchange, it could modify data held at some remote location.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040393" id="P7000497027000000000000000040393">Assume that the values of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040394" id="P7000497027000000000000000040394">sp</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040395" id="P7000497027000000000000000040395">dp</code> are stored in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040396" id="P7000497027000000000000000040396">%rdi</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040397" id="P7000497027000000000000000040397">%rsi</code>, respectively. For each entry in the table, show the two instructions that implement the specified data movement. The first instruction in the sequence should read from memory, do the appropriate conversion, and set the appropriate portion of register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040398" id="P7000497027000000000000000040398">%rax</code>. The second instruction should then write the appropriate portion of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040399" id="P7000497027000000000000000040399">%rax</code> to memory. In both cases, the portions may be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004039A" id="P700049702700000000000000004039A">%rax</code>, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004039B" id="P700049702700000000000000004039B">%eax</code>, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004039C" id="P700049702700000000000000004039C">%ax</code>, or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004039D" id="P700049702700000000000000004039D">%al</code>, and they may differ from one another.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004039E" id="P700049702700000000000000004039E">Recall that when performing a cast that involves both a size change and a change of "signedness" in C, the operation should change the size first (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000077D_split_001.xhtml#P7000497027000000000000000000BAC"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">2.2.6</span></a>).</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P700049702700000000000000004039F" id="P700049702700000000000000004039F">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000403A0" id="P70004970270000000000000000403A0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403A1" id="P70004970270000000000000000403A1">src_t</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000403A2" id="P70004970270000000000000000403A2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403A3" id="P70004970270000000000000000403A3">dest_t</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000403A4" id="P70004970270000000000000000403A4">Instruction</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403A5" id="P70004970270000000000000000403A5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403A6" id="P70004970270000000000000000403A6">long</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403A7" id="P70004970270000000000000000403A7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403A8" id="P70004970270000000000000000403A8">long</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403A9" id="P70004970270000000000000000403A9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403AA" id="P70004970270000000000000000403AA">movq (%rdi), %rax movq %rax, (%rsi)</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403AB" id="P70004970270000000000000000403AB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403AC" id="P70004970270000000000000000403AC">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403AD" id="P70004970270000000000000000403AD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403AE" id="P70004970270000000000000000403AE">int</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403AF" id="P70004970270000000000000000403AF">__________<br class="pcalibre1 pcalibre2 pcalibre7"/>__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403B0" id="P70004970270000000000000000403B0"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002118" epub:type="pagebreak" id="P7000497027000000000000000002118" title="189"></span><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403B1" id="P70004970270000000000000000403B1">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403B2" id="P70004970270000000000000000403B2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403B3" id="P70004970270000000000000000403B3">unsigned</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403B4" id="P70004970270000000000000000403B4">__________<br class="pcalibre1 pcalibre2 pcalibre7"/>__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403B5" id="P70004970270000000000000000403B5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403B6" id="P70004970270000000000000000403B6">unsigned char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403B7" id="P70004970270000000000000000403B7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403B8" id="P70004970270000000000000000403B8">long</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403B9" id="P70004970270000000000000000403B9">__________<br class="pcalibre1 pcalibre2 pcalibre7"/>__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403BA" id="P70004970270000000000000000403BA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403BB" id="P70004970270000000000000000403BB">int</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403BC" id="P70004970270000000000000000403BC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403BD" id="P70004970270000000000000000403BD">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403BE" id="P70004970270000000000000000403BE">__________<br class="pcalibre1 pcalibre2 pcalibre7"/>__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403BF" id="P70004970270000000000000000403BF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403C0" id="P70004970270000000000000000403C0">unsigned</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403C1" id="P70004970270000000000000000403C1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403C2" id="P70004970270000000000000000403C2">unsigned char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403C3" id="P70004970270000000000000000403C3">__________<br class="pcalibre1 pcalibre2 pcalibre7"/>__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403C4" id="P70004970270000000000000000403C4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403C5" id="P70004970270000000000000000403C5">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403C6" id="P70004970270000000000000000403C6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403C7" id="P70004970270000000000000000403C7">short</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403C8" id="P70004970270000000000000000403C8">__________<br class="pcalibre1 pcalibre2 pcalibre7"/>__________</td>
</tr>
</tbody>
</table>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002131" epub:type="practice" id="P7000497027000000000000000002131"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403C9" epub:type="title" id="P70004970270000000000000000403C9"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.5 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P70004970270000000000000000034D2">327</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000403CA" id="P70004970270000000000000000403CA">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000403CB" id="P70004970270000000000000000403CB">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403CC" id="P70004970270000000000000000403CC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000403CD" id="P70004970270000000000000000403CD">You are given the following information. A function with prototype</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000403CE" id="P70004970270000000000000000403CE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403CF" id="P70004970270000000000000000403CF">
void decode1(long *xp, long *yp, long *zp);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000403D0" id="P70004970270000000000000000403D0">is compiled into assembly code, yielding the following:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000403D1" id="P70004970270000000000000000403D1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403D2" id="P70004970270000000000000000403D2">
  <i class="pcalibre17 pcalibre2 pcalibre1">void decode1(long *xp, long *yp, long *zp)</i>
  <i class="pcalibre17 pcalibre2 pcalibre1">xp in %rdi, yp in %rsi, zp in %rdx</i>
decode1:
  movq	(%rdi), %r8
  movq	(%rsi), %rcx
  movq	(%rdx), %rax
  movq	%r8, (%rsi)
  movq	%rcx, (%rdx)
  movq	%rax, (%rdi)
  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000403D3" id="P70004970270000000000000000403D3">Parameters <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403D4" id="P70004970270000000000000000403D4">xp, yp</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403D5" id="P70004970270000000000000000403D5">zp</code> are stored in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403D6" id="P70004970270000000000000000403D6">%rdi, %rsi</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403D7" id="P70004970270000000000000000403D7">%rdx</code>, respectively.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000403D8" id="P70004970270000000000000000403D8">Write C code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403D9" id="P70004970270000000000000000403D9">decode1</code> that will have an effect equivalent to the assembly code shown.</p>
</div>
</li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002143" id="P7000497027000000000000000002143"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403DA" epub:type="title" id="P70004970270000000000000000403DA"><span class="pcalibre1 pcalibre21 pcalibre2">3.4.4 </span>Pushing and Popping Stack Data</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403DB" id="P70004970270000000000000000403DB">The final two data movement operations are used to push data onto and pop data from the program stack, as documented in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002146"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.8</span></a>. As we will see, the stack plays a vital role in the handling of procedure calls. By way of background, a stack is a data structure where values can be added or deleted, but only according to a "last-in, first-out" discipline. We add data to a stack via a <i class="pcalibre17 pcalibre2 pcalibre1">push</i> operation and remove it via a <i class="pcalibre17 pcalibre2 pcalibre1">pop</i> operation, with the property that the value popped will always be the value that was most recently pushed and is still on the stack. A stack can be implemented as an array, where we always insert and remove elements from one</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002146" id="P7000497027000000000000000002146">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000403DC" id="P70004970270000000000000000403DC">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000403DD" id="P70004970270000000000000000403DD"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002149" epub:type="pagebreak" id="P7000497027000000000000000002149" title="190"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000403DE" id="P70004970270000000000000000403DE">Effect</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000403DF" id="P70004970270000000000000000403DF">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403E0" id="P70004970270000000000000000403E0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403E1" id="P70004970270000000000000000403E1">pushq</code> <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403E2" id="P70004970270000000000000000403E2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403E3" id="P70004970270000000000000000403E3">R[%rsp] ← R[%rsp] –8;<br class="pcalibre1 pcalibre2 pcalibre7"/>M[R[%rsp]] ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var></code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403E4" id="P70004970270000000000000000403E4">Push quad word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403E5" id="P70004970270000000000000000403E5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403E6" id="P70004970270000000000000000403E6">popq</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403E7" id="P70004970270000000000000000403E7"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403E8" id="P70004970270000000000000000403E8">M[R[%rsp]];<br class="pcalibre1 caption pcalibre2"/>R[%rsp] ← R[%rsp] + 8</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403E9" id="P70004970270000000000000000403E9">Pop quad word</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P70004970270000000000000000403EA" id="P70004970270000000000000000403EA"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P70004970270000000000000000403EB" epub:type="title" id="P70004970270000000000000000403EB"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.8 </span>Push and pop instructions.</h1></header></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002158" id="P7000497027000000000000000002158">
<img alt="A diagram illustrates stacks." class="pcalibre125 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6B2" id="P70004970270000000000000000403EC" src="Images/chapter-03-image-03.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P70004970270000000000000000403ED" id="P70004970270000000000000000403ED"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P70004970270000000000000000403EE" epub:type="title" id="P70004970270000000000000000403EE"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.9 </span>Illustration of stack operation.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000403EF" id="P70004970270000000000000000403EF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000403F0" id="P70004970270000000000000000403F0">By convention, we draw stacks upside down, so that the "top" of the stack is shown at the bottom. With x86-64, stacks grow toward lower addresses, so pushing involves decrementing the stack pointer (register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403F1" id="P70004970270000000000000000403F1">%rsp</code>) and storing to memory, while popping involves reading from memory and incrementing the stack pointer.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P70004970270000000000000000206D7" id="P70004970270000000000000000206D7">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000403F2" id="P70004970270000000000000000403F2">A diagram shows tables above illustrations of stacks, which has increasing address from stack “top” on bottom to stack “bottom” on top. The three illustrations are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P70004970270000000000000000403F3" id="P70004970270000000000000000403F3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000403F4" id="P70004970270000000000000000403F4"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000403F5" id="P70004970270000000000000000403F5">Initially:</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P70004970270000000000000000403F6" id="P70004970270000000000000000403F6">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000403F7" id="P70004970270000000000000000403F7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000403F8" id="P70004970270000000000000000403F8">%rax: 0x123</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000403F9" id="P70004970270000000000000000403F9"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000403FA" id="P70004970270000000000000000403FA">%rdx: 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000403FB" id="P70004970270000000000000000403FB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000403FC" id="P70004970270000000000000000403FC">%rsp: 0x108</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000403FD" id="P70004970270000000000000000403FD"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000403FE" id="P70004970270000000000000000403FE">Illustration has 0x108 at stack “top”</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P70004970270000000000000000403FF" id="P70004970270000000000000000403FF">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040400" id="P7000497027000000000000000040400"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040401" id="P7000497027000000000000000040401">Pushq %rax:</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040402" id="P7000497027000000000000000040402"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040403" id="P7000497027000000000000000040403">%rax: 0x123</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040404" id="P7000497027000000000000000040404"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040405" id="P7000497027000000000000000040405">%rdx: 0</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040406" id="P7000497027000000000000000040406"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040407" id="P7000497027000000000000000040407">%rsp: 0x100</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040408" id="P7000497027000000000000000040408"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040409" id="P7000497027000000000000000040409">Illustration has 0x123 below 0x108 and above stack “top” 0x100</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P700049702700000000000000004040A" id="P700049702700000000000000004040A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004040B" id="P700049702700000000000000004040B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004040C" id="P700049702700000000000000004040C">Popq %rdx:</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004040D" id="P700049702700000000000000004040D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004040E" id="P700049702700000000000000004040E">%rax: 0x123</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004040F" id="P700049702700000000000000004040F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040410" id="P7000497027000000000000000040410">%rdx: 0x123</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040411" id="P7000497027000000000000000040411"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040412" id="P7000497027000000000000000040412">%rsp: 0x108</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040413" id="P7000497027000000000000000040413"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040414" id="P7000497027000000000000000040414">Illustration has 0x123 below stack “top” 0x108</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040415" id="P7000497027000000000000000040415">end of the array. This end is called the <i class="pcalibre17 pcalibre2 pcalibre1">top</i> of the stack. With x86-64, the program stack is stored in some region of memory. As illustrated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002158"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.9</span></a>, the stack grows downward such that the top element of the stack has the lowest address of all stack elements. (By convention, we draw stacks upside down, with the stack "top" shown at the bottom of the figure.) The stack pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040416" id="P7000497027000000000000000040416">%rsp</code> holds the address of the top stack element.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040417" id="P7000497027000000000000000040417">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040418" id="P7000497027000000000000000040418">pushq</code> instruction provides the ability to push data onto the stack, while the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040419" id="P7000497027000000000000000040419">popq</code> instruction pops it. Each of these instructions takes a single operand—the data source for pushing and the data destination for popping.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004041A" id="P700049702700000000000000004041A">Pushing a quad word value onto the stack involves first decrementing the stack pointer by 8 and then writing the value at the new top-of-stack address. <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002165" epub:type="pagebreak" id="P7000497027000000000000000002165" title="191"></span>Therefore, the behavior of the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004041B" id="P700049702700000000000000004041B">pushq %rbp</code> is equivalent to that of the pair of instructions</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004041C" id="P700049702700000000000000004041C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004041D" id="P700049702700000000000000004041D">
subq $8,%rsp		<i class="pcalibre17 pcalibre2 pcalibre1">Decrement stack pointer</i>
movq %rbp,( %rsp)	<i class="pcalibre17 pcalibre2 pcalibre1">Store %rbp on stack</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004041E" id="P700049702700000000000000004041E">except that the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004041F" id="P700049702700000000000000004041F">pushq</code> instruction is encoded in the machine code as a single byte, whereas the pair of instructions shown above requires a total of 8 bytes. The first two columns in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002158"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.9</span></a> illustrate the effect of executing the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040420" id="P7000497027000000000000000040420">pushq %rax</code> when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040421" id="P7000497027000000000000000040421">%rsp</code> is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040422" id="P7000497027000000000000000040422">0x108</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040423" id="P7000497027000000000000000040423">%rax</code> is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040424" id="P7000497027000000000000000040424">0x123</code>. First <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040425" id="P7000497027000000000000000040425">%rsp</code> is decremented by 8, giving <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040426" id="P7000497027000000000000000040426">0x100</code>, and then <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040427" id="P7000497027000000000000000040427">0x123</code> is stored at memory address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040428" id="P7000497027000000000000000040428">0x100</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040429" id="P7000497027000000000000000040429">Popping a quad word involves reading from the top-of-stack location and then incrementing the stack pointer by 8. Therefore, the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004042A" id="P700049702700000000000000004042A">popq %rax</code> is equivalent to the following pair of instructions:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004042B" id="P700049702700000000000000004042B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004042C" id="P700049702700000000000000004042C">
movq (%rsp),%rax	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Read %rax from stack</i></b>
addq $8,%rsp		<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Increment stack pointer</i></b>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004042D" id="P700049702700000000000000004042D">The third column of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002158"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.9</span></a> illustrates the effect of executing the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004042E" id="P700049702700000000000000004042E">popq %edx</code> immediately after executing the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004042F" id="P700049702700000000000000004042F">pushq</code>. Value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040430" id="P7000497027000000000000000040430">0x123</code> is read from memory and written to register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040431" id="P7000497027000000000000000040431">%rdx</code>. Register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040432" id="P7000497027000000000000000040432">%rspis</code> incremented back to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040433" id="P7000497027000000000000000040433">0x108</code>. As shown in the figure, the value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040434" id="P7000497027000000000000000040434">0x123</code> remains at memory location <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040435" id="P7000497027000000000000000040435">0x104</code> until it is overwritten (e.g., by another push operation). However, the stack top is always considered to be the address indicated by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040436" id="P7000497027000000000000000040436">%rsp</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040437" id="P7000497027000000000000000040437">Since the stack is contained in the same memory as the program code and other forms of program data, programs can access arbitrary positions within the stack using the standard memory addressing methods. For example, assuming the topmost element of the stack is a quad word, the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040438" id="P7000497027000000000000000040438">movq 8(%rsp), %rdx</code> will copy the second quad word from the stack to register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040439" id="P7000497027000000000000000040439">%rdx</code>.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.5 Arithmetic and Logical Operations</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000002185"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P700049702700000000000000004043A" epub:type="title" id="P700049702700000000000000004043A"><span class="pcalibre1 pcalibre21 pcalibre2">3.5 </span>Arithmetic and Logical Operations</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004043B" id="P700049702700000000000000004043B"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002190"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10</span></a> lists some of the x86-64 integer and logic operations. Most of the operations are given as instruction classes, as they can have different variants with different operand sizes. (Only <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004043C" id="P700049702700000000000000004043C">leaq</code> has no other size variants.) For example, the instruction class <span class="pcalibre1 pcalibre29 pcalibre2">add </span>consists of four addition instructions: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004043D" id="P700049702700000000000000004043D">addb, addw, addl</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004043E" id="P700049702700000000000000004043E">addq</code>, adding bytes, words, double words, and quad words, respectively. Indeed, each of the instruction classes shown has instructions for operating on these four different sizes of data. The operations are divided into four groups: load effective address, unary, binary, and shifts. <i class="pcalibre17 pcalibre2 pcalibre1">Binary</i> operations have two operands, while <i class="pcalibre17 pcalibre2 pcalibre1">unary</i> operations have one operand. These operands are specified using the same notation as described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001F3C"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.4</span></a>.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000218B" id="P700049702700000000000000000218B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004043F" epub:type="title" id="P700049702700000000000000004043F"><span class="pcalibre1 pcalibre21 pcalibre2">3.5.1 </span>Load Effective Address</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040440" id="P7000497027000000000000000040440">The <i class="pcalibre17 pcalibre2 pcalibre1">load effective address</i> instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040441" id="P7000497027000000000000000040441">leaq</code> is actually a variant of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040442" id="P7000497027000000000000000040442">movq</code> instruction. It has the form of an instruction that reads from memory to a register,<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000021F7" epub:type="pagebreak" id="P70004970270000000000000000021F7" title="192"></span></p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002190" id="P7000497027000000000000000002190">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040443" id="P7000497027000000000000000040443">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" colspan="2" data-uri="chapter03.xhtml#P7000497027000000000000000040444" id="P7000497027000000000000000040444">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040445" id="P7000497027000000000000000040445">Effect</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040446" id="P7000497027000000000000000040446">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040447" id="P7000497027000000000000000040447"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040448" id="P7000497027000000000000000040448">leaq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040449" id="P7000497027000000000000000040449"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004044A" id="P700049702700000000000000004044A"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← &amp;<var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004044B" id="P700049702700000000000000004044B">Load effective address</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004044C" id="P700049702700000000000000004044C"><span class="pcalibre1 pcalibre2 pcalibre84">inc </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004044D" id="P700049702700000000000000004044D"><var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004044E" id="P700049702700000000000000004044E"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var>+1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004044F" id="P700049702700000000000000004044F">Increment</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040450" id="P7000497027000000000000000040450"><span class="pcalibre1 pcalibre2 pcalibre84">dec </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040451" id="P7000497027000000000000000040451"><var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040452" id="P7000497027000000000000000040452"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var>-1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040453" id="P7000497027000000000000000040453">Decrement</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040454" id="P7000497027000000000000000040454"><span class="pcalibre1 pcalibre2 pcalibre84">neg </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040455" id="P7000497027000000000000000040455"><var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040456" id="P7000497027000000000000000040456"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← -<var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040457" id="P7000497027000000000000000040457">Negate</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040458" id="P7000497027000000000000000040458"><span class="pcalibre1 pcalibre2 pcalibre84">not </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040459" id="P7000497027000000000000000040459"><var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004045A" id="P700049702700000000000000004045A"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← ~<var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004045B" id="P700049702700000000000000004045B">Complement</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004045C" id="P700049702700000000000000004045C"><span class="pcalibre1 pcalibre2 pcalibre84">add </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004045D" id="P700049702700000000000000004045D"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004045E" id="P700049702700000000000000004045E"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var>+<var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004045F" id="P700049702700000000000000004045F">Add</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040460" id="P7000497027000000000000000040460"><span class="pcalibre1 pcalibre2 pcalibre84">sub </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040461" id="P7000497027000000000000000040461"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040462" id="P7000497027000000000000000040462"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var>-<var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040463" id="P7000497027000000000000000040463">Subtract</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040464" id="P7000497027000000000000000040464"><span class="pcalibre1 pcalibre2 pcalibre84">imul </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040465" id="P7000497027000000000000000040465"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040466" id="P7000497027000000000000000040466"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var>*<var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040467" id="P7000497027000000000000000040467">Multiply</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040468" id="P7000497027000000000000000040468"><span class="pcalibre1 pcalibre2 pcalibre84">xor </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040469" id="P7000497027000000000000000040469"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004046A" id="P700049702700000000000000004046A"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ←<var class="pcalibre17 pcalibre2 pcalibre1">D</var> ^ <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004046B" id="P700049702700000000000000004046B">Exclusive-or</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004046C" id="P700049702700000000000000004046C"><span class="pcalibre1 pcalibre2 pcalibre84">or </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004046D" id="P700049702700000000000000004046D"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004046E" id="P700049702700000000000000004046E"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var> | <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004046F" id="P700049702700000000000000004046F">Or</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040470" id="P7000497027000000000000000040470"><span class="pcalibre1 pcalibre2 pcalibre84">and </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040471" id="P7000497027000000000000000040471"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040472" id="P7000497027000000000000000040472"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var>&amp;<var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040473" id="P7000497027000000000000000040473">And</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040474" id="P7000497027000000000000000040474"><span class="pcalibre1 pcalibre2 pcalibre84">sal </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040475" id="P7000497027000000000000000040475"><var class="pcalibre17 pcalibre2 pcalibre1">k</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040476" id="P7000497027000000000000000040476"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <i class="pcalibre17 pcalibre2 pcalibre1">D &lt;&lt;k</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040477" id="P7000497027000000000000000040477">Left shift</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040478" id="P7000497027000000000000000040478"><span class="pcalibre1 pcalibre2 pcalibre84">shl </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040479" id="P7000497027000000000000000040479"><var class="pcalibre17 pcalibre2 pcalibre1">k</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004047A" id="P700049702700000000000000004047A"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var> &lt;&lt; <var class="pcalibre17 pcalibre2 pcalibre1">k</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004047B" id="P700049702700000000000000004047B">Left shift (same as <span class="pcalibre1 pcalibre2 pcalibre84">sal</span>)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004047C" id="P700049702700000000000000004047C"><span class="pcalibre1 pcalibre2 pcalibre84">sar </span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004047D" id="P700049702700000000000000004047D"><var class="pcalibre17 pcalibre2 pcalibre1">k</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004047E" id="P700049702700000000000000004047E"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var> &gt;&gt;<sub class="pcalibre97 pcalibre2 pcalibre1">A</sub> <var class="pcalibre17 pcalibre2 pcalibre1">k</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004047F" id="P700049702700000000000000004047F">Arithmetic right shift</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040480" id="P7000497027000000000000000040480"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040481" id="P7000497027000000000000000040481"><span class="pcalibre1 pcalibre2 pcalibre84">shr</span></code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040482" id="P7000497027000000000000000040482"><var class="pcalibre17 pcalibre2 pcalibre1">k</var>, <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040483" id="P7000497027000000000000000040483"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">D</var> &gt;&gt;<sub class="pcalibre97 pcalibre2 pcalibre1">L</sub> <var class="pcalibre17 pcalibre2 pcalibre1">k</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040484" id="P7000497027000000000000000040484">Logical right shift</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040485" id="P7000497027000000000000000040485"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040486" epub:type="title" id="P7000497027000000000000000040486"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.10 </span>Integer arithmetic operations.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040487" id="P7000497027000000000000000040487"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040488" id="P7000497027000000000000000040488">The load effective address (leaq) instruction is commonly used to perform simple arithmetic. The remaining ones are more standard unary or binary operations. We use the notation <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040489" id="P7000497027000000000000000040489">&gt;&gt;<sub class="pcalibre97 pcalibre2 pcalibre1">A</sub></code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004048A" id="P700049702700000000000000004048A">&gt;&gt;<sub class="pcalibre97 pcalibre2 pcalibre1">L</sub></code> to denote arithmetic and logical right shift, respectively. Note the nonintuitive ordering of the operands with ATT-format assembly code.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004048B" id="P700049702700000000000000004048B">but it does not reference memory at all. Its first operand appears to be a memory reference, but instead of reading from the designated location, the instruction copies the effective address to the destination. We indicate this computation in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002190"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10</span></a> using the C address operator &amp;<var class="pcalibre17 pcalibre2 pcalibre1">S</var>. This instruction can be used to generate pointers for later memory references. In addition, it can be used to compactly describe common arithmetic operations. For example, if register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004048C" id="P700049702700000000000000004048C">%rdx</code> contains value <var class="pcalibre17 pcalibre2 pcalibre1">x</var>, then the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004048D" id="P700049702700000000000000004048D">leaq 7(%rdx,%rdx,4), %rax</code> will set register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004048E" id="P700049702700000000000000004048E">%rax</code> to 5<var class="pcalibre17 pcalibre2 pcalibre1">x</var> + 7. Compilers often find clever uses of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004048F" id="P700049702700000000000000004048F">leaq</code> that have nothing to do with effective address computations. The destination operand must be a register.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000021DE" epub:type="practice" id="P70004970270000000000000000021DE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040490" epub:type="title" id="P7000497027000000000000000040490"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P70004970270000000000000000034D2">327</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040491" id="P7000497027000000000000000040491">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040492" id="P7000497027000000000000000040492">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040493" id="P7000497027000000000000000040493"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040494" id="P7000497027000000000000000040494">Suppose register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040495" id="P7000497027000000000000000040495">%rax</code> holds value <var class="pcalibre17 pcalibre2 pcalibre1">x</var> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040496" id="P7000497027000000000000000040496">%rcx</code> holds value <var class="pcalibre17 pcalibre2 pcalibre1">y</var>. Fill in the table below with formulas indicating the value that will be stored in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040497" id="P7000497027000000000000000040497">%rdx</code> for each of the given assembly-code instructions:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040498" id="P7000497027000000000000000040498">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040499" id="P7000497027000000000000000040499">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004049A" id="P700049702700000000000000004049A">Result</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004049B" id="P700049702700000000000000004049B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004049C" id="P700049702700000000000000004049C">leaq 6(%rax), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004049D" id="P700049702700000000000000004049D">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004049E" id="P700049702700000000000000004049E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004049F" id="P700049702700000000000000004049F">leaq (%rax,%rcx), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404A0" id="P70004970270000000000000000404A0">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404A1" id="P70004970270000000000000000404A1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404A2" id="P70004970270000000000000000404A2">leaq (%rax,%rcx,4), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404A3" id="P70004970270000000000000000404A3">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404A4" id="P70004970270000000000000000404A4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404A5" id="P70004970270000000000000000404A5">leaq 7(%rax,%rax,8), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404A6" id="P70004970270000000000000000404A6">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404A7" id="P70004970270000000000000000404A7"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000021FE" epub:type="pagebreak" id="P70004970270000000000000000021FE" title="193"></span><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404A8" id="P70004970270000000000000000404A8">leaq 0xA(,%rcx,4), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404A9" id="P70004970270000000000000000404A9">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404AA" id="P70004970270000000000000000404AA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404AB" id="P70004970270000000000000000404AB">leaq 9(%rax, %rcx,2), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404AC" id="P70004970270000000000000000404AC">__________</td>
</tr>
</tbody>
</table></div>
</li>
</ol>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404AD" id="P70004970270000000000000000404AD">As an illustration of the use of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404AE" id="P70004970270000000000000000404AE">leaq</code> in compiled code, consider the following C program:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000404AF" id="P70004970270000000000000000404AF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404B0" id="P70004970270000000000000000404B0">
long scale(long x, long y, long z) {
    long t = x + 4 * y + 12 * z;
    return t;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404B1" id="P70004970270000000000000000404B1">When compiled, the arithmetic operations of the function are implemented by a sequence of three <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404B2" id="P70004970270000000000000000404B2">leaq</code> functions, as is documented by the comments on the right-hand side:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000404B3" id="P70004970270000000000000000404B3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404B4" id="P70004970270000000000000000404B4">
  <i class="pcalibre17 pcalibre2 pcalibre1">long scale(long x, long y, long z)</i>
  <i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, z in %rdx</i>
scale:
  leaq	(%rdi,%rsi,4), %rax		<i class="pcalibre17 pcalibre2 pcalibre1">x + 4*y</i>
  leaq	(%rdx,%rdx,2), %rdx		<i class="pcalibre17 pcalibre2 pcalibre1">z + 2*z = 3*z</i>
  leaq	(%rax,%rdx,4), %rax		<i class="pcalibre17 pcalibre2 pcalibre1">(x+4*y) + 4*(3*z) = x + 4*y + 12*z</i>
  ret
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404B5" id="P70004970270000000000000000404B5">The ability of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404B6" id="P70004970270000000000000000404B6">leaq</code> instruction to perform addition and limited forms of multiplication proves useful when compiling simple arithmetic expressions such as this example.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002208" epub:type="practice" id="P7000497027000000000000000002208"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404B7" epub:type="title" id="P70004970270000000000000000404B7"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.7 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003508">328</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000404B8" id="P70004970270000000000000000404B8">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000404B9" id="P70004970270000000000000000404B9">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404BA" id="P70004970270000000000000000404BA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000404BB" id="P70004970270000000000000000404BB">Consider the following code, in which we have omitted the expression being computed:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000404BC" id="P70004970270000000000000000404BC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404BD" id="P70004970270000000000000000404BD">
long scale2(long x, long y, long z) {
  longt= __________;
  return t;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000404BE" id="P70004970270000000000000000404BE">Compiling the actual function with <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>yields the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000404BF" id="P70004970270000000000000000404BF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404C0" id="P70004970270000000000000000404C0">
  <i class="pcalibre17 pcalibre2 pcalibre1">long scale2(long x, long y, long z)</i>
  <i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, z in %rdx</i>
scale2:
  leaq	(%rdi,%rdi,4), %rax
  leaq	(%rax,%rsi,2), %rax
  leaq (%rax,%rdx,8), %rax
  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000404C1" id="P70004970270000000000000000404C1">Fill in the missing expression in the C code.</p>
</div></li>
</ol></section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002214" id="P7000497027000000000000000002214"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404C2" epub:type="title" id="P70004970270000000000000000404C2"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002216" epub:type="pagebreak" id="P7000497027000000000000000002216" title="194"></span><span class="pcalibre1 pcalibre21 pcalibre2">3.5.2 </span>Unary and Binary Operations</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404C3" id="P70004970270000000000000000404C3">Operations in the second group are unary operations, with the single operand serving as both source and destination. This operand can be either a register or a memory location. For example, the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404C4" id="P70004970270000000000000000404C4">incq (%rsp)</code> causes the 8-byte element on the top of the stack to be incremented. This syntax is reminiscent of the C increment (++) and decrement (−−) operators.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404C5" id="P70004970270000000000000000404C5">The third group consists of binary operations, where the second operand is used as both a source and a destination. This syntax is reminiscent of the C assignment operators, such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404C6" id="P70004970270000000000000000404C6">x -= y</code>. Observe, however, that the source operand is given first and the destination second. This looks peculiar for noncommutative operations. For example, the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404C7" id="P70004970270000000000000000404C7">subq %rax,%rdx</code> decrements register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404C8" id="P70004970270000000000000000404C8">%rdx</code> by the value in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404C9" id="P70004970270000000000000000404C9">%rax</code>. (It helps to read the instruction as "Subtract <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404CA" id="P70004970270000000000000000404CA">%rax</code> from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404CB" id="P70004970270000000000000000404CB">%rdx</code>.") The first operand can be either an immediate value, a register, or a memory location. The second can be either a register or a memory location. As with the <span class="pcalibre1 pcalibre29 pcalibre2">mov </span>instructions, the two operands cannot both be memory locations. Note that when the second operand is a memory location, the processor must read the value from memory, perform the operation, and then write the result back to memory.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002220" epub:type="practice" id="P7000497027000000000000000002220"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404CC" epub:type="title" id="P70004970270000000000000000404CC"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.8 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003508">328</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000404CD" id="P70004970270000000000000000404CD">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000404CE" id="P70004970270000000000000000404CE">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404CF" id="P70004970270000000000000000404CF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000404D0" id="P70004970270000000000000000404D0">Assume the following values are stored at the indicated memory addresses and registers:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000404D1" id="P70004970270000000000000000404D1">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000404D2" id="P70004970270000000000000000404D2">Address</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000404D3" id="P70004970270000000000000000404D3">Value</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000404D4" id="P70004970270000000000000000404D4">Register</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000404D5" id="P70004970270000000000000000404D5">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404D6" id="P70004970270000000000000000404D6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404D7" id="P70004970270000000000000000404D7">0x100</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404D8" id="P70004970270000000000000000404D8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404D9" id="P70004970270000000000000000404D9">0xFF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404DA" id="P70004970270000000000000000404DA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404DB" id="P70004970270000000000000000404DB">%rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404DC" id="P70004970270000000000000000404DC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404DD" id="P70004970270000000000000000404DD">0x100</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404DE" id="P70004970270000000000000000404DE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404DF" id="P70004970270000000000000000404DF">0x108</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404E0" id="P70004970270000000000000000404E0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404E1" id="P70004970270000000000000000404E1">0xAB</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404E2" id="P70004970270000000000000000404E2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404E3" id="P70004970270000000000000000404E3">%rcx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404E4" id="P70004970270000000000000000404E4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404E5" id="P70004970270000000000000000404E5">0x1</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404E6" id="P70004970270000000000000000404E6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404E7" id="P70004970270000000000000000404E7">0x110</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404E8" id="P70004970270000000000000000404E8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404E9" id="P70004970270000000000000000404E9">0x13</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404EA" id="P70004970270000000000000000404EA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404EB" id="P70004970270000000000000000404EB">%rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404EC" id="P70004970270000000000000000404EC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404ED" id="P70004970270000000000000000404ED">0x3</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404EE" id="P70004970270000000000000000404EE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404EF" id="P70004970270000000000000000404EF">0x118</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404F0" id="P70004970270000000000000000404F0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404F1" id="P70004970270000000000000000404F1">0x11</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000404F2" id="P70004970270000000000000000404F2">Fill in the following table showing the effects of the following instructions, in terms of both the register or memory location that will be updated and the resulting value:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000404F3" id="P70004970270000000000000000404F3">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000404F4" id="P70004970270000000000000000404F4">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000404F5" id="P70004970270000000000000000404F5">Destination</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000404F6" id="P70004970270000000000000000404F6">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404F7" id="P70004970270000000000000000404F7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404F8" id="P70004970270000000000000000404F8">addq %rcx,(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404F9" id="P70004970270000000000000000404F9">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404FA" id="P70004970270000000000000000404FA">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404FB" id="P70004970270000000000000000404FB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000404FC" id="P70004970270000000000000000404FC">subq %rdx,8(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404FD" id="P70004970270000000000000000404FD">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404FE" id="P70004970270000000000000000404FE">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000404FF" id="P70004970270000000000000000404FF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040500" id="P7000497027000000000000000040500">imulq $16,( %rax,%rdx,8)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040501" id="P7000497027000000000000000040501">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040502" id="P7000497027000000000000000040502">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040503" id="P7000497027000000000000000040503"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040504" id="P7000497027000000000000000040504">incq 16(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040505" id="P7000497027000000000000000040505">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040506" id="P7000497027000000000000000040506">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040507" id="P7000497027000000000000000040507"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040508" id="P7000497027000000000000000040508">decq %rcx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040509" id="P7000497027000000000000000040509">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004050A" id="P700049702700000000000000004050A">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004050B" id="P700049702700000000000000004050B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004050C" id="P700049702700000000000000004050C">subq %rdx,%rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004050D" id="P700049702700000000000000004050D">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004050E" id="P700049702700000000000000004050E">__________</td>
</tr>
</tbody>
</table>
</div>
</li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002264" id="P7000497027000000000000000002264"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004050F" epub:type="title" id="P700049702700000000000000004050F"><span class="pcalibre1 pcalibre21 pcalibre2">3.5.3 </span>Shift Operations</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040510" id="P7000497027000000000000000040510">The final group consists of shift operations, where the shift amount is given first and the value to shift is given second. Both arithmetic and logical right shifts are <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002267" epub:type="pagebreak" id="P7000497027000000000000000002267" title="195"></span>possible. The different shift instructions can specify the shift amount either as an immediate value or with the single-byte register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040511" id="P7000497027000000000000000040511">%cl</code>. (These instructions are unusual in only allowing this specific register as the operand.) In principle, having a 1-byte shift amount would make it possible to encode shift amounts ranging up to 2<sup class="pcalibre1 pcalibre2 pcalibre85">8</sup> − 1 = 255. With x86-64, a shift instruction operating on data values that are <var class="pcalibre17 pcalibre2 pcalibre1">w</var> bits long determines the shift amount from the low-order <var class="pcalibre17 pcalibre2 pcalibre1">m</var> bits of register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040512" id="P7000497027000000000000000040512">%cl</code>, where 2<sup class="pcalibre1 pcalibre2 pcalibre85"><var class="pcalibre17 pcalibre2 pcalibre1">m</var></sup> = <var class="pcalibre17 pcalibre2 pcalibre1">w</var>. The higher-order bits are ignored. So, for example, when register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040513" id="P7000497027000000000000000040513">%cl</code> has hexadecimal value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040514" id="P7000497027000000000000000040514">0xFF</code>, then instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040515" id="P7000497027000000000000000040515">salb</code> would shift by 7, while <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040516" id="P7000497027000000000000000040516">salw</code> would shift by 15, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040517" id="P7000497027000000000000000040517">sall</code> would shift by 31, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040518" id="P7000497027000000000000000040518">salq</code> would shift by 63.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040519" id="P7000497027000000000000000040519">As <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002190"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10</span></a> indicates, there are two names for the left shift instruction: <span class="pcalibre1 pcalibre29 pcalibre2">sal </span>and <span class="pcalibre1 pcalibre29 pcalibre2">shl</span>. Both have the same effect, filling from the right with zeros. The right shift instructions differ in that <span class="pcalibre1 pcalibre29 pcalibre2">sar </span>performs an arithmetic shift (fill with copies of the sign bit), whereas <span class="pcalibre1 pcalibre29 pcalibre2">shr </span>performs a logical shift (fill with zeros). The destination operand of a shift operation can be either a register or a memory location. We denote the two different right shift operations in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002190"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10</span></a> as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004051A" id="P700049702700000000000000004051A">&gt;&gt;<sub class="pcalibre97 pcalibre2 pcalibre1">A</sub></code> (arithmetic) and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004051B" id="P700049702700000000000000004051B">&gt;&gt;<sub class="pcalibre97 pcalibre2 pcalibre1">L</sub></code> (logical).</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002273" epub:type="practice" id="P7000497027000000000000000002273"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004051C" epub:type="title" id="P700049702700000000000000004051C"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.9 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003508">328</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004051D" id="P700049702700000000000000004051D">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004051E" id="P700049702700000000000000004051E">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004051F" id="P700049702700000000000000004051F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040520" id="P7000497027000000000000000040520">Suppose we want to generate assembly code for the following C function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040521" id="P7000497027000000000000000040521"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040522" id="P7000497027000000000000000040522">
long shift_left4_rightn(long x, long n)
{
  x ≪= 4;
  x ≫= n;
  return x;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040523" id="P7000497027000000000000000040523">The code that follows is a portion of the assembly code that performs the actual shifts and leaves the final value in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040524" id="P7000497027000000000000000040524">%rax.</code> Two key instructions have been omitted. Parameters x and n are stored in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040525" id="P7000497027000000000000000040525">%rdi</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040526" id="P7000497027000000000000000040526">%rsi</code>, respectively.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040527" id="P7000497027000000000000000040527"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040528" id="P7000497027000000000000000040528">
  <i class="pcalibre17 pcalibre2 pcalibre1">long shift_left4_rightn(long x, long n)</i>
  <i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, n in %rsi</i>
shift_left4_rightn:
  movq    %rdi, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Get x</i>
________________	<i class="pcalibre17 pcalibre2 pcalibre1">x ≪= 4</i>
  movl    %esi, %ecx    <i class="pcalibre17 pcalibre2 pcalibre1">Get n (4 bytes)</i>
________________	<i class="pcalibre17 pcalibre2 pcalibre1">x ≫= n</i>
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040529" id="P7000497027000000000000000040529">Fill in the missing instructions, following the annotations on the right. The right shift should be performed arithmetically.</p>
</div></li></ol>
</section>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002282" id="P7000497027000000000000000002282">
<ol class="pcalibre1 pcalibre2 pcalibre118" data-uri="chapter03.xhtml#P700049702700000000000000004052A" id="P700049702700000000000000004052A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004052B" id="P700049702700000000000000004052B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004052C" id="P700049702700000000000000004052C"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002286" epub:type="pagebreak" id="P7000497027000000000000000002286" title="196"></span>C code</p>
<pre class="pcalibre124 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004052D" id="P700049702700000000000000004052D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004052E" id="P700049702700000000000000004052E">
long arith(long x, long y, long z)
{
    long t1 = x ^ y;
    long t2 = z * 48;
    long t3 = t1 &amp; 0x0F0F0F0F;
    long t4 = t2 - t3;
    return t4;
}
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004052F" id="P700049702700000000000000004052F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040530" id="P7000497027000000000000000040530">Assembly code</p>
<pre class="pcalibre124 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040531" id="P7000497027000000000000000040531"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040532" id="P7000497027000000000000000040532">
  <i class="pcalibre17 pcalibre2 pcalibre1">long arith(long x, long y, long z)</i>
  <i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, z in %rdx</i>
1	arith:
2	  xorq %rsi, %rdi		<i class="pcalibre17 pcalibre2 pcalibre1">t1 = x ^ y</i>
3	  leaq (%rdx,%rdx,2), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">3*z</i>
4	  salq $4, %rax			<i class="pcalibre17 pcalibre2 pcalibre1">t2 = 16 * (3*z) = 48*z</i>
5	  andl $252645135, %edi		<i class="pcalibre17 pcalibre2 pcalibre1">t3 = t1 &amp; 0x0F0F0F0F</i>
6	  subq %rdi, %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Return t2 - t3</i>
7	  ret
</code></pre></li>
</ol>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040533" id="P7000497027000000000000000040533"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040534" epub:type="title" id="P7000497027000000000000000040534"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.11 </span>C and assembly code for arithmetic function.</h1></header></figcaption>
</figure>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000228F" id="P700049702700000000000000000228F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040535" epub:type="title" id="P7000497027000000000000000040535"><span class="pcalibre1 pcalibre21 pcalibre2">3.5.4 </span>Discussion</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040536" id="P7000497027000000000000000040536">We see that most of the instructions shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002190"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10</span></a> can be used for either unsigned or two's-complement arithmetic. Only right shifting requires instructions that differentiate between signed versus unsigned data. This is one of the features that makes two's-complement arithmetic the preferred way to implement signed integer arithmetic.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040537" id="P7000497027000000000000000040537"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002282"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.11</span></a> shows an example of a function that performs arithmetic operations and its translation into assembly code. Arguments <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040538" id="P7000497027000000000000000040538">x, y</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040539" id="P7000497027000000000000000040539">z</code> are initially stored in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004053A" id="P700049702700000000000000004053A">%rdi, %rsi</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004053B" id="P700049702700000000000000004053B">%rdx</code>, respectively. The assembly-code instructions correspond closely with the lines of C source code. Line 2 computes the value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004053C" id="P700049702700000000000000004053C">x^y</code>. Lines 3 and 4 compute the expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004053D" id="P700049702700000000000000004053D">z*48</code> by a combination of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004053E" id="P700049702700000000000000004053E">leaq</code> and shift instructions. Line 5 computes the <span class="pcalibre1 pcalibre29 pcalibre2">and </span>of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004053F" id="P700049702700000000000000004053F">t1</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040540" id="P7000497027000000000000000040540">0x0F0F0F0F</code>. The final subtraction is computed by line 6. Since the destination of the subtraction is register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040541" id="P7000497027000000000000000040541">%rax</code>, this will be the value returned by the function.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040542" id="P7000497027000000000000000040542">In the assembly code of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002282"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.11</span></a>, the sequence of values in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040543" id="P7000497027000000000000000040543">%rax</code> corresponds to program values <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040544" id="P7000497027000000000000000040544">3*z, z*48</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040545" id="P7000497027000000000000000040545">t4</code> (as the return value). In general, compilers generate code that uses individual registers for multiple program values and moves program values among the registers.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000022A1" epub:type="practice" id="P70004970270000000000000000022A1"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040546" epub:type="title" id="P7000497027000000000000000040546"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003561">329</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040547" id="P7000497027000000000000000040547">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040548" id="P7000497027000000000000000040548">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040549" id="P7000497027000000000000000040549"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004054A" id="P700049702700000000000000004054A">In the following variant of the function of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002282"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.11(a)</span></a>, the expressions have been replaced by blanks:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004054B" id="P700049702700000000000000004054B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004054C" id="P700049702700000000000000004054C">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000022A9" epub:type="pagebreak" id="P70004970270000000000000000022A9" title="197"></span>
long arith2(long x, long y, long z)
{
  longt1= __________;
  longt2= __________;
  longt3= __________;
  longt4= __________;
  return t4;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004054D" id="P700049702700000000000000004054D">The portion of the generated assembly code implementing these expressions is as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004054E" id="P700049702700000000000000004054E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004054F" id="P700049702700000000000000004054F">
  <i class="pcalibre17 pcalibre2 pcalibre1">long arith2(long x, long y, long z)</i>
  <i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, z in %rdx</i>
arith2:
  orq	%rsi, %rdi
  sarq	$3, %rdi
  notq	%rdi
  movq	%rdx, %rax
  subq	%rdi, %rax
  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040550" id="P7000497027000000000000000040550">Based on this assembly code, fill in the missing portions of the C code.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000022AE" epub:type="practice" id="P70004970270000000000000000022AE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040551" epub:type="title" id="P7000497027000000000000000040551"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.11 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003561">329</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040552" id="P7000497027000000000000000040552">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040553" id="P7000497027000000000000000040553">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040554" id="P7000497027000000000000000040554"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040555" id="P7000497027000000000000000040555">It is common to find assembly-code lines of the form</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040556" id="P7000497027000000000000000040556"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040557" id="P7000497027000000000000000040557">
xorq %rdx,%rdx
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040558" id="P7000497027000000000000000040558">in code that was generated from C where no <span class="pcalibre1 pcalibre29 pcalibre2">exclusive-or </span>operations were present.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000040559" id="P7000497027000000000000000040559">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004055A" id="P700049702700000000000000004055A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004055B" id="P700049702700000000000000004055B">Explain the effect of this particular <span class="pcalibre1 pcalibre29 pcalibre2">exclusive-or </span>instruction and what useful operation it implements.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004055C" id="P700049702700000000000000004055C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004055D" id="P700049702700000000000000004055D">What would be the more straightforward way to express this operation in assembly code?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004055E" id="P700049702700000000000000004055E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004055F" id="P700049702700000000000000004055F">Compare the number of bytes to encode these two different implementations of the same operation.</p></li></ol>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000022BE" id="P70004970270000000000000000022BE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040560" epub:type="title" id="P7000497027000000000000000040560"><span class="pcalibre1 pcalibre21 pcalibre2">3.5.5 </span>Special Arithmetic Operations</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040561" id="P7000497027000000000000000040561">As we saw in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000000CB3_split_000.xhtml#P7000497027000000000000000000CB3"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">2.3</span></a>, multiplying two 64-bit signed or unsigned integers can yield a product that requires 128 bits to represent. The x86-64 instruction set provides limited support for operations involving 128-bit (16-byte) numbers. Continuing with the naming convention of word (2 bytes), double word (4 bytes), and quad word (8 bytes), Intel refers to a 16-byte quantity as an <i class="pcalibre17 pcalibre2 pcalibre1">oct word</i>. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000022C1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.12</span></a></p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P70004970270000000000000000022C1" id="P70004970270000000000000000022C1">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040562" id="P7000497027000000000000000040562">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040563" id="P7000497027000000000000000040563"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P70004970270000000000000000022C4" epub:type="pagebreak" id="P70004970270000000000000000022C4" title="198"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040564" id="P7000497027000000000000000040564">Effect</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040565" id="P7000497027000000000000000040565">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040566" id="P7000497027000000000000000040566"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040567" id="P7000497027000000000000000040567">imulq</code> <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040568" id="P7000497027000000000000000040568">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040569" id="P7000497027000000000000000040569">%rdx</code>]:R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004056A" id="P700049702700000000000000004056A">%rax</code>] ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var> × R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004056B" id="P700049702700000000000000004056B">%rax</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004056C" id="P700049702700000000000000004056C">Signed full multiply</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004056D" id="P700049702700000000000000004056D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004056E" id="P700049702700000000000000004056E">mulq</code> <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004056F" id="P700049702700000000000000004056F">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040570" id="P7000497027000000000000000040570">%rdx</code>]:R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040571" id="P7000497027000000000000000040571">%rax</code>] ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var> × R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040572" id="P7000497027000000000000000040572">%rax</code>]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040573" id="P7000497027000000000000000040573">Unsigned full multiply</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040574" id="P7000497027000000000000000040574"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040575" id="P7000497027000000000000000040575">cqto</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040576" id="P7000497027000000000000000040576">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040577" id="P7000497027000000000000000040577">%rdx</code>]:R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040578" id="P7000497027000000000000000040578">%rax</code>] ← SignExtend(R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040579" id="P7000497027000000000000000040579">%rax</code>])</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004057A" id="P700049702700000000000000004057A">Convert to oct word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004057B" id="P700049702700000000000000004057B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004057C" id="P700049702700000000000000004057C">idivq</code> <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004057D" id="P700049702700000000000000004057D">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004057E" id="P700049702700000000000000004057E">%rdx</code>] ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004057F" id="P700049702700000000000000004057F">%rdx</code>]:R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040580" id="P7000497027000000000000000040580">%rax</code>] mod <var class="pcalibre17 pcalibre2 pcalibre1">S</var>;<br class="pcalibre1 pcalibre2 pcalibre7"/>R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040581" id="P7000497027000000000000000040581">%rax</code>] ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040582" id="P7000497027000000000000000040582">%rdx</code>]:R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040583" id="P7000497027000000000000000040583">%rax</code>] ÷ <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040584" id="P7000497027000000000000000040584">Signed divide</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040585" id="P7000497027000000000000000040585"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040586" id="P7000497027000000000000000040586">divq</code> <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040587" id="P7000497027000000000000000040587">R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040588" id="P7000497027000000000000000040588">%rdx</code>] ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040589" id="P7000497027000000000000000040589">%rdx</code>]:R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004058A" id="P700049702700000000000000004058A">%rax</code>] mod <var class="pcalibre17 pcalibre2 pcalibre1">S</var>;<br class="pcalibre1 pcalibre2 pcalibre7"/>R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004058B" id="P700049702700000000000000004058B">%rax</code>] ← R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004058C" id="P700049702700000000000000004058C">%rdx</code>]:R[<code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004058D" id="P700049702700000000000000004058D">%rax</code>] ÷ <var class="pcalibre17 pcalibre2 pcalibre1">S</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004058E" id="P700049702700000000000000004058E">Unsigned divide</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P700049702700000000000000004058F" id="P700049702700000000000000004058F"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040590" epub:type="title" id="P7000497027000000000000000040590"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.12 </span>Special arithmetic operations.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040591" id="P7000497027000000000000000040591"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040592" id="P7000497027000000000000000040592">These operations provide full 128-bit multiplication and division, for both signed and unsigned numbers. The pair of registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040593" id="P7000497027000000000000000040593">%rdx</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040594" id="P7000497027000000000000000040594">%rax</code> are viewed as forming a single 128-bit oct word.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040595" id="P7000497027000000000000000040595">describes instructions that support generating the full 128-bit product of two 64-bit numbers, as well as integer division.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040596" id="P7000497027000000000000000040596">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040597" id="P7000497027000000000000000040597">imulq</code> instruction has two different forms One form, shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002190"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10</span></a>, is as a member of the <span class="pcalibre1 pcalibre29 pcalibre2">imul </span>instruction class. In this form, it serves as a "two-operand" multiply instruction, generating a 64-bit product from two 64-bit operands. It implements the operations <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/198-1.png" altimg-height="22" altimg-width="25" alttext="" data-uri="" display="inline"><m:mrow><m:msubsup><m:mo>*</m:mo><m:mrow><m:mn>64</m:mn></m:mrow><m:mtext>u</m:mtext></m:msubsup></m:mrow></m:math></span> and <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/198-2.png" altimg-height="23" altimg-width="25" alttext="" data-uri="" display="inline"><m:mrow><m:msubsup><m:mo>*</m:mo><m:mrow><m:mn>64</m:mn></m:mrow><m:mtext>t</m:mtext></m:msubsup></m:mrow></m:math></span> described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000000CB3_split_000.xhtml#P7000497027000000000000000000E9A"><span class="pcalibre1 pcalibre21 pcalibre2">Sections </span><span class="pcalibre1 pcalibre21 pcalibre2">2.3.4</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000000CB3_split_001.xhtml#P7000497027000000000000000000EA4"><span class="pcalibre1 pcalibre21 pcalibre2">2.3.5</span></a>. (Recall that when truncating the product to 64 bits, both unsigned multiply and two's-complement multiply have the same bit-level behavior.)</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040598" id="P7000497027000000000000000040598">Additionally, the x86-64 instruction set includes two different "one-operand" multiply instructions to compute the full 128-bit product of two 64-bit values—one for unsigned (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040599" id="P7000497027000000000000000040599">mulq</code>) and one for two's-complement (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004059A" id="P700049702700000000000000004059A">imulq</code>) multiplication. For both of these instructions, one argument must be in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004059B" id="P700049702700000000000000004059B">%rax</code>, and the other is given as the instruction source operand. The product is then stored in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004059C" id="P700049702700000000000000004059C">%rdx</code> (high-order 64 bits) and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004059D" id="P700049702700000000000000004059D">%rax</code> (low-order 64 bits). Although the name <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004059E" id="P700049702700000000000000004059E">imulq</code> is used for two distinct multiplication operations, the assembler can tell which one is intended by counting the number of operands.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004059F" id="P700049702700000000000000004059F">As an example, the following C code demonstrates the generation of a 128-bit product of two unsigned 64-bit numbers x and y:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405A0" id="P70004970270000000000000000405A0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405A1" id="P70004970270000000000000000405A1">
#include &lt;inttypes.h&gt;

typedef unsigned __int128 uint128_t;

void store_uprod(uint128_t *dest, uint64_t x, uint64_t y) {
   *dest = x * (uint128_t) y;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405A2" id="P70004970270000000000000000405A2">In this program, we explicitly declare <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405A3" id="P70004970270000000000000000405A3">x</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405A4" id="P70004970270000000000000000405A4">y</code> to be 64-bit numbers, using definitions declared in the file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405A5" id="P70004970270000000000000000405A5">inttypes.h</code>, as part of an extension of the C standard. Unfortunately, this standard does not make provisions for 128-bit values. Instead, <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002307" epub:type="pagebreak" id="P7000497027000000000000000002307" title="199"></span>we rely on support provided by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>for 128-bit integers, declared using the name <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405A6" id="P70004970270000000000000000405A6">__int128</code>. Our code uses a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405A7" id="P70004970270000000000000000405A7">typedef</code> declaration to define data type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405A8" id="P70004970270000000000000000405A8">uint128_t</code>, following the naming pattern for other data types found in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405A9" id="P70004970270000000000000000405A9">inttypes.h.</code> The code specifies that the resulting product should be stored at the 16 bytes designated by pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405AA" id="P70004970270000000000000000405AA">dest</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405AB" id="P70004970270000000000000000405AB">The assembly code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>for this function is as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405AC" id="P70004970270000000000000000405AC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405AD" id="P70004970270000000000000000405AD">
  <i class="pcalibre17 pcalibre2 pcalibre1">void store_uprod(uint128_t *dest, uint64_t x, uint64_t y)</i>
  <i class="pcalibre17 pcalibre2 pcalibre1">dest in %rdi, x in %rsi, y in %rdx</i>
1	store_uprod:
2	  movq	%rsi, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Copy x to multiplicand</i>
3	  mulq	%rdx		<i class="pcalibre17 pcalibre2 pcalibre1">Multiply by y</i>
4	  movq	%rax, (%rdi)	<i class="pcalibre17 pcalibre2 pcalibre1">Store lower 8 bytes at dest</i>
5	  movq	%rdx, 8(%rdi)	<i class="pcalibre17 pcalibre2 pcalibre1">Store upper 8 bytes at dest+8</i>
6	  ret
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405AE" id="P70004970270000000000000000405AE">Observe that storing the product requires two <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405AF" id="P70004970270000000000000000405AF">movq</code> instructions: one for the low-order 8 bytes (line 4), and one for the high-order 8 bytes (line 5). Since the code is generated for a little-endian machine, the high-order bytes are stored at higher addresses, as indicated by the address specification <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B0" id="P70004970270000000000000000405B0">8(%rdi)</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B1" id="P70004970270000000000000000405B1">Our earlier table of arithmetic operations (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002190"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10</span></a>) does not list any division or modulus operations. These operations are provided by the single-operand divide instructions similar to the single-operand multiply instructions. The signed division instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B2" id="P70004970270000000000000000405B2">idivl</code> takes as its dividend the 128-bit quantity in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B3" id="P70004970270000000000000000405B3">%rdx</code> (high-order 64 bits) and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B4" id="P70004970270000000000000000405B4">%rax</code> (low-order 64 bits). The divisor is given as the instruction operand. The instruction stores the quotient in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B5" id="P70004970270000000000000000405B5">%rax</code> and the remainder in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B6" id="P70004970270000000000000000405B6">%rdx</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B7" id="P70004970270000000000000000405B7">For most applications of 64-bit addition, the dividend is given as a 64-bit value. This value should be stored in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B8" id="P70004970270000000000000000405B8">%rax</code>. The bits of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405B9" id="P70004970270000000000000000405B9">%rdx</code> should then be set to either all zeros (unsigned arithmetic) or the sign bit of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405BA" id="P70004970270000000000000000405BA">%rax</code> (signed arithmetic). The latter operation can be performed using the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405BB" id="P70004970270000000000000000405BB">cqto</code>.<a class="pcalibre1 pcalibre2 pcalibre56 pcalibre16 pcalibre14 pcalibre15" epub:type="noteref" href="#P7000497027000000000000000003A6B" id="r__P7000497027000000000000000003A6B"><sup class="pcalibre1 pcalibre2 calibre8">2</sup></a> This instruction takes no operands—it implicitly reads the sign bit from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405BC" id="P70004970270000000000000000405BC">%rax</code> and copies it across all of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405BD" id="P70004970270000000000000000405BD">%rdx</code>.</p><aside class="pcalibre2 pcalibre32 pcalibre57" data-uri="chapter03.xhtml#P7000497027000000000000000003A6B" epub:type="footnote" id="P7000497027000000000000000003A6B"><p class="pcalibre1 pcalibre2 pcalibre10"><span class="pcalibre1 pcalibre58 pcalibre2"><a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="#r__P7000497027000000000000000003A6B">2. </a></span>This instruction is called <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041C32" id="P7000497027000000000000000041C32">cqo</code> in the Intel documentation, one of the few cases where the ATT-format name for an instruction does not match the Intel name.</p></aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405BE" id="P70004970270000000000000000405BE">As an illustration of the implementation of division with x86-64, the following C function computes the quotient and remainder of two 64-bit, signed numbers:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405BF" id="P70004970270000000000000000405BF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405C0" id="P70004970270000000000000000405C0">
void remdiv(long x, long y,
  		long *qp, long *rp) {
  	long q = x/y;
  	long r = x%y;
  	*qp = q;
  	*rp = r;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405C1" id="P70004970270000000000000000405C1"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002324" epub:type="pagebreak" id="P7000497027000000000000000002324" title="200"></span>This compiles to the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405C2" id="P70004970270000000000000000405C2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405C3" id="P70004970270000000000000000405C3">
  <i class="pcalibre17 pcalibre2 pcalibre1">void remdiv(long x, long y, long *qp, long *rp)</i>
  <i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, qp in %rdx, rp in %rcx</i>
1	remdiv:
2	 movq %rdx, %r8		<i class="pcalibre17 pcalibre2 pcalibre1">Copy qp</i>
3	 movq %rdi, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Move x to lower 8 bytes of dividend</i>
4	 cqto			<i class="pcalibre17 pcalibre2 pcalibre1">Sign-extend to upper 8 bytes of dividend</i>
5	 idivq %rsi		<i class="pcalibre17 pcalibre2 pcalibre1">Divide by y</i>
6	 movq %rax, (%r8)	<i class="pcalibre17 pcalibre2 pcalibre1">Store quotient at qp</i>
7	 movq %rdx, (%rcx)	<i class="pcalibre17 pcalibre2 pcalibre1">Store remainder at rp</i>
8	 ret
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405C4" id="P70004970270000000000000000405C4">In this code, argument rp must first be saved in a different register (line 2), since argument register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405C5" id="P70004970270000000000000000405C5">%rdx</code> is required for the division operation. Lines 3-4 then prepare the dividend by copying and sign-extending <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405C6" id="P70004970270000000000000000405C6">x</code>. Following the division, the quotient in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405C7" id="P70004970270000000000000000405C7">%rax</code> gets stored at <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405C8" id="P70004970270000000000000000405C8">qp</code> (line 6), while the remainder in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405C9" id="P70004970270000000000000000405C9">%rdx</code> gets stored at <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405CA" id="P70004970270000000000000000405CA">rp</code> (line 7).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405CB" id="P70004970270000000000000000405CB">Unsigned division makes use of the divq instruction. Typically, register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405CC" id="P70004970270000000000000000405CC">%rdx</code> is set to zero beforehand.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002330" epub:type="practice" id="P7000497027000000000000000002330"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405CD" epub:type="title" id="P70004970270000000000000000405CD"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.12 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003561">329</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000405CE" id="P70004970270000000000000000405CE">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000405CF" id="P70004970270000000000000000405CF">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405D0" id="P70004970270000000000000000405D0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000405D1" id="P70004970270000000000000000405D1">Consider the following function for computing the quotient and remainder of two unsigned 64-bit numbers:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405D2" id="P70004970270000000000000000405D2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405D3" id="P70004970270000000000000000405D3">
void uremdiv(unsigned long x, unsigned long y,
  		unsigned long *qp, unsigned long *rp) {
  	unsigned long q = x/y;
  	unsigned long r = x%y;
  	*qp = q;
  	*rp = r;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000405D4" id="P70004970270000000000000000405D4">Modify the assembly code shown for signed division to implement this function.</p>
</div></li>
</ol></section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.6 Control</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000002339"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P70004970270000000000000000405D5" epub:type="title" id="P70004970270000000000000000405D5"><span class="pcalibre1 pcalibre21 pcalibre2">3.6 </span>Control</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405D6" id="P70004970270000000000000000405D6">So far, we have only considered the behavior of <i class="pcalibre17 pcalibre2 pcalibre1">straight-line</i> code, where instructions follow one another in sequence. Some constructs in C, such as conditionals, loops, and switches, require conditional execution, where the sequence of operations that get performed depends on the outcomes of tests applied to the data. Machine code provides two basic low-level mechanisms for implementing conditional behavior: it tests data values and then alters either the control flow or the data flow based on the results of these tests.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405D7" id="P70004970270000000000000000405D7">Data-dependent control flow is the more general and more common approach for implementing conditional behavior, and so we will examine this first. Normally, <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000233D" epub:type="pagebreak" id="P700049702700000000000000000233D" title="201"></span>both statements in C and instructions in machine code are executed <i class="pcalibre17 pcalibre2 pcalibre1">sequentially</i>, in the order they appear in the program. The execution order of a set of machine-code instructions can be altered with a <i class="pcalibre17 pcalibre2 pcalibre1">jump</i> instruction, indicating that control should pass to some other part of the program, possibly contingent on the result of some test. The compiler must generate instruction sequences that build upon this low-level mechanism to implement the control constructs of C.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405D8" id="P70004970270000000000000000405D8">In our presentation, we first cover the two ways of implementing conditional operations. We then describe methods for presenting loops and switch statements.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000233F" id="P700049702700000000000000000233F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405D9" epub:type="title" id="P70004970270000000000000000405D9"><span class="pcalibre1 pcalibre21 pcalibre2">3.6.1 </span>Condition Codes</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405DA" id="P70004970270000000000000000405DA">In addition to the integer registers, the CPU maintains a set of single-bit <i class="pcalibre17 pcalibre2 pcalibre1">condition code</i> registers describing attributes of the most recent arithmetic or logical operation. These registers can then be tested to perform conditional branches. These condition codes are the most useful:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405DB" id="P70004970270000000000000000405DB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405DC" id="P70004970270000000000000000405DC"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000405DD" id="P70004970270000000000000000405DD"><span class="pcalibre1 pcalibre29 pcalibre2">cf</span>: Carry flag. The most recent operation generated a carry out of the most significant bit. Used to detect overflow for unsigned operations.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405DE" id="P70004970270000000000000000405DE"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000405DF" id="P70004970270000000000000000405DF"><span class="pcalibre1 pcalibre29 pcalibre2">zf</span>: Zero flag. The most recent operation yielded zero.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405E0" id="P70004970270000000000000000405E0"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000405E1" id="P70004970270000000000000000405E1"><span class="pcalibre1 pcalibre29 pcalibre2">sf</span>: Sign flag. The most recent operation yielded a negative value.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405E2" id="P70004970270000000000000000405E2"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000405E3" id="P70004970270000000000000000405E3"><span class="pcalibre1 pcalibre29 pcalibre2">of</span>: Overflow flag. The most recent operation caused a two's-complement overflow—either negative or positive.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405E4" id="P70004970270000000000000000405E4">For example, suppose we used one of the <span class="pcalibre1 pcalibre29 pcalibre2">add </span>instructions to perform the equivalent of the C assignment <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405E5" id="P70004970270000000000000000405E5">t = a+b</code>, where variables <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405E6" id="P70004970270000000000000000405E6">a, b</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405E7" id="P70004970270000000000000000405E7">t</code> are integers. Then the condition codes would be set according to the following C expressions:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000405E8" id="P70004970270000000000000000405E8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405E9" id="P70004970270000000000000000405E9">
CF	(unsigned) t &lt; (unsigned) a		Unsigned overflow
ZF	(t == 0)				Zero
SF	(t &lt; 0)					Negative
OF	(a &lt; 0 == b &lt; 0) &amp;&amp; (t &lt; 0 ! = a &lt; 0)	Signed overflow
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405EA" id="P70004970270000000000000000405EA">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405EB" id="P70004970270000000000000000405EB">leaq</code> instruction does not alter any condition codes, since it is intended to be used in address computations. Otherwise, all of the instructions listed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002190"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10</span></a> cause the condition codes to be set. For the logical operations, such as <span class="pcalibre1 pcalibre29 pcalibre2">xor</span>, the carry and overflow flags are set to zero. For the shift operations, the carry flag is set to the last bit shifted out, while the overflow flag is set to zero. For reasons that we will not delve into, the <span class="pcalibre1 pcalibre29 pcalibre2">inc </span>and <span class="pcalibre1 pcalibre29 pcalibre2">dec </span>instructions set the overflow and zero flags, but they leave the carry flag unchanged.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405EC" id="P70004970270000000000000000405EC">In addition to the setting of condition codes by the instructions of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002190"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10</span></a>, there are two instruction classes (having 8-, 16-, 32-, and 64-bit forms) that set condition codes without altering any other registers; these are listed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002354"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.13</span></a>. The <span class="pcalibre1 pcalibre29 pcalibre2">cmp </span>instructions set the condition codes according to the differences of their two operands. They behave in the same way as the <span class="pcalibre1 pcalibre29 pcalibre2">sub </span>instructions, except that they set the condition codes without updating their destinations. With ATT format,</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002354" id="P7000497027000000000000000002354">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000405ED" id="P70004970270000000000000000405ED">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000405EE" id="P70004970270000000000000000405EE"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002357" epub:type="pagebreak" id="P7000497027000000000000000002357" title="202"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000405EF" id="P70004970270000000000000000405EF"></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000405F0" id="P70004970270000000000000000405F0">Based on</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000405F1" id="P70004970270000000000000000405F1">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405F2" id="P70004970270000000000000000405F2"><span class="pcalibre1 pcalibre2 pcalibre84">cmp</span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405F3" id="P70004970270000000000000000405F3"><var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405F4" id="P70004970270000000000000000405F4"><var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub> – <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405F5" id="P70004970270000000000000000405F5">Compare</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405F6" id="P70004970270000000000000000405F6"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405F7" id="P70004970270000000000000000405F7">cmpb</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405F8" id="P70004970270000000000000000405F8">Compare byte</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405F9" id="P70004970270000000000000000405F9"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405FA" id="P70004970270000000000000000405FA">cmpw</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405FB" id="P70004970270000000000000000405FB">Compare word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405FC" id="P70004970270000000000000000405FC"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000405FD" id="P70004970270000000000000000405FD">cmpl</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405FE" id="P70004970270000000000000000405FE">Compare double word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000405FF" id="P70004970270000000000000000405FF"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040600" id="P7000497027000000000000000040600">cmpq</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040601" id="P7000497027000000000000000040601">Compare quad word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040602" id="P7000497027000000000000000040602"><span class="pcalibre1 pcalibre2 pcalibre84">test</span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040603" id="P7000497027000000000000000040603"><var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040604" id="P7000497027000000000000000040604"><var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub> &amp; <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040605" id="P7000497027000000000000000040605">Test</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040606" id="P7000497027000000000000000040606"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040607" id="P7000497027000000000000000040607">testb</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040608" id="P7000497027000000000000000040608">Test byte</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040609" id="P7000497027000000000000000040609"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004060A" id="P700049702700000000000000004060A">testw</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004060B" id="P700049702700000000000000004060B">Test word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004060C" id="P700049702700000000000000004060C"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004060D" id="P700049702700000000000000004060D">testl</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004060E" id="P700049702700000000000000004060E">Test double word</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004060F" id="P700049702700000000000000004060F"> <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040610" id="P7000497027000000000000000040610">testq</code></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040611" id="P7000497027000000000000000040611">Test quad word</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040612" id="P7000497027000000000000000040612"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040613" epub:type="title" id="P7000497027000000000000000040613"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.13 </span>Comparison and test instructions.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040614" id="P7000497027000000000000000040614"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040615" id="P7000497027000000000000000040615">These instructions set the condition codes without updating any other registers.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040616" id="P7000497027000000000000000040616">the operands are listed in reverse order, making the code difficult to read. These instructions set the zero flag if the two operands are equal. The other flags can be used to determine ordering relations between the two operands. The <span class="pcalibre1 pcalibre29 pcalibre2">test </span>instructions behave in the same manner as the <span class="pcalibre1 pcalibre29 pcalibre2">and </span>instructions, except that they set the condition codes without altering their destinations. Typically, the same operand is repeated (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040617" id="P7000497027000000000000000040617">testq %rax,%rax</code> to see whether <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040618" id="P7000497027000000000000000040618">%rax</code> is negative, zero, or positive), or one of the operands is a mask indicating which bits should be tested.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002382" id="P7000497027000000000000000002382"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040619" epub:type="title" id="P7000497027000000000000000040619"><span class="pcalibre1 pcalibre21 pcalibre2">3.6.2 </span>Accessing the Condition Codes</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004061A" id="P700049702700000000000000004061A">Rather than reading the condition codes directly, there are three common ways of using the condition codes: (1) we can set a single byte to 0 or 1 depending on some combination of the condition codes, (2) we can conditionally jump to some other part of the program, or (3) we can conditionally transfer data. For the first case, the instructions described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000238C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.14</span></a> set a single byte to 0 or to 1 depending on some combination of the condition codes. We refer to this entire class of instructions as the <span class="pcalibre1 pcalibre29 pcalibre2">set </span>instructions; they differ from one another based on which combinations of condition codes they consider, as indicated by the different suffixes for the instruction names. It is important to recognize that the suffixes for these instructions denote different conditions and not different operand sizes. For example, instructions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004061B" id="P700049702700000000000000004061B">setl</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004061C" id="P700049702700000000000000004061C">setb</code> denote "set less" and "set below," not "set long word" or "set byte."</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004061D" id="P700049702700000000000000004061D">A <span class="pcalibre1 pcalibre29 pcalibre2">set </span>instruction has either one of the low-order single-byte register elements (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001F4C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.2</span></a>) or a single-byte memory location as its destination, setting this byte to either 0 or 1. To generate a 32-bit or 64-bit result, we must also clear the high-order bits. A typical instruction sequence to compute the C expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004061E" id="P700049702700000000000000004061E">a &lt; b</code>, where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004061F" id="P700049702700000000000000004061F">a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040620" id="P7000497027000000000000000040620">b</code> are both of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040621" id="P7000497027000000000000000040621">long</code>, proceeds as follows:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P700049702700000000000000000238C" id="P700049702700000000000000000238C">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040622" id="P7000497027000000000000000040622">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040623" id="P7000497027000000000000000040623"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P700049702700000000000000000238F" epub:type="pagebreak" id="P700049702700000000000000000238F" title="203"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040624" id="P7000497027000000000000000040624">Synonym</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040625" id="P7000497027000000000000000040625">Effect</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040626" id="P7000497027000000000000000040626">Set condition</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040627" id="P7000497027000000000000000040627"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040628" id="P7000497027000000000000000040628">sete</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040629" id="P7000497027000000000000000040629"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004062A" id="P700049702700000000000000004062A">setz</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004062B" id="P700049702700000000000000004062B"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004062C" id="P700049702700000000000000004062C">ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004062D" id="P700049702700000000000000004062D">Equal / zero</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004062E" id="P700049702700000000000000004062E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004062F" id="P700049702700000000000000004062F">setne</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040630" id="P7000497027000000000000000040630"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040631" id="P7000497027000000000000000040631">setnz</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040632" id="P7000497027000000000000000040632"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← ~ <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040633" id="P7000497027000000000000000040633">ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040634" id="P7000497027000000000000000040634">Not equal / not zero</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040635" id="P7000497027000000000000000040635"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040636" id="P7000497027000000000000000040636">sets</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040637" id="P7000497027000000000000000040637"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040638" id="P7000497027000000000000000040638">SF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040639" id="P7000497027000000000000000040639">Negative</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004063A" id="P700049702700000000000000004063A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004063B" id="P700049702700000000000000004063B">setns</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004063C" id="P700049702700000000000000004063C"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004063D" id="P700049702700000000000000004063D">SF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004063E" id="P700049702700000000000000004063E">Nonnegative</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004063F" id="P700049702700000000000000004063F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040640" id="P7000497027000000000000000040640">setg</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040641" id="P7000497027000000000000000040641"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040642" id="P7000497027000000000000000040642">setnle</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040643" id="P7000497027000000000000000040643"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040644" id="P7000497027000000000000000040644">~ (SF ^ OF) &amp; ~ ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040645" id="P7000497027000000000000000040645">Greater (signed &gt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040646" id="P7000497027000000000000000040646"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040647" id="P7000497027000000000000000040647">setge</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040648" id="P7000497027000000000000000040648"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040649" id="P7000497027000000000000000040649">setnl</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004064A" id="P700049702700000000000000004064A"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004064B" id="P700049702700000000000000004064B">~ (SF ^ OF)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004064C" id="P700049702700000000000000004064C">Greater or equal (signed &gt;=)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004064D" id="P700049702700000000000000004064D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004064E" id="P700049702700000000000000004064E">setl</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004064F" id="P700049702700000000000000004064F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040650" id="P7000497027000000000000000040650">setnge</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040651" id="P7000497027000000000000000040651"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040652" id="P7000497027000000000000000040652">SF ^ OF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040653" id="P7000497027000000000000000040653">Less (signed &lt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040654" id="P7000497027000000000000000040654"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040655" id="P7000497027000000000000000040655">setle</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040656" id="P7000497027000000000000000040656"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040657" id="P7000497027000000000000000040657">setng</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040658" id="P7000497027000000000000000040658"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040659" id="P7000497027000000000000000040659">(SF ^ OF) | ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004065A" id="P700049702700000000000000004065A">Less or equal (signed &lt;=)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004065B" id="P700049702700000000000000004065B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004065C" id="P700049702700000000000000004065C">seta</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004065D" id="P700049702700000000000000004065D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004065E" id="P700049702700000000000000004065E">setnbe</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004065F" id="P700049702700000000000000004065F"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040660" id="P7000497027000000000000000040660">~ CF &amp; ~ ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040661" id="P7000497027000000000000000040661">Above (unsigned &gt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040662" id="P7000497027000000000000000040662"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040663" id="P7000497027000000000000000040663">setae</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040664" id="P7000497027000000000000000040664"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040665" id="P7000497027000000000000000040665">setnb</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040666" id="P7000497027000000000000000040666"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040667" id="P7000497027000000000000000040667">~ CF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040668" id="P7000497027000000000000000040668">Above or equal (unsigned &gt;=)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040669" id="P7000497027000000000000000040669"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004066A" id="P700049702700000000000000004066A">setb</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004066B" id="P700049702700000000000000004066B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004066C" id="P700049702700000000000000004066C">setnae</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004066D" id="P700049702700000000000000004066D"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004066E" id="P700049702700000000000000004066E">CF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004066F" id="P700049702700000000000000004066F">Below (unsigned &lt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040670" id="P7000497027000000000000000040670"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040671" id="P7000497027000000000000000040671">setbe</code> <var class="pcalibre17 pcalibre2 pcalibre1">D</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040672" id="P7000497027000000000000000040672"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040673" id="P7000497027000000000000000040673">setna</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040674" id="P7000497027000000000000000040674"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040675" id="P7000497027000000000000000040675">CF | ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040676" id="P7000497027000000000000000040676">Below or equal (unsigned &lt;=)</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040677" id="P7000497027000000000000000040677"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040678" epub:type="title" id="P7000497027000000000000000040678"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.14 </span>The <span class="pcalibre1 pcalibre2 pcalibre84">set </span>instructions.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040679" id="P7000497027000000000000000040679"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004067A" id="P700049702700000000000000004067A">Each instruction sets a single byte to 0 or 1 based on some combination of the condition codes. Some instructions have "synonyms," that is, alternate names for the same machine instruction.</p></div></figcaption>
</figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004067B" id="P700049702700000000000000004067B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004067C" id="P700049702700000000000000004067C">
  <i class="pcalibre17 pcalibre2 pcalibre1">int comp(data_t a, data_t b)</i>
  <i class="pcalibre17 pcalibre2 pcalibre1">a in %rdi, b in %rsi</i>
1	comp:
2	 cmpq	%rsi, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Compare a:b</i>
3	 setl	%al		<i class="pcalibre17 pcalibre2 pcalibre1">Set low-order byte of %eax to 0 or 1</i>
4	 movzbl	%al, %eax	<i class="pcalibre17 pcalibre2 pcalibre1">Clear rest of %eax (and rest of %rax)</i>
5	 ret
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004067D" id="P700049702700000000000000004067D">Note the comparison order of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004067E" id="P700049702700000000000000004067E">cmpq</code> instruction (line 2). Although the arguments are listed in the order <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004067F" id="P700049702700000000000000004067F">%rsi</code> (b), then <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040680" id="P7000497027000000000000000040680">%rdi</code> (a), the comparison is really between <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040681" id="P7000497027000000000000000040681">a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040682" id="P7000497027000000000000000040682">b</code>. Recall also, as discussed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001FFB"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.4.2</span></a>, that the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040683" id="P7000497027000000000000000040683">movzbl</code> instruction (line 4) clears not just the high-order 3 bytes of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040684" id="P7000497027000000000000000040684">%eax</code>, but the upper 4 bytes of the entire register, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040685" id="P7000497027000000000000000040685">%rax</code>, as well.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040686" id="P7000497027000000000000000040686">For some of the underlying machine instructions, there are multiple possible names, which we list as "synonyms." For example, both <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040687" id="P7000497027000000000000000040687">setg</code> (for "set greater") and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040688" id="P7000497027000000000000000040688">setnle</code> (for "set not less or equal") refer to the same machine instruction. Compilers and disassemblers make arbitrary choices of which names to use.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040689" id="P7000497027000000000000000040689">Although all arithmetic and logical operations set the condition codes, the descriptions of the different <span class="pcalibre1 pcalibre29 pcalibre2">set </span>instructions apply to the case where a comparison instruction has been executed, setting the condition codes according to the computation <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004068A" id="P700049702700000000000000004068A">t = a-b</code>. More specifically, let <var class="pcalibre17 pcalibre2 pcalibre1">a</var>, <var class="pcalibre17 pcalibre2 pcalibre1">b</var>, and <var class="pcalibre17 pcalibre2 pcalibre1">t</var> be the integers represented in two's-complement form by variables <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004068B" id="P700049702700000000000000004068B">a, b</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004068C" id="P700049702700000000000000004068C">t</code>, respectively, and so <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-eq1.png" altimg-height="19" altimg-width="72" alttext="" data-uri="" display="inline"><m:mrow><m:mi>t</m:mi><m:mo>=</m:mo><m:msup><m:mi>a</m:mi><m:mo>−</m:mo></m:msup><m:msubsup><m:mrow></m:mrow><m:mi>w</m:mi><m:mtext>t</m:mtext></m:msubsup><m:mi>b</m:mi></m:mrow></m:math></span>, where <var class="pcalibre17 pcalibre2 pcalibre1">w</var> depends on the sizes associated with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004068D" id="P700049702700000000000000004068D">a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004068E" id="P700049702700000000000000004068E">b</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004068F" id="P700049702700000000000000004068F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000023FC" epub:type="pagebreak" id="P70004970270000000000000000023FC" title="204"></span>Consider the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040690" id="P7000497027000000000000000040690">sete</code>, or "set when equal," instruction. When <var class="pcalibre17 pcalibre2 pcalibre1">a</var> = <var class="pcalibre17 pcalibre2 pcalibre1">b</var>, we will have <var class="pcalibre17 pcalibre2 pcalibre1">t</var> = 0, and hence the zero flag indicates equality. Similarly, consider testing for signed comparison with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040691" id="P7000497027000000000000000040691">setl</code>, or "set when less," instruction. When no overflow occurs (indicated by having OF set to 0), we will have <var class="pcalibre17 pcalibre2 pcalibre1">a</var> ≥ <var class="pcalibre17 pcalibre2 pcalibre1">b</var> when <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-eq2.png" altimg-height="24" altimg-width="89" alttext="" data-uri="" display="inline"><m:mrow><m:msup><m:mi>a</m:mi><m:mo>−</m:mo></m:msup><m:msubsup><m:mrow></m:mrow><m:mi>w</m:mi><m:mtext>t</m:mtext></m:msubsup><m:mi>b</m:mi><m:mo>&lt;</m:mo><m:mn>0</m:mn></m:mrow></m:math></span>, indicated by having SF set to 1, and <var class="pcalibre17 pcalibre2 pcalibre1">a</var> ≥ <var class="pcalibre17 pcalibre2 pcalibre1">b</var> when <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-eq3.png" altimg-height="23" altimg-width="90" alttext="" data-uri="" display="inline"><m:mrow><m:msup><m:mi>a</m:mi><m:mo>−</m:mo></m:msup><m:msubsup><m:mrow></m:mrow><m:mi>w</m:mi><m:mtext>t</m:mtext></m:msubsup><m:mi>b</m:mi><m:mo>≥</m:mo><m:mn>0</m:mn></m:mrow></m:math></span>, indicated by having SF set to 0. On the other hand, when overflow occurs, we will have <var class="pcalibre17 pcalibre2 pcalibre1">a</var> &lt; <var class="pcalibre17 pcalibre2 pcalibre1">b</var> when <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-eq4.png" altimg-height="26" altimg-width="90" alttext="" data-uri="" display="inline"><m:mrow><m:msup><m:mi>a</m:mi><m:mo>−</m:mo></m:msup><m:msubsup><m:mrow></m:mrow><m:mi>w</m:mi><m:mtext>t</m:mtext></m:msubsup><m:mi>b</m:mi><m:mo>&gt;</m:mo><m:mn>0</m:mn></m:mrow></m:math> </span>(negative overflow) and <var class="pcalibre17 pcalibre2 pcalibre1">a</var> &gt; <var class="pcalibre17 pcalibre2 pcalibre1">b</var> when <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-eq5.png" altimg-height="23" altimg-width="90" alttext="" data-uri="" display="inline"><m:mrow><m:msup><m:mi>a</m:mi><m:mo>−</m:mo></m:msup><m:msubsup><m:mrow></m:mrow><m:mi>w</m:mi><m:mtext>t</m:mtext></m:msubsup><m:mi>b</m:mi><m:mo>&lt;</m:mo><m:mn>0</m:mn></m:mrow></m:math> </span>(positive overflow). We cannot have overflow when <var class="pcalibre17 pcalibre2 pcalibre1">a</var> = <var class="pcalibre17 pcalibre2 pcalibre1">b</var>. Thus, when OF is set to 1, we will have <var class="pcalibre17 pcalibre2 pcalibre1">a</var> &lt; <var class="pcalibre17 pcalibre2 pcalibre1">b</var> if and only if SF is set to 0. Combining these cases, the <span class="pcalibre1 pcalibre29 pcalibre2">exclusive-or </span>of the overflow and sign bits provides a test for whether <var class="pcalibre17 pcalibre2 pcalibre1">a</var> &lt; <var class="pcalibre17 pcalibre2 pcalibre1">b</var>. The other signed comparison tests are based on other combinations of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040692" id="P7000497027000000000000000040692">SF ^ OF</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040693" id="P7000497027000000000000000040693">ZF</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040694" id="P7000497027000000000000000040694">For the testing of unsigned comparisons, we now let <var class="pcalibre17 pcalibre2 pcalibre1">a</var> and <var class="pcalibre17 pcalibre2 pcalibre1">b</var> be the integers represented in unsigned form by variables <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040695" id="P7000497027000000000000000040695">a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040696" id="P7000497027000000000000000040696">b</code>. In performing the computation <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040697" id="P7000497027000000000000000040697">t = a-b</code>, the carry flag will be set by the <span class="pcalibre1 pcalibre29 pcalibre2">cmp </span>instruction when <var class="pcalibre17 pcalibre2 pcalibre1">a</var> − <var class="pcalibre17 pcalibre2 pcalibre1">b</var> &lt; 0, and so the unsigned comparisons use combinations of the carry and zero flags.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040698" id="P7000497027000000000000000040698">It is important to note how machine code does or does not distinguish between signed and unsigned values. Unlike in C, it does not associate a data type with each program value. Instead, it mostly uses the same instructions for the two cases, because many arithmetic operations have the same bit-level behavior for unsigned and two's-complement arithmetic. Some circumstances require different instructions to handle signed and unsigned operations, such as using different versions of right shifts, division and multiplication instructions, and different combinations of condition codes.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002406" epub:type="practice" id="P7000497027000000000000000002406"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040699" epub:type="title" id="P7000497027000000000000000040699"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.13 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003589">330</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004069A" id="P700049702700000000000000004069A">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004069B" id="P700049702700000000000000004069B">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004069C" id="P700049702700000000000000004069C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004069D" id="P700049702700000000000000004069D">The C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004069E" id="P700049702700000000000000004069E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004069F" id="P700049702700000000000000004069F">
int comp(data_t a, data_t b) {
  return a COMP b;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406A0" id="P70004970270000000000000000406A0">shows a general comparison between arguments <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406A1" id="P70004970270000000000000000406A1">a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406A2" id="P70004970270000000000000000406A2">b</code>, where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406A3" id="P70004970270000000000000000406A3">data_t</code>, the data type of the arguments, is defined (via <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406A4" id="P70004970270000000000000000406A4">typedef</code>) to be one of the integer data types listed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001EF2.xhtml#P7000497027000000000000000001EFD"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1</span></a> and either signed or unsigned. The comparison COMP is defined via <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406A5" id="P70004970270000000000000000406A5">#define</code>.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406A6" id="P70004970270000000000000000406A6">Suppose a is in some portion of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406A7" id="P70004970270000000000000000406A7">%rdx</code> while <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406A8" id="P70004970270000000000000000406A8">b</code> is in some portion of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406A9" id="P70004970270000000000000000406A9">%rsi</code>. For each of the following instruction sequences, determine which data types <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406AA" id="P70004970270000000000000000406AA">data_t</code> and which comparisons COMP could cause the compiler to generate this code. (There can be multiple correct answers; you should list them all.)</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000406AB" id="P70004970270000000000000000406AB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406AC" id="P70004970270000000000000000406AC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406AD" id="P70004970270000000000000000406AD"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406AE" id="P70004970270000000000000000406AE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406AF" id="P70004970270000000000000000406AF">
cmpl	%esi, %edi
setl	%al
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406B0" id="P70004970270000000000000000406B0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406B1" id="P70004970270000000000000000406B1"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406B2" id="P70004970270000000000000000406B2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406B3" id="P70004970270000000000000000406B3">
cmpw	%si, %di
setge	%al
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406B4" id="P70004970270000000000000000406B4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406B5" id="P70004970270000000000000000406B5"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002424" epub:type="pagebreak" id="P7000497027000000000000000002424" title="205"></span></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406B6" id="P70004970270000000000000000406B6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406B7" id="P70004970270000000000000000406B7">
cmpb	%sil, %dil
setbe	%al
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406B8" id="P70004970270000000000000000406B8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406B9" id="P70004970270000000000000000406B9"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406BA" id="P70004970270000000000000000406BA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406BB" id="P70004970270000000000000000406BB">
cmpq	%rsi, %rdi
setne	%a
</code></pre>
</li>
</ol>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000242B" epub:type="practice" id="P700049702700000000000000000242B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406BC" epub:type="title" id="P70004970270000000000000000406BC"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.14 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003589">330</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000406BD" id="P70004970270000000000000000406BD">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000406BE" id="P70004970270000000000000000406BE">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406BF" id="P70004970270000000000000000406BF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406C0" id="P70004970270000000000000000406C0">The C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406C1" id="P70004970270000000000000000406C1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406C2" id="P70004970270000000000000000406C2">
int test(data_t a) {
  return a TEST 0;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406C3" id="P70004970270000000000000000406C3">shows a general comparison between argument a and 0, where we can set the data type of the argument by declaring <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406C4" id="P70004970270000000000000000406C4">data_t</code> with a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406C5" id="P70004970270000000000000000406C5">typedef</code>, and the nature of the comparison by declaring TEST with a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406C6" id="P70004970270000000000000000406C6">#define</code> declaration. The following instruction sequences implement the comparison, where a is held in some portion of register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406C7" id="P70004970270000000000000000406C7">%rdi</code>. For each sequence, determine which data types <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406C8" id="P70004970270000000000000000406C8">data_t</code> and which comparisons TEST could cause the compiler to generate this code. (There can be multiple correct answers; list all correct ones.)</p></div>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000406C9" id="P70004970270000000000000000406C9">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406CA" id="P70004970270000000000000000406CA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406CB" id="P70004970270000000000000000406CB"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406CC" id="P70004970270000000000000000406CC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406CD" id="P70004970270000000000000000406CD">
testq	%rdi, %rdi
setge	%al
</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406CE" id="P70004970270000000000000000406CE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406CF" id="P70004970270000000000000000406CF"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406D0" id="P70004970270000000000000000406D0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406D1" id="P70004970270000000000000000406D1">
testw	%di, %di
sete	%al
</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406D2" id="P70004970270000000000000000406D2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406D3" id="P70004970270000000000000000406D3"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406D4" id="P70004970270000000000000000406D4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406D5" id="P70004970270000000000000000406D5">
testb	%dil, %dil
seta	%al
</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406D6" id="P70004970270000000000000000406D6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000406D7" id="P70004970270000000000000000406D7"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406D8" id="P70004970270000000000000000406D8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406D9" id="P70004970270000000000000000406D9">
testl	%edi, %edi
setle	%al
</code></pre></li>
</ol></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000244A" id="P700049702700000000000000000244A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406DA" epub:type="title" id="P70004970270000000000000000406DA"><span class="pcalibre1 pcalibre21 pcalibre2">3.6.3 </span>Jump Instructions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406DB" id="P70004970270000000000000000406DB">Under normal execution, instructions follow each other in the order they are listed. A <i class="pcalibre17 pcalibre2 pcalibre1">jump</i> instruction can cause the execution to switch to a completely new position in the program. These jump destinations are generally indicated in assembly code by a <i class="pcalibre17 pcalibre2 pcalibre1">label</i>. Consider the following (very contrived) assembly-code sequence:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000406DC" id="P70004970270000000000000000406DC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406DD" id="P70004970270000000000000000406DD">
  movq $0,%rax		<i class="pcalibre17 pcalibre2 pcalibre1">Set %rax to 0</i>
  jmp .L1		<i class="pcalibre17 pcalibre2 pcalibre1">Goto .L1</i>
  movq (%rax), %rdx	<i class="pcalibre17 pcalibre2 pcalibre1">Null pointer dereference (skipped)</i>
.L1:
  popq %rdx		<i class="pcalibre17 pcalibre2 pcalibre1">Jump target</i>
</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P700049702700000000000000000244F" id="P700049702700000000000000000244F">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000406DE" id="P70004970270000000000000000406DE">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" colspan="2" data-uri="chapter03.xhtml#P70004970270000000000000000406DF" id="P70004970270000000000000000406DF"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002452" epub:type="pagebreak" id="P7000497027000000000000000002452" title="206"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000406E0" id="P70004970270000000000000000406E0">Synonym</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000406E1" id="P70004970270000000000000000406E1">Jump condition</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000406E2" id="P70004970270000000000000000406E2">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406E3" id="P70004970270000000000000000406E3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406E4" id="P70004970270000000000000000406E4">jmp</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406E5" id="P70004970270000000000000000406E5"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406E6" id="P70004970270000000000000000406E6">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406E7" id="P70004970270000000000000000406E7">Direct jump</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406E8" id="P70004970270000000000000000406E8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406E9" id="P70004970270000000000000000406E9">jmp</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406EA" id="P70004970270000000000000000406EA">*<i class="pcalibre17 pcalibre2 pcalibre1">Operand</i></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406EB" id="P70004970270000000000000000406EB">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406EC" id="P70004970270000000000000000406EC">Indirect jump</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406ED" id="P70004970270000000000000000406ED"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406EE" id="P70004970270000000000000000406EE">je</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406EF" id="P70004970270000000000000000406EF"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406F0" id="P70004970270000000000000000406F0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406F1" id="P70004970270000000000000000406F1">jz</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406F2" id="P70004970270000000000000000406F2">ZF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406F3" id="P70004970270000000000000000406F3">Equal / zero</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406F4" id="P70004970270000000000000000406F4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406F5" id="P70004970270000000000000000406F5">jne</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406F6" id="P70004970270000000000000000406F6"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406F7" id="P70004970270000000000000000406F7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406F8" id="P70004970270000000000000000406F8">jnz</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406F9" id="P70004970270000000000000000406F9">~ZF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406FA" id="P70004970270000000000000000406FA">Not equal / not zero</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406FB" id="P70004970270000000000000000406FB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000406FC" id="P70004970270000000000000000406FC">js</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406FD" id="P70004970270000000000000000406FD"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406FE" id="P70004970270000000000000000406FE">SF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000406FF" id="P70004970270000000000000000406FF">Negative</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040700" id="P7000497027000000000000000040700"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040701" id="P7000497027000000000000000040701">jns</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040702" id="P7000497027000000000000000040702"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040703" id="P7000497027000000000000000040703">~SF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040704" id="P7000497027000000000000000040704">Nonnegative</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040705" id="P7000497027000000000000000040705"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040706" id="P7000497027000000000000000040706">jg</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040707" id="P7000497027000000000000000040707"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040708" id="P7000497027000000000000000040708"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040709" id="P7000497027000000000000000040709">jnle</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004070A" id="P700049702700000000000000004070A">~(SF ^ OF) &amp; ~ZF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004070B" id="P700049702700000000000000004070B">Greater (signed &gt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004070C" id="P700049702700000000000000004070C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004070D" id="P700049702700000000000000004070D">jge</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004070E" id="P700049702700000000000000004070E"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004070F" id="P700049702700000000000000004070F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040710" id="P7000497027000000000000000040710">jnl</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040711" id="P7000497027000000000000000040711">~(SF ^ OF)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040712" id="P7000497027000000000000000040712">Greater or equal (signed &gt;=)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040713" id="P7000497027000000000000000040713"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040714" id="P7000497027000000000000000040714">jl</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040715" id="P7000497027000000000000000040715"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040716" id="P7000497027000000000000000040716"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040717" id="P7000497027000000000000000040717">jnge</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040718" id="P7000497027000000000000000040718">SF ^ OF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040719" id="P7000497027000000000000000040719">Less (signed &lt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004071A" id="P700049702700000000000000004071A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004071B" id="P700049702700000000000000004071B">jle</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004071C" id="P700049702700000000000000004071C"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004071D" id="P700049702700000000000000004071D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004071E" id="P700049702700000000000000004071E">jng</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004071F" id="P700049702700000000000000004071F">(SF ^ OF) | ZF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040720" id="P7000497027000000000000000040720">Less or equal (signed &lt;=)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040721" id="P7000497027000000000000000040721"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040722" id="P7000497027000000000000000040722">ja</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040723" id="P7000497027000000000000000040723"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040724" id="P7000497027000000000000000040724"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040725" id="P7000497027000000000000000040725">jnbe</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040726" id="P7000497027000000000000000040726">~CF &amp; ~ZF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040727" id="P7000497027000000000000000040727">Above (unsigned &gt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040728" id="P7000497027000000000000000040728"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040729" id="P7000497027000000000000000040729">jae</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004072A" id="P700049702700000000000000004072A"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004072B" id="P700049702700000000000000004072B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004072C" id="P700049702700000000000000004072C">jnb</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004072D" id="P700049702700000000000000004072D">~CF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004072E" id="P700049702700000000000000004072E">Above or equal (unsigned &gt;=)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004072F" id="P700049702700000000000000004072F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040730" id="P7000497027000000000000000040730">jb</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040731" id="P7000497027000000000000000040731"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040732" id="P7000497027000000000000000040732"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040733" id="P7000497027000000000000000040733">jnae</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040734" id="P7000497027000000000000000040734">CF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040735" id="P7000497027000000000000000040735">Below (unsigned &lt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040736" id="P7000497027000000000000000040736"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040737" id="P7000497027000000000000000040737">jbe</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040738" id="P7000497027000000000000000040738"><i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040739" id="P7000497027000000000000000040739"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004073A" id="P700049702700000000000000004073A">jna</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004073B" id="P700049702700000000000000004073B">CF | ZF</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004073C" id="P700049702700000000000000004073C">Below or equal (unsigned &lt;=)</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P700049702700000000000000004073D" id="P700049702700000000000000004073D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P700049702700000000000000004073E" epub:type="title" id="P700049702700000000000000004073E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.15 </span>The jump instructions.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004073F" id="P700049702700000000000000004073F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040740" id="P7000497027000000000000000040740">These instructions jump to a labeled destination when the jump condition holds. Some instructions have "synonyms," alternate names for the same machine instruction.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040741" id="P7000497027000000000000000040741">The instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040742" id="P7000497027000000000000000040742">jmp .L1</code> will cause the program to skip over the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040743" id="P7000497027000000000000000040743">movq</code> instruction and instead resume execution with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040744" id="P7000497027000000000000000040744">popq</code> instruction. In generating the object-code file, the assembler determines the addresses of all labeled instructions and encodes the <i class="pcalibre17 pcalibre2 pcalibre1">jump targets</i> (the addresses of the destination instructions) as part of the jump instructions.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040745" id="P7000497027000000000000000040745"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000244F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.15</span></a> shows the different jump instructions. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040746" id="P7000497027000000000000000040746">jmp</code> instruction jumps unconditionally. It can be either a <i class="pcalibre17 pcalibre2 pcalibre1">direct</i> jump, where the jump target is encoded as part of the instruction, or an <i class="pcalibre17 pcalibre2 pcalibre1">indirect</i> jump, where the jump target is read from a register or a memory location. Direct jumps are written in assembly code by giving a label as the jump target, for example, the label <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040747" id="P7000497027000000000000000040747">.L1</code> in the code shown. Indirect jumps are written using `*' followed by an operand specifier using one of the memory operand formats described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001F57"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.3</span></a>. As examples, the instruction</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040748" id="P7000497027000000000000000040748"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040749" id="P7000497027000000000000000040749">
jmp *%rax
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004074A" id="P700049702700000000000000004074A">uses the value in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004074B" id="P700049702700000000000000004074B">%rax</code> as the jump target, and the instruction</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004074C" id="P700049702700000000000000004074C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004074D" id="P700049702700000000000000004074D">
jmp *(%rax)
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004074E" id="P700049702700000000000000004074E">reads the jump target from memory, using the value in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004074F" id="P700049702700000000000000004074F">%rax</code> as the read address.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040750" id="P7000497027000000000000000040750">The remaining jump instructions in the table are <i class="pcalibre17 pcalibre2 pcalibre1">conditional</i>—they either jump or continue executing at the next instruction in the code sequence, depending on some combination of the condition codes. The names of these instructions <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000024C4" epub:type="pagebreak" id="P70004970270000000000000000024C4" title="207"></span>and the conditions under which they jump match those of the <span class="pcalibre1 pcalibre29 pcalibre2">set </span>instructions (see <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000238C"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.14</span></a>). As with the <span class="pcalibre1 pcalibre29 pcalibre2">set </span>instructions, some of the underlying machine instructions have multiple names. Conditional jumps can only be direct.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000024C5" id="P70004970270000000000000000024C5"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040751" epub:type="title" id="P7000497027000000000000000040751"><span class="pcalibre1 pcalibre21 pcalibre2">3.6.4 </span>Jump Instruction Encodings</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040752" id="P7000497027000000000000000040752">For the most part, we will not concern ourselves with the detailed format of machine code. On the other hand, understanding how the targets of jump instructions are encoded will become important when we study linking in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000005FB4.xhtml#P7000497027000000000000000005FB4"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">7</span></a>. In addition, it helps when interpreting the output of a disassembler. In assembly code, jump targets are written using symbolic labels. The assembler, and later the linker, generate the proper encodings of the jump targets. There are several different encodings for jumps, but some of the most commonly used ones are <i class="pcalibre17 pcalibre2 pcalibre1">PC relative</i>. That is, they encode the difference between the address of the target instruction and the address of the instruction immediately following the jump. These offsets can be encoded using 1, 2, or 4 bytes. A second encoding method is to give an "absolute" address, using 4 bytes to directly specify the target. The assembler and linker select the appropriate encodings of the jump destinations.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040753" id="P7000497027000000000000000040753">As an example of PC-relative addressing, the following assembly code for a function was generated by compiling a file branch. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040754" id="P7000497027000000000000000040754">c.</code> It contains two jumps: the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040755" id="P7000497027000000000000000040755">jmp</code> instruction on line 2 jumps forward to a higher address, while the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040756" id="P7000497027000000000000000040756">jg</code> instruction on line 7 jumps back to a lower one.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040757" id="P7000497027000000000000000040757"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040758" id="P7000497027000000000000000040758">
1	  movq	%rdi, %rax
2	  jmp	.L2
3	.L3:
4	  sarq	%rax
5	.L2:
6	  testq	%rax, %rax
7	  jg	.L3
8	  rep; ret
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040759" id="P7000497027000000000000000040759">The disassembled version of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004075A" id="P700049702700000000000000004075A">.o</code> format generated by the assembler is as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004075B" id="P700049702700000000000000004075B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004075C" id="P700049702700000000000000004075C">
1	0:	48 89 f8	mov	%rdi,%rax
2	3:	eb 03		jmp	8 &lt;loop+0x8&gt;
3	5:	48 d1 f8	sar	%rax
4	8:	48 85 c0	test	%rax,%rax
5	b:	7f f8		jg	5 &lt;loop+0x5&gt;
6	d:	f3 c3		repz retq
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004075D" id="P700049702700000000000000004075D">In the annotations on the right generated by the disassembler, the jump targets are indicated as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004075E" id="P700049702700000000000000004075E">0x8</code> for the jump instruction on line 2 and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004075F" id="P700049702700000000000000004075F">0x5</code> for the jump instruction on line 5 (the disassembler lists all numbers in hexadecimal). Looking at the byte encodings of the instructions, however, we see that the target of the first jump instruction is encoded (in the second byte) as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040760" id="P7000497027000000000000000040760">0x03</code>. Adding this to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040761" id="P7000497027000000000000000040761">0x5</code>, the</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000024D7" id="P70004970270000000000000000024D7"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P7000497027000000000000000040762" epub:type="title" id="P7000497027000000000000000040762"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000024D9" epub:type="pagebreak" id="P70004970270000000000000000024D9" title="208"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>What do the instructions <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter03.xhtml#P7000497027000000000000000040763" id="P7000497027000000000000000040763">rep</code> and <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter03.xhtml#P7000497027000000000000000040764" id="P7000497027000000000000000040764">repz</code> do?</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040765" id="P7000497027000000000000000040765">Line 8 of the assembly code shown on page 207 contains the instruction combination <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040766" id="P7000497027000000000000000040766">rep; ret</code>. These are rendered in the disassembled code (line 6) as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040767" id="P7000497027000000000000000040767">repz retq</code>. One can infer that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040768" id="P7000497027000000000000000040768">repz</code> is a synonym for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040769" id="P7000497027000000000000000040769">rep</code>, just as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004076A" id="P700049702700000000000000004076A">retq</code> is a synonym for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004076B" id="P700049702700000000000000004076B">ret</code>. Looking at the Intel and AMD documentation for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004076C" id="P700049702700000000000000004076C">rep</code> instruction, we find that it is normally used to implement a repeating string operation <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3A6">[3,</a> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B408">51]</a>. It seems completely inappropriate here. The answer to this puzzle can be seen in AMD's guidelines to compiler writers <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3A2">[1]</a>. They recommend using the combination of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004076D" id="P700049702700000000000000004076D">rep</code> followed by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004076E" id="P700049702700000000000000004076E">ret</code> to avoid making the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004076F" id="P700049702700000000000000004076F">ret</code> instruction the destination of a conditional jump instruction. Without the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040770" id="P7000497027000000000000000040770">rep</code> instruction, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040771" id="P7000497027000000000000000040771">jg</code> instruction (line 7 of the assembly code) would proceed to the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040772" id="P7000497027000000000000000040772">ret</code> instruction when the branch is not taken. According toAMD, their processors cannot properly predict the destination of a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040773" id="P7000497027000000000000000040773">ret</code> instruction when it is reached from a jump instruction. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040774" id="P7000497027000000000000000040774">rep</code> instruction serves as a form of no-operation here, and so inserting it as the jump destination does not change behavior of the code, except to make it faster on AMD processors. We can safely ignore any <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040775" id="P7000497027000000000000000040775">rep</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040776" id="P7000497027000000000000000040776">repz</code> instruction we see in the rest of the code presented in this book.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040777" id="P7000497027000000000000000040777">address of the following instruction, we get jump target address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040778" id="P7000497027000000000000000040778">0x8</code>, the address of the instruction on line 4.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040779" id="P7000497027000000000000000040779">Similarly, the target of the second jump instruction is encoded as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004077A" id="P700049702700000000000000004077A">0xf8</code> (decimal −8) using a single-byte two's-complement representation. Adding this to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004077B" id="P700049702700000000000000004077B">0xd</code> (decimal 13), the address of the instruction on line 6, we get <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004077C" id="P700049702700000000000000004077C">0x5</code>, the address of the instruction on line 3.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004077D" id="P700049702700000000000000004077D">As these examples illustrate, the value of the program counter when performing PC-relative addressing is the address of the instruction following the jump, not that of the jump itself. This convention dates back to early implementations, when the processor would update the program counter as its first step in executing an instruction.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004077E" id="P700049702700000000000000004077E">The following shows the disassembled version of the program after linking:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004077F" id="P700049702700000000000000004077F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040780" id="P7000497027000000000000000040780">
1	4004d0: 48 89 f8	mov %rdi,%rax
2	4004d3: eb 03		jmp 4004d8 &lt;loop+0x8&gt;
3	4004d5: 48 d1 f8	sar %rax
4	4004d8: 48 85 c0	test %rax,%rax
5	4004db: 7f f8		jg 4004d5 &lt;loop+0x5&gt;
6	4004dd: f3 c3		repz retq
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040781" id="P7000497027000000000000000040781">The instructions have been relocated to different addresses, but the encodings of the jump targets in lines 2 and 5 remain unchanged. By using a PC-relative encoding of the jump targets, the instructions can be compactly encoded (requiring just 2 bytes), and the object code can be shifted to different positions in memory without alteration.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000024F9" epub:type="practice" id="P70004970270000000000000000024F9"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040782" epub:type="title" id="P7000497027000000000000000040782"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000024FB" epub:type="pagebreak" id="P70004970270000000000000000024FB" title="209"></span><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.15 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P7000497027000000000000000003589">330</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040783" id="P7000497027000000000000000040783">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040784" id="P7000497027000000000000000040784">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040785" id="P7000497027000000000000000040785"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040786" id="P7000497027000000000000000040786">In the following excerpts from a disassembled binary, some of the information has been replaced by X's. Answer the following questions about these instructions.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000040787" id="P7000497027000000000000000040787">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040788" id="P7000497027000000000000000040788"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040789" id="P7000497027000000000000000040789">What is the target of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004078A" id="P700049702700000000000000004078A">je</code> instruction below? (You do not need to know anything about the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004078B" id="P700049702700000000000000004078B">callq</code> instruction here.)</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004078C" id="P700049702700000000000000004078C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004078D" id="P700049702700000000000000004078D">
4003fa: 74 02	je	XXXXXX
4003fc: ff d0	callq	*%rax
</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004078E" id="P700049702700000000000000004078E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004078F" id="P700049702700000000000000004078F">What is the target of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040790" id="P7000497027000000000000000040790">je</code> instruction below?</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040791" id="P7000497027000000000000000040791"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040792" id="P7000497027000000000000000040792">
40042f: 74 f4	je	XXXXXX
400431: 5d	pop	%rbp
</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040793" id="P7000497027000000000000000040793"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040794" id="P7000497027000000000000000040794">What is the address of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040795" id="P7000497027000000000000000040795">ja</code> and pop instructions?</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040796" id="P7000497027000000000000000040796"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040797" id="P7000497027000000000000000040797">
XXXXXX: 77 02	ja	400547
XXXXXX: 5d	pop	%rbp
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040798" id="P7000497027000000000000000040798"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040799" id="P7000497027000000000000000040799">In the code that follows, the jump target is encoded in PC-relative form as a 4-byte two's-complement number. The bytes are listed from least significant to most, reflecting the little-endian byte ordering of x86-64. What is the address of the jump target?</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004079A" id="P700049702700000000000000004079A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004079B" id="P700049702700000000000000004079B">
4005e8: e9 73 ff ff ff	jmpq	XXXXXXX
4005ed: 90		nop
</code></pre>
</li></ol></div></li></ol>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004079C" id="P700049702700000000000000004079C">The jump instructions provide a means to implement conditional execution (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004079D" id="P700049702700000000000000004079D">if</code>), as well as several different loop constructs.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002517" id="P7000497027000000000000000002517"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004079E" epub:type="title" id="P700049702700000000000000004079E"><span class="pcalibre1 pcalibre21 pcalibre2">3.6.5 </span>Implementing Conditional Branches with Conditional Control</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004079F" id="P700049702700000000000000004079F">The most general way to translate conditional expressions and statements from C into machine code is to use combinations of conditional and unconditional jumps. (As an alternative, we will see in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002578"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6.6</span></a> that some conditionals can be implemented by conditional transfers of data rather than control.) For example, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16(a)</span></a> shows the C code for a function that computes the absolute value of the difference of two numbers.<a class="pcalibre1 pcalibre2 pcalibre56 pcalibre16 pcalibre14 pcalibre15" epub:type="noteref" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000003A6E" id="r__P7000497027000000000000000003A6E"><sup class="pcalibre1 pcalibre2 calibre8">3</sup></a> The function also has a side effect of incrementing one of two counters, encoded as global variables <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407A0" id="P70004970270000000000000000407A0">lt_cnt and ge_cnt.</code> Gcc generates the assembly code shown as <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16(c)</span></a>. Our rendition of the machine code into C is shown as the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407A1" id="P70004970270000000000000000407A1">gotodiff_se</code> (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16(b)</span></a>). It uses the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407A2" id="P70004970270000000000000000407A2">goto</code> statement in C, which is similar to the unconditional jump of</p><aside class="pcalibre2 pcalibre32 pcalibre57" data-uri="chapter03.xhtml#P7000497027000000000000000003A6E" epub:type="footnote" id="P7000497027000000000000000003A6E"><p class="pcalibre1 pcalibre2 pcalibre10"><span class="pcalibre1 pcalibre58 pcalibre2"><a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP7000497027000000000000000002339_split_000.xhtml#r__P7000497027000000000000000003A6E">3. </a></span>Actually, it can return a negative value if one of the subtractions overflows. Our interest here is to demonstrate machine code, not to implement robust code.</p></aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P700049702700000000000000000251D" id="P700049702700000000000000000251D">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407A3" id="P70004970270000000000000000407A3"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P700049702700000000000000000251F" epub:type="pagebreak" id="P700049702700000000000000000251F" title="210"></span>(a) Original C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407A4" id="P70004970270000000000000000407A4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407A5" id="P70004970270000000000000000407A5">
long lt_cnt = 0;
long ge_cnt = 0;
long absdiff_se(long x, long y)
{
	long result;
	if (x &lt; y) {
		lt_cnt++;
		result = y - x;
	}
	else {
		ge_cnt++;
		result = x - y;
	}
	return result;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407A6" id="P70004970270000000000000000407A6">(b) Equivalent goto version</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407A7" id="P70004970270000000000000000407A7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407A8" id="P70004970270000000000000000407A8">
1 long gotodiff_se(long x, long y)
2 {
3	long result;
4	if (x &gt;= y)
5		goto x_ge_y;
6	lt_cnt++;
7	result = y - x;
8	return result;
9 x_ge_y:
10	ge_cnt++;
11	result = x - y;
12	return result;
13 }
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407A9" id="P70004970270000000000000000407A9">(c) Generated assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407AA" id="P70004970270000000000000000407AA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407AB" id="P70004970270000000000000000407AB">
  <i class="pcalibre17 pcalibre2 pcalibre1">long absdiff_se(long x, long y</i>)
  <i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi</i>
1	absdiff_se:
2		cmpq	%rsi, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Compare x:y</i>
3		jge	.L2		<i class="pcalibre17 pcalibre2 pcalibre1">If &gt;= goto</i> <b class="pcalibre1 pcalibre2 pcalibre12">x_ge_y</b>
4		addq	$1,lt_cnt(%rip)	<i class="pcalibre17 pcalibre2 pcalibre1">lt_cnt++</i>
5		movq	%rsi, %rax
6		subq	%rdi, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">result = y - x</i>
7		ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
8	.L2:			  <b class="pcalibre1 pcalibre2 pcalibre12">x_ge_y</b><i class="pcalibre17 pcalibre2 pcalibre1">:</i>
9		addq $1, ge_cnt(%rip)	<i class="pcalibre17 pcalibre2 pcalibre1">ge_cnt++</i>
10		movq %rdi, %rax
11		subq %rsi, %rax		<i class="pcalibre17 pcalibre2 pcalibre1">result = x - y</i>
12		ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P70004970270000000000000000407AC" id="P70004970270000000000000000407AC"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P70004970270000000000000000407AD" epub:type="title" id="P70004970270000000000000000407AD"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.16 </span>Compilation of conditional statements.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407AE" id="P70004970270000000000000000407AE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407AF" id="P70004970270000000000000000407AF">(a) C procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407B0" id="P70004970270000000000000000407B0">absdiff_se</code> contains an if-else statement. The generated assembly code is shown (c), along with (b) a C procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407B1" id="P70004970270000000000000000407B1">gotodiff_se</code> that mimics the control flow of the assembly code.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407B2" id="P70004970270000000000000000407B2">assembly code. Using <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407B3" id="P70004970270000000000000000407B3">goto</code> statements is generally considered a bad programming style, since their use can make code very difficult to read and debug. We use them in our presentation as a way to construct C programs that describe the control flow of machine code. We call this style of programming "goto code."</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407B4" id="P70004970270000000000000000407B4">In the goto code (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16(b)</span></a>), the statement <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407B5" id="P70004970270000000000000000407B5">goto x_ge_y</code> on line 5 causes a jump to the label <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407B6" id="P70004970270000000000000000407B6">x_ge_y</code> (since it occurs when <var class="pcalibre17 pcalibre2 pcalibre1">x</var> ≥ <var class="pcalibre17 pcalibre2 pcalibre1">y</var>) on line 9. Continuing the</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000002533" id="P7000497027000000000000000002533"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P70004970270000000000000000407B7" epub:type="title" id="P70004970270000000000000000407B7"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002535" epub:type="pagebreak" id="P7000497027000000000000000002535" title="211"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Describing machine code with C code</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407B8" id="P70004970270000000000000000407B8"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16</span></a> shows an example of how we will demonstrate the translation of C language control constructs into machine code. The figure contains an example C function (a) and an annotated version of the assembly code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>(c). It also contains a version in C that closely matches the structure of the assembly code (b). Although these versions were generated in the sequence (a), (c), and (b), we recommend that you read them in the order (a), (b), and then (c). That is, the C rendition of the machine code will help you understand the key points, and this can guide you in understanding the actual assembly code.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407B9" id="P70004970270000000000000000407B9">execution from this point, it completes the computations specified by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407BA" id="P70004970270000000000000000407BA">else</code> portion of function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407BB" id="P70004970270000000000000000407BB">absdiff_se</code> and returns. On the other hand, if the test <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407BC" id="P70004970270000000000000000407BC">x &gt;= y</code> fails, the program procedure will carry out the steps specified by the if portion of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407BD" id="P70004970270000000000000000407BD">absdiff_se</code> and return.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407BE" id="P70004970270000000000000000407BE">The assembly-code implementation (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16(c)</span></a>) first compares the two operands (line 2), setting the condition codes. If the comparison result indicates that <var class="pcalibre17 pcalibre2 pcalibre1">x</var> is greater than or equal to <var class="pcalibre17 pcalibre2 pcalibre1">y</var>, it then jumps to a block of code starting at line 8 that increments global variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407BF" id="P70004970270000000000000000407BF">ge_cnt</code>, computes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407C0" id="P70004970270000000000000000407C0">x-y</code> as the return value, and returns. Otherwise, it continues with the execution of code beginning at line 4 that increments global variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407C1" id="P70004970270000000000000000407C1">lt_cnt</code>, computes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407C2" id="P70004970270000000000000000407C2">y-x</code> as the return value, and returns. We can see, then, that the control flow of the assembly code generated for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407C3" id="P70004970270000000000000000407C3">absdiff_se</code> closely follows the goto code of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407C4" id="P70004970270000000000000000407C4">gotodiff_se.</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407C5" id="P70004970270000000000000000407C5">The general form of an if-else statement in C is given by the template</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407C6" id="P70004970270000000000000000407C6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407C7" id="P70004970270000000000000000407C7">
if (<i class="pcalibre17 pcalibre2 pcalibre1">test-expr</i>)
  <i class="pcalibre17 pcalibre2 pcalibre1">then-statement</i>
else
  <i class="pcalibre17 pcalibre2 pcalibre1">else-statement</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407C8" id="P70004970270000000000000000407C8">where <i class="pcalibre17 pcalibre2 pcalibre1">test-expr</i> is an integer expression that evaluates either to zero (interpreted as meaning "false") or to a nonzero value (interpreted as meaning "true"). Only one of the two branch statements (<i class="pcalibre17 pcalibre2 pcalibre1">then-statement</i> or <i class="pcalibre17 pcalibre2 pcalibre1">else-statement</i>) is executed.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407C9" id="P70004970270000000000000000407C9">For this general form, the assembly implementation typically adheres to the following form, where we use C syntax to describe the control flow:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407CA" id="P70004970270000000000000000407CA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407CB" id="P70004970270000000000000000407CB">
  t = <i class="pcalibre17 pcalibre2 pcalibre1">test-expr</i>;
  if (!t)
  	goto false;
  <i class="pcalibre17 pcalibre2 pcalibre1">then-statement</i>
  goto done;
false:
  <i class="pcalibre17 pcalibre2 pcalibre1">else-statement</i>
done:
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407CC" id="P70004970270000000000000000407CC"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000254B" epub:type="pagebreak" id="P700049702700000000000000000254B" title="212"></span>That is, the compiler generates separate blocks of code for <i class="pcalibre17 pcalibre2 pcalibre1">then-statement</i> and <i class="pcalibre17 pcalibre2 pcalibre1">else-statement</i>. It inserts conditional and unconditional branches to make sure the correct block is executed.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000254C" epub:type="practice" id="P700049702700000000000000000254C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407CD" epub:type="title" id="P70004970270000000000000000407CD"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P70004970270000000000000000035CB">331</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000407CE" id="P70004970270000000000000000407CE">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000407CF" id="P70004970270000000000000000407CF">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000407D0" id="P70004970270000000000000000407D0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407D1" id="P70004970270000000000000000407D1">When given the C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407D2" id="P70004970270000000000000000407D2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407D3" id="P70004970270000000000000000407D3">void cond(long a, long *p)
{
  if (p &amp;&amp; a &gt; *p)
  	*p = a;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407D4" id="P70004970270000000000000000407D4"><span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407D5" id="P70004970270000000000000000407D5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407D6" id="P70004970270000000000000000407D6">
  <i class="pcalibre17 pcalibre2 pcalibre1">void cond(long a, long *p</i>)
  <i class="pcalibre17 pcalibre2 pcalibre1">a in %rdi, p in %rsi</i>
cond:
  testq %rsi, %rsi
  je .L1
  cmpq %rdi, (%rsi)
  jge .L1
  movq %rdi, (%rsi)
.L1:
  rep; ret
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000407D7" id="P70004970270000000000000000407D7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407D8" id="P70004970270000000000000000407D8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407D9" id="P70004970270000000000000000407D9">Write a goto version in C that performs the same computation and mimics the control flow of the assembly code, in the style shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16(b)</span></a>. You might find it helpful to first annotate the assembly code as we have done in our examples.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407DA" id="P70004970270000000000000000407DA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407DB" id="P70004970270000000000000000407DB">Explain why the assembly code contains two conditional branches, even though the C code has only one if statement.</p></li>
</ol>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000255C" epub:type="practice" id="P700049702700000000000000000255C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407DC" epub:type="title" id="P70004970270000000000000000407DC"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.17 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P70004970270000000000000000035CB">331</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000407DD" id="P70004970270000000000000000407DD">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000407DE" id="P70004970270000000000000000407DE">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000407DF" id="P70004970270000000000000000407DF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407E0" id="P70004970270000000000000000407E0">An alternate rule for translating <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407E1" id="P70004970270000000000000000407E1">if</code> statements into goto code is as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407E2" id="P70004970270000000000000000407E2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407E3" id="P70004970270000000000000000407E3">
  t = <i class="pcalibre17 pcalibre2 pcalibre1">test-expr</i>;
  if (t)
  	goto true;
  <i class="pcalibre17 pcalibre2 pcalibre1">else-statement</i>
  goto done;
true:
  <i class="pcalibre17 pcalibre2 pcalibre1">then-statement</i>
done:
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000407E4" id="P70004970270000000000000000407E4">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407E5" id="P70004970270000000000000000407E5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407E6" id="P70004970270000000000000000407E6"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002568" epub:type="pagebreak" id="P7000497027000000000000000002568" title="213"></span>Rewrite the goto version of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407E7" id="P70004970270000000000000000407E7">absdiff_se</code> based on this alternate rule.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407E8" id="P70004970270000000000000000407E8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407E9" id="P70004970270000000000000000407E9">Can you think of any reasons for choosing one rule over the other?</p></li>
</ol>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000256C" epub:type="practice" id="P700049702700000000000000000256C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407EA" epub:type="title" id="P70004970270000000000000000407EA"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.18 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P70004970270000000000000000035F9">332</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000407EB" id="P70004970270000000000000000407EB">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000407EC" id="P70004970270000000000000000407EC">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000407ED" id="P70004970270000000000000000407ED"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407EE" id="P70004970270000000000000000407EE">Starting with C code of the form</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407EF" id="P70004970270000000000000000407EF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407F0" id="P70004970270000000000000000407F0">
long test(long x, long y, long z) {
  long val = __________;
  if (__________) {
  	if (__________)
  		val = __________;
  	else
  		val = __________;
  } else if (__________)
  	val = __________;
  return val;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407F1" id="P70004970270000000000000000407F1"><span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407F2" id="P70004970270000000000000000407F2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407F3" id="P70004970270000000000000000407F3">
  <i class="pcalibre17 pcalibre2 pcalibre1">long test(long x, long y, long z</i>)
  <i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, z in %rdx</i>
  test:
  leaq	(%rdi,%rsi), %rax
  addq	%rdx, %rax
  cmpq	$-3, %rdi
  jge	.L2
  cmpq	%rdx, %rsi
  jge	.L3
  movq	%rdi, %rax
  imulq	%rsi, %rax
  ret
  .L3:
  movq	%rsi, %rax
  imulq	%rdx, %rax
  ret
  .L2:
  cmpq	$2, %rdi
  jle	.L4
  movq	%rdi, %rax
  imulq	%rdx, %rax
  .L4:
  rep; ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000407F4" id="P70004970270000000000000000407F4">Fill in the missing expressions in the C code.</p>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002578" id="P7000497027000000000000000002578"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407F5" epub:type="title" id="P70004970270000000000000000407F5"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000257A" epub:type="pagebreak" id="P700049702700000000000000000257A" title="214"></span><span class="pcalibre1 pcalibre21 pcalibre2">3.6.6 </span>Implementing Conditional Branches with Conditional Moves</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407F6" id="P70004970270000000000000000407F6">The conventional way to implement conditional operations is through a conditional transfer of <i class="pcalibre17 pcalibre2 pcalibre1">control</i>, where the program follows one execution path when a condition holds and another when it does not. This mechanism is simple and general, but it can be very inefficient on modern processors.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407F7" id="P70004970270000000000000000407F7">An alternate strategy is through a conditional transfer of <i class="pcalibre17 pcalibre2 pcalibre1">data</i>. This approach computes both outcomes of a conditional operation and then selects one based on whether or not the condition holds. This strategy makes sense only in restricted cases, but it can then be implemented by a simple <i class="pcalibre17 pcalibre2 pcalibre1">conditional move</i> instruction that is better matched to the performance characteristics of modern processors. Here, we examine this strategy and its implementation with x86-64.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407F8" id="P70004970270000000000000000407F8"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002580"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.17(a)</span></a> shows an example of code that can be compiled using a conditional move. The function computes the absolute value of its arguments x and y, as did our earlier example (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16</span></a>).Whereas the earlier example had side effects in the branches, modifying the value of either <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407F9" id="P70004970270000000000000000407F9">lt_cnt</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407FA" id="P70004970270000000000000000407FA">ge_cnt</code>, this version simply computes the value to be returned by the function.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002580" id="P7000497027000000000000000002580">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407FB" id="P70004970270000000000000000407FB">(a) Original C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407FC" id="P70004970270000000000000000407FC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407FD" id="P70004970270000000000000000407FD">
long absdiff(long x, long y)
{
  long result;
  if (x &lt; y)
  	result = y - x;
  else
  	result = x - y;
  return result;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000407FE" id="P70004970270000000000000000407FE">(b) Implementation using conditional assignment</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000407FF" id="P70004970270000000000000000407FF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040800" id="P7000497027000000000000000040800">
1	long cmovdiff(long x, long y)
2	{
3		long rval = y-x;
4		long eval = x-y;
5		long ntest = x &gt;= y;
6		/* Line below requires
7			single instruction: */
8		if (ntest) rval = eval;
9		return rval;
10	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040801" id="P7000497027000000000000000040801">(c) Generated assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040802" id="P7000497027000000000000000040802"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040803" id="P7000497027000000000000000040803">
  <i class="pcalibre17 pcalibre2 pcalibre1">long absdiff(long x, long y</i>)
  <i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi</i>
1	absdiff:
2		movq	%rsi, %rax
3		subq	%rdi, %rax	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">rval = y-x</i></b>
4		movq	%rdi, %rdx
5		subq	%rsi, %rdx	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">eval = x-y</i></b>
6		cmpq	%rsi, %rdi	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">Compare x:y</i></b>
7		cmovge	%rdx, %rax	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">If &gt;=, rval = eval</i></b>
8		ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return tval</i>
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040804" id="P7000497027000000000000000040804"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040805" epub:type="title" id="P7000497027000000000000000040805"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.17 </span>Compilation of conditional statements using conditional assignment.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040806" id="P7000497027000000000000000040806"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040807" id="P7000497027000000000000000040807">(a) C function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040808" id="P7000497027000000000000000040808">absdiff</code> contains a conditional expression. The generated assembly code is shown (c), along with (b) a C function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040809" id="P7000497027000000000000000040809">cmovdiff</code> that mimics the operation of the assembly code.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004080A" id="P700049702700000000000000004080A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002591" epub:type="pagebreak" id="P7000497027000000000000000002591" title="215"></span>For this function, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004080B" id="P700049702700000000000000004080B"><span class="pcalibre1 pcalibre29 pcalibre2">gcc</span></code> generates the assembly code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002580"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.17(c)</span></a>, having an approximate form shown by the C function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004080C" id="P700049702700000000000000004080C">cmovdiff</code> shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002580"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.17(b)</span></a>. Studying the C version, we can see that it computes both <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004080D" id="P700049702700000000000000004080D">y-x</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004080E" id="P700049702700000000000000004080E">x-y</code>, naming these <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004080F" id="P700049702700000000000000004080F">rval</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040810" id="P7000497027000000000000000040810">eval</code>, respectively. It then tests whether <var class="pcalibre17 pcalibre2 pcalibre1">x</var> is greater than or equal to <var class="pcalibre17 pcalibre2 pcalibre1">y</var>, and if so, copies <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040811" id="P7000497027000000000000000040811">eval</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040812" id="P7000497027000000000000000040812">rval</code> before returning <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040813" id="P7000497027000000000000000040813">rval</code>. The assembly code in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002580"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.17(c)</span></a> follows the same logic. The key is that the single <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040814" id="P7000497027000000000000000040814">cmovge</code> instruction (line 7) of the assembly code implements the conditional assignment (line 8) of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040815" id="P7000497027000000000000000040815">cmovdiff</code>. It will transfer the data from the source register to the destination, only if the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040816" id="P7000497027000000000000000040816">cmpq</code> instruction of line 6 indicates that one value is greater than or equal to the other (as indicated by the suffix <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040817" id="P7000497027000000000000000040817">ge</code>).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040818" id="P7000497027000000000000000040818">To understand why code based on conditional data transfers can outperform code based on conditional control transfers (as in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16</span></a>), we must understand something about how modern processors operate. As we will see in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003A76.xhtml#P7000497027000000000000000003A76"><span class="pcalibre1 pcalibre21 pcalibre2">Chapters </span><span class="pcalibre1 pcalibre21 pcalibre2">4</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004893.xhtml#P7000497027000000000000000004893"><span class="pcalibre1 pcalibre21 pcalibre2">5</span></a>, processors achieve high performance through <i class="pcalibre17 pcalibre2 pcalibre1">pipelining</i>, where an instruction is processed via a sequence of stages, each performing one small portion of the required operations (e.g., fetching the instruction from memory, determining the instruction type, reading from memory, performing an arithmetic operation, writing to memory, and updating the program counter). This approach achieves high performance by overlapping the steps of the successive instructions, such as fetching one instruction while performing the arithmetic operations for a previous instruction. To do this requires being able to determine the sequence of instructions to be executed well ahead of time in order to keep the pipeline full of instructions to be executed. When the machine encounters a conditional jump (referred to as a "branch"), it cannot determine which way the branch will go until it has evaluated the branch condition. Processors employ sophisticated <i class="pcalibre17 pcalibre2 pcalibre1">branch prediction logic</i> to try to guess whether or not each jump instruction will be followed. As long as it can guess reliably (modern microprocessor designs try to achieve success rates on the order of 90%), the instruction pipeline will be kept full of instructions. Mispredicting a jump, on the other hand, requires that the processor discard much of the work it has already done on future instructions and then begin filling the pipeline with instructions starting at the correct location. As we will see, such a misprediction can incur a serious penalty, say, 15–30 clock cycles of wasted effort, causing a serious degradation of program performance.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040819" id="P7000497027000000000000000040819">As an example, we ran timings of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004081A" id="P700049702700000000000000004081A">absdiff</code> function on an Intel Haswell processor using both methods of implementing the conditional operation. In a typical application, the outcome of the test <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004081B" id="P700049702700000000000000004081B">x &lt; y</code> is highly unpredictable, and so even the most sophisticated branch prediction hardware will guess correctly only around 50% of the time. In addition, the computations performed in each of the two code sequences require only a single clock cycle. As a consequence, the branch misprediction penalty dominates the performance of this function. For x86-64 code with conditional jumps, we found that the function requires around 8 clock cycles per call when the branching pattern is easily predictable, and around 17.50 clock cycles per call when the branching pattern is random. From this, we can infer that the branch misprediction penalty is around 19 clock cycles. That means time required by the function ranges between around 8 and 27 cycles, depending on whether or not the branch is predicted correctly.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000025A3" id="P70004970270000000000000000025A3"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P700049702700000000000000004081C" epub:type="title" id="P700049702700000000000000004081C"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000025A5" epub:type="pagebreak" id="P70004970270000000000000000025A5" title="216"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>How did you determine this penalty?</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004081D" id="P700049702700000000000000004081D">Assume the probability of misprediction is <var class="pcalibre17 pcalibre2 pcalibre1">p</var>, the time to execute the code without misprediction is <var class="pcalibre17 pcalibre2 pcalibre1">T</var><sub class="pcalibre1 pcalibre2 calibre14">OK</sub>, and the misprediction penalty is <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-neweq1.png" altimg-height="25" altimg-width="436" alttext="" data-uri="" display="inline"><m:mrow><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>avg</m:mtext></m:mrow></m:msub><m:mo stretchy="false">(</m:mo><m:mi>P</m:mi><m:mo stretchy="false">)</m:mo><m:mo>=</m:mo><m:mo stretchy="false">(</m:mo><m:mn>1</m:mn><m:mo>−</m:mo><m:mi>P</m:mi><m:mo stretchy="false">)</m:mo><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>OK</m:mtext></m:mrow></m:msub><m:mo>+</m:mo><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>MP</m:mtext></m:mrow></m:msub><m:mo stretchy="false">)</m:mo><m:mo>=</m:mo><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>OK</m:mtext></m:mrow></m:msub><m:mo>+</m:mo><m:mi>P</m:mi><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>MP</m:mtext></m:mrow></m:msub></m:mrow></m:math></span>. We are given <var class="pcalibre17 pcalibre2 pcalibre1">T</var><sub class="pcalibre1 pcalibre2 calibre14">OK</sub> and <var class="pcalibre17 pcalibre2 pcalibre1">T</var><sub class="pcalibre1 pcalibre2 calibre14">ran</sub>, the average time when <var class="pcalibre17 pcalibre2 pcalibre1">p</var> = 0.5, and we want to determine <var class="pcalibre17 pcalibre2 pcalibre1">T</var><sub class="pcalibre1 pcalibre2 calibre14">MP</sub>. Substituting into the equation, we get <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-neweq2.png" altimg-height="23" altimg-width="262" alttext="" data-uri="" display="inline"><m:mrow><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>ran</m:mtext></m:mrow></m:msub><m:mo>=</m:mo><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>avg</m:mtext></m:mrow></m:msub><m:mo stretchy="false">(</m:mo><m:mn>0.5</m:mn><m:mo stretchy="false">)</m:mo><m:mo>=</m:mo><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>OK</m:mtext></m:mrow></m:msub><m:mo>+</m:mo><m:mn>0.5</m:mn><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>MP</m:mtext></m:mrow></m:msub><m:mo>,</m:mo><m:mtext> </m:mtext><m:mtext>and</m:mtext><m:mtext> </m:mtext><m:mtext>therefore</m:mtext><m:mtext> </m:mtext><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>MP</m:mtext></m:mrow></m:msub><m:mo>=</m:mo><m:mn>2</m:mn><m:mo stretchy="false">(</m:mo><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>ran</m:mtext></m:mrow></m:msub><m:mo>−</m:mo><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>OK</m:mtext></m:mrow></m:msub><m:mo stretchy="false">)</m:mo><m:mo>.</m:mo><m:mtext> </m:mtext><m:mi>S</m:mi><m:mi>o</m:mi><m:mo>,</m:mo><m:mtext> </m:mtext><m:mi>f</m:mi><m:mi>o</m:mi><m:mi>r</m:mi><m:mtext> </m:mtext><m:msub><m:mi>T</m:mi><m:mrow><m:mtext>OK</m:mtext></m:mrow></m:msub><m:mo>=</m:mo><m:mn>8</m:mn><m:mtext> </m:mtext><m:mtext>and</m:mtext><m:mtext> </m:mtext><m:msub><m:mtext>T</m:mtext><m:mrow><m:mtext>ran</m:mtext></m:mrow></m:msub><m:mo>=</m:mo><m:mn>17.5</m:mn><m:mo>,</m:mo><m:mtext> </m:mtext><m:mtext>we</m:mtext><m:mtext> </m:mtext><m:mtext>get</m:mtext><m:mtext> </m:mtext><m:msub><m:mtext>T</m:mtext><m:mrow><m:mtext>MP</m:mtext></m:mrow></m:msub><m:mo>=</m:mo><m:mn>19</m:mn></m:mrow></m:math></span>.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004081E" id="P700049702700000000000000004081E">On the other hand, the code compiled using conditional moves requires around 8 clock cycles regardless of the data being tested. The flow of control does not depend on data, and this makes it easier for the processor to keep its pipeline full.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000025A8" epub:type="practice" id="P70004970270000000000000000025A8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004081F" epub:type="title" id="P700049702700000000000000004081F"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.19 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_000.xhtml#P70004970270000000000000000035F9">332</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040820" id="P7000497027000000000000000040820">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040821" id="P7000497027000000000000000040821">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040822" id="P7000497027000000000000000040822"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040823" id="P7000497027000000000000000040823">Running on an older processor model, our code required around 16 cycles when the branching pattern was highly predictable, and around 31 cycles when the pattern was random.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000040824" id="P7000497027000000000000000040824">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040825" id="P7000497027000000000000000040825"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040826" id="P7000497027000000000000000040826">What is the approximate miss penalty?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040827" id="P7000497027000000000000000040827"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040828" id="P7000497027000000000000000040828">How many cycles would the function require when the branch is mispredicted?</p></li>
</ol>
</div></li></ol>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040829" id="P7000497027000000000000000040829"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P70004970270000000000000000025B9"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.18</span></a> illustrates some of the conditional move instructions available with x86-64. Each of these instructions has two operands: a source register or memory location <var class="pcalibre17 pcalibre2 pcalibre1">S</var>, and a destination register <var class="pcalibre17 pcalibre2 pcalibre1">R</var>. As with the different set (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002382"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6.2</span></a>) and jump (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000244A"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6.3</span></a>) instructions, the outcome of these instructions depends on the values of the condition codes. The source value is read from either memory or the source register, but it is copied to the destination only if the specified condition holds.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004082A" id="P700049702700000000000000004082A">The source and destination values can be 16, 32, or 64 bits long. Single-byte conditional moves are not supported. Unlike the unconditional instructions, where the operand length is explicitly encoded in the instruction name (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004082B" id="P700049702700000000000000004082B">movw</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004082C" id="P700049702700000000000000004082C">movl</code>), the assembler can infer the operand length of a conditional move instruction from the name of the destination register, and so the same instruction name can be used for all operand lengths.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004082D" id="P700049702700000000000000004082D">Unlike conditional jumps, the processor can execute conditional move instructions without having to predict the outcome of the test. The processor simply reads the source value (possibly from memory), checks the condition code, and then either updates the destination register or keeps it the same. We will explore the implementation of conditional moves in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003A76.xhtml#P7000497027000000000000000003A76"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">4</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004082E" id="P700049702700000000000000004082E">To understand how conditional operations can be implemented via conditional data transfers, consider the following general form of conditional expression and assignment:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P70004970270000000000000000025B9" id="P70004970270000000000000000025B9">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P700049702700000000000000004082F" id="P700049702700000000000000004082F">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" colspan="2" data-uri="chapter03.xhtml#P7000497027000000000000000040830" id="P7000497027000000000000000040830"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P70004970270000000000000000025BC" epub:type="pagebreak" id="P70004970270000000000000000025BC" title="217"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040831" id="P7000497027000000000000000040831">Synonym</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040832" id="P7000497027000000000000000040832">Move condition</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040833" id="P7000497027000000000000000040833">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040834" id="P7000497027000000000000000040834"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040835" id="P7000497027000000000000000040835">cmove</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040836" id="P7000497027000000000000000040836"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040837" id="P7000497027000000000000000040837"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040838" id="P7000497027000000000000000040838">cmovz</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040839" id="P7000497027000000000000000040839"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004083A" id="P700049702700000000000000004083A">ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004083B" id="P700049702700000000000000004083B">Equal / zero</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004083C" id="P700049702700000000000000004083C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004083D" id="P700049702700000000000000004083D">cmovne</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004083E" id="P700049702700000000000000004083E"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004083F" id="P700049702700000000000000004083F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040840" id="P7000497027000000000000000040840">cmovnz</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040841" id="P7000497027000000000000000040841"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040842" id="P7000497027000000000000000040842">~ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040843" id="P7000497027000000000000000040843">Not equal / not zero</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040844" id="P7000497027000000000000000040844"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040845" id="P7000497027000000000000000040845">cmovs</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040846" id="P7000497027000000000000000040846"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040847" id="P7000497027000000000000000040847"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040848" id="P7000497027000000000000000040848">SF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040849" id="P7000497027000000000000000040849">Negative</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004084A" id="P700049702700000000000000004084A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004084B" id="P700049702700000000000000004084B">cmovns</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004084C" id="P700049702700000000000000004084C"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004084D" id="P700049702700000000000000004084D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004084E" id="P700049702700000000000000004084E">~SF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004084F" id="P700049702700000000000000004084F">Nonnegative</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040850" id="P7000497027000000000000000040850"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040851" id="P7000497027000000000000000040851">cmovg</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040852" id="P7000497027000000000000000040852"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040853" id="P7000497027000000000000000040853"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040854" id="P7000497027000000000000000040854">cmovnle</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040855" id="P7000497027000000000000000040855"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040856" id="P7000497027000000000000000040856">~(SF ^ OF) &amp; ~ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040857" id="P7000497027000000000000000040857">Greater (signed &gt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040858" id="P7000497027000000000000000040858"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040859" id="P7000497027000000000000000040859">cmovge</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004085A" id="P700049702700000000000000004085A"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004085B" id="P700049702700000000000000004085B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004085C" id="P700049702700000000000000004085C">cmovnl</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004085D" id="P700049702700000000000000004085D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004085E" id="P700049702700000000000000004085E">~(SF ^ OF)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004085F" id="P700049702700000000000000004085F">Greater or equal (signed &gt;=)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040860" id="P7000497027000000000000000040860"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040861" id="P7000497027000000000000000040861">cmovl</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040862" id="P7000497027000000000000000040862"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040863" id="P7000497027000000000000000040863"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040864" id="P7000497027000000000000000040864">cmovnge</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040865" id="P7000497027000000000000000040865"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040866" id="P7000497027000000000000000040866">SF ^ OF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040867" id="P7000497027000000000000000040867">Less (signed &lt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040868" id="P7000497027000000000000000040868"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040869" id="P7000497027000000000000000040869">cmovle</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004086A" id="P700049702700000000000000004086A"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004086B" id="P700049702700000000000000004086B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004086C" id="P700049702700000000000000004086C">cmovng</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004086D" id="P700049702700000000000000004086D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004086E" id="P700049702700000000000000004086E">(SF ^ OF) | ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004086F" id="P700049702700000000000000004086F">Less or equal (signed &lt;=)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040870" id="P7000497027000000000000000040870"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040871" id="P7000497027000000000000000040871">cmova</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040872" id="P7000497027000000000000000040872"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040873" id="P7000497027000000000000000040873"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040874" id="P7000497027000000000000000040874">cmovnbe</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040875" id="P7000497027000000000000000040875"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040876" id="P7000497027000000000000000040876">~CF &amp; ~ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040877" id="P7000497027000000000000000040877">Above (unsigned &gt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040878" id="P7000497027000000000000000040878"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040879" id="P7000497027000000000000000040879">cmovae</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004087A" id="P700049702700000000000000004087A"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004087B" id="P700049702700000000000000004087B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004087C" id="P700049702700000000000000004087C">cmovnb</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004087D" id="P700049702700000000000000004087D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004087E" id="P700049702700000000000000004087E">~CF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004087F" id="P700049702700000000000000004087F">Above or equal (Unsigned &gt;=)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040880" id="P7000497027000000000000000040880"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040881" id="P7000497027000000000000000040881">cmovb</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040882" id="P7000497027000000000000000040882"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040883" id="P7000497027000000000000000040883"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040884" id="P7000497027000000000000000040884">cmovnae</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040885" id="P7000497027000000000000000040885"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040886" id="P7000497027000000000000000040886">CF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040887" id="P7000497027000000000000000040887">Below (unsigned &lt;)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040888" id="P7000497027000000000000000040888"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040889" id="P7000497027000000000000000040889">cmovbe</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004088A" id="P700049702700000000000000004088A"><var class="pcalibre17 pcalibre2 pcalibre1">S</var>, <var class="pcalibre17 pcalibre2 pcalibre1">R</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004088B" id="P700049702700000000000000004088B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004088C" id="P700049702700000000000000004088C">cmovna</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004088D" id="P700049702700000000000000004088D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004088E" id="P700049702700000000000000004088E">CF | ZF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004088F" id="P700049702700000000000000004088F">Below or equal (unsigned &lt;=)</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040890" id="P7000497027000000000000000040890"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040891" epub:type="title" id="P7000497027000000000000000040891"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.18 </span>The conditional move instructions.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040892" id="P7000497027000000000000000040892"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040893" id="P7000497027000000000000000040893">These instructions copy the source value <var class="pcalibre17 pcalibre2 pcalibre1">S</var> to its destination <var class="pcalibre17 pcalibre2 pcalibre1">R</var> when the move condition holds. Some instructions have "synonyms," alternate names for the same machine instruction.</p></div></figcaption>
</figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040894" id="P7000497027000000000000000040894"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040895" id="P7000497027000000000000000040895">
v = <i class="pcalibre17 pcalibre2 pcalibre1">test-expr</i> ? <i class="pcalibre17 pcalibre2 pcalibre1">then-expr</i> : <i class="pcalibre17 pcalibre2 pcalibre1">else-expr</i>;
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040896" id="P7000497027000000000000000040896">The standard way to compile this expression using conditional control transfer would have the following form:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040897" id="P7000497027000000000000000040897"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040898" id="P7000497027000000000000000040898">
  if (!<i class="pcalibre17 pcalibre2 pcalibre1">test-expr</i>)
  	goto false;
  v = <i class="pcalibre17 pcalibre2 pcalibre1">then-expr</i>;
  goto done;
false:
  v = <i class="pcalibre17 pcalibre2 pcalibre1">else-expr</i>;
done:
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040899" id="P7000497027000000000000000040899">This code contains two code sequences—one evaluating <i class="pcalibre17 pcalibre2 pcalibre1">then-expr</i> and one evaluating <i class="pcalibre17 pcalibre2 pcalibre1">else-expr</i>. A combination of conditional and unconditional jumps is used to ensure that just one of the sequences is evaluated.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004089A" id="P700049702700000000000000004089A">For the code based on a conditional move, both the <i class="pcalibre17 pcalibre2 pcalibre1">then-expr</i> and the <i class="pcalibre17 pcalibre2 pcalibre1">else-expr</i> are evaluated, with the final value chosen based on the evaluation <i class="pcalibre17 pcalibre2 pcalibre1">test-expr</i>. This can be described by the following abstract code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004089B" id="P700049702700000000000000004089B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004089C" id="P700049702700000000000000004089C">
v = <i class="pcalibre17 pcalibre2 pcalibre1">then-expr</i>;
ve = <i class="pcalibre17 pcalibre2 pcalibre1">else-expr</i>;
t = <i class="pcalibre17 pcalibre2 pcalibre1">test-expr</i>;
if (!t) v = ve;
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004089D" id="P700049702700000000000000004089D">The final statement in this sequence is implemented with a conditional move—value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004089E" id="P700049702700000000000000004089E">ve</code> is copied to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004089F" id="P700049702700000000000000004089F">v</code> only if test condition <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408A0" id="P70004970270000000000000000408A0">t</code> does not hold.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408A1" id="P70004970270000000000000000408A1"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000262E" epub:type="pagebreak" id="P700049702700000000000000000262E" title="218"></span>Not all conditional expressions can be compiled using conditional moves. Most significantly, the abstract code we have shown evaluates both <i class="pcalibre17 pcalibre2 pcalibre1">then-expr</i> and <i class="pcalibre17 pcalibre2 pcalibre1">else-expr</i> regardless of the test outcome. If one of those two expressions could possibly generate an error condition or a side effect, this could lead to invalid behavior. Such is the case for our earlier example (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000251D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16</span></a>). Indeed, we put the side effects into this example specifically to force <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408A2" id="P70004970270000000000000000408A2"><span class="pcalibre1 pcalibre29 pcalibre2">gcc</span></code> to implement this function using conditional transfers.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408A3" id="P70004970270000000000000000408A3">As a second illustration, consider the following C function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000408A4" id="P70004970270000000000000000408A4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408A5" id="P70004970270000000000000000408A5">
long cread(long *xp) {
	return (xp ? *xp : 0);
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408A6" id="P70004970270000000000000000408A6">At first, this seems like a good candidate to compile using a conditional move to set the result to zero when the pointer is null, as shown in the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000408A7" id="P70004970270000000000000000408A7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408A8" id="P70004970270000000000000000408A8">
	<i class="pcalibre17 pcalibre2 pcalibre1">long cread(long *xp</i>)
	<i class="pcalibre17 pcalibre2 pcalibre1">Invalid implementation of function cread</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">xp in register %rdi</i>
1	cread:
2	  movq (%rdi), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">v = *xp</i>
3	  testq %rdi, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Test x</i>
4	  movl $0, %edx		<i class="pcalibre17 pcalibre2 pcalibre1">Set ve = 0</i>
5	  cmove %rdx, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">If x==0, v = ve</i>
6	  ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return v</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408A9" id="P70004970270000000000000000408A9">This implementation is invalid, however, since the dereferencing of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408AA" id="P70004970270000000000000000408AA">xp</code> by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408AB" id="P70004970270000000000000000408AB">movq</code> instruction (line 2) occurs even when the test fails, causing a null pointer dereferencing error. Instead, this code must be compiled using branching code.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408AC" id="P70004970270000000000000000408AC">Using conditional moves also does not always improve code efficiency. For example, if either the <i class="pcalibre17 pcalibre2 pcalibre1">then-expr</i> or the <i class="pcalibre17 pcalibre2 pcalibre1">else-expr</i> evaluation requires a significant computation, then this effort is wasted when the corresponding condition does not hold. Compilers must take into account the relative performance of wasted computation versus the potential for performance penalty due to branch misprediction. In truth, they do not really have enough information to make this decision reliably; for example, they do not know how well the branches will follow predictable patterns. Our experiments with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408AD" id="P70004970270000000000000000408AD"><span class="pcalibre1 pcalibre29 pcalibre2">gcc</span></code> indicate that it only uses conditional moves when the two expressions can be computed very easily, for example, with single add instructions. In our experience, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408AE" id="P70004970270000000000000000408AE"><span class="pcalibre1 pcalibre29 pcalibre2">gcc</span></code> uses conditional control transfers even in many cases where the cost of branch misprediction would exceed even more complex computations.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000408AF" id="P70004970270000000000000000408AF">Overall, then, we see that conditional data transfers offer an alternative strategy to conditional control transfers for implementing conditional operations. They can only be used in restricted cases, but these cases are fairly common and provide a much better match to the operation of modern processors.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.7 Procedures</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P700049702700000000000000000281F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040A66" epub:type="title" id="P7000497027000000000000000040A66"><span class="pcalibre1 pcalibre21 pcalibre2">3.7 </span>Procedures</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A67" id="P7000497027000000000000000040A67">Procedures are a key abstraction in software. They provide a way to package code that implements some functionality with a designated set of arguments and an optional return value. This function can then be invoked from different points in a program. Well-designed software uses procedures as an abstraction mechanism, hiding the detailed implementation of some action while providing a clear and concise interface definition of what values will be computed and what effects the procedure will have on the program state. Procedures come in many guises <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002822" epub:type="pagebreak" id="P7000497027000000000000000002822" title="239"></span>in different programming languages—functions, methods, subroutines, handlers, and so on—but they all share a general set of features.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A68" id="P7000497027000000000000000040A68">There are many different attributes that must be handled when providing machine-level support for procedures. For discussion purposes, suppose procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A69" id="P7000497027000000000000000040A69">P</code> calls procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A6A" id="P7000497027000000000000000040A6A">Q</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A6B" id="P7000497027000000000000000040A6B">Q</code> then executes and returns back to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A6C" id="P7000497027000000000000000040A6C">P</code>. These actions involve one or more of the following mechanisms:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A6D" id="P7000497027000000000000000040A6D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040A6E" id="P7000497027000000000000000040A6E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040A6F" id="P7000497027000000000000000040A6F"><span class="pcalibre1 pcalibre2 pcalibre41">Passing control. </span>The program counter must be set to the starting address of the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A70" id="P7000497027000000000000000040A70">Q</code> upon entry and then set to the instruction in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A71" id="P7000497027000000000000000040A71">P</code> following the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A72" id="P7000497027000000000000000040A72">Q</code> upon return.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040A73" id="P7000497027000000000000000040A73"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040A74" id="P7000497027000000000000000040A74"><span class="pcalibre1 pcalibre2 pcalibre41">Passing data. </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A75" id="P7000497027000000000000000040A75">P</code> must be able to provide one or more parameters to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A76" id="P7000497027000000000000000040A76">Q</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A77" id="P7000497027000000000000000040A77">Q</code> must be able to return a value back to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A78" id="P7000497027000000000000000040A78">P</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040A79" id="P7000497027000000000000000040A79"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040A7A" id="P7000497027000000000000000040A7A"><span class="pcalibre1 pcalibre2 pcalibre41">Allocating and deallocating memory. </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A7B" id="P7000497027000000000000000040A7B">Q</code> may need to allocate space for local variables when it begins and then free that storage before it returns.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A7C" id="P7000497027000000000000000040A7C">The x86-64 implementation of procedures involves a combination of special instructions and a set of conventions on how to use the machine resources, such as the registers and the program memory. Great effort has been made to minimize the overhead involved in invoking a procedure. As a consequence, it follows what can be seen as a minimalist strategy, implementing only as much of the above set of mechanisms as is required for each particular procedure. In our presentation, we build up the different mechanisms step by step, first describing control, then data passing, and, finally, memory management.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002838" id="P7000497027000000000000000002838"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A7D" epub:type="title" id="P7000497027000000000000000040A7D"><span class="pcalibre1 pcalibre21 pcalibre2">3.7.1 </span>The Run-Time Stack</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A7E" id="P7000497027000000000000000040A7E">A key feature of the procedure-calling mechanism of C, and of most other languages, is that it can make use of the last-in, first-out memory management discipline provided by a stack data structure. Using our example of procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A7F" id="P7000497027000000000000000040A7F">P</code> calling procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A80" id="P7000497027000000000000000040A80">Q</code>, we can see that while <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A81" id="P7000497027000000000000000040A81">Q</code> is executing, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A82" id="P7000497027000000000000000040A82">P</code>, along with any of the procedures in the chain of calls up to P, is temporarily suspended. While <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A83" id="P7000497027000000000000000040A83">Q</code> is running, only it will need the ability to allocate new storage for its local variables or to set up a call to another procedure. On the other hand, when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A84" id="P7000497027000000000000000040A84">Q</code> returns, any local storage it has allocated can be freed. Therefore, a program can manage the storage required by its procedures using a stack, where the stack and the program registers store the information required for passing control and data, and for allocating memory. As <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A85" id="P7000497027000000000000000040A85">P</code> calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A86" id="P7000497027000000000000000040A86">Q</code>, control and data information are added to the end of the stack. This information gets deallocated when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A87" id="P7000497027000000000000000040A87">P</code> returns.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A88" id="P7000497027000000000000000040A88">As described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000002143"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.4.4</span></a>, the x86-64 stack grows toward lower addresses and the stack pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A89" id="P7000497027000000000000000040A89">%rsp</code> points to the top element of the stack. Data can be stored on and retrieved from the stack using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A8A" id="P7000497027000000000000000040A8A">pushq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A8B" id="P7000497027000000000000000040A8B">popq</code> instructions. Space for data with no specified initial value can be allocated on the stack by simply decrementing the stack pointer by an appropriate amount. Similarly, space can be deallocated by incrementing the stack pointer.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A8C" id="P7000497027000000000000000040A8C">When an x86-64 procedure requires storage beyond what it can hold in registers, it allocates space on the stack. This region is referred to as the procedure's</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002849" id="P7000497027000000000000000002849">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000284A" epub:type="pagebreak" id="P700049702700000000000000000284A" title="240"></span>
<img alt="A diagram illustrates a general stack frame structure." class="pcalibre1 pcalibre2 pcalibre129" data-uri="P700049702700000000000000000B6B6" id="P7000497027000000000000000040A8D" src="Images/chapter-03-image-04.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040A8E" id="P7000497027000000000000000040A8E"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040A8F" epub:type="title" id="P7000497027000000000000000040A8F"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.25 </span>General stack frame structure.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040A90" id="P7000497027000000000000000040A90"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040A91" id="P7000497027000000000000000040A91">The stack can be used for passing arguments, for storing return information, for saving registers, and for local storage. Portions may be omitted when not needed.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P7000497027000000000000000020D73" id="P7000497027000000000000000020D73">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040A92" id="P7000497027000000000000000040A92">A diagram shows a stack with increasing address from stack “top” on bottom to stack “bottom” on top. The stack is divided into sections, as summarized from stack “top” to stack “bottom” below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P7000497027000000000000000040A93" id="P7000497027000000000000000040A93">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040A94" id="P7000497027000000000000000040A94"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040A95" id="P7000497027000000000000000040A95">Stack pointer %rsp at stack “top”</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040A96" id="P7000497027000000000000000040A96"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040A97" id="P7000497027000000000000000040A97">Three sections within frame for executing function Q:</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P7000497027000000000000000040A98" id="P7000497027000000000000000040A98">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040A99" id="P7000497027000000000000000040A99"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040A9A" id="P7000497027000000000000000040A9A">Argument build area</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040A9B" id="P7000497027000000000000000040A9B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040A9C" id="P7000497027000000000000000040A9C">Local variables</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040A9D" id="P7000497027000000000000000040A9D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040A9E" id="P7000497027000000000000000040A9E">Saved registers</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040A9F" id="P7000497027000000000000000040A9F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AA0" id="P7000497027000000000000000040AA0">Five sections within frame for calling function P:</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P7000497027000000000000000040AA1" id="P7000497027000000000000000040AA1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AA2" id="P7000497027000000000000000040AA2"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AA3" id="P7000497027000000000000000040AA3">Return address</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AA4" id="P7000497027000000000000000040AA4"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AA5" id="P7000497027000000000000000040AA5">Argument 7</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AA6" id="P7000497027000000000000000040AA6"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AA7" id="P7000497027000000000000000040AA7">...</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AA8" id="P7000497027000000000000000040AA8"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AA9" id="P7000497027000000000000000040AA9">Argument n</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AAA" id="P7000497027000000000000000040AAA"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AAB" id="P7000497027000000000000000040AAB">...</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AAC" id="P7000497027000000000000000040AAC"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AAD" id="P7000497027000000000000000040AAD">Earlier frames to stack “bottom”</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AAE" id="P7000497027000000000000000040AAE"><i class="pcalibre17 pcalibre2 pcalibre1">stack frame</i>. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002849"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.25</span></a> shows the overall structure of the run-time stack, including its partitioning into stack frames, in its most general form. The frame for the currently executing procedure is always at the top of the stack. When procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AAF" id="P7000497027000000000000000040AAF">P</code> calls procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB0" id="P7000497027000000000000000040AB0">Q</code>, it will push the <i class="pcalibre17 pcalibre2 pcalibre1">return address</i> onto the stack, indicating where within <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB1" id="P7000497027000000000000000040AB1">P</code> the program should resume execution once <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB2" id="P7000497027000000000000000040AB2">Q</code> returns. We consider the return address to be part of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB3" id="P7000497027000000000000000040AB3">P</code>'s stack frame, since it holds state relevant to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB4" id="P7000497027000000000000000040AB4">P</code>. The code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB5" id="P7000497027000000000000000040AB5">Q</code> allocates the space required for its stack frame by extending the current stack boundary. Within that space, it can save the values of registers, allocate <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002858" epub:type="pagebreak" id="P7000497027000000000000000002858" title="241"></span>space for local variables, and set up arguments for the procedures it calls. The stack frames for most procedures are of fixed size, allocated at the beginning of the procedure. Some procedures, however, require variable-size frames. This issue is discussed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002E6D.xhtml#P700049702700000000000000000300F"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10.5</span></a>. Procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB6" id="P7000497027000000000000000040AB6">P</code> can pass up to six integral values (i.e., pointers and integers) on the stack, but if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB7" id="P7000497027000000000000000040AB7">Q</code> requires more arguments, these can be stored by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB8" id="P7000497027000000000000000040AB8">P</code> within its stack frame prior to the call.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AB9" id="P7000497027000000000000000040AB9">In the interest of space and time efficiency, x86-64 procedures allocate only the portions of stack frames they require. For example, many procedures have six or fewer arguments, and so all of their parameters can be passed in registers. Thus, parts of the stack frame diagrammed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002849"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.25</span></a> may be omitted. Indeed, many functions do not even require as tack frame. This occurs when all of the local variables can be held in registers and the function does not call any other functions (sometimes referred to as a <i class="pcalibre17 pcalibre2 pcalibre1">leaf procedure</i>, in reference to the tree structure of procedure calls). For example, none of the functions we have examined thus far required stack frames.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000285D" id="P700049702700000000000000000285D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ABA" epub:type="title" id="P7000497027000000000000000040ABA"><span class="pcalibre1 pcalibre21 pcalibre2">3.7.2 </span>Control Transfer</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ABB" id="P7000497027000000000000000040ABB">Passing control from function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ABC" id="P7000497027000000000000000040ABC">P</code> to function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ABD" id="P7000497027000000000000000040ABD">Q</code> involves simply setting the program counter (PC) to the starting address of the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ABE" id="P7000497027000000000000000040ABE">Q</code>. However, when it later comes time for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ABF" id="P7000497027000000000000000040ABF">Q</code> to return, the processor must have some record of the code location where it should resume the execution of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AC0" id="P7000497027000000000000000040AC0">P</code>. This information is recorded in x86-64 machines by invoking procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AC1" id="P7000497027000000000000000040AC1">Q</code> with the instruction call <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AC2" id="P7000497027000000000000000040AC2">Q</code>. This instruction pushes an address <var class="pcalibre17 pcalibre2 pcalibre1">A</var> onto the stack and sets the PC to the beginning of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AC3" id="P7000497027000000000000000040AC3">Q</code>. The pushed address <var class="pcalibre17 pcalibre2 pcalibre1">A</var> is referred to as the <i class="pcalibre17 pcalibre2 pcalibre1">return address</i> and is computed as the address of the instruction immediately following the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AC4" id="P7000497027000000000000000040AC4">call</code> instruction. The counterpart instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AC5" id="P7000497027000000000000000040AC5">ret</code> pops an address <var class="pcalibre17 pcalibre2 pcalibre1">A</var> off the stack and sets the PC to <var class="pcalibre17 pcalibre2 pcalibre1">A</var>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AC6" id="P7000497027000000000000000040AC6">The general forms of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AC7" id="P7000497027000000000000000040AC7">call</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AC8" id="P7000497027000000000000000040AC8">ret</code> instructions are described as follows:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040AC9" id="P7000497027000000000000000040AC9">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040ACA" id="P7000497027000000000000000040ACA">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040ACB" id="P7000497027000000000000000040ACB">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040ACC" id="P7000497027000000000000000040ACC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ACD" id="P7000497027000000000000000040ACD">call</code> <i class="pcalibre17 pcalibre2 pcalibre1">Label</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040ACE" id="P7000497027000000000000000040ACE">Procedure call</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040ACF" id="P7000497027000000000000000040ACF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AD0" id="P7000497027000000000000000040AD0">call</code> *<i class="pcalibre17 pcalibre2 pcalibre1">Operand</i></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040AD1" id="P7000497027000000000000000040AD1">Procedure call</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040AD2" id="P7000497027000000000000000040AD2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AD3" id="P7000497027000000000000000040AD3">ret</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040AD4" id="P7000497027000000000000000040AD4">Return from call</td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AD5" id="P7000497027000000000000000040AD5">(These instructions are referred to as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AD6" id="P7000497027000000000000000040AD6">callq</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AD7" id="P7000497027000000000000000040AD7">retq</code> in the disassembly outputs generated by the program <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AD8" id="P7000497027000000000000000040AD8"><span class="pcalibre1 pcalibre29 pcalibre2">objdump</span></code>. The added suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AD9" id="P7000497027000000000000000040AD9">q</code>' simply emphasizes that these are x86-64 versions of call and return instructions, not IA32. In x86-64 assembly code, both versions can be used interchangeably.)</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ADA" id="P7000497027000000000000000040ADA">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ADB" id="P7000497027000000000000000040ADB">call</code> instruction has a target indicating the address of the instruction where the called procedure starts. Like jumps, a call can be either direct or indirect. In assembly code, the target of a direct call is given as a label, while the target of an indirect call is given by `*' followed by an operand specifier using one of the formats described in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001F57"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.3</span></a>.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002880" id="P7000497027000000000000000002880">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002881" epub:type="pagebreak" id="P7000497027000000000000000002881" title="242"></span>
<img alt="A diagram illustrates call and ret functions." class="pcalibre1 pcalibre2 pcalibre130" data-uri="P700049702700000000000000000B6B7" id="P7000497027000000000000000040ADC" src="Images/chapter-03-image-05.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040ADD" id="P7000497027000000000000000040ADD"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040ADE" epub:type="title" id="P7000497027000000000000000040ADE"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.26 </span>Illustration of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ADF" id="P7000497027000000000000000040ADF">call</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AE0" id="P7000497027000000000000000040AE0">ret</code> functions.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040AE1" id="P7000497027000000000000000040AE1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040AE2" id="P7000497027000000000000000040AE2">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AE3" id="P7000497027000000000000000040AE3">call instruction</code> transfers control to the start of a function, while the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AE4" id="P7000497027000000000000000040AE4">ret</code> instruction returns back to the instruction following the call.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P7000497027000000000000000020DC2" id="P7000497027000000000000000020DC2">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AE5" id="P7000497027000000000000000040AE5">A diagram has three cells representing executing call, after call, and after ret, as summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P7000497027000000000000000040AE6" id="P7000497027000000000000000040AE6">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AE7" id="P7000497027000000000000000040AE7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AE8" id="P7000497027000000000000000040AE8">Executing call: at bottom of cell, %rip = 0x400563 and %rsp = 0x7fffffffe840</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AE9" id="P7000497027000000000000000040AE9"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AEA" id="P7000497027000000000000000040AEA">After call: below bottom of cell, at 0x400568, %rip = 0x400540 and %rsp = 0x7fffffffe838</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AEB" id="P7000497027000000000000000040AEB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040AEC" id="P7000497027000000000000000040AEC">After ret: at bottom of cell, %rip = 0x400548 and %rsp = 0x7fffffffe840.</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AED" id="P7000497027000000000000000040AED"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002880"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.26</span></a> illustrates the execution of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AEE" id="P7000497027000000000000000040AEE">call</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AEF" id="P7000497027000000000000000040AEF">ret</code> instructions for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AF0" id="P7000497027000000000000000040AF0">multstore</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AF1" id="P7000497027000000000000000040AF1">main</code> functions introduced in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001E38.xhtml#P7000497027000000000000000001E6C"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.2.2</span></a>. The following are excerpts of the disassembled code for the two functions:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040AF2" id="P7000497027000000000000000040AF2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AF3" id="P7000497027000000000000000040AF3">
	<i class="pcalibre17 pcalibre2 pcalibre1">Beginning of function multstore</i>
1	0000000000400540 &lt;multstore&gt;:
2	400540:	53		push	%rbx
3	400541:	48 89 d3	mov	%rdx,%rbx
	...
	<i class="pcalibre17 pcalibre2 pcalibre1">Return from function multstore</i>
4	40054d:	c3		retq
	...
	<i class="pcalibre17 pcalibre2 pcalibre1">Call to multstore from main</i>
5	400563:	e8 d8 ff ff ff	callq 400540 &lt;multstore&gt;
6	400568:	48 8b 54 24 08	mov 0x8 (%rsp),%rdx
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AF4" id="P7000497027000000000000000040AF4">In this code, we can see that the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AF5" id="P7000497027000000000000000040AF5">call</code> instruction with address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AF6" id="P7000497027000000000000000040AF6">0x400563</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AF7" id="P7000497027000000000000000040AF7">main</code> calls function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AF8" id="P7000497027000000000000000040AF8">multstore</code>. This status is shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002880"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.26(a)</span></a>, with the indicated values for the stack pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AF9" id="P7000497027000000000000000040AF9">%rsp</code> and the program counter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AFA" id="P7000497027000000000000000040AFA">%rip</code>. The effect of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AFB" id="P7000497027000000000000000040AFB">call</code> is to push the return address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AFC" id="P7000497027000000000000000040AFC">0x400568</code> onto the stack and to jump to the first instruction in function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AFD" id="P7000497027000000000000000040AFD">multstore</code>, at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AFE" id="P7000497027000000000000000040AFE">0x0400540</code> (3.26(b)). The execution of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040AFF" id="P7000497027000000000000000040AFF">function</code> multstore continues until it hits the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B00" id="P7000497027000000000000000040B00">ret</code> instruction at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B01" id="P7000497027000000000000000040B01">0x40054d</code>. This instruction pops the value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B02" id="P7000497027000000000000000040B02">0x400568</code> from the stack and jumps to this address, resuming the execution of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B03" id="P7000497027000000000000000040B03">main</code> just after the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B04" id="P7000497027000000000000000040B04">call</code> instruction (3.26(c)).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B05" id="P7000497027000000000000000040B05">As a more detailed example of passing control to and from procedures, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000028B1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.27(a)</span></a> shows the disassembled code for two functions, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B06" id="P7000497027000000000000000040B06">top</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B07" id="P7000497027000000000000000040B07">leaf</code>, as well as the portion of code in function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B08" id="P7000497027000000000000000040B08">main</code> where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B09" id="P7000497027000000000000000040B09">top</code> gets called. Each instruction is identified by labels <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B0A" id="P7000497027000000000000000040B0A">L1–L2</code> (in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B0B" id="P7000497027000000000000000040B0B">leaf</code>), <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B0C" id="P7000497027000000000000000040B0C">T1–T4</code> (in top), and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B0D" id="P7000497027000000000000000040B0D">M1–M2</code> in main. Part (b) of the figure shows a detailed trace of the code execution, in which <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B0E" id="P7000497027000000000000000040B0E">main</code> calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B0F" id="P7000497027000000000000000040B0F">top(100)</code>, causing top to call <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B10" id="P7000497027000000000000000040B10">leaf(95)</code>. Function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B11" id="P7000497027000000000000000040B11">leaf</code> returns 97 to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B12" id="P7000497027000000000000000040B12">top</code>, which</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P70004970270000000000000000028B1" id="P70004970270000000000000000028B1">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B13" id="P7000497027000000000000000040B13"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P70004970270000000000000000028B3" epub:type="pagebreak" id="P70004970270000000000000000028B3" title="243"></span>(a) Disassembled code for demonstrating procedure calls and returns</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040B14" id="P7000497027000000000000000040B14"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B15" id="P7000497027000000000000000040B15">
	<i class="pcalibre17 pcalibre2 pcalibre1">Disassembly of leaf(long y</i>)
	<i class="pcalibre17 pcalibre2 pcalibre1">y in %rdi</i>
1	0000000000400540 &lt;leaf&gt;:
2	400540:	48 8d 47 02	lea	0x2(%rdi),%rax	<i class="pcalibre17 pcalibre2 pcalibre1">L1: z+2</i>
3	400544:	c3		retq			<i class="pcalibre17 pcalibre2 pcalibre1">L2: Return</i>

4	0000000000400545 &lt;top&gt;:
	<i class="pcalibre17 pcalibre2 pcalibre1">Disassembly of top(long x</i>)
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi</i>
5	400545:	48 83 ef 05	 sub	$0x5,%rdi	<i class="pcalibre17 pcalibre2 pcalibre1">T1: x-5</i>
6	400549: e8 f2 ff ff ff	callq   400540 &lt;leaf&gt;	<i class="pcalibre17 pcalibre2 pcalibre1">T2: Call leaf(x-5)</i>
7	40054e: 4801c0		add	%rax,%rax	<i class="pcalibre17 pcalibre2 pcalibre1">T3: Double result</i>
8	400551:c3		retq			<i class="pcalibre17 pcalibre2 pcalibre1">T4: Return</i>
	...
	<i class="pcalibre17 pcalibre2 pcalibre1">Call to top from function main</i>
9	40055b: e8 e5 ff ff ff	callq	400545 &lt;top&gt;	<i class="pcalibre17 pcalibre2 pcalibre1">M1: Call top(100)</i>
10	400560: 4889c2		mov	%rax,%rdx	<i class="pcalibre17 pcalibre2 pcalibre1">M2: Resume</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B16" id="P7000497027000000000000000040B16">(b) Execution trace of example code</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040B17" id="P7000497027000000000000000040B17">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" colspan="3" data-uri="chapter03.xhtml#P7000497027000000000000000040B18" id="P7000497027000000000000000040B18">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" colspan="4" data-uri="chapter03.xhtml#P7000497027000000000000000040B19" id="P7000497027000000000000000040B19">State values (at beginning)</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040B1A" id="P7000497027000000000000000040B1A"></th>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040B1B" id="P7000497027000000000000000040B1B">Label</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040B1C" id="P7000497027000000000000000040B1C">PC</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040B1D" id="P7000497027000000000000000040B1D">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040B1E" id="P7000497027000000000000000040B1E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B1F" id="P7000497027000000000000000040B1F">%rdi</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040B20" id="P7000497027000000000000000040B20"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B21" id="P7000497027000000000000000040B21">%rax</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040B22" id="P7000497027000000000000000040B22"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B23" id="P7000497027000000000000000040B23">%rsp</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040B24" id="P7000497027000000000000000040B24"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B25" id="P7000497027000000000000000040B25">*%rsp</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040B26" id="P7000497027000000000000000040B26">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B27" id="P7000497027000000000000000040B27">M1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B28" id="P7000497027000000000000000040B28"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B29" id="P7000497027000000000000000040B29">0x40055b</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B2A" id="P7000497027000000000000000040B2A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B2B" id="P7000497027000000000000000040B2B">callq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B2C" id="P7000497027000000000000000040B2C">100</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B2D" id="P7000497027000000000000000040B2D">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B2E" id="P7000497027000000000000000040B2E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B2F" id="P7000497027000000000000000040B2F">0x7fffffffe820</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B30" id="P7000497027000000000000000040B30">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B31" id="P7000497027000000000000000040B31">Call <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B32" id="P7000497027000000000000000040B32">top(100)</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B33" id="P7000497027000000000000000040B33">T1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B34" id="P7000497027000000000000000040B34"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B35" id="P7000497027000000000000000040B35">0x400545</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B36" id="P7000497027000000000000000040B36"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B37" id="P7000497027000000000000000040B37">sub</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B38" id="P7000497027000000000000000040B38">100</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B39" id="P7000497027000000000000000040B39">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B3A" id="P7000497027000000000000000040B3A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B3B" id="P7000497027000000000000000040B3B">0x7fffffffe818</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B3C" id="P7000497027000000000000000040B3C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B3D" id="P7000497027000000000000000040B3D">0x400560</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B3E" id="P7000497027000000000000000040B3E">Entry of <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B3F" id="P7000497027000000000000000040B3F">top</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B40" id="P7000497027000000000000000040B40">T2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B41" id="P7000497027000000000000000040B41"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B42" id="P7000497027000000000000000040B42">0x400549</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B43" id="P7000497027000000000000000040B43"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B44" id="P7000497027000000000000000040B44">callq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B45" id="P7000497027000000000000000040B45">95</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B46" id="P7000497027000000000000000040B46">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B47" id="P7000497027000000000000000040B47"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B48" id="P7000497027000000000000000040B48">0x7fffffffe818</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B49" id="P7000497027000000000000000040B49"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B4A" id="P7000497027000000000000000040B4A">0x400560</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B4B" id="P7000497027000000000000000040B4B">Call <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B4C" id="P7000497027000000000000000040B4C">leaf(95)</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B4D" id="P7000497027000000000000000040B4D">L1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B4E" id="P7000497027000000000000000040B4E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B4F" id="P7000497027000000000000000040B4F">0x400540</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B50" id="P7000497027000000000000000040B50"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B51" id="P7000497027000000000000000040B51">lea</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B52" id="P7000497027000000000000000040B52">95</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B53" id="P7000497027000000000000000040B53">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B54" id="P7000497027000000000000000040B54"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B55" id="P7000497027000000000000000040B55">0x7fffffffe810</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B56" id="P7000497027000000000000000040B56"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B57" id="P7000497027000000000000000040B57">0x40054e</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B58" id="P7000497027000000000000000040B58">Entry of <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B59" id="P7000497027000000000000000040B59">leaf</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B5A" id="P7000497027000000000000000040B5A">L2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B5B" id="P7000497027000000000000000040B5B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B5C" id="P7000497027000000000000000040B5C">0x400544</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B5D" id="P7000497027000000000000000040B5D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B5E" id="P7000497027000000000000000040B5E">retq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B5F" id="P7000497027000000000000000040B5F">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B60" id="P7000497027000000000000000040B60">97</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B61" id="P7000497027000000000000000040B61"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B62" id="P7000497027000000000000000040B62">0x7fffffffe810</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B63" id="P7000497027000000000000000040B63"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B64" id="P7000497027000000000000000040B64">0x40054e</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B65" id="P7000497027000000000000000040B65">Return 97 from leaf</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B66" id="P7000497027000000000000000040B66">T3</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B67" id="P7000497027000000000000000040B67"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B68" id="P7000497027000000000000000040B68">0x40054e</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B69" id="P7000497027000000000000000040B69"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B6A" id="P7000497027000000000000000040B6A">add</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B6B" id="P7000497027000000000000000040B6B">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B6C" id="P7000497027000000000000000040B6C">97</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B6D" id="P7000497027000000000000000040B6D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B6E" id="P7000497027000000000000000040B6E">0x7fffffffe818</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B6F" id="P7000497027000000000000000040B6F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B70" id="P7000497027000000000000000040B70">0x400560</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B71" id="P7000497027000000000000000040B71">Resume <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B72" id="P7000497027000000000000000040B72">top</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B73" id="P7000497027000000000000000040B73">T4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B74" id="P7000497027000000000000000040B74"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B75" id="P7000497027000000000000000040B75">0x400551</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B76" id="P7000497027000000000000000040B76"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B77" id="P7000497027000000000000000040B77">retq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B78" id="P7000497027000000000000000040B78">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B79" id="P7000497027000000000000000040B79">194</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B7A" id="P7000497027000000000000000040B7A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B7B" id="P7000497027000000000000000040B7B">0x7fffffffe818</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B7C" id="P7000497027000000000000000040B7C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B7D" id="P7000497027000000000000000040B7D">0x400560</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B7E" id="P7000497027000000000000000040B7E">Return 194 from <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B7F" id="P7000497027000000000000000040B7F">top</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B80" id="P7000497027000000000000000040B80">M2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B81" id="P7000497027000000000000000040B81"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B82" id="P7000497027000000000000000040B82">0x400560</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B83" id="P7000497027000000000000000040B83"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B84" id="P7000497027000000000000000040B84">mov</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B85" id="P7000497027000000000000000040B85">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B86" id="P7000497027000000000000000040B86">194</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B87" id="P7000497027000000000000000040B87"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B88" id="P7000497027000000000000000040B88">0x7fffffffe820</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B89" id="P7000497027000000000000000040B89">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040B8A" id="P7000497027000000000000000040B8A">Resume <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B8B" id="P7000497027000000000000000040B8B">main</code></td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040B8C" id="P7000497027000000000000000040B8C"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040B8D" epub:type="title" id="P7000497027000000000000000040B8D"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.27 </span>Detailed execution of program involving procedure calls and returns.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B8E" id="P7000497027000000000000000040B8E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040B8F" id="P7000497027000000000000000040B8F">Using the stack to store return addresses makes it possible to return to the right point in the procedures.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B90" id="P7000497027000000000000000040B90">then returns 194 to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B91" id="P7000497027000000000000000040B91">main</code>. The first three columns describe the instruction being executed, including the instruction label, the address, and the instruction type. The next four columns show the state of the program <i class="pcalibre17 pcalibre2 pcalibre1">before</i> the instruction is executed, including the contents of registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B92" id="P7000497027000000000000000040B92">%rdi, %rax</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B93" id="P7000497027000000000000000040B93">%rsp</code>, as well as the value at the top of the stack. The contents of this table should be studied carefully, as they <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002934" epub:type="pagebreak" id="P7000497027000000000000000002934" title="244"></span>demonstrate the important role of the run-time stack in managing the storage needed to support procedure calls and returns.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B94" id="P7000497027000000000000000040B94">Instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B95" id="P7000497027000000000000000040B95">L1</code> of leaf sets <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B96" id="P7000497027000000000000000040B96">%rax</code> to 97, the value to be returned. Instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B97" id="P7000497027000000000000000040B97">L2</code> then returns. It pops <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B98" id="P7000497027000000000000000040B98">0x400054e</code> from the stack. In setting the PC to this popped value, control transfers back to instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B99" id="P7000497027000000000000000040B99">T3</code> of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B9A" id="P7000497027000000000000000040B9A">top</code>. The program has successfully completed the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B9B" id="P7000497027000000000000000040B9B">leaf</code> and returned to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B9C" id="P7000497027000000000000000040B9C">top</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B9D" id="P7000497027000000000000000040B9D">Instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B9E" id="P7000497027000000000000000040B9E">T3</code> sets <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040B9F" id="P7000497027000000000000000040B9F">%rax</code> to 194, the value to be returned from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA0" id="P7000497027000000000000000040BA0">top</code>. Instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA1" id="P7000497027000000000000000040BA1">T4</code> then returns. It pops <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA2" id="P7000497027000000000000000040BA2">0x4000560</code> from the stack, thereby setting the PC to instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA3" id="P7000497027000000000000000040BA3">M2</code> of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA4" id="P7000497027000000000000000040BA4">main</code>. The program has successfully completed the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA5" id="P7000497027000000000000000040BA5">top</code> and returned to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA6" id="P7000497027000000000000000040BA6">main</code>. We see that the stack pointer has also been restored to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA7" id="P7000497027000000000000000040BA7">0x7fffffffe820</code>, the value it had before the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA8" id="P7000497027000000000000000040BA8">top</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BA9" id="P7000497027000000000000000040BA9">We can see that this simple mechanism of pushing the return address onto the stack makes it possible for the function to later return to the proper point in the program. The standard call/return mechanism of C (and of most programming languages) conveniently matches the last-in, first-out memory management discipline provided by a stack.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000294B" epub:type="practice" id="P700049702700000000000000000294B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BAA" epub:type="title" id="P7000497027000000000000000040BAA"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.32 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P70004970270000000000000000036ED">339</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040BAB" id="P7000497027000000000000000040BAB">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040BAC" id="P7000497027000000000000000040BAC">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BAD" id="P7000497027000000000000000040BAD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040BAE" id="P7000497027000000000000000040BAE">The disassembled code for two functions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BAF" id="P7000497027000000000000000040BAF">first</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BB0" id="P7000497027000000000000000040BB0">last</code> is shown below, along with the code for a call of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BB1" id="P7000497027000000000000000040BB1">first</code> by function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BB2" id="P7000497027000000000000000040BB2">main</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040BB3" id="P7000497027000000000000000040BB3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BB4" id="P7000497027000000000000000040BB4">
	<i class="pcalibre17 pcalibre2 pcalibre1">Disassembly of last(long u, long v</i>)
	<i class="pcalibre17 pcalibre2 pcalibre1">u in %rdi, v in %rsi</i>
1	0000000000400540 &lt;last&gt;:
2	400540: 48 89 f8		mov		%rdi,%rax		<i class="pcalibre17 pcalibre2 pcalibre1">L1: u</i>
3	400543: 48 0f af c6		imul		%rsi,%rax		<i class="pcalibre17 pcalibre2 pcalibre1">L2: u*v</i>
4	400547: c3			retq					<i class="pcalibre17 pcalibre2 pcalibre1">L3: Return</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">Disassembly of last(long x</i>)
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi</i>
5	0000000000400548 &lt;first&gt;:
6	400548: 48 8d 77 01		lea		0x1(%rdi),%rsi		<i class="pcalibre17 pcalibre2 pcalibre1">F1: x+1</i>
7	40054c: 48 83 ef 01		sub		$0x1,%rdi		<i class="pcalibre17 pcalibre2 pcalibre1">F2: x-1</i>
8	400550: e8 eb ff ff ff		callq		400540 &lt;last&gt;		<i class="pcalibre17 pcalibre2 pcalibre1">F3: Call last(x-1,x+1</i>)
9	400555: f3 c3			repz retq				<i class="pcalibre17 pcalibre2 pcalibre1">F4: Return</i>
	⋮
10	400560: e8 e3 ff ff ff		callq		400548 &lt;first&gt;		<i class="pcalibre17 pcalibre2 pcalibre1">M1: Call first(10</i>)
11	400565: 48 89 c2		mov		%rax,%rdx		<i class="pcalibre17 pcalibre2 pcalibre1">M2: Resume</i>
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040BB5" id="P7000497027000000000000000040BB5">Each of these instructions is given a label, similar to those in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000028B1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.27(a)</span></a>. Starting with the calling of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BB6" id="P7000497027000000000000000040BB6">first(10)</code> by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BB7" id="P7000497027000000000000000040BB7">main</code>, fill in the following table to trace instruction execution through to the point where the program returns back to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BB8" id="P7000497027000000000000000040BB8">main</code>.</p>
<table class="pcalibre1 informaltable pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BB9" id="P7000497027000000000000000040BB9">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" colspan="3" data-uri="chapter03.xhtml#P7000497027000000000000000040BBA" id="P7000497027000000000000000040BBA"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000295D" epub:type="pagebreak" id="P700049702700000000000000000295D" title="245"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" colspan="5" data-uri="chapter03.xhtml#P7000497027000000000000000040BBB" id="P7000497027000000000000000040BBB">State values (at beginning)</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BBC" id="P7000497027000000000000000040BBC"></th>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BBD" id="P7000497027000000000000000040BBD">Label</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BBE" id="P7000497027000000000000000040BBE">PC</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BBF" id="P7000497027000000000000000040BBF">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BC0" id="P7000497027000000000000000040BC0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BC1" id="P7000497027000000000000000040BC1">%rdi</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BC2" id="P7000497027000000000000000040BC2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BC3" id="P7000497027000000000000000040BC3">%rsi</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BC4" id="P7000497027000000000000000040BC4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BC5" id="P7000497027000000000000000040BC5">%rax</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BC6" id="P7000497027000000000000000040BC6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BC7" id="P7000497027000000000000000040BC7">%rsp</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BC8" id="P7000497027000000000000000040BC8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BC9" id="P7000497027000000000000000040BC9">*%rsp</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040BCA" id="P7000497027000000000000000040BCA">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BCB" id="P7000497027000000000000000040BCB">M1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BCC" id="P7000497027000000000000000040BCC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BCD" id="P7000497027000000000000000040BCD">0x400560</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BCE" id="P7000497027000000000000000040BCE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BCF" id="P7000497027000000000000000040BCF">callq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BD0" id="P7000497027000000000000000040BD0">10</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BD1" id="P7000497027000000000000000040BD1">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BD2" id="P7000497027000000000000000040BD2">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BD3" id="P7000497027000000000000000040BD3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BD4" id="P7000497027000000000000000040BD4">0x7fffffffe820</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BD5" id="P7000497027000000000000000040BD5">—</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BD6" id="P7000497027000000000000000040BD6">Call <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040BD7" id="P7000497027000000000000000040BD7">first(10)</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BD8" id="P7000497027000000000000000040BD8">F1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BD9" id="P7000497027000000000000000040BD9">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BDA" id="P7000497027000000000000000040BDA">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BDB" id="P7000497027000000000000000040BDB">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BDC" id="P7000497027000000000000000040BDC">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BDD" id="P7000497027000000000000000040BDD">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BDE" id="P7000497027000000000000000040BDE">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BDF" id="P7000497027000000000000000040BDF">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE0" id="P7000497027000000000000000040BE0">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE1" id="P7000497027000000000000000040BE1">F2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE2" id="P7000497027000000000000000040BE2">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE3" id="P7000497027000000000000000040BE3">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE4" id="P7000497027000000000000000040BE4">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE5" id="P7000497027000000000000000040BE5">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE6" id="P7000497027000000000000000040BE6">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE7" id="P7000497027000000000000000040BE7">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE8" id="P7000497027000000000000000040BE8">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BE9" id="P7000497027000000000000000040BE9">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BEA" id="P7000497027000000000000000040BEA">F3</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BEB" id="P7000497027000000000000000040BEB">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BEC" id="P7000497027000000000000000040BEC">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BED" id="P7000497027000000000000000040BED">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BEE" id="P7000497027000000000000000040BEE">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BEF" id="P7000497027000000000000000040BEF">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF0" id="P7000497027000000000000000040BF0">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF1" id="P7000497027000000000000000040BF1">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF2" id="P7000497027000000000000000040BF2">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF3" id="P7000497027000000000000000040BF3">L1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF4" id="P7000497027000000000000000040BF4">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF5" id="P7000497027000000000000000040BF5">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF6" id="P7000497027000000000000000040BF6">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF7" id="P7000497027000000000000000040BF7">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF8" id="P7000497027000000000000000040BF8">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BF9" id="P7000497027000000000000000040BF9">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BFA" id="P7000497027000000000000000040BFA">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BFB" id="P7000497027000000000000000040BFB">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BFC" id="P7000497027000000000000000040BFC">L2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BFD" id="P7000497027000000000000000040BFD">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BFE" id="P7000497027000000000000000040BFE">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040BFF" id="P7000497027000000000000000040BFF">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C00" id="P7000497027000000000000000040C00">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C01" id="P7000497027000000000000000040C01">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C02" id="P7000497027000000000000000040C02">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C03" id="P7000497027000000000000000040C03">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C04" id="P7000497027000000000000000040C04">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C05" id="P7000497027000000000000000040C05">L3</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C06" id="P7000497027000000000000000040C06">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C07" id="P7000497027000000000000000040C07">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C08" id="P7000497027000000000000000040C08">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C09" id="P7000497027000000000000000040C09">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C0A" id="P7000497027000000000000000040C0A">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C0B" id="P7000497027000000000000000040C0B">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C0C" id="P7000497027000000000000000040C0C">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C0D" id="P7000497027000000000000000040C0D">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C0E" id="P7000497027000000000000000040C0E">F4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C0F" id="P7000497027000000000000000040C0F">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C10" id="P7000497027000000000000000040C10">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C11" id="P7000497027000000000000000040C11">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C12" id="P7000497027000000000000000040C12">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C13" id="P7000497027000000000000000040C13">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C14" id="P7000497027000000000000000040C14">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C15" id="P7000497027000000000000000040C15">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C16" id="P7000497027000000000000000040C16">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C17" id="P7000497027000000000000000040C17">M2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C18" id="P7000497027000000000000000040C18">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C19" id="P7000497027000000000000000040C19">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C1A" id="P7000497027000000000000000040C1A">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C1B" id="P7000497027000000000000000040C1B">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C1C" id="P7000497027000000000000000040C1C">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C1D" id="P7000497027000000000000000040C1D">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C1E" id="P7000497027000000000000000040C1E">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C1F" id="P7000497027000000000000000040C1F">__________</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000029C3" id="P70004970270000000000000000029C3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C20" epub:type="title" id="P7000497027000000000000000040C20"><span class="pcalibre1 pcalibre21 pcalibre2">3.7.3 </span>Data Transfer</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C21" id="P7000497027000000000000000040C21">In addition to passing control to a procedure when called, and then back again when the procedure returns, procedure calls may involve passing data as arguments, and returning from a procedure may also involve returning a value. With x86-64, most of these data passing to and from procedures take place via registers. For example, we have already seen numerous examples of functions where arguments are passed in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C22" id="P7000497027000000000000000040C22">%rdi, %rsi</code>, and others, and where values are returned in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C23" id="P7000497027000000000000000040C23">%rax</code>. When procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C24" id="P7000497027000000000000000040C24">P</code> calls procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C25" id="P7000497027000000000000000040C25">Q</code>, the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C26" id="P7000497027000000000000000040C26">P</code> must first copy the arguments into the proper registers. Similarly, when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C27" id="P7000497027000000000000000040C27">Q</code> returns back to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C28" id="P7000497027000000000000000040C28">P</code>, the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C29" id="P7000497027000000000000000040C29">P</code> can access the returned value in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C2A" id="P7000497027000000000000000040C2A">%rax</code>. In this section, we explore these conventions in greater detail.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C2B" id="P7000497027000000000000000040C2B">With x86-64, up to six integral (i.e., integer and pointer) arguments can be passed via registers. The registers are used in a specified order, with the name used for a register depending on the size of the data type being passed. These are shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000029D0"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.28</span></a>. Arguments are allocated to these registers according to their</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P70004970270000000000000000029D0" id="P70004970270000000000000000029D0">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040C2C" id="P7000497027000000000000000040C2C">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040C2D" id="P7000497027000000000000000040C2D" rowspan="2">Operand size (bits)</th>
<th class="pcalibre1 pcalibre2 calibre5" colspan="6" data-uri="chapter03.xhtml#P7000497027000000000000000040C2E" id="P7000497027000000000000000040C2E">Argument number</th>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040C2F" id="P7000497027000000000000000040C2F">1</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040C30" id="P7000497027000000000000000040C30">2</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040C31" id="P7000497027000000000000000040C31">3</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040C32" id="P7000497027000000000000000040C32">4</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040C33" id="P7000497027000000000000000040C33">5</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040C34" id="P7000497027000000000000000040C34">6</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C35" id="P7000497027000000000000000040C35">64</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C36" id="P7000497027000000000000000040C36"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C37" id="P7000497027000000000000000040C37">%rdi</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C38" id="P7000497027000000000000000040C38"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C39" id="P7000497027000000000000000040C39">%rsi</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C3A" id="P7000497027000000000000000040C3A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C3B" id="P7000497027000000000000000040C3B">%rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C3C" id="P7000497027000000000000000040C3C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C3D" id="P7000497027000000000000000040C3D">%rcx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C3E" id="P7000497027000000000000000040C3E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C3F" id="P7000497027000000000000000040C3F">%r8</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C40" id="P7000497027000000000000000040C40"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C41" id="P7000497027000000000000000040C41">%r9</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C42" id="P7000497027000000000000000040C42">32</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C43" id="P7000497027000000000000000040C43"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C44" id="P7000497027000000000000000040C44">%edi</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C45" id="P7000497027000000000000000040C45"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C46" id="P7000497027000000000000000040C46">%esi</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C47" id="P7000497027000000000000000040C47"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C48" id="P7000497027000000000000000040C48">%edx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C49" id="P7000497027000000000000000040C49"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C4A" id="P7000497027000000000000000040C4A">%ecx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C4B" id="P7000497027000000000000000040C4B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C4C" id="P7000497027000000000000000040C4C">%r8d</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C4D" id="P7000497027000000000000000040C4D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C4E" id="P7000497027000000000000000040C4E">%r9d</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C4F" id="P7000497027000000000000000040C4F">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C50" id="P7000497027000000000000000040C50"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C51" id="P7000497027000000000000000040C51">%di</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C52" id="P7000497027000000000000000040C52"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C53" id="P7000497027000000000000000040C53">%si</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C54" id="P7000497027000000000000000040C54"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C55" id="P7000497027000000000000000040C55">%dx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C56" id="P7000497027000000000000000040C56"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C57" id="P7000497027000000000000000040C57">%cx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C58" id="P7000497027000000000000000040C58"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C59" id="P7000497027000000000000000040C59">%r8w</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C5A" id="P7000497027000000000000000040C5A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C5B" id="P7000497027000000000000000040C5B">%r9w</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C5C" id="P7000497027000000000000000040C5C">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C5D" id="P7000497027000000000000000040C5D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C5E" id="P7000497027000000000000000040C5E">%dil</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C5F" id="P7000497027000000000000000040C5F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C60" id="P7000497027000000000000000040C60">%sil</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C61" id="P7000497027000000000000000040C61"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C62" id="P7000497027000000000000000040C62">%dl</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C63" id="P7000497027000000000000000040C63"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C64" id="P7000497027000000000000000040C64">%cl</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C65" id="P7000497027000000000000000040C65"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C66" id="P7000497027000000000000000040C66">%r8b</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C67" id="P7000497027000000000000000040C67"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C68" id="P7000497027000000000000000040C68">%r9b</code></td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040C69" id="P7000497027000000000000000040C69"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040C6A" epub:type="title" id="P7000497027000000000000000040C6A"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.28 </span>Registers for passing function arguments.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C6B" id="P7000497027000000000000000040C6B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040C6C" id="P7000497027000000000000000040C6C">The registers are used in a specified order and named according to the argument sizes.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C6D" id="P7000497027000000000000000040C6D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002A13" epub:type="pagebreak" id="P7000497027000000000000000002A13" title="246"></span>ordering in the argument list. Arguments smaller than 64 bits can be accessed using the appropriate subsection of the 64-bit register. For example, if the first argument is 32 bits, it can be accessed as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C6E" id="P7000497027000000000000000040C6E">%edi</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C6F" id="P7000497027000000000000000040C6F">When a function has more than six integral arguments, the other ones are passed on the stack. Assume that procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C70" id="P7000497027000000000000000040C70">P</code> calls procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C71" id="P7000497027000000000000000040C71">Q</code> with <var class="pcalibre17 pcalibre2 pcalibre1">n</var> integral arguments, such that <var class="pcalibre17 pcalibre2 pcalibre1">n</var> &gt; 6. Then the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C72" id="P7000497027000000000000000040C72">P</code> must allocate a stack frame with enough storage for arguments 7 through <var class="pcalibre17 pcalibre2 pcalibre1">n</var>, as illustrated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002849"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.25</span></a>. It copies arguments 1–6 into the appropriate registers, and it puts arguments 7 through <var class="pcalibre17 pcalibre2 pcalibre1">n</var> onto the stack, with argument 7 at the top of the stack. When passing parameters on the stack, all data sizes are rounded up to be multiples of eight. With the arguments in place, the program can then execute a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C73" id="P7000497027000000000000000040C73">call</code> instruction to transfer control to procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C74" id="P7000497027000000000000000040C74">Q</code>. Procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C75" id="P7000497027000000000000000040C75">Q</code> can access its arguments via registers and possibly from the stack. If <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C76" id="P7000497027000000000000000040C76">Q</code>, in turn, calls some function that has more than six arguments, it can allocate space within its stack frame for these, as is illustrated by the area labeled "Argument build area" in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002849"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.25</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C77" id="P7000497027000000000000000040C77">As an example of argument passing, consider the C function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C78" id="P7000497027000000000000000040C78">proc</code> shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A38"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.29(a)</span></a>. This function has eight arguments, including integers with different numbers of bytes (8, 4, 2, and 1), as well as different types of pointers, each of which is 8 bytes.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C79" id="P7000497027000000000000000040C79">The assembly code generated for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C7A" id="P7000497027000000000000000040C7A">proc</code> is shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A38"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.29(b)</span></a>. The first six arguments are passed in registers. The last two are passed on the stack, as documented by the diagram of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A44"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.30</span></a>. This diagram shows the state of the stack during the execution of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C7B" id="P7000497027000000000000000040C7B">proc</code>. We can see that the return address was pushed onto the stack as part of the procedure call. The two arguments, therefore, are at positions 8 and 16 relative to the stack pointer. Within the code, we can see that different versions of the <span class="pcalibre1 pcalibre29 pcalibre2">add </span>instruction are used according to the sizes of the operands: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C7C" id="P7000497027000000000000000040C7C">addq</code> for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C7D" id="P7000497027000000000000000040C7D">a1 (long), addl</code> for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C7E" id="P7000497027000000000000000040C7E">a2 (int), addw</code> for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C7F" id="P7000497027000000000000000040C7F">a3 (short)</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C80" id="P7000497027000000000000000040C80">addb</code> for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C81" id="P7000497027000000000000000040C81">a4</code> (char). Observe that the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C82" id="P7000497027000000000000000040C82">movl</code> instruction of line 6 reads 4 bytes from memory; the following <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C83" id="P7000497027000000000000000040C83">addb</code> instruction only makes use of the low-order byte.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002A2A" epub:type="practice" id="P7000497027000000000000000002A2A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C84" epub:type="title" id="P7000497027000000000000000040C84"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.33 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P70004970270000000000000000036ED">339</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040C85" id="P7000497027000000000000000040C85">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040C86" id="P7000497027000000000000000040C86">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040C87" id="P7000497027000000000000000040C87"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040C88" id="P7000497027000000000000000040C88">A C function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C89" id="P7000497027000000000000000040C89">pro cprob</code> has four arguments <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C8A" id="P7000497027000000000000000040C8A">u, a, v</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C8B" id="P7000497027000000000000000040C8B">b</code>. Each is either a signed number or a pointer to a signed number, where the numbers have different sizes. The function has the following body:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040C8C" id="P7000497027000000000000000040C8C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C8D" id="P7000497027000000000000000040C8D">
*u += a;
*v += b;
return sizeof(a) + sizeof(b);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040C8E" id="P7000497027000000000000000040C8E">It compiles to the following x86-64 code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040C8F" id="P7000497027000000000000000040C8F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C90" id="P7000497027000000000000000040C90">
1	procprob:
2	movslq %edi, %rdi
3	addq %rdi, (%rdx)
4	addb %sil, (%rcx)
</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002A38" id="P7000497027000000000000000002A38">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040C91" id="P7000497027000000000000000040C91"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002A3A" epub:type="pagebreak" id="P7000497027000000000000000002A3A" title="247"></span>(a) C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040C92" id="P7000497027000000000000000040C92"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C93" id="P7000497027000000000000000040C93">
void proc(long a1, long *a1p,
	  int a2, int *a2p,
	  short a3, short *a3p,
	  char a4, char *a4p)
{
	*a1p += a1;
	*a2p += a2;
	*a3p += a3;
	*a4p += a4;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040C94" id="P7000497027000000000000000040C94">(b) Generated assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040C95" id="P7000497027000000000000000040C95"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C96" id="P7000497027000000000000000040C96">
	<i class="pcalibre17 pcalibre2 pcalibre1">void proc(a1, a1p, a2, a2p, a3, a3p, a4, a4p</i>)
	<i class="pcalibre17 pcalibre2 pcalibre1">Arguments passed as follows:</i>
	  a1 in %rdi (64 bits)
	  a1p in %rsi (64 bits)
	  a2 in %edx (32 bits)
	  a2p in %rcx (64 bits)
	  a3 in %r8w (16 bits)
	  a3p in %r9 (64 bits)
	  a4 at %rsp+8 ( 8 bits)
	  a4p at %rsp+16 (64 bits)
1	proc:
2	movq	16(%rsp), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Fetch a4p (64 bits</i>)
3	addq	%rdi, (%rsi)	<i class="pcalibre17 pcalibre2 pcalibre1">*a1p += a1 (64 bits</i>)
4	addl	%edx, (%rcx)	<i class="pcalibre17 pcalibre2 pcalibre1">*a2p += a2 (32 bits</i>)
5	addw	%r8w, (%r9)	<i class="pcalibre17 pcalibre2 pcalibre1">*a3p += a3 (16 bits</i>)
6	movl	8(%rsp), %edx	<i class="pcalibre17 pcalibre2 pcalibre1">Fetch a4 (8 bits</i>)
7	addb	%dl, (%rax)	<i class="pcalibre17 pcalibre2 pcalibre1">*a4p += a4 (8 bits</i>)
8	ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040C97" id="P7000497027000000000000000040C97"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040C98" epub:type="title" id="P7000497027000000000000000040C98"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.29 </span>Example of function with multiple arguments of different types.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C99" id="P7000497027000000000000000040C99"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040C9A" id="P7000497027000000000000000040C9A">Arguments 1–6 are passed in registers, while arguments 7–8 are passed on the stack.</p></div></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002A44" id="P7000497027000000000000000002A44">
<img alt="A diagram of a stack frame structure has three sections: 16 containing a4p on top; 8 containing a small section with a4 in the center; and 0 (stack pointer %rsp) containing Return address on bottom." class="calibre23 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B6B8" id="P7000497027000000000000000040C9B" src="Images/chapter-03-image-06.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040C9C" id="P7000497027000000000000000040C9C"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040C9D" epub:type="title" id="P7000497027000000000000000040C9D"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.30 </span>Stack frame structure for function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C9E" id="P7000497027000000000000000040C9E">proc</code>.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040C9F" id="P7000497027000000000000000040C9F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040CA0" id="P7000497027000000000000000040CA0">Arguments <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CA1" id="P7000497027000000000000000040CA1">a</code>4 and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CA2" id="P7000497027000000000000000040CA2">a4p</code> are passed on the stack.</p></div></figcaption>
</figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CA3" id="P7000497027000000000000000040CA3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CA4" id="P7000497027000000000000000040CA4">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002A4F" epub:type="pagebreak" id="P7000497027000000000000000002A4F" title="248"></span>5 movl $6, %eax
6 ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040CA5" id="P7000497027000000000000000040CA5">Determine a valid ordering and types of the four parameters. There are two correct answers.</p>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002A51" id="P7000497027000000000000000002A51"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CA6" epub:type="title" id="P7000497027000000000000000040CA6"><span class="pcalibre1 pcalibre21 pcalibre2">3.7.4 </span>Local Storage on the Stack</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CA7" id="P7000497027000000000000000040CA7">Most of the procedure examples we have seen so far did not require any local storage beyond what could be held in registers. At times, however, local data must be stored in memory. Common cases of this include these:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CA8" id="P7000497027000000000000000040CA8">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CA9" id="P7000497027000000000000000040CA9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040CAA" id="P7000497027000000000000000040CAA">There are not enough registers to hold all of the local data.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CAB" id="P7000497027000000000000000040CAB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040CAC" id="P7000497027000000000000000040CAC">The address operator `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CAD" id="P7000497027000000000000000040CAD">&amp;</code>' is applied to a local variable, and hence we must be able to generate an address for it.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CAE" id="P7000497027000000000000000040CAE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040CAF" id="P7000497027000000000000000040CAF">Some of the local variables are arrays or structures and hence must be accessed by array or structure references. We will discuss this possibility when we describe how arrays and structures are allocated.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB0" id="P7000497027000000000000000040CB0">Typically, a procedure allocates space on the stack frame by decrementing the stack pointer. This results in the portion of the stack frame labeled "Local variables" in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002849"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.25</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB1" id="P7000497027000000000000000040CB1">As an example of the handling of the address operator, consider the two functions shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A74"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.31(a)</span></a>. The function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB2" id="P7000497027000000000000000040CB2">swap_add</code> swaps the two values designated by pointers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB3" id="P7000497027000000000000000040CB3">xp</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB4" id="P7000497027000000000000000040CB4">yp</code> and also returns the sum of the two values. The function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB5" id="P7000497027000000000000000040CB5">caller</code> creates pointers to local variables <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB6" id="P7000497027000000000000000040CB6">arg1</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB7" id="P7000497027000000000000000040CB7">arg2</code> and passes these to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB8" id="P7000497027000000000000000040CB8">swap_add</code>. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A74"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.31(b)</span></a> shows how <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CB9" id="P7000497027000000000000000040CB9">caller</code> uses a stack frame to implement these local variables. The code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CBA" id="P7000497027000000000000000040CBA">caller</code> starts by decrementing the stack pointer by 16; this effectively allocates 16 bytes on the stack. Letting <var class="pcalibre17 pcalibre2 pcalibre1">S</var> denote the value of the stack pointer, we can see that the code computes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CBB" id="P7000497027000000000000000040CBB">&amp;arg2</code> as <var class="pcalibre17 pcalibre2 pcalibre1">S</var> + 8 (line 5), <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CBC" id="P7000497027000000000000000040CBC">&amp;arg1</code> as <var class="pcalibre17 pcalibre2 pcalibre1">S</var> (line 6). We can therefore infer that local variables <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CBD" id="P7000497027000000000000000040CBD">arg1</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CBE" id="P7000497027000000000000000040CBE">arg2</code> are stored within the stack frame at offsets 0 and 8 relative to the stack pointer. When the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CBF" id="P7000497027000000000000000040CBF">swap_add</code> completes, the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CC0" id="P7000497027000000000000000040CC0">caller</code> then retrieves the two values from the stack (lines 8–9), computes their difference, and multiplies this by the value returned by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CC1" id="P7000497027000000000000000040CC1">swap_add</code> in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CC2" id="P7000497027000000000000000040CC2">%rax</code> (line 10). Finally, the function deallocates its stack frame by incrementing the stack pointer by 16 (line 11.) We can see with this example that the run-time stack provides a simple mechanism for allocating local storage when it is required and deallocating it when the function completes.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CC3" id="P7000497027000000000000000040CC3">As a more complex example, the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CC4" id="P7000497027000000000000000040CC4">call_proc</code>, shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A89"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.32</span></a>, illustrates many aspects of the x86-64 stack discipline. Despite the length of this example, it is worth studying carefully. It shows a function that must allocate storage on the stack for local variables, as well as to pass values to the 8-argument function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CC5" id="P7000497027000000000000000040CC5">proc</code> (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A38"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.29</span></a>). The function creates a stack frame, diagrammed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A96"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.33</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CC6" id="P7000497027000000000000000040CC6">Looking at the assembly code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CC7" id="P7000497027000000000000000040CC7">call_proc</code> (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A89"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.32(b)</span></a>), we can see that a large portion of the code (lines 2–15) involves preparing to call function</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002A74" id="P7000497027000000000000000002A74">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CC8" id="P7000497027000000000000000040CC8"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002A76" epub:type="pagebreak" id="P7000497027000000000000000002A76" title="249"></span>(a) Code for swap_add and calling function</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CC9" id="P7000497027000000000000000040CC9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CCA" id="P7000497027000000000000000040CCA">
long swap_add(long *xp, long *yp)
{
	long x = *xp;
	long y = *yp;
	*xp = y;
	*yp = x;
	return x + y;
}
long caller()
{
	long arg1 = 534;
	long arg2 = 1057;
	long sum = swap_add(&amp;arg1, &amp;arg2);
	long diff = arg1 - arg2;
	return sum * diff;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CCB" id="P7000497027000000000000000040CCB">(b) Generated assembly code for calling function</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CCC" id="P7000497027000000000000000040CCC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CCD" id="P7000497027000000000000000040CCD">
	<i class="pcalibre17 pcalibre2 pcalibre1">long caller()</i>
1	caller:
2	subq	$16, %rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Allocate 16 bytes for stack frame</i>
3	movq	$534, (%rsp)	<i class="pcalibre17 pcalibre2 pcalibre1">Store 534 in arg1</i>
4	movq	$1057, 8(%rsp)	<i class="pcalibre17 pcalibre2 pcalibre1">Store 1057 in arg2</i>
5	leaq	8(%rsp), %rsi	<i class="pcalibre17 pcalibre2 pcalibre1">Compute &amp;arg2 as second argument</i>
6	movq	%rsp, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Compute &amp;arg1 as first argument</i>
7	call	swap_add	<i class="pcalibre17 pcalibre2 pcalibre1">Call swap_add(&amp;arg1, &amp;arg2</i>)
8	movq	(%rsp), %rdx	<i class="pcalibre17 pcalibre2 pcalibre1">Get arg1</i>
9	subq	8(%rsp), %rdx	<i class="pcalibre17 pcalibre2 pcalibre1">Compute diff = arg1 - arg2</i>
10	imulq	%rdx, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Compute sum * diff</i>
11	addq	$16, %rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Deallocate stack frame</i>
12	ret <i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040CCE" id="P7000497027000000000000000040CCE"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040CCF" epub:type="title" id="P7000497027000000000000000040CCF"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.31 </span>Example of procedure definition and call.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CD0" id="P7000497027000000000000000040CD0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040CD1" id="P7000497027000000000000000040CD1">The calling code must allocate a stack frame due to the presence of address operators.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CD2" id="P7000497027000000000000000040CD2"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CD3" id="P7000497027000000000000000040CD3">proc</code>. This includes setting up the stack frame for the local variables and function parameters, and for loading function arguments into registers. As <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A96"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.33</span></a> shows, local variables <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CD4" id="P7000497027000000000000000040CD4">x1–x4</code> are allocated on the stack and have different sizes. Expressing their locations as offsets relative to the stack pointer, they occupy bytes 24–31 (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CD5" id="P7000497027000000000000000040CD5">x1</code>), 20–23 (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CD6" id="P7000497027000000000000000040CD6">x2</code>), 18–19 (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CD7" id="P7000497027000000000000000040CD7">x3</code>), and 17 (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CD8" id="P7000497027000000000000000040CD8">s3</code>). Pointers to these locations are generated by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CD9" id="P7000497027000000000000000040CD9">leaq</code> instructions (lines 7, 10, 12, and 14). Arguments 7 (with value 4) and 8 (a pointer to the location of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CDA" id="P7000497027000000000000000040CDA">x4</code>) are stored on the stack at offsets 0 and 8 relative to the stack pointer.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002A89" id="P7000497027000000000000000002A89">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CDB" id="P7000497027000000000000000040CDB"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002A8B" epub:type="pagebreak" id="P7000497027000000000000000002A8B" title="250"></span>(a) C code for calling function</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CDC" id="P7000497027000000000000000040CDC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CDD" id="P7000497027000000000000000040CDD">
long call_proc()
{
	long x1 = 1; int x2 = 2;
	short x3 = 3; char x4 = 4;
	proc(x1, &amp;x1, x2, &amp;x2, x3, &amp;x3, x4, &amp;x4);
	return (x1+x2)*(x3-x4);
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CDE" id="P7000497027000000000000000040CDE">(b) Generated assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CDF" id="P7000497027000000000000000040CDF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CE0" id="P7000497027000000000000000040CE0">
	<i class="pcalibre17 pcalibre2 pcalibre1">long call_proc()</i>
1	call_proc:
	<i class="pcalibre17 pcalibre2 pcalibre1">Set up arguments to proc</i>
2	subq	$32, %rsp		<i class="pcalibre17 pcalibre2 pcalibre1">Allocate 32-byte stack frame</i>
3	movq	$1, 24(%rsp)		<i class="pcalibre17 pcalibre2 pcalibre1">Store 1 in &amp;x1</i>
4	movl	$2, 20(%rsp)		<i class="pcalibre17 pcalibre2 pcalibre1">Store 2 in &amp;x2</i>
5	movw	$3, 18(%rsp)		<i class="pcalibre17 pcalibre2 pcalibre1">Store 3 in &amp;x3</i>
6	movb	$4, 17(%rsp)		<i class="pcalibre17 pcalibre2 pcalibre1">Store 4 in &amp;x4</i>
7	leaq	17(%rsp), %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Create &amp;x4</i>
8	movq	%rax, 8(%rsp)		<i class="pcalibre17 pcalibre2 pcalibre1">Store &amp;x4 as argument 8</i>
9	movl	$4, (%rsp)		<i class="pcalibre17 pcalibre2 pcalibre1">Store 4 as argument 7</i>
10	leaq	18(%rsp), %r9		<i class="pcalibre17 pcalibre2 pcalibre1">Pass &amp;x3 as argument 6</i>
11	movl	$3, %r8d		<i class="pcalibre17 pcalibre2 pcalibre1">Pass 3 as argument 5</i>
12	leaq	20(%rsp), %rcx		<i class="pcalibre17 pcalibre2 pcalibre1">Pass &amp;x2 as argument 4</i>
13	movl	$2, %edx		<i class="pcalibre17 pcalibre2 pcalibre1">Pass 2 as argument 3</i>
14	leaq	24(%rsp), %rsi		<i class="pcalibre17 pcalibre2 pcalibre1">Pass &amp;x1 as argument 2</i>
15	movl	$1, %edi		<i class="pcalibre17 pcalibre2 pcalibre1">Pass 1 as argument 1</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">Call proc</i>
16	call proc
	<i class="pcalibre17 pcalibre2 pcalibre1">Retrieve changes to memory</i>
17	movslq	 20(%rsp), %rdx		<i class="pcalibre17 pcalibre2 pcalibre1">Get x2 and convert to long</i>
18	addq	24(%rsp), %rdx		<i class="pcalibre17 pcalibre2 pcalibre1">Compute x1+x2</i>
19	movswl	18(%rsp), %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Get x3 and convert to int</i>
20	movsbl	17(%rsp), %ecx		<i class="pcalibre17 pcalibre2 pcalibre1">Get x4 and convert to int</i>
21	subl	%ecx, %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Compute x3-x4</i>
22	cltq				<i class="pcalibre17 pcalibre2 pcalibre1">Convert to long</i>
23	imulq	%rdx, %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Compute (x1+x2) * (x3-x4</i>)
24	addq	$32, %rsp		<i class="pcalibre17 pcalibre2 pcalibre1">Deallocate stack frame</i>
25	ret				<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040CE1" id="P7000497027000000000000000040CE1"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040CE2" epub:type="title" id="P7000497027000000000000000040CE2"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.32 </span>Example of code to call function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CE3" id="P7000497027000000000000000040CE3">proc</code>, defined in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A38"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.29</span></a>.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CE4" id="P7000497027000000000000000040CE4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040CE5" id="P7000497027000000000000000040CE5">This code creates a stack frame.</p></div></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002A96" id="P7000497027000000000000000002A96">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002A97" epub:type="pagebreak" id="P7000497027000000000000000002A97" title="251"></span>
<img alt="A diagram illustrates stack frame for a function." class="pcalibre1 pcalibre2 calibre24" data-uri="P700049702700000000000000000B6BA" id="P7000497027000000000000000040CE6" src="Images/chapter-03-image-07.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040CE7" id="P7000497027000000000000000040CE7"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040CE8" epub:type="title" id="P7000497027000000000000000040CE8"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.33 </span>Stack frame for function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CE9" id="P7000497027000000000000000040CE9">call_proc</code>.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040CEA" id="P7000497027000000000000000040CEA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040CEB" id="P7000497027000000000000000040CEB">The stack frame contains local variables, as well as two of the arguments to pass to function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CEC" id="P7000497027000000000000000040CEC">proc</code>.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P7000497027000000000000000020FC7" id="P7000497027000000000000000020FC7">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CED" id="P7000497027000000000000000040CED">A diagram illustrates a stack frame divided into five sections, from top to bottom:</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P7000497027000000000000000040CEE" id="P7000497027000000000000000040CEE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CEF" id="P7000497027000000000000000040CEF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040CF0" id="P7000497027000000000000000040CF0">32: Return address</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CF1" id="P7000497027000000000000000040CF1"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040CF2" id="P7000497027000000000000000040CF2">24: x1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CF3" id="P7000497027000000000000000040CF3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040CF4" id="P7000497027000000000000000040CF4">Four sections: 16, 17 containing x4, 18 containing x3, 20 containing x2</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CF5" id="P7000497027000000000000000040CF5"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040CF6" id="P7000497027000000000000000040CF6">8: Argument 8 = &amp;x4</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040CF7" id="P7000497027000000000000000040CF7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040CF8" id="P7000497027000000000000000040CF8">0 (stack pointer %rsp): Argument 7 = 4</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CF9" id="P7000497027000000000000000040CF9">When procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CFA" id="P7000497027000000000000000040CFA">proc</code> is called, the program will begin executing the code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A38"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.29(b)</span></a>. As shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002A44"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.30</span></a>, arguments 7 and 8 are now at offsets 8 and 16 relative to the stack pointer, because the return address was pushed onto the stack.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CFB" id="P7000497027000000000000000040CFB">When the program returns to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CFC" id="P7000497027000000000000000040CFC">call_proc</code>, the code retrieves the values of the four local variables (lines 17–20) and performs the final computations. It finishes by incrementing the stack pointer by 32 to deallocate the stack frame.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002AA3" id="P7000497027000000000000000002AA3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CFD" epub:type="title" id="P7000497027000000000000000040CFD"><span class="pcalibre1 pcalibre21 pcalibre2">3.7.5 </span>Local Storage in Registers</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CFE" id="P7000497027000000000000000040CFE">The set of program registers acts as a single resource shared by all of the procedures. Although only one procedure can be active at a given time, we must make sure that when one procedure (the <i class="pcalibre17 pcalibre2 pcalibre1">caller</i>) calls another (the <i class="pcalibre17 pcalibre2 pcalibre1">callee</i>), the callee does not overwrite some register value that the caller planned to use later. For this reason, x86-64 adopts a uniform set of conventions for register usage that must be respected by all procedures, including those in program libraries.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040CFF" id="P7000497027000000000000000040CFF">By convention, registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D00" id="P7000497027000000000000000040D00">%rbx, %rbp</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D01" id="P7000497027000000000000000040D01">%r12–%r15</code> are classified as <i class="pcalibre17 pcalibre2 pcalibre1">callee-saved</i> registers. When procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D02" id="P7000497027000000000000000040D02">P</code> calls procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D03" id="P7000497027000000000000000040D03">Q</code>, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D04" id="P7000497027000000000000000040D04">Q</code> must <i class="pcalibre17 pcalibre2 pcalibre1">preserve</i> the values of these registers, ensuring that they have the same values when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D05" id="P7000497027000000000000000040D05">Q</code> returns to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D06" id="P7000497027000000000000000040D06">P</code> as they did when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D07" id="P7000497027000000000000000040D07">Q</code> was called. Procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D08" id="P7000497027000000000000000040D08">Q</code> can preserve a register value by either not changing it at all or by pushing the original value on the stack, altering it, and then popping the old value from the stack before returning. The pushing of register values has the effect of creating the portion of the stack frame labeled "Saved registers" in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002849"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.25</span></a>. With this convention, the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D09" id="P7000497027000000000000000040D09">P</code> can safely store a value in a callee-saved register (after saving the previous value on the stack, of course), call <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D0A" id="P7000497027000000000000000040D0A">Q</code>, and then use the value in the register without risk of it having been corrupted.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D0B" id="P7000497027000000000000000040D0B">All other registers, except for the stack pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D0C" id="P7000497027000000000000000040D0C">%rsp</code>, are classified as <i class="pcalibre17 pcalibre2 pcalibre1">caller-saved</i> registers. This means that they can be modified by any function. The name "caller saved" can be understood in the context of a procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D0D" id="P7000497027000000000000000040D0D">P</code> having some local data in such a register and calling procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D0E" id="P7000497027000000000000000040D0E">Q</code>. Since <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D0F" id="P7000497027000000000000000040D0F">Q</code> is free to alter this register, it is incumbent upon <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D10" id="P7000497027000000000000000040D10">P</code> (the caller) to first save the data before it makes the call.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D11" id="P7000497027000000000000000040D11">As an example, consider the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D12" id="P7000497027000000000000000040D12">P</code> shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002ABE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.34(a)</span></a>. It calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D13" id="P7000497027000000000000000040D13">Q</code> twice. During the first call, it must retain the value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D14" id="P7000497027000000000000000040D14">x</code> for use later. Similarly, during the second call, it must retain the value computed for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D15" id="P7000497027000000000000000040D15">Q</code>(<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D16" id="P7000497027000000000000000040D16">y</code>). In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002ABE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.34(b)</span></a>,</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002ABE" id="P7000497027000000000000000002ABE">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D17" id="P7000497027000000000000000040D17"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002AC0" epub:type="pagebreak" id="P7000497027000000000000000002AC0" title="252"></span>(a) Calling function</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D18" id="P7000497027000000000000000040D18"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D19" id="P7000497027000000000000000040D19">
long P(long x, long y)
{
	long u = Q(y);
	long v = Q(x);
	return u + v;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D1A" id="P7000497027000000000000000040D1A">(b) Generated assembly code for the calling function</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D1B" id="P7000497027000000000000000040D1B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D1C" id="P7000497027000000000000000040D1C">
	<i class="pcalibre17 pcalibre2 pcalibre1">long P(long x, long y</i>)
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi</i>
1	P:
2	pushq	%rbp		<i class="pcalibre17 pcalibre2 pcalibre1">Save %rbp</i>
3	pushq	%rbx		<i class="pcalibre17 pcalibre2 pcalibre1">Save %rbx</i>
4	subq	$8, %rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Align stack frame</i>
5	movq	%rdi, %rbp	<i class="pcalibre17 pcalibre2 pcalibre1">Save x</i>
6	movq	%rsi, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Move y to first argument</i>
7	call	Q		<i class="pcalibre17 pcalibre2 pcalibre1">Call Q(y</i>)
8	movq	%rax, %rbx	<i class="pcalibre17 pcalibre2 pcalibre1">Save result</i>
9	movq	%rbp, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Move x to first argument</i>
10	call	Q		<i class="pcalibre17 pcalibre2 pcalibre1">Call Q(x</i>)
11	addq	%rbx, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Add saved Q(y) to Q(x</i>)
12	addq	$8, %rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Deallocate last part of stack</i>
13	popq	%rbx		<i class="pcalibre17 pcalibre2 pcalibre1">Restore %rbx</i>
14	popq	%rbp		<i class="pcalibre17 pcalibre2 pcalibre1">Restore %rbp</i>
15	ret
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040D1D" id="P7000497027000000000000000040D1D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040D1E" epub:type="title" id="P7000497027000000000000000040D1E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.34 </span>Code demonstrating use of callee-saved registers.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D1F" id="P7000497027000000000000000040D1F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D20" id="P7000497027000000000000000040D20">Value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D21" id="P7000497027000000000000000040D21">x</code> must be preserved during the first call, and value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D22" id="P7000497027000000000000000040D22">Q</code>(<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D23" id="P7000497027000000000000000040D23">y</code>) must be preserved during the second.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D24" id="P7000497027000000000000000040D24">we can see that the code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>uses two callee-saved registers: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D25" id="P7000497027000000000000000040D25">%rbp</code> to hold <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D26" id="P7000497027000000000000000040D26">x</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D27" id="P7000497027000000000000000040D27">%rbx</code> to hold the computed value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D28" id="P7000497027000000000000000040D28">Q</code>(<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D29" id="P7000497027000000000000000040D29">y</code>). At the beginning of the function, it saves the values of these two registers on the stack (lines 2–3). It copies argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D2A" id="P7000497027000000000000000040D2A">x</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D2B" id="P7000497027000000000000000040D2B">%rbp</code> before the first call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D2C" id="P7000497027000000000000000040D2C">Q</code> (line 5). It copies the result of this call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D2D" id="P7000497027000000000000000040D2D">%rbx</code> before the second call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D2E" id="P7000497027000000000000000040D2E">Q</code> (line 8). At the end of the function (lines 13–14), it restores the values of the two callee-saved registers by popping them off the stack. Note how they are popped in the reverse order from how they were pushed, to account for the last-in, first-out discipline of a stack.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002AD8" epub:type="practice" id="P7000497027000000000000000002AD8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D2F" epub:type="title" id="P7000497027000000000000000040D2F"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.34 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003782">340</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040D30" id="P7000497027000000000000000040D30">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040D31" id="P7000497027000000000000000040D31">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D32" id="P7000497027000000000000000040D32"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D33" id="P7000497027000000000000000040D33">Consider a function P, which generates local values, named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D34" id="P7000497027000000000000000040D34">a0–a8</code>. It then calls function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D35" id="P7000497027000000000000000040D35">Q</code> using these generated values as arguments. G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>produces the following code for the first part of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D36" id="P7000497027000000000000000040D36">P</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D37" id="P7000497027000000000000000040D37"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D38" id="P7000497027000000000000000040D38">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002AE3" epub:type="pagebreak" id="P7000497027000000000000000002AE3" title="253"></span>	<i class="pcalibre17 pcalibre2 pcalibre1">long P(long x)
	x in %rdi</i>
1	P:
2	pushq	%r15
3	pushq	%r14
4	pushq	%r13
5	pushq	%r12
6	pushq	%rbp
7	pushq	%rbx
8	subq	$24, %rsp
9	movq	%rdi, %rbx
10	leaq	1(%rdi), %r15
11	leaq	2(%rdi), %r14
12	leaq	3(%rdi), %r13
13	leaq	4(%rdi), %r12
14	leaq	5(%rdi), %rbp
15	leaq	6(%rdi), %rax
16	movq	%rax, (%rsp)
17	leaq	7(%rdi), %rdx
18	movq	%rdx, 8(%rsp)
19	movl	$0, %eax
20	call	Q
	<i class="pcalibre17 pcalibre2 pcalibre1">...</i>
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000040D39" id="P7000497027000000000000000040D39">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D3A" id="P7000497027000000000000000040D3A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D3B" id="P7000497027000000000000000040D3B">Identify which local values get stored in callee-saved registers.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D3C" id="P7000497027000000000000000040D3C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D3D" id="P7000497027000000000000000040D3D">Identify which local values get stored on the stack.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D3E" id="P7000497027000000000000000040D3E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D3F" id="P7000497027000000000000000040D3F">Explain why the program could not store all of the local values in callee-saved registers.</p></li>
</ol>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002AEB" id="P7000497027000000000000000002AEB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D40" epub:type="title" id="P7000497027000000000000000040D40"><span class="pcalibre1 pcalibre21 pcalibre2">3.7.6 </span>Recursive Procedures</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D41" id="P7000497027000000000000000040D41">The conventions we have described for using the registers and the stack allow x86-64 procedures to call themselves recursively. Each procedure call has its own private space on the stack, and so the local variables of the multiple outstanding calls do not interfere with one another. Furthermore, the stack discipline naturally provides the proper policy for allocating local storage when the procedure is called and deallocating it before returning.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D42" id="P7000497027000000000000000040D42"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002AF2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.35</span></a> shows both the C code and the generated assembly code for a recursive factorial function. We can see that the assembly code uses register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D43" id="P7000497027000000000000000040D43">%rbx</code> to hold the parameter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D44" id="P7000497027000000000000000040D44">n</code>, after first saving the existing value on the stack (line 2) and later restoring the value before returning (line 11). Due to the stack discipline, and the register-saving conventions, we can be assured that when the recursive call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D45" id="P7000497027000000000000000040D45">rfact(n-1)</code> returns (line 9) that (1) the result of the call will be held in register</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002AF2" id="P7000497027000000000000000002AF2">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D46" id="P7000497027000000000000000040D46"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002AF4" epub:type="pagebreak" id="P7000497027000000000000000002AF4" title="254"></span>(a) C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D47" id="P7000497027000000000000000040D47"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D48" id="P7000497027000000000000000040D48">
long rfact(long n)
{
	long result;
	if (n &lt;= 1)
	  result = 1;
	else
	  result = n * rfact(n-1);
	return result;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D49" id="P7000497027000000000000000040D49">(b) Generated assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D4A" id="P7000497027000000000000000040D4A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D4B" id="P7000497027000000000000000040D4B">
	<i class="pcalibre17 pcalibre2 pcalibre1">long rfact(long n</i>)
	<i class="pcalibre17 pcalibre2 pcalibre1">n in %rdi</i>
1	rfact:
2	pushq	%rbx		<i class="pcalibre17 pcalibre2 pcalibre1">Save %rbx</i>
3	movq	%rdi, %rbx	<i class="pcalibre17 pcalibre2 pcalibre1">Store n in callee-saved register</i>
4	movl	$1, %eax	<i class="pcalibre17 pcalibre2 pcalibre1">Set return value = 1</i>
5	cmpq	$1, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Compare n:1</i>
6	jle	.L35		<i class="pcalibre17 pcalibre2 pcalibre1">If &lt;=, goto done</i>
7	leaq	-1(%rdi), %rdi <i class="pcalibre17 pcalibre2 pcalibre1">Compute n-1</i>
8	call	rfact		<i class="pcalibre17 pcalibre2 pcalibre1">Call rfact(n-1</i>)
9	imulq	%rbx, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Multiply result by n</i>
10	.L35:		   <b class="pcalibre1 pcalibre2 pcalibre12">done:</b>
11	popq	%rbx		<i class="pcalibre17 pcalibre2 pcalibre1">Restore %rbx</i>
12	ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040D4C" id="P7000497027000000000000000040D4C"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040D4D" epub:type="title" id="P7000497027000000000000000040D4D"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.35 </span>Code for recursive factorial program.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D4E" id="P7000497027000000000000000040D4E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D4F" id="P7000497027000000000000000040D4F">The standard procedure handling mechanisms suffice for implementing recursive functions.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D50" id="P7000497027000000000000000040D50"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D51" id="P7000497027000000000000000040D51">%rax</code>, and (2) the value of argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D52" id="P7000497027000000000000000040D52">n</code> will held in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D53" id="P7000497027000000000000000040D53">%rbx</code>. Multiplying these two values then computes the desired result.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D54" id="P7000497027000000000000000040D54">We can see from this example that calling a function recursively proceeds just like any other function call. Our stack discipline provides a mechanism where each invocation of a function has its own private storage for state information (saved values of the return location and callee-saved registers). If need be, it can also provide storage for local variables. The stack discipline of allocation and deallocation naturally matches the call-return ordering of functions. This method of implementing function calls and returns even works for more complex patterns, including mutual recursion (e.g., when procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D55" id="P7000497027000000000000000040D55">P</code> calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D56" id="P7000497027000000000000000040D56">Q</code>, which in turn calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D57" id="P7000497027000000000000000040D57">P</code>).</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002B06" epub:type="practice" id="P7000497027000000000000000002B06"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D58" epub:type="title" id="P7000497027000000000000000040D58"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.35 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003782">340</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040D59" id="P7000497027000000000000000040D59">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040D5A" id="P7000497027000000000000000040D5A">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D5B" id="P7000497027000000000000000040D5B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D5C" id="P7000497027000000000000000040D5C">For a C function having the general structure</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D5D" id="P7000497027000000000000000040D5D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D5E" id="P7000497027000000000000000040D5E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002B0E" epub:type="pagebreak" id="P7000497027000000000000000002B0E" title="255"></span>long rfun(unsigned long x) {
	if(__________)
	  return __________;
	unsigned long nx = __________;
	long rv = rfun(nx);
	return __________;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D5F" id="P7000497027000000000000000040D5F"><span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D60" id="P7000497027000000000000000040D60"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D61" id="P7000497027000000000000000040D61">
	<i class="pcalibre17 pcalibre2 pcalibre1">long rfun(unsigned long x</i>)
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi</i>
1	rfun:
2		pushq	 %rbx
3		movq	%rdi, %rbx
4		movl	$0, %eax
5		testq	%rdi, %rdi
6		je	.L2
7		shrq	$2, %rdi
8		call	rfun
9		addq	%rbx, %rax
10	.L2:
11		popq	%rbx
12		ret
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000040D62" id="P7000497027000000000000000040D62">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D63" id="P7000497027000000000000000040D63"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D64" id="P7000497027000000000000000040D64">What value does <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D65" id="P7000497027000000000000000040D65">rfun</code> store in the callee-saved register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D66" id="P7000497027000000000000000040D66">%rbx</code>?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D67" id="P7000497027000000000000000040D67"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040D68" id="P7000497027000000000000000040D68">Fill in the missing expressions in the C code shown above.</p></li>
</ol></div></li></ol>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.8 Array Allocation and Access</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000002B19"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040D69" epub:type="title" id="P7000497027000000000000000040D69"><span class="pcalibre1 pcalibre21 pcalibre2">3.8 </span>Array Allocation and Access</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D6A" id="P7000497027000000000000000040D6A">Arrays in C are one means of aggregating scalar data into larger data types. C uses a particularly simple implementation of arrays, and hence the translation into machine code is fairly straightforward. One unusual feature of C is that we can generate pointers to elements within arrays and perform arithmetic with these pointers. These are translated into address computations in machine code.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D6B" id="P7000497027000000000000000040D6B">Optimizing compilers are particularly good at simplifying the address computations used by array indexing. This can make the correspondence between the C code and its translation into machine code somewhat difficult to decipher.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002B1D" id="P7000497027000000000000000002B1D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D6C" epub:type="title" id="P7000497027000000000000000040D6C"><span class="pcalibre1 pcalibre21 pcalibre2">3.8.1 </span>Basic Principles</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D6D" id="P7000497027000000000000000040D6D">For data type <var class="pcalibre17 pcalibre2 pcalibre1">T</var> and integer constant <var class="pcalibre17 pcalibre2 pcalibre1">N</var>, consider a declaration of the form</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D6E" id="P7000497027000000000000000040D6E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D6F" id="P7000497027000000000000000040D6F">
<var class="pcalibre17 pcalibre2 pcalibre1">T</var> A[<var class="pcalibre17 pcalibre2 pcalibre1">N</var>]
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D70" id="P7000497027000000000000000040D70"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002B23" epub:type="pagebreak" id="P7000497027000000000000000002B23" title="256"></span>Let us denote the starting location as <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D71" id="P7000497027000000000000000040D71">A</code></sub>. The declaration has two effects. First, it allocates a contiguous region of <var class="pcalibre17 pcalibre2 pcalibre1">L</var> · <var class="pcalibre17 pcalibre2 pcalibre1">N</var> bytes in memory, where <var class="pcalibre17 pcalibre2 pcalibre1">L</var> is the size (in bytes) of data type <var class="pcalibre17 pcalibre2 pcalibre1">T</var>. Second, it introduces an identifier <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D72" id="P7000497027000000000000000040D72">A</code> that can be used as a pointer to the beginning of the array. The value of this pointer will be <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D73" id="P7000497027000000000000000040D73">A</code></sub>. The array elements can be accessed using an integer index ranging between 0 and <var class="pcalibre17 pcalibre2 pcalibre1">N</var>–1. Array element <var class="pcalibre17 pcalibre2 pcalibre1">i</var> will be stored at address <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D74" id="P7000497027000000000000000040D74">A</code></sub> + <var class="pcalibre17 pcalibre2 pcalibre1">L</var> · <var class="pcalibre17 pcalibre2 pcalibre1">i</var>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D75" id="P7000497027000000000000000040D75">As examples, consider the following declarations:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040D76" id="P7000497027000000000000000040D76"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D77" id="P7000497027000000000000000040D77">
char	A[12];
char	*B[8];
int		C[6];
double	*D[5];
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D78" id="P7000497027000000000000000040D78">These declarations will generate arrays with the following parameters:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040D79" id="P7000497027000000000000000040D79">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040D7A" id="P7000497027000000000000000040D7A">Array</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040D7B" id="P7000497027000000000000000040D7B">Element size</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040D7C" id="P7000497027000000000000000040D7C">Total size</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040D7D" id="P7000497027000000000000000040D7D">Start address</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040D7E" id="P7000497027000000000000000040D7E">Element <var class="pcalibre17 pcalibre2 pcalibre1">i</var></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D7F" id="P7000497027000000000000000040D7F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D80" id="P7000497027000000000000000040D80">A</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D81" id="P7000497027000000000000000040D81">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D82" id="P7000497027000000000000000040D82">12</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D83" id="P7000497027000000000000000040D83"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D84" id="P7000497027000000000000000040D84">A</code></sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D85" id="P7000497027000000000000000040D85"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D86" id="P7000497027000000000000000040D86">A</code></sub> + <var class="pcalibre17 pcalibre2 pcalibre1">i</var></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D87" id="P7000497027000000000000000040D87"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D88" id="P7000497027000000000000000040D88">B</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D89" id="P7000497027000000000000000040D89">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D8A" id="P7000497027000000000000000040D8A">64</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D8B" id="P7000497027000000000000000040D8B"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D8C" id="P7000497027000000000000000040D8C">B</code></sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D8D" id="P7000497027000000000000000040D8D"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D8E" id="P7000497027000000000000000040D8E">B</code></sub> + 8<var class="pcalibre17 pcalibre2 pcalibre1">i</var></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D8F" id="P7000497027000000000000000040D8F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D90" id="P7000497027000000000000000040D90">C</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D91" id="P7000497027000000000000000040D91">4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D92" id="P7000497027000000000000000040D92">24</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D93" id="P7000497027000000000000000040D93"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D94" id="P7000497027000000000000000040D94">C</code></sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D95" id="P7000497027000000000000000040D95"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D96" id="P7000497027000000000000000040D96">C</code></sub> + 4<var class="pcalibre17 pcalibre2 pcalibre1">i</var></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D97" id="P7000497027000000000000000040D97"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D98" id="P7000497027000000000000000040D98">D</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D99" id="P7000497027000000000000000040D99">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D9A" id="P7000497027000000000000000040D9A">40</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D9B" id="P7000497027000000000000000040D9B"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D9C" id="P7000497027000000000000000040D9C">D</code></sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040D9D" id="P7000497027000000000000000040D9D"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040D9E" id="P7000497027000000000000000040D9E">D</code></sub> + 8<var class="pcalibre17 pcalibre2 pcalibre1">i</var></td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040D9F" id="P7000497027000000000000000040D9F">Array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA0" id="P7000497027000000000000000040DA0">A</code> consists of 12 single-byte (char) elements. Array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA1" id="P7000497027000000000000000040DA1">C</code> consists of 6 integers, each requiring 4 bytes. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA2" id="P7000497027000000000000000040DA2">B</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA3" id="P7000497027000000000000000040DA3">D</code> are both arrays of pointers, and hence the array elements are 8 bytes each.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA4" id="P7000497027000000000000000040DA4">The memory referencing instructions of x86-64 are designed to simplify array access. For example, suppose <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA5" id="P7000497027000000000000000040DA5">E</code> is an array of values of type int and we wish to evaluate <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA6" id="P7000497027000000000000000040DA6">E[i]</code>, where the address of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA7" id="P7000497027000000000000000040DA7">E</code> is stored in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA8" id="P7000497027000000000000000040DA8">%rdx</code> and <var class="pcalibre17 pcalibre2 pcalibre1">i</var> is stored in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DA9" id="P7000497027000000000000000040DA9">%rcx</code>. Then the instruction</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040DAA" id="P7000497027000000000000000040DAA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DAB" id="P7000497027000000000000000040DAB">
movl (%rdx,%rcx,4),%eax
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DAC" id="P7000497027000000000000000040DAC">will perform the address computation <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040DAD" id="P7000497027000000000000000040DAD">E</code></sub> + 4<var class="pcalibre17 pcalibre2 pcalibre1">i</var>, read that memory location, and copy the result to register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DAE" id="P7000497027000000000000000040DAE">%eax</code>. The allowed scaling factors of 1, 2, 4, and 8 cover the sizes of the common primitive data types.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002B62" epub:type="practice" id="P7000497027000000000000000002B62"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DAF" epub:type="title" id="P7000497027000000000000000040DAF"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.36 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P70004970270000000000000000037B1">341</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040DB0" id="P7000497027000000000000000040DB0">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040DB1" id="P7000497027000000000000000040DB1">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DB2" id="P7000497027000000000000000040DB2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040DB3" id="P7000497027000000000000000040DB3">Consider the following declarations:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040DB4" id="P7000497027000000000000000040DB4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DB5" id="P7000497027000000000000000040DB5">
short	S[7];
short	*T[3];
short	**U[6];
int		V[8];
double	*W[4];
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040DB6" id="P7000497027000000000000000040DB6">Fill in the following table describing the element size, the total size, and the address of element <var class="pcalibre17 pcalibre2 pcalibre1">i</var> for each of these arrays.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040DB7" id="P7000497027000000000000000040DB7">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040DB8" id="P7000497027000000000000000040DB8"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002B6D" epub:type="pagebreak" id="P7000497027000000000000000002B6D" title="257"></span>Array</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040DB9" id="P7000497027000000000000000040DB9">Element size</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040DBA" id="P7000497027000000000000000040DBA">Total size</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040DBB" id="P7000497027000000000000000040DBB">Start address</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040DBC" id="P7000497027000000000000000040DBC">Element <var class="pcalibre17 pcalibre2 pcalibre1">i</var></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DBD" id="P7000497027000000000000000040DBD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DBE" id="P7000497027000000000000000040DBE">S</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DBF" id="P7000497027000000000000000040DBF">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DC0" id="P7000497027000000000000000040DC0">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DC1" id="P7000497027000000000000000040DC1"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040DC2" id="P7000497027000000000000000040DC2">S</code></sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DC3" id="P7000497027000000000000000040DC3">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DC4" id="P7000497027000000000000000040DC4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DC5" id="P7000497027000000000000000040DC5">T</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DC6" id="P7000497027000000000000000040DC6">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DC7" id="P7000497027000000000000000040DC7">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DC8" id="P7000497027000000000000000040DC8"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040DC9" id="P7000497027000000000000000040DC9">T</code></sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DCA" id="P7000497027000000000000000040DCA">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DCB" id="P7000497027000000000000000040DCB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DCC" id="P7000497027000000000000000040DCC">U</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DCD" id="P7000497027000000000000000040DCD">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DCE" id="P7000497027000000000000000040DCE">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DCF" id="P7000497027000000000000000040DCF"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040DD0" id="P7000497027000000000000000040DD0">U</code></sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DD1" id="P7000497027000000000000000040DD1">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DD2" id="P7000497027000000000000000040DD2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DD3" id="P7000497027000000000000000040DD3">V</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DD4" id="P7000497027000000000000000040DD4">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DD5" id="P7000497027000000000000000040DD5">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DD6" id="P7000497027000000000000000040DD6"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040DD7" id="P7000497027000000000000000040DD7">V</code></sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DD8" id="P7000497027000000000000000040DD8">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DD9" id="P7000497027000000000000000040DD9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DDA" id="P7000497027000000000000000040DDA">W</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DDB" id="P7000497027000000000000000040DDB">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DDC" id="P7000497027000000000000000040DDC">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DDD" id="P7000497027000000000000000040DDD"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre97 pcalibre2 pcalibre1"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040DDE" id="P7000497027000000000000000040DDE">W</code></sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DDF" id="P7000497027000000000000000040DDF">__________</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002B95" id="P7000497027000000000000000002B95"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DE0" epub:type="title" id="P7000497027000000000000000040DE0"><span class="pcalibre1 pcalibre21 pcalibre2">3.8.2 </span>Pointer Arithmetic</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DE1" id="P7000497027000000000000000040DE1">C allows arithmetic on pointers, where the computed value is scaled according to the size of the data type referenced by the pointer. That is, if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DE2" id="P7000497027000000000000000040DE2">p</code> is a pointer to data of type <var class="pcalibre17 pcalibre2 pcalibre1">T</var>, and the value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DE3" id="P7000497027000000000000000040DE3">p</code> is <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040DE4" id="P7000497027000000000000000040DE4">p</code></sub>, then the expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DE5" id="P7000497027000000000000000040DE5">p+i</code> has value <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040DE6" id="P7000497027000000000000000040DE6">p</code></sub> + <var class="pcalibre17 pcalibre2 pcalibre1">L</var> · <var class="pcalibre17 pcalibre2 pcalibre1">i</var>, where <var class="pcalibre17 pcalibre2 pcalibre1">L</var> is the size of data type <var class="pcalibre17 pcalibre2 pcalibre1">T</var>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DE7" id="P7000497027000000000000000040DE7">The unary operators `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DE8" id="P7000497027000000000000000040DE8">&amp;</code>' and `*' allow the generation and dereferencing of pointers. That is, for an expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DE9" id="P7000497027000000000000000040DE9"><i class="pcalibre17 pcalibre2 pcalibre1">Expr</i></code> denoting some object, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DEA" id="P7000497027000000000000000040DEA">&amp;<i class="pcalibre17 pcalibre2 pcalibre1">Expr</i></code> is a pointer giving the address of the object. For an expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DEB" id="P7000497027000000000000000040DEB"><i class="pcalibre17 pcalibre2 pcalibre1">AExpr</i></code> denoting an address, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DEC" id="P7000497027000000000000000040DEC">*<i class="pcalibre17 pcalibre2 pcalibre1">AExpr</i></code> gives the value at that address. The expressions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DED" id="P7000497027000000000000000040DED"><i class="pcalibre17 pcalibre2 pcalibre1">Expr</i></code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DEE" id="P7000497027000000000000000040DEE">*&amp;<i class="pcalibre17 pcalibre2 pcalibre1">Expr</i></code> are therefore equivalent. The array subscripting operation can be applied to both arrays and pointers. The array reference <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DEF" id="P7000497027000000000000000040DEF">A[i]</code> is identical to the expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DF0" id="P7000497027000000000000000040DF0">*(A+i)</code>. It computes the address of the <var class="pcalibre17 pcalibre2 pcalibre1">i</var>th array element and then accesses this memory location.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DF1" id="P7000497027000000000000000040DF1">Expanding on our earlier example, suppose the starting address of integer array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DF2" id="P7000497027000000000000000040DF2">E</code> and integer index <var class="pcalibre17 pcalibre2 pcalibre1">i</var> are stored in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DF3" id="P7000497027000000000000000040DF3">%rdx</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DF4" id="P7000497027000000000000000040DF4">%rcx</code>, respectively. The following are some expressions involving <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DF5" id="P7000497027000000000000000040DF5">E</code>. We also show an assembly-code implementation of each expression, with the result being stored in either register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DF6" id="P7000497027000000000000000040DF6">%eax</code> (for data) or register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DF7" id="P7000497027000000000000000040DF7">%rax</code> (for pointers).</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040DF8" id="P7000497027000000000000000040DF8">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040DF9" id="P7000497027000000000000000040DF9">Expression</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040DFA" id="P7000497027000000000000000040DFA">Type</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040DFB" id="P7000497027000000000000000040DFB">Value</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040DFC" id="P7000497027000000000000000040DFC">Assembly code</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DFD" id="P7000497027000000000000000040DFD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040DFE" id="P7000497027000000000000000040DFE">E</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040DFF" id="P7000497027000000000000000040DFF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E00" id="P7000497027000000000000000040E00">int *</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E01" id="P7000497027000000000000000040E01"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E02" id="P7000497027000000000000000040E02"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 pcalibre122">E</sub></code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E03" id="P7000497027000000000000000040E03"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E04" id="P7000497027000000000000000040E04">movl %rdx,%rax</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E05" id="P7000497027000000000000000040E05"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E06" id="P7000497027000000000000000040E06">E[0]</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E07" id="P7000497027000000000000000040E07"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E08" id="P7000497027000000000000000040E08">int</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E09" id="P7000497027000000000000000040E09"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E0A" id="P7000497027000000000000000040E0A">M[<var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 pcalibre122">E</sub>]</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E0B" id="P7000497027000000000000000040E0B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E0C" id="P7000497027000000000000000040E0C">movl (%rdx),%eax</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E0D" id="P7000497027000000000000000040E0D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E0E" id="P7000497027000000000000000040E0E">E[i]</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E0F" id="P7000497027000000000000000040E0F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E10" id="P7000497027000000000000000040E10">int</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E11" id="P7000497027000000000000000040E11"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E12" id="P7000497027000000000000000040E12">M[<var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 pcalibre122">E</sub> + 4<var class="pcalibre17 pcalibre2 pcalibre1">i</var>]</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E13" id="P7000497027000000000000000040E13"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E14" id="P7000497027000000000000000040E14">movl (%rdx,%rcx,4),%eax</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E15" id="P7000497027000000000000000040E15"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E16" id="P7000497027000000000000000040E16">&amp;E[2]</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E17" id="P7000497027000000000000000040E17"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E18" id="P7000497027000000000000000040E18">int *</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E19" id="P7000497027000000000000000040E19"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E1A" id="P7000497027000000000000000040E1A"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 pcalibre122">E</sub> +8</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E1B" id="P7000497027000000000000000040E1B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E1C" id="P7000497027000000000000000040E1C">leaq 8(%rdx),%rax</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E1D" id="P7000497027000000000000000040E1D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E1E" id="P7000497027000000000000000040E1E">E+i–1</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E1F" id="P7000497027000000000000000040E1F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E20" id="P7000497027000000000000000040E20">int *</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E21" id="P7000497027000000000000000040E21"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E22" id="P7000497027000000000000000040E22"><var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 pcalibre122">E</sub> + 4<var class="pcalibre17 pcalibre2 pcalibre1">i</var> – 4</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E23" id="P7000497027000000000000000040E23"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E24" id="P7000497027000000000000000040E24">leaq -4(%rdx,%rcx,4),%rax</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E25" id="P7000497027000000000000000040E25"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E26" id="P7000497027000000000000000040E26">*(E+i–3)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E27" id="P7000497027000000000000000040E27"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E28" id="P7000497027000000000000000040E28">int</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E29" id="P7000497027000000000000000040E29"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E2A" id="P7000497027000000000000000040E2A">M[<var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 pcalibre122">E</sub> + 4<var class="pcalibre17 pcalibre2 pcalibre1">i</var> – 12] <var class="pcalibre17 pcalibre2 pcalibre1">i</var></code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E2B" id="P7000497027000000000000000040E2B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E2C" id="P7000497027000000000000000040E2C">movl –12(%rdx,%rcx,4),%eax</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E2D" id="P7000497027000000000000000040E2D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E2E" id="P7000497027000000000000000040E2E">&amp;E[i]–E</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E2F" id="P7000497027000000000000000040E2F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E30" id="P7000497027000000000000000040E30">long</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E31" id="P7000497027000000000000000040E31"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E32" id="P7000497027000000000000000040E32"><var class="pcalibre17 pcalibre2 pcalibre1">i</var></code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E33" id="P7000497027000000000000000040E33"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E34" id="P7000497027000000000000000040E34">movq %rcx,%rax</code></td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E35" id="P7000497027000000000000000040E35">In these examples, we see that operations that return array values have type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E36" id="P7000497027000000000000000040E36">int</code>, and hence involve 4-byte operations (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E37" id="P7000497027000000000000000040E37">movl</code>) and registers (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E38" id="P7000497027000000000000000040E38">%eax</code>). Those that return pointers have type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E39" id="P7000497027000000000000000040E39">int *</code>, and hence involve 8-byte operations (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E3A" id="P7000497027000000000000000040E3A">leaq</code>) and registers (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E3B" id="P7000497027000000000000000040E3B">%rax</code>). The final example shows that one can compute the difference of two pointers within the same data structure, with the result being data having type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E3C" id="P7000497027000000000000000040E3C">long</code> and value equal to the difference of the two addresses divided by the size of the data type.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002BF3" epub:type="practice" id="P7000497027000000000000000002BF3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E3D" epub:type="title" id="P7000497027000000000000000040E3D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002BF5" epub:type="pagebreak" id="P7000497027000000000000000002BF5" title="258"></span><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.37 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P70004970270000000000000000037B1">341</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040E3E" id="P7000497027000000000000000040E3E">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040E3F" id="P7000497027000000000000000040E3F">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E40" id="P7000497027000000000000000040E40"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040E41" id="P7000497027000000000000000040E41">Suppose <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040E42" id="P7000497027000000000000000040E42">S</code></sub>, the address of short integer array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E43" id="P7000497027000000000000000040E43">S</code>, and long integer index <var class="pcalibre17 pcalibre2 pcalibre1">i</var> are stored in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E44" id="P7000497027000000000000000040E44">%rdx</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E45" id="P7000497027000000000000000040E45">%rcx</code>, respectively. For each of the following expressions, give its type, a formula for its value, and an assembly-code implementation. The result should be stored in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E46" id="P7000497027000000000000000040E46">%rax</code> if it is a pointer and register element <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E47" id="P7000497027000000000000000040E47">%ax</code> if it has data type short.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040E48" id="P7000497027000000000000000040E48">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040E49" id="P7000497027000000000000000040E49">Expression</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040E4A" id="P7000497027000000000000000040E4A">Type</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040E4B" id="P7000497027000000000000000040E4B">Value</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040E4C" id="P7000497027000000000000000040E4C">Assembly code</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E4D" id="P7000497027000000000000000040E4D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E4E" id="P7000497027000000000000000040E4E">S+1</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E4F" id="P7000497027000000000000000040E4F">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E50" id="P7000497027000000000000000040E50">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E51" id="P7000497027000000000000000040E51">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E52" id="P7000497027000000000000000040E52"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E53" id="P7000497027000000000000000040E53">S[3]</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E54" id="P7000497027000000000000000040E54">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E55" id="P7000497027000000000000000040E55">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E56" id="P7000497027000000000000000040E56">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E57" id="P7000497027000000000000000040E57"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E58" id="P7000497027000000000000000040E58">&amp;S[i]</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E59" id="P7000497027000000000000000040E59">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E5A" id="P7000497027000000000000000040E5A">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E5B" id="P7000497027000000000000000040E5B">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E5C" id="P7000497027000000000000000040E5C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E5D" id="P7000497027000000000000000040E5D">S[4*i+1]</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E5E" id="P7000497027000000000000000040E5E">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E5F" id="P7000497027000000000000000040E5F">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E60" id="P7000497027000000000000000040E60">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E61" id="P7000497027000000000000000040E61"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E62" id="P7000497027000000000000000040E62">S+i-5</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E63" id="P7000497027000000000000000040E63">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E64" id="P7000497027000000000000000040E64">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E65" id="P7000497027000000000000000040E65">__________</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002C1E" id="P7000497027000000000000000002C1E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E66" epub:type="title" id="P7000497027000000000000000040E66"><span class="pcalibre1 pcalibre21 pcalibre2">3.8.3 </span>Nested Arrays</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E67" id="P7000497027000000000000000040E67">The general principles of array allocation and referencing hold even when we create arrays of arrays. For example, the declaration</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040E68" id="P7000497027000000000000000040E68"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E69" id="P7000497027000000000000000040E69">
int A[5][3];
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E6A" id="P7000497027000000000000000040E6A">is equivalent to the declaration</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040E6B" id="P7000497027000000000000000040E6B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E6C" id="P7000497027000000000000000040E6C">
typedef int row3_t[3];
row3_t A[5];
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E6D" id="P7000497027000000000000000040E6D">Data type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E6E" id="P7000497027000000000000000040E6E">row3_t</code> is defined to be an array of three integers. Array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E6F" id="P7000497027000000000000000040E6F">A</code> contains five such elements, each requiring 12 bytes to store the three integers. The total array size is then 4 · 5 · 3 = 60 bytes.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E70" id="P7000497027000000000000000040E70">Array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E71" id="P7000497027000000000000000040E71">A</code> can also be viewed as a two-dimensional array with five rows and three columns, referenced as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E72" id="P7000497027000000000000000040E72">A[0][0]</code> through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E73" id="P7000497027000000000000000040E73">A[4][2]</code>. The array elements are ordered in memory in <i class="pcalibre17 pcalibre2 pcalibre1">row-major</i> order, meaning all elements of row 0, which can be written <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E74" id="P7000497027000000000000000040E74">A[0]</code>, followed by all elements of row 1 <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E75" id="P7000497027000000000000000040E75">(A[1])</code>, and so on. This is illustrated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C3A"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.36</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E76" id="P7000497027000000000000000040E76">This ordering is a consequence of our nested declaration. Viewing <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E77" id="P7000497027000000000000000040E77">A</code> as an array of five elements, each of which is an array of three <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E78" id="P7000497027000000000000000040E78">int</code>'s, we first have <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E79" id="P7000497027000000000000000040E79">A[0]</code>, followed by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E7A" id="P7000497027000000000000000040E7A">A[1]</code>, and so on.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E7B" id="P7000497027000000000000000040E7B">Toaccess elements of multidimensional arrays, the compiler generates code to compute the off set of the desired element and then uses one of the <span class="pcalibre1 pcalibre29 pcalibre2">mov </span>instructions with the start of the array as the base address and the (possibly scaled) offset as an index. In general, for an array declared as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040E7C" id="P7000497027000000000000000040E7C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E7D" id="P7000497027000000000000000040E7D">
<var class="pcalibre17 pcalibre2 pcalibre1">T</var> D[<var class="pcalibre17 pcalibre2 pcalibre1">R</var>][<var class="pcalibre17 pcalibre2 pcalibre1">C</var>];
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E7E" id="P7000497027000000000000000040E7E">array element <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E7F" id="P7000497027000000000000000040E7F">D[i][j]</code> is at memory address</p>
<div class="pcalibre1 pcalibre2 informalequation" data-uri="chapter03.xhtml#P7000497027000000000000000002C39" id="P7000497027000000000000000002C39"><m:math altimg="../images/ch03-eq6.png" altimg-height="14" altimg-width="175" alttext="" data-uri="" display="block"><m:mrow><m:mo>&amp;</m:mo><m:mtext>D</m:mtext><m:mrow><m:mo>[</m:mo> <m:mtext>i</m:mtext> <m:mo>]</m:mo></m:mrow><m:mrow><m:mo>[</m:mo> <m:mtext>j</m:mtext> <m:mo>]</m:mo></m:mrow><m:mo>=</m:mo><m:msub><m:mi>x</m:mi><m:mi>D</m:mi></m:msub><m:mo>+</m:mo><m:mi>L</m:mi><m:mrow><m:mo>(</m:mo><m:mrow><m:mi>C</m:mi><m:mo>⋅</m:mo><m:mi>i</m:mi><m:mo>+</m:mo><m:mi>j</m:mi></m:mrow><m:mo>)</m:mo></m:mrow></m:mrow></m:math>
<span class="pcalibre1 pcalibre76 pcalibre2">(3.1)</span>
</div>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002C3A" id="P7000497027000000000000000002C3A">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002C3B" epub:type="pagebreak" id="P7000497027000000000000000002C3B" title="259"></span>
<img alt="A diagram lists elements of array within five major rows." class="pcalibre1 pcalibre2 pcalibre131" data-uri="P700049702700000000000000000B6BB" id="P7000497027000000000000000040E80" src="Images/chapter-03-image-08.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040E81" id="P7000497027000000000000000040E81"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040E82" epub:type="title" id="P7000497027000000000000000040E82"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.36 </span>Elements of array in row-major order.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P7000497027000000000000000021158" id="P7000497027000000000000000021158">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040E83" id="P7000497027000000000000000040E83">A diagram is reproduced in the following table.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040E84" id="P7000497027000000000000000040E84">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040E85" id="P7000497027000000000000000040E85">Row</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040E86" id="P7000497027000000000000000040E86">Element</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040E87" id="P7000497027000000000000000040E87">Address</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E88" id="P7000497027000000000000000040E88">A[0]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E89" id="P7000497027000000000000000040E89">A[0][0]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E8A" id="P7000497027000000000000000040E8A">xA</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E8B" id="P7000497027000000000000000040E8B">A[0][1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E8C" id="P7000497027000000000000000040E8C">xA + 4</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E8D" id="P7000497027000000000000000040E8D">A[0][2]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E8E" id="P7000497027000000000000000040E8E">xA + 8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E8F" id="P7000497027000000000000000040E8F">A[1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E90" id="P7000497027000000000000000040E90">A[1][0]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E91" id="P7000497027000000000000000040E91">xA + 12</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E92" id="P7000497027000000000000000040E92">A[1][1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E93" id="P7000497027000000000000000040E93">xA + 16</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E94" id="P7000497027000000000000000040E94">A[1][2]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E95" id="P7000497027000000000000000040E95">xA + 20</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E96" id="P7000497027000000000000000040E96">A[2]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E97" id="P7000497027000000000000000040E97">A[2][0]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E98" id="P7000497027000000000000000040E98">xA + 24</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E99" id="P7000497027000000000000000040E99">A[2][1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E9A" id="P7000497027000000000000000040E9A">xA + 28</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E9B" id="P7000497027000000000000000040E9B">A[2][2]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E9C" id="P7000497027000000000000000040E9C">xA + 32</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E9D" id="P7000497027000000000000000040E9D">A[3]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E9E" id="P7000497027000000000000000040E9E">A[3][0]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040E9F" id="P7000497027000000000000000040E9F">xA + 36</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA0" id="P7000497027000000000000000040EA0">A[3][1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA1" id="P7000497027000000000000000040EA1">xA + 40</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA2" id="P7000497027000000000000000040EA2">A[3][2]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA3" id="P7000497027000000000000000040EA3">xA + 44</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA4" id="P7000497027000000000000000040EA4">A[4]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA5" id="P7000497027000000000000000040EA5">A[4][0]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA6" id="P7000497027000000000000000040EA6">xA + 48</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA7" id="P7000497027000000000000000040EA7">A[4][1]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA8" id="P7000497027000000000000000040EA8">xA + 52</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EA9" id="P7000497027000000000000000040EA9">A[4][2]</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EAA" id="P7000497027000000000000000040EAA">xA + 56</td>
</tr>
</tbody>
</table>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EAB" id="P7000497027000000000000000040EAB">where <var class="pcalibre17 pcalibre2 pcalibre1">L</var> is the size of data type <var class="pcalibre17 pcalibre2 pcalibre1">T</var> in bytes. As an example, consider the 5×3 integer array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EAC" id="P7000497027000000000000000040EAC">A</code> defined earlier. Suppose <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040EAD" id="P7000497027000000000000000040EAD">A</code></sub>, <i class="pcalibre17 pcalibre2 pcalibre1"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EAE" id="P7000497027000000000000000040EAE">i</code></i>, and <i class="pcalibre17 pcalibre2 pcalibre1"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EAF" id="P7000497027000000000000000040EAF">j</code></i> are in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EB0" id="P7000497027000000000000000040EB0">%rdi, %rsi</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EB1" id="P7000497027000000000000000040EB1">%rdx</code>, respectively. Then array element <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EB2" id="P7000497027000000000000000040EB2">A[i][j]</code> can be copied to register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EB3" id="P7000497027000000000000000040EB3">%eax</code> by the following code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040EB4" id="P7000497027000000000000000040EB4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EB5" id="P7000497027000000000000000040EB5">
	<i class="pcalibre17 pcalibre2 pcalibre1">A in %rdi, i in %rsi, and j in %rdx</i>
1	leaq	(%rsi,%rsi,2), %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Compute</i> 3<var class="pcalibre17 pcalibre2 pcalibre1">i</var>
2	leaq	(%rdi,%rax,4), %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Compute x</i><sub class="pcalibre1 pcalibre2 pcalibre122">A</sub> + 12<var class="pcalibre17 pcalibre2 pcalibre1">i</var>
3	movl	(%rax,%rdx,4), %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Read from</i> M[<var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 pcalibre122">A</sub> + 12<var class="pcalibre17 pcalibre2 pcalibre1">i</var> + 4]
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EB6" id="P7000497027000000000000000040EB6">As can be seen, this code computes the element's address as <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040EB7" id="P7000497027000000000000000040EB7">A</code></sub> + 12<var class="pcalibre17 pcalibre2 pcalibre1">i</var> + 4<var class="pcalibre17 pcalibre2 pcalibre1">j</var> = <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040EB8" id="P7000497027000000000000000040EB8">A</code></sub> + 4(3<var class="pcalibre17 pcalibre2 pcalibre1">i</var> + <var class="pcalibre17 pcalibre2 pcalibre1">j</var>) using the scaling and addition capabilities of x86-64 address arithmetic.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002C4D" epub:type="practice" id="P7000497027000000000000000002C4D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EB9" epub:type="title" id="P7000497027000000000000000040EB9"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.38 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P70004970270000000000000000037B1">341</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040EBA" id="P7000497027000000000000000040EBA">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040EBB" id="P7000497027000000000000000040EBB">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EBC" id="P7000497027000000000000000040EBC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040EBD" id="P7000497027000000000000000040EBD">Consider the following source code, where <var class="pcalibre17 pcalibre2 pcalibre1">M</var> and <var class="pcalibre17 pcalibre2 pcalibre1">N</var> are constants declared with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EBE" id="P7000497027000000000000000040EBE">#define</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040EBF" id="P7000497027000000000000000040EBF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EC0" id="P7000497027000000000000000040EC0">
long P[M][N];
long Q[N][M];
long sum_element(long i, long j) {
	return P[i][j] + Q[j][i];
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040EC1" id="P7000497027000000000000000040EC1">In compiling this program, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040EC2" id="P7000497027000000000000000040EC2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EC3" id="P7000497027000000000000000040EC3">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002C59" epub:type="pagebreak" id="P7000497027000000000000000002C59" title="260"></span>	<i class="pcalibre17 pcalibre2 pcalibre1">long sum_element(long i, long j)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">i in %rdi, j in %rsi</i>
1	sum_element:
2	leaq	0(,%rdi,8), %rdx
3	subq	%rdi, %rdx
4	addq	%rsi, %rdx
5	leaq	(%rsi,%rsi,4), %rax
6	addq	%rax, %rdi
7	movq	Q(,%rdi,8), %rax
8	addq	P(,%rdx,8), %rax
9	ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040EC4" id="P7000497027000000000000000040EC4">Use your reverse engineering skills to determine the values of <var class="pcalibre17 pcalibre2 pcalibre1">M</var> and <var class="pcalibre17 pcalibre2 pcalibre1">N</var> based on this assembly code.</p>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002C5B" id="P7000497027000000000000000002C5B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EC5" epub:type="title" id="P7000497027000000000000000040EC5"><span class="pcalibre1 pcalibre21 pcalibre2">3.8.4 </span>Fixed-Size Arrays</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EC6" id="P7000497027000000000000000040EC6">The C compiler is able to make many optimizations for code operating on multidimensional arrays of fixed size. Here we demonstrate some of the optimizations made by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>when the optimization level is set with the flag <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EC7" id="P7000497027000000000000000040EC7">-01</code>. Suppose we declare data type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EC8" id="P7000497027000000000000000040EC8">fix_matrix</code> to be 16 × 16 arrays of integers as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040EC9" id="P7000497027000000000000000040EC9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ECA" id="P7000497027000000000000000040ECA">
#define N 16
typedef int fix_matrix[N][N];
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ECB" id="P7000497027000000000000000040ECB">(This example illustrates a good coding practice. Whenever a program uses some constant as an array dimension or buffer size, it is best to associate a name with it via a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ECC" id="P7000497027000000000000000040ECC">#define</code> declaration, and then use this name consistently, rather than the numeric value. That way, if an occasion ever arises to change the value, it can be done by simply modifying the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ECD" id="P7000497027000000000000000040ECD">#define</code> declaration.) The code in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C79"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.37(a)</span></a> computes element <i class="pcalibre17 pcalibre2 pcalibre1">i, k</i> of the product of arrays <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ECE" id="P7000497027000000000000000040ECE">A</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ECF" id="P7000497027000000000000000040ECF">B</code>—that is, the inner product of row <var class="pcalibre17 pcalibre2 pcalibre1">i</var> from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED0" id="P7000497027000000000000000040ED0">A</code> and column <var class="pcalibre17 pcalibre2 pcalibre1">k</var> from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED1" id="P7000497027000000000000000040ED1">B</code>. This product is given by the formula <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-eq7.png" altimg-height="17" altimg-width="112" alttext="" data-uri="" display="inline"><m:mrow><m:mstyle displaystyle="true"><m:msub><m:mo>∑</m:mo><m:mrow><m:mn>0</m:mn><m:mo>≤</m:mo><m:mi>j</m:mi><m:mo>&lt;</m:mo><m:mi>N</m:mi></m:mrow></m:msub><m:mrow><m:msub><m:mi>a</m:mi><m:mrow><m:mi>i</m:mi><m:mo>,</m:mo><m:mi>j</m:mi></m:mrow></m:msub><m:mo>⋅</m:mo><m:msub><m:mi>b</m:mi><m:mrow><m:mi>j</m:mi><m:mo>,</m:mo><m:mi>k</m:mi></m:mrow></m:msub></m:mrow></m:mstyle></m:mrow></m:math></span>. G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>generates code that we then recoded into C, shown as function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED2" id="P7000497027000000000000000040ED2">fix_prod_ele_opt</code> in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C79"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.37(b)</span></a>. This code contains a number of clever optimizations. It removes the integer index <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED3" id="P7000497027000000000000000040ED3">j</code> and converts all array references to pointer dereferences. This involves (1) generating a pointer, which we have named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED4" id="P7000497027000000000000000040ED4">Aptr</code>, that points to successive elements in row <var class="pcalibre17 pcalibre2 pcalibre1">i</var> of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED5" id="P7000497027000000000000000040ED5">A</code>, (2) generating a pointer, which we have named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED6" id="P7000497027000000000000000040ED6">Bptr</code>, that points to successive elements in column <var class="pcalibre17 pcalibre2 pcalibre1">k</var> of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED7" id="P7000497027000000000000000040ED7">B</code>, and (3) generating a pointer, which we have named Bend, that equals the value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED8" id="P7000497027000000000000000040ED8">Bptr</code> will have when it is time to terminate the loop. The initial value for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040ED9" id="P7000497027000000000000000040ED9">Aptr</code> is the address of the first element of row <var class="pcalibre17 pcalibre2 pcalibre1">i</var> of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EDA" id="P7000497027000000000000000040EDA">A</code>, given by the C expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EDB" id="P7000497027000000000000000040EDB">&amp;A[i][0]</code>. The initial value for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EDC" id="P7000497027000000000000000040EDC">Bptr</code> is the address of the first element of column <var class="pcalibre17 pcalibre2 pcalibre1">k</var> of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EDD" id="P7000497027000000000000000040EDD">B</code>, given by the C expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EDE" id="P7000497027000000000000000040EDE">&amp;B[0][k]</code>. The value for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EDF" id="P7000497027000000000000000040EDF">Bend</code> is the index of what would be the (<var class="pcalibre17 pcalibre2 pcalibre1">n</var> + 1)st element in column <var class="pcalibre17 pcalibre2 pcalibre1">j</var> of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EE0" id="P7000497027000000000000000040EE0">B</code>, given by the C expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EE1" id="P7000497027000000000000000040EE1">&amp;B[N][k]</code>.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002C79" id="P7000497027000000000000000002C79">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EE2" id="P7000497027000000000000000040EE2"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002C7B" epub:type="pagebreak" id="P7000497027000000000000000002C7B" title="261"></span>(a) Original C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040EE3" id="P7000497027000000000000000040EE3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EE4" id="P7000497027000000000000000040EE4">
/* Compute i,k of fixed matrix product */
int fix_prod_ele (fix_matrix A, fix_matrix B, long i, long k) {
	long j;
	int result = 0;

	for (j = 0; j &lt; N; j++)
	  result += A[i][j] * B[j][k];
	return result;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EE5" id="P7000497027000000000000000040EE5">(b) Optimized C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040EE6" id="P7000497027000000000000000040EE6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EE7" id="P7000497027000000000000000040EE7">
1	/* Compute i,k of fixed matrix product */
2	int fix_prod_ele_opt(fix_matrix A, fix_matrix B, long i, long k) {
3		int *Aptr = &amp;A[i][0];	/* Points to elements in row i of A		*/
4		int *Bptr = &amp;B[0][k];	/* Points to elements in column k of B	*/
5		int *Bend = &amp;B[N][k];	/* Marks stopping point for Bptr		*/
6		int result = 0;
7		do {					/* No need for initial test */
8			result += *Aptr * *Bptr;	/* Add next product to sum */
9			Aptr ++;			/* Move Aptr to next column */
10			Bptr += N;			/* Move Bptr to next row */
11		} while (Bptr != Bend);			/* Test for stopping point */
12		return result;
13	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040EE8" id="P7000497027000000000000000040EE8"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040EE9" epub:type="title" id="P7000497027000000000000000040EE9"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.37 </span>Original and optimized code to compute element <i class="pcalibre17 pcalibre2 pcalibre1">i, k</i> of matrix product for fixed-length arrays.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EEA" id="P7000497027000000000000000040EEA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040EEB" id="P7000497027000000000000000040EEB">The compiler performs these optimizations automatically.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EEC" id="P7000497027000000000000000040EEC">The following is the actual assembly code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>for function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EED" id="P7000497027000000000000000040EED">fix_prod_ele</code>. We see that four registers are used as follows: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EEE" id="P7000497027000000000000000040EEE">%eax</code> holds result, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EEF" id="P7000497027000000000000000040EEF">%rdi</code> holds <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EF0" id="P7000497027000000000000000040EF0">Aptr, %rcx</code> holds <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EF1" id="P7000497027000000000000000040EF1">Bptr</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EF2" id="P7000497027000000000000000040EF2">%rsi</code> holds <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EF3" id="P7000497027000000000000000040EF3">Bend</code>.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040EF4" id="P7000497027000000000000000040EF4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EF5" id="P7000497027000000000000000040EF5">
	<i class="pcalibre17 pcalibre2 pcalibre1">int fix_prod_ele_opt(fix_matrix A, fix_matrix B, long i, long k)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">A in %rdi, B in %rsi, i in %rdx, k in %rcx</i>
1	fix_prod_ele:
2	  salq	 $6, %rdx		<i class="pcalibre17 pcalibre2 pcalibre1">Compute 64 * i</i>
3	  addq	 %rdx, %rdi		<i class="pcalibre17 pcalibre2 pcalibre1">Compute Aptr = x</i><sub class="pcalibre1 pcalibre2 pcalibre122">A</sub> + 64<i class="pcalibre17 pcalibre2 pcalibre1">i = &amp;A[i][0]</i>
4	  leaq	(%rsi,%rcx,4), %rcx	<i class="pcalibre17 pcalibre2 pcalibre1">Compute Bptr = x</i><sub class="pcalibre1 pcalibre2 pcalibre122">B</sub> + 4<i class="pcalibre17 pcalibre2 pcalibre1">k = &amp;B[0][k]</i>
5	  leaq	 1024(%rcx), %rsi	<i class="pcalibre17 pcalibre2 pcalibre1">Compute Bend = x</i><sub class="pcalibre1 pcalibre2 pcalibre122">B</sub> + 4<var class="pcalibre17 pcalibre2 pcalibre1">k</var> + 1024 <i class="pcalibre17 pcalibre2 pcalibre1">= &amp;B[N][k]</i>
6	  movl	 $0, %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Set result = 0</i>
7	.L7:		<b class="pcalibre1 pcalibre2 pcalibre12">loop:</b>
8	  movl	(%rdi), %edx		<i class="pcalibre17 pcalibre2 pcalibre1">Read *Aptr</i>
9	  imull	(%rcx), %edx		<i class="pcalibre17 pcalibre2 pcalibre1">Multiply by *Bptr</i>
10	  addl	%edx, %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Add to result</i>
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002C8F" epub:type="pagebreak" id="P7000497027000000000000000002C8F" title="262"></span>11	  addq	$4, %rdi		<i class="pcalibre17 pcalibre2 pcalibre1">Increment Aptr ++</i>
12	  addq	$64, %rcx		<i class="pcalibre17 pcalibre2 pcalibre1">Increment Bptr += N</i>
13	  cmpq	%rsi, %rcx		<i class="pcalibre17 pcalibre2 pcalibre1">Compare Bptr:Bend</i>
14	  jne		.L7		<i class="pcalibre17 pcalibre2 pcalibre1">If !=, goto</i> <b class="pcalibre1 pcalibre2 pcalibre12">loop</b>
15	  rep; ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002C90" epub:type="practice" id="P7000497027000000000000000002C90"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EF6" epub:type="title" id="P7000497027000000000000000040EF6"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.39 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P700049702700000000000000000381C">342</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040EF7" id="P7000497027000000000000000040EF7">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040EF8" id="P7000497027000000000000000040EF8">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040EF9" id="P7000497027000000000000000040EF9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040EFA" id="P7000497027000000000000000040EFA">Use <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C39"><span class="pcalibre1 pcalibre21 pcalibre2">Equation </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1</span></a> to explain how the computations of the initial values for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EFB" id="P7000497027000000000000000040EFB">Aptr</code>, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EFC" id="P7000497027000000000000000040EFC">Bptr</code>, and Bend in the C code of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C79"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.37(b)</span></a> (lines 3–5) correctly describe their computations in the assembly code generated for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EFD" id="P7000497027000000000000000040EFD">fix_prod_ele</code> (lines 3–5).</p></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002C99" epub:type="practice" id="P7000497027000000000000000002C99"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040EFE" epub:type="title" id="P7000497027000000000000000040EFE"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.40 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P700049702700000000000000000381C">342</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040EFF" id="P7000497027000000000000000040EFF">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040F00" id="P7000497027000000000000000040F00">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040F01" id="P7000497027000000000000000040F01"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F02" id="P7000497027000000000000000040F02">The following C code sets the diagonal elements of one of our fixed-size arrays to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F03" id="P7000497027000000000000000040F03">val</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F04" id="P7000497027000000000000000040F04"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F05" id="P7000497027000000000000000040F05">
/* Set all diagonal elements to val */
void fix_set_diag(fix_matrix A, int val) {
	long i;
	for (i = 0; i &lt; N; i++)
	  A[i][i] = val;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F06" id="P7000497027000000000000000040F06">When compiled with optimization level <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F07" id="P7000497027000000000000000040F07">-01, <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span></code> generates the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F08" id="P7000497027000000000000000040F08"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F09" id="P7000497027000000000000000040F09">
1	fix_set_diag:
	<i class="pcalibre17 pcalibre2 pcalibre1">void fix_set_diag(fix_matrix A, int val)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">A in %rdi, val in %rsi</i>
2		movl	$0, %eax
3	.L13:
4		movl	%esi, (%rdi,%rax)
5		addq	$68, %rax
6		cmpq	$1088, %rax
7		jne	.L13
8		rep; ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F0A" id="P7000497027000000000000000040F0A">Create a C code program <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F0B" id="P7000497027000000000000000040F0B">fix_set_diag_opt</code> that uses optimizations similar to those in the assembly code, in the same style as the code in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C79"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.37(b)</span></a>. Use expressions involving the parameter <var class="pcalibre17 pcalibre2 pcalibre1">N</var> rather than integer constants, so that your code will work correctly if <var class="pcalibre17 pcalibre2 pcalibre1">N</var> is redefined.</p>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002CA8" id="P7000497027000000000000000002CA8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F0C" epub:type="title" id="P7000497027000000000000000040F0C"><span class="pcalibre1 pcalibre21 pcalibre2">3.8.5 </span>Variable-Size Arrays</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F0D" id="P7000497027000000000000000040F0D">Historically, C only supported multidimensional arrays where the sizes (with the possible exception of the first dimension) could be determined at compile time. <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002CAB" epub:type="pagebreak" id="P7000497027000000000000000002CAB" title="263"></span>Programmers requiring variable-size arrays had to allocate storage for these arrays using functions such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F0E" id="P7000497027000000000000000040F0E">malloc</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F0F" id="P7000497027000000000000000040F0F">calloc</code>, and they had to explicitly encode the mapping of multidimensional arrays into single-dimension ones via row-major indexing, as expressed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C39"><span class="pcalibre1 pcalibre21 pcalibre2">Equation </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1</span></a>. ISO C99 introduced the capability of having array dimension expressions that are computed as the array is being allocated.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F10" id="P7000497027000000000000000040F10">In the C version of variable-size arrays, we can declare an array</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F11" id="P7000497027000000000000000040F11"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F12" id="P7000497027000000000000000040F12">
int A<i class="pcalibre17 pcalibre2 pcalibre1">[expr1] [expr2]</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F13" id="P7000497027000000000000000040F13">either as a local variable or as an argument to a function, and then the dimensions of the array are determined by evaluating the expressions <i class="pcalibre17 pcalibre2 pcalibre1">expr1</i> and <i class="pcalibre17 pcalibre2 pcalibre1">expr2</i> at the time the declaration is encountered. So, for example, we can write a function to access element <i class="pcalibre17 pcalibre2 pcalibre1">i, j</i> of an <var class="pcalibre17 pcalibre2 pcalibre1">n</var> × <var class="pcalibre17 pcalibre2 pcalibre1">n</var> array as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F14" id="P7000497027000000000000000040F14"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F15" id="P7000497027000000000000000040F15">
int var_ele(long n, int A[n][n], long i, long j) {
	return A[i][j];
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F16" id="P7000497027000000000000000040F16">The parameter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F17" id="P7000497027000000000000000040F17">n</code> must precede the parameter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F18" id="P7000497027000000000000000040F18">A[n][n]</code>, so that the function can compute the array dimensions as the parameter is encountered.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F19" id="P7000497027000000000000000040F19">G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>generates code for this referencing function as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F1A" id="P7000497027000000000000000040F1A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F1B" id="P7000497027000000000000000040F1B">
	<i class="pcalibre17 pcalibre2 pcalibre1">int var_ele(long n, int A[n][n], long i, long j)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">n in %rdi, A in %rsi, i in %rdx, j in %rcx</i>
1	var_ele:
2		imulq	%rdx, %rdi			<i class="pcalibre17 pcalibre2 pcalibre1">Compute n · i</i>
3		leaq	(%rsi,%rdi,4), %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Compute x</i><sub class="pcalibre1 pcalibre2 pcalibre122">A</sub> + 4(<i class="pcalibre17 pcalibre2 pcalibre1">n · i</i>
4		movl	(%rax,%rcx,4), %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Read from</i> M[<var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 pcalibre122">A</sub> + 4(<var class="pcalibre17 pcalibre2 pcalibre1">n</var> · <var class="pcalibre17 pcalibre2 pcalibre1">i</var>) + 4<var class="pcalibre17 pcalibre2 pcalibre1">j</var>]
5		ret
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F1C" id="P7000497027000000000000000040F1C">As the annotations show, this code computes the address of element <i class="pcalibre17 pcalibre2 pcalibre1">i, j</i> as <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040F1D" id="P7000497027000000000000000040F1D">A</code></sub> + 4(<var class="pcalibre17 pcalibre2 pcalibre1">n</var> · <var class="pcalibre17 pcalibre2 pcalibre1">i</var>) + 4<var class="pcalibre17 pcalibre2 pcalibre1">j</var> = <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000040F1E" id="P7000497027000000000000000040F1E">A</code></sub> + 4(<var class="pcalibre17 pcalibre2 pcalibre1">n</var> · <var class="pcalibre17 pcalibre2 pcalibre1">i</var> + <var class="pcalibre17 pcalibre2 pcalibre1">j</var>). The address computation is similar to that of the fixed-size array (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C1E"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.8.3</span></a>), except that (1) the register usage changes due to added parameter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F1F" id="P7000497027000000000000000040F1F">n</code>, and (2) a multiply instruction is used (line 2) to compute <var class="pcalibre17 pcalibre2 pcalibre1">n</var> · <var class="pcalibre17 pcalibre2 pcalibre1">i</var>, rather than an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F20" id="P7000497027000000000000000040F20">leaq</code> instruction to compute 3<var class="pcalibre17 pcalibre2 pcalibre1">i</var>. We see therefore that referencing variable-size arrays requires only a slight generalization over fixed-size ones. The dynamic version must use a multiplication instruction to scale <var class="pcalibre17 pcalibre2 pcalibre1">i</var> by <var class="pcalibre17 pcalibre2 pcalibre1">n</var>, rather than a series of shifts and adds. In some processors, this multiplication can incur a significant performance penalty, but it is unavoidable in this case.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F21" id="P7000497027000000000000000040F21">When variable-size arrays are referenced within a loop, the compiler can often optimize the index computations by exploiting the regularity of the access patterns. For example, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002CC3"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.38(a)</span></a> shows C code to compute element <var class="pcalibre17 pcalibre2 pcalibre1">i</var>, <var class="pcalibre17 pcalibre2 pcalibre1">k</var> of the product of two <var class="pcalibre17 pcalibre2 pcalibre1">n</var> × <var class="pcalibre17 pcalibre2 pcalibre1">n</var> arrays <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F22" id="P7000497027000000000000000040F22">A</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F23" id="P7000497027000000000000000040F23">B</code>. G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>generates assembly code, which we have recast into C (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002CC3"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.38(b)</span></a>). This code follows a different style from the optimized code for the fixed-size array (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C79"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.37</span></a>), but that is more an artifact of the choices made by the compiler, rather than a fundamental requirement for the two different functions. The code of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002CC3"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.38(b)</span></a> retains loop variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F24" id="P7000497027000000000000000040F24">j</code>, both to detect when</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002CC3" id="P7000497027000000000000000002CC3">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F25" id="P7000497027000000000000000040F25"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002CC5" epub:type="pagebreak" id="P7000497027000000000000000002CC5" title="264"></span>(a) Original C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F26" id="P7000497027000000000000000040F26"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F27" id="P7000497027000000000000000040F27">
1	/* Compute i,k of variable matrix product */
2	int var_prod_ele(long n, int A[n][n], int B[n][n], long i, long k) {
3		long j;
4		int result = 0;
5
6		for (j = 0; j &lt; n; j++)
7			result += A[i][j] * B[j][k];
8
9		return result;
10	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F28" id="P7000497027000000000000000040F28">(b) Optimized C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F29" id="P7000497027000000000000000040F29"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F2A" id="P7000497027000000000000000040F2A">
/* Compute i,k of variable matrix product */
int var_prod_ele_opt(long n, int A[n][n], int B[n][n], long i, long k) {
	int *Arow = A[i];
	int *Bptr = &amp;B[0][k];
	int result = 0;
	long j;
	for (j = 0; j &lt; n; j++) {
	  result += Arow[j] * *Bptr;
	  Bptr += n;
	}
	return result;
}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040F2B" id="P7000497027000000000000000040F2B"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000040F2C" epub:type="title" id="P7000497027000000000000000040F2C"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.38 </span>Original and optimized code to compute element <i class="pcalibre17 pcalibre2 pcalibre1">i, k</i> of matrix product for variable-size arrays.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F2D" id="P7000497027000000000000000040F2D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F2E" id="P7000497027000000000000000040F2E">The compiler performs these optimizations automatically.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F2F" id="P7000497027000000000000000040F2F">the loop has terminated and to index into an array consisting of the elements of row <var class="pcalibre17 pcalibre2 pcalibre1">i</var> of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F30" id="P7000497027000000000000000040F30">A</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F31" id="P7000497027000000000000000040F31">The following is the assembly code for the loop of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F32" id="P7000497027000000000000000040F32">var_prod_ele</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F33" id="P7000497027000000000000000040F33"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F34" id="P7000497027000000000000000040F34">
	<i class="pcalibre17 pcalibre2 pcalibre1">Registers: n in %rdi, Arow in %rsi, Bptr in %rcx</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">4n in %r9, result in %eax, j in %edx</i>
1	.L24:				<b class="pcalibre1 pcalibre2 pcalibre12">loop:</b>
2	movl	(%rsi,%rdx,4), %r8d	<i class="pcalibre17 pcalibre2 pcalibre1">Read Arow[j]</i>
3	imull	(%rcx), %r8d		<i class="pcalibre17 pcalibre2 pcalibre1">Multiply by *Bptr</i>
4	addl	%r8d, %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Add to result</i>
5	addq	$1, %rdx		<i class="pcalibre17 pcalibre2 pcalibre1">j++</i>
6	addq	%r9, %rcx		<i class="pcalibre17 pcalibre2 pcalibre1">Bptr += n</i>
7	cmpq	%rdi, %rdx		<i class="pcalibre17 pcalibre2 pcalibre1">Compare j:n</i>
8	jne	.L24			<i class="pcalibre17 pcalibre2 pcalibre1">If !=, goto</i> <b class="pcalibre1 pcalibre2 pcalibre12">loop</b>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F35" id="P7000497027000000000000000040F35">We see that the program makes use of both a scaled value 4<var class="pcalibre17 pcalibre2 pcalibre1">n</var> (register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F36" id="P7000497027000000000000000040F36">%r9</code>) for incrementing <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F37" id="P7000497027000000000000000040F37">Bptr</code> as well as the value of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> (register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F38" id="P7000497027000000000000000040F38">%rdi</code>) to check the loop <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002CD9" epub:type="pagebreak" id="P7000497027000000000000000002CD9" title="265"></span>bounds. The need for two values does not show upin the C code, due to the scaling of pointer arithmetic.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F39" id="P7000497027000000000000000040F39">We have seen that, with optimizations enabled, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>is able to recognize patterns that arise when a program steps through the elements of a multidimensional array. It can then generate code that avoids the multiplication that would result from a direct application of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C39"><span class="pcalibre1 pcalibre21 pcalibre2">Equation </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1</span></a>. Whether it generates the pointer-based code of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002C79"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.37(b)</span></a> or the array-based code of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002CC3"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.38(b)</span></a>, these optimizations will significantly improve program performance.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.9 Heterogeneous Data Structures</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000002CDB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P7000497027000000000000000040F3A" epub:type="title" id="P7000497027000000000000000040F3A"><span class="pcalibre1 pcalibre21 pcalibre2">3.9 </span>Heterogeneous Data Structures</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F3B" id="P7000497027000000000000000040F3B">C provides two mechanisms for creating data types by combining objects of different types: <i class="pcalibre17 pcalibre2 pcalibre1">structures</i>, declared using the keyword <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F3C" id="P7000497027000000000000000040F3C">struct</code>, aggregate multiple objects into a single unit; <i class="pcalibre17 pcalibre2 pcalibre1">unions</i>, declared using the keyword <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F3D" id="P7000497027000000000000000040F3D">union</code>, allow an object to be referenced using several different types.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002CE0" id="P7000497027000000000000000002CE0"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F3E" epub:type="title" id="P7000497027000000000000000040F3E"><span class="pcalibre1 pcalibre21 pcalibre2">3.9.1 </span>Structures</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F3F" id="P7000497027000000000000000040F3F">The C <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F40" id="P7000497027000000000000000040F40">struct</code> declaration creates a data type that groups objects of possibly different types into a single object. The different components of a structure are referenced by names. The implementation of structures is similar to that of arrays in that all of the components of a structure are stored in a contiguous region of memory and a pointer to a structure is the address of its first byte. The compiler maintains information about each structure type indicating the byte offset of each field. It generates references to structure elements using these offsets as displacements in memory referencing instructions.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F41" id="P7000497027000000000000000040F41">As an example, consider the following structure declaration:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F42" id="P7000497027000000000000000040F42"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F43" id="P7000497027000000000000000040F43">
struct rec {
	int i;
	int j;
	int a[2];
	int *p;
};
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F44" id="P7000497027000000000000000040F44">This structure contains four fields: two 4-byte values of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F45" id="P7000497027000000000000000040F45">int</code>, a two-element array of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F46" id="P7000497027000000000000000040F46">int</code>, and an 8-byte integer pointer, giving a total of 24 bytes:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002CEA" id="P7000497027000000000000000002CEA">
<img alt="A diagram shows four fields: offset 0 to 4 with contents i; offset 4 to 8 with contents j; two offsets from 8 to 16 with contents a[0] and a[1]; offset 16 to 24 with contents p." class="pcalibre1 pcalibre2 pcalibre132" data-uri="P700049702700000000000000000B6BC" id="P7000497027000000000000000040F47" src="Images/chapter-03-image-09.png"/>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F48" id="P7000497027000000000000000040F48">Observe that array a is embedded within the structure. The numbers along the top of the diagram give the byte offsets of the fields from the beginning of the structure.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F49" id="P7000497027000000000000000040F49">To access the fields of a structure, the compiler generates code that adds the appropriate offset to the address of the structure. For example, suppose variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F4A" id="P7000497027000000000000000040F4A">r</code></p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000002CEF" id="P7000497027000000000000000002CEF"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P7000497027000000000000000040F4B" epub:type="title" id="P7000497027000000000000000040F4B"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002CF1" epub:type="pagebreak" id="P7000497027000000000000000002CF1" title="266"></span><span class="pcalibre1 pcalibre2 pcalibre34">New to C? </span>Representing an object as a <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter03.xhtml#P7000497027000000000000000040F4C" id="P7000497027000000000000000040F4C">struct</code></h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040F4D" id="P7000497027000000000000000040F4D">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F4E" id="P7000497027000000000000000040F4E">struct</code> data type constructor is the closest thing C provides to the objects of C++ and Java. It allows the programmer to keep information about some entity in a single data structure and to reference that information with names.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040F4F" id="P7000497027000000000000000040F4F">For example, a graphics program might represent a rectangle as a structure:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F50" id="P7000497027000000000000000040F50"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F51" id="P7000497027000000000000000040F51">
struct rect {
	long llx;		/* X coordinate of lower-left corner */
	long lly;		/* Y coordinate of lower-left corner */
	unsigned long width;	 /* Width (in pixels)			*/
	unsigned long height;	/* Height (in pixels)			*/
	unsigned color;		/* Coding of color			*/
};
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040F52" id="P7000497027000000000000000040F52">We can declare a variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F53" id="P7000497027000000000000000040F53">r</code> of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F54" id="P7000497027000000000000000040F54">struct rect</code> and set its field values as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F55" id="P7000497027000000000000000040F55"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F56" id="P7000497027000000000000000040F56">
struct rect r;
r.llx = r.lly = 0;
r.color = 0xFF00FF;
r.width = 10;
r.height = 20;
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040F57" id="P7000497027000000000000000040F57">where the expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F58" id="P7000497027000000000000000040F58">r.llx</code> selects field <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F59" id="P7000497027000000000000000040F59">llx</code> of structure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F5A" id="P7000497027000000000000000040F5A">r</code>.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040F5B" id="P7000497027000000000000000040F5B">Alternatively, we can both declare the variable and initialize its fields with a single statement:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F5C" id="P7000497027000000000000000040F5C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F5D" id="P7000497027000000000000000040F5D">
struct rect r = { 0, 0, 0xFF00FF, 10, 20 };
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040F5E" id="P7000497027000000000000000040F5E">It is common to pass pointers to structures from one place to another rather than copying them. For example, the following function computes the area of a rectangle, where a pointer to the rectangle <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F5F" id="P7000497027000000000000000040F5F">struct</code> is passed to the function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F60" id="P7000497027000000000000000040F60"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F61" id="P7000497027000000000000000040F61">
long area(struct rect *rp) {
	return (*rp).width * (*rp).height;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000040F62" id="P7000497027000000000000000040F62">The expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F63" id="P7000497027000000000000000040F63">(*rp)</code>.width dereferences the pointer and selects the width field of the resulting structure. Parentheses are required, because the compiler would interpret the expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F64" id="P7000497027000000000000000040F64">*rp.width</code> as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F65" id="P7000497027000000000000000040F65">*(rp.width)</code>, which is not valid. This combination of dereferencing and field selection is so common that C provides an alternative notation using -&gt;. That is, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F66" id="P7000497027000000000000000040F66">rp-&gt;width</code> is equivalent to the expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F67" id="P7000497027000000000000000040F67">(*rp).width.</code> For example, we can write a function that rotates a rectangle counterclockwise by 90 degrees as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F68" id="P7000497027000000000000000040F68"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F69" id="P7000497027000000000000000040F69">
void rotate_left(struct rect *rp) {
	/* Exchange width and height */
	long t = rp-&gt;height;
	rp-&gt;height = rp-&gt;width;
	rp-&gt;width = t;
	/* Shift to new lower-left corner */
	rp-&gt;llx -= t;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F6A" id="P7000497027000000000000000040F6A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002D11" epub:type="pagebreak" id="P7000497027000000000000000002D11" title="267"></span>The objects of C++ and Java are more elaborate than structures in C, in that they also associate a set of <i class="pcalibre17 pcalibre2 pcalibre1">methods</i> with an object that can be invoked to perform computation. In C, we would simply write these as ordinary functions, such as the functions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F6B" id="P7000497027000000000000000040F6B">area</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F6C" id="P7000497027000000000000000040F6C">rotate_left</code> shown previously.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F6D" id="P7000497027000000000000000040F6D">of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F6E" id="P7000497027000000000000000040F6E">struct rec *</code> is in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F6F" id="P7000497027000000000000000040F6F">%rdi</code>. Then the following code copies element <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F70" id="P7000497027000000000000000040F70">r-&gt;i</code> to element <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F71" id="P7000497027000000000000000040F71">r-&gt;j</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F72" id="P7000497027000000000000000040F72"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F73" id="P7000497027000000000000000040F73">
	<i class="pcalibre17 pcalibre2 pcalibre1">Registers: r in %rdi</i>
1	movl	(%rdi), %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Get r-&gt;i</i>
2	movl	%eax, 4(%rdi)		<i class="pcalibre17 pcalibre2 pcalibre1">Store in r-&gt;j</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F74" id="P7000497027000000000000000040F74">Since the offset of field <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F75" id="P7000497027000000000000000040F75">i</code> is 0, the address of this field is simply the value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F76" id="P7000497027000000000000000040F76">r</code>. To store into field <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F77" id="P7000497027000000000000000040F77">j</code>, the code adds offset 4 to the address of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F78" id="P7000497027000000000000000040F78">r</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F79" id="P7000497027000000000000000040F79">To generate a pointer to an object within a structure, we can simply add the field's offset to the structure address. For example, we can generate the pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F7A" id="P7000497027000000000000000040F7A">&amp;(r-&gt;a[1])</code> by adding offset 8 + 4 · 1 = 12. For pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F7B" id="P7000497027000000000000000040F7B">r</code> in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F7C" id="P7000497027000000000000000040F7C">%rdi</code> and long integer variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F7D" id="P7000497027000000000000000040F7D">i</code> in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F7E" id="P7000497027000000000000000040F7E">%rsi</code>, we can generate the pointer value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F7F" id="P7000497027000000000000000040F7F">&amp;(r-&gt;a[i])</code> with the single instruction</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F80" id="P7000497027000000000000000040F80"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F81" id="P7000497027000000000000000040F81">
	<i class="pcalibre17 pcalibre2 pcalibre1">Registers: r in %rdi, i %rsi</i>
1	leaq	 8(%rdi,%rsi,4), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Set %rax to &amp;r-&gt;a[i]</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F82" id="P7000497027000000000000000040F82">As a final example, the following code implements the statement</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F83" id="P7000497027000000000000000040F83"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F84" id="P7000497027000000000000000040F84">
r-&gt;p = &amp;r-&gt;a[r-&gt;i + r-&gt;j];
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F85" id="P7000497027000000000000000040F85">starting with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F86" id="P7000497027000000000000000040F86">r</code> in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F87" id="P7000497027000000000000000040F87">%rdi:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F88" id="P7000497027000000000000000040F88"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F89" id="P7000497027000000000000000040F89">
	<i class="pcalibre17 pcalibre2 pcalibre1">Registers: r in %rdi</i>
1	movl	 4(%rdi), %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Get r-&gt;j</i>
2	addl	 (%rdi), %eax		<i class="pcalibre17 pcalibre2 pcalibre1">Add r-&gt;i</i>
3	cltq				<i class="pcalibre17 pcalibre2 pcalibre1">Extend to 8 bytes</i>
4	leaq	 8(%rdi,%rax,4), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Compute &amp;r-&gt;a[r-&gt;i + r-&gt;j]</i>
5	movq	%rax, 16(%rdi)		<i class="pcalibre17 pcalibre2 pcalibre1">Store in r-&gt;p</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F8A" id="P7000497027000000000000000040F8A">As these examples show, the selection of the different fields of a structure is handled completely at compile time. The machine code contains no information about the field declarations or the names of the fields.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002D32" epub:type="practice" id="P7000497027000000000000000002D32"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F8B" epub:type="title" id="P7000497027000000000000000040F8B"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002D34" epub:type="pagebreak" id="P7000497027000000000000000002D34" title="268"></span><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.41 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003838">343</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040F8C" id="P7000497027000000000000000040F8C">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040F8D" id="P7000497027000000000000000040F8D">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040F8E" id="P7000497027000000000000000040F8E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F8F" id="P7000497027000000000000000040F8F">Consider the following structure declaration:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F90" id="P7000497027000000000000000040F90"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F91" id="P7000497027000000000000000040F91">
struct prob {
	int *p;
	struct {
	  int x;
	  int y;
	} s;
	struct prob *next;
};
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F92" id="P7000497027000000000000000040F92">This declaration illustrates that one structure can be embedded within another, just as arrays can be embedded within structures and arrays can be embedded within arrays.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F93" id="P7000497027000000000000000040F93">The following procedure (with some expressions omitted) operates on this structure:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F94" id="P7000497027000000000000000040F94"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F95" id="P7000497027000000000000000040F95">
void sp_init(struct prob *sp) {
	sp-&gt;s.x =	__________;
	sp-&gt;p =		__________;
	sp-&gt;next=	__________;
}
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000040F96" id="P7000497027000000000000000040F96">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F97" id="P7000497027000000000000000040F97"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F98" id="P7000497027000000000000000040F98">What are the offsets (in bytes) of the following fields?</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F99" id="P7000497027000000000000000040F99"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F9A" id="P7000497027000000000000000040F9A">
p:	__________
s.x:	 __________
s.y:	__________
next:	__________
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F9B" id="P7000497027000000000000000040F9B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F9C" id="P7000497027000000000000000040F9C">How many total bytes does the structure require?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040F9D" id="P7000497027000000000000000040F9D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040F9E" id="P7000497027000000000000000040F9E">The compiler generates the following assembly code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040F9F" id="P7000497027000000000000000040F9F">sp_init:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FA0" id="P7000497027000000000000000040FA0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FA1" id="P7000497027000000000000000040FA1">
	<i class="pcalibre17 pcalibre2 pcalibre1">void sp_init(struct prob *sp)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">sp in %rdi</i>
1	sp_init:
2	movl	12(%rdi), %eax
3	movl	%eax, 8(%rdi)
4	leaq	8(%rdi), %rax
5	movq	%rax, (%rdi)
6	movq	%rdi, 16(%rdi)
7	ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040FA2" id="P7000497027000000000000000040FA2">On the basis of this information, fill in the missing expressions in the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FA3" id="P7000497027000000000000000040FA3">sp_init.</code></p>
</li></ol></div>
</li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002D4D" epub:type="practice" id="P7000497027000000000000000002D4D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FA4" epub:type="title" id="P7000497027000000000000000040FA4"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002D4F" epub:type="pagebreak" id="P7000497027000000000000000002D4F" title="269"></span><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.42 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003838">343</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000040FA5" id="P7000497027000000000000000040FA5">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000040FA6" id="P7000497027000000000000000040FA6">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FA7" id="P7000497027000000000000000040FA7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040FA8" id="P7000497027000000000000000040FA8">The following code shows the declaration of a structure of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FA9" id="P7000497027000000000000000040FA9">ELE</code> and the prototype for a function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FAA" id="P7000497027000000000000000040FAA">fun</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FAB" id="P7000497027000000000000000040FAB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FAC" id="P7000497027000000000000000040FAC">
struct ELE {
	long v;
	struct ELE *p;
};

long fun(struct ELE *ptr);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040FAD" id="P7000497027000000000000000040FAD">When the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FAE" id="P7000497027000000000000000040FAE">fun</code> is compiled, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FAF" id="P7000497027000000000000000040FAF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FB0" id="P7000497027000000000000000040FB0">
	<i class="pcalibre17 pcalibre2 pcalibre1">long fun(struct ELE *ptr)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">ptr in %rdi</i>
1	fun:
2	movl	$0, %eax
3	jmp	.L2
4	L3:
5	addq	(%rdi), %rax
6	movq	8(%rdi), %rdi
7	.L2:
8	testq	%rdi, %rdi
9	jne	.L3
10	rep; ret
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000040FB1" id="P7000497027000000000000000040FB1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FB2" id="P7000497027000000000000000040FB2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040FB3" id="P7000497027000000000000000040FB3">Use your reverse engineering skills to write C code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FB4" id="P7000497027000000000000000040FB4">fun</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FB5" id="P7000497027000000000000000040FB5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000040FB6" id="P7000497027000000000000000040FB6">Describe the data structure that this structure implements and the operation performed by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FB7" id="P7000497027000000000000000040FB7">fun</code>.</p></li>
</ol>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002D63" id="P7000497027000000000000000002D63"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FB8" epub:type="title" id="P7000497027000000000000000040FB8"><span class="pcalibre1 pcalibre21 pcalibre2">3.9.2 </span>Unions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FB9" id="P7000497027000000000000000040FB9">Unions provide a way to circumvent the type system of C, allowing a single object to be referenced according to multiple types. The syntax of a union declaration is identical to that for structures, but its semantics are very different. Rather than having the different fields reference different blocks of memory, they all reference the same block.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FBA" id="P7000497027000000000000000040FBA">Consider the following declarations:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FBB" id="P7000497027000000000000000040FBB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FBC" id="P7000497027000000000000000040FBC">
struct S3 {
	char c;
	int i[2];
	double v;
};
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002D69" epub:type="pagebreak" id="P7000497027000000000000000002D69" title="270"></span>union U3 {
	char c;
	int i[2];
	double v;
};
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FBD" id="P7000497027000000000000000040FBD">When compiled on an x86-64 Linux machine, the offsets of the fields, as well as the total size of data types <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FBE" id="P7000497027000000000000000040FBE">S3</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FBF" id="P7000497027000000000000000040FBF">U3</code>, are as shown in the following table:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000040FC0" id="P7000497027000000000000000040FC0">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040FC1" id="P7000497027000000000000000040FC1">Type</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040FC2" id="P7000497027000000000000000040FC2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FC3" id="P7000497027000000000000000040FC3">c</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040FC4" id="P7000497027000000000000000040FC4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FC5" id="P7000497027000000000000000040FC5">i</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040FC6" id="P7000497027000000000000000040FC6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FC7" id="P7000497027000000000000000040FC7">v</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000040FC8" id="P7000497027000000000000000040FC8">Size</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FC9" id="P7000497027000000000000000040FC9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FCA" id="P7000497027000000000000000040FCA">S3</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FCB" id="P7000497027000000000000000040FCB">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FCC" id="P7000497027000000000000000040FCC">4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FCD" id="P7000497027000000000000000040FCD">16</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FCE" id="P7000497027000000000000000040FCE">24</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FCF" id="P7000497027000000000000000040FCF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FD0" id="P7000497027000000000000000040FD0">U3</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FD1" id="P7000497027000000000000000040FD1">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FD2" id="P7000497027000000000000000040FD2">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FD3" id="P7000497027000000000000000040FD3">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000040FD4" id="P7000497027000000000000000040FD4">8</td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FD5" id="P7000497027000000000000000040FD5">(We will see shortly why <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FD6" id="P7000497027000000000000000040FD6">i</code> has offset 4 in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FD7" id="P7000497027000000000000000040FD7">S3</code> rather than 1, and why <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FD8" id="P7000497027000000000000000040FD8">v</code> has offset 16, rather than 9 or 12.) For pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FD9" id="P7000497027000000000000000040FD9">p</code> of type union <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FDA" id="P7000497027000000000000000040FDA">U3</code> *, references <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FDB" id="P7000497027000000000000000040FDB">p-&gt;c, p-&gt;i[0]</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FDC" id="P7000497027000000000000000040FDC">p-&gt;v</code> would all reference the beginning of the data structure. Observe also that the overall size of a union equals the maximum size of any of its fields.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FDD" id="P7000497027000000000000000040FDD">Unions can be useful in several contexts. However, they can also lead to nasty bugs, since they bypass the safety provided by the C type system. One application is when we know in advance that the use of two different fields in a data structure will be mutually exclusive. Then, declaring these two fields as part of a union rather than a structure will reduce the total space allocated.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FDE" id="P7000497027000000000000000040FDE">For example, suppose we want to implement a binary tree data structure where each leaf node has two <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FDF" id="P7000497027000000000000000040FDF">double</code> data values and each internal node has pointers to two children but no data. If we declare this as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FE0" id="P7000497027000000000000000040FE0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FE1" id="P7000497027000000000000000040FE1">
struct node_s {
	struct node_s *left;
	struct node_s *right;
	double data[2];
};
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FE2" id="P7000497027000000000000000040FE2">then every node requires 32 bytes, with half the bytes wasted for each type of node. On the other hand, if we declare a node as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FE3" id="P7000497027000000000000000040FE3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FE4" id="P7000497027000000000000000040FE4">
union node_u {
	struct {
	  union node_u *left;
	  union node_u *right;
	} internal;
	double data[2];
};
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FE5" id="P7000497027000000000000000040FE5">then every node will require just 16 bytes. If <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FE6" id="P7000497027000000000000000040FE6">n</code> is a pointer to a node of type union <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FE7" id="P7000497027000000000000000040FE7">node_u *</code>, we would reference the data of a leaf node as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FE8" id="P7000497027000000000000000040FE8">n-&gt;data[0]</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FE9" id="P7000497027000000000000000040FE9">n-&gt;data[1]</code>, and the children of an internal node as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FEA" id="P7000497027000000000000000040FEA">n-&gt;internal.left</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FEB" id="P7000497027000000000000000040FEB">n-&gt;internal.right.</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FEC" id="P7000497027000000000000000040FEC"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002D9A" epub:type="pagebreak" id="P7000497027000000000000000002D9A" title="271"></span>With this encoding, however, there is no way to determine whether a given node is a leaf or an internal node. A common method is to introduce an enumerated type defining the different possible choices for the union, and then create a structure containing a tag field and the union:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FED" id="P7000497027000000000000000040FED"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FEE" id="P7000497027000000000000000040FEE">
typedef enum { N_LEAF, N_INTERNAL } nodetype_t;

struct node_t {
	nodetype_t type;
	union {
	  struct {
	  	struct node_t *left;
	  	struct node_t *right;
	  } internal;
	  double data[2];
	} info;
};
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FEF" id="P7000497027000000000000000040FEF">This structure requires a total of 24 bytes: 4 for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FF0" id="P7000497027000000000000000040FF0">type</code>, and either 8 each for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FF1" id="P7000497027000000000000000040FF1">info.internal.left</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FF2" id="P7000497027000000000000000040FF2">info.internal.right</code> or 16 for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FF3" id="P7000497027000000000000000040FF3">info.data.</code> As we will discuss shortly, an additional 4 bytes of padding is required between the field for type and the union elements, bringing the total structure size to 4 + 4 + 16 = 24. In this case, the savings gain of using a union is small relative to the awkwardness of the resulting code. For data structures with more fields, the savings can be more compelling.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FF4" id="P7000497027000000000000000040FF4">Unions can also be used to access the bit patterns of different data types. For example, suppose we use a simple cast to convert a value d of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FF5" id="P7000497027000000000000000040FF5">double</code> to a value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FF6" id="P7000497027000000000000000040FF6">u</code> of type unsigned <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FF7" id="P7000497027000000000000000040FF7">long</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000040FF8" id="P7000497027000000000000000040FF8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FF9" id="P7000497027000000000000000040FF9">
unsigned long u = (unsigned long) d;
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FFA" id="P7000497027000000000000000040FFA">Value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FFB" id="P7000497027000000000000000040FFB">u</code> will be an integer representation of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FFC" id="P7000497027000000000000000040FFC">d</code>. Except for the case where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FFD" id="P7000497027000000000000000040FFD">d</code> is 0.0, the bit representation of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FFE" id="P7000497027000000000000000040FFE">u</code> will be very different from that of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000040FFF" id="P7000497027000000000000000040FFF">d</code>. Now consider the following code to generate a value of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041000" id="P7000497027000000000000000041000">unsigned</code> long from a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041001" id="P7000497027000000000000000041001">double</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041002" id="P7000497027000000000000000041002"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041003" id="P7000497027000000000000000041003">
unsigned long double2bits(double d) {
	union {
	  double d;
	  unsigned long u;
	} temp;
	temp.d = d;
	return temp.u;
};
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041004" id="P7000497027000000000000000041004">In this code, we store the argument in the union using one data type and access it using another. The result will be that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041005" id="P7000497027000000000000000041005">u</code> will have the same bit representation as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041006" id="P7000497027000000000000000041006">d</code>, including fields for the sign bit, the exponent, and the significand, as described in <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002DB5" epub:type="pagebreak" id="P7000497027000000000000000002DB5" title="272"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003080"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.11</span></a>. The numeric value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041007" id="P7000497027000000000000000041007">u</code> will bear no relation to that of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041008" id="P7000497027000000000000000041008">d</code>, except for the case when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041009" id="P7000497027000000000000000041009">d</code> is 0.0.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004100A" id="P700049702700000000000000004100A">When using unions to combine data types of different sizes, byte-ordering issues can become important. For example, suppose we write a procedure that will create an 8-byte <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004100B" id="P700049702700000000000000004100B">double</code> using the bit patterns given by two 4-byte <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004100C" id="P700049702700000000000000004100C">unsigned</code> values:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004100D" id="P700049702700000000000000004100D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004100E" id="P700049702700000000000000004100E">
double uu2double(unsigned word0, unsigned word1)
{
	union {
	  double d;
	  unsigned u[2];
	} temp;
	temp.u[0] = word0;
	temp.u[1] = word1;
	return temp.d;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004100F" id="P700049702700000000000000004100F">On a little-endian machine, such as an x86-64 processor, argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041010" id="P7000497027000000000000000041010">word0</code> will become the low-order 4 bytes of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041011" id="P7000497027000000000000000041011">d</code>, while <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041012" id="P7000497027000000000000000041012">word1</code> will become the high-order 4 bytes. On a big-endian machine, the role of the two arguments will be reversed.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002DC2" epub:type="practice" id="P7000497027000000000000000002DC2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041013" epub:type="title" id="P7000497027000000000000000041013"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.43 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003855">344</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041014" id="P7000497027000000000000000041014">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041015" id="P7000497027000000000000000041015">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041016" id="P7000497027000000000000000041016"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041017" id="P7000497027000000000000000041017">Suppose you are given the job of checking that a C compiler generates the proper code for structure and union access. You write the following structure declaration:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041018" id="P7000497027000000000000000041018"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041019" id="P7000497027000000000000000041019">
typedef union {
	struct {
	  long u;
	  short v;
	  char w;
	} t1;
	struct {
	  int a[2];
	  char *p;
	} t2;
} u_type;
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004101A" id="P700049702700000000000000004101A">You write a series of functions of the form</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004101B" id="P700049702700000000000000004101B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004101C" id="P700049702700000000000000004101C">
void get(u_type *up, <i class="pcalibre17 pcalibre2 pcalibre1">type</i> *dest) {
	*dest = <i class="pcalibre17 pcalibre2 pcalibre1">expr</i>;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004101D" id="P700049702700000000000000004101D">with different access expressions <i class="pcalibre17 pcalibre2 pcalibre1">expr</i> and with destination data type <i class="pcalibre17 pcalibre2 pcalibre1">type</i> set according to type associated with <i class="pcalibre17 pcalibre2 pcalibre1">expr</i>. You then examine the code generated when compiling the functions to see if they match your expectations.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004101E" id="P700049702700000000000000004101E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002DCF" epub:type="pagebreak" id="P7000497027000000000000000002DCF" title="273"></span>Suppose in these functions that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004101F" id="P700049702700000000000000004101F">up</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041020" id="P7000497027000000000000000041020">dest</code> are loaded into registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041021" id="P7000497027000000000000000041021">%rdi</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041022" id="P7000497027000000000000000041022">%rsi</code>, respectively. Fill in the following table with data type <i class="pcalibre17 pcalibre2 pcalibre1">type</i> and sequences of one to three instructions to compute the expression and store the result at <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041023" id="P7000497027000000000000000041023">dest</code>.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000041024" id="P7000497027000000000000000041024">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041025" id="P7000497027000000000000000041025"><i class="pcalibre17 pcalibre2 pcalibre1">expr</i></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041026" id="P7000497027000000000000000041026"><i class="pcalibre17 pcalibre2 pcalibre1">type</i></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041027" id="P7000497027000000000000000041027">Code</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041028" id="P7000497027000000000000000041028"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041029" id="P7000497027000000000000000041029">up-&gt;t1.u</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004102A" id="P700049702700000000000000004102A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004102B" id="P700049702700000000000000004102B">long</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004102C" id="P700049702700000000000000004102C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004102D" id="P700049702700000000000000004102D">movq (%rdi), %rax</code><br class="pcalibre1 pcalibre2 pcalibre7"/><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004102E" id="P700049702700000000000000004102E">movq %rax, (%rsi)</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004102F" id="P700049702700000000000000004102F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041030" id="P7000497027000000000000000041030">up-&gt;t1.v</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041031" id="P7000497027000000000000000041031">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041032" id="P7000497027000000000000000041032">____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041033" id="P7000497027000000000000000041033"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041034" id="P7000497027000000000000000041034">up-&gt;t1.w</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041035" id="P7000497027000000000000000041035">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041036" id="P7000497027000000000000000041036">____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041037" id="P7000497027000000000000000041037"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041038" id="P7000497027000000000000000041038">up-&gt;t2.a</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041039" id="P7000497027000000000000000041039">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004103A" id="P700049702700000000000000004103A">____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004103B" id="P700049702700000000000000004103B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004103C" id="P700049702700000000000000004103C">up-&gt;t2.a[up-&gt;t1.u]</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004103D" id="P700049702700000000000000004103D">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004103E" id="P700049702700000000000000004103E">____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004103F" id="P700049702700000000000000004103F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041040" id="P7000497027000000000000000041040">*up-&gt;t2.p</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041041" id="P7000497027000000000000000041041">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041042" id="P7000497027000000000000000041042">____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________<br class="pcalibre1 pcalibre2 pcalibre7"/>____________________</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002DF4" id="P7000497027000000000000000002DF4"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041043" epub:type="title" id="P7000497027000000000000000041043"><span class="pcalibre1 pcalibre21 pcalibre2">3.9.3 </span>Data Alignment</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041044" id="P7000497027000000000000000041044">Many computer systems place restrictions on the allowable addresses for the primitive data types, requiring that the address for some objects must be a multiple of some value <var class="pcalibre17 pcalibre2 pcalibre1">K</var> (typically 2, 4, or 8). Such <i class="pcalibre17 pcalibre2 pcalibre1">alignment restrictions</i> simplify the design of the hardware forming the interface between the processor and the memory system. For example, suppose a processor always fetches 8 bytes from memory with an address that must be a multiple of 8. If we can guarantee that any double will be aligned to have its address be a multiple of 8, then the value can be read or written with a single memory operation. Otherwise, we may need to perform two memory accesses, since the object might be split across two 8-byte memory blocks.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041045" id="P7000497027000000000000000041045">The x86-64 hardware will work correctly regardless of the alignment of data. However, Intel recommends that data be aligned to improve memory system performance. Their alignment rule is based on the principle that any primitive object of <var class="pcalibre17 pcalibre2 pcalibre1">K</var> bytes must have an address that is a multiple of <var class="pcalibre17 pcalibre2 pcalibre1">K</var>. We can see that this rule leads to the following alignments:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000041046" id="P7000497027000000000000000041046">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041047" id="P7000497027000000000000000041047"><var class="pcalibre17 pcalibre2 pcalibre1">K</var></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041048" id="P7000497027000000000000000041048">Types</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041049" id="P7000497027000000000000000041049">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004104A" id="P700049702700000000000000004104A">char</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004104B" id="P700049702700000000000000004104B">2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004104C" id="P700049702700000000000000004104C">short</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004104D" id="P700049702700000000000000004104D">4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004104E" id="P700049702700000000000000004104E">int, float</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004104F" id="P700049702700000000000000004104F">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041050" id="P7000497027000000000000000041050">long, double, char *</td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041051" id="P7000497027000000000000000041051"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002E04" epub:type="pagebreak" id="P7000497027000000000000000002E04" title="274"></span>Alignment is enforced by making sure that every data type is organized and allocated in such a way that every object within the type satisfies its alignment restrictions. The compiler places directives in the assembly code indicating the desired alignment for global data. For example, the assembly-code declaration of the jump table on page 235 contains the following directive on line 2:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041052" id="P7000497027000000000000000041052"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041053" id="P7000497027000000000000000041053">
.align 8
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041054" id="P7000497027000000000000000041054">This ensures that the data following it (in this case the start of the jump table) will start with an address that is a multiple of 8. Since each table entry is 8 bytes long, the successive elements will obey the 8-byte alignment restriction.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041055" id="P7000497027000000000000000041055">For code involving structures, the compiler may need to insert gaps in the field allocation to ensure that each structure element satisfies its alignment requirement. The structure will then have some required alignment for its starting address.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041056" id="P7000497027000000000000000041056">For example, consider the structure declaration</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041057" id="P7000497027000000000000000041057"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041058" id="P7000497027000000000000000041058">
struct S1 {
	int i;
	char c;
	int j;
};
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041059" id="P7000497027000000000000000041059">Suppose the compiler used the minimal 9-byte allocation, diagrammed as follows:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002E0D" id="P7000497027000000000000000002E0D">
<img alt="A diagram shows three fields: offset 0 to 4 with contents i; offset 4 to 5 with contents c; offset 5 to 9 with contents j." class="pcalibre1 pcalibre2 pcalibre133" data-uri="P700049702700000000000000000B6BE" id="P700049702700000000000000004105A" src="Images/chapter-03-image-10.png"/>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004105B" id="P700049702700000000000000004105B">Then it would be impossible to satisfy the 4-byte alignment requirement for both fields <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004105C" id="P700049702700000000000000004105C">i</code> (offset 0) and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004105D" id="P700049702700000000000000004105D">j</code> (offset 5). Instead, the compiler inserts a 3-byte gap (shown here as shaded in blue) between fields <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004105E" id="P700049702700000000000000004105E">c</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004105F" id="P700049702700000000000000004105F">j</code>:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002E14" id="P7000497027000000000000000002E14">
<img alt="A diagram shows four fields: offset 0 to 4 with contents i; offset 4 to 5 with contents c; offset 5 to 8 with a blue gap; offset 8 to 12 with contents j." class="pcalibre1 pcalibre134 pcalibre2" data-uri="P700049702700000000000000000B6BF" id="P7000497027000000000000000041060" src="Images/chapter-03-image-11.png"/>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041061" id="P7000497027000000000000000041061">As a result, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041062" id="P7000497027000000000000000041062">j</code> has offset 8, and the overall structure size is 12 bytes. Furthermore, the compiler must ensure that any pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041063" id="P7000497027000000000000000041063">p</code> of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041064" id="P7000497027000000000000000041064">struct S1*</code> satisfies a 4-byte alignment. Using our earlier notation, let pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041065" id="P7000497027000000000000000041065">p</code> have value <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000041066" id="P7000497027000000000000000041066">p</code></sub>. Then <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000041067" id="P7000497027000000000000000041067">p</code></sub> must be a multiple of 4. This guarantees that both <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041068" id="P7000497027000000000000000041068">p-&gt;i</code> (address <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000041069" id="P7000497027000000000000000041069">p</code></sub>) and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004106A" id="P700049702700000000000000004106A">p-&gt;j</code> (address <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P700049702700000000000000004106B" id="P700049702700000000000000004106B">p</code></sub> + 8) will satisfy their 4-byte alignment requirements.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004106C" id="P700049702700000000000000004106C">In addition, the compiler may need to add padding to the end of the structure so that each element in an array of structures will satisfy its alignment requirement. For example, consider the following structure declaration:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004106D" id="P700049702700000000000000004106D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004106E" id="P700049702700000000000000004106E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002E24" epub:type="pagebreak" id="P7000497027000000000000000002E24" title="275"></span>struct S2 {
	int i;
	int j;
	char c;
};
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004106F" id="P700049702700000000000000004106F">If we pack this structure into 9 bytes, we can still satisfy the alignment requirements for fields <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041070" id="P7000497027000000000000000041070">i</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041071" id="P7000497027000000000000000041071">j</code> by making sure that the starting address of the structure satisfies a 4-byte alignment requirement. Consider, however, the following declaration:</p>
<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041072" id="P7000497027000000000000000041072">struct S2 d[4];</code>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041073" id="P7000497027000000000000000041073">With the 9-byte allocation, it is not possible to satisfy the alignment requirement for each element of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041074" id="P7000497027000000000000000041074">d</code>, because these elements will have addresses <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000041075" id="P7000497027000000000000000041075">d</code></sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000041076" id="P7000497027000000000000000041076">d</code></sub> + 9, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000041077" id="P7000497027000000000000000041077">d</code></sub> + 18, and <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000041078" id="P7000497027000000000000000041078">d</code></sub> + 27. Instead, the compiler allocates 12 bytes for structure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041079" id="P7000497027000000000000000041079">S2</code>, with the final 3 bytes being wasted space:</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002E30" id="P7000497027000000000000000002E30">
<img alt="A diagram shows four fields: offset 0 to 4 with contents i; offset 4 to 8 with contents j; offset 8 to 9 with contents c; offset 9 to 12 with a blue gap." class="pcalibre1 pcalibre134 pcalibre2" data-uri="P700049702700000000000000000B6C0" id="P700049702700000000000000004107A" src="Images/chapter-03-image-12.png"/>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004107B" id="P700049702700000000000000004107B">That way, the elements of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004107C" id="P700049702700000000000000004107C">d</code> will have addresses <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P700049702700000000000000004107D" id="P700049702700000000000000004107D">d</code></sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P700049702700000000000000004107E" id="P700049702700000000000000004107E">d</code></sub> + 12, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P700049702700000000000000004107F" id="P700049702700000000000000004107F">d</code></sub> + 24, and <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000041080" id="P7000497027000000000000000041080">d</code></sub> + 36. As long as <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14"><code class="pcalibre1 pcalibre2 pcalibre110" data-uri="chapter03.xhtml#P7000497027000000000000000041081" id="P7000497027000000000000000041081">d</code></sub> is a multiple of 4, all of the alignment restrictions will be satisfied.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002E39" epub:type="practice" id="P7000497027000000000000000002E39"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041082" epub:type="title" id="P7000497027000000000000000041082"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.44 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P700049702700000000000000000389F">345</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041083" id="P7000497027000000000000000041083">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041084" id="P7000497027000000000000000041084">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041085" id="P7000497027000000000000000041085"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041086" id="P7000497027000000000000000041086">For each of the following structure declarations, determine the offset of each field, the total size of the structure, and its alignment requirement for x86-64:</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041087" id="P7000497027000000000000000041087">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041088" id="P7000497027000000000000000041088"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041089" id="P7000497027000000000000000041089"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004108A" id="P700049702700000000000000004108A">struct P1 { int i; char c; int j; char d; };</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004108B" id="P700049702700000000000000004108B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004108C" id="P700049702700000000000000004108C"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004108D" id="P700049702700000000000000004108D">struct P2 { int i; char c; char d; long j; };</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004108E" id="P700049702700000000000000004108E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004108F" id="P700049702700000000000000004108F"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041090" id="P7000497027000000000000000041090">struct P3 { short w[3]; char c[3] };</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041091" id="P7000497027000000000000000041091"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041092" id="P7000497027000000000000000041092"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041093" id="P7000497027000000000000000041093">struct P4 { short w[5]; char *c[3] };</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041094" id="P7000497027000000000000000041094"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041095" id="P7000497027000000000000000041095"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041096" id="P7000497027000000000000000041096">struct P5 { struct P3 a[2]; struct P2 t };</code></p></li>
</ol>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002E4F" epub:type="practice" id="P7000497027000000000000000002E4F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041097" epub:type="title" id="P7000497027000000000000000041097"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.45 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P700049702700000000000000000389F">345</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041098" id="P7000497027000000000000000041098">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041099" id="P7000497027000000000000000041099">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004109A" id="P700049702700000000000000004109A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004109B" id="P700049702700000000000000004109B">Answer the following for the structure declaration</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004109C" id="P700049702700000000000000004109C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004109D" id="P700049702700000000000000004109D">
struct {
	char	*a;
	short	b;
	double	c;
	char	d;
	float	e;
	char	f;
</code></pre>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000002E57" id="P7000497027000000000000000002E57"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P700049702700000000000000004109E" epub:type="title" id="P700049702700000000000000004109E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002E59" epub:type="pagebreak" id="P7000497027000000000000000002E59" title="276"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>A case of mandatory alignment</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004109F" id="P700049702700000000000000004109F">For most x86-64 instructions, keeping data aligned improves efficiency, but it does not affect program behavior. On the other hand, some models of Intel and AMD processors will not work correctly with unaligned data for some of the SSE instructions implementing multimedia operations. These instructions operate on 16-byte blocks of data, and the instructions that transfer data between the SSE unit and memory require the memory addresses to be multiples of 16. Any attempt to access memory with an address that does not satisfy this alignment will lead to an <i class="pcalibre17 pcalibre2 pcalibre1">exception</i> (see <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000066A6.xhtml#P70004970270000000000000000066A6"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">8.1</span></a>), with the default behavior for the program to terminate.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410A0" id="P70004970270000000000000000410A0">As a result, any compiler and run-time system for an x86-64 processor must ensure that any memory allocated to hold a data structure that may be read from or stored into an SSE register must satisfy a 16-byte alignment. This requirement has the following two consequences:</p>
<ul class="pcalibre1 pcalibre2 pcalibre117" data-uri="chapter03.xhtml#P70004970270000000000000000410A1" id="P70004970270000000000000000410A1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410A2" id="P70004970270000000000000000410A2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410A3" id="P70004970270000000000000000410A3">The starting address for any block generated by a memory allocation function (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410A4" id="P70004970270000000000000000410A4">alloca, malloc, calloc</code>, or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410A5" id="P70004970270000000000000000410A5">realloc</code>) must be a multiple of 16.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410A6" id="P70004970270000000000000000410A6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410A7" id="P70004970270000000000000000410A7">The stack frame for most functions must be aligned on a 16-byte boundary. (This requirement has a number of exceptions.)</p></li>
</ul>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410A8" id="P70004970270000000000000000410A8">More recent versions of x86-64 processors implement the AVX multimedia instructions. In addition to providing a superset of the SSE instructions, processors supporting AVX also do not have a mandatory alignment requirement.</p>
</aside>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410A9" id="P70004970270000000000000000410A9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410AA" id="P70004970270000000000000000410AA">
long	g;
int	h;
} rec;
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000410AB" id="P70004970270000000000000000410AB">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410AC" id="P70004970270000000000000000410AC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410AD" id="P70004970270000000000000000410AD">What are the byte offsets of all the fields in the structure?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410AE" id="P70004970270000000000000000410AE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410AF" id="P70004970270000000000000000410AF">What is the total size of the structure?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410B0" id="P70004970270000000000000000410B0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410B1" id="P70004970270000000000000000410B1">Rearrange the fields of the structure to minimize wasted space, and then show the byte offsets and total size for the rearranged structure.</p></li>
</ol>
</div></li></ol>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.10 Combining Control and Data in Machine-Level Programs</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000002E6D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P70004970270000000000000000410B2" epub:type="title" id="P70004970270000000000000000410B2"><span class="pcalibre1 pcalibre21 pcalibre2">3.10 </span>Combining Control and Data in Machine-Level Programs</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410B3" id="P70004970270000000000000000410B3">So far, we have looked separately at how machine-level code implements the control aspects of a program and how it implements different data structures. In this section, we look at ways in which data and control interact with each other. We start by taking a deep look into pointers, one of the most important concepts in the C programming language, but one for which many programmers only have a shallow understanding. We review the use of the symbolic debugger <span class="pcalibre1 pcalibre29 pcalibre2">gdb</span> for examining the detailed operation of machine-level programs. Next, we see how understanding machine-level programs enables us to study buffer overflow, an important security vulnerability in many real-world systems. Finally, we examine <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002E70" epub:type="pagebreak" id="P7000497027000000000000000002E70" title="277"></span>how machine-level programs implement cases where the amount of stack storage required by a function can vary from one execution to another.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002E71" id="P7000497027000000000000000002E71"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410B4" epub:type="title" id="P70004970270000000000000000410B4"><span class="pcalibre1 pcalibre21 pcalibre2">3.10.1 </span>Understanding Pointers</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410B5" id="P70004970270000000000000000410B5">Pointers are a central feature of the C programming language. They serve as a uniform way to generate references to elements within different data structures. Pointers are a source of confusion for novice programmers, but the underlying concepts are fairly simple. Here we highlight some key principles of pointers and their mapping into machine code.</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410B6" id="P70004970270000000000000000410B6">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410B7" id="P70004970270000000000000000410B7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410B8" id="P70004970270000000000000000410B8"><span class="pcalibre1 pcalibre2 pcalibre41">Every pointer has an associated type. </span>This type indicates what kind of object the pointer points to. Using the following pointer declarations as illustrations</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410B9" id="P70004970270000000000000000410B9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410BA" id="P70004970270000000000000000410BA">
int *ip; char **cpp;
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410BB" id="P70004970270000000000000000410BB">variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410BC" id="P70004970270000000000000000410BC">ip</code> is a pointer to an object of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410BD" id="P70004970270000000000000000410BD">int</code>, while <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410BE" id="P70004970270000000000000000410BE">cpp</code> is a pointer to an object that itself is a pointer to an object of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410BF" id="P70004970270000000000000000410BF">char</code>. In general, if the object has type <var class="pcalibre17 pcalibre2 pcalibre1">T</var>, then the pointer has type *<var class="pcalibre17 pcalibre2 pcalibre1">T</var>. The special <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410C0" id="P70004970270000000000000000410C0">void</code> * type represents a generic pointer. For example, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410C1" id="P70004970270000000000000000410C1">malloc</code> function returns a generic pointer, which is converted to a typed pointer via either an explicit cast or by the implicit casting of the assignment operation. Pointer types are not part of machine code; they are an abstraction provided by C to help programmers avoid addressing errors.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410C2" id="P70004970270000000000000000410C2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410C3" id="P70004970270000000000000000410C3"><span class="pcalibre1 pcalibre2 pcalibre41">Every pointer has a value. </span>This value is an address of some object of the designated type. The special <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410C4" id="P70004970270000000000000000410C4">NULL (0)</code> value indicates that the pointer does not point anywhere.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410C5" id="P70004970270000000000000000410C5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410C6" id="P70004970270000000000000000410C6"><span class="pcalibre1 pcalibre2 pcalibre41">Pointers are created with the `&amp;' operator. </span>This operator can be applied to any C expression that is categorized as an <i class="pcalibre17 pcalibre2 pcalibre1">lvalue</i>, meaning an expression that can appear on the left side of an assignment. Examples include variables and the elements of structures, unions, and arrays. We have seen that the machine-code realization of the `&amp;' operator often uses the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410C7" id="P70004970270000000000000000410C7">leaq</code> instruction to compute the expression value, since this instruction is designed to compute the address of a memory reference.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410C8" id="P70004970270000000000000000410C8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410C9" id="P70004970270000000000000000410C9"><span class="pcalibre1 pcalibre2 pcalibre41">Pointers are dereferenced with the `*' operator. </span>The result is a value having the type associated with the pointer. Dereferencing is implemented by a memory reference, either storing to or retrieving from the specified address.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410CA" id="P70004970270000000000000000410CA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410CB" id="P70004970270000000000000000410CB"><span class="pcalibre1 pcalibre2 pcalibre41">Arrays and pointers are closely related. </span>The name of an array canbe referenced (but not updated) as if it were a pointer variable. Array referencing (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410CC" id="P70004970270000000000000000410CC">a[3]</code>) has the exact same effect as pointer arithmetic and dereferencing (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410CD" id="P70004970270000000000000000410CD">*(a+3)</code>). Both array referencing and pointer arithmetic require scaling the offsets by the object size. When we write an expression <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410CE" id="P70004970270000000000000000410CE">p+i</code> for pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410CF" id="P70004970270000000000000000410CF">p</code> with value <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410D0" id="P70004970270000000000000000410D0"><var class="pcalibre17 pcalibre2 pcalibre1">p</var></code>, the resulting address is computed as <i class="pcalibre17 pcalibre2 pcalibre1"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410D1" id="P70004970270000000000000000410D1">p</code></i> + <var class="pcalibre17 pcalibre2 pcalibre1">L</var> · <var class="pcalibre17 pcalibre2 pcalibre1">i</var>, where <var class="pcalibre17 pcalibre2 pcalibre1">L</var> is the size of the data type associated with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410D2" id="P70004970270000000000000000410D2">p</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410D3" id="P70004970270000000000000000410D3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410D4" id="P70004970270000000000000000410D4"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002E93" epub:type="pagebreak" id="P7000497027000000000000000002E93" title="278"></span><span class="pcalibre1 pcalibre2 pcalibre41">Casting from one type of pointer to another changes its type but not its value. </span>One effect of casting is to change any scaling of pointer arithmetic. So, for example, if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410D5" id="P70004970270000000000000000410D5">p</code> is a pointer of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410D6" id="P70004970270000000000000000410D6">char</code> * having value <i class="pcalibre17 pcalibre2 pcalibre1"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410D7" id="P70004970270000000000000000410D7">p</code></i>, then the expression (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410D8" id="P70004970270000000000000000410D8">int *) p+7</code> computes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410D9" id="P70004970270000000000000000410D9"><var class="pcalibre17 pcalibre2 pcalibre1">p</var></code> + 28, while <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410DA" id="P70004970270000000000000000410DA">(int *) (p+7)</code> computes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410DB" id="P70004970270000000000000000410DB"><var class="pcalibre17 pcalibre2 pcalibre1">p</var> + 7</code>. (Recall that casting has higher precedence than addition.)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410DC" id="P70004970270000000000000000410DC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410DD" id="P70004970270000000000000000410DD"><span class="pcalibre1 pcalibre2 pcalibre41">Pointers can also point to functions. </span>This provides a powerful capability for storing and passing references to code, which can be invoked in some other part of the program. For example, if we have a function defined by the prototype</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410DE" id="P70004970270000000000000000410DE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410DF" id="P70004970270000000000000000410DF">
int fun(int x, int *p);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410E0" id="P70004970270000000000000000410E0">then we can declare and assign a pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410E1" id="P70004970270000000000000000410E1">fp</code> to this function by the following code sequence:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410E2" id="P70004970270000000000000000410E2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410E3" id="P70004970270000000000000000410E3">int (*fp)(int, int *); fp = fun;
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410E4" id="P70004970270000000000000000410E4">We can then invoke the function using this pointer:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410E5" id="P70004970270000000000000000410E5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410E6" id="P70004970270000000000000000410E6">
int y = 1;
int result = fp(3, &amp;y);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410E7" id="P70004970270000000000000000410E7">The value of a function pointer is the address of the first instruction in the machine-code representation of the function.</p></li>
</ul>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000002EA7" id="P7000497027000000000000000002EA7"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P70004970270000000000000000410E8" epub:type="title" id="P70004970270000000000000000410E8"><span class="pcalibre1 pcalibre2 pcalibre34">New to C? </span>Function pointers</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000410E9" id="P70004970270000000000000000410E9">The syntax for declaring function pointers is especially difficult for novice programmers to understand. For a declaration such as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410EA" id="P70004970270000000000000000410EA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410EB" id="P70004970270000000000000000410EB">
int (*f)(int*);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000410EC" id="P70004970270000000000000000410EC">it helps to read it starting from the inside (starting with `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410ED" id="P70004970270000000000000000410ED">f</code>') and working outward. Thus, we see that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410EE" id="P70004970270000000000000000410EE">f</code> is a pointer, as indicated by (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410EF" id="P70004970270000000000000000410EF">*f</code>). It is a pointer to a function that has a single <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410F0" id="P70004970270000000000000000410F0">int</code> * as an argument, as indicated by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410F1" id="P70004970270000000000000000410F1">(*f)(int*)</code>. Finally, we see that it is a pointer to a function that takes an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410F2" id="P70004970270000000000000000410F2">int</code> * as an argument and returns <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410F3" id="P70004970270000000000000000410F3">int</code>.</p>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000410F4" id="P70004970270000000000000000410F4">The parentheses around *<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410F5" id="P70004970270000000000000000410F5">f</code> are required, because otherwise the declaration</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410F6" id="P70004970270000000000000000410F6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410F7" id="P70004970270000000000000000410F7">
int *f(int*);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000410F8" id="P70004970270000000000000000410F8">would be read as</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000410F9" id="P70004970270000000000000000410F9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410FA" id="P70004970270000000000000000410FA">
(int *) f(int*);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000410FB" id="P70004970270000000000000000410FB">That is, it would be interpreted as a function prototype, declaring a function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410FC" id="P70004970270000000000000000410FC">f</code> that has an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410FD" id="P70004970270000000000000000410FD">int</code> * as its argument and returns an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000410FE" id="P70004970270000000000000000410FE">int</code> *.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000410FF" id="P70004970270000000000000000410FF">Kernighan and Ritchie <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B41C">[61,</a> Sect. 5.12] present a helpful tutorial on reading C declarations.</p>
</aside>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002EC0" id="P7000497027000000000000000002EC0"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041100" epub:type="title" id="P7000497027000000000000000041100"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002EC2" epub:type="pagebreak" id="P7000497027000000000000000002EC2" title="279"></span><span class="pcalibre1 pcalibre21 pcalibre2">3.10.2 </span>Life in the Real World: Using the <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>Debugger</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041101" id="P7000497027000000000000000041101">The GNU debugger <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>provides a number of useful features to support the run-time evaluation and analysis of machine-level programs. With the examples and exercises in this book, we attempt to infer the behavior of a program by just looking at the code. Using <span class="pcalibre1 pcalibre29 pcalibre2">gdb</span>, it becomes possible to study the behavior by watching the program in action while having considerable control over its execution.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041102" id="P7000497027000000000000000041102"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002ED2"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.39</span></a> shows examples of some <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>commands that help when working with machine-level x86-64 programs. It is very helpful to first run <span class="pcalibre1 pcalibre29 pcalibre2">objdump </span>to get a disassembled version of the program. Our examples are based on running <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>on the file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041103" id="P7000497027000000000000000041103">prog</code>, described and disassembled on page 175. We start <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>with the following command line:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041104" id="P7000497027000000000000000041104"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041105" id="P7000497027000000000000000041105">
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gdb prog</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041106" id="P7000497027000000000000000041106">The general scheme is to set breakpoints near points of interest in the program. These can be set to just after the entry of a function or at a program address. When one of the breakpoints is hit during program execution, the program will halt and return control to the user. From a breakpoint, we can examine different registers and memory locations in various formats. We can also single-step the program, running just a few instructions at a time, or we can proceed to the next breakpoint.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041107" id="P7000497027000000000000000041107">As our examples suggest, <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>has an obscure command syntax, but the online help information (invoked within <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041108" id="P7000497027000000000000000041108">help</code> command) overcomes this shortcoming. Rather than using the command-line interface to <span class="pcalibre1 pcalibre29 pcalibre2">gdb</span>, many programmers prefer using <span class="pcalibre1 pcalibre29 pcalibre2">ddd</span>, an extension to <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>that provides a graphical user interface.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002ECB" id="P7000497027000000000000000002ECB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041109" epub:type="title" id="P7000497027000000000000000041109"><span class="pcalibre1 pcalibre21 pcalibre2">3.10.3 </span>Out-of-Bounds Memory References and Buffer Overflow</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004110A" id="P700049702700000000000000004110A">We have seen that C does not perform any bounds checking for array references, and that local variables are stored on the stack along with state information such as saved register values and return addresses. This combination can lead to serious program errors, where the state stored on the stack gets corrupted by a write to an out-of-bounds array element. When the program then tries to reload the register or execute a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004110B" id="P700049702700000000000000004110B">ret</code> instruction with this corrupted state, things can go seriously wrong.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004110C" id="P700049702700000000000000004110C">A particularly common source of state corruption is known as <i class="pcalibre17 pcalibre2 pcalibre1">buffer overflow</i>. Typically, some character array is allocated on the stack to hold a string, but the size of the string exceeds the space allocated for the array. This is demonstrated by the following program example:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004110D" id="P700049702700000000000000004110D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004110E" id="P700049702700000000000000004110E">
/* Implementation of library function gets() */
char *gets(char *s)
{
	int c;
	char *dest = s;
</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002ED2" id="P7000497027000000000000000002ED2">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P700049702700000000000000004110F" id="P700049702700000000000000004110F">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041110" id="P7000497027000000000000000041110"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002ED5" epub:type="pagebreak" id="P7000497027000000000000000002ED5" title="280"></span>Command</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041111" id="P7000497027000000000000000041111">Effect</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" colspan="2" data-uri="chapter03.xhtml#P7000497027000000000000000041112" id="P7000497027000000000000000041112">Starting and stopping</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041113" id="P7000497027000000000000000041113"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041114" id="P7000497027000000000000000041114">quit</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041115" id="P7000497027000000000000000041115">Exit <span class="pcalibre1 pcalibre2 pcalibre84">gdb</span></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041116" id="P7000497027000000000000000041116"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041117" id="P7000497027000000000000000041117">run</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041118" id="P7000497027000000000000000041118">Run your program (give command-line arguments here)</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041119" id="P7000497027000000000000000041119"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004111A" id="P700049702700000000000000004111A">kill</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004111B" id="P700049702700000000000000004111B">Stop your program</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" colspan="2" data-uri="chapter03.xhtml#P700049702700000000000000004111C" id="P700049702700000000000000004111C">Breakpoints</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004111D" id="P700049702700000000000000004111D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004111E" id="P700049702700000000000000004111E">break multstore</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004111F" id="P700049702700000000000000004111F">Set breakpoint at entry to function multstore</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041120" id="P7000497027000000000000000041120"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041121" id="P7000497027000000000000000041121">break *0x400540</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041122" id="P7000497027000000000000000041122">Set breakpoint at address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041123" id="P7000497027000000000000000041123">0x400540</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041124" id="P7000497027000000000000000041124"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041125" id="P7000497027000000000000000041125">delete 1</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041126" id="P7000497027000000000000000041126">Delete breakpoint 1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041127" id="P7000497027000000000000000041127"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041128" id="P7000497027000000000000000041128">delete</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041129" id="P7000497027000000000000000041129">Delete all breakpoints</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" colspan="2" data-uri="chapter03.xhtml#P700049702700000000000000004112A" id="P700049702700000000000000004112A">Execution</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004112B" id="P700049702700000000000000004112B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004112C" id="P700049702700000000000000004112C">stepi</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004112D" id="P700049702700000000000000004112D">Execute one instruction</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004112E" id="P700049702700000000000000004112E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004112F" id="P700049702700000000000000004112F">stepi 4</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041130" id="P7000497027000000000000000041130">Execute four instructions</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041131" id="P7000497027000000000000000041131"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041132" id="P7000497027000000000000000041132">nexti</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041133" id="P7000497027000000000000000041133">Like <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041134" id="P7000497027000000000000000041134">stepi</code>, but proceed through function calls</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041135" id="P7000497027000000000000000041135"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041136" id="P7000497027000000000000000041136">continue</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041137" id="P7000497027000000000000000041137">Resume execution</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041138" id="P7000497027000000000000000041138"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041139" id="P7000497027000000000000000041139">finish</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004113A" id="P700049702700000000000000004113A">Run until current function returns</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" colspan="2" data-uri="chapter03.xhtml#P700049702700000000000000004113B" id="P700049702700000000000000004113B">Examining code</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004113C" id="P700049702700000000000000004113C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004113D" id="P700049702700000000000000004113D">disas</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004113E" id="P700049702700000000000000004113E">Disassemble current function</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004113F" id="P700049702700000000000000004113F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041140" id="P7000497027000000000000000041140">disas multstore</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041141" id="P7000497027000000000000000041141">Disassemble function <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041142" id="P7000497027000000000000000041142">multstore</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041143" id="P7000497027000000000000000041143"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041144" id="P7000497027000000000000000041144">disas 0x400544</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041145" id="P7000497027000000000000000041145">Disassemble function around address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041146" id="P7000497027000000000000000041146">0x400544</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041147" id="P7000497027000000000000000041147"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041148" id="P7000497027000000000000000041148">disas 0x400540, 0x40054d</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041149" id="P7000497027000000000000000041149">Disassemble code within specified address range</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004114A" id="P700049702700000000000000004114A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004114B" id="P700049702700000000000000004114B">print /x $rip</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004114C" id="P700049702700000000000000004114C">Print program counter in hex</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" colspan="2" data-uri="chapter03.xhtml#P700049702700000000000000004114D" id="P700049702700000000000000004114D">Examining data</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004114E" id="P700049702700000000000000004114E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004114F" id="P700049702700000000000000004114F">print $rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041150" id="P7000497027000000000000000041150">Print contents of <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041151" id="P7000497027000000000000000041151">%rax</code> in decimal</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041152" id="P7000497027000000000000000041152"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041153" id="P7000497027000000000000000041153">print /x $rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041154" id="P7000497027000000000000000041154">Print contents of <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041155" id="P7000497027000000000000000041155">%rax</code> in hex</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041156" id="P7000497027000000000000000041156"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041157" id="P7000497027000000000000000041157">print /t $rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041158" id="P7000497027000000000000000041158">Print contents of <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041159" id="P7000497027000000000000000041159">%rax</code> in binary</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004115A" id="P700049702700000000000000004115A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004115B" id="P700049702700000000000000004115B">print 0x100</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004115C" id="P700049702700000000000000004115C">Print decimal representation of <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004115D" id="P700049702700000000000000004115D">0x100</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004115E" id="P700049702700000000000000004115E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004115F" id="P700049702700000000000000004115F">print /x 555</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041160" id="P7000497027000000000000000041160">Print hex representation of 555</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041161" id="P7000497027000000000000000041161"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041162" id="P7000497027000000000000000041162">print /x ($rsp+8)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041163" id="P7000497027000000000000000041163">Print contents of <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041164" id="P7000497027000000000000000041164">%rsp</code> plus 8 in hex</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041165" id="P7000497027000000000000000041165"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041166" id="P7000497027000000000000000041166">print *(long *) 0x7fffffffe818</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041167" id="P7000497027000000000000000041167">Print long integer at address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041168" id="P7000497027000000000000000041168">0x7fffffffe818</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041169" id="P7000497027000000000000000041169"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004116A" id="P700049702700000000000000004116A">print *(long *) ($rsp+8)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004116B" id="P700049702700000000000000004116B">Print long integer at address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004116C" id="P700049702700000000000000004116C">%rsp</code> + 8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004116D" id="P700049702700000000000000004116D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004116E" id="P700049702700000000000000004116E">x/2g 0x7fffffffe818</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004116F" id="P700049702700000000000000004116F">Examine two (8-byte) words starting at address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041170" id="P7000497027000000000000000041170">0x7fffffffe818</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041171" id="P7000497027000000000000000041171"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041172" id="P7000497027000000000000000041172">x/20b multstore</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041173" id="P7000497027000000000000000041173">Examine first 20 bytes of function <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041174" id="P7000497027000000000000000041174">multstore</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" colspan="2" data-uri="chapter03.xhtml#P7000497027000000000000000041175" id="P7000497027000000000000000041175">Useful information</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041176" id="P7000497027000000000000000041176"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041177" id="P7000497027000000000000000041177">info frame</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041178" id="P7000497027000000000000000041178">Information about current stack frame</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041179" id="P7000497027000000000000000041179"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004117A" id="P700049702700000000000000004117A">info registers</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004117B" id="P700049702700000000000000004117B">Values of all the registers</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004117C" id="P700049702700000000000000004117C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004117D" id="P700049702700000000000000004117D">help</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004117E" id="P700049702700000000000000004117E">Get information about <span class="pcalibre1 pcalibre2 pcalibre84">gdb</span></td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P700049702700000000000000004117F" id="P700049702700000000000000004117F"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000041180" epub:type="title" id="P7000497027000000000000000041180"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.39 </span>Example <span class="pcalibre1 pcalibre2 pcalibre84">gdb </span>commands.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041181" id="P7000497027000000000000000041181"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041182" id="P7000497027000000000000000041182">These examples illustrate some of the ways <span class="pcalibre1 pcalibre2 pcalibre84">gdb </span>supports debugging of machine-level programs.</p></div></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002F48" id="P7000497027000000000000000002F48">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002F49" epub:type="pagebreak" id="P7000497027000000000000000002F49" title="281"></span>
<img alt="A diagram illustrates a stack organization for echo function." class="pcalibre1 pcalibre2 pcalibre135" data-uri="P700049702700000000000000000B6C1" id="P7000497027000000000000000041183" src="Images/chapter-03-image-13.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041184" id="P7000497027000000000000000041184"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000041185" epub:type="title" id="P7000497027000000000000000041185"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.40 </span>Stack organization for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041186" id="P7000497027000000000000000041186">echo</code> function.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041187" id="P7000497027000000000000000041187"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041188" id="P7000497027000000000000000041188">Character array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041189" id="P7000497027000000000000000041189">buf</code> is just part of the saved state. An out-of-bounds write to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004118A" id="P700049702700000000000000004118A">buf</code> can corrupt the program state.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P7000497027000000000000000021461" id="P7000497027000000000000000021461">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004118B" id="P700049702700000000000000004118B">A diagram has two parts, from bottom to top:</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004118C" id="P700049702700000000000000004118C">Stack frame for echo with buf = %rsp at the bottom containing [7][6][5][4][3][2][1][0]</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004118D" id="P700049702700000000000000004118D">Stack frame for caller with %rsp+24 on bottom containing Return address</p>
</details>
</figcaption></figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004118E" id="P700049702700000000000000004118E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004118F" id="P700049702700000000000000004118F">
while ((c = getchar()) != `n' &amp;&amp; c != EOF)
	*dest++ = c;
if (c == EOF &amp;&amp; dest == s)
	/* No characters read */
	return NULL;
*dest++ = `0'; /* Terminate string */
return s;
}
/* Read input line and write it back */
void echo()
{
	char buf[8]; /* Way too small! */
	gets(buf);
	puts(buf);
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041190" id="P7000497027000000000000000041190">The preceding code shows an implementation of the library function gets to demonstrate a serious problem with this function. It reads a line from the standard input, stopping when either a terminating newline character or some error condition is encountered. It copies this string to the location designated by argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041191" id="P7000497027000000000000000041191">s</code> and terminates the string with a null character. We show the use of gets in the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041192" id="P7000497027000000000000000041192">echo</code>, which simply reads a line from standard input and echos it back to standard output.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041193" id="P7000497027000000000000000041193">The problem with gets is that it has no way to determine whether sufficient space has been allocated to hold the entire string. In our <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041194" id="P7000497027000000000000000041194">echo</code> example, we have purposely made the buffer very small—just eight characters long. Any string longer than seven characters will cause an out-of-bounds write.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041195" id="P7000497027000000000000000041195">By examining the assembly code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041196" id="P7000497027000000000000000041196">echo</code>, we can infer how the stack is organized:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041197" id="P7000497027000000000000000041197"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041198" id="P7000497027000000000000000041198">
	<i class="pcalibre17 pcalibre2 pcalibre1">void echo()</i>
1	echo:
2	subq	$24, %rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Allocate 24 bytes on stack</i>
3	movq	%rsp, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Compute buf as %rsp</i>
4	call	gets		<i class="pcalibre17 pcalibre2 pcalibre1">Call gets</i>
5	movq	%rsp, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Compute buf as %rsp</i>
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002F5D" epub:type="pagebreak" id="P7000497027000000000000000002F5D" title="282"></span>6	call	puts		<i class="pcalibre17 pcalibre2 pcalibre1">Call puts</i>
7	addq	$24, %rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Deallocate stack space</i>
8	ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041199" id="P7000497027000000000000000041199"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002F48"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.40</span></a> illustrates the stack organization during the execution of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004119A" id="P700049702700000000000000004119A">echo</code>. The program allocates 24 bytes on the stack by subtracting 24 from the stack pointer (line 2). Character <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004119B" id="P700049702700000000000000004119B">buf</code> is positioned at the top of the stack, as can be seen by the fact that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004119C" id="P700049702700000000000000004119C">%rsp</code> is copied to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004119D" id="P700049702700000000000000004119D">%rdi</code> to be used as the argument to the calls to both gets and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004119E" id="P700049702700000000000000004119E">puts</code>. The 16 bytes between <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004119F" id="P700049702700000000000000004119F">buf</code> and the stored return pointer are not used. As long as the user types at most seven characters, the string returned by gets (including the terminating null) will fit within the space allocated for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411A0" id="P70004970270000000000000000411A0">buf</code>. A longer string, however, will cause gets to overwrite some of the information stored on the stack. As the string gets longer, the following information will get corrupted:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000411A1" id="P70004970270000000000000000411A1">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000411A2" id="P70004970270000000000000000411A2">Characters typed</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000411A3" id="P70004970270000000000000000411A3">Additional corrupted state</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411A4" id="P70004970270000000000000000411A4">0–7</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411A5" id="P70004970270000000000000000411A5">None</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411A6" id="P70004970270000000000000000411A6">9–23</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411A7" id="P70004970270000000000000000411A7">Unused stack space</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411A8" id="P70004970270000000000000000411A8">24–31</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411A9" id="P70004970270000000000000000411A9">Return address</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411AA" id="P70004970270000000000000000411AA">32+</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411AB" id="P70004970270000000000000000411AB">Saved state in caller</td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411AC" id="P70004970270000000000000000411AC">No serious consequence occurs for strings of up to 23 characters, but beyond that, the value of the return pointer, and possibly additional saved state, will be corrupted. If the stored value of the return address is corrupted, then the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411AD" id="P70004970270000000000000000411AD">ret</code> instruction (line 8) will cause the program to jump to a totally unexpected location. None of these behaviors would seem possible based on the C code. The impact of out-of-bounds writing to memory by functions such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411AE" id="P70004970270000000000000000411AE">gets</code> can only be understood by studying the program at the machine-code level.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411AF" id="P70004970270000000000000000411AF">Our code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411B0" id="P70004970270000000000000000411B0">echo</code> is simple but sloppy. A better version involves using the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411B1" id="P70004970270000000000000000411B1">fgets</code>, which includes as an argument a count on the maximum number of bytes to read. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000032E1.xhtml#P70004970270000000000000000033FE"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.71</span></a> asks you to write an echo function that can handle an input string of arbitrary length. In general, using <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411B2" id="P70004970270000000000000000411B2">gets</code> or any function that can overflow storage is considered a bad programming practice. Unfortunately, a number of commonly used library functions, including <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411B3" id="P70004970270000000000000000411B3">strcpy, strcat</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411B4" id="P70004970270000000000000000411B4">sprintf</code>, have the property that they can generate a byte sequence without being given any indication of the size of the destination buffer <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B466">[97]</a>. Such conditions can lead to vulnerabilities to buffer overflow.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002F7A" epub:type="practice" id="P7000497027000000000000000002F7A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411B5" epub:type="title" id="P70004970270000000000000000411B5"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.46 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003928">346</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000411B6" id="P70004970270000000000000000411B6">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000411B7" id="P70004970270000000000000000411B7">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411B8" id="P70004970270000000000000000411B8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411B9" id="P70004970270000000000000000411B9"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002F87"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.41</span></a> shows a (low-quality) implementation of a function that reads a line from standard input, copies the string to newly allocated storage, and returns a pointer to the result.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411BA" id="P70004970270000000000000000411BA">Consider the following scenario. Procedure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411BB" id="P70004970270000000000000000411BB">get_line</code> is called with the return address equal to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411BC" id="P70004970270000000000000000411BC">0x400776</code> and register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411BD" id="P70004970270000000000000000411BD">%rbx</code> equal to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411BE" id="P70004970270000000000000000411BE">0x0123456789ABCDEF</code>. You type in the string</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411BF" id="P70004970270000000000000000411BF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411C0" id="P70004970270000000000000000411C0">
0123456789012345678901234
</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002F87" id="P7000497027000000000000000002F87">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411C1" id="P70004970270000000000000000411C1"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000002F89" epub:type="pagebreak" id="P7000497027000000000000000002F89" title="283"></span>(a) C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411C2" id="P70004970270000000000000000411C2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411C3" id="P70004970270000000000000000411C3">
/* This is very low-quality code.
	It is intended to illustrate bad programming practices.
	See Practice <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002F7A"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">3.46</span></a>. */
char *get_line()
{
	char buf[4];
	char *result;
	gets(buf);
	result = malloc(strlen(buf));
	strcpy(result, buf);
	return result;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411C4" id="P70004970270000000000000000411C4">(b) Disassembly up through call to gets</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411C5" id="P70004970270000000000000000411C5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411C6" id="P70004970270000000000000000411C6">
	<i class="pcalibre17 pcalibre2 pcalibre1">char *get_line()</i>
1	0000000000400720 &lt;get_line&gt;:
2	400720:	53			push	%rbx
3	400721:	48 83 ec 10		sub	$0x10,%rsp
	<i class="pcalibre17 pcalibre2 pcalibre1">Diagram stack at this point</i>
4	400725:	48 89 e7		mov	%rsp,%rdi
5	400728:	e8 73 ff ff ff		callq	4006a0 &lt;gets&gt;
<i class="pcalibre17 pcalibre2 pcalibre1">Modify diagram to show stack contents at this point</i>
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P70004970270000000000000000411C7" id="P70004970270000000000000000411C7"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P70004970270000000000000000411C8" epub:type="title" id="P70004970270000000000000000411C8"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.41 </span>C and disassembled code for Practice <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002F7A"><span class="label pcalibre1 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">3.46</span></a>.</h1></header></figcaption>
</figure>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411C9" id="P70004970270000000000000000411C9">The program terminates with a segmentation fault. You run <span class="pcalibre1 pcalibre29 pcalibre2">gdb </span>and determine that the error occurs during the execution of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411CA" id="P70004970270000000000000000411CA">ret</code> instruction of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411CB" id="P70004970270000000000000000411CB">get_line.</code></p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000411CC" id="P70004970270000000000000000411CC">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411CD" id="P70004970270000000000000000411CD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411CE" id="P70004970270000000000000000411CE">Fill in the diagram that follows, indicating as much as you can about the stack just after executing the instruction at line 3 in the disassembly. Label the quantities stored on the stack (e.g., "Return address") on the right, and their hexadecimal values (if known) within the box. Each box represents 8 bytes. Indicate the position of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411CF" id="P70004970270000000000000000411CF">%rsp</code>. Recall that the ASCII codes for characters 0–9 are <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411D0" id="P70004970270000000000000000411D0">0x30–0x39.</code></p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002F99" id="P7000497027000000000000000002F99">
<img alt="A diagram shows a stack with four black sections below a Return address section on top, containing 00 00 00 00 00 40 00 76." class="pcalibre136 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B6C2" id="P70004970270000000000000000411D1" src="Images/chapter-03-image-14.png"/>
</figure>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411D2" id="P70004970270000000000000000411D2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411D3" id="P70004970270000000000000000411D3">Modify your diagram to show the effect of the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411D4" id="P70004970270000000000000000411D4">gets</code> (line 5).</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411D5" id="P70004970270000000000000000411D5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411D6" id="P70004970270000000000000000411D6">To what address does the program attempt to return?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411D7" id="P70004970270000000000000000411D7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411D8" id="P70004970270000000000000000411D8"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002FA2" epub:type="pagebreak" id="P7000497027000000000000000002FA2" title="284"></span>What register(s) have corrupted value(s) when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411D9" id="P70004970270000000000000000411D9">get_line</code> returns?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411DA" id="P70004970270000000000000000411DA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411DB" id="P70004970270000000000000000411DB">Besides the potential for buffer overflow, what two other things are wrong with the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411DC" id="P70004970270000000000000000411DC">get_line?</code></p></li>
</ol>
</div></li></ol>
</section>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411DD" id="P70004970270000000000000000411DD">A more pernicious use of buffer overflow is to get a program to perform a function that it would otherwise be unwilling to do. This is one of the most common methods to attack the security of a system over a computer network. Typically, the program is fed with a string that contains the byte encoding of some executable code, called the <i class="pcalibre17 pcalibre2 pcalibre1">exploit code</i>, plus some extra bytes that overwrite the return address with a pointer to the exploit code. The effect of executing the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411DE" id="P70004970270000000000000000411DE">ret</code> instruction is then to jump to the exploit code.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411DF" id="P70004970270000000000000000411DF">In one form of attack, the exploit code then uses a system call to start up a shell program, providing the attacker with a range of operating system functions. In another form, the exploit code performs some otherwise unauthorized task, repairs the damage to the stack, and then executes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411E0" id="P70004970270000000000000000411E0">ret</code> a second time, causing an (apparently) normal return to the caller.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411E1" id="P70004970270000000000000000411E1">As an example, the famous Internet worm of November 1988 used four different ways to gain access to many of the computers across the Internet. One was a buffer overflow attack on the finger daemon <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411E2" id="P70004970270000000000000000411E2">fingerd</code>, which serves requests by the <span class="pcalibre1 pcalibre29 pcalibre2">finger </span>command. By invoking <span class="pcalibre1 pcalibre29 pcalibre2">finger </span>with an appropriate string, the worm could make the daemon at a remote site have a buffer overflow and execute code that gave the worm access to the remote system. Once the worm gained access to a system, it would replicate itself and consume virtually all of the machine's computing resources. As a consequence, hundreds of machines were effectively paralyzed until security experts could determine how to eliminate the worm. The author of the worm was caught and prosecuted. He was sentenced to 3 years probation, 400 hours of community service, and a $10,500 fine. Even to this day, however, people continue to find security leaks in systems that leave them vulnerable to buffer overflow attacks. This highlights the need for careful programming. Any interface to the external environment should be made "bulletproof" so that no behavior by an external agent can cause the system to misbehave.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002FAD" id="P7000497027000000000000000002FAD"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411E3" epub:type="title" id="P70004970270000000000000000411E3"><span class="pcalibre1 pcalibre21 pcalibre2">3.10.4 </span>Thwarting Buffer Overflow Attacks</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411E4" id="P70004970270000000000000000411E4">Buffer overflow attacks have become so pervasive and have caused so many problems with computer systems that modern compilers and operating systems have implemented mechanisms to make it more difficult to mount these attacks and to limit the ways by which an intruder can seize control of a system via a buffer overflow attack. In this section, we will present mechanisms that are provided by recent versions of <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>for Linux.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002FB0" id="P7000497027000000000000000002FB0"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411E5" epub:type="title" id="P70004970270000000000000000411E5">Stack Randomization</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411E6" id="P70004970270000000000000000411E6">In order to insert exploit code into a system, the attacker needs to inject both the code as well as a pointer to this code as part of the attack string. Generating</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000002FB3" id="P7000497027000000000000000002FB3"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter03.xhtml#P70004970270000000000000000411E7" epub:type="title" id="P70004970270000000000000000411E7"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002FB5" epub:type="pagebreak" id="P7000497027000000000000000002FB5" title="285"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Worms and viruses</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411E8" id="P70004970270000000000000000411E8">Both worms and viruses are pieces of code that attempt to spread themselves among computers. As described by Spafford <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B476">[105],</a> a <i class="pcalibre17 pcalibre2 pcalibre1">worm</i> is a program that can run by itself and can propagate a fully working version of itself to other machines. A <i class="pcalibre17 pcalibre2 pcalibre1">virus</i> is a piece of code that adds itself to other programs, including operating systems. It cannot run independently. In the popular press, the term "virus" is used to refer to a variety of different strategies for spreading attacking code among systems, and so you will hear people saying "virus" for what more properly should be called a "worm."</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411E9" id="P70004970270000000000000000411E9">this pointer requires knowing the stack address where the string will be located. Historically, the stack addresses for a program were highly predictable. For all systems running the same combination of program and operating system version, the stack locations were fairly stable across many machines. So, for example, if an attacker could determine the stack addresses used by a common Web server, it could devise an attack that would work on many machines. Using infectious disease as an analogy, many systems were vulnerable to the exact same strain of a virus, a phenomenon often referred to as a <i class="pcalibre17 pcalibre2 pcalibre1">security monoculture</i> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B464">[96]</a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411EA" id="P70004970270000000000000000411EA">The idea of <i class="pcalibre17 pcalibre2 pcalibre1">stack randomization</i> is to make the position of the stack vary from one run of a program to another. Thus, even if many machines are running identical code, they would all be using different stack addresses. This is implemented by allocating a random amount of space between 0 and <var class="pcalibre17 pcalibre2 pcalibre1">n</var> bytes on the stack at the start of a program, for example, by using the allocation function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411EB" id="P70004970270000000000000000411EB">alloca</code>, which allocates space for a specified number of bytes on the stack. This allocated space is not used by the program, but it causes all subsequent stack locations to vary from one execution of a program to another. The allocation range <var class="pcalibre17 pcalibre2 pcalibre1">n</var> needs to be large enough to get sufficient variations in the stack addresses, yet small enough that it does not waste too much space in the program.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411EC" id="P70004970270000000000000000411EC">The following code shows a simple way to determine a "typical" stack address:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411ED" id="P70004970270000000000000000411ED"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411EE" id="P70004970270000000000000000411EE">
int main(){
	long local;
	printf("local at %p\n", &amp;local);
	return 0;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411EF" id="P70004970270000000000000000411EF">This code simply prints the address of a local variable in the main function. Running the code 10,000 times on a Linux machine in 32-bit mode, the addresses ranged from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411F0" id="P70004970270000000000000000411F0">0xff7fc59c</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411F1" id="P70004970270000000000000000411F1">0xffffd09c</code>, a range of around 2<sup class="pcalibre1 pcalibre2 pcalibre85">23</sup>. Running in 64-bit mode on the newer machine, the addresses ranged from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411F2" id="P70004970270000000000000000411F2">0x7fff0001b698</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411F3" id="P70004970270000000000000000411F3">0x7ffffffaa4a8</code>, a range of nearly 2<sup class="pcalibre1 pcalibre2 pcalibre85">32</sup>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411F4" id="P70004970270000000000000000411F4">Stack randomization has become standard practice in Linux systems. It is one of a larger class of techniques known as <i class="pcalibre17 pcalibre2 pcalibre1">address-space layout randomization</i>, or ASLR <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B46A">[99]</a>. With ASLR, different parts of the program, including program code, library code, stack, global variables, and heap data, are loaded into different <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002FC3" epub:type="pagebreak" id="P7000497027000000000000000002FC3" title="286"></span>regions of memory each time a program is run. That means that a program running on one machine will have very different address mappings than the same program running on other machines. This can thwart some forms of attack.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411F5" id="P70004970270000000000000000411F5">Overall, however, a persistent attacker can overcome randomization by brute force, repeatedly attempting attacks with different addresses. A common trick is to include a long sequence of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411F6" id="P70004970270000000000000000411F6">nop</code> (pronounced "no op," short for "no operation") instructions before the actual exploit code. Executing this instruction has no effect, other than incrementing the program counter to the next instruction. As long as the attacker can guess an address somewhere within this sequence, the program will run through the sequence and then hit the exploit code. The common term for this sequence is a "nop sled" <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B466">[97]</a>, expressing the idea that the program "slides" through the sequence. If we set up a 256-byte nop sled, then the randomization over <var class="pcalibre17 pcalibre2 pcalibre1">n</var> = 2<sup class="pcalibre1 pcalibre2 pcalibre85">23</sup> can be cracked by enumerating 2<sup class="pcalibre1 pcalibre2 pcalibre85">15</sup> = 32,768 starting addresses, which is entirely feasible for a determined attacker. For the 64-bit case, trying to enumerate 2<sup class="pcalibre1 pcalibre2 pcalibre85">24</sup> = 16,777,216 is a bit more daunting. We can see that stack randomization and other aspects of ASLR can increase the effort required to successfully attack a system, and therefore greatly reduce the rate at which a virus or worm can spread, but it cannot provide a complete safeguard.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002FC6" epub:type="practice" id="P7000497027000000000000000002FC6"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre127 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411F7" epub:type="title" id="P70004970270000000000000000411F7"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.47 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003968">347</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000411F8" id="P70004970270000000000000000411F8">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000411F9" id="P70004970270000000000000000411F9">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000411FA" id="P70004970270000000000000000411FA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000411FB" id="P70004970270000000000000000411FB">Running our stack-checking code 10,000 times on a system running Linux version 2.6.16, we obtained addresses ranging from a minimum of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411FC" id="P70004970270000000000000000411FC">0xffffb754</code> to a maximum of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000411FD" id="P70004970270000000000000000411FD">0xffffd754</code>.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000411FE" id="P70004970270000000000000000411FE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000411FF" id="P70004970270000000000000000411FF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041200" id="P7000497027000000000000000041200">What is the approximate range of addresses?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041201" id="P7000497027000000000000000041201"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041202" id="P7000497027000000000000000041202">If we attempted a buffer overrun with a 128-byte nop sled, about how many attempts would it take to test all starting addresses?</p></li>
</ol>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002FD3" id="P7000497027000000000000000002FD3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041203" epub:type="title" id="P7000497027000000000000000041203">Stack Corruption Detection</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041204" id="P7000497027000000000000000041204">A second line of defense is to be able to detect when a stack has been corrupted. We saw in the example of the echo function (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002F48"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.40</span></a>) that the corruption typically occurs when the program overruns the bounds of a local buffer. In C, there is no reliable way to prevent writing beyond the bounds of an array. Instead, the program can attempt to detect when such a write has occurred before it can have any harmful effects.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041205" id="P7000497027000000000000000041205">Recent versions of <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>incorporate a mechanism known as a <i class="pcalibre17 pcalibre2 pcalibre1">stack protector</i> into the generated code to detect buffer overruns. The idea is to store a special <i class="pcalibre17 pcalibre2 pcalibre1">canary</i> value<a class="pcalibre1 pcalibre2 pcalibre56 pcalibre16 pcalibre14 pcalibre15" epub:type="noteref" href="#P7000497027000000000000000003A70" id="r__P7000497027000000000000000003A70"><sup class="pcalibre1 pcalibre2 calibre8">4</sup></a> in the stack frame between any local buffer and the rest of the stack state, as illustrated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000002FD7"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.42</span></a> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3D5">[26,</a> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B466">97]</a>. This canary value, also referred to as a <i class="pcalibre17 pcalibre2 pcalibre1">guard value</i>, is generated randomly each time the program runs, and so there is no</p><aside class="pcalibre2 pcalibre32 pcalibre57" data-uri="chapter03.xhtml#P7000497027000000000000000003A70" epub:type="footnote" id="P7000497027000000000000000003A70"><p class="pcalibre1 pcalibre2 pcalibre10"><span class="pcalibre1 pcalibre58 pcalibre2"><a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="#r__P7000497027000000000000000003A70">4. </a></span>The term "canary" refers to the historic use of these birds to detect the presence of dangerous gases in coal mines.</p></aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000002FD7" id="P7000497027000000000000000002FD7">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002FD8" epub:type="pagebreak" id="P7000497027000000000000000002FD8" title="287"></span>
<img alt="A diagram illustrates a stack organization for echo function with stack protector enabled." class="pcalibre1 pcalibre2 calibre25" data-uri="P700049702700000000000000000B6C3" id="P7000497027000000000000000041206" src="Images/chapter-03-image-15.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041207" id="P7000497027000000000000000041207"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000041208" epub:type="title" id="P7000497027000000000000000041208"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.42 </span>Stack organization for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041209" id="P7000497027000000000000000041209">echo</code> function with stack protector enabled.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004120A" id="P700049702700000000000000004120A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004120B" id="P700049702700000000000000004120B">A special "canary" value is positioned between array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004120C" id="P700049702700000000000000004120C">buf</code> and the saved state. The code checks the canary value to determine whether or not the stack state has been corrupted.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P70004970270000000000000000214E4" id="P70004970270000000000000000214E4">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004120D" id="P700049702700000000000000004120D">A diagram has two parts, from bottom to top:</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004120E" id="P700049702700000000000000004120E">Stack frame for echo with buf = %rsp at the bottom containing [7][6][5][4][3][2][1][0] and a section above containing Canary</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004120F" id="P700049702700000000000000004120F">Stack frame for caller with %rsp+24 on bottom containing Return address</p>
</details>
</figcaption></figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041210" id="P7000497027000000000000000041210">easy way for an attacker to determine what it is. Before restoring the register state and returning from the function, the program checks if the canary has been altered by some operation of this function or one that it has called. If so, the program aborts with an error.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041211" id="P7000497027000000000000000041211">Recent versions of <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>try to determine whether a function is vulnerable to a stack overflow and insert this type of overflow detection automatically. In fact, for our earlier demonstration of stack overflow, we had to give the command-line option <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041212" id="P7000497027000000000000000041212">-fno-stack-protector</code> to prevent <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>from inserting this code. Compiling the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041213" id="P7000497027000000000000000041213">echo</code> without this option, and hence with the stack protector enabled, gives the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041214" id="P7000497027000000000000000041214"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041215" id="P7000497027000000000000000041215">
<i class="pcalibre17 pcalibre2 pcalibre1">void echo()</i>
1	echo:
2	subq	$24, %rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Allocate 24 bytes on stack</i>
3	movq	%fs:40, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Retrieve canary</i>
4	movq	%rax, 8(%rsp)	<i class="pcalibre17 pcalibre2 pcalibre1">Store on stack</i>
5	xorl	%eax, %eax	<i class="pcalibre17 pcalibre2 pcalibre1">Zero out register</i>
6	movq	%rsp, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Compute buf as %rsp</i>
7	call	gets		<i class="pcalibre17 pcalibre2 pcalibre1">Call gets</i>
8	movq	%rsp, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Compute buf as %rsp</i>
9	call	puts		<i class="pcalibre17 pcalibre2 pcalibre1">Call puts</i>
10	movq	8(%rsp), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Retrieve canary</i>
11	xorq	%fs:40, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Compare to stored value</i>
12	je	.L9		<i class="pcalibre17 pcalibre2 pcalibre1">If =, goto</i> ok
13	call	__stack_chk_fail <i class="pcalibre17 pcalibre2 pcalibre1">Stack corrupted!</i>
14	.L9:		     <b class="pcalibre1 pcalibre2 pcalibre12">ok:</b>
15	addq	$24, %rsp	<i class="pcalibre17 pcalibre2 pcalibre1">Deallocate stack space</i>
16	ret
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041216" id="P7000497027000000000000000041216">We see that this version of the function retrieves a value from memory (line 3) and stores it on the stack at offset 8 from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041217" id="P7000497027000000000000000041217">%rsp</code>, just beyond the region allocated for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041218" id="P7000497027000000000000000041218">buf</code>. The instruction argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041219" id="P7000497027000000000000000041219">%fs:40</code> is an indication that the canary value is read from memory using <i class="pcalibre17 pcalibre2 pcalibre1">segmented addressing</i>, an addressing mechanism that dates <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002FEA" epub:type="pagebreak" id="P7000497027000000000000000002FEA" title="288"></span>back to the 80286 and is seldom found in programs running on modern systems. By storing the canary in a special segment, it can be marked as "read only," so that an attacker cannot overwrite the stored canary value. Before restoring the register state and returning, the function compares the value stored at the stack location with the canary value (via the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004121A" id="P700049702700000000000000004121A">xorq</code> instruction on line 11). If the two are identical, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004121B" id="P700049702700000000000000004121B">xorq</code> instruction will yield zero, and the function will complete in the normal fashion. A nonzero value indicates that the canary on the stack has been modified, and so the code will call an error routine.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004121C" id="P700049702700000000000000004121C">Stack protection does a good job of preventing a buffer overflow attack from corrupting state stored on the program stack. It incurs only a small performance penalty, especially because <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>only inserts it when there is a local buffer of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004121D" id="P700049702700000000000000004121D">char</code> in the function. Of course, there are other ways to corrupt the state of an executing program, but reducing the vulnerability of the stack thwarts many common attack strategies.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000002FEF" epub:type="practice" id="P7000497027000000000000000002FEF"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre127 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004121E" epub:type="title" id="P700049702700000000000000004121E"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.48 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003968">347</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004121F" id="P700049702700000000000000004121F">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041220" id="P7000497027000000000000000041220">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041221" id="P7000497027000000000000000041221"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041222" id="P7000497027000000000000000041222">The functions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041223" id="P7000497027000000000000000041223">intlen, len</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041224" id="P7000497027000000000000000041224">iptoa</code> provide a very convoluted way to compute the number of decimal digits required to represent an integer. We will use this as a way to study some aspects of the <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>stack protector facility.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041225" id="P7000497027000000000000000041225"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041226" id="P7000497027000000000000000041226">
int len(char *s) {
	return strlen(s);
}
void iptoa(char *s, long *p) {
	long val = *p;
	sprintf(s, "%ld", val);
}
int intlen(long x) {
	long v;
	char buf[12];
	v = x;
	iptoa(buf, &amp;v);
	return len(buf);
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041227" id="P7000497027000000000000000041227">The following show portions of the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041228" id="P7000497027000000000000000041228">intlen</code>, compiled both with and without stack protector:</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041229" id="P7000497027000000000000000041229">(a) Without protector</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004122A" id="P700049702700000000000000004122A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004122B" id="P700049702700000000000000004122B">
	<i class="pcalibre17 pcalibre2 pcalibre1">int intlen(long x)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi</i>
1	intlen:
2	subq	$40, %rsp
3	movq	%rdi, 24(%rsp)
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000002FFE" epub:type="pagebreak" id="P7000497027000000000000000002FFE" title="289"></span>4	leaq	24(%rsp), %rsi
5	movq	%rsp, %rdi
6	call	iptoa
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004122C" id="P700049702700000000000000004122C">(b) With protector</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004122D" id="P700049702700000000000000004122D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004122E" id="P700049702700000000000000004122E">
	<i class="pcalibre17 pcalibre2 pcalibre1">int intlen(long x)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi</i>
1	intlen:
2	subq	$56, %rsp
3	movq	%fs:40, %rax
4	movq	%rax, 40(%rsp)
5	xorl	%eax, %eax
6	movq	%rdi, 8(%rsp)
7	leaq	8(%rsp), %rsi
8	leaq	16(%rsp), %rdi
9	call	iptoa
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P700049702700000000000000004122F" id="P700049702700000000000000004122F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041230" id="P7000497027000000000000000041230"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041231" id="P7000497027000000000000000041231">For both versions: What are the positions in the stack frame for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041232" id="P7000497027000000000000000041232">buf, v</code>, and (when present) the canary value?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041233" id="P7000497027000000000000000041233"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041234" id="P7000497027000000000000000041234">How does the rearranged ordering of the local variables in the protected code provide greater security against a buffer overrun attack?</p></li>
</ol>
</div></li></ol></section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003008" id="P7000497027000000000000000003008"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041235" epub:type="title" id="P7000497027000000000000000041235">Limiting Executable Code Regions</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041236" id="P7000497027000000000000000041236">A final step is to eliminate the ability of an attacker to insert executable code into a system. One method is to limit which memory regions hold executable code. In typical programs, only the portion of memory holding the code generated by the compiler need be executable. The other portions can be restricted to allow just reading and writing. As we will see in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006FF7.xhtml#P7000497027000000000000000006FF7"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">9</span></a>, the virtual memory space is logically divided into <i class="pcalibre17 pcalibre2 pcalibre1">pages</i>, typically with 2,048 or 4,096 bytes per page. The hardware supports different forms of <i class="pcalibre17 pcalibre2 pcalibre1">memory protection</i>, indicating the forms of access allowed by both user programs and the operating system kernel. Many systems allow control over three forms of access: read (reading data from memory), write (storing data into memory), and execute (treating the memory contents as machine-level code). Historically, the x86 architecture merged the read and execute access controls into a single 1-bit flag, so that any page marked as readable was also executable. The stack had to be kept both readable and writable, and therefore the bytes on the stack were also executable. Various schemes were implemented to be able to limit some pages to being readable but not executable, but these generally introduced significant inefficiencies.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041237" id="P7000497027000000000000000041237">More recently, AMD introduced an NX (for "no-execute") bit into the memory protection for its 64-bit processors, separating the read and execute access modes, and Intel followed suit. With this feature, the stack can be marked as being readable and writable, but not executable, and the checking of whether a page is executable is performed in hardware, with no penalty in efficiency.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041238" id="P7000497027000000000000000041238"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000300D" epub:type="pagebreak" id="P700049702700000000000000000300D" title="290"></span>Some types of programs require the ability to dynamically generate and execute code. For example, "just-in-time" compilation techniques dynamically generate code for programs written in interpreted languages, such as Java, to improve execution performance. Whether or not the run-time system can restrict the executable code to just that part generated by the compiler in creating the original program depends on the language and the operating system.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041239" id="P7000497027000000000000000041239">The techniques we have outlined—randomization, stack protection, and limiting which portions of memory can hold executable code—are three of the most common mechanisms used to minimize the vulnerability of programs to buffer overflow attacks. They all have the properties that they require no special effort on the part of the programmer and incur very little or no performance penalty. Each separately reduces the level of vulnerability, and in combination they become even more effective. Unfortunately, there are still ways to attack computers <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B44D">[85,</a> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B466">97]</a>, and so worms and viruses continue to compromise the integrity of many machines.</p>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000300F" id="P700049702700000000000000000300F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004123A" epub:type="title" id="P700049702700000000000000004123A"><span class="pcalibre1 pcalibre21 pcalibre2">3.10.5 </span>Supporting Variable-Size Stack Frames</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004123B" id="P700049702700000000000000004123B">We have examined the machine-level code for a variety of functions so far, but they all have the property that the compiler can determine in advance the amount of space that must be allocated for their stack frames. Some functions, however, require a variable amount of local storage. This can occur, for example, when the function calls <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004123C" id="P700049702700000000000000004123C">alloca</code>, a standard library function that can allocate an arbitrary number of bytes of storage on the stack. It can also occur when the code declares a local array of variable size.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004123D" id="P700049702700000000000000004123D">Although the information presented in this section should rightfully be considered an aspect of how procedures are implemented, we have deferred the presentation to this point, since it requires an understanding of arrays and alignment.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004123E" id="P700049702700000000000000004123E">The code of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003022"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.43(a)</span></a> gives an example of a function containing a variable-size array. The function declares local array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004123F" id="P700049702700000000000000004123F">p</code> of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> pointers, where <var class="pcalibre17 pcalibre2 pcalibre1">n</var> is given by the first argument. This requires allocating 8<var class="pcalibre17 pcalibre2 pcalibre1">n</var> bytes on the stack, where the value of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> may vary from one call of the function to another. The compiler therefore cannot determine how much space it must allocate for the function's stack frame. In addition, the program generates a reference to the address of local variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041240" id="P7000497027000000000000000041240">i</code>, and so this variable must also be stored on the stack. During execution, the program must be able to access both local variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041241" id="P7000497027000000000000000041241">i</code> and the elements of array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041242" id="P7000497027000000000000000041242">p</code>. On returning, the function must deallocate the stack frame and set the stack pointer to the position of the stored return address.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041243" id="P7000497027000000000000000041243">To manage a variable-size stack frame, x86-64 code uses register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041244" id="P7000497027000000000000000041244">%rbp</code> to serve as a <i class="pcalibre17 pcalibre2 pcalibre1">frame pointer</i> (sometimes referred to as a <i class="pcalibre17 pcalibre2 pcalibre1">base pointer</i>, and hence the letters <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041245" id="P7000497027000000000000000041245">bp</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041246" id="P7000497027000000000000000041246">%rbp</code>). When using a frame pointer, the stack frame is organized as shown for the case of function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041247" id="P7000497027000000000000000041247">vframe</code> in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000302E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.44</span></a>. We see that the code must save the previous version of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041248" id="P7000497027000000000000000041248">%rbp</code> on the stack, since it is a callee-saved register. It then keeps <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041249" id="P7000497027000000000000000041249">%rbp</code> pointing to this position throughout the execution of the function, and it references fixed-length local variables, such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004124A" id="P700049702700000000000000004124A">i</code>, at offsets relative to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004124B" id="P700049702700000000000000004124B">%rbp.</code></p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000003022" id="P7000497027000000000000000003022">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004124C" id="P700049702700000000000000004124C"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000003024" epub:type="pagebreak" id="P7000497027000000000000000003024" title="291"></span>(a) C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004124D" id="P700049702700000000000000004124D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004124E" id="P700049702700000000000000004124E">
long vframe(long n, long idx, long *q) {
	long i;
	long *p[n];
	p[0] = &amp;i;
	for (i = 1; i &lt; n; i++)
	  p[i] = q;
	return *p[idx];
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004124F" id="P700049702700000000000000004124F">(b) Portions of generated assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041250" id="P7000497027000000000000000041250"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041251" id="P7000497027000000000000000041251">
	<i class="pcalibre17 pcalibre2 pcalibre1">long vframe(long n, long idx, long *q)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">n in %rdi, idx in %rsi, q in %rdx</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">Only portions of code shown</i>
1	vframe:
2	pushq	%rbp			<i class="pcalibre17 pcalibre2 pcalibre1">Save old %rbp</i>
3	movq	%rsp, %rbp		<i class="pcalibre17 pcalibre2 pcalibre1">Set frame pointer</i>
4	subq	$16, %rsp		<i class="pcalibre17 pcalibre2 pcalibre1">Allocate space for i (%rsp = s</i><sub class="pcalibre1 pcalibre2 pcalibre122">1</sub>)
5	leaq	22(,%rdi,8), %rax
6	andq	$-16, %rax
7	subq	%rax, %rsp		<i class="pcalibre17 pcalibre2 pcalibre1">Allocate space for array p (%rsp = s</i><sub class="pcalibre1 pcalibre2 pcalibre122">2</sub>)
8	leaq	7(%rsp), %rax
9	shrq	$3, %rax
10	leaq	0(,%rax,8), %r8		<i class="pcalibre17 pcalibre2 pcalibre1">Set %r8 to &amp;p[0]</i>
11	movq	%r8, %rcx		<i class="pcalibre17 pcalibre2 pcalibre1">Set %rcx to &amp;p[0] (%rcx = p)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">...</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">Code for initialization loop</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">i in %rax and on stack, n in %rdi, p in %rcx, q in %rdx</i>
12	.L3:			      <b class="pcalibre1 pcalibre2 pcalibre12">loop:</b>
13	movq	%rdx, (%rcx,%rax,8)	<i class="pcalibre17 pcalibre2 pcalibre1">Set p[i] to q</i>
14	addq	$1, %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Increment i</i>
15	movq	%rax, -8(%rbp)		<i class="pcalibre17 pcalibre2 pcalibre1">Store on stack</i>
16	.L2:
17	movq	-8(%rbp), %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Retrieve i from stack</i>
18	cmpq	%rdi, %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Compare i:n</i>
19	jl	.L3			<i class="pcalibre17 pcalibre2 pcalibre1">If &lt;, goto</i> loop
	<i class="pcalibre17 pcalibre2 pcalibre1">...</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">Code for function exit</i>
20	leave				<i class="pcalibre17 pcalibre2 pcalibre1">Restore %rbp and %rsp</i>
21	ret				<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041252" id="P7000497027000000000000000041252"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000041253" epub:type="title" id="P7000497027000000000000000041253"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.43 </span>Function requiring the use of a frame pointer.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041254" id="P7000497027000000000000000041254"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041255" id="P7000497027000000000000000041255">The variable-size array implies that the size of the stack frame cannot be determined at compile time.</p></div></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P700049702700000000000000000302E" id="P700049702700000000000000000302E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000302F" epub:type="pagebreak" id="P700049702700000000000000000302F" title="292"></span>
<img alt="A diagram illustrates a stack frame for function vframe." class="pcalibre1 pcalibre2 calibre26" data-uri="P700049702700000000000000000B6C4" id="P7000497027000000000000000041256" src="Images/chapter-03-image-16.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041257" id="P7000497027000000000000000041257"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000041258" epub:type="title" id="P7000497027000000000000000041258"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.44 </span>Stack frame structure for function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041259" id="P7000497027000000000000000041259">vframe</code>.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004125A" id="P700049702700000000000000004125A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004125B" id="P700049702700000000000000004125B">The function uses register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004125C" id="P700049702700000000000000004125C">%rbp</code> as a frame pointer. The annotations along the right-hand side are in reference to Practice <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003055"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">3.49</span></a>.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P7000497027000000000000000021535" id="P7000497027000000000000000021535">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004125D" id="P700049702700000000000000004125D">The sections of the stack are summarized below from bottom to top:</p>
<ul class="pcalibre1 pcalibre2 pcalibre126" data-uri="chapter03.xhtml#P700049702700000000000000004125E" id="P700049702700000000000000004125E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004125F" id="P700049702700000000000000004125F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041260" id="P7000497027000000000000000041260">e2 from s2 (Stack point %rsp) at the bottom to p.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041261" id="P7000497027000000000000000041261"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041262" id="P7000497027000000000000000041262">8n bytes containing p</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041263" id="P7000497027000000000000000041263"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041264" id="P7000497027000000000000000041264">e1 to s1, numbered negative 16</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041265" id="P7000497027000000000000000041265"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041266" id="P7000497027000000000000000041266">from negative 16 to negative 8 containing (Unused)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041267" id="P7000497027000000000000000041267"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041268" id="P7000497027000000000000000041268">from negative 8 to 0 (frame pointer %rbp) containing i</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041269" id="P7000497027000000000000000041269"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004126A" id="P700049702700000000000000004126A">from 0 to 8 containing Saved %rbp</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004126B" id="P700049702700000000000000004126B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004126C" id="P700049702700000000000000004126C">above 8 containing Return address</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004126D" id="P700049702700000000000000004126D"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003022"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.43(b)</span></a> shows portions of the code <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates for function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004126E" id="P700049702700000000000000004126E">vframe</code>. At the beginning of the function, we see code that sets up the stack frame and allocates space for array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004126F" id="P700049702700000000000000004126F">p</code>. The code starts by pushing the current value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041270" id="P7000497027000000000000000041270">%rbp</code> onto the stack and setting <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041271" id="P7000497027000000000000000041271">%rbp</code> to point to this stack position (lines 2–3). Next, it allocates 16 bytes on the stack, the first 8 of which are used to store local variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041272" id="P7000497027000000000000000041272">i</code>, and the second 8 of which are unused. Then it allocates space for array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041273" id="P7000497027000000000000000041273">p</code> (lines 5–11). The details of how much space it allocates and where it positions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041274" id="P7000497027000000000000000041274">p</code> within this space are explored in Practice <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003055"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.49</span></a>. Suffice it to say that by the time the program reaches line 11, it has (1) allocated at least 8<var class="pcalibre17 pcalibre2 pcalibre1">n</var> bytes on the stack and (2) positioned array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041275" id="P7000497027000000000000000041275">p</code> within the allocated region such that at least 8<var class="pcalibre17 pcalibre2 pcalibre1">n</var> bytes are available for its use.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041276" id="P7000497027000000000000000041276">The code for the initialization loop shows examples of how local variables <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041277" id="P7000497027000000000000000041277">i</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041278" id="P7000497027000000000000000041278">p</code> are referenced. Line 13 shows array element <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041279" id="P7000497027000000000000000041279">p[i]</code> being set to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004127A" id="P700049702700000000000000004127A">q</code>. This instruction uses the value in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004127B" id="P700049702700000000000000004127B">%rcx</code> as the address for the start of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004127C" id="P700049702700000000000000004127C">p</code>. We can see instances where local variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004127D" id="P700049702700000000000000004127D">i</code> is updated (line 15) and read (line 17). The address of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004127E" id="P700049702700000000000000004127E">i</code> is given by reference <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004127F" id="P700049702700000000000000004127F">-8(%rbp)</code>—that is, at offset -8 relative to the frame pointer.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041280" id="P7000497027000000000000000041280">At the end of the function, the frame pointer is restored to its previous value using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041281" id="P7000497027000000000000000041281">leave</code> instruction (line 20). This instruction takes no arguments. It is equivalent to executing the following two instructions:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041282" id="P7000497027000000000000000041282"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041283" id="P7000497027000000000000000041283">
movq %rbp, %rsp		<i class="pcalibre17 pcalibre2 pcalibre1">Set stack pointer to beginning of frame</i>
popq %rbp		<i class="pcalibre17 pcalibre2 pcalibre1">Restore saved %rbp and set stack ptr to end of caller's frame</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041284" id="P7000497027000000000000000041284">That is, the stack pointer is first set to the position of the saved value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041285" id="P7000497027000000000000000041285">%rbp</code>, and then this value is popped from the stack into <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041286" id="P7000497027000000000000000041286">%rbp</code>. This instruction combination has the effect of deallocating the entire stack frame.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041287" id="P7000497027000000000000000041287"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003052" epub:type="pagebreak" id="P7000497027000000000000000003052" title="293"></span>In earlier versions of x86 code, the frame pointer was used with every function call. With x86-64 code, it is used only in cases where the stack frame may be of variable size, as is the case for function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041288" id="P7000497027000000000000000041288">vframe</code>. Historically, most compilers used frame pointers when generating IA32 code. Recent versions of <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>have dropped this convention. Observe that it is acceptable to mix code that uses frame pointers with code that does not, as long as all functions treat <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041289" id="P7000497027000000000000000041289">%rbp</code> as a callee-saved register.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003055" epub:type="practice" id="P7000497027000000000000000003055"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004128A" epub:type="title" id="P700049702700000000000000004128A"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.49 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003968">347</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004128B" id="P700049702700000000000000004128B">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004128C" id="P700049702700000000000000004128C">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004128D" id="P700049702700000000000000004128D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004128E" id="P700049702700000000000000004128E">In this problem, we will explore the logic behind the code in lines 5–11 of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003022"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.43(b)</span></a>, where space is allocated for variable-size array p. As the annotations of the code indicate, let us let <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub> denote the address of the stack pointer after executing the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004128F" id="P700049702700000000000000004128F">subq</code> instruction of line 4. This instruction allocates the space for local variable i. Let <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> denote the value of the stack pointer after executing the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041290" id="P7000497027000000000000000041290">subq</code> instruction of line 7. This instruction allocates the storage for local array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041291" id="P7000497027000000000000000041291">p</code>. Finally, let <var class="pcalibre17 pcalibre2 pcalibre1">p</var> denote the value assigned to registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041292" id="P7000497027000000000000000041292">%r8</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041293" id="P7000497027000000000000000041293">%rcx</code> in the instructions of lines 10–11. Both of these registers are used to reference array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041294" id="P7000497027000000000000000041294">p</code>.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041295" id="P7000497027000000000000000041295">The right-hand side of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000302E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.44</span></a> diagrams the positions of the locations indicated by <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub>, and <var class="pcalibre17 pcalibre2 pcalibre1">p</var>. It also shows that there may be an offset of <var class="pcalibre17 pcalibre2 pcalibre1">e</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> bytes between the values of <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub> and <var class="pcalibre17 pcalibre2 pcalibre1">p</var>. This space will not be used. There may also be an offset of <var class="pcalibre17 pcalibre2 pcalibre1">e</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub> bytes between the end of array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041296" id="P7000497027000000000000000041296">p</code> and the position indicated by <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041297" id="P7000497027000000000000000041297">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041298" id="P7000497027000000000000000041298"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041299" id="P7000497027000000000000000041299">Explain, in mathematical terms, the logic in the computation of <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> on lines 5–7. <i class="pcalibre17 pcalibre2 pcalibre1">Hint:</i> Think about the bit-level representation of –16 and its effect in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004129A" id="P700049702700000000000000004129A">andq</code> instruction of line 6.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004129B" id="P700049702700000000000000004129B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004129C" id="P700049702700000000000000004129C">Explain, in mathematical terms, the logic in the computation of <var class="pcalibre17 pcalibre2 pcalibre1">p</var> on lines 8–10. <i class="pcalibre17 pcalibre2 pcalibre1">Hint:</i> You may want to refer to the discussion on division by powers of 2 in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000000CB3_split_001.xhtml#P7000497027000000000000000000FF6"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">2.3.7</span></a>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004129D" id="P700049702700000000000000004129D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004129E" id="P700049702700000000000000004129E">For the following values of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> and <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, trace the execution of the code to determine what the resulting values would be for <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">p</var>, <var class="pcalibre17 pcalibre2 pcalibre1">e</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, and <var class="pcalibre17 pcalibre2 pcalibre1">e</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub>.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P700049702700000000000000004129F" id="P700049702700000000000000004129F">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000412A0" id="P70004970270000000000000000412A0"><var class="pcalibre17 pcalibre2 pcalibre1">n</var></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000412A1" id="P70004970270000000000000000412A1"><var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000412A2" id="P70004970270000000000000000412A2"><var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000412A3" id="P70004970270000000000000000412A3"><var class="pcalibre17 pcalibre2 pcalibre1">p</var></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000412A4" id="P70004970270000000000000000412A4"><var class="pcalibre17 pcalibre2 pcalibre1">e</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000412A5" id="P70004970270000000000000000412A5"><var class="pcalibre17 pcalibre2 pcalibre1">e</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412A6" id="P70004970270000000000000000412A6">5</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412A7" id="P70004970270000000000000000412A7">2,065</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412A8" id="P70004970270000000000000000412A8">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412A9" id="P70004970270000000000000000412A9">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412AA" id="P70004970270000000000000000412AA">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412AB" id="P70004970270000000000000000412AB">__________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412AC" id="P70004970270000000000000000412AC">6</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412AD" id="P70004970270000000000000000412AD">2,064</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412AE" id="P70004970270000000000000000412AE">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412AF" id="P70004970270000000000000000412AF">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412B0" id="P70004970270000000000000000412B0">__________</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412B1" id="P70004970270000000000000000412B1">__________</td>
</tr>
</tbody>
</table></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000412B2" id="P70004970270000000000000000412B2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000412B3" id="P70004970270000000000000000412B3">What alignment properties does this code guarantee for the values of <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> and <var class="pcalibre17 pcalibre2 pcalibre1">p</var>?</p></li>
</ol></div></li></ol>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.11 Floating-Point Code</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000003080"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P70004970270000000000000000412B4" epub:type="title" id="P70004970270000000000000000412B4"><span class="pcalibre1 pcalibre21 pcalibre2">3.11 </span>Floating-Point Code</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412B5" id="P70004970270000000000000000412B5">The <i class="pcalibre17 pcalibre2 pcalibre1">floating-point architecture</i> for a processor consists of the different aspects that affect how programs operating on floating-point data are mapped onto the machine, including</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412B6" id="P70004970270000000000000000412B6">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000412B7" id="P70004970270000000000000000412B7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000412B8" id="P70004970270000000000000000412B8">How floating-point values are stored and accessed. This is typically via some form of registers.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000412B9" id="P70004970270000000000000000412B9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000412BA" id="P70004970270000000000000000412BA"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003088" epub:type="pagebreak" id="P7000497027000000000000000003088" title="294"></span>The instructions that operate on floating-point data.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000412BB" id="P70004970270000000000000000412BB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000412BC" id="P70004970270000000000000000412BC">The conventions used for passing floating-point values as arguments to functions and for returning them as results.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000412BD" id="P70004970270000000000000000412BD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000412BE" id="P70004970270000000000000000412BE">The conventions for how registers are preserved during function calls—for example, with some registers designated as caller saved, and others as callee saved.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412BF" id="P70004970270000000000000000412BF">To understand the x86-64 floating-point architecture, it is helpful to have a brief historical perspective. Since the introduction of the Pentium/MMX in 1997, both Intel and AMD have incorporated successive generations of <i class="pcalibre17 pcalibre2 pcalibre1">media</i> instructions to support graphics and image processing. These instructions originally focused on allowing multiple operations to be performed in a parallel mode known as <i class="pcalibre17 pcalibre2 pcalibre1">single instruction, multiple data</i>, or <i class="pcalibre17 pcalibre2 pcalibre1">SIMD</i> (pronounced sim-dee). In this mode the same operation is performed on a number of different data values in parallel. Over the years, there has been a progression of these extensions. The names have changed through a series of major revisions from MMX to SSE (for "streaming SIMD extensions") and most recently AVX (for "advanced vector extensions"). Within each generation, there have also been different versions. Each of these extensions manages datainsetsofregisters, referredto as"MM" registers for MMX, "XMM" for SSE, and "YMM" for AVX, ranging from 64 bits for MM registers, to 128 for XMM, to 256 for YMM. So, for example, each YMM register can hold eight 32-bit values, or four 64-bit values, where these values can be either integer or floating point.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412C0" id="P70004970270000000000000000412C0">Starting with SSE2, introduced with the Pentium 4 in 2000, the media instructions have included ones to operate on <i class="pcalibre17 pcalibre2 pcalibre1">scalar</i> floating-point data, using single values in the low-order 32 or 64 bits of XMM or YMM registers. This scalar mode provides a set of registers and instructions that are more typical of the way other processors support floating point. All processors capable of executing x86-64 code support SSE2 or higher, and hence x86-64 floating point is based on SSE or AVX, including conventions for passing procedure arguments and return values <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B43D">[77]</a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412C1" id="P70004970270000000000000000412C1">Our presentation is based on AVX2, the second version of AVX, introduced with the Core i7 Haswell processor in 2013. G<span class="pcalibre1 pcalibre29 pcalibre2">cc</span> will generate AVX2 code when given the command-line parameter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412C2" id="P70004970270000000000000000412C2">-mavx2</code>. Code based on the different versions of SSE, as well as the first version of AVX, is conceptually similar, although they differ in the instruction names and formats. We present only instructions that arise in compiling floating-point programs with <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>. These are, for the most part, the scalar AVX instructions, although we document occasions where instructions intended for operating on entire data vectors arise. A more complete coverage of how to exploit the SIMD capabilities of SSE and AVX is presented in Web Aside <span class="pcalibre1 pcalibre29 pcalibre2">opt:simd</span> on page 546. Readers may wish to refer to the AMD and Intel documentation for the individual instructions <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3A8">[4,</a> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B408">51]</a>. As with integer operations, note that the ATT format we use in our presentation differs from the Intel format used in these documents. In particular, the instruction operands are listed in a different order in these two versions.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000003091" id="P7000497027000000000000000003091">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003092" epub:type="pagebreak" id="P7000497027000000000000000003092" title="295"></span>
<img alt="A diagram lists 16 media registers." class="pcalibre137 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B6C5" id="P70004970270000000000000000412C3" src="Images/chapter-03-image-17.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P70004970270000000000000000412C4" id="P70004970270000000000000000412C4"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P70004970270000000000000000412C5" epub:type="title" id="P70004970270000000000000000412C5"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.45 </span>Media registers.</h1></header><div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412C6" id="P70004970270000000000000000412C6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000412C7" id="P70004970270000000000000000412C7">These registers are used to hold floating-point data. Each YMM register holds 32 bytes. The low-order 16 bytes can be accessed as an XMM register.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter03.xhtml#P70004970270000000000000000215A1" id="P70004970270000000000000000215A1">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412C8" id="P70004970270000000000000000412C8">A diagram lists 16 registers, each with values from 0 to 127 within values from 0 to 255, as summarized in the following table.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000412C9" id="P70004970270000000000000000412C9">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000412CA" id="P70004970270000000000000000412CA">Register</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000412CB" id="P70004970270000000000000000412CB">127</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000412CC" id="P70004970270000000000000000412CC">255</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412CD" id="P70004970270000000000000000412CD">1st FP arg./Return value</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412CE" id="P70004970270000000000000000412CE">%xmm0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412CF" id="P70004970270000000000000000412CF">%ymm0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D0" id="P70004970270000000000000000412D0">2nd FP argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D1" id="P70004970270000000000000000412D1">%xmm1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D2" id="P70004970270000000000000000412D2">%ymm1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D3" id="P70004970270000000000000000412D3">3rd FP argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D4" id="P70004970270000000000000000412D4">%xmm2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D5" id="P70004970270000000000000000412D5">%ymm2</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D6" id="P70004970270000000000000000412D6">4th FP argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D7" id="P70004970270000000000000000412D7">%xmm3</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D8" id="P70004970270000000000000000412D8">%ymm3</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412D9" id="P70004970270000000000000000412D9">5th FP argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412DA" id="P70004970270000000000000000412DA">%xmm4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412DB" id="P70004970270000000000000000412DB">%ymm4</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412DC" id="P70004970270000000000000000412DC">6th FP argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412DD" id="P70004970270000000000000000412DD">%xmm5</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412DE" id="P70004970270000000000000000412DE">%ymm5</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412DF" id="P70004970270000000000000000412DF">7th FP argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E0" id="P70004970270000000000000000412E0">%xmm6</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E1" id="P70004970270000000000000000412E1">%ymm6</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E2" id="P70004970270000000000000000412E2">8th FP argument</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E3" id="P70004970270000000000000000412E3">%xmm7</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E4" id="P70004970270000000000000000412E4">%ymm7</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E5" id="P70004970270000000000000000412E5">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E6" id="P70004970270000000000000000412E6">%xmm8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E7" id="P70004970270000000000000000412E7">%ymm8</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E8" id="P70004970270000000000000000412E8">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412E9" id="P70004970270000000000000000412E9">%xmm9</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412EA" id="P70004970270000000000000000412EA">%ymm9</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412EB" id="P70004970270000000000000000412EB">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412EC" id="P70004970270000000000000000412EC">%xmm10</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412ED" id="P70004970270000000000000000412ED">%ymm10</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412EE" id="P70004970270000000000000000412EE">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412EF" id="P70004970270000000000000000412EF">%xmm11</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F0" id="P70004970270000000000000000412F0">%ymm11</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F1" id="P70004970270000000000000000412F1">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F2" id="P70004970270000000000000000412F2">%xmm12</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F3" id="P70004970270000000000000000412F3">%ymm12</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F4" id="P70004970270000000000000000412F4">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F5" id="P70004970270000000000000000412F5">%xmm13</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F6" id="P70004970270000000000000000412F6">%ymm13</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F7" id="P70004970270000000000000000412F7">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F8" id="P70004970270000000000000000412F8">%xmm14</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412F9" id="P70004970270000000000000000412F9">%ymm14</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412FA" id="P70004970270000000000000000412FA">Caller saved</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412FB" id="P70004970270000000000000000412FB">%xmm15</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000412FC" id="P70004970270000000000000000412FC">%ymm15</td>
</tr>
</tbody>
</table>
</details>
</figcaption></figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412FD" id="P70004970270000000000000000412FD">As is illustrated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003091"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.45</span></a>, the AVX floating-point architecture allows data to be stored in 16 YMM registers, named <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412FE" id="P70004970270000000000000000412FE">%ymm0-%ymm15</code>. Each YMM register is 256 bits (32 bytes) long. When operating on scalar data, these registers only hold floating-point data, and only the low-order 32 bits (for float) or 64 bits (for double) are used. The assembly code refers to the registers by their SSE XMM register names <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000412FF" id="P70004970270000000000000000412FF">%xmm0-%xmm15</code>, where each XMM register is the low-order 128 bits (16 bytes) of the corresponding YMM register.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P700049702700000000000000000309B" id="P700049702700000000000000000309B">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000041300" id="P7000497027000000000000000041300">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041301" id="P7000497027000000000000000041301"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P700049702700000000000000000309E" epub:type="pagebreak" id="P700049702700000000000000000309E" title="296"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041302" id="P7000497027000000000000000041302">Source</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041303" id="P7000497027000000000000000041303">Destination</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041304" id="P7000497027000000000000000041304">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041305" id="P7000497027000000000000000041305"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041306" id="P7000497027000000000000000041306">vmovss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041307" id="P7000497027000000000000000041307"><var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041308" id="P7000497027000000000000000041308"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041309" id="P7000497027000000000000000041309">Move single precision</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004130A" id="P700049702700000000000000004130A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004130B" id="P700049702700000000000000004130B">vmovss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004130C" id="P700049702700000000000000004130C"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004130D" id="P700049702700000000000000004130D"><var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004130E" id="P700049702700000000000000004130E">Move single precision</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004130F" id="P700049702700000000000000004130F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041310" id="P7000497027000000000000000041310">vmovsd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041311" id="P7000497027000000000000000041311"><var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">64</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041312" id="P7000497027000000000000000041312"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041313" id="P7000497027000000000000000041313">Move double precision</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041314" id="P7000497027000000000000000041314"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041315" id="P7000497027000000000000000041315">vmovsd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041316" id="P7000497027000000000000000041316"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041317" id="P7000497027000000000000000041317"><var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">64</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041318" id="P7000497027000000000000000041318">Move double precision</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041319" id="P7000497027000000000000000041319"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004131A" id="P700049702700000000000000004131A">vmovaps</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004131B" id="P700049702700000000000000004131B"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004131C" id="P700049702700000000000000004131C"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004131D" id="P700049702700000000000000004131D">Move aligned, packed single precision</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004131E" id="P700049702700000000000000004131E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004131F" id="P700049702700000000000000004131F">vmovapd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041320" id="P7000497027000000000000000041320"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041321" id="P7000497027000000000000000041321"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041322" id="P7000497027000000000000000041322">Move aligned, packed double precision</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041323" id="P7000497027000000000000000041323"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000041324" epub:type="title" id="P7000497027000000000000000041324"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.46 </span>Floating-point movement instructions.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041325" id="P7000497027000000000000000041325"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041326" id="P7000497027000000000000000041326">These operations transfer values between memory and registers, as well as between pairs of registers. (<var class="pcalibre17 pcalibre2 pcalibre1">X</var>: XMM register (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041327" id="P7000497027000000000000000041327">%xmm3</code>); <var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre1 pcalibre2 calibre14">32</sub>: 32-bit memory range; <var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre1 pcalibre2 calibre14">64</sub>: 64-bit memory range)</p></div></figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000030C5" id="P70004970270000000000000000030C5"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041328" epub:type="title" id="P7000497027000000000000000041328"><span class="pcalibre1 pcalibre21 pcalibre2">3.11.1 </span>Floating-Point Movement and Conversion Operations</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041329" id="P7000497027000000000000000041329"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000309B"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.46</span></a> shows a set of instructions for transferring floating-point data between memory and XMM registers, as well as from one XMM register to another without any conversions. Those that reference memory are <i class="pcalibre17 pcalibre2 pcalibre1">scalar</i> instructions, meaning that they operate on individual, rather than packed, data values. The data are held either in memory (indicated in the table as <var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre1 pcalibre2 calibre14">32</sub> and <var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre1 pcalibre2 calibre14">64</sub>) or in XMM registers (shown in the table as <var class="pcalibre17 pcalibre2 pcalibre1">X</var>). These instructions will work correctly regardless of the alignment of data, although the code optimization guidelines recommend that 32-bit memory data satisfy a 4-byte alignment and that 64-bit data satisfy an 8-byte alignment. Memory references are specified in the same way as for the integer <span class="pcalibre1 pcalibre29 pcalibre2">mov </span>instructions, with all of the different possible combinations of displacement, base register, index register, and scaling factor.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004132A" id="P700049702700000000000000004132A">G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>uses the scalar movement operations only to transfer data from memory to an XMM register or from an XMM register to memory. For transferring data between two XMM registers, it uses one of two different instructions for copying the entire contents of one XMM register to another—namely, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004132B" id="P700049702700000000000000004132B">vmovaps</code> for single-precision and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004132C" id="P700049702700000000000000004132C">vmovapd</code> for double-precision values. For these cases, whether the program copies the entire register or just the low-order value affects neither the program functionality nor the execution speed, and so using these instructions rather than ones specific to scalar data makes no real difference. The letter `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004132D" id="P700049702700000000000000004132D">a</code>' in these instruction names stands for "aligned." When used to read and write memory, they will cause an exception if the address does not satisfy a 16-byte alignment. For transferring between two registers, there is no possibility of an incorrect alignment.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004132E" id="P700049702700000000000000004132E">As an example of the different floating-point move operations, consider the C function</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004132F" id="P700049702700000000000000004132F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041330" id="P7000497027000000000000000041330">
float float_mov(float v1, float *src, float *dst) {
	float v2 = *src;
	*dst = v1;
	return v2;
}
</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P70004970270000000000000000030CF" id="P70004970270000000000000000030CF">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000041331" id="P7000497027000000000000000041331">
<thead class="pcalibre44 pcalibre2 pcalibre1"><tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041332" id="P7000497027000000000000000041332"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P70004970270000000000000000030D2" epub:type="pagebreak" id="P70004970270000000000000000030D2" title="297"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041333" id="P7000497027000000000000000041333">Source</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041334" id="P7000497027000000000000000041334">Destination</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041335" id="P7000497027000000000000000041335">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041336" id="P7000497027000000000000000041336"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041337" id="P7000497027000000000000000041337">vcvttss2si</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041338" id="P7000497027000000000000000041338"><var class="pcalibre17 pcalibre2 pcalibre1">X</var>/<var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041339" id="P7000497027000000000000000041339"><var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004133A" id="P700049702700000000000000004133A">Convert with truncation single precision to integer</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004133B" id="P700049702700000000000000004133B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004133C" id="P700049702700000000000000004133C">vcvttsd2si</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004133D" id="P700049702700000000000000004133D"><var class="pcalibre17 pcalibre2 pcalibre1">X</var>/<var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">64</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004133E" id="P700049702700000000000000004133E"><var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004133F" id="P700049702700000000000000004133F">Convert with truncation double precision to integer</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041340" id="P7000497027000000000000000041340"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041341" id="P7000497027000000000000000041341">vcvttss2siq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041342" id="P7000497027000000000000000041342"><var class="pcalibre17 pcalibre2 pcalibre1">X</var>/<var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041343" id="P7000497027000000000000000041343"><var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre97 pcalibre2 pcalibre1">64</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041344" id="P7000497027000000000000000041344">Convert with truncation single precision to quad word integer</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041345" id="P7000497027000000000000000041345"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041346" id="P7000497027000000000000000041346">vcvttsd2siq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041347" id="P7000497027000000000000000041347"><var class="pcalibre17 pcalibre2 pcalibre1">X</var>/<var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">64</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041348" id="P7000497027000000000000000041348"><var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre97 pcalibre2 pcalibre1">64</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041349" id="P7000497027000000000000000041349">Convert with truncation double precision to quad word integer</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P700049702700000000000000004134A" id="P700049702700000000000000004134A"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P700049702700000000000000004134B" epub:type="title" id="P700049702700000000000000004134B"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.47 </span>Two-operand floating-point conversion operations.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004134C" id="P700049702700000000000000004134C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004134D" id="P700049702700000000000000004134D">These convert floating-point data to integers. (<var class="pcalibre17 pcalibre2 pcalibre1">X</var>: XMM register (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004134E" id="P700049702700000000000000004134E">%xmm3</code>); <var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre1 pcalibre2 calibre14">32</sub>: 32-bit general-purpose register (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004134F" id="P700049702700000000000000004134F">%eax</code>); <var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre1 pcalibre2 calibre14">64</sub>: 64-bit general-purpose register (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041350" id="P7000497027000000000000000041350">%rax</code>); <var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre1 pcalibre2 calibre14">32</sub>: 32-bit memory range; <var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre1 pcalibre2 calibre14">64</sub>: 64-bit memory range)</p></div></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P70004970270000000000000000030F1" id="P70004970270000000000000000030F1">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000041351" id="P7000497027000000000000000041351">
<thead class="pcalibre44 pcalibre2 pcalibre1"><tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041352" id="P7000497027000000000000000041352">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041353" id="P7000497027000000000000000041353">Source 1</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041354" id="P7000497027000000000000000041354">Source 2</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041355" id="P7000497027000000000000000041355">Destination</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041356" id="P7000497027000000000000000041356">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041357" id="P7000497027000000000000000041357"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041358" id="P7000497027000000000000000041358">vcvtsi2ss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041359" id="P7000497027000000000000000041359"><var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub>/<var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004135A" id="P700049702700000000000000004135A"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004135B" id="P700049702700000000000000004135B"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004135C" id="P700049702700000000000000004135C">Convert integer to single precision</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004135D" id="P700049702700000000000000004135D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004135E" id="P700049702700000000000000004135E">vcvtsi2sd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004135F" id="P700049702700000000000000004135F"><var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub>/<var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041360" id="P7000497027000000000000000041360"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041361" id="P7000497027000000000000000041361"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041362" id="P7000497027000000000000000041362">Convert integer to double precision</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041363" id="P7000497027000000000000000041363"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041364" id="P7000497027000000000000000041364">vcvtsi2ssq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041365" id="P7000497027000000000000000041365"><var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre97 pcalibre2 pcalibre1">32</sub>/<var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre97 pcalibre2 pcalibre1">64</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041366" id="P7000497027000000000000000041366"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041367" id="P7000497027000000000000000041367"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041368" id="P7000497027000000000000000041368">Convert quad word integer to single precision</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041369" id="P7000497027000000000000000041369"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004136A" id="P700049702700000000000000004136A">vcvtsi2sdq</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004136B" id="P700049702700000000000000004136B"><var class="pcalibre17 pcalibre2 pcalibre1">M</var>/<var class="pcalibre17 pcalibre2 pcalibre1">R</var><sub class="pcalibre97 pcalibre2 pcalibre1">64</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004136C" id="P700049702700000000000000004136C"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004136D" id="P700049702700000000000000004136D"><var class="pcalibre17 pcalibre2 pcalibre1">X</var></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004136E" id="P700049702700000000000000004136E">Convert quad word integer to double precision</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P700049702700000000000000004136F" id="P700049702700000000000000004136F"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000041370" epub:type="title" id="P7000497027000000000000000041370"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.48 </span>Three-operand floating-point conversion operations.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041371" id="P7000497027000000000000000041371"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041372" id="P7000497027000000000000000041372">These instructions convert from the data type of the first source to the data type of the destination. The second source value has no effect on the low-order bytes of the result. (<var class="pcalibre17 pcalibre2 pcalibre1">X</var>: XMM register (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041373" id="P7000497027000000000000000041373">%xmm3</code>); <var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre1 pcalibre2 calibre14">32</sub>: 32-bit memory range; <var class="pcalibre17 pcalibre2 pcalibre1">M</var><sub class="pcalibre1 pcalibre2 calibre14">64</sub>: 64-bit memory range)</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041374" id="P7000497027000000000000000041374">and its associated x86-64 assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041375" id="P7000497027000000000000000041375"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041376" id="P7000497027000000000000000041376">
	<i class="pcalibre17 pcalibre2 pcalibre1">float float_mov(float v1, float *src, float *dst)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">v1 in %xmm0, src in %rdi, dst in %rsi</i>
1	float_mov:
2	vmovaps	%xmm0, %xmm1	<i class="pcalibre17 pcalibre2 pcalibre1">Copy v1</i>
3	vmovss	(%rdi), %xmm0	<i class="pcalibre17 pcalibre2 pcalibre1">Read v2 from src</i>
4	vmovss	%xmm1, (%rsi)	<i class="pcalibre17 pcalibre2 pcalibre1">Write v1 to dst</i>
5	ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return v2 in %xmm0</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041377" id="P7000497027000000000000000041377">We can see in this example the use of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041378" id="P7000497027000000000000000041378">vmovaps</code> instruction to copy data from one register to another and the use of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041379" id="P7000497027000000000000000041379">vmovss</code> instruction to copy data from memory to an XMM register and from an XMM register to memory.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004137A" id="P700049702700000000000000004137A"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000030CF"><span class="pcalibre1 pcalibre21 pcalibre2">Figures </span><span class="pcalibre1 pcalibre21 pcalibre2">3.47</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000030F1"><span class="pcalibre1 pcalibre21 pcalibre2">3.48</span></a> show sets of instructions for converting between floating-point and integer data types, as well as between different floating-point formats. These are all scalar instructions operating on individual data values. Those in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000030CF"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.47</span></a> convert from a floating-point value read from either an XMM register or memory and write the result to a general-purpose register (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004137B" id="P700049702700000000000000004137B">%rax, %ebx</code>, etc.). When converting floating-point values to integers, they perform <i class="pcalibre17 pcalibre2 pcalibre1">truncation</i>, rounding values toward zero, as is required by C and most other programming languages.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004137C" id="P700049702700000000000000004137C">The instructions in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000030F1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.48</span></a> convert from integer to floating point. They use an unusual three-operand format, with two sources and a destination. The <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000311E" epub:type="pagebreak" id="P700049702700000000000000000311E" title="298"></span>first operand is read from memory or from a general-purpose register. For our purposes, we can ignore the second operand, since its value only affects the upper bytes of the result. The destination must be an XMM register. In common usage, both the second source and the destination operands are identical, as in the instruction</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004137D" id="P700049702700000000000000004137D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004137E" id="P700049702700000000000000004137E">
vcvtsi2sdq	%rax, %xmm1, %xmm1
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004137F" id="P700049702700000000000000004137F">This instruction reads a long integer from register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041380" id="P7000497027000000000000000041380">%rax</code>, converts it to data type double, and stores the result in the lower bytes of XMM register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041381" id="P7000497027000000000000000041381">%xmm1</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041382" id="P7000497027000000000000000041382">Finally, for converting between two different floating-point formats, current versions of <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generate code that requires separate documentation. Suppose the low-order 4 bytes of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041383" id="P7000497027000000000000000041383">%xmm0</code> hold a single-precision value; then it would seem straightforward to use the instruction</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041384" id="P7000497027000000000000000041384"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041385" id="P7000497027000000000000000041385">
vcvtss2sd	%xmm0, %xmm0, %xmm0
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041386" id="P7000497027000000000000000041386">to convert this to a double-precision value and store the result in the lower 8 bytes of register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041387" id="P7000497027000000000000000041387">%xmm0</code>. Instead, we find the following code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041388" id="P7000497027000000000000000041388"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041389" id="P7000497027000000000000000041389">
	<i class="pcalibre17 pcalibre2 pcalibre1">Conversion from single to double precision</i>
1	vunpcklps	%xmm0, %xmm0, %xmm0	<i class="pcalibre17 pcalibre2 pcalibre1">Replicate first vector element</i>
2	vcvtps2pd	%xmm0, %xmm0		<i class="pcalibre17 pcalibre2 pcalibre1">Convert two vector elements to double</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004138A" id="P700049702700000000000000004138A">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004138B" id="P700049702700000000000000004138B">vunpcklps</code> instruction is normally used to interleave the values in two XMM registers and store them in a third. That is, if one source register contains words [<var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">3</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>] and the other contains words [<var class="pcalibre17 pcalibre2 pcalibre1">d</var><sub class="pcalibre1 pcalibre2 calibre14">3</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">d</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">d</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">d</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>], then the value of the destination register will be [<var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">d</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">d</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>]. In the code above, we see the same register being used for all three operands, and so if the original register held values [<var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">3</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>], then the instruction will update the register to hold values [<var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>]. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004138C" id="P700049702700000000000000004138C">vcvtps2pd</code> instruction expands the two low-order single-precision values in the source XMM register to be the two double-precision values in the destination XMM register. Applying this to the result of the preceding <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004138D" id="P700049702700000000000000004138D">vunpcklps</code> instruction would give values [<i class="pcalibre17 pcalibre2 pcalibre1">dx</i><sub class="pcalibre1 pcalibre2 calibre14">0</sub>, <i class="pcalibre17 pcalibre2 pcalibre1">dx</i><sub class="pcalibre1 pcalibre2 calibre14">0</sub>], where <i class="pcalibre17 pcalibre2 pcalibre1">dx</i><sub class="pcalibre1 pcalibre2 calibre14">0</sub> is the result of converting <var class="pcalibre17 pcalibre2 pcalibre1">x</var> to double precision. That is, the net effect of the two instructions is to convert the original single-precision value in the low-order 4 bytes of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004138E" id="P700049702700000000000000004138E">%xmm0</code> to double precision and store two copies of it in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004138F" id="P700049702700000000000000004138F">%xmm0</code>. It is unclear why <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates this code. There is neither benefit nor need to have the value duplicated within the XMM register.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041390" id="P7000497027000000000000000041390">G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>generates similar code for converting from double precision to single precision:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041391" id="P7000497027000000000000000041391"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041392" id="P7000497027000000000000000041392">
<i class="pcalibre17 pcalibre2 pcalibre1">Conversion from double to single precision</i>
1	vmovddup	%xmm0, %xmm0	<i class="pcalibre17 pcalibre2 pcalibre1">Replicate first vector element</i>
2	vcvtpd2psx	%xmm0, %xmm0	<i class="pcalibre17 pcalibre2 pcalibre1">Convert two vector elements to single</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041393" id="P7000497027000000000000000041393"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003136" epub:type="pagebreak" id="P7000497027000000000000000003136" title="299"></span>Suppose these instructions start with register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041394" id="P7000497027000000000000000041394">%xmm0</code> holding two double-precision values [<var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>]. Then the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041395" id="P7000497027000000000000000041395">vmovddup</code> instruction will set it to [<var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>]. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041396" id="P7000497027000000000000000041396">vcvtpd2psx</code> instruction will convert these values to single precision, pack them into the low-order half of the register, and set the upper half to 0, yielding a result [0.0, 0.0, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">x</var><sub class="pcalibre1 pcalibre2 calibre14">0</sub>] (recall that floating-point value 0.0 is represented by a bit pattern of all zeros). Again, there is no clear value in computing the conversion from one precision to another this way, rather than by using the single instruction</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041397" id="P7000497027000000000000000041397"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041398" id="P7000497027000000000000000041398">
vcvtsd2ss %xmm0, %xmm0, %xmm0
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041399" id="P7000497027000000000000000041399">As an example of the different floating-point conversion operations, consider the C function</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004139A" id="P700049702700000000000000004139A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004139B" id="P700049702700000000000000004139B">
double fcvt(int i, float *fp, double *dp, long *lp)
{
	float f = *fp; double d = *dp; long l = *lp;
	*lp = (long) d;
	*fp = (float) i;
	*dp = (double) l;
	return (double) f;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004139C" id="P700049702700000000000000004139C">and its associated x86-64 assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004139D" id="P700049702700000000000000004139D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004139E" id="P700049702700000000000000004139E">
	<i class="pcalibre17 pcalibre2 pcalibre1">double fcvt(int i, float *fp, double *dp, long *lp)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">i in %edi, fp in %rsi, dp in %rdx, lp in %rcx</i>
1	fcvt:
2	 vmovss	(%rsi), %xmm0			<i class="pcalibre17 pcalibre2 pcalibre1">Get f = *fp</i>
3	 movq	(%rcx), %rax			<i class="pcalibre17 pcalibre2 pcalibre1">Get l = *lp</i>
4	 vcvttsd2siq	(%rdx), %r8		<i class="pcalibre17 pcalibre2 pcalibre1">Get d = *dp and convert to long</i>
5	 movq	%r8, (%rcx)			<i class="pcalibre17 pcalibre2 pcalibre1">Store at lp</i>
6	 vcvtsi2ss	%edi, %xmm1, %xmm1	<i class="pcalibre17 pcalibre2 pcalibre1">Convert i to float</i>
7	 vmovss	%xmm1, (%rsi)			<i class="pcalibre17 pcalibre2 pcalibre1">Store at fp</i>
8	 vcvtsi2sdq	%rax, %xmm1, %xmm1	<i class="pcalibre17 pcalibre2 pcalibre1">Convert l to double</i>
9	 vmovsd	%xmm1, (%rdx)			<i class="pcalibre17 pcalibre2 pcalibre1">Store at dp</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">The following two instructions convert f to double</i>
10	 vunpcklps	%xmm0, %xmm0, %xmm0
11	 vcvtps2pd	%xmm0, %xmm0
12	 ret					<i class="pcalibre17 pcalibre2 pcalibre1">Return f</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004139F" id="P700049702700000000000000004139F">All of the arguments to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413A0" id="P70004970270000000000000000413A0">fcvt</code> are passed through the general-purpose registers, since they are either integers or pointers. The result is returned in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413A1" id="P70004970270000000000000000413A1">%xmm0</code>. As is documented in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003091"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.45</span></a>, this is the designated return register for float or double values. In this code, we see a number of the movement and conversion instructions of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000309B"><span class="pcalibre1 pcalibre21 pcalibre2">Figures </span><span class="pcalibre1 pcalibre21 pcalibre2">3.46</span></a>–<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000030F1"><span class="pcalibre1 pcalibre21 pcalibre2">3.48</span></a>, as well as <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>'s preferred method of converting from single to double precision.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003145" epub:type="practice" id="P7000497027000000000000000003145"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413A2" epub:type="title" id="P70004970270000000000000000413A2"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003147" epub:type="pagebreak" id="P7000497027000000000000000003147" title="300"></span><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.50 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003968">347</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000413A3" id="P70004970270000000000000000413A3">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000413A4" id="P70004970270000000000000000413A4">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413A5" id="P70004970270000000000000000413A5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413A6" id="P70004970270000000000000000413A6">For the following C code, the expressions <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413A7" id="P70004970270000000000000000413A7">val1-val4</code> all map to the program values <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413A8" id="P70004970270000000000000000413A8">i, f, d</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413A9" id="P70004970270000000000000000413A9">l</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413AA" id="P70004970270000000000000000413AA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413AB" id="P70004970270000000000000000413AB">
double fcvt2(int *ip, float *fp, double *dp, long l)
{
	int i = *ip; float f = *fp; double d = *dp;
	*ip = (int)	val1;
	*fp = (float)	val2;
	*dp = (double)	val3;
	return (double)	val4;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413AC" id="P70004970270000000000000000413AC">Determine the mapping, based on the following x86-64 code for the function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413AD" id="P70004970270000000000000000413AD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413AE" id="P70004970270000000000000000413AE">
	<i class="pcalibre17 pcalibre2 pcalibre1">double fcvt2(int *ip, float *fp, double *dp, long l) ip in %rdi, fp in %rsi, dp in %rdx, l in %rcx Result returned in %xmm0</i>
1	fcvt2:
2	 movl	(%rdi), %eax
3	 vmovss	(%rsi), %xmm0
4	 vcvttsd2si	(%rdx), %r8d
5	 movl %r8d,	(%rdi)
6	 vcvtsi2ss	%eax, %xmm1, %xmm1
7	 vmovss %xmm1,	(%rsi)
8	 vcvtsi2sdq	%rcx, %xmm1, %xmm1
9	 vmovsd	%xmm1, (%rdx)
10	 vunpcklps	%xmm0, %xmm0, %xmm0
11	 vcvtps2pd	%xmm0, %xmm0
12	 ret
</code></pre>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003154" epub:type="practice" id="P7000497027000000000000000003154"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413AF" epub:type="title" id="P70004970270000000000000000413AF"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.51 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P70004970270000000000000000039B2">348</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000413B0" id="P70004970270000000000000000413B0">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000413B1" id="P70004970270000000000000000413B1">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413B2" id="P70004970270000000000000000413B2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413B3" id="P70004970270000000000000000413B3">The following C function converts an argument of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413B4" id="P70004970270000000000000000413B4">src_t</code> to a return value of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413B5" id="P70004970270000000000000000413B5">dst_t</code>, where these two types are defined using <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413B6" id="P70004970270000000000000000413B6">typedef</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413B7" id="P70004970270000000000000000413B7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413B8" id="P70004970270000000000000000413B8">
dest_t cvt(src_t x)
{
	dest_t y = (dest_t) x;
	return y;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413B9" id="P70004970270000000000000000413B9">For execution on x86-64, assume that argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413BA" id="P70004970270000000000000000413BA">x</code> is either in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413BB" id="P70004970270000000000000000413BB">%xmm0</code> or in the appropriately named portion of register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413BC" id="P70004970270000000000000000413BC">%rdi</code> (i.e., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413BD" id="P70004970270000000000000000413BD">%rdi</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413BE" id="P70004970270000000000000000413BE">%edi</code>). One or two instructions are to be used to perform the type conversion and to copy the value to the appropriately named portion of register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413BF" id="P70004970270000000000000000413BF">%rax</code> (integer result) or <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003166" epub:type="pagebreak" id="P7000497027000000000000000003166" title="301"></span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413C0" id="P70004970270000000000000000413C0">%xmm0</code> (floating-point result). Show the instruction(s), including the source and destination registers.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000413C1" id="P70004970270000000000000000413C1">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000413C2" id="P70004970270000000000000000413C2"><var class="pcalibre17 pcalibre2 pcalibre1">T</var><sub class="pcalibre97 pcalibre2 pcalibre1">x</sub></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000413C3" id="P70004970270000000000000000413C3"><var class="pcalibre17 pcalibre2 pcalibre1">T</var><sub class="pcalibre97 pcalibre2 pcalibre1">y</sub></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000413C4" id="P70004970270000000000000000413C4">Instruction(s)</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413C5" id="P70004970270000000000000000413C5">long</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413C6" id="P70004970270000000000000000413C6">double</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413C7" id="P70004970270000000000000000413C7">vcvtsi2sdq %rdi, %xmm0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413C8" id="P70004970270000000000000000413C8">double</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413C9" id="P70004970270000000000000000413C9">int</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413CA" id="P70004970270000000000000000413CA">____________________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413CB" id="P70004970270000000000000000413CB">double</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413CC" id="P70004970270000000000000000413CC">float</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413CD" id="P70004970270000000000000000413CD">____________________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413CE" id="P70004970270000000000000000413CE">long</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413CF" id="P70004970270000000000000000413CF">float</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413D0" id="P70004970270000000000000000413D0">____________________</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413D1" id="P70004970270000000000000000413D1">float</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413D2" id="P70004970270000000000000000413D2">long</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413D3" id="P70004970270000000000000000413D3">____________________</td>
</tr>
</tbody>
</table>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000317B" id="P700049702700000000000000000317B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413D4" epub:type="title" id="P70004970270000000000000000413D4"><span class="pcalibre1 pcalibre21 pcalibre2">3.11.2 </span>Floating-Point Code in Procedures</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413D5" id="P70004970270000000000000000413D5">With x86-64, the XMM registers are used for passing floating-point arguments to functions and for returning floating-point values from them. As is illustrated in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003091"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.45</span></a>, the following conventions are observed:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413D6" id="P70004970270000000000000000413D6">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413D7" id="P70004970270000000000000000413D7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413D8" id="P70004970270000000000000000413D8">Up to eight floating-point arguments can be passed in XMM registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413D9" id="P70004970270000000000000000413D9">%xmm0–%xmm7</code>. These registers are used in the order the arguments are listed. Additional floating-point arguments can be passed on the stack.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413DA" id="P70004970270000000000000000413DA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413DB" id="P70004970270000000000000000413DB">A function that returns a floating-point value does so in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413DC" id="P70004970270000000000000000413DC">%xmm0</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413DD" id="P70004970270000000000000000413DD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413DE" id="P70004970270000000000000000413DE">All XMM registers are caller saved. The callee may overwrite any of these registers without first saving it.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413DF" id="P70004970270000000000000000413DF">When a function contains a combination of pointer, integer, and floating-point arguments, the pointers and integers are passed in general-purpose registers, while the floating-point values are passed in XMM registers. This means that the mapping of arguments to registers depends on both their types and their ordering. Here are several examples:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413E0" id="P70004970270000000000000000413E0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413E1" id="P70004970270000000000000000413E1">
double f1(int x, double y, long z);
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413E2" id="P70004970270000000000000000413E2">This function would have <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413E3" id="P70004970270000000000000000413E3">x</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413E4" id="P70004970270000000000000000413E4">%edi, y</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413E5" id="P70004970270000000000000000413E5">%xmm0,</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413E6" id="P70004970270000000000000000413E6">z</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413E7" id="P70004970270000000000000000413E7">%rsi</code>.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413E8" id="P70004970270000000000000000413E8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413E9" id="P70004970270000000000000000413E9">
double f2(double y, int x, long z);
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413EA" id="P70004970270000000000000000413EA">This function would have the same register assignment as function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413EB" id="P70004970270000000000000000413EB">f1</code>.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413EC" id="P70004970270000000000000000413EC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413ED" id="P70004970270000000000000000413ED">
double f1(float x, double *y, long *z);
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413EE" id="P70004970270000000000000000413EE">This function would have <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413EF" id="P70004970270000000000000000413EF">x</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413F0" id="P70004970270000000000000000413F0">%xmm0, y</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413F1" id="P70004970270000000000000000413F1">%rdi</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413F2" id="P70004970270000000000000000413F2">z</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413F3" id="P70004970270000000000000000413F3">%rsi.</code></p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000319C" epub:type="practice" id="P700049702700000000000000000319C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413F4" epub:type="title" id="P70004970270000000000000000413F4"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.52 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P70004970270000000000000000039B2">348</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000413F5" id="P70004970270000000000000000413F5">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000413F6" id="P70004970270000000000000000413F6">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000413F7" id="P70004970270000000000000000413F7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413F8" id="P70004970270000000000000000413F8">For each of the following function declarations, determine the register assignments for the arguments:</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000413F9" id="P70004970270000000000000000413F9">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413FA" id="P70004970270000000000000000413FA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413FB" id="P70004970270000000000000000413FB"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413FC" id="P70004970270000000000000000413FC">double g1(double a, long b, float c, int d);</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000413FD" id="P70004970270000000000000000413FD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000413FE" id="P70004970270000000000000000413FE"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000031A8" epub:type="pagebreak" id="P70004970270000000000000000031A8" title="302"></span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000413FF" id="P70004970270000000000000000413FF">double g2(int a, double *b, float *c, long d);</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041400" id="P7000497027000000000000000041400"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041401" id="P7000497027000000000000000041401"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041402" id="P7000497027000000000000000041402">double g3(double *a, double b, int c, float d);</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041403" id="P7000497027000000000000000041403"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041404" id="P7000497027000000000000000041404"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041405" id="P7000497027000000000000000041405">double g4(float a, int *b, float c, double d);</code></p></li>
</ol></div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000031B0" id="P70004970270000000000000000031B0"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041406" epub:type="title" id="P7000497027000000000000000041406"><span class="pcalibre1 pcalibre21 pcalibre2">3.11.3 </span>Floating-Point Arithmetic Operations</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041407" id="P7000497027000000000000000041407"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000031B9"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.49</span></a> documents a set of scalar AVX2 floating-point instructions that perform arithmetic operations. Each has either one (<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>) or two (<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub>) source operands and a destination operand <var class="pcalibre17 pcalibre2 pcalibre1">D</var>. The first source operand <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub> can be either an XMM register or a memory location. The second source operand and the destination operands must be XMM registers. Each operation has an instruction for single precision and an instruction for double precision. The result is stored in the destination register.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041408" id="P7000497027000000000000000041408">As an example, consider the following floating-point function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041409" id="P7000497027000000000000000041409"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004140A" id="P700049702700000000000000004140A">
double funct(double a, float x, double b, int i)
{
	return a*x - b/i;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004140B" id="P700049702700000000000000004140B">The x86-64 code is as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004140C" id="P700049702700000000000000004140C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004140D" id="P700049702700000000000000004140D">
	<i class="pcalibre17 pcalibre2 pcalibre1">double funct(double a, float x, double b, int i)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">a in %xmm0, x in %xmm1, b in %xmm2, i in %edi</i>
1	funct:
	<i class="pcalibre17 pcalibre2 pcalibre1">The following two instructions convert x to double</i>
2	vunpcklps	%xmm1, %xmm1, %xmm1
3	vcvtps2pd	%xmm1, %xmm1
4	vmulsd	%xmm0, %xmm1, %xmm0		<i class="pcalibre17 pcalibre2 pcalibre1">Multiply a by x</i>
5	vcvtsi2sd	%edi, %xmm1, %xmm1	<i class="pcalibre17 pcalibre2 pcalibre1">Convert i to double</i>
6	vdivsd	%xmm1, %xmm2, %xmm2		<i class="pcalibre17 pcalibre2 pcalibre1">Compute b/i</i>
</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P70004970270000000000000000031B9" id="P70004970270000000000000000031B9">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P700049702700000000000000004140E" id="P700049702700000000000000004140E">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004140F" id="P700049702700000000000000004140F">Single</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041410" id="P7000497027000000000000000041410">Double</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041411" id="P7000497027000000000000000041411">Effect</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041412" id="P7000497027000000000000000041412">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041413" id="P7000497027000000000000000041413"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041414" id="P7000497027000000000000000041414">vaddss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041415" id="P7000497027000000000000000041415"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041416" id="P7000497027000000000000000041416">vaddsd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041417" id="P7000497027000000000000000041417"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub> +<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041418" id="P7000497027000000000000000041418">Floating-point add</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041419" id="P7000497027000000000000000041419"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004141A" id="P700049702700000000000000004141A">vsubss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004141B" id="P700049702700000000000000004141B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004141C" id="P700049702700000000000000004141C">vsubsd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004141D" id="P700049702700000000000000004141D"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub> -<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004141E" id="P700049702700000000000000004141E">Floating-point subtract</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004141F" id="P700049702700000000000000004141F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041420" id="P7000497027000000000000000041420">vmulss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041421" id="P7000497027000000000000000041421"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041422" id="P7000497027000000000000000041422">vmulsd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041423" id="P7000497027000000000000000041423"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub> × <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041424" id="P7000497027000000000000000041424">Floating-point multiply</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041425" id="P7000497027000000000000000041425"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041426" id="P7000497027000000000000000041426">vdivss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041427" id="P7000497027000000000000000041427"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041428" id="P7000497027000000000000000041428">vdivsd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041429" id="P7000497027000000000000000041429"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub>/<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004142A" id="P700049702700000000000000004142A">Floating-point divide</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004142B" id="P700049702700000000000000004142B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004142C" id="P700049702700000000000000004142C">vmaxss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004142D" id="P700049702700000000000000004142D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004142E" id="P700049702700000000000000004142E">vmaxsd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004142F" id="P700049702700000000000000004142F"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← max(<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041430" id="P7000497027000000000000000041430">Floating-point maximum</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041431" id="P7000497027000000000000000041431"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041432" id="P7000497027000000000000000041432">vminss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041433" id="P7000497027000000000000000041433"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041434" id="P7000497027000000000000000041434">vminsd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041435" id="P7000497027000000000000000041435"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← min(<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>)</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041436" id="P7000497027000000000000000041436">Floating-point minimum</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041437" id="P7000497027000000000000000041437"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041438" id="P7000497027000000000000000041438">sqrtss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041439" id="P7000497027000000000000000041439"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004143A" id="P700049702700000000000000004143A">sqrtsd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004143B" id="P700049702700000000000000004143B"><span class="pcalibre1 pcalibre2 pcalibre98"><m:math altimg="../images/ch03-eq8.png" altimg-height="18" altimg-width="69" alttext="" data-uri="" display="inline"><m:mrow><m:mi>D</m:mi><m:mo>←</m:mo><m:msqrt><m:mrow><m:msub><m:mi>S</m:mi><m:mn>1</m:mn></m:msub></m:mrow></m:msqrt></m:mrow></m:math></span></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004143C" id="P700049702700000000000000004143C">Floating-point square root</td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P700049702700000000000000004143D" id="P700049702700000000000000004143D"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P700049702700000000000000004143E" epub:type="title" id="P700049702700000000000000004143E"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.49 </span>Scalar floating-point arithmetic operations.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004143F" id="P700049702700000000000000004143F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041440" id="P7000497027000000000000000041440">These have either one or two source operands and a destination operand.</p></div></figcaption>
</figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041441" id="P7000497027000000000000000041441"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041442" id="P7000497027000000000000000041442">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000031EF" epub:type="pagebreak" id="P70004970270000000000000000031EF" title="303"></span>7	vsubsd	%xmm2, %xmm0, %xmm0	<i class="pcalibre17 pcalibre2 pcalibre1">Subtract from a*x</i>
8	ret				<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041443" id="P7000497027000000000000000041443">The three floating-point arguments <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041444" id="P7000497027000000000000000041444">a, x</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041445" id="P7000497027000000000000000041445">b</code> are passed in XMM registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041446" id="P7000497027000000000000000041446">%xmm0-%xmm2</code>, while integer argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041447" id="P7000497027000000000000000041447">i</code> is passed in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041448" id="P7000497027000000000000000041448">%edi</code>. The standard two-instruction sequence is used to convert argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041449" id="P7000497027000000000000000041449">x</code> to double (lines 2-3). Another conversion instruction is required to convert argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004144A" id="P700049702700000000000000004144A">i</code> to double (line 5). The function value is returned in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004144B" id="P700049702700000000000000004144B">%xmm0</code>.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000031F9" epub:type="practice" id="P70004970270000000000000000031F9"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004144C" epub:type="title" id="P700049702700000000000000004144C"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.53 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P70004970270000000000000000039B2">348</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004144D" id="P700049702700000000000000004144D">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004144E" id="P700049702700000000000000004144E">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004144F" id="P700049702700000000000000004144F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041450" id="P7000497027000000000000000041450">For the following C function, the types of the four arguments are defined by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041451" id="P7000497027000000000000000041451">typedef</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041452" id="P7000497027000000000000000041452"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041453" id="P7000497027000000000000000041453">
double funct1(arg1_t p, arg2_t q, arg3_t r, arg4_t s)
{
	return p/(q+r) - s;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041454" id="P7000497027000000000000000041454">When compiled, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041455" id="P7000497027000000000000000041455"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041456" id="P7000497027000000000000000041456">
	<i class="pcalibre17 pcalibre2 pcalibre1">double funct1(arg1_t p, arg2_t q, arg3_t r, arg4_t s)</i>
1	funct1:
2	  vcvtsi2ssq	%rsi, %xmm2, %xmm2
3	  vaddss	%xmm0, %xmm2, %xmm0
4	  vcvtsi2ss	%edi, %xmm2, %xmm2
5	  vdivss	%xmm0, %xmm2, %xmm0
6	  vunpcklps	%xmm0, %xmm0, %xmm0
7	  vcvtps2pd	%xmm0, %xmm0
8	  vsubsd	%xmm1, %xmm0, %xmm0
9	  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041457" id="P7000497027000000000000000041457">Determine the possible combinations of types of the four arguments (there may be more than one).</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003206" epub:type="practice" id="P7000497027000000000000000003206"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041458" epub:type="title" id="P7000497027000000000000000041458"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.54 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003A2D">349</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041459" id="P7000497027000000000000000041459">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004145A" id="P700049702700000000000000004145A">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004145B" id="P700049702700000000000000004145B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004145C" id="P700049702700000000000000004145C">Function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004145D" id="P700049702700000000000000004145D">funct2</code> has the following prototype:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004145E" id="P700049702700000000000000004145E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004145F" id="P700049702700000000000000004145F">
double funct2(double w, int x, float y, long z);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041460" id="P7000497027000000000000000041460">G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>generates the following code for the function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041461" id="P7000497027000000000000000041461"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041462" id="P7000497027000000000000000041462">
	<i class="pcalibre17 pcalibre2 pcalibre1">double funct2(double w, int x, float y, long z) w in %xmm0, x in %edi, y in %xmm1, z in %rsi</i>
1	funct2:
2	  vcvtsi2ss	%edi, %xmm2, %xmm2
3	  vmulss	%xmm1, %xmm2, %xmm1
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003212" epub:type="pagebreak" id="P7000497027000000000000000003212" title="304"></span>4	  vunpcklps	%xmm1, %xmm1, %xmm1
5	  vcvtps2pd	%xmm1, %xmm2
6	  vcvtsi2sdq	%rsi, %xmm1, %xmm1
7	  vdivsd	%xmm1, %xmm0, %xmm0
8	  vsubsd	%xmm0, %xmm2, %xmm0
9	  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041463" id="P7000497027000000000000000041463">Write a C version of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041464" id="P7000497027000000000000000041464">funct2</code>.</p>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003215" id="P7000497027000000000000000003215"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041465" epub:type="title" id="P7000497027000000000000000041465"><span class="pcalibre1 pcalibre21 pcalibre2">3.11.4 </span>Defining and Using Floating-Point Constants</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041466" id="P7000497027000000000000000041466">Unlike integer arithmetic operations, AVX floating-point operations cannot have immediate values as operands. Instead, the compiler must allocate and initialize storage for any constant values. The code then reads the values from memory. This is illustrated by the following Celsius to Fahrenheit conversion function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041467" id="P7000497027000000000000000041467"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041468" id="P7000497027000000000000000041468">
double cel2fahr(double temp)
{
	return 1.8 * temp + 32.0;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041469" id="P7000497027000000000000000041469">The relevant parts of the x86-64 assembly code are as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004146A" id="P700049702700000000000000004146A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004146B" id="P700049702700000000000000004146B">
	<i class="pcalibre17 pcalibre2 pcalibre1">double cel2fahr(double temp) temp in %xmm0</i>
1	cel2fahr:
2	  vmulsd	.LC2(%rip), %xmm0, %xmm0	<i class="pcalibre17 pcalibre2 pcalibre1">Multiply by 1.8</i>
3	  vaddsd	.LC3(%rip), %xmm0, %xmm0	<i class="pcalibre17 pcalibre2 pcalibre1">Add 32.0</i>
4	  ret
5	.LC2:
6	  .long	3435973837				<i class="pcalibre17 pcalibre2 pcalibre1">Low-order 4 bytes of 1.8</i>
7	  .long	1073532108				<i class="pcalibre17 pcalibre2 pcalibre1">High-order 4 bytes of 1.8</i>
8	.LC3:
9	  .long	0					<i class="pcalibre17 pcalibre2 pcalibre1">Low-order 4 bytes of 32.0</i>
10	  .long	1077936128				<i class="pcalibre17 pcalibre2 pcalibre1">High-order 4 bytes of 32.0</i>
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004146C" id="P700049702700000000000000004146C">We see that the function reads the value 1.8 from the memory location labeled <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004146D" id="P700049702700000000000000004146D">.LC2</code> and the value 32.0 from the memory location labeled <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004146E" id="P700049702700000000000000004146E">.LC3.</code> Looking at the values associated with these labels, we see that each is specified by a pair of .long declarations with the values given in decimal. How should these be interpreted as floating-point values? Looking at the declaration labeled .<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004146F" id="P700049702700000000000000004146F">LC2</code>, we see that the two values are 3435973837 (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041470" id="P7000497027000000000000000041470">0xcccccccd</code>) and 1073532108 (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041471" id="P7000497027000000000000000041471">0x3ffccccc</code>.) Since the machine uses little-endian byte ordering, the first value gives the low-order 4 bytes, while the second gives the high-order 4 bytes. From the high-order bytes, we can extract an exponent field of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041472" id="P7000497027000000000000000041472">0x3ff</code> (1023), from which we subtract a bias of 1023 to get an exponent of 0. Concatenating the fraction bits of the two values, we get a fraction field of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041473" id="P7000497027000000000000000041473">0xccccccccccccd</code>, which can be shown to be the fractional binary representation of 0.8, to which we add the implied leading one to get 1.8.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000003225" id="P7000497027000000000000000003225">
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000041474" id="P7000497027000000000000000041474">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041475" id="P7000497027000000000000000041475"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000003228" epub:type="pagebreak" id="P7000497027000000000000000003228" title="305"></span>Single</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041476" id="P7000497027000000000000000041476">Double</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041477" id="P7000497027000000000000000041477">Effect</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041478" id="P7000497027000000000000000041478">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041479" id="P7000497027000000000000000041479"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004147A" id="P700049702700000000000000004147A">vxorps</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004147B" id="P700049702700000000000000004147B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004147C" id="P700049702700000000000000004147C">xorpd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004147D" id="P700049702700000000000000004147D"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub> ^ <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004147E" id="P700049702700000000000000004147E">Bitwise <span class="pcalibre1 pcalibre2 pcalibre84">exclusive-or</span></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004147F" id="P700049702700000000000000004147F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041480" id="P7000497027000000000000000041480">vandps</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041481" id="P7000497027000000000000000041481"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041482" id="P7000497027000000000000000041482">andpd</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041483" id="P7000497027000000000000000041483"><var class="pcalibre17 pcalibre2 pcalibre1">D</var> ← <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub> &amp; <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041484" id="P7000497027000000000000000041484">Bitwise <span class="pcalibre1 pcalibre2 pcalibre84">and</span></td>
</tr>
</tbody>
</table>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041485" id="P7000497027000000000000000041485"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000041486" epub:type="title" id="P7000497027000000000000000041486"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.50 </span>Bitwise operations on packed data.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041487" id="P7000497027000000000000000041487"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041488" id="P7000497027000000000000000041488">These instructions perform Boolean operations on all 128 bits in an XMM register.</p></div></figcaption>
</figure>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000323C" epub:type="practice" id="P700049702700000000000000000323C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041489" epub:type="title" id="P7000497027000000000000000041489"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.55 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003A2D">349</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004148A" id="P700049702700000000000000004148A">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004148B" id="P700049702700000000000000004148B">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004148C" id="P700049702700000000000000004148C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004148D" id="P700049702700000000000000004148D">Show how the numbers declared at label <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004148E" id="P700049702700000000000000004148E">.LC3</code> encode the number 32.0.</p></div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003243" id="P7000497027000000000000000003243"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004148F" epub:type="title" id="P700049702700000000000000004148F"><span class="pcalibre1 pcalibre21 pcalibre2">3.11.5 </span>Using Bitwise Operations in Floating-Point Code</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041490" id="P7000497027000000000000000041490">At times, we find <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generating code that performs bitwise operations on XMM registers to implement useful floating-point results. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003225"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.50</span></a> shows some relevant instructions, similar to their counterparts for operating on general-purpose registers. These operations all act on packed data, meaning that they update the entire destination XMM register, applying the bitwise operation to all the data in the two source registers. Once again, our only interest for scalar data is the effect these instructions have on the low-order 4 or 8 bytes of the destination. These operations are often simple and convenient ways to manipulate floating-point values, as is explored in the following problem.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003246" epub:type="practice" id="P7000497027000000000000000003246"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041491" epub:type="title" id="P7000497027000000000000000041491"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.56 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003A4A">350</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041492" id="P7000497027000000000000000041492">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041493" id="P7000497027000000000000000041493">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041494" id="P7000497027000000000000000041494"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041495" id="P7000497027000000000000000041495">Consider the following C function, where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041496" id="P7000497027000000000000000041496">EXPR</code> is a macro defined with #define:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041497" id="P7000497027000000000000000041497"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041498" id="P7000497027000000000000000041498">
double simplefun(double x)
{
	return EXPR(x);
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041499" id="P7000497027000000000000000041499">Below, we show the AVX2 code generated for different definitions of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004149A" id="P700049702700000000000000004149A">EXPR</code>, where value x is held in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004149B" id="P700049702700000000000000004149B">%xmm0</code>. All of them correspond to some useful operation on floating-point values. Identify what the operations are. Your answers will require you to understand the bit patterns of the constant words being retrieved from memory.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P700049702700000000000000004149C" id="P700049702700000000000000004149C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004149D" id="P700049702700000000000000004149D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004149E" id="P700049702700000000000000004149E"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004149F" id="P700049702700000000000000004149F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414A0" id="P70004970270000000000000000414A0">
1	  vmovsd	.LC1(%rip), %xmm1
2	  vandpd	%xmm1, %xmm0, %xmm0
3	.LC1:
4	  .long		4294967295
5	  .long		2147483647
6	  .long		0
7	  .long		0
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414A1" id="P70004970270000000000000000414A1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000414A2" id="P70004970270000000000000000414A2"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414A3" id="P70004970270000000000000000414A3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414A4" id="P70004970270000000000000000414A4">
1	vxorpd	%xmm0, %xmm0, %xmm0
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414A5" id="P70004970270000000000000000414A5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000414A6" id="P70004970270000000000000000414A6"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000325D" epub:type="pagebreak" id="P700049702700000000000000000325D" title="306"></span></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414A7" id="P70004970270000000000000000414A7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414A8" id="P70004970270000000000000000414A8">
1	  vmovsd	.LC2(%rip), %xmm1
2	  vxorpd	%xmm1, %xmm0, %xmm0
3	.LC2:	
4	  .long		0
5	  .long		-2147483648
6	  .long		0
7	  .long		0
</code></pre>
</li>
</ol></div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003260" id="P7000497027000000000000000003260"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414A9" epub:type="title" id="P70004970270000000000000000414A9"><span class="pcalibre1 pcalibre21 pcalibre2">3.11.6 </span>Floating-Point Comparison Operations</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414AA" id="P70004970270000000000000000414AA">AVX2 provides two instructions for comparing floating-point values:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000414AB" id="P70004970270000000000000000414AB">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000414AC" id="P70004970270000000000000000414AC">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000414AD" id="P70004970270000000000000000414AD">Based on</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000414AE" id="P70004970270000000000000000414AE">Description</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414AF" id="P70004970270000000000000000414AF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414B0" id="P70004970270000000000000000414B0">ucomiss</code> <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414B1" id="P70004970270000000000000000414B1"><var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub>-<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414B2" id="P70004970270000000000000000414B2">Compare single precision</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414B3" id="P70004970270000000000000000414B3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414B4" id="P70004970270000000000000000414B4">ucomisd</code> <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub>, <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414B5" id="P70004970270000000000000000414B5"><var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub>-<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414B6" id="P70004970270000000000000000414B6">Compare double precision</td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414B7" id="P70004970270000000000000000414B7">These instructions are similar to the <span class="pcalibre1 pcalibre29 pcalibre2">cmp </span>instructions (see <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002339"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6</span></a>), in that they compare operands <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub> and <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> (but in the opposite order one might expect) and set the condition codes to indicate their relative values. As with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414B8" id="P70004970270000000000000000414B8">cmpq</code>, they follow the ATT-format convention of listing the operands in reverse order. Argument <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> must be in an XMM register, while <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub> can be either in an XMM register or in memory.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414B9" id="P70004970270000000000000000414B9">The floating-point comparison instructions set three condition codes: the zero flag <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414BA" id="P70004970270000000000000000414BA">ZF</code>, the carry flag <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414BB" id="P70004970270000000000000000414BB">CF</code>, and the parity flag <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414BC" id="P70004970270000000000000000414BC">PF</code>. We did not document the parity flag in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000233F"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6.1</span></a>, because it is not commonly found in <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>-generated x86 code. For integer operations, this flag is set when the most recent arithmetic or logical operation yielded a value where the least significant byte has even parity (i.e., an even number of ones in the byte). For floating-point comparisons, however, the flag is set when either operand is <i class="pcalibre17 pcalibre2 pcalibre1">NaN</i>. By convention, any comparison in C is considered to fail when one of the arguments is <i class="pcalibre17 pcalibre2 pcalibre1">NaN</i>, and this flag is used to detect such a condition. For example, even the comparison <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414BD" id="P70004970270000000000000000414BD">x == x</code> yields 0 when <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414BE" id="P70004970270000000000000000414BE">x</code> is <i class="pcalibre17 pcalibre2 pcalibre1">NaN</i>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414BF" id="P70004970270000000000000000414BF">The condition codes are set as follows:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P70004970270000000000000000414C0" id="P70004970270000000000000000414C0">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000414C1" id="P70004970270000000000000000414C1">Ordering <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub>:<var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000414C2" id="P70004970270000000000000000414C2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414C3" id="P70004970270000000000000000414C3">CF</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000414C4" id="P70004970270000000000000000414C4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414C5" id="P70004970270000000000000000414C5">ZF</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000414C6" id="P70004970270000000000000000414C6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414C7" id="P70004970270000000000000000414C7">PF</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414C8" id="P70004970270000000000000000414C8">Unordered</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414C9" id="P70004970270000000000000000414C9">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414CA" id="P70004970270000000000000000414CA">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414CB" id="P70004970270000000000000000414CB">1</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414CC" id="P70004970270000000000000000414CC"><var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub> &lt; <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414CD" id="P70004970270000000000000000414CD">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414CE" id="P70004970270000000000000000414CE">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414CF" id="P70004970270000000000000000414CF">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414D0" id="P70004970270000000000000000414D0"><var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub> = <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414D1" id="P70004970270000000000000000414D1">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414D2" id="P70004970270000000000000000414D2">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414D3" id="P70004970270000000000000000414D3">0</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414D4" id="P70004970270000000000000000414D4"><var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">2</sub> &gt; <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre97 pcalibre2 pcalibre1">1</sub></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414D5" id="P70004970270000000000000000414D5">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414D6" id="P70004970270000000000000000414D6">0</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000414D7" id="P70004970270000000000000000414D7">0</td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414D8" id="P70004970270000000000000000414D8">The <i class="pcalibre17 pcalibre2 pcalibre1">unordered</i> case occurs when either operand is <i class="pcalibre17 pcalibre2 pcalibre1">NaN</i>. This can be detected with the parity flag. Commonly, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414D9" id="P70004970270000000000000000414D9">jp</code> (for "jump on parity") instruction is used to conditionally jump when a floating-point comparison yields an unordered result. Except for this case, the values of the carry and zero flags are the same as those for an unsigned comparison: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414DA" id="P70004970270000000000000000414DA">ZF</code> is set when the two operands are equal, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414DB" id="P70004970270000000000000000414DB">CF</code> is</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000003294" id="P7000497027000000000000000003294">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414DC" id="P70004970270000000000000000414DC"><span class="pcalibre1 pcalibre2 pcalibre123" data-uri="chapter03.xhtml#P7000497027000000000000000003296" epub:type="pagebreak" id="P7000497027000000000000000003296" title="307"></span>(a) C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414DD" id="P70004970270000000000000000414DD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414DE" id="P70004970270000000000000000414DE">
typedef enum {NEG, ZERO, POS, OTHER} range_t;

range_t find_range(float x)
{
	int result;
	if (x &lt; 0)
	  result = NEG;
	else if (x == 0)
	  result = ZERO;
	else if (x &gt; 0)
	  result = POS;
	else
	result = OTHER;
return result;
}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414DF" id="P70004970270000000000000000414DF">(b) Generated assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414E0" id="P70004970270000000000000000414E0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414E1" id="P70004970270000000000000000414E1">
	<i class="pcalibre17 pcalibre2 pcalibre1">range_t find_range(float x) x in %xmm0</i>
1	find_range:
2	  vxorps	%xmm1, %xmm1, %xmm1		<i class="pcalibre17 pcalibre2 pcalibre1">Set %xmm1 = 0</i>
3	  vucomiss	%xmm0, %xmm1			<i class="pcalibre17 pcalibre2 pcalibre1">Compare 0:x</i>
4	  ja	.L5					<i class="pcalibre17 pcalibre2 pcalibre1">If &gt;, goto</i> <b class="pcalibre1 pcalibre2 pcalibre12">neg</b>
5	  vucomiss	%xmm1, %xmm0			<i class="pcalibre17 pcalibre2 pcalibre1">Compare x:0</i>
6	  jp	.L8					<i class="pcalibre17 pcalibre2 pcalibre1">If NaN, goto</i> <b class="pcalibre1 pcalibre2 pcalibre12">posornan</b>
7	  movl	$1, %eax				<i class="pcalibre17 pcalibre2 pcalibre1">result = ZERO</i>
8	  je	.L3					<i class="pcalibre17 pcalibre2 pcalibre1">If =, goto</i> <b class="pcalibre1 pcalibre2 pcalibre12">done</b>
9	.L8:					  <b class="pcalibre1 pcalibre2 pcalibre12">posornan:</b>
10	  vucomiss	.LC0(%rip), %xmm0		<i class="pcalibre17 pcalibre2 pcalibre1">Compare x:0</i>
11	  setbe	%al					<i class="pcalibre17 pcalibre2 pcalibre1">Set result = NaN ? 1 : 0</i>
12	  movzbl	%al, %eax			<i class="pcalibre17 pcalibre2 pcalibre1">Zero-extend</i>
13	  addl	$2, %eax				<i class="pcalibre17 pcalibre2 pcalibre1">result += 2 (POS for &gt; 0, OTHER for NaN)</i>
14	  ret						<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
15	.L5:					  <b class="pcalibre1 pcalibre2 pcalibre12">neg:</b>
16	  movl	$0, %eax				<i class="pcalibre17 pcalibre2 pcalibre1">result = NEG</i>
17	.L3:					  <b class="pcalibre1 pcalibre2 pcalibre12">done:</b>
18	  rep; ret					<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P70004970270000000000000000414E2" id="P70004970270000000000000000414E2"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P70004970270000000000000000414E3" epub:type="title" id="P70004970270000000000000000414E3"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.51 </span>Illustration of conditional branching in floating-point code.</h1></header></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414E4" id="P70004970270000000000000000414E4"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000329F" epub:type="pagebreak" id="P700049702700000000000000000329F" title="308"></span>set when <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> &lt; <var class="pcalibre17 pcalibre2 pcalibre1">S</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>. Instructions such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414E5" id="P70004970270000000000000000414E5">ja</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414E6" id="P70004970270000000000000000414E6">jb</code> are used to conditionally jump on various combinations of these flags.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414E7" id="P70004970270000000000000000414E7">As an example of floating-point comparisons, the C function of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003294"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.51(a)</span></a> classifies argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414E8" id="P70004970270000000000000000414E8">x</code> according to its relation to 0.0, returning an enumerated type as the result. Enumerated types in C are encoded as integers, and so the possible function values are: <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414E9" id="P70004970270000000000000000414E9">0 (NEG), 1 (ZERO), 2 (POS)</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414EA" id="P70004970270000000000000000414EA">3 (OTHER)</code>. This final outcome occurs when the value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414EB" id="P70004970270000000000000000414EB">x</code> is <i class="pcalibre17 pcalibre2 pcalibre1">NaN</i>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414EC" id="P70004970270000000000000000414EC">G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>generates the code shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003294"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.51(b)</span></a> for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414ED" id="P70004970270000000000000000414ED">find_range</code>. The code is not very efficient—it compares <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414EE" id="P70004970270000000000000000414EE">x</code> to 0.0 three times, even though the required information could be obtained with a single comparison. It also generates floating point constant 0.0 twice—once using <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414EF" id="P70004970270000000000000000414EF">vxorps</code>, and once by reading the value from memory. Let us trace the flow of the function for the four possible comparison results:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414F0" id="P70004970270000000000000000414F0">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414F1" id="P70004970270000000000000000414F1"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000414F2" id="P70004970270000000000000000414F2">x &lt; 0.0 The ja branch on line 4 will be taken, jumping to the end with a return value of 0.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414F3" id="P70004970270000000000000000414F3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000414F4" id="P70004970270000000000000000414F4">x = 0.0 The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414F5" id="P70004970270000000000000000414F5">ja</code> (line 4) and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414F6" id="P70004970270000000000000000414F6">jp</code> (line 6) branches will not be taken, but the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414F7" id="P70004970270000000000000000414F7">je</code> branch (line 8) will, returning with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414F8" id="P70004970270000000000000000414F8">%eax</code> equal to 1.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414F9" id="P70004970270000000000000000414F9"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000414FA" id="P70004970270000000000000000414FA">x &gt; 0.0 None of the three branches will be taken. The set be (line 11) will yield 0, and this will be incremented by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414FB" id="P70004970270000000000000000414FB">addl</code> instruction (line 13) to give a return value of 2.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000414FC" id="P70004970270000000000000000414FC"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000414FD" id="P70004970270000000000000000414FD">x = <i class="pcalibre17 pcalibre2 pcalibre1">NaN</i> The jp branch (line 6) will be taken. The third <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414FE" id="P70004970270000000000000000414FE">vucomiss</code> instruction (line 10) will set both the carry and the zero flag, and so the set be instruction (line 11) and the following instruction will set <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000414FF" id="P70004970270000000000000000414FF">%eax</code> to 1. This gets incremented by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041500" id="P7000497027000000000000000041500">addl</code> instruction (line 13) to give a return value of 3.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041501" id="P7000497027000000000000000041501">In Homework <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000032E1.xhtml#P700049702700000000000000000342C"><span class="pcalibre1 pcalibre21 pcalibre2">Problems </span><span class="pcalibre1 pcalibre21 pcalibre2">3.73</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP70004970270000000000000000032E1.xhtml#P7000497027000000000000000003433"><span class="pcalibre1 pcalibre21 pcalibre2">3.74</span></a>, you are challenged to hand-generate more efficient implementations of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041502" id="P7000497027000000000000000041502">find_range</code>.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000032BE" epub:type="practice" id="P70004970270000000000000000032BE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041503" epub:type="title" id="P7000497027000000000000000041503"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.57 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000344D_split_001.xhtml#P7000497027000000000000000003A4A">350</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041504" id="P7000497027000000000000000041504">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041505" id="P7000497027000000000000000041505">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041506" id="P7000497027000000000000000041506"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041507" id="P7000497027000000000000000041507">Function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041508" id="P7000497027000000000000000041508">funct3</code> has the following prototype:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041509" id="P7000497027000000000000000041509"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004150A" id="P700049702700000000000000004150A">
double funct3(int *ap, double b, long c, float *dp);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004150B" id="P700049702700000000000000004150B">For this function, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004150C" id="P700049702700000000000000004150C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004150D" id="P700049702700000000000000004150D">
	<i class="pcalibre17 pcalibre2 pcalibre1">double funct3(int *ap, double b, long c, float *dp)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">ap in %rdi, b in %xmm0, c in %rsi, dp in %rdx</i>
1	funct3:
2	  vmovss	(%rdx), %xmm1
3	  vcvtsi2sd	(%rdi), %xmm2, %xmm2
4	  vucomisd	%xmm2, %xmm0
5	  jbe	.L8
6	  vcvtsi2ssq	%rsi, %xmm0, %xmm0
7	  vmulss	%xmm1, %xmm0, %xmm1
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000032CA" epub:type="pagebreak" id="P70004970270000000000000000032CA" title="309"></span>8	  vunpcklps	%xmm1, %xmm1, %xmm1
9	  vcvtps2pd	%xmm1, %xmm0
10	  ret
11	.L8:
12	  vaddss	%xmm1, %xmm1, %xmm1
13	  vcvtsi2ssq	%rsi, %xmm0, %xmm0
14	  vaddss	%xmm1, %xmm0, %xmm0
15	  vunpcklps	%xmm0, %xmm0, %xmm0
16	  vcvtps2pd	%xmm0, %xmm0
17	  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004150E" id="P700049702700000000000000004150E">Write a C version of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004150F" id="P700049702700000000000000004150F">funct3</code>.</p>
</div></li></ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000032CD" id="P70004970270000000000000000032CD"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041510" epub:type="title" id="P7000497027000000000000000041510"><span class="pcalibre1 pcalibre21 pcalibre2">3.11.7 </span>Observations about Floating-Point Code</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041511" id="P7000497027000000000000000041511">We see that the general style of machine code generated for operating on floating-point data with AVX2 is similar to what we have seen for operating on integer data. Both use a collection of registers to hold and operate on values, and they use these registers for passing function arguments.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041512" id="P7000497027000000000000000041512">Of course, there are many complexities in dealing with the different data types and the rules for evaluating expressions containing a mixture of data types, and AVX2 code involves many more different instructions and formats than is usually seen with functions that perform only integer arithmetic.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041513" id="P7000497027000000000000000041513">AVX2 also has the potential to make computations run faster by performing parallel operations on packed data. Compiler developers are working on automating the conversion of scalar code to parallel code, but currently the most reliable way to achieve higher performance through parallelism is to use the extensions to the C language supported by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>for manipulating vectors of data. See Web Aside <span class="pcalibre1 pcalibre29 pcalibre2">opt:simd </span>on page 546 to see how this can be done.</p>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>3.12 Summary </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000032D2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041514" epub:type="title" id="P7000497027000000000000000041514"><span class="pcalibre1 pcalibre21 pcalibre2">3.12 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041515" id="P7000497027000000000000000041515">In this chapter, we have peered beneath the layer of abstraction provided by the C language to get a view of machine-level programming. By having the compiler generate an assembly-code representation of the machine-level program, we gain insights into both the compiler and its optimization capabilities, along with the machine, its data types, and its instruction set. In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000004893.xhtml#P7000497027000000000000000004893"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">5</span></a>, we will see that knowing the characteristics of a compiler can help when trying to write programs that have efficient mappings onto the machine. We have also gotten amore complete picture of how the program stores data in different memory regions. In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000008060.xhtml#P7000497027000000000000000008060"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">12</span></a>, we will see many examples where application programmers need to know whether a program variable is on the run-time stack, in some dynamically allocated data structure, or part of the global program data. Understanding how programs map onto machines makes it easier to understand the differences between these kinds of storage.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041516" id="P7000497027000000000000000041516"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000032D6" epub:type="pagebreak" id="P70004970270000000000000000032D6" title="310"></span>Machine-level programs, and their representation by assembly code, differ in many ways from C programs. There is minimal distinction between different data types. The program is expressed as a sequence of instructions, each of which performs a single operation. Parts of the program state, such as registers and the run-time stack, are directly visible to the programmer. Only low-level operations are provided to support data manipulation and program control. The compiler must use multiple instructions to generate and operate on different data structures and to implement control constructs such as conditionals, loops, and procedures. We have covered many different aspects of C and how it gets compiled. We have seen that the lack of bounds checking in C makes many programs prone to buffer overflows. This has made many systems vulnerable to attacks by malicious intruders, although recent safeguards provided by the run-time system and the compiler help make programs more secure.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041517" id="P7000497027000000000000000041517">We have only examined the mapping of C onto x86-64, but much of what we have covered is handled in a similar way for other combinations of language and machine. For example, compiling C++ is very similar to compiling C. In fact, early implementations of C++ first performed a source-to-source conversion from C++ to C and generated object code by running a C compiler on the result. C++ objects are represented by structures, similar to a C <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041518" id="P7000497027000000000000000041518">struct</code>. Methods are represented by pointers to the code implementing the methods. By contrast, Java is implemented in an entirely different fashion. The object code of Java is a special binary representation known as <i class="pcalibre17 pcalibre2 pcalibre1">Java byte code</i>. This code can be viewed as a machine-level program for a <i class="pcalibre17 pcalibre2 pcalibre1">virtual machine</i>. As its name suggests, this machine is not implemented directly in hardware. Instead, software interpreters process the byte code, simulating the behavior of the virtual machine. Alternatively, an approach known as <i class="pcalibre17 pcalibre2 pcalibre1">just-in-time compilation</i> dynamically translates byte code sequences into machine instructions. This approach provides faster execution when code is executed multiple times, such as in loops. The advantage of using byte code as the low-level representation of a program is that the same code can be "executed" on many different machines, whereas the machine code we have considered runs only on x86-64 machines.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Bibliographic Notes </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre83 pcalibre2" epub:type="bibliography" id="P70004970270000000000000000032D9"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 title" data-uri="chapter03.xhtml#P7000497027000000000000000041519" epub:type="title" id="P7000497027000000000000000041519"><span class="pcalibre1 pcalibre21 pcalibre2">Bibliographic Notes </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004151A" id="P700049702700000000000000004151A">Both Intel and AMD provide extensive documentation on their processors. This includes general descriptions of an assembly-language programmer's view of the hardware <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3A4">[2,</a> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B406">50]</a>, as well as detailed references about the individual instructions <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3A6">[3,</a> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B408">51]</a>. Reading the instruction descriptions is complicated by the facts that (1) all documentation is based on the Intel assembly-code format, (2) there are many variations for each instruction due to the different addressing and execution modes, and (3) there are no illustrative examples. Still, these remain the authoritative references about the behavior of each instruction.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004151B" id="P700049702700000000000000004151B">The organization x86-64.org has been responsible for defining the <i class="pcalibre17 pcalibre2 pcalibre1">application binary interface</i> (ABI) for x86-64 code running on Linux systems <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B43D">[77]</a>. This interface describes details for procedure linkages, binary code files, and a number of other features that are required for machine-code programs to execute properly.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004151C" id="P700049702700000000000000004151C"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000032DE" epub:type="pagebreak" id="P70004970270000000000000000032DE" title="311"></span>As we have discussed, the ATT format used by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>is very different from the Intel format used in Intel documentation and by other compilers (including the Microsoft compilers).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004151D" id="P700049702700000000000000004151D">Muchnick's book on compiler design <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B443">[80]</a> is considered the most comprehensive reference on code-optimization techniques. It covers many of the techniques we discuss here, such as register usage conventions.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004151E" id="P700049702700000000000000004151E">Much has been written about the use of buffer overflow to attack systems over the Internet. Detailed analyses of the 1988 Internet worm have been published by Spafford <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B476">[105]</a> as well as by members of the team at MIT who helped stop its spread <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3E7">[35]</a>. Since then a number of papers and projects have generated ways both to create and to prevent buffer overflow attacks. Seacord's book <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B466">[97]</a> provides a wealth of information about buffer overflow and other attacks on code generated by C compilers.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Homework Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="practice" id="P70004970270000000000000000032E1"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P700049702700000000000000004151F" epub:type="title" id="P700049702700000000000000004151F"><span class="pcalibre1 pcalibre21 pcalibre2">Homework Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000032E3" id="P70004970270000000000000000032E3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041520" epub:type="title" id="P7000497027000000000000000041520"><span class="pcalibre1 pcalibre21 pcalibre2">3.58 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041521" id="P7000497027000000000000000041521">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041522" id="P7000497027000000000000000041522">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041523" id="P7000497027000000000000000041523"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041524" id="P7000497027000000000000000041524">For a function with prototype</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041525" id="P7000497027000000000000000041525"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041526" id="P7000497027000000000000000041526">
long decode2(long x, long y, long z);
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041527" id="P7000497027000000000000000041527"><span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041528" id="P7000497027000000000000000041528"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041529" id="P7000497027000000000000000041529">
1	decode2:	
2	subq	%rdx, %rsi
3	imulq	%rsi, %rdi
4	movq	%rsi, %rax
5	salq	$63, %rax
6	sarq	$63, %rax
7	xorq	%rdi, %rax
8	ret	
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004152A" id="P700049702700000000000000004152A">Parameters <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004152B" id="P700049702700000000000000004152B">x, y</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004152C" id="P700049702700000000000000004152C">z</code> are passed in registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004152D" id="P700049702700000000000000004152D">%rdi, %rsi</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004152E" id="P700049702700000000000000004152E">%rdx</code>. The code stores the return value in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004152F" id="P700049702700000000000000004152F">%rax</code>.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041530" id="P7000497027000000000000000041530">Write C code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041531" id="P7000497027000000000000000041531">decode2</code> that will have an effect equivalent to the assembly code shown.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000032F6" id="P70004970270000000000000000032F6"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041532" epub:type="title" id="P7000497027000000000000000041532"><span class="pcalibre1 pcalibre21 pcalibre2">3.59 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041533" id="P7000497027000000000000000041533">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041534" id="P7000497027000000000000000041534">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041535" id="P7000497027000000000000000041535"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041536" id="P7000497027000000000000000041536">The following code computes the 128-bit product of two 64-bit signed values <var class="pcalibre17 pcalibre2 pcalibre1">x</var> and <var class="pcalibre17 pcalibre2 pcalibre1">y</var> and stores the result in memory:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041537" id="P7000497027000000000000000041537"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041538" id="P7000497027000000000000000041538">
1	typedef __int128 int128_t;
2	
3	void store_prod(int128_t *dest, int64_t x, int64_t y) {
4	*dest = x * (int128_t) y;
5	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041539" id="P7000497027000000000000000041539"><span class="pcalibre1 pcalibre29 pcalibre2">Gcc </span>generates the following assembly code implementing the computation:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004153A" id="P700049702700000000000000004153A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004153B" id="P700049702700000000000000004153B">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003301" epub:type="pagebreak" id="P7000497027000000000000000003301" title="312"></span>1	store_prod:
2	movq	%rdx, %rax
3	cqto	
4	movq	%rsi, %rcx
5	sarq	$63, %rcx
6	imulq	%rax, %rcx
7	imulq	%rsi, %rdx
8	addq	%rdx, %rcx
9	mulq	%rsi
1	addq	%rcx, %rdx
1	movq	%rax, (%rdi)
1	movq	%rdx, 8(%rdi)
1	ret	
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004153C" id="P700049702700000000000000004153C">This code uses three multiplications for the multiprecision arithmetic required to implement 128-bit arithmetic on a 64-bit machine. Describe the algorithm used to compute the product, and annotate the assembly code to show how it realizes your algorithm. <i class="pcalibre17 pcalibre2 pcalibre1">Hint:</i> When extending arguments of <var class="pcalibre17 pcalibre2 pcalibre1">x</var> and <var class="pcalibre17 pcalibre2 pcalibre1">y</var> to 128 bits, they can be rewritten as <var class="pcalibre17 pcalibre2 pcalibre1">x</var> = 2<sup class="pcalibre1 pcalibre2 pcalibre85">64</sup> · <i class="pcalibre17 pcalibre2 pcalibre1">x<sub class="pcalibre1 pcalibre2 calibre14">h</sub></i> + <i class="pcalibre17 pcalibre2 pcalibre1">x<sub class="pcalibre1 pcalibre2 calibre14">l</sub></i> and <var class="pcalibre17 pcalibre2 pcalibre1">y</var> = 2<sup class="pcalibre1 pcalibre2 pcalibre85">64</sup> · <i class="pcalibre17 pcalibre2 pcalibre1">y<sub class="pcalibre1 pcalibre2 calibre14">h</sub></i> + <i class="pcalibre17 pcalibre2 pcalibre1">y<sub class="pcalibre1 pcalibre2 calibre14">l</sub></i>, where <i class="pcalibre17 pcalibre2 pcalibre1">x<sub class="pcalibre1 pcalibre2 calibre14">h</sub></i>, <i class="pcalibre17 pcalibre2 pcalibre1">x<sub class="pcalibre1 pcalibre2 calibre14">l</sub></i>, <i class="pcalibre17 pcalibre2 pcalibre1">y<sub class="pcalibre1 pcalibre2 calibre14">h</sub></i>, and <i class="pcalibre17 pcalibre2 pcalibre1">y<sub class="pcalibre1 pcalibre2 calibre14">l</sub></i> are 64-bit values. Similarly, the 128-bit product can be written as <var class="pcalibre17 pcalibre2 pcalibre1">p</var> = 2<sup class="pcalibre1 pcalibre2 pcalibre85">64</sup> · <i class="pcalibre17 pcalibre2 pcalibre1">p<sub class="pcalibre1 pcalibre2 calibre14">h</sub></i> + <i class="pcalibre17 pcalibre2 pcalibre1">p<sub class="pcalibre1 pcalibre2 calibre14">l</sub></i>, where <i class="pcalibre17 pcalibre2 pcalibre1">p<sub class="pcalibre1 pcalibre2 calibre14">h</sub></i> and <i class="pcalibre17 pcalibre2 pcalibre1">p<sub class="pcalibre1 pcalibre2 calibre14">l</sub></i> are 64-bit values. Show how the code computes the values of <i class="pcalibre17 pcalibre2 pcalibre1">p<sub class="pcalibre1 pcalibre2 calibre14">h</sub></i> and <i class="pcalibre17 pcalibre2 pcalibre1">p<sub class="pcalibre1 pcalibre2 calibre14">l</sub></i> in terms of <i class="pcalibre17 pcalibre2 pcalibre1">x<sub class="pcalibre1 pcalibre2 calibre14">h</sub></i>, <i class="pcalibre17 pcalibre2 pcalibre1">x<sub class="pcalibre1 pcalibre2 calibre14">l</sub></i>, <i class="pcalibre17 pcalibre2 pcalibre1">y<sub class="pcalibre1 pcalibre2 calibre14">h</sub></i>, and <i class="pcalibre17 pcalibre2 pcalibre1">y<sub class="pcalibre1 pcalibre2 calibre14">l</sub></i>.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003303" id="P7000497027000000000000000003303"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004153D" epub:type="title" id="P700049702700000000000000004153D"><span class="pcalibre1 pcalibre21 pcalibre2">3.60 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004153E" id="P700049702700000000000000004153E">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004153F" id="P700049702700000000000000004153F">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041540" id="P7000497027000000000000000041540"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041541" id="P7000497027000000000000000041541">Consider the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041542" id="P7000497027000000000000000041542"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041543" id="P7000497027000000000000000041543">
	<i class="pcalibre17 pcalibre2 pcalibre1">long loop(long x, int n)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, n in %esi</i>
1	loop:
2	  movl	%esi, %ecx
3	  movl	$1, %edx
4	  movl	$0, %eax
5	  jmp	.L2
6	.L3:
7	  movq	%rdi, %r8
8	  andq	%rdx, %r8
9	  orq	%r8, %rax
10	  salq	%cl, %rdx
11	.L2:
12	  testq	%rdx, %rdx
13	  jne	.L3
14	  rep; ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041544" id="P7000497027000000000000000041544">The preceding code was generated by compiling C code that had the following overall form:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041545" id="P7000497027000000000000000041545"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041546" id="P7000497027000000000000000041546">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000330E" epub:type="pagebreak" id="P700049702700000000000000000330E" title="313"></span>1	long loop(long x, long n)
2	{
3		long result = _____;
4		long mask;
5		for (mask = _____; mask _____; mask = _____){
6			result	|	= _____;
7	}
8	return result;
9	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041547" id="P7000497027000000000000000041547">Your task is to fill in the missing parts of the C code to get a program equivalent to the generated assembly code. Recall that the result of the function is returned in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041548" id="P7000497027000000000000000041548">%rax</code>. You will find it helpful to examine the assembly code before, during, and after the loop to form a consistent mapping between the registers and the program variables.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041549" id="P7000497027000000000000000041549">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004154A" id="P700049702700000000000000004154A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004154B" id="P700049702700000000000000004154B">Which registers hold program values <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004154C" id="P700049702700000000000000004154C">x, n, result</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004154D" id="P700049702700000000000000004154D">mask?</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004154E" id="P700049702700000000000000004154E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004154F" id="P700049702700000000000000004154F">What are the initial values of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041550" id="P7000497027000000000000000041550">result</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041551" id="P7000497027000000000000000041551">mask?</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041552" id="P7000497027000000000000000041552"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041553" id="P7000497027000000000000000041553">What is the test condition for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041554" id="P7000497027000000000000000041554">mask?</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041555" id="P7000497027000000000000000041555"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041556" id="P7000497027000000000000000041556">How does <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041557" id="P7000497027000000000000000041557">mask</code> get updated?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041558" id="P7000497027000000000000000041558"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041559" id="P7000497027000000000000000041559">How does <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004155A" id="P700049702700000000000000004155A">result</code> get updated?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004155B" id="P700049702700000000000000004155B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004155C" id="P700049702700000000000000004155C">Fill in all the missing parts of the C code.</p></li>
</ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003325" id="P7000497027000000000000000003325"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004155D" epub:type="title" id="P700049702700000000000000004155D"><span class="pcalibre1 pcalibre21 pcalibre2">3.61 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004155E" id="P700049702700000000000000004155E">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004155F" id="P700049702700000000000000004155F">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041560" id="P7000497027000000000000000041560"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041561" id="P7000497027000000000000000041561">In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002578"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6.6</span></a>, we examined the following code as a candidate for the use of conditional data transfer:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041562" id="P7000497027000000000000000041562"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041563" id="P7000497027000000000000000041563">
long cread(long *xp) {
	return (xp ? *xp : 0);
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041564" id="P7000497027000000000000000041564">We showed a trial implementation using a conditional move instruction but argued that it was not valid, since it could attempt to read from a null address.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041565" id="P7000497027000000000000000041565">Write a C function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041566" id="P7000497027000000000000000041566">cread_alt</code> that has the same behavior as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041567" id="P7000497027000000000000000041567">cread</code>, except that it can be compiled to use conditional data transfer. When compiled, the generated code should use a conditional move instruction rather than one of the jump instructions.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003331" id="P7000497027000000000000000003331"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041568" epub:type="title" id="P7000497027000000000000000041568"><span class="pcalibre1 pcalibre21 pcalibre2">3.62 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041569" id="P7000497027000000000000000041569">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004156A" id="P700049702700000000000000004156A">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004156B" id="P700049702700000000000000004156B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004156C" id="P700049702700000000000000004156C">The code that follows shows an example of branching on an enumerated type value in a switch statement. Recall that enumerated types in C are simply a way to introduce a set of names having associated integer values. By default, the values assigned to the names count from zero upward. In our code, the actions associated with the different case labels have been omitted.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004156D" id="P700049702700000000000000004156D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004156E" id="P700049702700000000000000004156E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003339" epub:type="pagebreak" id="P7000497027000000000000000003339" title="314"></span>1	/* Enumerated type creates set of constants numbered 0 and upward */
2	typedef enum {MODE_A, MODE_B, MODE_C, MODE_D, MODE_E} mode_t;
3	
4	long switch3(long *p1, long *p2, mode_t action)
5	{
6		long result = 0;
7		switch(action) {
8		case MODE_A: 9
10		case MODE_B:
11	
12		case MODE_C:
13	
14		case MODE_D:
15	
16		case MODE_E:
17	
18		default:
19	
20		}
21		return result;
22	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004156F" id="P700049702700000000000000004156F">The part of the generated assembly code implementing the different actions is shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003346"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.52</span></a>. The annotations indicate the argument locations, the register values, and the case labels for the different jump destinations.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041570" id="P7000497027000000000000000041570">Fill in the missing parts of the C code. It contained one case that fell through to another—try to reconstruct this.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000333C" id="P700049702700000000000000000333C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041571" epub:type="title" id="P7000497027000000000000000041571"><span class="pcalibre1 pcalibre21 pcalibre2">3.63 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041572" id="P7000497027000000000000000041572">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041573" id="P7000497027000000000000000041573">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041574" id="P7000497027000000000000000041574"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041575" id="P7000497027000000000000000041575">This problem will give you a chance to reverse engineer a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041576" id="P7000497027000000000000000041576">switch</code> statement from disassembled machine code. In the following procedure, the body of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041577" id="P7000497027000000000000000041577">switch</code> statement has been omitted:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041578" id="P7000497027000000000000000041578"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041579" id="P7000497027000000000000000041579">
1	long switch_prob(long x, long n) {
2		long result = x;
3		switch(n) {
4			/* Fill in code here */ 5
6		}
7		return result;
8	}
</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000003346" id="P7000497027000000000000000003346">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004157A" id="P700049702700000000000000004157A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004157B" id="P700049702700000000000000004157B">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003349" epub:type="pagebreak" id="P7000497027000000000000000003349" title="315"></span>	<i class="pcalibre17 pcalibre2 pcalibre1">p1 in %rdi, p2 in %rsi, action in %edx</i>
1	.L8:	<i class="pcalibre17 pcalibre2 pcalibre1">MODE_E</i>
2	  movl	$27, %eax
3	  ret
4	.L3:	<i class="pcalibre17 pcalibre2 pcalibre1">MODE_A</i>
5	  movq	(%rsi), %rax
6	  movq	(%rdi), %rdx
7	  movq	%rdx, (%rsi)
8	  ret
9	.L5:	<i class="pcalibre17 pcalibre2 pcalibre1">MODE_B</i>
10	  movq	(%rdi), %rax
11	  addq	(%rsi), %rax
12	  movq	%rax, (%rdi)
13	  ret
14	.L6:	<i class="pcalibre17 pcalibre2 pcalibre1">MODE_C</i>
15	  movq	$59, (%rdi)
16	  movq	(%rsi), %rax
17	  ret
18	.L7:	<i class="pcalibre17 pcalibre2 pcalibre1">MODE_D</i>
19	  movq	(%rsi), %rax
20	  movq	%rax, (%rdi)
21	  movl	$27, %eax
22	  ret
23	.L9:	<i class="pcalibre17 pcalibre2 pcalibre1">default</i>
24	  movl	$12, %eax
25	  ret
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P700049702700000000000000004157C" id="P700049702700000000000000004157C"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P700049702700000000000000004157D" epub:type="title" id="P700049702700000000000000004157D"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.52 </span>Assembly code for <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003331"><span class="label pcalibre1 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">3.62</span></a>.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004157E" id="P700049702700000000000000004157E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004157F" id="P700049702700000000000000004157F">This code implements the different branches of a switch statement.</p></div></figcaption>
</figure>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041580" id="P7000497027000000000000000041580"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003355"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.53</span></a> shows the disassembled machine code for the procedure.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041581" id="P7000497027000000000000000041581">The jump table resides in a different area of memory. We can see from the indirect jump on line 5 that the jump table begins at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041582" id="P7000497027000000000000000041582">0x4006f8</code>. Using the <span class="pcalibre1 pcalibre29 pcalibre2">GDB </span>debugger, we can examine the six 8-byte words of memory comprising the jump table with the command <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041583" id="P7000497027000000000000000041583">x/6gx 0x4006f8.</code> <span class="pcalibre1 pcalibre29 pcalibre2">GDB </span>prints the following:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041584" id="P7000497027000000000000000041584"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041585" id="P7000497027000000000000000041585">
(gdb) <i class="pcalibre17 pcalibre2 pcalibre1">x/6gx 0x4006f8</i>
0x4006f8:	0x00000000004005a1	0x00000000004005c3
0x400708:	0x00000000004005a1	0x00000000004005aa
0x400718:	0x00000000004005b2	0x00000000004005bf
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041586" id="P7000497027000000000000000041586">Fill in the body of the switch statement with C code that will have the same behavior as the machine code.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P7000497027000000000000000003355" id="P7000497027000000000000000003355">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041587" id="P7000497027000000000000000041587"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041588" id="P7000497027000000000000000041588">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003358" epub:type="pagebreak" id="P7000497027000000000000000003358" title="316"></span><i class="pcalibre17 pcalibre2 pcalibre1">long switch_prob(long x, long n)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, n in %rsi</i>
1	0000000000400590 &lt;switch_prob&gt;:
2	400590: 48 83 ee 3c	sub	$0x3c,%rsi
3	400594: 48 83 fe 05	cmp	$0x5,%rsi
4	400598: 77 29	ja	4005c3 &lt;switch_prob+0x33&gt;
5	40059a: ff 24 f5 f8 06 40 00	jmpq	*0x4006f8(,%rsi,8)
6	4005a1: 48 8d 04 fd 00 00 00	lea	0x0(,%rdi,8),%rax
7	4005a8: 00
8	4005a9: c3	retq
9	4005aa: 4889f8	mov	%rdi,%rax
10	4005ad: 48 c1 f8 03	sar	$0x3,%rax
11	4005b1: c3	retq
12	4005b2: 4889f8	mov	%rdi,%rax
13	4005b5: 48 c1 e0 04	shl	$0x4,%rax
14	4005b9: 4829f8	sub	%rdi,%rax
15	4005bc: 4889c7	mov	%rax,%rdi
16	4005bf: 48 0f af ff	imul	%rdi,%rdi
17	4005c3: 48 8d 47 4b	lea	0x4b(%rdi),%rax
18	4005c7: c3	retq
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041589" id="P7000497027000000000000000041589"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P700049702700000000000000004158A" epub:type="title" id="P700049702700000000000000004158A"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.53 </span>Disassembled code for <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000333C"><span class="label pcalibre1 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">3.63</span></a>.</h1></header></figcaption>
</figure>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000335B" id="P700049702700000000000000000335B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004158B" epub:type="title" id="P700049702700000000000000004158B"><span class="pcalibre1 pcalibre21 pcalibre2">3.64 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004158C" id="P700049702700000000000000004158C">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004158D" id="P700049702700000000000000004158D">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004158E" id="P700049702700000000000000004158E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004158F" id="P700049702700000000000000004158F">Consider the following source code, where <var class="pcalibre17 pcalibre2 pcalibre1">R</var>, <var class="pcalibre17 pcalibre2 pcalibre1">S</var>, and <var class="pcalibre17 pcalibre2 pcalibre1">T</var> are constants declared with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041590" id="P7000497027000000000000000041590">#define</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041591" id="P7000497027000000000000000041591"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041592" id="P7000497027000000000000000041592">
1	long A[R][S][T]; 
2
3	long store_ele(long i, long j, long k, long *dest)
4	{
5		*dest = A[i][j][k];
6		return sizeof(A);
7	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041593" id="P7000497027000000000000000041593">In compiling this program, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041594" id="P7000497027000000000000000041594"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041595" id="P7000497027000000000000000041595">
	<i class="pcalibre17 pcalibre2 pcalibre1">long store_ele(long i, long j, long k, long *dest)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">i in %rdi, j in %rsi, k in %rdx, dest in %rcx</i>
1	store_ele:
2	  leaq	(%rsi,%rsi,2), %rax
3	  leaq	(%rsi,%rax,4), %rax
4	  movq	%rdi, %rsi
5	  salq	$6, %rsi
6	  addq	%rsi, %rdi
7	  addq	%rax, %rdi
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003367" epub:type="pagebreak" id="P7000497027000000000000000003367" title="317"></span>8	  addq	%rdi, %rdx
9	  movq	A(,%rdx,8), %rax
10	  movq	%rax, (%rcx)
11	  movl	$3640, %eax
12	  ret
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041596" id="P7000497027000000000000000041596">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041597" id="P7000497027000000000000000041597"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041598" id="P7000497027000000000000000041598">Extend <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002B19.xhtml#P7000497027000000000000000002C39"><span class="pcalibre1 pcalibre21 pcalibre2">Equation </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1</span></a> from two dimensions to three to provide a formula for the location of array element <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041599" id="P7000497027000000000000000041599">A[i][j][k]</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004159A" id="P700049702700000000000000004159A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004159B" id="P700049702700000000000000004159B">Use your reverse engineering skills to determine the values of <var class="pcalibre17 pcalibre2 pcalibre1">R</var>, <var class="pcalibre17 pcalibre2 pcalibre1">S</var>, and <var class="pcalibre17 pcalibre2 pcalibre1">T</var> based on the assembly code.</p></li>
</ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000336E" id="P700049702700000000000000000336E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004159C" epub:type="title" id="P700049702700000000000000004159C"><span class="pcalibre1 pcalibre21 pcalibre2">3.65 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004159D" id="P700049702700000000000000004159D">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004159E" id="P700049702700000000000000004159E">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004159F" id="P700049702700000000000000004159F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415A0" id="P70004970270000000000000000415A0">The following code transposes the elements of an <var class="pcalibre17 pcalibre2 pcalibre1">M</var> × <var class="pcalibre17 pcalibre2 pcalibre1">M</var> array, where <var class="pcalibre17 pcalibre2 pcalibre1">M</var> is a constant defined by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415A1" id="P70004970270000000000000000415A1">#define</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415A2" id="P70004970270000000000000000415A2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415A3" id="P70004970270000000000000000415A3">
1	void transpose(long A[M][M]) {
2		long i, j;
3		for (i = 0; i &lt; M; i++)
4			for (j = 0; j &lt; i; j++) {
5				long t = A[i][j];
6				A[i][j] = A[j][i];
7				A[j][i] = t;
8			}
9	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415A4" id="P70004970270000000000000000415A4">When compiled with optimization level –01, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following code for the inner loop of the function:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415A5" id="P70004970270000000000000000415A5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415A6" id="P70004970270000000000000000415A6">
1	.L6:
2	  movq	(%rdx), %rcx
3	  movq	(%rax), %rsi
4	  movq	%rsi, (%rdx)
5	  movq	%rcx, (%rax)
6	  addq	$8, %rdx
7	  addq	$120, %rax
8	  cmpq	%rdi, %rax
9	  jne	.L6
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415A7" id="P70004970270000000000000000415A7">We can see that <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>has converted the array indexing to pointer code.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000415A8" id="P70004970270000000000000000415A8">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415A9" id="P70004970270000000000000000415A9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415AA" id="P70004970270000000000000000415AA">Which register holds a pointer to array element <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415AB" id="P70004970270000000000000000415AB">A[i][j]?</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415AC" id="P70004970270000000000000000415AC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415AD" id="P70004970270000000000000000415AD">Which register holds a pointer to array element <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415AE" id="P70004970270000000000000000415AE">A[j][i]?</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415AF" id="P70004970270000000000000000415AF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415B0" id="P70004970270000000000000000415B0">What is the value of <var class="pcalibre17 pcalibre2 pcalibre1">M</var>?</p></li>
</ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003384" id="P7000497027000000000000000003384"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415B1" epub:type="title" id="P70004970270000000000000000415B1"><span class="pcalibre1 pcalibre21 pcalibre2">3.66 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000415B2" id="P70004970270000000000000000415B2">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000415B3" id="P70004970270000000000000000415B3">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000415B4" id="P70004970270000000000000000415B4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415B5" id="P70004970270000000000000000415B5">Consider the following source code, where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415B6" id="P70004970270000000000000000415B6">NR</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415B7" id="P70004970270000000000000000415B7">NC</code> are macro expressions declared with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415B8" id="P70004970270000000000000000415B8">#define</code> that compute the dimensions of array A in terms of parameter <var class="pcalibre17 pcalibre2 pcalibre1">n</var>. This code computes the sum of the elements of column <var class="pcalibre17 pcalibre2 pcalibre1">j</var> of the array.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415B9" id="P70004970270000000000000000415B9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415BA" id="P70004970270000000000000000415BA">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000338F" epub:type="pagebreak" id="P700049702700000000000000000338F" title="318"></span>1	long sum_col(long n, long A[NR(n)][NC(n)], long j) {
2		long i;
3		long result = 0;
4		for (i = 0; i &lt; NR(n); i++)
5			result += A[i][j];
6		return result;
7	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415BB" id="P70004970270000000000000000415BB">In compiling this program, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415BC" id="P70004970270000000000000000415BC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415BD" id="P70004970270000000000000000415BD">
	<i class="pcalibre17 pcalibre2 pcalibre1">long sum_col(long n, long A[NR(n)][NC(n)], long j)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">n in %rdi, A in %rsi, j in %rdx</i>
1	sum_col:
2	  leaq	1(,%rdi,4), %r8
3	  leaq	(%rdi,%rdi,2), %rax
4	  movq	%rax, %rdi
5	  testq	%rax, %rax
6	  jle	.L4
7	  salq	$3, %r8
8	  leaq	(%rsi,%rdx,8), %rcx
9	  movl	$0, %eax
10	  movl	$0, %edx
11	.L3:
12	  addq	(%rcx), %rax
13	  addq	$1, %rdx
14	  addq	%r8, %rcx
15	  cmpq	%rdi, %rdx
16	  jne	.L3
17	  rep;	ret
18	.L4:
19	  movl	$0, %eax
20	  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415BE" id="P70004970270000000000000000415BE">Use your reverse engineering skills to determine the definitions of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415BF" id="P70004970270000000000000000415BF">NR</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415C0" id="P70004970270000000000000000415C0">NC</code>.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003396" id="P7000497027000000000000000003396"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415C1" epub:type="title" id="P70004970270000000000000000415C1"><span class="pcalibre1 pcalibre21 pcalibre2">3.67 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000415C2" id="P70004970270000000000000000415C2">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000415C3" id="P70004970270000000000000000415C3">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000415C4" id="P70004970270000000000000000415C4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415C5" id="P70004970270000000000000000415C5">For this exercise, we will examine the code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>for functions that have structures as arguments and return values, and from this see how these language features are typically implemented.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415C6" id="P70004970270000000000000000415C6">The following C code has a function process having structures as argument and return values, and a function eval that calls process:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415C7" id="P70004970270000000000000000415C7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415C8" id="P70004970270000000000000000415C8">
1	typedef struct {
2		long a[2];
3		long *p;
4	} strA;
5	
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000339F" epub:type="pagebreak" id="P700049702700000000000000000339F" title="319"></span>6	typedef struct {
7		long u[2];
8		long q;
9	} strB;
10	
11	strB process(strA s) {
12		strB r;
13		r.u[0] = s.a[1];
14		r.u[1] = s.a[0];
15		r.q = *s.p;
16		return r;
17	}
18	
19	long eval(long x, long y, long z) {
20		strA s;
21		s.a[0] = x;
22		s.a[1] = y;
23		s.p = &amp;z;
24		strB r = process(s);
25		return r.u[0] + r.u[1] + r.q;
26	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415C9" id="P70004970270000000000000000415C9">G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>generates the following code for these two functions:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415CA" id="P70004970270000000000000000415CA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415CB" id="P70004970270000000000000000415CB">
	<i class="pcalibre17 pcalibre2 pcalibre1">strB process(strA s)</i>
1	process:
2	  movq	%rdi, %rax
3	  movq	24(%rsp), %rdx
4	  movq	(%rdx), %rdx
5	  movq	16(%rsp), %rcx
6	  movq	%rcx, (%rdi)
7	  movq	8(%rsp), %rcx
8	  movq	%rcx, 8(%rdi)
9	  movq	%rdx, 16(%rdi)
10	  ret
	<i class="pcalibre17 pcalibre2 pcalibre1">long eval(long x, long y, long z)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, z in %rdx</i>
1	eval:
2	  subq	$104, %rsp
3	  movq	%rdx, 24(%rsp)
4	  leaq	24(%rsp), %rax
5	  movq	%rdi, (%rsp)
6	  movq	%rsi, 8(%rsp)
7	  movq	%rax, 16(%rsp)
8	  leaq	64(%rsp), %rdi
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000033A3" epub:type="pagebreak" id="P70004970270000000000000000033A3" title="320"></span>9	  call	process
10	  movq	72(%rsp), %rax
11	  addq	64(%rsp), %rax
12	  addq	80(%rsp), %rax
13	  addq	$104, %rsp
14	  ret
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000415CC" id="P70004970270000000000000000415CC">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415CD" id="P70004970270000000000000000415CD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415CE" id="P70004970270000000000000000415CE">We can see on line 2 of function eval that it allocates 104 bytes on the stack. Diagram the stack frame for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415CF" id="P70004970270000000000000000415CF">eval</code>, showing the values that it stores on the stack prior to calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415D0" id="P70004970270000000000000000415D0">process</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415D1" id="P70004970270000000000000000415D1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415D2" id="P70004970270000000000000000415D2">What value does <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415D3" id="P70004970270000000000000000415D3">eval</code> pass in its call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415D4" id="P70004970270000000000000000415D4">process?</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415D5" id="P70004970270000000000000000415D5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415D6" id="P70004970270000000000000000415D6">How does the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415D7" id="P70004970270000000000000000415D7">process</code> access the elements of structure arguments?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415D8" id="P70004970270000000000000000415D8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415D9" id="P70004970270000000000000000415D9">How does the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415DA" id="P70004970270000000000000000415DA">process</code> set the fields of result structure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415DB" id="P70004970270000000000000000415DB">r?</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415DC" id="P70004970270000000000000000415DC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415DD" id="P70004970270000000000000000415DD">Complete your diagram of the stack frame for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415DE" id="P70004970270000000000000000415DE">eval</code>, showing how <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415DF" id="P70004970270000000000000000415DF">eval</code> accesses the elements of structure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415E0" id="P70004970270000000000000000415E0">r</code> following the return from process.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415E1" id="P70004970270000000000000000415E1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415E2" id="P70004970270000000000000000415E2">What general principles can you discern about how structure values are passed as function arguments and how they are returned as function results?</p></li>
</ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000033BB" id="P70004970270000000000000000033BB"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415E3" epub:type="title" id="P70004970270000000000000000415E3"><span class="pcalibre1 pcalibre21 pcalibre2">3.68 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000415E4" id="P70004970270000000000000000415E4">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000415E5" id="P70004970270000000000000000415E5">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000415E6" id="P70004970270000000000000000415E6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415E7" id="P70004970270000000000000000415E7">In the following code, <var class="pcalibre17 pcalibre2 pcalibre1">A</var> and <var class="pcalibre17 pcalibre2 pcalibre1">B</var> are constants defined with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415E8" id="P70004970270000000000000000415E8">#define:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415E9" id="P70004970270000000000000000415E9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415EA" id="P70004970270000000000000000415EA">
1	typedef struct {
2		int x[A][B]; /* Unknown constants A and B */
3		long y;
4	} str1;
5	
6	typedef struct {
7		char array[B];
8		int t;
9		short s[A];
10		long u;
11	} str2;
12	
13	void setVal(str1 *p, str2 *q) {
14		long v1 = q-&lt;t;
15		long v2 = q-&lt;u;
16		p-&lt;y = v1+v2;
17	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415EB" id="P70004970270000000000000000415EB">G<span class="pcalibre1 pcalibre29 pcalibre2">cc </span>generates the following code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415EC" id="P70004970270000000000000000415EC">setVal:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415ED" id="P70004970270000000000000000415ED"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415EE" id="P70004970270000000000000000415EE">
	<i class="pcalibre17 pcalibre2 pcalibre1">void setVal(str1 *p, str2 *q) p in %rdi, q in %rsi</i>
1	setVal:
2	  movslq	8(%rsi), %rax
3	  addq	32(%rsi), %rax
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000033C8" epub:type="pagebreak" id="P70004970270000000000000000033C8" title="321"></span>4	  movq	%rax, 184(%rdi)
5	  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415EF" id="P70004970270000000000000000415EF">What are the values of <var class="pcalibre17 pcalibre2 pcalibre1">A</var> and <var class="pcalibre17 pcalibre2 pcalibre1">B</var>? (The solution is unique.)</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000033CA" id="P70004970270000000000000000033CA"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415F0" epub:type="title" id="P70004970270000000000000000415F0"><span class="pcalibre1 pcalibre21 pcalibre2">3.69 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P70004970270000000000000000415F1" id="P70004970270000000000000000415F1">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P70004970270000000000000000415F2" id="P70004970270000000000000000415F2">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P70004970270000000000000000415F3" id="P70004970270000000000000000415F3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415F4" id="P70004970270000000000000000415F4">You are charged with maintaining a large C program, and you come across the following code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415F5" id="P70004970270000000000000000415F5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415F6" id="P70004970270000000000000000415F6">
1	typedef struct {
2		int first;
3		a_struct a[CNT];
4		int last;
5	} b_struct;
6	
7	void test(long i, b_struct *bp)
8	{
9		int n = bp-&gt;first + bp-&gt;last;
10		a_struct *ap = &amp;bp-&gt;a[i];
11		ap-&gt;x[ap-&gt;idx] = n;
12	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415F7" id="P70004970270000000000000000415F7">The declarations of the compile-time constant <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415F8" id="P70004970270000000000000000415F8">CNT</code> and the structure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415F9" id="P70004970270000000000000000415F9">a_struct</code> are in a file for which you do not have the necessary access privilege. Fortunately, you have a copy of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415FA" id="P70004970270000000000000000415FA">.o</code> version of code, which you are able to disassemble with the <span class="pcalibre1 pcalibre29 pcalibre2">objdump </span>program, yielding the following disassembly:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415FB" id="P70004970270000000000000000415FB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000415FC" id="P70004970270000000000000000415FC">
	<i class="pcalibre17 pcalibre2 pcalibre1">void test(long i, b_struct *bp)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">i in %rdi, bp in %rsi</i>
1	0000000000000000 &lt;test&gt;:
2	 0: 8b 8e 20 01 00 00	mov	0x120(%rsi),%ecx
3	 6: 030e		add	(%rsi),%ecx
4	 8: 48 8d 04 bf		lea	(%rdi,%rdi,4),%rax
5	 c: 48 8d 04 c6		lea	(%rsi,%rax,8),%rax
6	 10: 48 8b 50 08	mov	0x8(%rax),%rdx
7	 14: 48 63 c9		movslq	%ecx,%rcx
8	 17: 48 89 4c d0 10	mov	%rcx,0x10(%rax,%rdx,8)
9	 1c: c3			retq
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P70004970270000000000000000415FD" id="P70004970270000000000000000415FD">Using your reverse engineering skills, deduce the following:</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000415FE" id="P70004970270000000000000000415FE">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000415FF" id="P70004970270000000000000000415FF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041600" id="P7000497027000000000000000041600">The value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041601" id="P7000497027000000000000000041601">CNT.</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041602" id="P7000497027000000000000000041602"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041603" id="P7000497027000000000000000041603">A complete declaration of structure <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041604" id="P7000497027000000000000000041604">a_struct.</code> Assume that the only fields in this structure are <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041605" id="P7000497027000000000000000041605">idx</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041606" id="P7000497027000000000000000041606">x</code>, and that both of these contain signed values.</p></li>
</ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000033E2" id="P70004970270000000000000000033E2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041607" epub:type="title" id="P7000497027000000000000000041607"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000033E4" epub:type="pagebreak" id="P70004970270000000000000000033E4" title="322"></span><span class="pcalibre1 pcalibre21 pcalibre2">3.70 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041608" id="P7000497027000000000000000041608">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041609" id="P7000497027000000000000000041609">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004160A" id="P700049702700000000000000004160A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004160B" id="P700049702700000000000000004160B">Consider the following union declaration:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004160C" id="P700049702700000000000000004160C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004160D" id="P700049702700000000000000004160D">
1	union ele {
2		struct {
3			long *p;
4			long y;
5		} e1;
6		struct {
7			long x;
8			union ele *next;
9		} e2;
10	};
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004160E" id="P700049702700000000000000004160E">This declaration illustrates that structures can be embedded within unions.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004160F" id="P700049702700000000000000004160F">The following function (with some expressions omitted) operates on a linked list having these unions as list elements:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041610" id="P7000497027000000000000000041610"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041611" id="P7000497027000000000000000041611">
1	void proc (union ele *up) {
2		up-&gt; _____ = *(_____) - _____;
3	}
</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041612" id="P7000497027000000000000000041612">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041613" id="P7000497027000000000000000041613"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041614" id="P7000497027000000000000000041614">What are the offsets (in bytes) of the following fields:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041615" id="P7000497027000000000000000041615"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041616" id="P7000497027000000000000000041616">
e1.p	_____
e1.y	_____
e2.x	_____
e2.next	_____
</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041617" id="P7000497027000000000000000041617"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041618" id="P7000497027000000000000000041618">How many total bytes does the structure require?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041619" id="P7000497027000000000000000041619"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004161A" id="P700049702700000000000000004161A">The compiler generates the following assembly code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004161B" id="P700049702700000000000000004161B">proc:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004161C" id="P700049702700000000000000004161C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004161D" id="P700049702700000000000000004161D">
	<i class="pcalibre17 pcalibre2 pcalibre1">void proc (union ele *up) up in %rdi</i>
1	proc:
2	movq	8(%rdi), %rax
3	movq	(%rax), %rdx
4	movq	(%rdx), %rdx
5	subq	8(%rax), %rdx
6	movq	%rdx, (%rdi)
7	ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004161E" id="P700049702700000000000000004161E">On the basis of this information, fill in the missing expressions in the code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004161F" id="P700049702700000000000000004161F">proc.</code> <i class="pcalibre17 pcalibre2 pcalibre1">Hint:</i> Some union references can have ambiguous interpretations. These ambiguities get resolved as you see where the references lead. There <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000033FD" epub:type="pagebreak" id="P70004970270000000000000000033FD" title="323"></span>is only one answer that does not perform any casting and does not violate any type constraints.</p></li>
</ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000033FE" id="P70004970270000000000000000033FE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041620" epub:type="title" id="P7000497027000000000000000041620"><span class="pcalibre1 pcalibre21 pcalibre2">3.71 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041621" id="P7000497027000000000000000041621">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041622" id="P7000497027000000000000000041622">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041623" id="P7000497027000000000000000041623"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041624" id="P7000497027000000000000000041624">Write a function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041625" id="P7000497027000000000000000041625">good_echo</code> that reads a line from standard input and writes it to standard output. Your implementation should work for an input line of arbitrary length. You may use the library function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041626" id="P7000497027000000000000000041626">fgets</code>, but you must make sure your function works correctly even when the input line requires more space than you have allocated for your buffer. Your code should also check for error conditions and return when one is encountered. Refer to the definitions of the standard I/O functions for documentation <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3FC">[45,</a> <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B41C">61]</a>.</p></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003406" id="P7000497027000000000000000003406"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041627" epub:type="title" id="P7000497027000000000000000041627"><span class="pcalibre1 pcalibre21 pcalibre2">3.72 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041628" id="P7000497027000000000000000041628">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041629" id="P7000497027000000000000000041629">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004162A" id="P700049702700000000000000004162A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004162B" id="P700049702700000000000000004162B"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000340F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.54(a)</span></a> shows the code for a function that is similar to function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004162C" id="P700049702700000000000000004162C">vfunct</code> (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000003022"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.43(a)</span></a>). We used <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004162D" id="P700049702700000000000000004162D">vfunct</code> to illustrate the use of a frame pointer in managing variable-size stack frames. The new function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004162E" id="P700049702700000000000000004162E">aframe</code> allocates space for local</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter03.xhtml#P700049702700000000000000000340F" id="P700049702700000000000000000340F">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004162F" id="P700049702700000000000000004162F">(a) C code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041630" id="P7000497027000000000000000041630"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041631" id="P7000497027000000000000000041631">
1	#include &lt;alloca.h&gt;
2	
3	long aframe(long n, long idx, long *q) {
4		long i;
5		long **p = alloca(n * sizeof(long *));
6		p[0] = &amp;i;
7		for (i = 1; i &lt; n; i++)
8			p[i] = q;
9		return *p[idx];
10 }
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041632" id="P7000497027000000000000000041632">(b) Portions of generated assembly code</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041633" id="P7000497027000000000000000041633"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041634" id="P7000497027000000000000000041634">
	<i class="pcalibre17 pcalibre2 pcalibre1">long aframe(long n, long idx, long *q)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">n in %rdi, idx in %rsi, q in %rdx</i>
1	aframe:
2	pushq	%rbp
3	movq	%rsp, %rbp
4	subq	$16, %rsp <i class="pcalibre17 pcalibre2 pcalibre1">Allocate space for i (%rsp = s</i><sub class="pcalibre1 pcalibre2 pcalibre122">1</sub>)
5	leaq	30(,%rdi,8), %rax
6	andq	$-16, %rax
7	subq	%rax, %rsp <i class="pcalibre17 pcalibre2 pcalibre1">Allocate space for array p (%rsp = s</i><sub class="pcalibre1 pcalibre2 pcalibre122">2</sub>)
8	leaq	15(%rsp), %r8
9	andq	$-16, %r8 <i class="pcalibre17 pcalibre2 pcalibre1">Set %r8 to &amp;p[0]</i>
	⋮
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041635" id="P7000497027000000000000000041635"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter03.xhtml#P7000497027000000000000000041636" epub:type="title" id="P7000497027000000000000000041636"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.54 </span>Code for <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000003406"><span class="label pcalibre1 pcalibre2">Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">3.72</span></a>.</h1></header><div class="pcalibre1 caption pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041637" id="P7000497027000000000000000041637"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041638" id="P7000497027000000000000000041638">This function is similar to that of <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000003022"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">3.43</span></a>.</p></div></figcaption>
</figure>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041639" id="P7000497027000000000000000041639"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000341B" epub:type="pagebreak" id="P700049702700000000000000000341B" title="324"></span>array p by calling library function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004163A" id="P700049702700000000000000004163A">alloca</code>. This function is similar to the more commonly used function malloc, except that it allocates space on the run-time stack. The space is automatically deallocated when the executing procedure returns.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004163B" id="P700049702700000000000000004163B"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000340F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.54(b)</span></a> shows the part of the assembly code that sets up the frame pointer and allocates space for local variables <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004163C" id="P700049702700000000000000004163C">i</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004163D" id="P700049702700000000000000004163D">p</code>. It is very similar to the corresponding code for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004163E" id="P700049702700000000000000004163E">vframe</code>. Let us use the same notation as in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000003055"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.49</span></a>: The stack pointer is set to values <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub> at line 4 and <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> at line 7. The start address of array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004163F" id="P700049702700000000000000004163F">p</code> is set to value <var class="pcalibre17 pcalibre2 pcalibre1">p</var> at line 9. Extra space <var class="pcalibre17 pcalibre2 pcalibre1">e</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> may arise between <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> and <var class="pcalibre17 pcalibre2 pcalibre1">p</var>, and extra space <var class="pcalibre17 pcalibre2 pcalibre1">e</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub> may arise between the end of array <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041640" id="P7000497027000000000000000041640">p</code> and <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041641" id="P7000497027000000000000000041641">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041642" id="P7000497027000000000000000041642"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041643" id="P7000497027000000000000000041643">Explain, in mathematical terms, the logic in the computation of <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041644" id="P7000497027000000000000000041644"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041645" id="P7000497027000000000000000041645">Explain, in mathematical terms, the logic in the computation of <var class="pcalibre17 pcalibre2 pcalibre1">p</var>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041646" id="P7000497027000000000000000041646"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041647" id="P7000497027000000000000000041647">Find values of <var class="pcalibre17 pcalibre2 pcalibre1">n</var> and <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub> that lead to minimum and maximum values of <var class="pcalibre17 pcalibre2 pcalibre1">e</var><sub class="pcalibre1 pcalibre2 calibre14">1</sub>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041648" id="P7000497027000000000000000041648"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041649" id="P7000497027000000000000000041649">What alignment properties does this code guarantee for the values of <var class="pcalibre17 pcalibre2 pcalibre1">s</var><sub class="pcalibre1 pcalibre2 calibre14">2</sub> and <var class="pcalibre17 pcalibre2 pcalibre1">p</var>?</p></li>
</ol></div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000342C" id="P700049702700000000000000000342C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004164A" epub:type="title" id="P700049702700000000000000004164A"><span class="pcalibre1 pcalibre21 pcalibre2">3.73 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P700049702700000000000000004164B" id="P700049702700000000000000004164B">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P700049702700000000000000004164C" id="P700049702700000000000000004164C">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004164D" id="P700049702700000000000000004164D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004164E" id="P700049702700000000000000004164E">Write a function in assembly code that matches the behavior of the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004164F" id="P700049702700000000000000004164F">find_range</code> in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003294"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.51</span></a>. Your code should contain only one floating-point comparison instruction, and then it should use conditional branches to generate the correct result. Test your code on all 2<sup class="pcalibre1 pcalibre2 pcalibre85">32</sup> possible argument values. Web Aside <span class="pcalibre1 pcalibre29 pcalibre2">ASM:EASM </span>on page 178 describes how to incorporate functions written in assembly code into C programs.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003433" id="P7000497027000000000000000003433"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041650" epub:type="title" id="P7000497027000000000000000041650"><span class="pcalibre1 pcalibre21 pcalibre2">3.74 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041651" id="P7000497027000000000000000041651">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041652" id="P7000497027000000000000000041652">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041653" id="P7000497027000000000000000041653"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041654" id="P7000497027000000000000000041654">Write a function in assembly code that matches the behavior of the function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041655" id="P7000497027000000000000000041655">find_range</code> in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000003080.xhtml#P7000497027000000000000000003294"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.51</span></a>. Your code should contain only one floating-point comparison instruction, and then it should use conditional moves to generate the correct result. You might want to make use of the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041656" id="P7000497027000000000000000041656">cmovp</code> (move if even parity). Test your code on all 2<sup class="pcalibre1 pcalibre2 pcalibre85">32</sup> possible argument values. Web Aside <span class="pcalibre1 pcalibre29 pcalibre2">ASM:EASM </span>on page 178 describes how to incorporate functions written in assembly code into C programs.</p>
</div></li></ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000343B" id="P700049702700000000000000000343B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041657" epub:type="title" id="P7000497027000000000000000041657"><span class="pcalibre1 pcalibre21 pcalibre2">3.75 </span></h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter03.xhtml#P7000497027000000000000000041658" id="P7000497027000000000000000041658">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter03.xhtml#P7000497027000000000000000041659" id="P7000497027000000000000000041659">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter03.xhtml#P700049702700000000000000004165A" id="P700049702700000000000000004165A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004165B" id="P700049702700000000000000004165B">ISO C99 includes extensions to support complex numbers. Any floating-point type can be modified with the keyword complex. Here are some sample functions that work with complex data and that call some of the associated library functions:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004165C" id="P700049702700000000000000004165C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004165D" id="P700049702700000000000000004165D">
1	#include &lt;complex.h&gt; 2
3	double c_imag(double complex x) {
4		return cimag(x);
5	}
6	
7	double c_real(double complex x) {
8		return creal(x);
9	}
10	
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003443" epub:type="pagebreak" id="P7000497027000000000000000003443" title="325"></span>11	double complex c_sub(double complex x, double complex y) {
12		return x - y;
13	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004165E" id="P700049702700000000000000004165E">When compiled, <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>generates the following assembly code for these functions:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004165F" id="P700049702700000000000000004165F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041660" id="P7000497027000000000000000041660">
	<i class="pcalibre17 pcalibre2 pcalibre1">double c_imag(double complex x)</i>
1	c_imag:
2		movapd	%xmm1, %xmm0
3		ret

	<i class="pcalibre17 pcalibre2 pcalibre1">double c_real(double complex x)</i>
4	c_real:
5		rep; ret

	<i class="pcalibre17 pcalibre2 pcalibre1">double complex c_sub(double complex x, double complex y)</i>
6	c_sub:
7		subsd	%xmm2, %xmm0
8		subsd	%xmm3, %xmm1
9		ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041661" id="P7000497027000000000000000041661">Based on these examples, determine the following:</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041662" id="P7000497027000000000000000041662">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041663" id="P7000497027000000000000000041663"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041664" id="P7000497027000000000000000041664">How are complex arguments passed to a function?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041665" id="P7000497027000000000000000041665"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041666" id="P7000497027000000000000000041666">How are complex values returned from a function?</p></li>
</ol></div></li></ol>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Solutions to Practice Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P700049702700000000000000000344D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter03.xhtml#P7000497027000000000000000041667" epub:type="title" id="P7000497027000000000000000041667"><span class="pcalibre1 pcalibre21 pcalibre2">Solutions to Practice Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000344F" id="P700049702700000000000000000344F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041668" epub:type="title" id="P7000497027000000000000000041668"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001FB4"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.1 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001FB3">182</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041669" id="P7000497027000000000000000041669">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004166A" id="P700049702700000000000000004166A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004166B" id="P700049702700000000000000004166B">This exercise gives you practice with the different operand forms.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P700049702700000000000000004166C" id="P700049702700000000000000004166C">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004166D" id="P700049702700000000000000004166D">Operand</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004166E" id="P700049702700000000000000004166E">Value</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004166F" id="P700049702700000000000000004166F">Comment</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041670" id="P7000497027000000000000000041670"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041671" id="P7000497027000000000000000041671">%rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041672" id="P7000497027000000000000000041672"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041673" id="P7000497027000000000000000041673">0x100</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041674" id="P7000497027000000000000000041674">Register</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041675" id="P7000497027000000000000000041675"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041676" id="P7000497027000000000000000041676">0x104</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041677" id="P7000497027000000000000000041677"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041678" id="P7000497027000000000000000041678">0xAB</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041679" id="P7000497027000000000000000041679">Absolute address</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004167A" id="P700049702700000000000000004167A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004167B" id="P700049702700000000000000004167B">$0x108</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004167C" id="P700049702700000000000000004167C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004167D" id="P700049702700000000000000004167D">0x108</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004167E" id="P700049702700000000000000004167E">Immediate</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004167F" id="P700049702700000000000000004167F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041680" id="P7000497027000000000000000041680">(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041681" id="P7000497027000000000000000041681"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041682" id="P7000497027000000000000000041682">0xFF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041683" id="P7000497027000000000000000041683">Address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041684" id="P7000497027000000000000000041684">0x100</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041685" id="P7000497027000000000000000041685"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041686" id="P7000497027000000000000000041686">4(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041687" id="P7000497027000000000000000041687"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041688" id="P7000497027000000000000000041688">0xAB</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041689" id="P7000497027000000000000000041689">Address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004168A" id="P700049702700000000000000004168A">0x104</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004168B" id="P700049702700000000000000004168B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004168C" id="P700049702700000000000000004168C">9(%rax,%rdx)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004168D" id="P700049702700000000000000004168D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004168E" id="P700049702700000000000000004168E">0x11</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004168F" id="P700049702700000000000000004168F">Address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041690" id="P7000497027000000000000000041690">0x10C</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041691" id="P7000497027000000000000000041691"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041692" id="P7000497027000000000000000041692">260(%rcx,%rdx)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041693" id="P7000497027000000000000000041693"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041694" id="P7000497027000000000000000041694">0x13</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041695" id="P7000497027000000000000000041695">Address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041696" id="P7000497027000000000000000041696">0x108</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041697" id="P7000497027000000000000000041697"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041698" id="P7000497027000000000000000041698">0xFC(,%rcx,4)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041699" id="P7000497027000000000000000041699"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004169A" id="P700049702700000000000000004169A">0xFF</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004169B" id="P700049702700000000000000004169B">Address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004169C" id="P700049702700000000000000004169C">0x100</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004169D" id="P700049702700000000000000004169D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004169E" id="P700049702700000000000000004169E">(%rax,%rdx,4)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004169F" id="P700049702700000000000000004169F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416A0" id="P70004970270000000000000000416A0">0x11</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416A1" id="P70004970270000000000000000416A1">Address <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416A2" id="P70004970270000000000000000416A2">0x10C</code></td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000348B" id="P700049702700000000000000000348B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416A3" epub:type="title" id="P70004970270000000000000000416A3"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000002087"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.2 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000001F3C.xhtml#P700049702700000000000000000205C">185</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416A4" id="P70004970270000000000000000416A4">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000416A5" id="P70004970270000000000000000416A5"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000416A6" id="P70004970270000000000000000416A6">As we have seen, the assembly code generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>includes suffixes on the instructions, while the disassembler does not. Being able to switch between these <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003490" epub:type="pagebreak" id="P7000497027000000000000000003490" title="326"></span>two forms is an important skill to learn. One important feature is that memory references in x86-64 are always given with quad word registers, such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416A7" id="P70004970270000000000000000416A7">%rax</code>, even if the operand is a byte, single word, or double word.</p>
<p class="pcalibre1 pcalibre2 pcalibre42" data-uri="chapter03.xhtml#P70004970270000000000000000416A8" id="P70004970270000000000000000416A8">Here is the code written with suffixes:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000416A9" id="P70004970270000000000000000416A9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416AA" id="P70004970270000000000000000416AA">
movl	%eax, (%rsp)
movw	(%rax), %dx
movb	$0xFF, %bl
movb	(%rsp,%rdx,4), %dl
movq	(%rdx), %rax
movw	%dx, (%rax)
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003495" id="P7000497027000000000000000003495"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416AB" epub:type="title" id="P70004970270000000000000000416AB"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P70004970270000000000000000020A3"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.3 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000002093">186</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416AC" id="P70004970270000000000000000416AC">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000416AD" id="P70004970270000000000000000416AD"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000416AE" id="P70004970270000000000000000416AE">Since we will rely on <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>to generate most of our assembly code, being able to write correct assembly code is not a critical skill. Nonetheless, this exercise will help you become more familiar with the different instruction and operand types.</p>
<p class="pcalibre1 pcalibre2 pcalibre42" data-uri="chapter03.xhtml#P70004970270000000000000000416AF" id="P70004970270000000000000000416AF">Here is the code with explanations of the errors:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000416B0" id="P70004970270000000000000000416B0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416B1" id="P70004970270000000000000000416B1">
movb	$0xF, (%ebx)	<i class="pcalibre17 pcalibre2 pcalibre1">Cannot use %ebx as address register</i>
movl	%rax, (%rsp)	<i class="pcalibre17 pcalibre2 pcalibre1">Mismatch between instruction suffix and register ID</i>
movw	(%rax),4(%rsp)	<i class="pcalibre17 pcalibre2 pcalibre1">Cannot have both source and destination be memory references</i>
movb	%al,%sl		<i class="pcalibre17 pcalibre2 pcalibre1">No register named %sl</i>
movl	%eax,$0x123	<i class="pcalibre17 pcalibre2 pcalibre1">Cannot have immediate as destination</i>
movl	%eax,%dx	<i class="pcalibre17 pcalibre2 pcalibre1">Destination operand incorrect size</i>
movb	%si, 8(%rbp)	<i class="pcalibre17 pcalibre2 pcalibre1">Mismatch between instruction suffix and register ID</i>
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000349D" id="P700049702700000000000000000349D"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416B2" epub:type="title" id="P70004970270000000000000000416B2"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P70004970270000000000000000020D5"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.4 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000001F3C.xhtml#P70004970270000000000000000020B6">187</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416B3" id="P70004970270000000000000000416B3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000416B4" id="P70004970270000000000000000416B4"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000416B5" id="P70004970270000000000000000416B5">This exercise gives you more experience with the different data movement instructions and how they relate to the data types and conversion rules of C. The nuances of conversions of both signedness and size, as well as integral promotion, add challenge to this problem.</p>
<table class="pcalibre1 informaltable pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416B6" id="P70004970270000000000000000416B6">
<thead class="pcalibre44 pcalibre2 pcalibre1"><tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000416B7" id="P70004970270000000000000000416B7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416B8" id="P70004970270000000000000000416B8">src_t</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000416B9" id="P70004970270000000000000000416B9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416BA" id="P70004970270000000000000000416BA">dest_t</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000416BB" id="P70004970270000000000000000416BB">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P70004970270000000000000000416BC" id="P70004970270000000000000000416BC">Comments</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416BD" id="P70004970270000000000000000416BD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416BE" id="P70004970270000000000000000416BE">long</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416BF" id="P70004970270000000000000000416BF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416C0" id="P70004970270000000000000000416C0">long</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416C1" id="P70004970270000000000000000416C1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416C2" id="P70004970270000000000000000416C2">movq (%rdi), %rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416C3" id="P70004970270000000000000000416C3">Read 8 bytes</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416C4" id="P70004970270000000000000000416C4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416C5" id="P70004970270000000000000000416C5">movq %rax, (%rsi)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416C6" id="P70004970270000000000000000416C6">Store 8 bytes</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416C7" id="P70004970270000000000000000416C7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416C8" id="P70004970270000000000000000416C8">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416C9" id="P70004970270000000000000000416C9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416CA" id="P70004970270000000000000000416CA">int</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416CB" id="P70004970270000000000000000416CB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416CC" id="P70004970270000000000000000416CC">movsbl (%rdi), %eax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416CD" id="P70004970270000000000000000416CD">Convert char to int</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416CE" id="P70004970270000000000000000416CE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416CF" id="P70004970270000000000000000416CF">movl %eax, (%rsi)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416D0" id="P70004970270000000000000000416D0">Store 4 bytes</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416D1" id="P70004970270000000000000000416D1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416D2" id="P70004970270000000000000000416D2">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416D3" id="P70004970270000000000000000416D3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416D4" id="P70004970270000000000000000416D4">unsigned</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416D5" id="P70004970270000000000000000416D5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416D6" id="P70004970270000000000000000416D6">movsbl (%rdi), %eax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416D7" id="P70004970270000000000000000416D7">Convert char to int</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416D8" id="P70004970270000000000000000416D8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416D9" id="P70004970270000000000000000416D9">movl %eax, (%rsi)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416DA" id="P70004970270000000000000000416DA">Store 4 bytes</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416DB" id="P70004970270000000000000000416DB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416DC" id="P70004970270000000000000000416DC">unsigned char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416DD" id="P70004970270000000000000000416DD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416DE" id="P70004970270000000000000000416DE">long</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416DF" id="P70004970270000000000000000416DF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416E0" id="P70004970270000000000000000416E0">movzbl (%rdi), %eax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416E1" id="P70004970270000000000000000416E1">Read byte and zero-extend</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416E2" id="P70004970270000000000000000416E2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416E3" id="P70004970270000000000000000416E3">movq %rax, (%rsi)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416E4" id="P70004970270000000000000000416E4">Store 8 bytes</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416E5" id="P70004970270000000000000000416E5"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000034D2" epub:type="pagebreak" id="P70004970270000000000000000034D2" title="327"></span><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416E6" id="P70004970270000000000000000416E6">int</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416E7" id="P70004970270000000000000000416E7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416E8" id="P70004970270000000000000000416E8">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416E9" id="P70004970270000000000000000416E9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416EA" id="P70004970270000000000000000416EA">movl (%rdi), %eax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416EB" id="P70004970270000000000000000416EB">Read 4 bytes</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416EC" id="P70004970270000000000000000416EC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416ED" id="P70004970270000000000000000416ED">movb %al, (%rsi)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416EE" id="P70004970270000000000000000416EE">Store low-order byte</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416EF" id="P70004970270000000000000000416EF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416F0" id="P70004970270000000000000000416F0">unsigned</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416F1" id="P70004970270000000000000000416F1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416F2" id="P70004970270000000000000000416F2">unsigned</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416F3" id="P70004970270000000000000000416F3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416F4" id="P70004970270000000000000000416F4">movl (%rdi), %eax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416F5" id="P70004970270000000000000000416F5">Read 4 bytes</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416F6" id="P70004970270000000000000000416F6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416F7" id="P70004970270000000000000000416F7">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416F8" id="P70004970270000000000000000416F8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416F9" id="P70004970270000000000000000416F9">movb %al, (%rsi)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416FA" id="P70004970270000000000000000416FA">Store low-order byte</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416FB" id="P70004970270000000000000000416FB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416FC" id="P70004970270000000000000000416FC">char</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416FD" id="P70004970270000000000000000416FD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000416FE" id="P70004970270000000000000000416FE">short</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P70004970270000000000000000416FF" id="P70004970270000000000000000416FF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041700" id="P7000497027000000000000000041700">movsbw (%rdi), %ax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041701" id="P7000497027000000000000000041701">Read byte and sign-extend</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041702" id="P7000497027000000000000000041702"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041703" id="P7000497027000000000000000041703">movw %ax, (%rsi)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041704" id="P7000497027000000000000000041704">Store 2 bytes</td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000034F2" id="P70004970270000000000000000034F2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041705" epub:type="title" id="P7000497027000000000000000041705"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000002131"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.5 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000002118">189</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041706" id="P7000497027000000000000000041706">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041707" id="P7000497027000000000000000041707"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041708" id="P7000497027000000000000000041708">Reverse engineering is a good way to understand systems. In this case, we want to reverse the effect of the C compiler to determine what C code gave rise to this assembly code. The best way is to run a "simulation," starting with values <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041709" id="P7000497027000000000000000041709">x, y</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004170A" id="P700049702700000000000000004170A">z</code> at the locations designated by pointers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004170B" id="P700049702700000000000000004170B">xp, yp</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004170C" id="P700049702700000000000000004170C">zp</code>, respectively. We would then get the following behavior:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004170D" id="P700049702700000000000000004170D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004170E" id="P700049702700000000000000004170E">
	<i class="pcalibre17 pcalibre2 pcalibre1">void decode1(long *xp, long *yp, long *zp)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">xp in %rdi, yp in %rsi, zp in %rdx</i>
decode1:
	movq	(%rdi), %r8	<i class="pcalibre17 pcalibre2 pcalibre1">Get x = *xp</i>
	movq	(%rsi), %rcx	<i class="pcalibre17 pcalibre2 pcalibre1">Get y = *yp</i>
	movq	(%rdx), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Get z = *zp</i>
	movq	%r8, (%rsi)	<i class="pcalibre17 pcalibre2 pcalibre1">Store x at yp</i>
	movq	%rcx, (%rdx)	<i class="pcalibre17 pcalibre2 pcalibre1">Store y at zp</i>
	movq	%rax, (%rdi)	<i class="pcalibre17 pcalibre2 pcalibre1">Store z at xp</i>
	ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004170F" id="P700049702700000000000000004170F">From this, we can generate the following C code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041710" id="P7000497027000000000000000041710"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041711" id="P7000497027000000000000000041711">
void decode1(long *xp, long *yp, long *zp)
{
	long x = *xp;
	long y = *yp;
	long z = *zp;

	*yp = x;
	*zp = y;
	*xp = z;
}
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003500" id="P7000497027000000000000000003500"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041712" epub:type="title" id="P7000497027000000000000000041712"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P70004970270000000000000000021DE"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002185.xhtml#P70004970270000000000000000021F7">192</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041713" id="P7000497027000000000000000041713">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041714" id="P7000497027000000000000000041714"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041715" id="P7000497027000000000000000041715">This exercise demonstrates the versatility of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041716" id="P7000497027000000000000000041716">leaq</code> instruction and gives you more practice in deciphering the different operand forms. Although the operand forms are classified as type "Memory" in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000001F3C.xhtml#P7000497027000000000000000001F57"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">3.3</span></a>, no memory access occurs.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P7000497027000000000000000041717" id="P7000497027000000000000000041717">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041718" id="P7000497027000000000000000041718"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003508" epub:type="pagebreak" id="P7000497027000000000000000003508" title="328"></span>Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041719" id="P7000497027000000000000000041719">Result</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004171A" id="P700049702700000000000000004171A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004171B" id="P700049702700000000000000004171B">leaq 6(%rax), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004171C" id="P700049702700000000000000004171C">6+<var class="pcalibre17 pcalibre2 pcalibre1">x</var></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004171D" id="P700049702700000000000000004171D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004171E" id="P700049702700000000000000004171E">leaq (%rax,%rcx), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004171F" id="P700049702700000000000000004171F"><var class="pcalibre17 pcalibre2 pcalibre1">x</var> +<var class="pcalibre17 pcalibre2 pcalibre1">y</var></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041720" id="P7000497027000000000000000041720"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041721" id="P7000497027000000000000000041721">leaq (%rax,%rcx,4), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041722" id="P7000497027000000000000000041722"><var class="pcalibre17 pcalibre2 pcalibre1">x</var> + 4<var class="pcalibre17 pcalibre2 pcalibre1">y</var></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041723" id="P7000497027000000000000000041723"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041724" id="P7000497027000000000000000041724">leaq 7(%rax,%rax,8), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041725" id="P7000497027000000000000000041725">7 + 9<var class="pcalibre17 pcalibre2 pcalibre1">x</var></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041726" id="P7000497027000000000000000041726"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041727" id="P7000497027000000000000000041727">leaq 0xA(,%rcx,4), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041728" id="P7000497027000000000000000041728">10 + 4<var class="pcalibre17 pcalibre2 pcalibre1">y</var></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041729" id="P7000497027000000000000000041729"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004172A" id="P700049702700000000000000004172A">leaq 9(%rax,%rcx,2), %rdx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004172B" id="P700049702700000000000000004172B">9 +<var class="pcalibre17 pcalibre2 pcalibre1">x</var> + 2<var class="pcalibre17 pcalibre2 pcalibre1">y</var></td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000351C" id="P700049702700000000000000000351C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004172C" epub:type="title" id="P700049702700000000000000004172C"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002208"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.7 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002185.xhtml#P70004970270000000000000000021FE">193</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004172D" id="P700049702700000000000000004172D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004172E" id="P700049702700000000000000004172E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004172F" id="P700049702700000000000000004172F">Again, reverse engineering proves to be a useful way to learn the relationship between C code and the generated assembly code.</p>
<p class="pcalibre1 pcalibre2 pcalibre42" data-uri="chapter03.xhtml#P7000497027000000000000000041730" id="P7000497027000000000000000041730">The best way to solve problems of this type is to annotate the lines of assembly code with information about the operations being performed. Here is a sample:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041731" id="P7000497027000000000000000041731"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041732" id="P7000497027000000000000000041732">
	<i class="pcalibre17 pcalibre2 pcalibre1">long scale2(long x, long y, long z)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, z in %rdx</i>
scale2:
  leaq	(%rdi,%rdi,4), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">5*x</i>
  leaq	(%rax,%rsi,2), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">5*x+2*y</i>
  leaq	(%rax,%rdx,8), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">5*x+2*y+8*z</i>
  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041733" id="P7000497027000000000000000041733">From this, it is easy to generate the missing expression:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041734" id="P7000497027000000000000000041734"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041735" id="P7000497027000000000000000041735">
long t = 5 * x + 2 * y + 8 * z;
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003527" id="P7000497027000000000000000003527"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041736" epub:type="title" id="P7000497027000000000000000041736"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002220"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.8 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002216">194</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041737" id="P7000497027000000000000000041737">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041738" id="P7000497027000000000000000041738"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041739" id="P7000497027000000000000000041739">This problem gives you a chance to test your understanding of operands and the arithmetic instructions. The instruction sequence is designed so that the result of each instruction does not affect the behavior of subsequent ones.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter03.xhtml#P700049702700000000000000004173A" id="P700049702700000000000000004173A">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004173B" id="P700049702700000000000000004173B">Instruction</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004173C" id="P700049702700000000000000004173C">Destination</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004173D" id="P700049702700000000000000004173D">Value</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004173E" id="P700049702700000000000000004173E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004173F" id="P700049702700000000000000004173F">addq %rcx,(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041740" id="P7000497027000000000000000041740"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041741" id="P7000497027000000000000000041741">0x100</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041742" id="P7000497027000000000000000041742"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041743" id="P7000497027000000000000000041743">0x100</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041744" id="P7000497027000000000000000041744"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041745" id="P7000497027000000000000000041745">subq %rdx,8(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041746" id="P7000497027000000000000000041746"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041747" id="P7000497027000000000000000041747">0x108</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041748" id="P7000497027000000000000000041748"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041749" id="P7000497027000000000000000041749">0xA8</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004174A" id="P700049702700000000000000004174A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004174B" id="P700049702700000000000000004174B">imulq $16,(%rax,%rdx,8)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004174C" id="P700049702700000000000000004174C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004174D" id="P700049702700000000000000004174D">0x118</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004174E" id="P700049702700000000000000004174E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004174F" id="P700049702700000000000000004174F">0x110</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041750" id="P7000497027000000000000000041750"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041751" id="P7000497027000000000000000041751">incq 16(%rax)</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041752" id="P7000497027000000000000000041752"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041753" id="P7000497027000000000000000041753">0x110</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041754" id="P7000497027000000000000000041754"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041755" id="P7000497027000000000000000041755">0x14</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041756" id="P7000497027000000000000000041756"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041757" id="P7000497027000000000000000041757">decq %rcx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041758" id="P7000497027000000000000000041758"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041759" id="P7000497027000000000000000041759">%rcx</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004175A" id="P700049702700000000000000004175A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004175B" id="P700049702700000000000000004175B">0x0</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004175C" id="P700049702700000000000000004175C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004175D" id="P700049702700000000000000004175D">subq %rdx,%rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004175E" id="P700049702700000000000000004175E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004175F" id="P700049702700000000000000004175F">%rax</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041760" id="P7000497027000000000000000041760"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041761" id="P7000497027000000000000000041761">0xFD</code></td>
</tr>
</tbody>
</table>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003554" id="P7000497027000000000000000003554"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041762" epub:type="title" id="P7000497027000000000000000041762"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002273"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.9 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002267">195</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041763" id="P7000497027000000000000000041763">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041764" id="P7000497027000000000000000041764"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041765" id="P7000497027000000000000000041765">This exercise gives you a chance to generate a little bit of assembly code. The solution code was generated by <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>. By loading parameter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041766" id="P7000497027000000000000000041766">n</code> in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041767" id="P7000497027000000000000000041767">%ecx</code>, it can then use byte register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041768" id="P7000497027000000000000000041768">%cl</code> to specify the shift amount for the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041769" id="P7000497027000000000000000041769">sarq</code> instruction. It might seem odd to use a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004176A" id="P700049702700000000000000004176A">movl</code> instruction, given that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004176B" id="P700049702700000000000000004176B">n</code> is eight bytes long, but keep in mind that only the least significant byte is required to specify the shift amount.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004176C" id="P700049702700000000000000004176C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004176D" id="P700049702700000000000000004176D">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003561" epub:type="pagebreak" id="P7000497027000000000000000003561" title="329"></span>	<i class="pcalibre17 pcalibre2 pcalibre1">long shift_left4_rightn(long x, long n)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, n in %rsi</i>
shift_left4_rightn:
	movq	%rdi, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Get x</i>
	salq	$4, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">x &lt;&lt;= 4</i>
	movl	%esi, %ecx	<i class="pcalibre17 pcalibre2 pcalibre1">Get n (4 bytes)</i>
	sarq	%cl, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">x &gt;&gt;= n</i>
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003562" id="P7000497027000000000000000003562"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004176E" epub:type="title" id="P700049702700000000000000004176E"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P70004970270000000000000000022A1"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002286">196</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004176F" id="P700049702700000000000000004176F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041770" id="P7000497027000000000000000041770"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041771" id="P7000497027000000000000000041771">This problem is fairly straightforward, since the assembly code follows the structure of the C code closely.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041772" id="P7000497027000000000000000041772"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041773" id="P7000497027000000000000000041773">
long t1 = x | y;
long t2 = t1 &lt;&lt; 3;
long t3 = ~t2;
long t4 = z-t3;
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003569" id="P7000497027000000000000000003569"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041774" epub:type="title" id="P7000497027000000000000000041774"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P70004970270000000000000000022AE"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.11 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002185.xhtml#P70004970270000000000000000022A9">197</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041775" id="P7000497027000000000000000041775">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041776" id="P7000497027000000000000000041776"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041777" id="P7000497027000000000000000041777">This instruction is used to set register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041778" id="P7000497027000000000000000041778">%rdx</code> to zero, exploiting the property that <var class="pcalibre17 pcalibre2 pcalibre1">x</var> ^ <var class="pcalibre17 pcalibre2 pcalibre1">x</var> = 0 for any <var class="pcalibre17 pcalibre2 pcalibre1">x</var>. It corresponds to the C statement <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041779" id="P7000497027000000000000000041779">x</code> = 0.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004177A" id="P700049702700000000000000004177A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004177B" id="P700049702700000000000000004177B">A more direct way of setting register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004177C" id="P700049702700000000000000004177C">%rdx</code> to zero is with the instruction <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004177D" id="P700049702700000000000000004177D">movq $0,%rdx.</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004177E" id="P700049702700000000000000004177E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P700049702700000000000000004177F" id="P700049702700000000000000004177F">Assembling and disassembling this code, however, we find that the version with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041780" id="P7000497027000000000000000041780">xorq</code> requires only 3 bytes, while the version with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041781" id="P7000497027000000000000000041781">movq</code> requires 7. Other ways to set <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041782" id="P7000497027000000000000000041782">%rdx</code> to zero rely on the property that any instruction that updates the lower 4 bytes will cause the high-order bytes to be set to zero. Thus, we could use either <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041783" id="P7000497027000000000000000041783">xorl %edx,%edx</code> (2 bytes) or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041784" id="P7000497027000000000000000041784">movl $0,%edx</code> (5 bytes).</p></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000357B" id="P700049702700000000000000000357B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041785" epub:type="title" id="P7000497027000000000000000041785"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002330"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.12 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002185.xhtml#P7000497027000000000000000002324">200</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041786" id="P7000497027000000000000000041786">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041787" id="P7000497027000000000000000041787"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041788" id="P7000497027000000000000000041788">We can simply replace the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041789" id="P7000497027000000000000000041789">cqto</code> instruction with one that sets register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004178A" id="P700049702700000000000000004178A">%rdx</code> to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004178B" id="P700049702700000000000000004178B">zero</code>, and use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004178C" id="P700049702700000000000000004178C">divq</code> rather than <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004178D" id="P700049702700000000000000004178D">idivq</code> as our division instruction, yielding the following code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004178E" id="P700049702700000000000000004178E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004178F" id="P700049702700000000000000004178F">
	<i class="pcalibre17 pcalibre2 pcalibre1">void uremdiv(unsigned long x, unsigned long y</i>, <i class="pcalibre17 pcalibre2 pcalibre1">unsigned long *qp, unsigned long *rp)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi, y in %rsi, qp in %rdx, rp in %rcx</i>
1	uremdiv:
2	  movq	%rdx, %r8	<i class="pcalibre17 pcalibre2 pcalibre1">Copy qp</i>
3	  movq	%rdi, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Move x to lower 8 bytes of dividend</i>
4	  movl	$0, %edx	<i class="pcalibre17 pcalibre2 pcalibre1">Set upper 8 bytes of dividend to 0</i>
5	  divq	%rsi		<i class="pcalibre17 pcalibre2 pcalibre1">Divide by y</i>
6	  movq	%rax, (%r8)	<i class="pcalibre17 pcalibre2 pcalibre1">Store quotient at qp</i>
7	  movq	%rdx, (%rcx)	<i class="pcalibre17 pcalibre2 pcalibre1">Store remainder at rp</i>
8	  ret
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003587" id="P7000497027000000000000000003587"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041790" epub:type="title" id="P7000497027000000000000000041790"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003589" epub:type="pagebreak" id="P7000497027000000000000000003589" title="330"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002406"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.13 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_000.xhtml#P70004970270000000000000000023FC">204</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041791" id="P7000497027000000000000000041791">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041792" id="P7000497027000000000000000041792"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041793" id="P7000497027000000000000000041793">It is important to understand that assembly code does not keep track of the type of a program value. Instead, the different instructions determine the operand sizes and whether they are signed or unsigned. When mapping from instruction sequences back to C code, we must do a bit of detective work to infer the data types of the program values.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041794" id="P7000497027000000000000000041794">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041795" id="P7000497027000000000000000041795"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041796" id="P7000497027000000000000000041796">The suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041797" id="P7000497027000000000000000041797">l</code>' and the register identifiers indicate 32-bit operands, while the comparison is for a two's-complement &lt;. We can infer that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041798" id="P7000497027000000000000000041798">data_t</code> must be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041799" id="P7000497027000000000000000041799">int.</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004179A" id="P700049702700000000000000004179A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004179B" id="P700049702700000000000000004179B">The suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004179C" id="P700049702700000000000000004179C">w</code>' and the register identifiers indicate 16-bit operands, while the comparison is for a two's-complement &gt;=. We can infer that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004179D" id="P700049702700000000000000004179D">data_t</code> must be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004179E" id="P700049702700000000000000004179E">short.</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004179F" id="P700049702700000000000000004179F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417A0" id="P70004970270000000000000000417A0">The suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417A1" id="P70004970270000000000000000417A1">b</code>' and the register identifiers indicate 8-bit operands, while the comparison is for an unsigned &lt;=. We can infer that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417A2" id="P70004970270000000000000000417A2">data_t</code> must be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417A3" id="P70004970270000000000000000417A3">unsigned char.</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417A4" id="P70004970270000000000000000417A4"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417A5" id="P70004970270000000000000000417A5">The suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417A6" id="P70004970270000000000000000417A6">q</code>' and the register identifiers indicate 64-bit operands, while the comparison is for !=, which is the same whether the arguments are signed, unsigned, or pointers. We can infer that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417A7" id="P70004970270000000000000000417A7">data_t</code> could be either <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417A8" id="P70004970270000000000000000417A8">long, unsigned long</code>, or some form of pointer.</p></li>
</ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000035A2" id="P70004970270000000000000000035A2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417A9" epub:type="title" id="P70004970270000000000000000417A9"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000242B"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.14 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002424">205</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417AA" id="P70004970270000000000000000417AA">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417AB" id="P70004970270000000000000000417AB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417AC" id="P70004970270000000000000000417AC">This problem is similar to <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002406"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.13</span></a>, except that it involves <span class="pcalibre1 pcalibre29 pcalibre2">test </span>instructions rather than <span class="pcalibre1 pcalibre29 pcalibre2">cmp </span>instructions.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000417AD" id="P70004970270000000000000000417AD">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417AE" id="P70004970270000000000000000417AE"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417AF" id="P70004970270000000000000000417AF">The suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417B0" id="P70004970270000000000000000417B0">q</code>' and the register identifiers indicate a 64-bit operand, while the comparison is for &gt;=, which must be signed. We can infer that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417B1" id="P70004970270000000000000000417B1">data_t</code> must be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417B2" id="P70004970270000000000000000417B2">long</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417B3" id="P70004970270000000000000000417B3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417B4" id="P70004970270000000000000000417B4">The suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417B5" id="P70004970270000000000000000417B5">w</code>' and the register identifier indicate a 16-bit operand, while the comparison is for ==, which is the same for signed or unsigned. We can infer that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417B6" id="P70004970270000000000000000417B6">data_t</code> must be either <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417B7" id="P70004970270000000000000000417B7">short or unsigned short.</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417B8" id="P70004970270000000000000000417B8"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417B9" id="P70004970270000000000000000417B9">The suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417BA" id="P70004970270000000000000000417BA">b</code>' and the register identifier indicate an 8-bit operand, while the comparison is for unsigned &gt;. We can infer that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417BB" id="P70004970270000000000000000417BB">data_t</code> must be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417BC" id="P70004970270000000000000000417BC">unsigned char.</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417BD" id="P70004970270000000000000000417BD"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417BE" id="P70004970270000000000000000417BE">The suffix `<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417BF" id="P70004970270000000000000000417BF">l</code>' and the register identifier indicate 32-bit operands, while the comparison is for &lt;. We can infer that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417C0" id="P70004970270000000000000000417C0">data_t</code> must be <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417C1" id="P70004970270000000000000000417C1">int.</code></p></li>
</ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000035BC" id="P70004970270000000000000000035BC"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417C2" epub:type="title" id="P70004970270000000000000000417C2"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P70004970270000000000000000024F9"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.15 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_000.xhtml#P70004970270000000000000000024FB">209</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417C3" id="P70004970270000000000000000417C3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417C4" id="P70004970270000000000000000417C4"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417C5" id="P70004970270000000000000000417C5">This exercise requires you to examine disassembled code in detail and reason about the encodings for jump targets. It also gives you practice in hexadecimal arithmetic.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000417C6" id="P70004970270000000000000000417C6">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417C7" id="P70004970270000000000000000417C7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417C8" id="P70004970270000000000000000417C8">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417C9" id="P70004970270000000000000000417C9">je</code> instruction has as its target <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417CA" id="P70004970270000000000000000417CA">0x4003fc + 0x02.</code> As the original disassembled code shows, this is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417CB" id="P70004970270000000000000000417CB">0x4003fe:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417CC" id="P70004970270000000000000000417CC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417CD" id="P70004970270000000000000000417CD">
4003fa:7402		je	4003fe
4003fc:ffd0		callq	*%rax
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417CE" id="P70004970270000000000000000417CE"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417CF" id="P70004970270000000000000000417CF"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000035CB" epub:type="pagebreak" id="P70004970270000000000000000035CB" title="331"></span>The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417D0" id="P70004970270000000000000000417D0">je</code> instruction has as its target <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417D1" id="P70004970270000000000000000417D1">0x0x400431</code> – 12 (since <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417D2" id="P70004970270000000000000000417D2">0xf4</code> is the 1-byte two's-complement representation of – 12). As the original disassembled code shows, this is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417D3" id="P70004970270000000000000000417D3">0x400425:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417D4" id="P70004970270000000000000000417D4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417D5" id="P70004970270000000000000000417D5">
40042f:74f4		je	400425
400431: 5d		pop	%rbp
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417D6" id="P70004970270000000000000000417D6"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417D7" id="P70004970270000000000000000417D7">According to the annotation produced by the disassembler, the jump target is at absolute address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417D8" id="P70004970270000000000000000417D8">0x400547</code>. According to the byte encoding, this must be at an address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417D9" id="P70004970270000000000000000417D9">0x2</code> bytes beyond that of the pop instruction. Subtracting these gives address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417DA" id="P70004970270000000000000000417DA">0x400545</code>. Noting that the encoding of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417DB" id="P70004970270000000000000000417DB">ja</code> instruction requires 2 bytes, it must be located at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417DC" id="P70004970270000000000000000417DC">0x400543</code>. These are confirmed by examining the original disassembly:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417DD" id="P70004970270000000000000000417DD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417DE" id="P70004970270000000000000000417DE">
400543:77 02	ja	400547
400545: 5d	pop	%rbp
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417DF" id="P70004970270000000000000000417DF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417E0" id="P70004970270000000000000000417E0">Reading the bytes in reverse order, we can see that the target offset is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417E1" id="P70004970270000000000000000417E1">0xffffff73</code>, or decimal -141. Adding this to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417E2" id="P70004970270000000000000000417E2">0x0x4005ed</code> (the address of the nop instruction) gives address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417E3" id="P70004970270000000000000000417E3">0x400560:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417E4" id="P70004970270000000000000000417E4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417E5" id="P70004970270000000000000000417E5">
4005e8: e9 73 ff ff ff	jmpq	400560
4005ed:90		nop
</code></pre>
</li></ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000035E2" id="P70004970270000000000000000035E2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417E6" epub:type="title" id="P70004970270000000000000000417E6"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000254C"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.16 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000254B">212</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417E7" id="P70004970270000000000000000417E7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417E8" id="P70004970270000000000000000417E8"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417E9" id="P70004970270000000000000000417E9">Annotating assembly code and writing C code that mimics its control flow are good first steps in understanding assembly-language programs. This problem gives you practice for an example with simple control flow. It also gives you a chance to examine the implementation of logical operations.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000417EA" id="P70004970270000000000000000417EA">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417EB" id="P70004970270000000000000000417EB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417EC" id="P70004970270000000000000000417EC">Here is the C code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417ED" id="P70004970270000000000000000417ED"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417EE" id="P70004970270000000000000000417EE">
void goto_cond(long a, long *p) {
	if (p == 0)
	  goto done;
	if (*p &gt;= a)
	  goto done;
	*p = a;
done:
	return;
}
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417EF" id="P70004970270000000000000000417EF"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417F0" id="P70004970270000000000000000417F0">The first conditional branch is part of the implementation of the &amp;&amp; expression. If the test for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417F1" id="P70004970270000000000000000417F1">p</code> being non-null fails, the code will skip the test of a &gt; *p.</p></li>
</ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000035EF" id="P70004970270000000000000000035EF"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417F2" epub:type="title" id="P70004970270000000000000000417F2"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000255C"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.17 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000254B">212</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417F3" id="P70004970270000000000000000417F3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417F4" id="P70004970270000000000000000417F4"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417F5" id="P70004970270000000000000000417F5">This is an exercise to help you think about the idea of a general translation rule and how to apply it.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P70004970270000000000000000417F6" id="P70004970270000000000000000417F6">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417F7" id="P70004970270000000000000000417F7"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417F8" id="P70004970270000000000000000417F8">Converting to this alternate form involves only switching around a few lines of the code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417F9" id="P70004970270000000000000000417F9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417FA" id="P70004970270000000000000000417FA">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000035F9" epub:type="pagebreak" id="P70004970270000000000000000035F9" title="332"></span>long gotodiff_se_alt(long x, long y) {
	long result;
	if (x &lt; y)
	  goto x_lt_y;
	ge_cnt++;
	result = x - y;
	return result;
x_lt_y:
	lt_cnt++;
	result = y - x;
	return result;
}
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417FB" id="P70004970270000000000000000417FB"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417FC" id="P70004970270000000000000000417FC">In most respects, the choice is arbitrary. But the original rule works better for the common case where there is no else statement. For this case, we can simply modify the translation rule to be as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P70004970270000000000000000417FD" id="P70004970270000000000000000417FD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000417FE" id="P70004970270000000000000000417FE">
	t = <i class="pcalibre17 pcalibre2 pcalibre1">test-expr</i>;
	if (!t)
	  goto done;
<i class="pcalibre17 pcalibre2 pcalibre1">then-statement</i>
done:
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P70004970270000000000000000417FF" id="P70004970270000000000000000417FF">A translation based on the alternate rule is more cumbersome.</p>
</li></ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P70004970270000000000000000035FF" id="P70004970270000000000000000035FF"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041800" epub:type="title" id="P7000497027000000000000000041800"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000256C"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.18 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_000.xhtml#P7000497027000000000000000002568">213</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041801" id="P7000497027000000000000000041801">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041802" id="P7000497027000000000000000041802"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041803" id="P7000497027000000000000000041803">This problem requires that you work through a nested branch structure, where you will see how our rule for translating <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041804" id="P7000497027000000000000000041804">if</code> statements has been applied. On the whole, the machine code is a straightforward translation of the C code.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041805" id="P7000497027000000000000000041805"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041806" id="P7000497027000000000000000041806">
long test(long x, long y, long z) {
	long val = x+y+z;
	if (x &lt; -3) {
	  if (y &lt; z)
	  	val = x*y;
	  else
	  	val = y*z;
	} else if (x &gt; 2)
	  val = x*z;
	return val;
}
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003607" id="P7000497027000000000000000003607"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041807" epub:type="title" id="P7000497027000000000000000041807"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P70004970270000000000000000025A8"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.19 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_000.xhtml#P70004970270000000000000000025A5">216</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041808" id="P7000497027000000000000000041808">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041809" id="P7000497027000000000000000041809"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004180A" id="P700049702700000000000000004180A">This problem reinforces our method of computing the misprediction penalty.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P700049702700000000000000004180B" id="P700049702700000000000000004180B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004180C" id="P700049702700000000000000004180C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004180D" id="P700049702700000000000000004180D">We can apply our formula directly to get <var class="pcalibre17 pcalibre2 pcalibre1">T</var><sub class="pcalibre1 pcalibre2 calibre14">MP</sub> = 2(31 – 16) = 30.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004180E" id="P700049702700000000000000004180E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004180F" id="P700049702700000000000000004180F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003611" epub:type="pagebreak" id="P7000497027000000000000000003611" title="333"></span>When misprediction occurs, the function will require around <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-neweq3.png" altimg-height="16" altimg-width="108" alttext="" data-uri="" display="inline"><m:mrow><m:mn>16</m:mn><m:mo>+</m:mo><m:mn>30</m:mn><m:mo>=</m:mo><m:mn>46</m:mn></m:mrow></m:math></span> cycles.</p></li>
</ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003612" id="P7000497027000000000000000003612"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041810" epub:type="title" id="P7000497027000000000000000041810"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P700049702700000000000000000263D"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.20 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P700049702700000000000000000263F">219</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041811" id="P7000497027000000000000000041811">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041812" id="P7000497027000000000000000041812"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041813" id="P7000497027000000000000000041813">This problem provides a chance to study the use of conditional moves.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041814" id="P7000497027000000000000000041814">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041815" id="P7000497027000000000000000041815"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041816" id="P7000497027000000000000000041816">The operator is `/'. We see this is an example of dividing by a power of 3 by right shifting (see <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000000CB3_split_001.xhtml#P7000497027000000000000000000FF6"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">2.3.7</span></a>). Before shifting by <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-neweq4.png" altimg-height="15" altimg-width="42" alttext="" data-uri="" display="inline"><m:mrow><m:mi>k</m:mi><m:mo>=</m:mo><m:mn>3</m:mn></m:mrow></m:math></span>, we must add a bias of <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-neweq5.png" altimg-height="18" altimg-width="86" alttext="" data-uri="" display="inline"><m:mrow><m:msup><m:mn>2</m:mn><m:mi>k</m:mi></m:msup><m:mo>−</m:mo><m:mn>1</m:mn><m:mo>=</m:mo><m:mn>7</m:mn></m:mrow></m:math></span> when the dividend is negative.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041817" id="P7000497027000000000000000041817"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041818" id="P7000497027000000000000000041818">Here is an annotated version of the assembly code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041819" id="P7000497027000000000000000041819"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004181A" id="P700049702700000000000000004181A">
	<i class="pcalibre17 pcalibre2 pcalibre1">long arith(long x)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x in %rdi</i>
arith:
  leaq	7(%rdi), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">temp = x+7</i>
  testq	%rdi, %rdi	<i class="pcalibre17 pcalibre2 pcalibre1">Text x</i>
  cmovns	%rdi, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">If x&gt;= 0, temp = x</i>
  sarq	$3, %rax	<i class="pcalibre17 pcalibre2 pcalibre1">result = temp &gt;&gt; 3 (= x/8)</i>
  ret
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004181B" id="P700049702700000000000000004181B">The program creates a temporary value equal to <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-neweq6.png" altimg-height="16" altimg-width="46" alttext="" data-uri="" display="inline"><m:mrow><m:mi>x</m:mi><m:mo>+</m:mo><m:mn>7</m:mn></m:mrow></m:math></span>, in anticipation of <var class="pcalibre17 pcalibre2 pcalibre1">x</var> being negative and therefore requiring biasing. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004181C" id="P700049702700000000000000004181C">cmovns</code> instruction conditionally changes this number to <var class="pcalibre17 pcalibre2 pcalibre1">x</var> when <span class="pcalibre1 inlineequation pcalibre2"><m:math altimg="../images/ch03-neweq7.png" altimg-height="17" altimg-width="27" alttext="" data-uri="" display="inline"><m:mrow><m:mi>x</m:mi><m:mo>≥</m:mo><m:mn>0</m:mn></m:mrow></m:math></span>, and then it is shifted by 3 to generate <var class="pcalibre17 pcalibre2 pcalibre1">x</var>/8.</p>
</li></ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003620" id="P7000497027000000000000000003620"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004181D" epub:type="title" id="P700049702700000000000000004181D"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002651"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.21 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P700049702700000000000000000263F">219</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004181E" id="P700049702700000000000000004181E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004181F" id="P700049702700000000000000004181F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041820" id="P7000497027000000000000000041820">This problem is similar to <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000256C"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.18</span></a>, except that some of the conditionals have been implemented by conditional data transfers. Although it might seem daunting to fit this code into the framework of the original C code, you will find that it follows the translation rules fairly closely.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041821" id="P7000497027000000000000000041821"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041822" id="P7000497027000000000000000041822">
long test(long x, long y) {
	long val = 8*x;
	if (y &gt; 0) {
	  if (x &lt; y)
	  	val = y-x;
	  else
	  	val = x&amp;y;
	} else if (y &lt;= -2)
	  val = x+y;
	return val;
}
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003627" id="P7000497027000000000000000003627"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041823" epub:type="title" id="P7000497027000000000000000041823"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002683"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.22 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002674">221</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041824" id="P7000497027000000000000000041824">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041825" id="P7000497027000000000000000041825"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041826" id="P7000497027000000000000000041826">If we build up a table of factorials computed with data type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041827" id="P7000497027000000000000000041827">int</code>, we get the following:</p>
<table class="pcalibre1 informaltable pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041828" id="P7000497027000000000000000041828">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P7000497027000000000000000041829" id="P7000497027000000000000000041829"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P700049702700000000000000000362F" epub:type="pagebreak" id="P700049702700000000000000000362F" title="334"></span><var class="pcalibre17 pcalibre2 pcalibre1">n</var></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004182A" id="P700049702700000000000000004182A"><var class="pcalibre17 pcalibre2 pcalibre1">n</var>!</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter03.xhtml#P700049702700000000000000004182B" id="P700049702700000000000000004182B">OK?</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004182C" id="P700049702700000000000000004182C">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004182D" id="P700049702700000000000000004182D">1</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004182E" id="P700049702700000000000000004182E">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004182F" id="P700049702700000000000000004182F">2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041830" id="P7000497027000000000000000041830">2</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041831" id="P7000497027000000000000000041831">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041832" id="P7000497027000000000000000041832">3</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041833" id="P7000497027000000000000000041833">6</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041834" id="P7000497027000000000000000041834">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041835" id="P7000497027000000000000000041835">4</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041836" id="P7000497027000000000000000041836">24</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041837" id="P7000497027000000000000000041837">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041838" id="P7000497027000000000000000041838">5</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041839" id="P7000497027000000000000000041839">120</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004183A" id="P700049702700000000000000004183A">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004183B" id="P700049702700000000000000004183B">6</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004183C" id="P700049702700000000000000004183C">720</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004183D" id="P700049702700000000000000004183D">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004183E" id="P700049702700000000000000004183E">7</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004183F" id="P700049702700000000000000004183F">5,040</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041840" id="P7000497027000000000000000041840">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041841" id="P7000497027000000000000000041841">8</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041842" id="P7000497027000000000000000041842">40,320</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041843" id="P7000497027000000000000000041843">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041844" id="P7000497027000000000000000041844">9</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041845" id="P7000497027000000000000000041845">362,880</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041846" id="P7000497027000000000000000041846">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041847" id="P7000497027000000000000000041847">10</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041848" id="P7000497027000000000000000041848">3,628,800</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041849" id="P7000497027000000000000000041849">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004184A" id="P700049702700000000000000004184A">11</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004184B" id="P700049702700000000000000004184B">39,916,800</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004184C" id="P700049702700000000000000004184C">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004184D" id="P700049702700000000000000004184D">12</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004184E" id="P700049702700000000000000004184E">479,001,600</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P700049702700000000000000004184F" id="P700049702700000000000000004184F">Y</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041850" id="P7000497027000000000000000041850">13</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041851" id="P7000497027000000000000000041851">1,932,053,504</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter03.xhtml#P7000497027000000000000000041852" id="P7000497027000000000000000041852">N</td>
</tr>
</tbody>
</table>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041853" id="P7000497027000000000000000041853">We can see that the computation of 13! has overflowed. As we learned in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000000CB3_split_001.xhtml#P7000497027000000000000000000F42"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">2.35</span></a>, when we get value <var class="pcalibre17 pcalibre2 pcalibre1">x</var> while attempting to compute <var class="pcalibre17 pcalibre2 pcalibre1">n</var>!, we can test for overflow by computing <i class="pcalibre17 pcalibre2 pcalibre1">x/n</i> and seeing whether it equals (<var class="pcalibre17 pcalibre2 pcalibre1">n</var> - 1)! (assuming that we have already ensured that the computation of (<var class="pcalibre17 pcalibre2 pcalibre1">n</var> - 1) !did not overflow). In this case we get 1,932,053,504/13 = 161,004,458.667. As a second test, we can see that any factorial beyond 10! must be a multiple of 100 and therefore have zeros for the last two digits. The correct value of 13! is 6,227,020,800.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041854" id="P7000497027000000000000000041854"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter03.xhtml#P7000497027000000000000000041855" id="P7000497027000000000000000041855">Doing the computation with data type long lets us go up to 20!, yielding 2,432,902,008,176,640,000.</p></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000365C" id="P700049702700000000000000000365C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041856" epub:type="title" id="P7000497027000000000000000041856"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P70004970270000000000000000026A1"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.23 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002693">222</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041857" id="P7000497027000000000000000041857">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041858" id="P7000497027000000000000000041858"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041859" id="P7000497027000000000000000041859">The code generated when compiling loops can be tricky to analyze, because the compiler can perform many different optimizations on loop code, and because it can be difficult to match program variables with registers. This particular example demonstrates several places where the assembly code is not just a direct translation of the C code.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P700049702700000000000000004185A" id="P700049702700000000000000004185A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004185B" id="P700049702700000000000000004185B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004185C" id="P700049702700000000000000004185C">Although parameter <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004185D" id="P700049702700000000000000004185D">x</code> is passed to the function in register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004185E" id="P700049702700000000000000004185E">%rdi</code>, we can see that the register is never referenced once the loop is entered. Instead, we can see that registers <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004185F" id="P700049702700000000000000004185F">%rax, %rcx</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041860" id="P7000497027000000000000000041860">%rdx</code> are initialized in lines 2–5 to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041861" id="P7000497027000000000000000041861">x, x*x</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041862" id="P7000497027000000000000000041862">x+x</code>. We can conclude, therefore, that these registers contain the program variables.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041863" id="P7000497027000000000000000041863"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041864" id="P7000497027000000000000000041864">The compiler determines that pointer <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041865" id="P7000497027000000000000000041865">p</code> always points to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041866" id="P7000497027000000000000000041866">x</code>, and hence the expression (*<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041867" id="P7000497027000000000000000041867">p</code>)++ simply increments <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041868" id="P7000497027000000000000000041868">x</code>. It combines this incrementing by 1 with the increment by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041869" id="P7000497027000000000000000041869">y</code>, via the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004186A" id="P700049702700000000000000004186A">leaq</code> instruction of line 7.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004186B" id="P700049702700000000000000004186B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004186C" id="P700049702700000000000000004186C">The annotated code is as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004186D" id="P700049702700000000000000004186D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004186E" id="P700049702700000000000000004186E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003676" epub:type="pagebreak" id="P7000497027000000000000000003676" title="335"></span>	<i class="pcalibre17 pcalibre2 pcalibre1">long dw_loop(long x)</i>
	<i class="pcalibre17 pcalibre2 pcalibre1">x initially in %rdi</i>
1	dw_loop:
2	movq	%rdi, %rax		<i class="pcalibre17 pcalibre2 pcalibre1">Copy x to %rax</i>
3	movq	%rdi, %rcx
4	imulq	%rdi, %rcx		<i class="pcalibre17 pcalibre2 pcalibre1">Compute y = x*x</i>
5	leaq	(%rdi,%rdi), %rdx	<i class="pcalibre17 pcalibre2 pcalibre1">Compute n = 2*x</i>
6	.L2:			    <b class="pcalibre1 pcalibre2 pcalibre12">loop:</b>
7	leaq	1(%rcx,%rax), %rax	<i class="pcalibre17 pcalibre2 pcalibre1">Compute x += y + 1</i>
8	subq $1, %rdx			<i class="pcalibre17 pcalibre2 pcalibre1">Decrement n</i>
9	testq	%rdx, %rdx		<i class="pcalibre17 pcalibre2 pcalibre1">Test n</i>
10	jg	.L2			<i class="pcalibre17 pcalibre2 pcalibre1">If &gt; 0, goto</i> <b class="pcalibre1 pcalibre2 pcalibre12">loop</b>
11	rep;	ret			<i class="pcalibre17 pcalibre2 pcalibre1">Return</i>
</code></pre>
</li></ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003677" id="P7000497027000000000000000003677"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004186F" epub:type="title" id="P700049702700000000000000004186F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P70004970270000000000000000026E2"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.24 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P70004970270000000000000000026C9">224</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041870" id="P7000497027000000000000000041870">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041871" id="P7000497027000000000000000041871"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041872" id="P7000497027000000000000000041872">This assembly code is a fairly straightforward translation of the loop using the jump-to-middle method. The full C code is as follows:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041873" id="P7000497027000000000000000041873"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041874" id="P7000497027000000000000000041874">
long loop_while(long a, long b)
{
	long result = 1;
	while (a &lt; b) {
	  result = result * (a+b);
	  a = a+1;
	}
	return result;
}
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000367E" id="P700049702700000000000000000367E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041875" epub:type="title" id="P7000497027000000000000000041875"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P70004970270000000000000000026FF"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.25 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P70004970270000000000000000026FC">226</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041876" id="P7000497027000000000000000041876">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041877" id="P7000497027000000000000000041877"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041878" id="P7000497027000000000000000041878">While the generated code does not follow the exact pattern of the guarded-do translation, we can see that it is equivalent to the following C code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041879" id="P7000497027000000000000000041879"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004187A" id="P700049702700000000000000004187A">
long loop_while2(long a, long b)
{
	long result = b;
	while (b &gt; 0) {
	  result = result * a;
	  b = b-a;
	}
	return result;
}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004187B" id="P700049702700000000000000004187B">We will often see cases, especially when compiling with higher levels of optimization, where <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>takes some liberties in the exact form of the code it generates, while preserving the required functionality.</p>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003686" id="P7000497027000000000000000003686"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004187C" epub:type="title" id="P700049702700000000000000004187C"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P7000497027000000000000000003688" epub:type="pagebreak" id="P7000497027000000000000000003688" title="336"></span><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002720"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.26 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P700049702700000000000000000271F">228</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004187D" id="P700049702700000000000000004187D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004187E" id="P700049702700000000000000004187E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004187F" id="P700049702700000000000000004187F">Being able to work backward from assembly code to C code is a prime example of reverse engineering.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041880" id="P7000497027000000000000000041880">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041881" id="P7000497027000000000000000041881"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041882" id="P7000497027000000000000000041882">We can see that the code uses the jump-to-middle translation, using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041883" id="P7000497027000000000000000041883">jmp</code> instruction on line 3.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041884" id="P7000497027000000000000000041884"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041885" id="P7000497027000000000000000041885">Here is the original C code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041886" id="P7000497027000000000000000041886"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041887" id="P7000497027000000000000000041887">
long fun_a(unsigned long x) {
	long val = 0;
	while (x) {
	  val ^= x;
	  x &gt;&gt;= 1;
	}
	return val &amp; 0x1;
}
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041888" id="P7000497027000000000000000041888"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041889" id="P7000497027000000000000000041889">This code computes the <i class="pcalibre17 pcalibre2 pcalibre1">parity</i> of argument <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004188A" id="P700049702700000000000000004188A">x</code>. That is, it returns 1 if there is an odd number of ones in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004188B" id="P700049702700000000000000004188B">x</code> and 0 if there is an even number.</p></li>
</ol></li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P7000497027000000000000000003698" id="P7000497027000000000000000003698"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004188C" epub:type="title" id="P700049702700000000000000004188C"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002762"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.27 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P700049702700000000000000000275E">231</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004188D" id="P700049702700000000000000004188D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004188E" id="P700049702700000000000000004188E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004188F" id="P700049702700000000000000004188F">This exercise is intended to reinforce your understanding of how loops are implemented.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041890" id="P7000497027000000000000000041890"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041891" id="P7000497027000000000000000041891">
long fact_for_gd_goto(long n)
{
	long i = 2;
	long result = 1;
	if (n &lt;= 1)
	  goto done;
loop:
	result *= i;
	i++;
	if (i &lt;= n)
	  goto loop;
done:
	return result;
}
</code></pre>
</li></ul>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter03.xhtml#P700049702700000000000000000369F" id="P700049702700000000000000000369F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041892" epub:type="title" id="P7000497027000000000000000041892"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P700049702700000000000000000276D"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.28 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000002339_split_001.xhtml#P700049702700000000000000000275E">231</a>)</h1></header>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P7000497027000000000000000041893" id="P7000497027000000000000000041893">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041894" id="P7000497027000000000000000041894"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041895" id="P7000497027000000000000000041895">This problem is trickier than <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_001.xhtml#P7000497027000000000000000002720"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">3.26</span></a>, since the code within the loop is more complex and the overall operation is less familiar.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter03.xhtml#P7000497027000000000000000041896" id="P7000497027000000000000000041896">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041897" id="P7000497027000000000000000041897"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P7000497027000000000000000041898" id="P7000497027000000000000000041898">Here is the original C code:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P7000497027000000000000000041899" id="P7000497027000000000000000041899"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004189A" id="P700049702700000000000000004189A">
long fun_b(unsigned long x) {
	long val = 0;
	long i;
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter03.xhtml#P70004970270000000000000000036A9" epub:type="pagebreak" id="P70004970270000000000000000036A9" title="337"></span>	for (i = 64; i != 0; i–) {
	  val = (val &lt;&lt; 1) | (x &amp; 0x1);
	  x &gt;&gt;= 1;
	}
	return val;
}
</code></pre>
</li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004189B" id="P700049702700000000000000004189B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004189C" id="P700049702700000000000000004189C">The code was generated using the guarded-do transformation, but the compiler detected that, since <var class="pcalibre17 pcalibre2 pcalibre1">i</var> is initialized to 64, it will satisfy the test <var class="pcalibre17 pcalibre2 pcalibre1">i</var> ≠ 0, and therefore the initial test is not required.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter03.xhtml#P700049702700000000000000004189D" id="P700049702700000000000000004189D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter03.xhtml#P700049702700000000000000004189E" id="P700049702700000000000000004189E">This code reverses the bits in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P700049702700000000000000004189F" id="P700049702700000000000000004189F">x</code>, creating a mirror image. It does this by shifting the bits of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000418A0" id="P70004970270000000000000000418A0">x</code> from left to right, and then filling these bits in as it shifts <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter03.xhtml#P70004970270000000000000000418A1" id="P70004970270000000000000000418A1">val</code> from right to left.</p></li>
</ol></li></ul>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Chapter 5 Optimizing Program Performance</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="chapter" id="P7000497027000000000000000004893"><header class="pcalibre1 pcalibre2 pcalibre48"><h1 class="pcalibre1 pcalibre2 pcalibre49" data-uri="chapter05.xhtml#P7000497027000000000000000042FE6" epub:type="title" id="P7000497027000000000000000042FE6"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter05.xhtml#P7000497027000000000000000004895" epub:type="pagebreak" id="P7000497027000000000000000004895" title="495"></span><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre50 pcalibre2">5 </span>Optimizing Program Performance</h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" id="d9e105665">
<nav class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter05.xhtml#P7000497027000000000000000042FE7" epub:type="toc" id="P7000497027000000000000000042FE7">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter05.xhtml#P7000497027000000000000000042FE8" id="P7000497027000000000000000042FE8">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000042FE9" id="P7000497027000000000000000042FE9">
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FEA" id="P7000497027000000000000000042FEA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FEB" id="P7000497027000000000000000042FEB"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000048D0.xhtml#P70004970270000000000000000048D0"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.1 </span>Capabilities and Limitations of Optimizing Compilers </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">498</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FEC" id="P7000497027000000000000000042FEC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FED" id="P7000497027000000000000000042FED"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000493B.xhtml#P700049702700000000000000000493B"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.2 </span>Expressing Program Performance </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">502</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FEE" id="P7000497027000000000000000042FEE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FEF" id="P7000497027000000000000000042FEF"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000496E.xhtml#P700049702700000000000000000496E"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.3 </span>Program Example </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">504</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FF0" id="P7000497027000000000000000042FF0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FF1" id="P7000497027000000000000000042FF1"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000049CE.xhtml#P70004970270000000000000000049CE"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.4 </span>Eliminating Loop Inefficiencies </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">508</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FF2" id="P7000497027000000000000000042FF2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FF3" id="P7000497027000000000000000042FF3"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004A83.xhtml#P7000497027000000000000000004A83"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.5 </span>Reducing Procedure Calls </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">512</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FF4" id="P7000497027000000000000000042FF4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FF5" id="P7000497027000000000000000042FF5"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004AB6.xhtml#P7000497027000000000000000004AB6"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.6 </span>Eliminating Unneeded Memory References </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">514</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FF6" id="P7000497027000000000000000042FF6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FF7" id="P7000497027000000000000000042FF7"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004B6C.xhtml#P7000497027000000000000000004B6C"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.7 </span>Understanding Modern Processors </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">517</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FF8" id="P7000497027000000000000000042FF8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FF9" id="P7000497027000000000000000042FF9"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004C94.xhtml#P7000497027000000000000000004C94"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.8 </span>Loop Unrolling </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">531</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FFA" id="P7000497027000000000000000042FFA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FFB" id="P7000497027000000000000000042FFB"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004D16.xhtml#P7000497027000000000000000004D16"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.9 </span>Enhancing Parallelism </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">536</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FFC" id="P7000497027000000000000000042FFC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FFD" id="P7000497027000000000000000042FFD"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004E68.xhtml#P7000497027000000000000000004E68"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.10 </span>Summary of Results for Optimizing Combining Code </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">547</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000042FFE" id="P7000497027000000000000000042FFE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000042FFF" id="P7000497027000000000000000042FFF"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004E9A.xhtml#P7000497027000000000000000004E9A"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.11 </span>Some Limiting Factors </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">548</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000043000" id="P7000497027000000000000000043000"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000043001" id="P7000497027000000000000000043001"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004F49.xhtml#P7000497027000000000000000004F49"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.12 </span>Understanding Memory Performance </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">553</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000043002" id="P7000497027000000000000000043002"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000043003" id="P7000497027000000000000000043003"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000004FF4.xhtml#P7000497027000000000000000004FF4"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.13 </span>Life in the Real World: Performance Improvement Techniques </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">561</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter05.xhtml#P7000497027000000000000000043004" id="P7000497027000000000000000043004"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000043005" id="P7000497027000000000000000043005"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000500C.xhtml#P700049702700000000000000000500C"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.14 </span>Identifying and Eliminating Performance Bottlenecks </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">562</span></a></p></li>
</ol></div>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter05.xhtml#P7000497027000000000000000043006" id="P7000497027000000000000000043006">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043007" id="P7000497027000000000000000043007">
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter05.xhtml#P7000497027000000000000000043008" id="P7000497027000000000000000043008"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P7000497027000000000000000043009" id="P7000497027000000000000000043009"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000005082.xhtml#P7000497027000000000000000005082"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">5.15 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary</span> </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">568</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter05.xhtml#P700049702700000000000000004300A" id="P700049702700000000000000004300A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P700049702700000000000000004300B" id="P700049702700000000000000004300B"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000508A.xhtml#P700049702700000000000000000508A"><span class="pcalibre1 pcalibre2" epub:type="title">Bibliographic Notes </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">569</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter05.xhtml#P700049702700000000000000004300C" id="P700049702700000000000000004300C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P700049702700000000000000004300D" id="P700049702700000000000000004300D"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000005090.xhtml#P7000497027000000000000000005090"><span class="pcalibre1 pcalibre2" epub:type="title">Homework Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">570</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter05.xhtml#P700049702700000000000000004300E" id="P700049702700000000000000004300E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter05.xhtml#P700049702700000000000000004300F" id="P700049702700000000000000004300F"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000050E4.xhtml#P70004970270000000000000000050E4"><span class="pcalibre1 pcalibre2" epub:type="title">Solutions to Practice Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">573</span></a></p></li>
</ol>
</div>
</nav>
<section class="pcalibre1 pcalibre2 pcalibre51" data-uri="chapter05.xhtml#P7000497027000000000000000043010" epub:type="introduction" id="P7000497027000000000000000043010">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043011" id="P7000497027000000000000000043011"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter05.xhtml#P70004970270000000000000000048C1" epub:type="pagebreak" id="P70004970270000000000000000048C1" title="496"></span>The primary objective in writing a program must be to make it work correctly under all possible conditions. A program that runs fast but gives incorrect results serves no useful purpose. Programmers must write clear and concise code, not only so that they can make sense of it, but also so that others can read and understand the code during code reviews and when modifications are required later.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043012" id="P7000497027000000000000000043012">On the other hand, there are many occasions when making a program run fast is also an important consideration. If a program must process video frames or network packets in real time, then a slow-running program will not provide the needed functionality. When a computational task is so demanding that it requires days or weeks to execute, then making it run just 20% faster can have significant impact. In this chapter, we will explore how to make programs run faster via several different types of program optimization.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043013" id="P7000497027000000000000000043013">Writing an efficient program requires several types of activities. First, we must select an appropriate set of algorithms and data structures. Second, we must write source code that the compiler can effectively optimize to turn into efficient executable code. For this second part, it is important to understand the capabilities and limitations of optimizing compilers. Seemingly minor changes in how a program is written can make large differences in how well a compiler can optimize it. Some programming languages are more easily optimized than others. Some features of C, such as the ability to perform pointer arithmetic and casting, make it challenging for a compiler to optimize. Programmers can often write their programs in ways that make it easier for compilers to generate efficient code. A third technique for dealing with especially demanding computations is to divide a task into portions that can be computed in parallel, on some combination of multiple cores and multiple processors. We will defer this aspect of performance enhancement to <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000008060.xhtml#P7000497027000000000000000008060"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">12</span></a>. Even when exploiting parallelism, it is important that each parallel thread execute with maximum performance, and so the material of this chapter remains relevant in any case.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043014" id="P7000497027000000000000000043014">In approaching program development and optimization, we must consider how the code will be used and what critical factors affect it. In general, programmers must make a trade-off between how easy a program is to implement and maintain, and how fast it runs. At an algorithmic level, a simple insertion sort can be programmed in a matter of minutes, whereas a highly efficient sort routine may take a day or more to implement and optimize. At the coding level, many low-level optimizations tend to reduce code readability and modularity, making the programs more susceptible to bugs and more difficult to modify or extend. For code that will be executed repeatedly in a performance-critical environment, extensive optimization may be appropriate. One challenge is to maintain some degree of elegance and readability in the code despite extensive transformations.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043015" id="P7000497027000000000000000043015">We describe a number of techniques for improving code performance. Ideally, a compiler would be able to take whatever code we write and generate the most efficient possible machine-level program having the specified behavior. Modern compilers employ sophisticated forms of analysis and optimization, and they keep getting better. Even the best compilers, however, can be thwarted by <i class="pcalibre17 pcalibre2 pcalibre1">optimization blockers</i>—aspects of the program's behavior that depend strongly on the execution <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter05.xhtml#P70004970270000000000000000048C6" epub:type="pagebreak" id="P70004970270000000000000000048C6" title="497"></span>environment. Programmers must assist the compiler by writing code that can be optimized readily.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043016" id="P7000497027000000000000000043016">The first step in optimizing a program is to eliminate unnecessary work, making the code perform its intended task as efficiently as possible. This includes eliminating unnecessary function calls, conditional tests, and memory references. These optimizations do not depend on any specific properties of the target machine.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043017" id="P7000497027000000000000000043017">To maximize the performance of a program, both the programmer and the compiler require a model of the target machine, specifying how instructions are processed and the timing characteristics of the different operations. For example, the compiler must know timing information to be able to decide whether it should use a multiply instruction or some combination of shifts and adds. Modern computers use sophisticated techniques to process a machine-level program, executing many instructions in parallel and possibly in a different order than they appear in the program. Programmers must understand how these processors work to be able to tune their programs for maximum speed. We present a high-level model of such a machine based on recent designs of Intel and AMD processors. We also devise a graphical <i class="pcalibre17 pcalibre2 pcalibre1">data-flow</i> notation to visualize the execution of instructions by the processor, with which we can predict program performance.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043018" id="P7000497027000000000000000043018">With this understanding of processor operation, we can take a second step in program optimization, exploiting the capability of processors to provide <i class="pcalibre17 pcalibre2 pcalibre1">instruction-level parallelism</i>, executing multiple instructions simultaneously. We cover several program transformations that reduce the data dependencies between different parts of a computation, increasing the degree of parallelism with which they can be executed.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P7000497027000000000000000043019" id="P7000497027000000000000000043019">We conclude the chapter by discussing issues related to optimizing large programs. We describe the use of code <i class="pcalibre17 pcalibre2 pcalibre1">profilers</i>—tools that measure the performance of different parts of a program. This analysis can help find inefficiencies in the code and identify the parts of the program on which we should focus our optimization efforts.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P700049702700000000000000004301A" id="P700049702700000000000000004301A">In this presentation, we make code optimization look like a simple linear process of applying a series of transformations to the code in a particular order. In fact, the task is not nearly so straightforward. A fair amount of trial-and-error experimentation is required. This is especially true as we approach the later optimization stages, where seemingly small changes can cause major changes in performance and some very promising techniques prove ineffective. As we will see in the examples that follow, it can be difficult to explain exactly why a particular code sequence has a particular execution time. Performance can depend on many detailed features of the processor design for which we have relatively little documentation or understanding. This is another reason to try a number of different variations and combinations of techniques.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P700049702700000000000000004301B" id="P700049702700000000000000004301B">Studying the assembly-code representation of a program is one of the most effective means for gaining an understanding of the compiler and how the generated code will run. A good strategy is to start by looking carefully at the code for the inner loops, identifying performance-reducing attributes such as excessive memory references and poor use of registers. Starting with the assembly code, we <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter05.xhtml#P70004970270000000000000000048CD" epub:type="pagebreak" id="P70004970270000000000000000048CD" title="498"></span>can also predict what operations will be performed in parallel and how well they will use the processor resources. As we will see, we can often determine the time (or at least a lower bound on the time) required to execute a loop by identifying <i class="pcalibre17 pcalibre2 pcalibre1">critical paths</i>, chains of data dependencies that form during repeated executions of a loop. We can then go back and modify the source code to try to steer the compiler toward more efficient implementations.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P700049702700000000000000004301C" id="P700049702700000000000000004301C">Most major compilers, including <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>, are continually being updated and improved, especially in terms of their optimization abilities. One useful strategy is to do only as much rewriting of a program as is required to get it to the point where the compiler can then generate efficient code. By this means, we avoid compromising the readability, modularity, and portability of the code as much as if we had to work with a compiler of only minimal capabilities. Again, it helps to iteratively modify the code and analyze its performance both through measurements and by examining the generated assembly code.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter05.xhtml#P700049702700000000000000004301D" id="P700049702700000000000000004301D">To novice programmers, it might seem strange to keep modifying the source code in an attempt to coax the compiler into generating efficient code, but this is indeed how many high-performance programs are written. Compared to the alternative of writing code in assembly language, this indirect approach has the advantage that the resulting code will still run on other machines, although perhaps not with peak performance.</p>
</section>
</section>
<!--EOF:P70004970270000000000000000048D0-->
<!--EOF:P700049702700000000000000000493B-->
<!--EOF:P700049702700000000000000000496E-->
<!--EOF:P70004970270000000000000000049CE-->
<!--EOF:P7000497027000000000000000004A83-->
<!--EOF:P7000497027000000000000000004AB6-->
<!--EOF:P7000497027000000000000000004B6C-->
<!--EOF:P7000497027000000000000000004C94-->
<!--EOF:P7000497027000000000000000004D16-->
<!--EOF:P7000497027000000000000000004E68-->
<!--EOF:P7000497027000000000000000004E9A-->
<!--EOF:P7000497027000000000000000004F49-->
<!--EOF:P7000497027000000000000000004FF4-->
<!--EOF:P700049702700000000000000000500C-->
<!--EOF:P7000497027000000000000000005082-->
<!--EOF:P700049702700000000000000000508A-->
<!--EOF:P7000497027000000000000000005090-->
<!--EOF:P70004970270000000000000000050E4-->
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Chapter 12 Concurrent Programming</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="chapter" id="P7000497027000000000000000008060"><header class="pcalibre1 pcalibre2 pcalibre48"><h1 class="pcalibre1 pcalibre2 pcalibre49" data-uri="chapter12.xhtml#P7000497027000000000000000046B6B" epub:type="title" id="P7000497027000000000000000046B6B"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter12.xhtml#P7000497027000000000000000008062" epub:type="pagebreak" id="P7000497027000000000000000008062" title="971"></span><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre50 pcalibre2">12 </span>Concurrent Programming</h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" id="d9e172027">
<nav class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter12.xhtml#P7000497027000000000000000046B6C" epub:type="toc" id="P7000497027000000000000000046B6C">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter12.xhtml#P7000497027000000000000000046B6D" id="P7000497027000000000000000046B6D">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter12.xhtml#P7000497027000000000000000046B6E" id="P7000497027000000000000000046B6E">
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter12.xhtml#P7000497027000000000000000046B6F" id="P7000497027000000000000000046B6F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B70" id="P7000497027000000000000000046B70"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000008097.xhtml#P7000497027000000000000000008097"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">12.1 </span>Concurrent Programming with Processes </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">973</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter12.xhtml#P7000497027000000000000000046B71" id="P7000497027000000000000000046B71"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B72" id="P7000497027000000000000000046B72"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000080DE.xhtml#P70004970270000000000000000080DE"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">12.2 </span>Concurrent Programming with I/O Multiplexing </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">977</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter12.xhtml#P7000497027000000000000000046B73" id="P7000497027000000000000000046B73"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B74" id="P7000497027000000000000000046B74"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000817D.xhtml#P700049702700000000000000000817D"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">12.3 </span>Concurrent Programming with Threads </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">985</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter12.xhtml#P7000497027000000000000000046B75" id="P7000497027000000000000000046B75"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B76" id="P7000497027000000000000000046B76"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000821D.xhtml#P700049702700000000000000000821D"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">12.4 </span>Shared Variables in Threaded Programs </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">992</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter12.xhtml#P7000497027000000000000000046B77" id="P7000497027000000000000000046B77"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B78" id="P7000497027000000000000000046B78"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000827E.xhtml#P700049702700000000000000000827E"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">12.5 </span>Synchronizing Threads with Semaphores </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">995</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter12.xhtml#P7000497027000000000000000046B79" id="P7000497027000000000000000046B79"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B7A" id="P7000497027000000000000000046B7A"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000849B.xhtml#P700049702700000000000000000849B"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">12.6 </span>Using Threads for Parallelism </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">1013</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter12.xhtml#P7000497027000000000000000046B7B" id="P7000497027000000000000000046B7B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B7C" id="P7000497027000000000000000046B7C"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000008577.xhtml#P7000497027000000000000000008577"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">12.7 </span>Other Concurrency Issues </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">1020</span></a></p></li>
</ol></div>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter12.xhtml#P7000497027000000000000000046B7D" id="P7000497027000000000000000046B7D">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter12.xhtml#P7000497027000000000000000046B7E" id="P7000497027000000000000000046B7E">
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter12.xhtml#P7000497027000000000000000046B7F" id="P7000497027000000000000000046B7F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B80" id="P7000497027000000000000000046B80"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000008670.xhtml#P7000497027000000000000000008670"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">12.8 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary</span> </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">1030</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter12.xhtml#P7000497027000000000000000046B81" id="P7000497027000000000000000046B81"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B82" id="P7000497027000000000000000046B82"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000008676.xhtml#P7000497027000000000000000008676"><span class="pcalibre1 pcalibre2" epub:type="title">Bibliographic Notes </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">1030</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter12.xhtml#P7000497027000000000000000046B83" id="P7000497027000000000000000046B83"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B84" id="P7000497027000000000000000046B84"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000867A.xhtml#P700049702700000000000000000867A"><span class="pcalibre1 pcalibre2" epub:type="title">Homework Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">1031</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter12.xhtml#P7000497027000000000000000046B85" id="P7000497027000000000000000046B85"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B86" id="P7000497027000000000000000046B86"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000875E.xhtml#P700049702700000000000000000875E"><span class="pcalibre1 pcalibre2" epub:type="title">Solutions to Practice Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">1036</span></a></p></li>
</ol></div>
</nav>
<section class="pcalibre1 pcalibre2 pcalibre51" data-uri="chapter12.xhtml#P7000497027000000000000000046B87" epub:type="introduction" id="P7000497027000000000000000046B87">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter12.xhtml#P7000497027000000000000000046B88" id="P7000497027000000000000000046B88"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter12.xhtml#P7000497027000000000000000008080" epub:type="pagebreak" id="P7000497027000000000000000008080" title="972"></span>As we learned in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000666E.xhtml#P700049702700000000000000000666E"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">8</span></a>, logical control flows are <i class="pcalibre17 pcalibre2 pcalibre1">concurrent</i> if they overlap in time. This general phenomenon, known as <i class="pcalibre17 pcalibre2 pcalibre1">concurrency</i>, shows up at many different levels of a computer system. Hardware exception handlers, processes, and Linux signal handlers are all familiar examples.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter12.xhtml#P7000497027000000000000000046B89" id="P7000497027000000000000000046B89">Thus far, we have treated concurrency mainly as a mechanism that the operating system kernel uses to run multiple application programs. But concurrency is not just limited to the kernel. It can play an important role in application programs as well. For example, we have seen how Linux signal handlers allow applications to respond to asynchronous events such as the user typing Ctrl+C or the program accessing an undefined area of virtual memory. Application-level concurrency is useful in other ways as well:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter12.xhtml#P7000497027000000000000000046B8A" id="P7000497027000000000000000046B8A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter12.xhtml#P7000497027000000000000000046B8B" id="P7000497027000000000000000046B8B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B8C" id="P7000497027000000000000000046B8C"><span class="pcalibre1 pcalibre2 pcalibre41">Accessing slow I/O devices. </span>When an application is waiting for data to arrive from a slow I/O device such as a disk, the kernel keeps the CPU busy by running other processes. Individual applications can exploit concurrency in a similar way by overlapping useful work with I/O requests.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter12.xhtml#P7000497027000000000000000046B8D" id="P7000497027000000000000000046B8D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B8E" id="P7000497027000000000000000046B8E"><span class="pcalibre1 pcalibre2 pcalibre41">Interacting with humans. </span>People who interact with computers demand the ability to perform multiple tasks at the same time. For example, they might want to resize a window while they are printing a document. Modern windowing systems use concurrency to provide this capability. Each time the user requests some action (say, by clicking the mouse), a separate concurrent logical flow is created to perform the action.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter12.xhtml#P7000497027000000000000000046B8F" id="P7000497027000000000000000046B8F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B90" id="P7000497027000000000000000046B90"><span class="pcalibre1 pcalibre2 pcalibre41">Reducing latency by deferring work. </span>Sometimes, applications can use concurrency to reduce the latency of certain operations by deferring other operations and performing them concurrently. For example, a dynamic storage allocator might reduce the latency of individual free operations by deferring coalescing to a concurrent "coalescing" flow that runs at a lower priority, soaking up spare CPU cycles as they become available.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter12.xhtml#P7000497027000000000000000046B91" id="P7000497027000000000000000046B91"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B92" id="P7000497027000000000000000046B92"><span class="pcalibre1 pcalibre2 pcalibre41">Servicing multiple network clients. </span>The iterative network servers that we studied in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007B7A.xhtml#P7000497027000000000000000007B7A"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">11</span></a> are unrealistic because they can only service one client at a time. Thus, a single slow client can deny service to every other client. For a real server that might be expected to service hundreds or thousands of clients per second, it is not acceptable to allow one slow client to deny service to the others. A better approach is to build a <i class="pcalibre17 pcalibre2 pcalibre1">concurrent server</i> that creates a separate logical flow for each client. This allows the server to service multiple clients concurrently and precludes slow clients from monopolizing the server.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter12.xhtml#P7000497027000000000000000046B93" id="P7000497027000000000000000046B93"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B94" id="P7000497027000000000000000046B94"><span class="pcalibre1 pcalibre2 pcalibre41">Computing in parallel on multi-core machines. </span>Many modern systems are equipped with multi-core processors that contain multiple CPUs. Applications that are partitioned into concurrent flows often run faster on multi-core machines than on uniprocessor machines because the flows execute in parallel rather than being interleaved.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter12.xhtml#P7000497027000000000000000046B95" id="P7000497027000000000000000046B95">Applications that use application-level concurrency are known as <i class="pcalibre17 pcalibre2 pcalibre1">concurrent programs</i>. Modern operating systems provide three basic approaches for building concurrent programs:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter12.xhtml#P7000497027000000000000000046B96" id="P7000497027000000000000000046B96">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter12.xhtml#P7000497027000000000000000046B97" id="P7000497027000000000000000046B97"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B98" id="P7000497027000000000000000046B98"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter12.xhtml#P7000497027000000000000000008091" epub:type="pagebreak" id="P7000497027000000000000000008091" title="973"></span><span class="pcalibre1 pcalibre2 pcalibre41">Processes. </span>With this approach, each logical control flow is a process that is scheduled and maintained by the kernel. Since processes have separate virtual address spaces, flows that want to communicate with each other must use some kind of explicit <i class="pcalibre17 pcalibre2 pcalibre1">interprocess communication (IPC)</i> mechanism.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter12.xhtml#P7000497027000000000000000046B99" id="P7000497027000000000000000046B99"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B9A" id="P7000497027000000000000000046B9A"><span class="pcalibre1 pcalibre2 pcalibre41">I/O multiplexing. </span>his is a form of concurrent programming where applications explicitly schedule their own logical flows in the context of a single process. Logical flows are modeled as state machines that the main program explicitly transitions from state to state as a result of data arriving on file descriptors. Since the program is a single process, all flows share the same address space.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter12.xhtml#P7000497027000000000000000046B9B" id="P7000497027000000000000000046B9B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter12.xhtml#P7000497027000000000000000046B9C" id="P7000497027000000000000000046B9C"><span class="pcalibre1 pcalibre2 pcalibre41">Threads. </span>Threads are logical flows that run in the context of a single process and are scheduled by the kernel. You can think of threads as a hybrid of the other two approaches, scheduled by the kernel like process flows and sharing the same virtual address space like I/O multiplexing flows.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter12.xhtml#P7000497027000000000000000046B9D" id="P7000497027000000000000000046B9D">This chapter investigates these three different concurrent programming techniques. To keep our discussion concrete, we will work with the same motivating application throughout—a concurrent version of the iterative echo server from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000007CC1.xhtml#P7000497027000000000000000007E4C"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">11.4.9</span></a>.</p>
</section>
</section>
<!--EOF:P7000497027000000000000000008097-->
<!--EOF:P70004970270000000000000000080DE-->
<!--EOF:P700049702700000000000000000817D-->
<!--EOF:P700049702700000000000000000821D-->
<!--EOF:P700049702700000000000000000827E-->
<!--EOF:P700049702700000000000000000849B-->
<!--EOF:P7000497027000000000000000008577-->
<!--EOF:P7000497027000000000000000008670-->
<!--EOF:P7000497027000000000000000008676-->
<!--EOF:P700049702700000000000000000867A-->
<!--EOF:P700049702700000000000000000875E-->
</section></body></html>
