<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Chapter 7 Linking</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" epub:type="chapter" id="P7000497027000000000000000005FB4"><header class="pcalibre1 pcalibre2 pcalibre48"><h1 class="pcalibre1 pcalibre2 pcalibre49" data-uri="chapter07.xhtml#P700049702700000000000000004473E" epub:type="title" id="P700049702700000000000000004473E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000005FB6" epub:type="pagebreak" id="P7000497027000000000000000005FB6" title="669"></span><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre50 pcalibre2">7 </span>Linking</h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" id="d9e134638">
<nav class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P700049702700000000000000004473F" epub:type="toc" id="P700049702700000000000000004473F">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044740" id="P7000497027000000000000000044740">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044741" id="P7000497027000000000000000044741">
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P7000497027000000000000000044742" id="P7000497027000000000000000044742"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044743" id="P7000497027000000000000000044743"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006006.xhtml#P7000497027000000000000000006006"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.1 </span>Compiler Drivers </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">671</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P7000497027000000000000000044744" id="P7000497027000000000000000044744"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044745" id="P7000497027000000000000000044745"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006034.xhtml#P7000497027000000000000000006034"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.2 </span>Static Linking </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">672</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P7000497027000000000000000044746" id="P7000497027000000000000000044746"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044747" id="P7000497027000000000000000044747"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006040.xhtml#P7000497027000000000000000006040"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.3 </span>Object Files </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">673</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P7000497027000000000000000044748" id="P7000497027000000000000000044748"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044749" id="P7000497027000000000000000044749"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006053.xhtml#P7000497027000000000000000006053"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.4 </span>Relocatable Object Files </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">674</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P700049702700000000000000004474A" id="P700049702700000000000000004474A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P700049702700000000000000004474B" id="P700049702700000000000000004474B"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000608B.xhtml#P700049702700000000000000000608B"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.5 </span>Symbols and Symbol Tables </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">675</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P700049702700000000000000004474C" id="P700049702700000000000000004474C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P700049702700000000000000004474D" id="P700049702700000000000000004474D"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006160.xhtml#P7000497027000000000000000006160"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.6 </span>Symbol Resolution </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">679</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P700049702700000000000000004474E" id="P700049702700000000000000004474E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P700049702700000000000000004474F" id="P700049702700000000000000004474F"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000627E.xhtml#P700049702700000000000000000627E"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.7 </span>Relocation </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">689</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P7000497027000000000000000044750" id="P7000497027000000000000000044750"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044751" id="P7000497027000000000000000044751"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006348.xhtml#P7000497027000000000000000006348"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.8 </span>Executable Object Files </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">695</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P7000497027000000000000000044752" id="P7000497027000000000000000044752"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044753" id="P7000497027000000000000000044753"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006385.xhtml#P7000497027000000000000000006385"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.9 </span>Loading Executable Object Files </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">697</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P7000497027000000000000000044754" id="P7000497027000000000000000044754"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044755" id="P7000497027000000000000000044755"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000063A5.xhtml#P70004970270000000000000000063A5"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.10 </span>Dynamic Linking with Shared Libraries </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">698</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P7000497027000000000000000044756" id="P7000497027000000000000000044756"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044757" id="P7000497027000000000000000044757"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000063E3.xhtml#P70004970270000000000000000063E3"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.11 </span>Loading and Linking Shared Libraries from Applications </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">701</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P7000497027000000000000000044758" id="P7000497027000000000000000044758"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044759" id="P7000497027000000000000000044759"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006428.xhtml#P7000497027000000000000000006428"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.12 </span>Position-Independent Code (PIC) </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">704</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P700049702700000000000000004475A" id="P700049702700000000000000004475A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P700049702700000000000000004475B" id="P700049702700000000000000004475B"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006493.xhtml#P7000497027000000000000000006493"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.13 </span>Library Interpositioning </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">707</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-class="toclevel1" data-uri="chapter07.xhtml#P700049702700000000000000004475C" id="P700049702700000000000000004475C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P700049702700000000000000004475D" id="P700049702700000000000000004475D"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000650C.xhtml#P700049702700000000000000000650C"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.14 </span>Tools for Manipulating Object Files </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">713</span></a></p></li>
</ol></div>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P700049702700000000000000004475E" id="P700049702700000000000000004475E">
<ol class="pcalibre23 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004475F" id="P700049702700000000000000004475F">
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter07.xhtml#P7000497027000000000000000044760" id="P7000497027000000000000000044760"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044761" id="P7000497027000000000000000044761"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006524.xhtml#P7000497027000000000000000006524"><span class="pcalibre1 pcalibre2" epub:type="title"><span class="pcalibre1 pcalibre21 pcalibre2">7.15 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary</span> </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">713</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter07.xhtml#P7000497027000000000000000044762" id="P7000497027000000000000000044762"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044763" id="P7000497027000000000000000044763"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP700049702700000000000000000652E.xhtml#P700049702700000000000000000652E"><span class="pcalibre1 pcalibre2" epub:type="title">Bibliographic Notes </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">714</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter07.xhtml#P7000497027000000000000000044764" id="P7000497027000000000000000044764"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044765" id="P7000497027000000000000000044765"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP7000497027000000000000000006533.xhtml#P7000497027000000000000000006533"><span class="pcalibre1 pcalibre2" epub:type="title">Homework Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">714</span></a></p></li>
<li class="pcalibre1 pcalibre2 pcalibre24" data-uri="chapter07.xhtml#P7000497027000000000000000044766" id="P7000497027000000000000000044766"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044767" id="P7000497027000000000000000044767"><a class="pcalibre1 pcalibre2 pcalibre25 pcalibre16 pcalibre14 pcalibre15" href="fileP70004970270000000000000000065E7.xhtml#P70004970270000000000000000065E7"><span class="pcalibre1 pcalibre2" epub:type="title">Solutions to Practice Problems </span><span class="pcalibre1 pcalibre2" epub:type="pagebreak">717</span></a></p></li>
</ol></div>
</nav>
<section class="pcalibre1 pcalibre2 pcalibre51" data-uri="chapter07.xhtml#P7000497027000000000000000044768" epub:type="introduction" id="P7000497027000000000000000044768">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044769" id="P7000497027000000000000000044769"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000005FE2" epub:type="pagebreak" id="P7000497027000000000000000005FE2" title="670"></span>Linking is the process of collecting and combining various pieces of code and data into a single file that can be <i class="pcalibre17 pcalibre2 pcalibre1">loaded</i> (copied) into memory and executed. Linking can be performed at <i class="pcalibre17 pcalibre2 pcalibre1">compile time</i>, when the source code is translated into machine code; at <i class="pcalibre17 pcalibre2 pcalibre1">load time</i>, when the program is loaded into memory and executed by the <i class="pcalibre17 pcalibre2 pcalibre1">loader</i>; and even at <i class="pcalibre17 pcalibre2 pcalibre1">run time</i>, by application programs. On early computer systems, linking was performed manually. On modern systems, linking is performed automatically by programs called <i class="pcalibre17 pcalibre2 pcalibre1">linkers</i>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004476A" id="P700049702700000000000000004476A">Linkers play a crucial role in software development because they enable <i class="pcalibre17 pcalibre2 pcalibre1">separate compilation</i>. Instead of organizing a large application as one monolithic source file, we can decompose it into smaller, more manageable modules that can be modified and compiled separately. When we change one of these modules, we simply recompile it and relink the application, without having to recompile the other files.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004476B" id="P700049702700000000000000004476B">Linking is usually handled quietly by the linker and is not an important issue for students who are building small programs in introductory programming classes. So why bother learning about linking?</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004476C" id="P700049702700000000000000004476C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004476D" id="P700049702700000000000000004476D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P700049702700000000000000004476E" id="P700049702700000000000000004476E"><span class="pcalibre1 pcalibre2 pcalibre41">Understanding linkers will help you build large programs. </span>Programmers who build large programs often encounter linker errors caused by missing modules, missing libraries, or incompatible library versions. Unless you understand how a linker resolves references, what a library is, and how a linker uses a library to resolve references, these kinds of errors will be baffling and frustrating.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004476F" id="P700049702700000000000000004476F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044770" id="P7000497027000000000000000044770"><span class="pcalibre1 pcalibre2 pcalibre41">Understanding linkers will help you avoid dangerous programming errors. </span>The decisions that Linux linkers make when they resolve symbol references can silently affect the correctness of your programs. Programs that incorrectly define multiple global variables can pass through the linker without any warnings in the default case. The resulting programs can exhibit baffling run-time behavior and are extremely difficult to debug. We will show you how this happens and how to avoid it.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044771" id="P7000497027000000000000000044771"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044772" id="P7000497027000000000000000044772"><span class="pcalibre1 pcalibre2 pcalibre41">Understanding linking will help you understand how language scoping rules are implemented. </span>For example, what is the difference between global and local variables? What does it really mean when you define a variable or function with the static attribute?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044773" id="P7000497027000000000000000044773"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044774" id="P7000497027000000000000000044774"><span class="pcalibre1 pcalibre2 pcalibre41">Understanding linking will help you understand other important systems concepts. </span>The executable object files produced by linkers play key roles in important systems functions such as loading and running programs, virtual memory, paging, and memory mapping.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044775" id="P7000497027000000000000000044775"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044776" id="P7000497027000000000000000044776"><span class="pcalibre1 pcalibre2 pcalibre41">Understanding linking will enable you to exploit shared libraries. </span>For many years, linking was considered to be fairly straightforward and uninteresting. However, with the increased importance of shared libraries and dynamic linking in modern operating systems, linking is a sophisticated process that provides the knowledgeable programmer with significant power. For example, many software products use shared libraries to upgrade shrink-wrapped binaries at run time. Also, many Web servers rely on dynamic linking of shared libraries to serve dynamic content.</p></li>
</ul>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P7000497027000000000000000005FF0" id="P7000497027000000000000000005FF0">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000005FF1" epub:type="pagebreak" id="P7000497027000000000000000005FF1" title="671"></span>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044777" id="P7000497027000000000000000044777">(a) <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044778" id="P7000497027000000000000000044778">main.c</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044779" id="P7000497027000000000000000044779">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/main.c</i></p>
<pre class="pcalibre53 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004477A" id="P700049702700000000000000004477A"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004477B" id="P700049702700000000000000004477B">
1	int sum(int *a, int n);
2
3	int array[2] = {1, 2};
4
5	int main()
6	{
7		int val = sum(array, 2);
8		return val;
9	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004477C" id="P700049702700000000000000004477C">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/main.c</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004477D" id="P700049702700000000000000004477D">(b) <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004477E" id="P700049702700000000000000004477E">sum.c</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004477F" id="P700049702700000000000000004477F">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/sum.c</i></p>
<pre class="pcalibre53 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044780" id="P7000497027000000000000000044780"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044781" id="P7000497027000000000000000044781">
1	int sum(int *a, int n)
2	{
3		int i, s = 0;
4
5		for (i = 0; i &lt; n; i++) {
6			s += a[i];
7		}
8		return s;
9	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044782" id="P7000497027000000000000000044782">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/sum.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044783" id="P7000497027000000000000000044783"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044784" epub:type="title" id="P7000497027000000000000000044784"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.1 </span>Example program 1.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044785" id="P7000497027000000000000000044785"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044786" id="P7000497027000000000000000044786">The example program consists of two source files, <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044787" id="P7000497027000000000000000044787">main.c</code> and <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044788" id="P7000497027000000000000000044788">sum.c</code>. The <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044789" id="P7000497027000000000000000044789">main function</code> initializes an array of <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004478A" id="P700049702700000000000000004478A">ints</code>, and then calls the <code class="pcalibre52 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004478B" id="P700049702700000000000000004478B">sum</code> function to sum the array elements.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004478C" id="P700049702700000000000000004478C">This chapter provides a thorough discussion of all aspects of linking, from traditional static linking, to dynamic linking of shared libraries at load time, to dynamic linking of shared libraries at run time. We will describe the basic mechanisms using real examples, and we will identify situations in which linking issues can affect the performance and correctness of your programs. To keep things concrete and understandable, we will couch our discussion in the context of an x86-64 system running Linux and using the standard ELF-64 (hereafter referred to as ELF) object file format. However, it is important to realize that the basic concepts of linking are universal, regardless of the operating system, the ISA, or the object file format. Details may vary, but the concepts are the same.</p>
</section>
</section>
<!--EOF:P7000497027000000000000000006006-->
<!--EOF:P7000497027000000000000000006034-->
<!--EOF:P7000497027000000000000000006040-->
<!--EOF:P7000497027000000000000000006053-->
<!--EOF:P700049702700000000000000000608B-->
<!--EOF:P7000497027000000000000000006160-->
<!--EOF:P700049702700000000000000000627E-->
<!--EOF:P7000497027000000000000000006348-->
<!--EOF:P7000497027000000000000000006385-->
<!--EOF:P70004970270000000000000000063A5-->
<!--EOF:P70004970270000000000000000063E3-->
<!--EOF:P7000497027000000000000000006428-->
<!--EOF:P7000497027000000000000000006493-->
<!--EOF:P700049702700000000000000000650C-->
<!--EOF:P7000497027000000000000000006524-->
<!--EOF:P700049702700000000000000000652E-->
<!--EOF:P7000497027000000000000000006533-->
<!--EOF:P70004970270000000000000000065E7-->
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.1 Compiler Drivers</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006006"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P700049702700000000000000004478D" epub:type="title" id="P700049702700000000000000004478D"><span class="pcalibre1 pcalibre21 pcalibre2">7.1 </span>Compiler Drivers</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004478E" id="P700049702700000000000000004478E">Consider the C program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000005FB4.xhtml#P7000497027000000000000000005FF0"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.1</span></a>. It will serve as a simple running example throughout this chapter that will allow us to make some important points about how linkers work.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004478F" id="P700049702700000000000000004478F">Most compilation systems provide a <i class="pcalibre17 pcalibre2 pcalibre1">compiler driver</i> that invokes the language preprocessor, compiler, assembler, and linker, as needed on behalf of the user. For example, to build the example program using the GNU compilation system, we might invoke the <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>driver by typing the following command to the shell:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044790" id="P7000497027000000000000000044790"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044791" id="P7000497027000000000000000044791">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Og -o prog main.c sum.c</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044792" id="P7000497027000000000000000044792"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006011"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.2</span></a> summarizes the activities of the driver as it translates the example program from an ASCII source file into an executable object file. (If you want to see these steps for yourself, run <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>with the -<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044793" id="P7000497027000000000000000044793">v</code> option.) The driver first runs the C preprocessor (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044794" id="P7000497027000000000000000044794">cpp</code>),<a class="pcalibre1 pcalibre2 pcalibre56 pcalibre16 pcalibre14 pcalibre15" epub:type="noteref" href="#P7000497027000000000000000006662" id="r__P7000497027000000000000000006662">1</a> which translates the C source file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044795" id="P7000497027000000000000000044795">main.c</code> into an ASCII intermediate file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044796" id="P7000497027000000000000000044796">main.i</code>:</p><aside class="pcalibre2 pcalibre32 pcalibre57" data-uri="chapter07.xhtml#P7000497027000000000000000006662" epub:type="footnote" id="P7000497027000000000000000006662"><p class="pcalibre1 pcalibre2 pcalibre10"><span class="pcalibre1 pcalibre58 pcalibre2"><a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="#r__P7000497027000000000000000006662">1. </a></span>In some versions of <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>, the preprocessor is integrated into the compiler driver.</p></aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P7000497027000000000000000006011" id="P7000497027000000000000000006011">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006012" epub:type="pagebreak" id="P7000497027000000000000000006012" title="672"></span>
<img alt="A diagram illustrates static linking." class="pcalibre1 pcalibre2 pcalibre234" data-uri="P700049702700000000000000000B758" id="P7000497027000000000000000044797" src="Images/chapter-06-image-01.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044798" id="P7000497027000000000000000044798"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044799" epub:type="title" id="P7000497027000000000000000044799"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.2 </span>Static linking.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P700049702700000000000000004479A" id="P700049702700000000000000004479A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P700049702700000000000000004479B" id="P700049702700000000000000004479B">The linker combines relocatable object files to form an executable object file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004479C" id="P700049702700000000000000004479C">prog</code>.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter07.xhtml#P7000497027000000000000000024AAC" id="P7000497027000000000000000024AAC">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004479D" id="P700049702700000000000000004479D">A diagram shows a flow through the following:</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter07.xhtml#P700049702700000000000000004479E" id="P700049702700000000000000004479E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004479F" id="P700049702700000000000000004479F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447A0" id="P70004970270000000000000000447A0">Source files main.c and sum.c</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447A1" id="P70004970270000000000000000447A1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447A2" id="P70004970270000000000000000447A2">Translators (cpp, cc1, as), one each from main.c and sum.c</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447A3" id="P70004970270000000000000000447A3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447A4" id="P70004970270000000000000000447A4">Relocatable object files: main.o from translator from main.c and sum.o from translator from sum.c</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447A5" id="P70004970270000000000000000447A5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447A6" id="P70004970270000000000000000447A6">Linker (ld) from relocatable object files</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447A7" id="P70004970270000000000000000447A7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447A8" id="P70004970270000000000000000447A8">Fully linked executable object file: prog</p></li>
</ul>
</details>
</figcaption>
</figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447A9" id="P70004970270000000000000000447A9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447AA" id="P70004970270000000000000000447AA">cpp [<i class="pcalibre17 pcalibre2 pcalibre1">other arguments</i>] main.c /tmp/main.i</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447AB" id="P70004970270000000000000000447AB">Next, the driver runs the C compiler (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447AC" id="P70004970270000000000000000447AC">cc1</code>), which translates <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447AD" id="P70004970270000000000000000447AD">main.i</code> into an ASCII assembly-language file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447AE" id="P70004970270000000000000000447AE">main.s</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447AF" id="P70004970270000000000000000447AF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447B0" id="P70004970270000000000000000447B0">cc1 /tmp/main.i -0g [<i class="pcalibre17 pcalibre2 pcalibre1">other arguments</i>] -o /tmp/main.s</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447B1" id="P70004970270000000000000000447B1">Then, the driver runs the assembler (as), which translates <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447B2" id="P70004970270000000000000000447B2">main.s</code> into a binary <i class="pcalibre17 pcalibre2 pcalibre1">relocatable object file</i> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447B3" id="P70004970270000000000000000447B3">main.o:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447B4" id="P70004970270000000000000000447B4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447B5" id="P70004970270000000000000000447B5">as [<i class="pcalibre17 pcalibre2 pcalibre1">other arguments</i>] -o /tmp/main.o /tmp/main.s</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447B6" id="P70004970270000000000000000447B6">The driver goes through the same process to generate <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447B7" id="P70004970270000000000000000447B7">sum.o.</code> Finally, it runs the linker program <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447B8" id="P70004970270000000000000000447B8">ld</code>, which combines <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447B9" id="P70004970270000000000000000447B9">main.o</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447BA" id="P70004970270000000000000000447BA">sum.o</code>, along with the necessary system object files, to create the binary <i class="pcalibre17 pcalibre2 pcalibre1">executable object file</i> <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447BB" id="P70004970270000000000000000447BB">prog</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447BC" id="P70004970270000000000000000447BC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447BD" id="P70004970270000000000000000447BD">ld -o prog [<i class="pcalibre17 pcalibre2 pcalibre1">system object files and args</i>] /tmp/main.o /tmp/sum.o</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447BE" id="P70004970270000000000000000447BE">To run the executable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447BF" id="P70004970270000000000000000447BF">prog</code>, we type its name on the Linux shell's command line:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447C0" id="P70004970270000000000000000447C0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447C1" id="P70004970270000000000000000447C1">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">./prog</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447C2" id="P70004970270000000000000000447C2">The shell invokes a function in the operating system called the <i class="pcalibre17 pcalibre2 pcalibre1">loader</i>, which copies the code and data in the executable file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447C3" id="P70004970270000000000000000447C3">prog</code> into memory, and then transfers control to the beginning of the program.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.2 Static Linking</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006034"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P70004970270000000000000000447C4" epub:type="title" id="P70004970270000000000000000447C4"><span class="pcalibre1 pcalibre21 pcalibre2">7.2 </span>Static Linking</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447C5" id="P70004970270000000000000000447C5"><i class="pcalibre17 pcalibre2 pcalibre1">Static linkers</i> such as the Linux <span class="pcalibre1 pcalibre29 pcalibre2">ld </span>program take as input a collection of relocatable object files and command-line arguments and generate as output a fully linked executable object file that can be loaded and run. The input relocatable object files consist of various code and data sections, where each section is a contiguous sequence of bytes. Instructions are in one section, initialized global variables are in another section, and uninitialized variables are in yet another section.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447C6" id="P70004970270000000000000000447C6"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006038" epub:type="pagebreak" id="P7000497027000000000000000006038" title="673"></span>To build the executable, the linker must perform two main tasks:</p>
<ol class="pcalibre1 pcalibre2 pcalibre235" data-uri="chapter07.xhtml#P70004970270000000000000000447C7" id="P70004970270000000000000000447C7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447C8" id="P70004970270000000000000000447C8">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447C9" id="P70004970270000000000000000447C9"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">1. </span><span class="pcalibre1 pcalibre2 pcalibre41">Symbol resolution. </span>Object files define and reference <i class="pcalibre17 pcalibre2 pcalibre1">symbols</i>, where each symbol corresponds to a function, a global variable, or a <i class="pcalibre17 pcalibre2 pcalibre1">static variable</i> (i.e., any C variable declared with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447CA" id="P70004970270000000000000000447CA">static</code> attribute). The purpose of symbol resolution is to associate each symbol <i class="pcalibre17 pcalibre2 pcalibre1">reference</i> with exactly one symbol <i class="pcalibre17 pcalibre2 pcalibre1">definition</i>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447CB" id="P70004970270000000000000000447CB">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447CC" id="P70004970270000000000000000447CC"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">2. </span><span class="pcalibre1 pcalibre2 pcalibre41">Relocation. </span>Compilers and assemblers generate code and data sections that start at address 0. The linker <i class="pcalibre17 pcalibre2 pcalibre1">relocates</i> these sections by associating a memory location with each symbol definition, and then modifying all of the references to those symbols so that they point to this memory location. The linker blindly performs these relocations using detailed instructions, generated by the assembler, called <i class="pcalibre17 pcalibre2 pcalibre1">relocation entries</i>.</p></li>
</ol>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447CD" id="P70004970270000000000000000447CD">The sections that follow describe these tasks in more detail. As you read, keep in mind some basic facts about linkers: Object files are merely collections of blocks of bytes. Some of these blocks contain program code, others contain program data, and others contain data structures that guide the linker and loader. A linker concatenates blocks together, decides on run-time locations for the concatenated blocks, and modifies various locations within the code and data blocks. Linkers have minimal understanding of the target machine. The compilers and assemblers that generate the object files have already done most of the work.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.3 Object Files</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006040"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P70004970270000000000000000447CE" epub:type="title" id="P70004970270000000000000000447CE"><span class="pcalibre1 pcalibre21 pcalibre2">7.3 </span>Object Files</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447CF" id="P70004970270000000000000000447CF">Object files come in three forms:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447D0" id="P70004970270000000000000000447D0">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447D1" id="P70004970270000000000000000447D1"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P70004970270000000000000000447D2" id="P70004970270000000000000000447D2"><span class="pcalibre1 pcalibre2 pcalibre41">Relocatable object file. </span>Contains binary code and data in a form that can be combined with other relocatable object files at compile time to create an executable object file.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447D3" id="P70004970270000000000000000447D3"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P70004970270000000000000000447D4" id="P70004970270000000000000000447D4"><span class="pcalibre1 pcalibre2 pcalibre41">Executable object file. </span>Contains binary code and data in a form that can be copied directly into memory and executed.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447D5" id="P70004970270000000000000000447D5"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P70004970270000000000000000447D6" id="P70004970270000000000000000447D6"><span class="pcalibre1 pcalibre2 pcalibre41">Shared object file. </span>A special type of relocatable object file that can be loaded into memory and linked dynamically, at either load time or run time.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447D7" id="P70004970270000000000000000447D7">Compilers and assemblers generate relocatable object files (including shared object files). Linkers generate executable object files. Technically, an <i class="pcalibre17 pcalibre2 pcalibre1">object module</i> is a sequence of bytes, and an <i class="pcalibre17 pcalibre2 pcalibre1">object file</i> is an object module stored on disk in a file. However, we will use these terms interchangeably.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447D8" id="P70004970270000000000000000447D8">Object files are organized according to specific <i class="pcalibre17 pcalibre2 pcalibre1">object file formats</i>, which vary from system to system. The first Unix systems from Bell Labs used the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447D9" id="P70004970270000000000000000447D9">a.out</code> format. (To this day, executables are still referred to as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447DA" id="P70004970270000000000000000447DA">a.out</code> files.) Windows uses the Portable Executable (PE) format. Mac OS-X uses the Mach-O format. Modern x86-64 Linux and Unix systems use <i class="pcalibre17 pcalibre2 pcalibre1">Executable and Linkable Format (ELF</i>). Although our discussion will focus on ELF, the basic concepts are similar, regardless of the particular format.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P700049702700000000000000000604E" id="P700049702700000000000000000604E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000604F" epub:type="pagebreak" id="P700049702700000000000000000604F" title="674"></span>
<img alt="A diagram shows a typical ELF relocatable object file." class="pcalibre1 pcalibre2 pcalibre236" data-uri="P700049702700000000000000000B759" id="P70004970270000000000000000447DB" src="Images/chapter-06-image-02.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P70004970270000000000000000447DC" id="P70004970270000000000000000447DC"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P70004970270000000000000000447DD" epub:type="title" id="P70004970270000000000000000447DD"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.3 </span>Typical ELF relocatable object file.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter07.xhtml#P7000497027000000000000000024AEE" id="P7000497027000000000000000024AEE">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447DE" id="P70004970270000000000000000447DE">A diagram has 11 sections extending from 0 at the top, with a section at the bottom, containing section header table, describing object file sections. The sections, from bottom to top, are:</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter07.xhtml#P70004970270000000000000000447DF" id="P70004970270000000000000000447DF">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447E0" id="P70004970270000000000000000447E0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447E1" id="P70004970270000000000000000447E1">ELF header</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447E2" id="P70004970270000000000000000447E2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447E3" id="P70004970270000000000000000447E3">.text</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447E4" id="P70004970270000000000000000447E4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447E5" id="P70004970270000000000000000447E5">.rodata</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447E6" id="P70004970270000000000000000447E6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447E7" id="P70004970270000000000000000447E7">.data</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447E8" id="P70004970270000000000000000447E8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447E9" id="P70004970270000000000000000447E9">.bss</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447EA" id="P70004970270000000000000000447EA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447EB" id="P70004970270000000000000000447EB">.symtab</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447EC" id="P70004970270000000000000000447EC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447ED" id="P70004970270000000000000000447ED">.rel .text</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447EE" id="P70004970270000000000000000447EE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447EF" id="P70004970270000000000000000447EF">.rel .data</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447F0" id="P70004970270000000000000000447F0"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447F1" id="P70004970270000000000000000447F1">.debug</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447F2" id="P70004970270000000000000000447F2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447F3" id="P70004970270000000000000000447F3">.line</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447F4" id="P70004970270000000000000000447F4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000447F5" id="P70004970270000000000000000447F5">.strtb</p></li>
</ul>
</details>
</figcaption>
</figure>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.4 Relocatable Object Files</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006053"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P70004970270000000000000000447F6" epub:type="title" id="P70004970270000000000000000447F6"><span class="pcalibre1 pcalibre21 pcalibre2">7.4 </span>Relocatable Object Files</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447F7" id="P70004970270000000000000000447F7"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006040.xhtml#P700049702700000000000000000604E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.3</span></a> shows the format of a typical ELF relocatable object file. The <i class="pcalibre17 pcalibre2 pcalibre1">ELF header</i> begins with a 16-byte sequence that describes the word size and byte ordering of the system that generated the file. The rest of the ELF header contains information that allows a linker to parse and interpret the object file. This includes the size of the ELF header, the object file type (e.g., relocatable, executable, or shared), the machine type (e.g., x86-64), the file offset of the section header table, and the size and number of entries in the section header table. The locations and sizes of the various sections are described by the <i class="pcalibre17 pcalibre2 pcalibre1">section header table</i>, which contains a fixed-size entry for each section in the object file.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447F8" id="P70004970270000000000000000447F8">Sandwiched between the ELF header and the section header table are the sections themselves. A typical ELF relocatable object file contains the following sections:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447F9" id="P70004970270000000000000000447F9">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447FA" id="P70004970270000000000000000447FA"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P70004970270000000000000000447FB" id="P70004970270000000000000000447FB"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447FC" id="P70004970270000000000000000447FC">.text</code> The machine code of the compiled program.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000447FD" id="P70004970270000000000000000447FD"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P70004970270000000000000000447FE" id="P70004970270000000000000000447FE"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000447FF" id="P70004970270000000000000000447FF">.rodata</code> Read-only data such as the format strings in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044800" id="P7000497027000000000000000044800">printf</code> statements, and jump tables for switch statements.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044801" id="P7000497027000000000000000044801"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044802" id="P7000497027000000000000000044802"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044803" id="P7000497027000000000000000044803">.data</code> <i class="pcalibre17 pcalibre2 pcalibre1">Initialized</i> global and static C variables. Local C variables are maintained at run time on the stack and do <i class="pcalibre17 pcalibre2 pcalibre1">not</i> appear in either the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044804" id="P7000497027000000000000000044804">.data</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044805" id="P7000497027000000000000000044805">.bss</code> sections.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044806" id="P7000497027000000000000000044806"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044807" id="P7000497027000000000000000044807"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044808" id="P7000497027000000000000000044808">.bss</code> <i class="pcalibre17 pcalibre2 pcalibre1">Uninitialized</i> global and static C variables, along with any global or static variables that are initialized to zero. This section occupies no actual space in the object file; it is merely a placeholder. Object file formats distinguish between initialized and uninitialized variables for space efficiency: uninitialized variables do not have to occupy any actual disk space in the object file. At run time, these variables are allocated in memory with an initial value of zero.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000006067" id="P7000497027000000000000000006067"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter07.xhtml#P7000497027000000000000000044809" epub:type="title" id="P7000497027000000000000000044809"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006069" epub:type="pagebreak" id="P7000497027000000000000000006069" title="675"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Why is uninitialized data called <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter07.xhtml#P700049702700000000000000004480A" id="P700049702700000000000000004480A">.bss</code>?</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P700049702700000000000000004480B" id="P700049702700000000000000004480B">The use of the term <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004480C" id="P700049702700000000000000004480C">.bss</code> to denote uninitialized data is universal. It was originally an acronym for the "block started by symbol" directive from the IBM 704 assembly language (circa 1957) and the acronym has stuck. A simple way to remember the difference between the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004480D" id="P700049702700000000000000004480D">.data</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004480E" id="P700049702700000000000000004480E">.bss</code> sections is to think of "bss" as an abbreviation for "Better Save Space!"</p>
</aside></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004480F" id="P700049702700000000000000004480F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044810" id="P7000497027000000000000000044810"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044811" id="P7000497027000000000000000044811">.symtab</code> A <i class="pcalibre17 pcalibre2 pcalibre1">symbol table</i> with information about functions and global variables that are defined and referenced in the program. Some programmers mistakenly believe that a program must be compiled with the -<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044812" id="P7000497027000000000000000044812">g</code> option to get symbol table information. In fact, every relocatable object file has a symbol table in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044813" id="P7000497027000000000000000044813">.symtab</code> (unless the programmer has specifically removed it with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044814" id="P7000497027000000000000000044814"><span class="pcalibre1 pcalibre29 pcalibre2">strip</span></code> command). However, unlike the symbol table inside a compiler, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044815" id="P7000497027000000000000000044815">.symtab</code> symbol table does not contain entries for local variables.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044816" id="P7000497027000000000000000044816"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044817" id="P7000497027000000000000000044817"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044818" id="P7000497027000000000000000044818">.rel.text</code> A list of locations in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044819" id="P7000497027000000000000000044819">.text</code> section that will need to be modified when the linker combines this object file with others. In general, any instruction that calls an external function or references a global variable will need to be modified. On the other hand, instructions that call local functions do not need to be modified. Note that relocation information is not needed in executable object files, and is usually omitted unless the user explicitly instructs the linker to include it.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004481A" id="P700049702700000000000000004481A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P700049702700000000000000004481B" id="P700049702700000000000000004481B"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004481C" id="P700049702700000000000000004481C">.rel.data</code> Relocation information for any global variables that are referenced or defined by the module. In general, any initialized global variable whose initial value is the address of a global variable or externally defined function will need to be modified.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004481D" id="P700049702700000000000000004481D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P700049702700000000000000004481E" id="P700049702700000000000000004481E"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004481F" id="P700049702700000000000000004481F">.debug</code> A debugging symbol table with entries for local variables and typedefs defined in the program, global variables defined and referenced in the program, and the original C source file. It is only present if the compiler driver is invoked with the -<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044820" id="P7000497027000000000000000044820">g</code> option.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044821" id="P7000497027000000000000000044821"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044822" id="P7000497027000000000000000044822"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044823" id="P7000497027000000000000000044823">.line</code> A mapping between line numbers in the original C source program and machine code instructions in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044824" id="P7000497027000000000000000044824">.text</code> section. It is only present if the compiler driver is invoked with the -<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044825" id="P7000497027000000000000000044825">g</code> option.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044826" id="P7000497027000000000000000044826"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044827" id="P7000497027000000000000000044827"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044828" id="P7000497027000000000000000044828">.strtab</code> A string table for the symbol tables in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044829" id="P7000497027000000000000000044829">.symtab</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004482A" id="P700049702700000000000000004482A">.debug</code> sections and for the section names in the section headers. A string table is a sequence of null-terminated character strings.</p></li>
</ul>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.5 Symbols and Symbol Tables</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P700049702700000000000000000608B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P700049702700000000000000004482B" epub:type="title" id="P700049702700000000000000004482B"><span class="pcalibre1 pcalibre21 pcalibre2">7.5 </span>Symbols and Symbol Tables</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004482C" id="P700049702700000000000000004482C">Each relocatable object module, <var class="pcalibre17 pcalibre2 pcalibre1">m</var>, has a symbol table that contains information about the symbols that are defined and referenced by <i class="pcalibre17 pcalibre2 pcalibre1">m.</i> In the context of a linker, there are three different kinds of symbols:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004482D" id="P700049702700000000000000004482D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004482E" id="P700049702700000000000000004482E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P700049702700000000000000004482F" id="P700049702700000000000000004482F"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006091" epub:type="pagebreak" id="P7000497027000000000000000006091" title="676"></span><i class="pcalibre17 pcalibre2 pcalibre1">Global symbols</i> that are defined by module <var class="pcalibre17 pcalibre2 pcalibre1">m</var> and that can be referenced by other modules. Global linker symbols correspond to <i class="pcalibre17 pcalibre2 pcalibre1">nonstatic</i> C functions and global variables.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044830" id="P7000497027000000000000000044830"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044831" id="P7000497027000000000000000044831">Global symbols that are referenced by module <var class="pcalibre17 pcalibre2 pcalibre1">m</var> but defined by some other module. Such symbols are called <i class="pcalibre17 pcalibre2 pcalibre1">externals</i> and correspond to nonstatic C functions and global variables that are defined in other modules.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044832" id="P7000497027000000000000000044832"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044833" id="P7000497027000000000000000044833"><i class="pcalibre17 pcalibre2 pcalibre1">Local symbols</i> that are defined and referenced exclusively by module <var class="pcalibre17 pcalibre2 pcalibre1">m</var>.These correspond to static C functions and global variables that are defined with the static attribute. These symbols are visible anywhere within module <var class="pcalibre17 pcalibre2 pcalibre1">m</var>, but cannot be referenced by other modules.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044834" id="P7000497027000000000000000044834">It is important to realize that local linker symbols are not the same as local program variables. The symbol table in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044835" id="P7000497027000000000000000044835">.symtab</code> does not contain any symbols that correspond to local nonstatic program variables. These are managed at run time on the stack and are not of interest to the linker.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044836" id="P7000497027000000000000000044836">Interestingly, local procedure variables that are defined with the C <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044837" id="P7000497027000000000000000044837">static</code> attribute are not managed on the stack. Instead, the compiler allocates space in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044838" id="P7000497027000000000000000044838">.data</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044839" id="P7000497027000000000000000044839">.bss</code> for each definition and creates a local linker symbol in the symbol table with a unique name. For example, suppose a pair of functions in the same module define a static local variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004483A" id="P700049702700000000000000004483A">x</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004483B" id="P700049702700000000000000004483B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004483C" id="P700049702700000000000000004483C">
1	int f()
2	{
3		static int x = 0;
4		return x;
5	}
6
7	int g()
8	{
9		static int x = 1;
10		return x;
11	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004483D" id="P700049702700000000000000004483D">In this case, the compiler exports a pair of local linker symbols with different names to the assembler. For example, it might use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004483E" id="P700049702700000000000000004483E">x.1</code> for the definition in function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004483F" id="P700049702700000000000000004483F">f</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044840" id="P7000497027000000000000000044840">x.2</code> for the definition in function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044841" id="P7000497027000000000000000044841">g</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044842" id="P7000497027000000000000000044842">Symbol tables are built by assemblers, using symbols exported by the compiler into the assembly-language <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044843" id="P7000497027000000000000000044843">.s</code> file. An ELF symbol table is contained in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044844" id="P7000497027000000000000000044844">.symtab</code> section. It contains an array of entries. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000060B9"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.4</span></a> shows the format of each entry.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044845" id="P7000497027000000000000000044845">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044846" id="P7000497027000000000000000044846">name</code> is a byte offset into the string table that points to the null-terminated string name of the symbol. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044847" id="P7000497027000000000000000044847">value</code> is the symbol's address. For relocatable modules, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044848" id="P7000497027000000000000000044848">value</code> is an offset from the beginning of the section where the object is defined. For executable object files, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044849" id="P7000497027000000000000000044849">value</code> is an absolute run-time address. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004484A" id="P700049702700000000000000004484A">size</code> is the size (in bytes) of the object. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004484B" id="P700049702700000000000000004484B">type</code> is usually either <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004484C" id="P700049702700000000000000004484C">data</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004484D" id="P700049702700000000000000004484D">function</code>. The symbol table can also contain entries for the individual sections</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000060B0" id="P70004970270000000000000000060B0"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter07.xhtml#P700049702700000000000000004484E" epub:type="title" id="P700049702700000000000000004484E"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000060B2" epub:type="pagebreak" id="P70004970270000000000000000060B2" title="677"></span><span class="pcalibre1 pcalibre2 pcalibre34">New to C? </span>Hiding variable and function names with <code class="pcalibre1 pcalibre2 calibre16" data-uri="chapter07.xhtml#P700049702700000000000000004484F" id="P700049702700000000000000004484F">static</code></h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044850" id="P7000497027000000000000000044850">C programmers use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044851" id="P7000497027000000000000000044851">static</code> attribute to hide variable and function declarations inside modules, much as you would use <i class="pcalibre17 pcalibre2 pcalibre1">public</i> and <i class="pcalibre17 pcalibre2 pcalibre1">private</i> declarations in Java and C++. In C, source files play the role of modules. Any global variable or function declared with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044852" id="P7000497027000000000000000044852">static</code> attribute is private to that module. Similarly, any global variable or function declared without the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044853" id="P7000497027000000000000000044853">static</code> attribute is public and can be accessed by any other module. It is good programming practice to protect your variables and functions with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044854" id="P7000497027000000000000000044854">static</code> attribute wherever possible.</p>
</aside>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P70004970270000000000000000060B9" id="P70004970270000000000000000060B9">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044855" id="P7000497027000000000000000044855">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/elfstructs.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044856" id="P7000497027000000000000000044856"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044857" id="P7000497027000000000000000044857">
1	typedef struct {
2	int	name;		/* String table offset */
3	char	type:4,		/* Function or data (4 bits) */
4		binding:4;	/* Local or global (4 bits) */
5	char	reserved;	/* Unused */
6	short	section;	/* Section header index */
7	long	value;		/* Section offset or absolute address */
8	long	size;		/* Object size in bytes */
9	} Elf64_Symbol;
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044858" id="P7000497027000000000000000044858">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/elfstructs.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044859" id="P7000497027000000000000000044859"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P700049702700000000000000004485A" epub:type="title" id="P700049702700000000000000004485A"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.4 </span>ELF symbol table entry.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004485B" id="P700049702700000000000000004485B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P700049702700000000000000004485C" id="P700049702700000000000000004485C">The type and binding fields are 4 bits each.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004485D" id="P700049702700000000000000004485D">and for the path name of the original source file. So there are distinct types for these objects as well. The binding field indicates whether the symbol is local or global.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004485E" id="P700049702700000000000000004485E">Each symbol is assigned to some section of the object file, denoted by the section field, which is an index into the section header table. There are three special pseudosections that don't have entries in the section header table: ABS is for symbols that should not be relocated. UNDEF is for undefined symbolsthat is, symbols that are referenced in this object module but defined elsewhere. COMMON is for uninitialized data objects that are not yet allocated. For COMMON symbols, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004485F" id="P700049702700000000000000004485F">value</code> field gives the alignment requirement, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044860" id="P7000497027000000000000000044860">size</code> gives the minimum size. Note that these pseudosections exist only in relocatable object files; they do not exist in executable object files.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044861" id="P7000497027000000000000000044861">The distinction between COMMON and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044862" id="P7000497027000000000000000044862">.bss</code> is subtle. Modern versions of <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>assign symbols in relocatable object files to COMMON and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044863" id="P7000497027000000000000000044863">.bss</code> using the following convention:</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter07.xhtml#P7000497027000000000000000044864" id="P7000497027000000000000000044864">
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044865" id="P7000497027000000000000000044865">COMMON</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044866" id="P7000497027000000000000000044866">Uninitialized global variables</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044867" id="P7000497027000000000000000044867"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044868" id="P7000497027000000000000000044868">.bss</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044869" id="P7000497027000000000000000044869">Uninitialized static variables, and global or static variables that are initialized to zero</td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004486A" id="P700049702700000000000000004486A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000060D0" epub:type="pagebreak" id="P70004970270000000000000000060D0" title="678"></span>The reason for this seemingly arbitrary distinction stems from the way the linker performs symbol resolution, which we will explain in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P7000497027000000000000000006160"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">7.6</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004486B" id="P700049702700000000000000004486B">The GNU <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004486C" id="P700049702700000000000000004486C"><span class="pcalibre1 pcalibre29 pcalibre2">readelf</span></code> program is a handy tool for viewing the contents of object files. For example, here are the last three symbol table entries for the relocatable object <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004486D" id="P700049702700000000000000004486D">file main.o</code>, from the example program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000005FB4.xhtml#P7000497027000000000000000005FF0"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.1</span></a>. The first eight entries, which are not shown, are local symbols that the linker uses internally.</p>
<table class="pcalibre1 informaltable pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004486E" id="P700049702700000000000000004486E">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P700049702700000000000000004486F" id="P700049702700000000000000004486F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044870" id="P7000497027000000000000000044870">Num:</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044871" id="P7000497027000000000000000044871"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044872" id="P7000497027000000000000000044872">Value</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044873" id="P7000497027000000000000000044873"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044874" id="P7000497027000000000000000044874">Size</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044875" id="P7000497027000000000000000044875"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044876" id="P7000497027000000000000000044876">Type</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044877" id="P7000497027000000000000000044877"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044878" id="P7000497027000000000000000044878">Bind</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044879" id="P7000497027000000000000000044879"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004487A" id="P700049702700000000000000004487A">Vis</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P700049702700000000000000004487B" id="P700049702700000000000000004487B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004487C" id="P700049702700000000000000004487C">Ndx</code></th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P700049702700000000000000004487D" id="P700049702700000000000000004487D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004487E" id="P700049702700000000000000004487E">Name</code></th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P700049702700000000000000004487F" id="P700049702700000000000000004487F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044880" id="P7000497027000000000000000044880">8:</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044881" id="P7000497027000000000000000044881"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044882" id="P7000497027000000000000000044882">0000000000000000</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044883" id="P7000497027000000000000000044883"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044884" id="P7000497027000000000000000044884">24</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044885" id="P7000497027000000000000000044885"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044886" id="P7000497027000000000000000044886">FUNC</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044887" id="P7000497027000000000000000044887"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044888" id="P7000497027000000000000000044888">GLOBAL</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044889" id="P7000497027000000000000000044889"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004488A" id="P700049702700000000000000004488A">DEFAULT</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P700049702700000000000000004488B" id="P700049702700000000000000004488B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004488C" id="P700049702700000000000000004488C">1</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P700049702700000000000000004488D" id="P700049702700000000000000004488D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004488E" id="P700049702700000000000000004488E">main</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P700049702700000000000000004488F" id="P700049702700000000000000004488F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044890" id="P7000497027000000000000000044890">9:</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044891" id="P7000497027000000000000000044891"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044892" id="P7000497027000000000000000044892">0000000000000000</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044893" id="P7000497027000000000000000044893"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044894" id="P7000497027000000000000000044894">8</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044895" id="P7000497027000000000000000044895"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044896" id="P7000497027000000000000000044896">OBJECT</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044897" id="P7000497027000000000000000044897"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044898" id="P7000497027000000000000000044898">GLOBAL</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044899" id="P7000497027000000000000000044899"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004489A" id="P700049702700000000000000004489A">DEFAULT</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P700049702700000000000000004489B" id="P700049702700000000000000004489B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004489C" id="P700049702700000000000000004489C">3</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P700049702700000000000000004489D" id="P700049702700000000000000004489D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004489E" id="P700049702700000000000000004489E">array</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P700049702700000000000000004489F" id="P700049702700000000000000004489F"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448A0" id="P70004970270000000000000000448A0">10:</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448A1" id="P70004970270000000000000000448A1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448A2" id="P70004970270000000000000000448A2">0000000000000000</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448A3" id="P70004970270000000000000000448A3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448A4" id="P70004970270000000000000000448A4">0</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448A5" id="P70004970270000000000000000448A5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448A6" id="P70004970270000000000000000448A6">NOTYPE</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448A7" id="P70004970270000000000000000448A7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448A8" id="P70004970270000000000000000448A8">GLOBAL</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448A9" id="P70004970270000000000000000448A9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448AA" id="P70004970270000000000000000448AA">DEFAULT</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448AB" id="P70004970270000000000000000448AB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448AC" id="P70004970270000000000000000448AC">UND</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448AD" id="P70004970270000000000000000448AD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448AE" id="P70004970270000000000000000448AE">sum</code></td>
</tr>
</tbody>
</table>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448AF" id="P70004970270000000000000000448AF">In this example, we see an entry for the definition of global symbol <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B0" id="P70004970270000000000000000448B0">main</code>, a 24-byte function located at an offset (i.e., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B1" id="P70004970270000000000000000448B1">value</code>) of zero in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B2" id="P70004970270000000000000000448B2">.text</code> section. This is followed by the definition of the global symbol <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B3" id="P70004970270000000000000000448B3">array</code>, an 8-byte object located at an offset of zero in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B4" id="P70004970270000000000000000448B4">.data</code> section. The last entry comes from the reference to the external symbol <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B5" id="P70004970270000000000000000448B5">sum. <span class="pcalibre1 pcalibre29 pcalibre2">readelf</span></code> identifies each section by an integer index. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B6" id="P70004970270000000000000000448B6">Ndx=1</code> denotes the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B7" id="P70004970270000000000000000448B7">.text</code> section, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B8" id="P70004970270000000000000000448B8">Ndx=3</code> denotes the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448B9" id="P70004970270000000000000000448B9">.data</code> section.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006120" epub:type="practice" id="P7000497027000000000000000006120"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448BA" epub:type="title" id="P70004970270000000000000000448BA"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.1 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000006533.xhtml#P70004970270000000000000000065A9">717</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter07.xhtml#P70004970270000000000000000448BB" id="P70004970270000000000000000448BB">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter07.xhtml#P70004970270000000000000000448BC" id="P70004970270000000000000000448BC">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448BD" id="P70004970270000000000000000448BD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000448BE" id="P70004970270000000000000000448BE">This problem concerns the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448BF" id="P70004970270000000000000000448BF">m.o</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448C0" id="P70004970270000000000000000448C0">swap.o</code> modules from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000612D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.5</span></a>. For each symbol that is defined or referenced in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448C1" id="P70004970270000000000000000448C1">swap.o</code>, indicate whether or not it will have a symbol table entry in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448C2" id="P70004970270000000000000000448C2">.symtab</code> section in module <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448C3" id="P70004970270000000000000000448C3">swap.o</code>. If so, indicate the module that defines the symbol (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448C4" id="P70004970270000000000000000448C4">swap.oorm.o</code>), the symbol type (local, global, or extern), and the section (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448C5" id="P70004970270000000000000000448C5">.text, .data, .bss</code>, or COMMON) it is assigned to in the module.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P700049702700000000000000000612D" id="P700049702700000000000000000612D">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000448C6" id="P70004970270000000000000000448C6">(a) m.c</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000448C7" id="P70004970270000000000000000448C7">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/m.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000448C8" id="P70004970270000000000000000448C8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448C9" id="P70004970270000000000000000448C9">
1	void swap();
2
3	int buf[2] = {1, 2};
4
5	int main()
6	{
7		swap();
8		return 0;
9	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000448CA" id="P70004970270000000000000000448CA">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/m.c</i></p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000448CB" id="P70004970270000000000000000448CB">(b) swap.c</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000448CC" id="P70004970270000000000000000448CC">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/swap.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000448CD" id="P70004970270000000000000000448CD"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448CE" id="P70004970270000000000000000448CE">
1	extern int buf[];
2
3	int *bufp0 = &amp;buf[0];
4	int *bufp1;
5
6	void swap()
7	{
8		int temp;
9
10		bufp1 = &amp;buf[1];
11		temp = *bufp0;
12		*bufp0 = *bufp1;
13		*bufp1 = temp;
14	}
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000448CF" id="P70004970270000000000000000448CF">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/swap.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P70004970270000000000000000448D0" id="P70004970270000000000000000448D0"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P70004970270000000000000000448D1" epub:type="title" id="P70004970270000000000000000448D1"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.5 </span>Example program for <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006120"><span class="label pcalibre1 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre2 pcalibre37">7.1</span></a>.</h1></header>
</figcaption>
</figure>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter07.xhtml#P70004970270000000000000000448D2" id="P70004970270000000000000000448D2">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P70004970270000000000000000448D3" id="P70004970270000000000000000448D3"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000613C" epub:type="pagebreak" id="P700049702700000000000000000613C" title="679"></span>Symbol</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P70004970270000000000000000448D4" id="P70004970270000000000000000448D4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448D5" id="P70004970270000000000000000448D5">.symtab</code> entry?</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P70004970270000000000000000448D6" id="P70004970270000000000000000448D6">Symbol type</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P70004970270000000000000000448D7" id="P70004970270000000000000000448D7">Module where defined</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P70004970270000000000000000448D8" id="P70004970270000000000000000448D8">Section</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448D9" id="P70004970270000000000000000448D9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448DA" id="P70004970270000000000000000448DA">buf</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448DB" id="P70004970270000000000000000448DB">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448DC" id="P70004970270000000000000000448DC">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448DD" id="P70004970270000000000000000448DD">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448DE" id="P70004970270000000000000000448DE">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448DF" id="P70004970270000000000000000448DF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448E0" id="P70004970270000000000000000448E0">bufp0</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448E1" id="P70004970270000000000000000448E1">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448E2" id="P70004970270000000000000000448E2">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448E3" id="P70004970270000000000000000448E3">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448E4" id="P70004970270000000000000000448E4">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448E5" id="P70004970270000000000000000448E5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448E6" id="P70004970270000000000000000448E6">bufp1</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448E7" id="P70004970270000000000000000448E7">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448E8" id="P70004970270000000000000000448E8">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448E9" id="P70004970270000000000000000448E9">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448EA" id="P70004970270000000000000000448EA">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448EB" id="P70004970270000000000000000448EB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448EC" id="P70004970270000000000000000448EC">swap</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448ED" id="P70004970270000000000000000448ED">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448EE" id="P70004970270000000000000000448EE">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448EF" id="P70004970270000000000000000448EF">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448F0" id="P70004970270000000000000000448F0">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448F1" id="P70004970270000000000000000448F1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448F2" id="P70004970270000000000000000448F2">temp</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448F3" id="P70004970270000000000000000448F3">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448F4" id="P70004970270000000000000000448F4">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448F5" id="P70004970270000000000000000448F5">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P70004970270000000000000000448F6" id="P70004970270000000000000000448F6">_____</td>
</tr>
</tbody>
</table>
</div></li>
</ol>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.6 Symbol Resolution</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006160"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P70004970270000000000000000448F7" epub:type="title" id="P70004970270000000000000000448F7"><span class="pcalibre1 pcalibre21 pcalibre2">7.6 </span>Symbol Resolution</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448F8" id="P70004970270000000000000000448F8">The linker resolves symbol references by associating each reference with exactly one symbol definition from the symbol tables of its input relocatable object files. Symbol resolution is straightforward for references to local symbols that are defined in the same module as the reference. The compiler allows only one definition of each local symbol per module. The compiler also ensures that static local variables, which get local linker symbols, have unique names.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448F9" id="P70004970270000000000000000448F9">Resolving references to global symbols, however, is trickier. When the compiler encounters a symbol (either a variable or function name) that is not defined in the current module, it assumes that it is defined in some other module, generates a linker symbol table entry, and leaves it for the linker to handle. If the linker is unable to find a definition for the referenced symbol in any of its input modules, it prints an (often cryptic) error message and terminates. For example, if we try to compile and link the following source file on a Linux machine,</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000448FA" id="P70004970270000000000000000448FA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448FB" id="P70004970270000000000000000448FB">
1	void foo(void); 
2
3	int main() {
4	    foo();
5	    return 0;
6	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448FC" id="P70004970270000000000000000448FC">then the compiler runs without a hitch, but the linker terminates when it cannot resolve the reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448FD" id="P70004970270000000000000000448FD">foo:</code></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000448FE" id="P70004970270000000000000000448FE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000448FF" id="P70004970270000000000000000448FF">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Wall -Og -o linkerror linkerror.c</i>
/tmp/ccSz5uti.o: In function `main':
/tmp/ccSz5uti.o(.text+0x7): undefined reference to `foo'</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044900" id="P7000497027000000000000000044900">Symbol resolution for global symbols is also tricky because multiple object modules might define global symbols with the same name. In this case, the linker must either flag an error or somehow choose one of the definitions and discard the rest. The approach adopted by Linux systems involves cooperation between the compiler, assembler, and linker and can introduce some baffling bugs to the unwary programmer.</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000000616B" id="P700049702700000000000000000616B"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter07.xhtml#P7000497027000000000000000044901" epub:type="title" id="P7000497027000000000000000044901"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000616D" epub:type="pagebreak" id="P700049702700000000000000000616D" title="680"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Mangling of linker symbols in C++ and Java</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044902" id="P7000497027000000000000000044902">Both C++ and Java allow overloaded methods that have the same name in the source code but different parameter lists. So how does the linker tell the difference between these different overloaded functions? Overloaded functions in C++ and Java work because the compiler encodes each unique method and parameter list combination into a unique name for the linker. This encoding process is called <i class="pcalibre17 pcalibre2 pcalibre1">mangling</i>, and the inverse process is known as <i class="pcalibre17 pcalibre2 pcalibre1">demangling.</i></p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044903" id="P7000497027000000000000000044903">Happily, C++ and Java use compatible mangling schemes. A mangled class name consists of the integer number of characters in the name followed by the original name. For example, the class <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044904" id="P7000497027000000000000000044904">Foo</code> is encoded as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044905" id="P7000497027000000000000000044905">3Foo</code>. A method is encoded as the original method name, followed by __, followed by the mangled class name, followed by single letter encodings of each argument. For example, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044906" id="P7000497027000000000000000044906">Foo::bar(int, long)</code> is encoded as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044907" id="P7000497027000000000000000044907">bar_3Fooil</code>. Similar schemes are used to mangle global variable and template names.</p>
</aside>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006174" id="P7000497027000000000000000006174"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044908" epub:type="title" id="P7000497027000000000000000044908"><span class="pcalibre1 pcalibre21 pcalibre2">7.6.1 </span>How Linkers Resolve Duplicate Symbol Names</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044909" id="P7000497027000000000000000044909">The input to the linker is a collection of relocatable object modules. Each of these modules defines a set of symbols, some of which are local (visible only to the module that defines it), and some of which are global (visible to other modules). What happens if multiple modules define global symbols with the same name? Here is the approach that Linux compilation systems use.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004490A" id="P700049702700000000000000004490A">At compile time, the compiler exports each global symbol to the assembler as either <i class="pcalibre17 pcalibre2 pcalibre1">strong</i> or <i class="pcalibre17 pcalibre2 pcalibre1">weak</i>, and the assembler encodes this information implicitly in the symbol table of the relocatable object file. Functions and initialized global variables get strong symbols. Uninitialized global variables get weak symbols.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004490B" id="P700049702700000000000000004490B">Given this notion of strong and weak symbols, Linux linkers use the following rules for dealing with duplicate symbol names:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004490C" id="P700049702700000000000000004490C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004490D" id="P700049702700000000000000004490D"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P700049702700000000000000004490E" id="P700049702700000000000000004490E">Rule 1. Multiple strong symbols with the same name are not allowed.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004490F" id="P700049702700000000000000004490F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044910" id="P7000497027000000000000000044910">Rule 2. Given a strong symbol and multiple weak symbols with the same name, choose the strong symbol.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044911" id="P7000497027000000000000000044911"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044912" id="P7000497027000000000000000044912">Rule 3. Given multiple weak symbols with the same name, choose any of the weak symbols.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044913" id="P7000497027000000000000000044913">For example, suppose we attempt to compile and link the following two C modules:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044914" id="P7000497027000000000000000044914"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044915" id="P7000497027000000000000000044915">
1	/* foo1.c */
2	int main()
3	{
4		return 0;
5	}
1	/* bar1.c */
2	int main()
3	{
4		return 0;
5	}</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044916" id="P7000497027000000000000000044916"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006184" epub:type="pagebreak" id="P7000497027000000000000000006184" title="681"></span>In this case, the linker will generate an error message because the strong symbol main is defined multiple times (rule 1):</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044917" id="P7000497027000000000000000044917"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044918" id="P7000497027000000000000000044918">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc foo1.c bar1.c</i>
/tmp/ccq2Uxnd.o: In function `main':
bar1.c:(.text+0x0): multiple definition of `main'</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044919" id="P7000497027000000000000000044919">Similarly, the linker will generate an error message for the following modules because the strong symbol <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004491A" id="P700049702700000000000000004491A">x</code> is defined twice (rule 1):</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004491B" id="P700049702700000000000000004491B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004491C" id="P700049702700000000000000004491C">
1	/* foo2.c */
2	int x = 15213;
3
4	int main()
5	{
6		return 0;
7	}
</code></pre>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004491D" id="P700049702700000000000000004491D"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004491E" id="P700049702700000000000000004491E">
1	/* bar2.c */
2	int x = 15213;
3
4	void f()
5	{
6	}</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004491F" id="P700049702700000000000000004491F">However, if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044920" id="P7000497027000000000000000044920">x</code> is uninitialized in one module, then the linker will quietly choose the strong symbol defined in the other (rule 2):</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044921" id="P7000497027000000000000000044921"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044922" id="P7000497027000000000000000044922">
1	/* foo3.c */
2	#include &lt;stdio.h&gt;
3	void f(void);
4
5	int x = 15213;
6
7	int main()
8	{
9		f();
10		printf(x = %dn, x);
11		return 0;
12	}
</code></pre>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044923" id="P7000497027000000000000000044923"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044924" id="P7000497027000000000000000044924">
1	/* bar3.c */
2	int x;
3
4	void f()
5	{
6		x = 15212;
7	}</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044925" id="P7000497027000000000000000044925"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006194" epub:type="pagebreak" id="P7000497027000000000000000006194" title="682"></span>At run time, function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044926" id="P7000497027000000000000000044926">f</code> changes the value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044927" id="P7000497027000000000000000044927">x</code> from 15213 to 15212, which might come as an unwelcome surprise to the author of function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044928" id="P7000497027000000000000000044928">main</code>! Notice that the linker normally gives no indication that it has detected multiple definitions of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044929" id="P7000497027000000000000000044929">x</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004492A" id="P700049702700000000000000004492A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004492B" id="P700049702700000000000000004492B">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -o foobar3 foo3.c bar3.c</i>
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1"> ./foobar3</i>
x = 15212</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004492C" id="P700049702700000000000000004492C">The same thing can happen if there are two weak definitions of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004492D" id="P700049702700000000000000004492D">x</code> (rule 3):</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004492E" id="P700049702700000000000000004492E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004492F" id="P700049702700000000000000004492F">
1	/* foo4.c */
2	#include &lt;stdio.h&gt;
3	void f(void);
4
5	int x;
6
7	int main()
8	{
9		x = 15213;
10		f();
11		printf(x = %dn, x);
12		return 0;
13	}
</code></pre>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044930" id="P7000497027000000000000000044930"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044931" id="P7000497027000000000000000044931">
1	/* bar4.c */
2	int x;
3
4	void f()
5	{
6		x = 15212;
7	}</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044932" id="P7000497027000000000000000044932">The application of rules 2 and 3 can introduce some insidious run-time bugs that are incomprehensible to the unwary programmer, especially if the duplicate symbol definitions have different types. Consider the following example, in which <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044933" id="P7000497027000000000000000044933">x</code> is inadvertently defined as an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044934" id="P7000497027000000000000000044934">int</code> in one module and a double in another:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044935" id="P7000497027000000000000000044935"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044936" id="P7000497027000000000000000044936">
1	/* foo5.c */
2	#include &lt;stdio.h&gt;
3	void f(void);
4
5	int y = 15212;
6	int x = 15213;
7
8	int main()
9	{
10		f();
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000061A6" epub:type="pagebreak" id="P70004970270000000000000000061A6" title="683"></span>11		printf(x = 0x%x y = 0x%x n,
12			x, y);
13		return 0;
14	}
</code></pre>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044937" id="P7000497027000000000000000044937"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044938" id="P7000497027000000000000000044938">
1	/* bar5.c */
2	double x;
3
4	void f()
5	{
6		x = -0.0;
7	}</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044939" id="P7000497027000000000000000044939">On an x86-64/Linux machine, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004493A" id="P700049702700000000000000004493A">doubles</code> are 8 bytes and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004493B" id="P700049702700000000000000004493B">ints</code> are 4 bytes. On our system, the address of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004493C" id="P700049702700000000000000004493C">x</code> is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004493D" id="P700049702700000000000000004493D">0x601020</code> and the address of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004493E" id="P700049702700000000000000004493E">y</code> is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004493F" id="P700049702700000000000000004493F">0x601024</code>. Thus, the assignment <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044940" id="P7000497027000000000000000044940">x</code> = <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044941" id="P7000497027000000000000000044941">-0.0</code> in line 6 of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044942" id="P7000497027000000000000000044942">bar5.c</code> will overwrite the memory locations for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044943" id="P7000497027000000000000000044943">x</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044944" id="P7000497027000000000000000044944">y</code> (lines 5 and 6 in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044945" id="P7000497027000000000000000044945">foo5.c</code>) with the double-precision floating-point representation of negative zero!</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044946" id="P7000497027000000000000000044946"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044947" id="P7000497027000000000000000044947">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Wall -0g -o foobar5 foo5.c bar5.c</i>
/usr/bin/ld: Warning: alignment 4 of symbol `x' in /tmp/cclUFK5g.o
is smaller than 8 in /tmp/ccbTLcb9.o
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">./foobar5</i>
x = 0x0 y = 0x80000000</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044948" id="P7000497027000000000000000044948">This is a subtle and nasty bug, especially because it triggers only a warning from the linker, and because it typically manifests itself much later in the execution of the program, far away from where the error occurred. In a large system with hundreds of modules, a bug of this kind is extremely hard to fix, especially because many programmers are not aware of how linkers work, and because they often ignore compiler warnings. When in doubt, invoke the linker with a flag such as the <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044949" id="P7000497027000000000000000044949">-fno-common</code> flag, which triggers an error if it encounters multiply-defined global symbols. Or use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004494A" id="P700049702700000000000000004494A">-Werror</code> option, which turns all warnings into errors.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004494B" id="P700049702700000000000000004494B">In <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000608B.xhtml#P700049702700000000000000000608B"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">7.5</span></a>, we saw how the compiler assigns symbols to COMMON and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004494C" id="P700049702700000000000000004494C">.bss</code> using a seemingly arbitrary convention. Actually, this convention is due to the fact that in some cases the linker allows multiple modules to define global symbols with the same name. When the compiler is translating some module and encounters a weak global symbol, say, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004494D" id="P700049702700000000000000004494D">x</code>, it does not know if other modules also define <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004494E" id="P700049702700000000000000004494E">x</code>, and if so, it cannot predict which of the multiple instances of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004494F" id="P700049702700000000000000004494F">x</code> the linker might choose. So the compiler defers the decision to the linker by assigning <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044950" id="P7000497027000000000000000044950">x</code> to COMMON. On the other hand, if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044951" id="P7000497027000000000000000044951">x</code> is initialized to zero, then it is a strong symbol (and thus must be unique by rule 2), so the compiler can confidently assign it to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044952" id="P7000497027000000000000000044952">.bss</code>. Similarly, static symbols are unique by construction, so the compiler can confidently assign them to either <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044953" id="P7000497027000000000000000044953">.data</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044954" id="P7000497027000000000000000044954">.bss</code>.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000061C5" epub:type="practice" id="P70004970270000000000000000061C5"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044955" epub:type="title" id="P7000497027000000000000000044955"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000061C7" epub:type="pagebreak" id="P70004970270000000000000000061C7" title="684"></span><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.2 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000065E7.xhtml#P70004970270000000000000000065EF">718</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter07.xhtml#P7000497027000000000000000044956" id="P7000497027000000000000000044956">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter07.xhtml#P7000497027000000000000000044957" id="P7000497027000000000000000044957">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044958" id="P7000497027000000000000000044958"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044959" id="P7000497027000000000000000044959">In this problem, let <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004495A" id="P700049702700000000000000004495A">REF(x.i)  DEF(x.k)</code> denote that the linker will associate an arbitrary reference to symbol <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004495B" id="P700049702700000000000000004495B">x</code> in module <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004495C" id="P700049702700000000000000004495C">i</code> to the definition of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004495D" id="P700049702700000000000000004495D">x</code> in module <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004495E" id="P700049702700000000000000004495E">k</code>. For each example that follows, use this notation to indicate how the linker would resolve references to the multiply-defined symbol in each module. If there is a link-time error (rule 1), write "<span class="pcalibre1 pcalibre29 pcalibre2">error</span>". If the linker arbitrarily chooses one of the definitions (rule 3), write "<span class="pcalibre1 pcalibre29 pcalibre2">unknown</span>".</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P700049702700000000000000004495F" id="P700049702700000000000000004495F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044960" id="P7000497027000000000000000044960"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044961" id="P7000497027000000000000000044961"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044962" id="P7000497027000000000000000044962"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044963" id="P7000497027000000000000000044963">/* Module 1 */		/* Module 2 */
int main()		int main;
{			int p2()
}			{
			}
(a) REF(main.1)  DEF(_____._____)
(b) REF(main.2)  DEF(_____._____)</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044964" id="P7000497027000000000000000044964"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044965" id="P7000497027000000000000000044965"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044966" id="P7000497027000000000000000044966"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044967" id="P7000497027000000000000000044967">/* Module 1 */		/* Module 2 */
void main()		int main = 1;
{			int p2()
}			{
			}
(a) REF(main.1)  DEF(_____._____)
(b) REF(main.2)  DEF(_____._____)</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044968" id="P7000497027000000000000000044968"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044969" id="P7000497027000000000000000044969"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004496A" id="P700049702700000000000000004496A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004496B" id="P700049702700000000000000004496B">/* Module 1 */		/* Module 2 */
intx;			doublex=1.0;
void main()		int p2()
{			{
}			}
(a) REF(x.1)  DEF(_____._____)
(b) REF(x.2)  DEF(_____._____)</code></pre>
</li></ol></div></li>
</ol>
</section>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000061DE" id="P70004970270000000000000000061DE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004496C" epub:type="title" id="P700049702700000000000000004496C"><span class="pcalibre1 pcalibre21 pcalibre2">7.6.2 </span>Linking with Static Libraries</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004496D" id="P700049702700000000000000004496D">So far, we have assumed that the linker reads a collection of relocatable object files and links them together into an output executable file. In practice, all compilation systems provide a mechanism for packaging related object modules into a single file called a <i class="pcalibre17 pcalibre2 pcalibre1">static library</i>, which can then be supplied as input to the linker. When it builds the output executable, the linker copies only the object modules in the library that are referenced by the application program.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004496E" id="P700049702700000000000000004496E">Why do systems support the notion of libraries? Consider ISO C99, which defines an extensive collection of standard I/O, string manipulation, and integer math functions such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004496F" id="P700049702700000000000000004496F">atoi, printf, scanf, strcpy</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044970" id="P7000497027000000000000000044970">rand</code>. They are available <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000061E4" epub:type="pagebreak" id="P70004970270000000000000000061E4" title="685"></span>to every C program in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044971" id="P7000497027000000000000000044971">libc.a</code> library. ISO C99 also defines an extensive collection of floating-point math functions such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044972" id="P7000497027000000000000000044972">sin, cos</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044973" id="P7000497027000000000000000044973">sqrt</code> in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044974" id="P7000497027000000000000000044974">libm.a</code> library.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044975" id="P7000497027000000000000000044975">Consider the different approaches that compiler developers might use to provide these functions to users without the benefit of static libraries. One approach would be to have the compiler recognize calls to the standard functions and to generate the appropriate code directly. Pascal, which provides a small set of standard functions, takes this approach, but it is not feasible for C, because of the large number of standard functions defined by the C standard. It would add significant complexity to the compiler and would require a new compiler version each time a function was added, deleted, or modified. To application programmers, however, this approach would be quite convenient because the standard functions would always be available.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044976" id="P7000497027000000000000000044976">Another approach would be to put all of the standard C functions in a single relocatable object module, say, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044977" id="P7000497027000000000000000044977">libc.o</code>, that application programmers could link into their executables:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044978" id="P7000497027000000000000000044978"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044979" id="P7000497027000000000000000044979">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc main.c /usr/lib/libc.o</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004497A" id="P700049702700000000000000004497A">This approach has the advantage that it would decouple the implementation of the standard functions from the implementation of the compiler, and would still be reasonably convenient for programmers. However, a big disadvantage is that every executable file in a system would now contain a complete copy of the collection of standard functions, which would be extremely wasteful of disk space. (On our system, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004497B" id="P700049702700000000000000004497B">libc.a</code> is about 5 MB and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004497C" id="P700049702700000000000000004497C">libm.a</code> is about 2 MB.) Worse, each running program would now contain its own copy of these functions in memory, which would be extremely wasteful of memory. Another big disadvantage is that any change to any standard function, no matter how small, would require the library developer to recompile the entire source file, a time-consuming operation that would complicate the development and maintenance of the standard functions.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004497D" id="P700049702700000000000000004497D">We could address some of these problems by creating a separate relocatable file for each standard function and storing them in a well-known directory. However, this approach would require application programmers to explicitly link the appropriate object modules into their executables, a process that would be error prone and time consuming:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004497E" id="P700049702700000000000000004497E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004497F" id="P700049702700000000000000004497F">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc main.c /usr/lib/printf.o /usr/lib/scanf.o . . .</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044980" id="P7000497027000000000000000044980">The notion of a static library was developed to resolve the disadvantages of these various approaches. Related functions can be compiled into separate object modules and then packaged in a single static library file. Application programs can then use any of the functions defined in the library by specifying a single filename on the command line. For example, a program that uses functions from the C standard library and the math library could be compiled and linked with a command of the form</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044981" id="P7000497027000000000000000044981"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044982" id="P7000497027000000000000000044982">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc main.c /usr/lib/libm.a /usr/lib/libc.a</i></code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P70004970270000000000000000061F7" id="P70004970270000000000000000061F7">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000061F8" epub:type="pagebreak" id="P70004970270000000000000000061F8" title="686"></span>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044983" id="P7000497027000000000000000044983">(a) <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044984" id="P7000497027000000000000000044984">addvec.o</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044985" id="P7000497027000000000000000044985">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/addvec.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044986" id="P7000497027000000000000000044986"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044987" id="P7000497027000000000000000044987">
1	int addcnt = 0; 2
3	void addvec(int *x, int *y,
4				int *z, int n)
5	{
6		int i;
7
8		addcnt++;
9
10		for (i = 0; i &lt; n; i++)
11			z[i] = x[i] + y[i];
12	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044988" id="P7000497027000000000000000044988">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/addvec.c</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044989" id="P7000497027000000000000000044989">(b) <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004498A" id="P700049702700000000000000004498A">multvec.o</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004498B" id="P700049702700000000000000004498B">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/multvec.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P700049702700000000000000004498C" id="P700049702700000000000000004498C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004498D" id="P700049702700000000000000004498D">
1	int multcnt = 0;
2
3	void multvec(int *x, int *y,
4			int *z, int n)
5	{
6		int i;
7
8		multcnt++;
9
10		for (i = 0; i &lt; n; i++)
11			z[i] = x[i] * y[i];
12	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004498E" id="P700049702700000000000000004498E">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/multvec.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P700049702700000000000000004498F" id="P700049702700000000000000004498F"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044990" epub:type="title" id="P7000497027000000000000000044990"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.6 </span>Member object files in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044991" id="P7000497027000000000000000044991">libvector</code> library.</h1></header>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044992" id="P7000497027000000000000000044992">At link time, the linker will only copy the object modules that are referenced by the program, which reduces the size of the executable on disk and in memory. On the other hand, the application programmer only needs to include the names of a few library files. (In fact, C compiler drivers always pass <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044993" id="P7000497027000000000000000044993">libc.a</code> to the linker, so the reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044994" id="P7000497027000000000000000044994">libc.a</code> mentioned previously is unnecessary.)</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044995" id="P7000497027000000000000000044995">On Linux systems, static libraries are stored on disk in a particular file format known as an <i class="pcalibre17 pcalibre2 pcalibre1">archive</i>. An archive is a collection of concatenated relocatable object files, with a header that describes the size and location of each member object file. Archive filenames are denoted with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044996" id="P7000497027000000000000000044996">.a suffix.</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044997" id="P7000497027000000000000000044997">To make our discussion of libraries concrete, consider the pair of vector routines in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000061F7"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.6</span></a>. Each routine, defined in its own object module, performs a vector operation on a pair of input vectors and stores the result in an output vector. As a side effect, each routine records the number of times it has been called by incrementing a global variable. (This will be useful when we explain the idea of position-independent code in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006428.xhtml#P7000497027000000000000000006428"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">7.12</span></a>.)</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044998" id="P7000497027000000000000000044998">To create a static library of these functions, we would use the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044999" id="P7000497027000000000000000044999"><span class="pcalibre1 pcalibre29 pcalibre2">ar</span></code> tool as follows:</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004499A" id="P700049702700000000000000004499A"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004499B" id="P700049702700000000000000004499B">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -c addvec.c multvec.c</i></code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004499C" id="P700049702700000000000000004499C"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004499D" id="P700049702700000000000000004499D">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">ar rcs libvector.a addvec.o multvec.o</i></code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004499E" id="P700049702700000000000000004499E">To use the library, we might write an application such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000004499F" id="P700049702700000000000000004499F">main2.c</code> in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000621E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.7</span></a>, which invokes the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449A0" id="P70004970270000000000000000449A0">addvec</code> library routine. The include (or header) file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449A1" id="P70004970270000000000000000449A1">vector.h</code> defines the function prototypes for the routines in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449A2" id="P70004970270000000000000000449A2">libvector.a</code>,</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449A3" id="P70004970270000000000000000449A3">To build the executable, we would compile and link the input files <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449A4" id="P70004970270000000000000000449A4">main2.o</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449A5" id="P70004970270000000000000000449A5">libvector.a</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449A6" id="P70004970270000000000000000449A6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449A7" id="P70004970270000000000000000449A7">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -c main2.c</i>
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -static -o prog2c main2.o . /libvector.a</i></code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P700049702700000000000000000621E" id="P700049702700000000000000000621E">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000621F" epub:type="pagebreak" id="P700049702700000000000000000621F" title="687"></span>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449A8" id="P70004970270000000000000000449A8">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/main2.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449A9" id="P70004970270000000000000000449A9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449AA" id="P70004970270000000000000000449AA">
1	#include &lt;stdio.h&gt;
2	#include "vector.h"
3
4	int x[2] = {1, 2};
5	int y[2] = {3, 4};
6	int z[2];
7
8	int main()
9	{
10		addvec(x, y, z, 2);
11		printf("z = [%d %d] n", z[0], z[1]);
12		return 0;
13	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449AB" id="P70004970270000000000000000449AB">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/main2.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P70004970270000000000000000449AC" id="P70004970270000000000000000449AC"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P70004970270000000000000000449AD" epub:type="title" id="P70004970270000000000000000449AD"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.7 </span>Example program 2.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449AE" id="P70004970270000000000000000449AE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449AF" id="P70004970270000000000000000449AF">This program invokes a function in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449B0" id="P70004970270000000000000000449B0">libvector</code> library.</p></div></figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P7000497027000000000000000006229" id="P7000497027000000000000000006229">
<img alt="A diagram illustrates linking with static libraries." class="pcalibre1 pcalibre2 pcalibre237" data-uri="P700049702700000000000000000B75A" id="P70004970270000000000000000449B1" src="Images/chapter-06-image-03.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P70004970270000000000000000449B2" id="P70004970270000000000000000449B2"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P70004970270000000000000000449B3" epub:type="title" id="P70004970270000000000000000449B3"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.8 </span>Linking with static libraries.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter07.xhtml#P7000497027000000000000000024CC5" id="P7000497027000000000000000024CC5">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449B4" id="P70004970270000000000000000449B4">A diagram shows a flow of files, as listed in order below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter07.xhtml#P70004970270000000000000000449B5" id="P70004970270000000000000000449B5">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449B6" id="P70004970270000000000000000449B6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449B7" id="P70004970270000000000000000449B7">Source files: main2.c and vector.h</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449B8" id="P70004970270000000000000000449B8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449B9" id="P70004970270000000000000000449B9">Translators (cpp, cc1, as)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449BA" id="P70004970270000000000000000449BA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449BB" id="P70004970270000000000000000449BB">Three relocatable object files:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter07.xhtml#P70004970270000000000000000449BC" id="P70004970270000000000000000449BC">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449BD" id="P70004970270000000000000000449BD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449BE" id="P70004970270000000000000000449BE">Main2.o from translators</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449BF" id="P70004970270000000000000000449BF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449C0" id="P70004970270000000000000000449C0">Addvec.o from libvector.a</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449C1" id="P70004970270000000000000000449C1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449C2" id="P70004970270000000000000000449C2">Printf.o and any other modules called by printf.o from libc.a Static libraries</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449C3" id="P70004970270000000000000000449C3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449C4" id="P70004970270000000000000000449C4">Linter (ld)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449C5" id="P70004970270000000000000000449C5"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449C6" id="P70004970270000000000000000449C6">Fully linked executable object file prog2c</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449C7" id="P70004970270000000000000000449C7">or equivalently,</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449C8" id="P70004970270000000000000000449C8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449C9" id="P70004970270000000000000000449C9">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -c main2.c</i>
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -static -o prog2c main2.o -L. -lvector</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449CA" id="P70004970270000000000000000449CA"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006229"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.8</span></a> summarizes the activity of the linker. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449CB" id="P70004970270000000000000000449CB">-static</code> argument tells the compiler driver that the linker should build a fully linked executable object file that can be loaded into memory and run without any further linking at load time. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449CC" id="P70004970270000000000000000449CC">-lvector</code> argument is a shorthand for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449CD" id="P70004970270000000000000000449CD">libvector.a</code>, and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449CE" id="P70004970270000000000000000449CE">-L</code>. argument tells the linker to look for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449CF" id="P70004970270000000000000000449CF">libvector.a</code> in the current directory.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D0" id="P70004970270000000000000000449D0">When the linker runs, it determines that the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D1" id="P70004970270000000000000000449D1">addvec</code> symbol defined by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D2" id="P70004970270000000000000000449D2">addvec.o</code> is referenced by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D3" id="P70004970270000000000000000449D3">main2.o</code>, so it copies <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D4" id="P70004970270000000000000000449D4">addvec.o</code> into the executable. <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000623B" epub:type="pagebreak" id="P700049702700000000000000000623B" title="688"></span>Since the program doesn't reference any symbols defined by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D5" id="P70004970270000000000000000449D5">multvec.o</code>, the linker does <i class="pcalibre17 pcalibre2 pcalibre1">not</i> copy this module into the executable. The linker also copies the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D6" id="P70004970270000000000000000449D6">printf.o</code> module from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D7" id="P70004970270000000000000000449D7">libc.a</code>, along with a number of other modules from the C run-time system.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P700049702700000000000000000623F" id="P700049702700000000000000000623F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D8" epub:type="title" id="P70004970270000000000000000449D8"><span class="pcalibre1 pcalibre21 pcalibre2">7.6.3 </span>How Linkers Use Static Libraries to Resolve References</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449D9" id="P70004970270000000000000000449D9">While static libraries are useful, they are also a source of confusion to programmers because of the way the Linux linker uses them to resolve external references. During the symbol resolution phase, the linker scans the relocatable object files and archives left to right in the same sequential order that they appear on the compiler driver's command line. (The driver automatically translates any <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449DA" id="P70004970270000000000000000449DA">.c files</code> on the command line into <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449DB" id="P70004970270000000000000000449DB">.o files</code>.) During this scan, the linker maintains a set <var class="pcalibre17 pcalibre2 pcalibre1">E</var> of relocatable object files that will be merged to form the executable, a set <var class="pcalibre17 pcalibre2 pcalibre1">U</var> of unresolved symbols (i.e., symbols referred to but not yet defined), and a set <var class="pcalibre17 pcalibre2 pcalibre1">D</var> of symbols that have been defined in previous input files. Initially, <var class="pcalibre17 pcalibre2 pcalibre1">E</var>, <var class="pcalibre17 pcalibre2 pcalibre1">U</var>, and <var class="pcalibre17 pcalibre2 pcalibre1">D</var> are empty.</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449DC" id="P70004970270000000000000000449DC">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449DD" id="P70004970270000000000000000449DD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449DE" id="P70004970270000000000000000449DE">For each input file <var class="pcalibre17 pcalibre2 pcalibre1">f</var> on the command line, the linker determines if <var class="pcalibre17 pcalibre2 pcalibre1">f</var> is an object file or an archive. If <var class="pcalibre17 pcalibre2 pcalibre1">f</var> is an object file, the linker adds <var class="pcalibre17 pcalibre2 pcalibre1">f</var> to <var class="pcalibre17 pcalibre2 pcalibre1">E</var>, updates <var class="pcalibre17 pcalibre2 pcalibre1">U</var> and <var class="pcalibre17 pcalibre2 pcalibre1">D</var> to reflect the symbol definitions and references in <var class="pcalibre17 pcalibre2 pcalibre1">f</var>, and proceeds to the next input file.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449DF" id="P70004970270000000000000000449DF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449E0" id="P70004970270000000000000000449E0">If <var class="pcalibre17 pcalibre2 pcalibre1">f</var> is an archive, the linker attempts to match the unresolved symbols in <var class="pcalibre17 pcalibre2 pcalibre1">U</var> against the symbols defined by the members of the archive. If some archive member <var class="pcalibre17 pcalibre2 pcalibre1">m</var> defines a symbol that resolves a reference in <var class="pcalibre17 pcalibre2 pcalibre1">U</var>, then <var class="pcalibre17 pcalibre2 pcalibre1">m</var> is added to <var class="pcalibre17 pcalibre2 pcalibre1">E</var>, and the linker updates <var class="pcalibre17 pcalibre2 pcalibre1">U</var> and <var class="pcalibre17 pcalibre2 pcalibre1">D</var> to reflect the symbol definitions and references in <var class="pcalibre17 pcalibre2 pcalibre1">m</var>. This process iterates over the member object files in the archive until a fixed point is reached where <var class="pcalibre17 pcalibre2 pcalibre1">U</var> and <var class="pcalibre17 pcalibre2 pcalibre1">D</var> no longer change. At this point, any member object files not contained in <var class="pcalibre17 pcalibre2 pcalibre1">E</var> are simply discarded and the linker proceeds to the next input file.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449E1" id="P70004970270000000000000000449E1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P70004970270000000000000000449E2" id="P70004970270000000000000000449E2">If <var class="pcalibre17 pcalibre2 pcalibre1">U</var> is nonempty when the linker finishes scanning the input files on the command line, it prints an error and terminates. Otherwise, it merges and relocates the object files in <var class="pcalibre17 pcalibre2 pcalibre1">E</var> to build the output executable file.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449E3" id="P70004970270000000000000000449E3">Unfortunately, this algorithm can result in some baffling link-time errors because the ordering of libraries and object files on the command line is significant. If the library that defines a symbol appears on the command line before the object file that references that symbol, then the reference will not be resolved and linking will fail. For example, consider the following:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449E4" id="P70004970270000000000000000449E4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449E5" id="P70004970270000000000000000449E5">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -static . /libvector.a main2.c</i>
/tmp/cc9XH6Rp.o: In function `main':
/tmp/cc9XH6Rp.o(.text+0x18): undefined reference to `addvec'</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449E6" id="P70004970270000000000000000449E6">What happened? When <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449E7" id="P70004970270000000000000000449E7">libvector.a</code> is processed, <var class="pcalibre17 pcalibre2 pcalibre1">U</var> is empty, so no member object files from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449E8" id="P70004970270000000000000000449E8">libvector.a</code> are added to <var class="pcalibre17 pcalibre2 pcalibre1">E</var>. Thus, the reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449E9" id="P70004970270000000000000000449E9">addvec</code> is never resolved and the linker emits an error message and terminates.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449EA" id="P70004970270000000000000000449EA"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006253" epub:type="pagebreak" id="P7000497027000000000000000006253" title="689"></span>The general rule for libraries is to place them at the end of the command line. If the members of the different libraries are independent, in that no member references a symbol defined by another member, then the libraries can be placed at the end of the command line in any order. If, on the other hand, the libraries are not independent, then they must be ordered so that for each symbol <var class="pcalibre17 pcalibre2 pcalibre1">s</var> that is referenced externally by a member of an archive, at least one definition of <var class="pcalibre17 pcalibre2 pcalibre1">s</var> follows a reference to <var class="pcalibre17 pcalibre2 pcalibre1">s</var> on the command line. For example, suppose <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449EB" id="P70004970270000000000000000449EB">foo.c</code> calls functions in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449EC" id="P70004970270000000000000000449EC">libx.a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449ED" id="P70004970270000000000000000449ED">libz.a</code> that call functions in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449EE" id="P70004970270000000000000000449EE">liby.a</code>. Then <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449EF" id="P70004970270000000000000000449EF">libx.a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449F0" id="P70004970270000000000000000449F0">libz.a</code> must precede <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449F1" id="P70004970270000000000000000449F1">liby.a</code> on the command line:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449F2" id="P70004970270000000000000000449F2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449F3" id="P70004970270000000000000000449F3">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc foo.c libx.a libz.a liby.a</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449F4" id="P70004970270000000000000000449F4">Libraries can be repeated on the command line if necessary to satisfy the dependence requirements. For example, suppose <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449F5" id="P70004970270000000000000000449F5">foo.c</code> calls a function in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449F6" id="P70004970270000000000000000449F6">libx.a</code> that calls a function in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449F7" id="P70004970270000000000000000449F7">liby.a</code> that calls a function in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449F8" id="P70004970270000000000000000449F8">libx.a</code>. Then <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449F9" id="P70004970270000000000000000449F9">libx.a</code> must be repeated on the command line:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P70004970270000000000000000449FA" id="P70004970270000000000000000449FA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449FB" id="P70004970270000000000000000449FB">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc foo.c libx.a liby.a libx.a</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449FC" id="P70004970270000000000000000449FC">Alternatively, we could combine <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449FD" id="P70004970270000000000000000449FD">libx.a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449FE" id="P70004970270000000000000000449FE">liby.a</code> into a single archive.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006268" epub:type="practice" id="P7000497027000000000000000006268"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000449FF" epub:type="title" id="P70004970270000000000000000449FF"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.3 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000065E7.xhtml#P70004970270000000000000000065EF">718</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter07.xhtml#P7000497027000000000000000044A00" id="P7000497027000000000000000044A00">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter07.xhtml#P7000497027000000000000000044A01" id="P7000497027000000000000000044A01">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044A02" id="P7000497027000000000000000044A02"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A03" id="P7000497027000000000000000044A03">Let <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A04" id="P7000497027000000000000000044A04">a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A05" id="P7000497027000000000000000044A05">b</code> denote object modules or static libraries in the current directory, and let <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A06" id="P7000497027000000000000000044A06">ab</code> denote that <var class="pcalibre17 pcalibre2 pcalibre1">a</var> depends on <var class="pcalibre17 pcalibre2 pcalibre1">b</var>, in the sense that <var class="pcalibre17 pcalibre2 pcalibre1">b</var> defines a symbol that is referenced by <var class="pcalibre17 pcalibre2 pcalibre1">a</var>. For each of the following scenarios, show the minimal command line (i.e., one with the least number of object file and library arguments) that will allow the static linker to resolve all symbol references.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P7000497027000000000000000044A07" id="P7000497027000000000000000044A07">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A08" id="P7000497027000000000000000044A08"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A09" id="P7000497027000000000000000044A09"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A0A" id="P7000497027000000000000000044A0A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A0B" id="P7000497027000000000000000044A0B">p.o  libx.a</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A0C" id="P7000497027000000000000000044A0C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A0D" id="P7000497027000000000000000044A0D"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A0E" id="P7000497027000000000000000044A0E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A0F" id="P7000497027000000000000000044A0F">p.o  libx.a  liby.a</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A10" id="P7000497027000000000000000044A10"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A11" id="P7000497027000000000000000044A11"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A12" id="P7000497027000000000000000044A12"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A13" id="P7000497027000000000000000044A13">p.o  libx.a  liby.a <i class="pcalibre17 pcalibre2 pcalibre1">and</i> liby.a  libx.a  p.o</code></pre>
</li>
</ol></div>
</li></ol>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.7 Relocation</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P700049702700000000000000000627E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044A14" epub:type="title" id="P7000497027000000000000000044A14"><span class="pcalibre1 pcalibre21 pcalibre2">7.7 </span>Relocation</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A15" id="P7000497027000000000000000044A15">Once the linker has completed the symbol resolution step, it has associated each symbol reference in the code with exactly one symbol definition (i.e., a symbol table entry in one of its input object modules). At this point, the linker knows the exact sizes of the code and data sections in its input object modules. It is now ready to begin the relocation step, where it merges the input modules and assigns run-time addresses to each symbol. Relocation consists of two steps:</p>
<ol class="pcalibre1 calibre19 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A16" id="P7000497027000000000000000044A16">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A17" id="P7000497027000000000000000044A17"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A18" id="P7000497027000000000000000044A18"><span class="pcalibre1 pcalibre2 pcalibre41">Relocating sections and symbol definitions. </span>In this step, the linker merges all sections of the same type into a new aggregate section of the same type. For example, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A19" id="P7000497027000000000000000044A19">.data</code> sections from the input modules are all merged into one section that will become the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A1A" id="P7000497027000000000000000044A1A">.data</code> section for the output executable object <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006286" epub:type="pagebreak" id="P7000497027000000000000000006286" title="690"></span>file. The linker then assigns run-time memory addresses to the new aggregate sections, to each section defined by the input modules, and to each symbol defined by the input modules. When this step is complete, each instruction and global variable in the program has a unique run-time memory address.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A1B" id="P7000497027000000000000000044A1B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A1C" id="P7000497027000000000000000044A1C"><span class="pcalibre1 pcalibre2 pcalibre41">Relocating symbol references within sections. </span>In this step, the linker modifies every symbol reference in the bodies of the code and data sections so that they point to the correct run-time addresses. To perform this step, the linker relies on data structures in the relocatable object modules known as relocation entries, which we describe next.</p></li>
</ol>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006289" id="P7000497027000000000000000006289"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A1D" epub:type="title" id="P7000497027000000000000000044A1D"><span class="pcalibre1 pcalibre21 pcalibre2">7.7.1 </span>Relocation Entries</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A1E" id="P7000497027000000000000000044A1E">When an assembler generates an object module, it does not know where the code and data will ultimately be stored in memory. Nor does it know the locations of any externally defined functions or global variables that are referenced by the module. So whenever the assembler encounters a reference to an object whose ultimate location is unknown, it generates a <i class="pcalibre17 pcalibre2 pcalibre1">relocation entry</i> that tells the linker how to modify the reference when it merges the object file into an executable. Relocation entries for code are placed in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A1F" id="P7000497027000000000000000044A1F">.rel.text</code>. Relocation entries for data are placed in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A20" id="P7000497027000000000000000044A20">.rel.data.</code></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A21" id="P7000497027000000000000000044A21"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006298"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.9</span></a> shows the format of an ELF relocation entry. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A22" id="P7000497027000000000000000044A22">offset</code> is the section offset of the reference that will need to be modified. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A23" id="P7000497027000000000000000044A23">symbol</code> identifies the symbol that the modified reference should point to. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A24" id="P7000497027000000000000000044A24">type</code> tells the linker how to modify the new reference. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A25" id="P7000497027000000000000000044A25">addend</code> is a signed constant that is used by some types of relocations to bias the value of the modified reference.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A26" id="P7000497027000000000000000044A26">ELF defines 32 different relocation types, many quite arcane. We are concerned with only the two most basic relocation types:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A27" id="P7000497027000000000000000044A27">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A28" id="P7000497027000000000000000044A28"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044A29" id="P7000497027000000000000000044A29"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A2A" id="P7000497027000000000000000044A2A">R_X86_64_PC32.</code> Relocate a reference that uses a 32-bit PC-relative address. Recall from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002339_split_000.xhtml#P700049702700000000000000000244A"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.6.3</span></a> that a PC-relative address is an offset from the current run-time value of the program counter (PC). When the CPU executes an instruction using PC-relative addressing, it forms the <i class="pcalibre17 pcalibre2 pcalibre1">effective address</i> (e.g., the target of the call instruction) by adding the 32-bit value</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P7000497027000000000000000006298" id="P7000497027000000000000000006298">
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044A2B" id="P7000497027000000000000000044A2B">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/elfstructs.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A2C" id="P7000497027000000000000000044A2C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A2D" id="P7000497027000000000000000044A2D">
1	typedef struct {
2		long offset;		/* Offset of the reference to relocate */
3		long type:32,		/* Relocation type */
4			symbol:32;	/* Symbol table index */
5		long addend;		/* Constant part of relocation expression */
6	} Elf64_Rela;
</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044A2E" id="P7000497027000000000000000044A2E">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/elfstructs.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044A2F" id="P7000497027000000000000000044A2F"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044A30" epub:type="title" id="P7000497027000000000000000044A30"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.9 </span>ELF relocation entry.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A31" id="P7000497027000000000000000044A31"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A32" id="P7000497027000000000000000044A32">Each entry identifies a reference that must be relocated and specifies how to compute the modified reference.</p></div></figcaption>
</figure>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044A33" id="P7000497027000000000000000044A33"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000062A2" epub:type="pagebreak" id="P70004970270000000000000000062A2" title="691"></span>encoded in the instruction to the current run-time value of the PC, which is always the address of the next instruction in memory.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A34" id="P7000497027000000000000000044A34"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044A35" id="P7000497027000000000000000044A35"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A36" id="P7000497027000000000000000044A36">R_X86_64_32</code>. Relocate a reference that uses a 32-bit absolute address. With absolute addressing, the CPU directly uses the 32-bit value encoded in the instruction as the effective address, without further modifications.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A37" id="P7000497027000000000000000044A37">These two relocation types support the x86-64 <i class="pcalibre17 pcalibre2 pcalibre1">small code model</i>, which assumes that the total size of the code and data in the executable object file is smaller than 2 GB, and thus can be accessed at run-time using 32-bit PC-relative addresses. The small code model is the default for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A38" id="P7000497027000000000000000044A38"><span class="pcalibre1 pcalibre29 pcalibre2">gcc</span></code>. Programs larger than 2 GB can be compiled using the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A39" id="P7000497027000000000000000044A39">-mcmodel=medium</code> (<i class="pcalibre17 pcalibre2 pcalibre1">medium code model</i>) and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A3A" id="P7000497027000000000000000044A3A">-mcmodel=large</code> (<i class="pcalibre17 pcalibre2 pcalibre1">large code model</i>) flags, but we won't discuss those.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000062AA" id="P70004970270000000000000000062AA"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A3B" epub:type="title" id="P7000497027000000000000000044A3B"><span class="pcalibre1 pcalibre21 pcalibre2">7.7.2 </span>Relocating Symbol References</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A3C" id="P7000497027000000000000000044A3C"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000062B6"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.10</span></a> shows the pseudocode for the linker's relocation algorithm. Lines 1 and 2 iterate over each section <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A3D" id="P7000497027000000000000000044A3D">s</code> and each relocation entry <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A3E" id="P7000497027000000000000000044A3E">r</code> associated with each section. For concreteness, assume that each section <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A3F" id="P7000497027000000000000000044A3F">s</code> is an array of bytes and that each relocation entry <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A40" id="P7000497027000000000000000044A40">r</code> is a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A41" id="P7000497027000000000000000044A41">struct</code> of type <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A42" id="P7000497027000000000000000044A42">Elf64_Rela</code>, as defined in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006298"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.9</span></a>. Also, assume that when the algorithm runs, the linker has already chosen runtime addresses for each section (denoted <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A43" id="P7000497027000000000000000044A43">ADDR(s)</code>) and each symbol (denoted <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A44" id="P7000497027000000000000000044A44">ADDR(r.symbol)</code>). Line 3 computes the address in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A45" id="P7000497027000000000000000044A45">s</code> array of the 4-byte reference that needs to be relocated. If this reference uses PC-relative addressing, then it is relocated by lines 59. If the reference uses absolute addressing, then it is relocated by lines 1113.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P70004970270000000000000000062B6" id="P70004970270000000000000000062B6">
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A46" id="P7000497027000000000000000044A46"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A47" id="P7000497027000000000000000044A47">
1	foreach section s {
2		foreach relocation entry r {
3			refptr = s + r.offset; /* ptr to reference to be relocated */
4
5			/* Relocate a PC-relative reference */
6			if (r.type == R_X86_64_PC32) {
7				refaddr = ADDR(s) + r.offset; /* ref's run-time address */
8				*refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr);
9			}
10
11			/* Relocate an absolute reference */
12			if (r.type == R_X86_64_32)
13				*refptr = (unsigned) (ADDR(r.symbol) + r.addend);
14		}
15	}
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044A48" id="P7000497027000000000000000044A48"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044A49" epub:type="title" id="P7000497027000000000000000044A49"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.10 </span>Relocation algorithm.</h1></header>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P70004970270000000000000000062BC" id="P70004970270000000000000000062BC">
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A4A" id="P7000497027000000000000000044A4A"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000062B9" epub:type="pagebreak" id="P70004970270000000000000000062B9" title="692"></span>-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/main-relo.d</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A4B" id="P7000497027000000000000000044A4B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A4C" id="P7000497027000000000000000044A4C">
1	0000000000000000 &lt;main&gt;:
2	0: 4883ec08		sub		$0x8, %rsp
3	4: be 02 00 00 00	mov		$0x2, %esi
4	9: bf 00 00 00 00	mov		$0x0, %edi		<i class="pcalibre17 pcalibre2 pcalibre1">%edi = &amp;array</i>
5			a: R_X86_64_32 array				<i class="pcalibre17 pcalibre2 pcalibre1">Relocation entry</i>
6	e: e8 00 00 00 00	callq		13 &lt;main+0x13&gt;		<i class="pcalibre17 pcalibre2 pcalibre1">sum()</i>
7			f: R_X86_64_PC32 sum-0x4			<i class="pcalibre17 pcalibre2 pcalibre1">Relocation entry</i>
8	13: 4883c408		add		$0x8, %rsp
9	17:c3			retq
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A4D" id="P7000497027000000000000000044A4D">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/main-relo.d</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044A4E" id="P7000497027000000000000000044A4E"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044A4F" epub:type="title" id="P7000497027000000000000000044A4F"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.11 </span>Code and relocation entries from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A50" id="P7000497027000000000000000044A50">main.o.</code></h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A51" id="P7000497027000000000000000044A51"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A52" id="P7000497027000000000000000044A52">The original C code is in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000005FB4.xhtml#P7000497027000000000000000005FF0"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.1</span></a>.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A53" id="P7000497027000000000000000044A53">Let's see how the linker uses this algorithm to relocate the references in our example program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000005FB4.xhtml#P7000497027000000000000000005FF0"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.1</span></a>. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000062BC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.11</span></a> shows the disassembled code from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A54" id="P7000497027000000000000000044A54">main.o</code>, as generated by the GNU <span class="pcalibre1 pcalibre29 pcalibre2">objdump </span>tool (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A55" id="P7000497027000000000000000044A55">objdump -dx main.o</code>).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A56" id="P7000497027000000000000000044A56">The main function references two global symbols, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A57" id="P7000497027000000000000000044A57">array</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A58" id="P7000497027000000000000000044A58">sum</code>. For each reference, the assembler has generated a relocation entry, which is displayed on the following line.<a class="pcalibre1 pcalibre2 pcalibre56 pcalibre16 pcalibre14 pcalibre15" epub:type="noteref" href="#P7000497027000000000000000006664" id="r__P7000497027000000000000000006664">2</a> The relocation entries tell the linker that the reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A59" id="P7000497027000000000000000044A59">sum</code> should be relocated using a 32-bit PC-relative address, and the reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A5A" id="P7000497027000000000000000044A5A">array</code> should be relocated using a 32-bit absolute address. The next two sections detail how the linker relocates these references.</p><aside class="pcalibre2 pcalibre32 pcalibre57" data-uri="chapter07.xhtml#P7000497027000000000000000006664" epub:type="footnote" id="P7000497027000000000000000006664"><p class="pcalibre1 pcalibre2 pcalibre10"><span class="pcalibre1 pcalibre58 pcalibre2"><a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="#r__P7000497027000000000000000006664">2. </a></span>Recall that relocation entries and instructions are actually stored in different sections of the object file. The <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E55" id="P7000497027000000000000000044E55"><span class="pcalibre1 pcalibre29 pcalibre2">objdump</span></code> tool displays them together for convenience.</p></aside>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000062CE" id="P70004970270000000000000000062CE"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A5B" epub:type="title" id="P7000497027000000000000000044A5B">Relocating PC-Relative References</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A5C" id="P7000497027000000000000000044A5C">In line 6 in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000062BC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.11</span></a>, function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A5D" id="P7000497027000000000000000044A5D">main</code> calls the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A5E" id="P7000497027000000000000000044A5E">sum</code> function, which is defined in module <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A5F" id="P7000497027000000000000000044A5F">sum.o</code>. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A60" id="P7000497027000000000000000044A60">call</code> instruction begins at section offset <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A61" id="P7000497027000000000000000044A61">0xe</code> and consists of the 1-byte opcode <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A62" id="P7000497027000000000000000044A62">0xe8</code>, followed by a placeholder for the 32-bit PC-relative reference to the target <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A63" id="P7000497027000000000000000044A63">sum</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A64" id="P7000497027000000000000000044A64">The corresponding relocation entry <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A65" id="P7000497027000000000000000044A65">r</code> consists of four fields:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A66" id="P7000497027000000000000000044A66"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A67" id="P7000497027000000000000000044A67">
r.offset = 0xf
r.symbol = sum
r.type = R_X86_64_PC32
r.addend = -4
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A68" id="P7000497027000000000000000044A68">These fields tell the linker to modify the 32-bit PC-relative reference starting at offset <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A69" id="P7000497027000000000000000044A69">0xf</code> so that it will point to the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A6A" id="P7000497027000000000000000044A6A">sum</code> routine at run time. Now, suppose that the linker has determined that</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A6B" id="P7000497027000000000000000044A6B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A6C" id="P7000497027000000000000000044A6C">
ADDR(s) = ADDR(.text) = 0x4004d0
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A6D" id="P7000497027000000000000000044A6D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000062E2" epub:type="pagebreak" id="P70004970270000000000000000062E2" title="693"></span>and</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A6E" id="P7000497027000000000000000044A6E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A6F" id="P7000497027000000000000000044A6F">ADDR(r.symbol) = ADDR(sum) = 0x4004e8</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A70" id="P7000497027000000000000000044A70">Using the algorithm in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000062B6"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.10</span></a>, the linker first computes the run-time address of the reference (line 7):</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A71" id="P7000497027000000000000000044A71"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A72" id="P7000497027000000000000000044A72">
refaddr = ADDR(s) + r.offset
	= 0x4004d0 + 0xf
	= 0x4004df</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A73" id="P7000497027000000000000000044A73">It then updates the reference so that it will point to the sum routine at run time (line 8):</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A74" id="P7000497027000000000000000044A74"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A75" id="P7000497027000000000000000044A75">
*refptr = (unsigned) (ADDR(r.symbol)	+ r.addend - refaddr)
	= (unsigned) (0x4004e8	+ (-4) - 0x4004df)
	= (unsigned) (0x5)</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A76" id="P7000497027000000000000000044A76">In the resulting executable object file, the call instruction has the following relocated form:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A77" id="P7000497027000000000000000044A77"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A78" id="P7000497027000000000000000044A78">4004de: e8 05 00 00 00	callq 4004e8 &lt;sum&gt;	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">sum()</i></b></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A79" id="P7000497027000000000000000044A79">At run time, the call instruction will be located at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A7A" id="P7000497027000000000000000044A7A">0x4004de</code>. When the CPU executes the call instruction, the PC has a value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A7B" id="P7000497027000000000000000044A7B">0x4004e3</code>, which is the address of the instruction immediately following the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A7C" id="P7000497027000000000000000044A7C">call</code> instruction. To execute the call instruction, the CPU performs the following steps:</p>
<ol class="pcalibre1 calibre19 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A7D" id="P7000497027000000000000000044A7D">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A7E" id="P7000497027000000000000000044A7E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A7F" id="P7000497027000000000000000044A7F">Push PC onto stack</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A80" id="P7000497027000000000000000044A80"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044A81" id="P7000497027000000000000000044A81">PC  PC + <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A82" id="P7000497027000000000000000044A82">0x5 = 0x4004e3 + 0x5 = 0x4004e8</code></p></li>
</ol>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A83" id="P7000497027000000000000000044A83">Thus, the next instruction to execute is the first instruction of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A84" id="P7000497027000000000000000044A84">sum</code> routine, which of course is what we want!</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000062FA" id="P70004970270000000000000000062FA"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A85" epub:type="title" id="P7000497027000000000000000044A85">Relocating Absolute References</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A86" id="P7000497027000000000000000044A86">Relocating absolute references is straightforward. For example, in line 4 in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000062BC"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.11</span></a>, the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A87" id="P7000497027000000000000000044A87">mov</code> instruction copies the address of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A88" id="P7000497027000000000000000044A88">array</code> (a 32-bit immediate value) into register <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A89" id="P7000497027000000000000000044A89">%edi</code>. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A8A" id="P7000497027000000000000000044A8A">mov</code> instruction begins at section offset <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A8B" id="P7000497027000000000000000044A8B">0x9</code> and consists of the 1-byte opcode <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A8C" id="P7000497027000000000000000044A8C">0xbf</code>, followed by a placeholder for the 32-bit absolute reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A8D" id="P7000497027000000000000000044A8D">array</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A8E" id="P7000497027000000000000000044A8E">The corresponding relocation entry <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A8F" id="P7000497027000000000000000044A8F">r</code> consists of four fields:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A90" id="P7000497027000000000000000044A90"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A91" id="P7000497027000000000000000044A91">r.offset = 0xa
r.symbol = array
r.type = R_X86_64_32
r.addend = 0</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A92" id="P7000497027000000000000000044A92">These fields tell the linker to modify the absolute reference starting at offset <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A93" id="P7000497027000000000000000044A93">0xa</code> so that it will point to the first byte of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A94" id="P7000497027000000000000000044A94">array</code> at run time. Now, suppose that the linker has determined that</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P700049702700000000000000000630B" id="P700049702700000000000000000630B">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000630C" epub:type="pagebreak" id="P700049702700000000000000000630C" title="694"></span>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A95" id="P7000497027000000000000000044A95">(a) Relocated <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A96" id="P7000497027000000000000000044A96">.text</code> section</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A97" id="P7000497027000000000000000044A97"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A98" id="P7000497027000000000000000044A98">
1	00000000004004d0 &lt;main&gt;:
2	4004d0: 48 83 ec 08		sub	$0x8, %rsp
3	4004d4: be 02 00 00 00		mov	$0x2, %esi
4	4004d9: bf 18 10 60 00		mov	$0x601018, %edi	<i class="pcalibre17 pcalibre2 pcalibre1">%edi = &amp;array</i>
5	4004de: e8 05 00 00 00		callq	4004e8 &lt;sum&gt;	<i class="pcalibre17 pcalibre2 pcalibre1">sum()</i>
6	4004e3: 48 83 c4 08		add	$0x8, %rsp
7	4004e7: c3			retq	
8	00000000004004e8 &lt;sum&gt;:
9	4004e8: b8 00 00 00 00		mov	$0x0, %eax
10	4004ed: ba 00 00 00 00		mov	$0x0, %edx
11	4004f2: eb 09			jmp	4004fd &lt;sum+0x15&gt;
12	4004f4: 48 63 ca		movslq	%edx, %rcx
13	4004f7: 03 04 8f		add	(%rdi, %rcx,4), %eax
14	4004fa: 83 c2 01		add	$0x1, %edx
15	4004fd: 39 f2			cmp	%esi, %edx
16	4004ff: 7c f3			jl	4004f4 &lt;sum+0xc&gt;
17	400501: f3 c3			repz retq
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A99" id="P7000497027000000000000000044A99">(b) Relocated .data section</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044A9A" id="P7000497027000000000000000044A9A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A9B" id="P7000497027000000000000000044A9B">
1	0000000000601018 &lt;array&gt;:
2	  601018: 01 00 00 00 02 00 00 00
</code></pre>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044A9C" id="P7000497027000000000000000044A9C"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044A9D" epub:type="title" id="P7000497027000000000000000044A9D"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.12 </span>Relocated <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A9E" id="P7000497027000000000000000044A9E">.text</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044A9F" id="P7000497027000000000000000044A9F">.data</code> sections for the executable file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AA0" id="P7000497027000000000000000044AA0">prog.</code></h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AA1" id="P7000497027000000000000000044AA1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AA2" id="P7000497027000000000000000044AA2">The original C code is in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000005FB4.xhtml#P7000497027000000000000000005FF0"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.1</span></a>.</p></div></figcaption>
</figure>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AA3" id="P7000497027000000000000000044AA3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AA4" id="P7000497027000000000000000044AA4">ADDR(r.symbol) = ADDR(array) = 0x601018</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AA5" id="P7000497027000000000000000044AA5">The linker updates the reference using line 13 of the algorithm in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000062B6"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.10</span></a>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AA6" id="P7000497027000000000000000044AA6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AA7" id="P7000497027000000000000000044AA7">*refptr = (unsigned) (ADDR(r.symbol) + r.addend)
	= (unsigned) (0x601018 + 0)
	= (unsigned) (0x601018)</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AA8" id="P7000497027000000000000000044AA8">In the resulting executable object file, the reference has the following relocated form:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AA9" id="P7000497027000000000000000044AA9"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AAA" id="P7000497027000000000000000044AAA">4004d9: bf 18 10 60 00		mov	$0x601018, %edi	  <b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">%edi = &amp;array</i></b></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AAB" id="P7000497027000000000000000044AAB">Putting it all together, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000630B"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.12</span></a> shows the relocated <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AAC" id="P7000497027000000000000000044AAC">.text</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AAD" id="P7000497027000000000000000044AAD">.data</code> sections in the final executable object file. At load time, the loader can copy the bytes from these sections directly into memory and execute the instructions without any further modifications.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006326" epub:type="practice" id="P7000497027000000000000000006326"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre127 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AAE" epub:type="title" id="P7000497027000000000000000044AAE"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.4 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000065E7.xhtml#P70004970270000000000000000065EF">718</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter07.xhtml#P7000497027000000000000000044AAF" id="P7000497027000000000000000044AAF">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter07.xhtml#P7000497027000000000000000044AB0" id="P7000497027000000000000000044AB0">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044AB1" id="P7000497027000000000000000044AB1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AB2" id="P7000497027000000000000000044AB2">This problem concerns the relocated program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000630B"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.12(a)</span></a>.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P7000497027000000000000000044AB3" id="P7000497027000000000000000044AB3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AB4" id="P7000497027000000000000000044AB4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AB5" id="P7000497027000000000000000044AB5"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000632F" epub:type="pagebreak" id="P700049702700000000000000000632F" title="695"></span>What is the hex address of the relocated reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AB6" id="P7000497027000000000000000044AB6">sum</code> in line 5?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AB7" id="P7000497027000000000000000044AB7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AB8" id="P7000497027000000000000000044AB8">What is the hex value of the relocated reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AB9" id="P7000497027000000000000000044AB9">sum</code> in line 5?</p></li>
</ol></div></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006334" epub:type="practice" id="P7000497027000000000000000006334"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre127 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044ABA" epub:type="title" id="P7000497027000000000000000044ABA"><span class="pcalibre1 pcalibre21 pcalibre2">Practice Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.5 </span>(solution page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP70004970270000000000000000065E7.xhtml#P70004970270000000000000000065EF">718</a>)</h1></header>
<ol class="pcalibre1 pcalibre2 pcalibre77" data-uri="chapter07.xhtml#P7000497027000000000000000044ABB" id="P7000497027000000000000000044ABB">
<li class="pcalibre1 pcalibre2 pcalibre78" data-uri="chapter07.xhtml#P7000497027000000000000000044ABC" id="P7000497027000000000000000044ABC">
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044ABD" id="P7000497027000000000000000044ABD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044ABE" id="P7000497027000000000000000044ABE">Consider the call to function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044ABF" id="P7000497027000000000000000044ABF">swap</code> in object file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AC0" id="P7000497027000000000000000044AC0">m.o</code> (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000608B.xhtml#P700049702700000000000000000612D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.5</span></a>).</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AC1" id="P7000497027000000000000000044AC1"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AC2" id="P7000497027000000000000000044AC2">9: e8 00 00 00 00	callq	e &lt;main+0xe&gt;	<i class="pcalibre17 pcalibre2 pcalibre1">swap()</i></code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AC3" id="P7000497027000000000000000044AC3">with the following relocation entry:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AC4" id="P7000497027000000000000000044AC4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AC5" id="P7000497027000000000000000044AC5">r.offset = 0xa
r.symbol = swap
r.type = R_X86_64_PC32
r.addend = -4</code></pre>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AC6" id="P7000497027000000000000000044AC6">Now suppose that the linker relocates <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AC7" id="P7000497027000000000000000044AC7">.text</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AC8" id="P7000497027000000000000000044AC8">m.o</code> to address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AC9" id="P7000497027000000000000000044AC9">0x4004d0</code> and swap to address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044ACA" id="P7000497027000000000000000044ACA">0x4004e8</code>. Then what is the value of the relocated reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044ACB" id="P7000497027000000000000000044ACB">swap</code> in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044ACC" id="P7000497027000000000000000044ACC">callq</code> instruction?</p></div></li>
</ol>
</section>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.8 Executable Object Files</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006348"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044ACD" epub:type="title" id="P7000497027000000000000000044ACD"><span class="pcalibre1 pcalibre21 pcalibre2">7.8 </span>Executable Object Files</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044ACE" id="P7000497027000000000000000044ACE">We have seen how the linker merges multiple object files into a single executable object file. Our example C program, which began life as a collection of ASCII text files, has been transformed into a single binary file that contains all of the information needed to load the program into memory and run it. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000634B"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.13</span></a> summarizes the kinds of information in a typical ELF executable file.</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P700049702700000000000000000634B" id="P700049702700000000000000000634B">
<img alt="A diagram shows a typical ELF executable object file." class="pcalibre238 pcalibre2 pcalibre1" data-uri="P700049702700000000000000000B75B" id="P7000497027000000000000000044ACF" src="Images/chapter-06-image-04.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044AD0" id="P7000497027000000000000000044AD0"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044AD1" epub:type="title" id="P7000497027000000000000000044AD1"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.13 </span>Typical ELF executable object file.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter07.xhtml#P7000497027000000000000000024DE4" id="P7000497027000000000000000024DE4">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AD2" id="P7000497027000000000000000044AD2">A diagram has 11 sections extending from 0 at the top, with a section at the bottom, containing section header table, describing object file sections. All 12 sections are grouped, as summarized in the list below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter07.xhtml#P7000497027000000000000000044AD3" id="P7000497027000000000000000044AD3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AD4" id="P7000497027000000000000000044AD4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AD5" id="P7000497027000000000000000044AD5">Read-only memory segment (code segment):</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter07.xhtml#P7000497027000000000000000044AD6" id="P7000497027000000000000000044AD6">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AD7" id="P7000497027000000000000000044AD7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AD8" id="P7000497027000000000000000044AD8">ELF header</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AD9" id="P7000497027000000000000000044AD9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044ADA" id="P7000497027000000000000000044ADA">Segment header table (maps contiguous file sections to run-time memory segments)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044ADB" id="P7000497027000000000000000044ADB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044ADC" id="P7000497027000000000000000044ADC">.init</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044ADD" id="P7000497027000000000000000044ADD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044ADE" id="P7000497027000000000000000044ADE">.text</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044ADF" id="P7000497027000000000000000044ADF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AE0" id="P7000497027000000000000000044AE0">.rodata</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AE1" id="P7000497027000000000000000044AE1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AE2" id="P7000497027000000000000000044AE2">Read/write memory segment (data segment)</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter07.xhtml#P7000497027000000000000000044AE3" id="P7000497027000000000000000044AE3">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AE4" id="P7000497027000000000000000044AE4"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AE5" id="P7000497027000000000000000044AE5">.data</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AE6" id="P7000497027000000000000000044AE6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AE7" id="P7000497027000000000000000044AE7">.bss</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AE8" id="P7000497027000000000000000044AE8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AE9" id="P7000497027000000000000000044AE9">Symbol table and bebugging info are not loaded into memory</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter07.xhtml#P7000497027000000000000000044AEA" id="P7000497027000000000000000044AEA">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AEB" id="P7000497027000000000000000044AEB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AEC" id="P7000497027000000000000000044AEC">.symtab</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AED" id="P7000497027000000000000000044AED"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AEE" id="P7000497027000000000000000044AEE">.debug</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AEF" id="P7000497027000000000000000044AEF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AF0" id="P7000497027000000000000000044AF0">.line</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AF1" id="P7000497027000000000000000044AF1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AF2" id="P7000497027000000000000000044AF2">.strtb</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AF3" id="P7000497027000000000000000044AF3"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AF4" id="P7000497027000000000000000044AF4">Section header table</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P700049702700000000000000000634F" id="P700049702700000000000000000634F">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006350" epub:type="pagebreak" id="P7000497027000000000000000006350" title="696"></span>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AF5" id="P7000497027000000000000000044AF5">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/prog-exe.d</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044AF6" id="P7000497027000000000000000044AF6"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AF7" id="P7000497027000000000000000044AF7">
	<i class="pcalibre17 pcalibre2 pcalibre1">Read-only code segment</i>
1	LOAD off	0x0000000000000000 vaddr 0x0000000000400000 paddr 0x0000000000400000 align 2**21
2	   filesz 0x000000000000069c memsz 0x000000000000069c flags r-x
	<i class="pcalibre17 pcalibre2 pcalibre1">Read/write data segment</i>
3	LOAD off	 0x0000000000000df8 vaddr 0x0000000000600df8 paddr 0x0000000000600df8 align 2**21
4	   filesz 0x0000000000000228 memsz 0x0000000000000230 flags rw-
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AF8" id="P7000497027000000000000000044AF8">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/prog-exe.d</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044AF9" id="P7000497027000000000000000044AF9"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044AFA" epub:type="title" id="P7000497027000000000000000044AFA"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.14 </span>Program header table for the example executable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AFB" id="P7000497027000000000000000044AFB">prog.</code></h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AFC" id="P7000497027000000000000000044AFC"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044AFD" id="P7000497027000000000000000044AFD"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AFE" id="P7000497027000000000000000044AFE">off</code>: offset in object file; <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044AFF" id="P7000497027000000000000000044AFF">vaddr/paddr</code>: memory address; <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B00" id="P7000497027000000000000000044B00">align</code>: alignment requirement; <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B01" id="P7000497027000000000000000044B01">filesz</code>: segment size in object file; <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B02" id="P7000497027000000000000000044B02">memsz</code>: segment size in memory; <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B03" id="P7000497027000000000000000044B03">flags</code>: run-time permissions.</p></div></figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B04" id="P7000497027000000000000000044B04">The format of an executable object file is similar to that of a relocatable object file. The ELF header describes the overall format of the file. It also includes the program's <i class="pcalibre17 pcalibre2 pcalibre1">entry point</i>, which is the address of the first instruction to execute when the program runs. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B05" id="P7000497027000000000000000044B05">.text, .rodata</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B06" id="P7000497027000000000000000044B06">.data</code> sections are similar to those in a relocatable object file, except that these sections have been relocated to their eventual run-time memory addresses. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B07" id="P7000497027000000000000000044B07">.init</code> section defines a small function, called <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B08" id="P7000497027000000000000000044B08">_init</code>, that will be called by the program's initialization code. Since the executable is <i class="pcalibre17 pcalibre2 pcalibre1">fully linked</i> (relocated), it needs no <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B09" id="P7000497027000000000000000044B09">.rel</code> sections.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B0A" id="P7000497027000000000000000044B0A">ELF executables are designed to be easy to load into memory, with contiguous chunks of the executable file mapped to contiguous memory segments. This mapping is described by the <i class="pcalibre17 pcalibre2 pcalibre1">program header table</i>. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000634F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.14</span></a> shows part of the program header table for our example executable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B0B" id="P7000497027000000000000000044B0B">prog</code>, as displayed by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B0C" id="P7000497027000000000000000044B0C"><span class="pcalibre1 pcalibre29 pcalibre2">objdump</span></code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B0D" id="P7000497027000000000000000044B0D">From the program header table, we see that two memory segments will be initialized with the contents of the executable object file. Lines 1 and 2 tell us that the first segment (the <i class="pcalibre17 pcalibre2 pcalibre1">code segment</i>) has read/execute permissions, starts at memory address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B0E" id="P7000497027000000000000000044B0E">0x400000</code>, has a total size in memory of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B0F" id="P7000497027000000000000000044B0F">0x69c</code> bytes, and is initialized with the first <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B10" id="P7000497027000000000000000044B10">0x69c</code> bytes of the executable object file, which includes the ELF header, the program header table, and the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B11" id="P7000497027000000000000000044B11">.init, .text</code>, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B12" id="P7000497027000000000000000044B12">.rodata</code> sections.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B13" id="P7000497027000000000000000044B13">Lines 3 and 4 tell us that the second segment (the <i class="pcalibre17 pcalibre2 pcalibre1">data segment</i>) has read/write permissions, starts at memory address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B14" id="P7000497027000000000000000044B14">0x600df8</code>, has a total memory size of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B15" id="P7000497027000000000000000044B15">0x230</code> bytes, and is initialized with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B16" id="P7000497027000000000000000044B16">0x228</code> bytes in the .data section starting at offset <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B17" id="P7000497027000000000000000044B17">0xdf8</code> in the object file. The remaining 8 bytes in the segment correspond to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B18" id="P7000497027000000000000000044B18">.bss</code> data that will be initialized to zero at run time.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B19" id="P7000497027000000000000000044B19">For any segment <var class="pcalibre17 pcalibre2 pcalibre1">s</var>, the linker must choose a starting address, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B1A" id="P7000497027000000000000000044B1A">vaddr</code>, such that</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B1B" id="P7000497027000000000000000044B1B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B1C" id="P7000497027000000000000000044B1C">vaddr mod align = offmod align</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B1D" id="P7000497027000000000000000044B1D">where <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B1E" id="P7000497027000000000000000044B1E">off</code> is the offset of the segment's first section in the object file, and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B1F" id="P7000497027000000000000000044B1F">align</code> is the alignment specified in the program header (2<sup class="pcalibre1 pcalibre2 pcalibre85">21</sup> = <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B20" id="P7000497027000000000000000044B20">0x200000</code>). For example, in the data segment in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P700049702700000000000000000634F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.14</span></a>,</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B21" id="P7000497027000000000000000044B21"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000637E" epub:type="pagebreak" id="P700049702700000000000000000637E" title="697"></span></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B22" id="P7000497027000000000000000044B22"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B23" id="P7000497027000000000000000044B23">vaddr mod align = 0x600df8 mod 0x200000 = 0xdf8</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B24" id="P7000497027000000000000000044B24">and</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B25" id="P7000497027000000000000000044B25"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B26" id="P7000497027000000000000000044B26">offmod align = 0xdf8 mod 0x200000= 0xdf8</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B27" id="P7000497027000000000000000044B27">This alignment requirement is an optimization that enables segments in the object file to be transferred efficiently to memory when the program executes. The reason is somewhat subtle and is due to the way that virtual memory is organized as large contiguous power-of-2 chunks of bytes. You will learn all about virtual memory in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006FF7.xhtml#P7000497027000000000000000006FF7"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">9</span></a>.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.9 Loading Executable Object Files</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006385"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044B28" epub:type="title" id="P7000497027000000000000000044B28"><span class="pcalibre1 pcalibre21 pcalibre2">7.9 </span>Loading Executable Object Files</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B29" id="P7000497027000000000000000044B29">To run an executable object file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B2A" id="P7000497027000000000000000044B2A">prog</code>, we can type its name to the Linux shell's command line:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B2B" id="P7000497027000000000000000044B2B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B2C" id="P7000497027000000000000000044B2C">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">./prog</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B2D" id="P7000497027000000000000000044B2D">Since <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B2E" id="P7000497027000000000000000044B2E">prog</code> does not correspond to a built-in shell command, the shell assumes that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B2F" id="P7000497027000000000000000044B2F">prog</code> is an executable object file, which it runs for us by invoking some memory-resident operating system code known as the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B30" id="P7000497027000000000000000044B30">loader</code>. Any Linux program can invoke the loader by calling the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B31" id="P7000497027000000000000000044B31">execve</code> function, which we will describe in detail in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000685D.xhtml#P70004970270000000000000000069EF"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">8.4.6</span></a>. The loader copies the code and data in the executable object file from disk into memory and then runs the program by jumping to its first instruction, or <i class="pcalibre17 pcalibre2 pcalibre1">entry point</i>. This process of copying the program into memory and then running it is known as <i class="pcalibre17 pcalibre2 pcalibre1">loading</i>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B32" id="P7000497027000000000000000044B32">Every running Linux program has a run-time memory image similar to the one in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006397"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.15</span></a>. On Linux x86-64 systems, the code segment starts at address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B33" id="P7000497027000000000000000044B33">0x400000</code>, followed by the data segment. The run-time <i class="pcalibre17 pcalibre2 pcalibre1">heap</i> follows the data segment and grows upward via calls to the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B34" id="P7000497027000000000000000044B34">malloc</code> library.(We will describe <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B35" id="P7000497027000000000000000044B35">malloc</code> and the heap in detail in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000733C.xhtml#P700049702700000000000000000733C"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">9.9</span></a>.) This is followed by a region that is reserved for shared modules. The user stack starts below the largest legal user address (2<sup class="pcalibre1 pcalibre2 pcalibre85">48</sup> - 1) and grows down, toward smaller memory addresses. The region above the stack, starting at address 2<sup class="pcalibre1 pcalibre2 pcalibre85">48</sup>, is reserved for the code and data in the <i class="pcalibre17 pcalibre2 pcalibre1">kernel</i>, which is the memory-resident part of the operating system.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B36" id="P7000497027000000000000000044B36">For simplicity, we've drawn the heap, data, and code segments as abutting each other, and we've placed the top of the stack at the largest legal user address. In practice, there is a gap between the code and data segments due to the alignment requirement on the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B37" id="P7000497027000000000000000044B37">.data</code> segment (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006348.xhtml#P7000497027000000000000000006348"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">7.8</span></a>). Also, the linker uses address-space layout randomization (ASLR, <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000002E6D.xhtml#P7000497027000000000000000002FAD"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">3.10.4</span></a>) when it assigns runtime addresses to the stack, shared library, and heap segments. Even though the locations of these regions change each time the program is run, their relative positions are the same.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B38" id="P7000497027000000000000000044B38">When the loader runs, it creates a memory image similar to the one shown in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006397"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.15</span></a>. Guided by the program header table, it copies chunks of the</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P7000497027000000000000000006397" id="P7000497027000000000000000006397">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006398" epub:type="pagebreak" id="P7000497027000000000000000006398" title="698"></span>
<img alt="A diagram illustrates Linus x86-64 run-time memory image." class="pcalibre1 pcalibre2 calibre61" data-uri="P700049702700000000000000000B75C" id="P7000497027000000000000000044B39" src="Images/chapter-06-image-05.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044B3A" id="P7000497027000000000000000044B3A"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044B3B" epub:type="title" id="P7000497027000000000000000044B3B"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.15 </span>Linux x86-64 run-time memory image.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044B3C" id="P7000497027000000000000000044B3C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B3D" id="P7000497027000000000000000044B3D">Gaps due to segment alignment requirements and address-space layout randomization (ASLR) are not shown. Not to scale.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter07.xhtml#P7000497027000000000000000024E51" id="P7000497027000000000000000024E51">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B3E" id="P7000497027000000000000000044B3E">A diagram shows a stack with sections summarized below from bottom to top.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter07.xhtml#P7000497027000000000000000044B3F" id="P7000497027000000000000000044B3F">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B40" id="P7000497027000000000000000044B40"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B41" id="P7000497027000000000000000044B41">Gap from 0 to 0x400000</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B42" id="P7000497027000000000000000044B42"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B43" id="P7000497027000000000000000044B43">Loaded from the executable file:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter07.xhtml#P7000497027000000000000000044B44" id="P7000497027000000000000000044B44">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B45" id="P7000497027000000000000000044B45"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B46" id="P7000497027000000000000000044B46">Read-only code segment (.init, .text, .rodata)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B47" id="P7000497027000000000000000044B47"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B48" id="P7000497027000000000000000044B48">Read/write segment (.data, .bss)</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B49" id="P7000497027000000000000000044B49"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B4A" id="P7000497027000000000000000044B4A">Run-time heap (created by malloc), to brk</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B4B" id="P7000497027000000000000000044B4B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B4C" id="P7000497027000000000000000044B4C">Gap</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B4D" id="P7000497027000000000000000044B4D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B4E" id="P7000497027000000000000000044B4E">Memory-mapped region for shared libraries</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B4F" id="P7000497027000000000000000044B4F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B50" id="P7000497027000000000000000044B50">Gap to %esp (stack pointer)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B51" id="P7000497027000000000000000044B51"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B52" id="P7000497027000000000000000044B52">User stack (created at run time), to 2<sup class="pcalibre1 pcalibre2 pcalibre85">48</sup> minus 1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B53" id="P7000497027000000000000000044B53"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B54" id="P7000497027000000000000000044B54">Kernel memory, to memory invisible to user code</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B55" id="P7000497027000000000000000044B55">executable object file into the code and data segments. Next, the loader jumps to the program's entry point, which is always the address of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B56" id="P7000497027000000000000000044B56">_start</code> function. This function is defined in the system object file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B57" id="P7000497027000000000000000044B57">crt1.o</code> and is the same for all C programs. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B58" id="P7000497027000000000000000044B58">_start</code> function calls the <i class="pcalibre17 pcalibre2 pcalibre1">system startup function</i>, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B59" id="P7000497027000000000000000044B59">__libc_start_main</code>, which is defined in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B5A" id="P7000497027000000000000000044B5A">libc.so</code>. It initializes the execution environment, calls the user-level <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B5B" id="P7000497027000000000000000044B5B">main</code> function, handles its return value, and if necessary returns control to the kernel.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.10 Dynamic Linking with Shared Libraries</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000063A5"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044B5C" epub:type="title" id="P7000497027000000000000000044B5C"><span class="pcalibre1 pcalibre21 pcalibre2">7.10 </span>Dynamic Linking with Shared Libraries</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B5D" id="P7000497027000000000000000044B5D">The static libraries that we studied in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P70004970270000000000000000061DE"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">7.6.2</span></a> address many of the issues associated with making large collections of related functions available to application programs. However, static libraries still have some significant disadvantages. Static libraries, like all software, need to be maintained and updated periodically. If application programmers want to use the most recent version of a library, they must somehow become aware that the library has changed and then explicitly relink their programs against the updated library.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B5E" id="P7000497027000000000000000044B5E">Another issue is that almost every C program uses standard I/O functions such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B5F" id="P7000497027000000000000000044B5F">printf</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B60" id="P7000497027000000000000000044B60">scanf</code>. At run time, the code for these functions is duplicated in the text segment of each running process. On a typical system that is running hundreds of processes, this can be a significant waste of scarce memory system resources. (An interesting property of memory is that it is <i class="pcalibre17 pcalibre2 pcalibre1">always</i> a scarce resource, regardless</p>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter07.xhtml#P70004970270000000000000000063AB" id="P70004970270000000000000000063AB"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter07.xhtml#P7000497027000000000000000044B61" epub:type="title" id="P7000497027000000000000000044B61"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000063AD" epub:type="pagebreak" id="P70004970270000000000000000063AD" title="699"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>How do loaders really work?</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044B62" id="P7000497027000000000000000044B62">Our description of loading is conceptually correct but intentionally not entirely accurate. To understand how loading really works, you must understand the concepts of <i class="pcalibre17 pcalibre2 pcalibre1">processes</i>, <i class="pcalibre17 pcalibre2 pcalibre1">virtual memory</i>, and <i class="pcalibre17 pcalibre2 pcalibre1">memory mapping</i>, which we haven't discussed yet. As we encounter these concepts later in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000666E.xhtml#P700049702700000000000000000666E"><span class="pcalibre1 pcalibre21 pcalibre2">Chapters </span><span class="pcalibre1 pcalibre21 pcalibre2">8</span></a> and <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006FF7.xhtml#P7000497027000000000000000006FF7"><span class="pcalibre1 pcalibre21 pcalibre2">9</span></a>, we will revisit loading and gradually reveal the mystery to you.</p>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B63" id="P7000497027000000000000000044B63">For the impatient reader, here is a preview of how loading really works: Each program in a Linux system runs in the context of a process with its own virtual address space. When the shell runs a program, the parent shell process forks a child process that is a duplicate of the parent. The child process invokes the loader via the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B64" id="P7000497027000000000000000044B64">execve</code> system call. The loader deletes the child's existing virtual memory segments and creates a new set of code, data, heap, and stack segments. The new stack and heap segments are initialized to zero. The new code and data segments are initialized to the contents of the executable file by mapping pages in the virtual address space to page-size chunks of the executable file. Finally, the loader jumps to the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B65" id="P7000497027000000000000000044B65">_start</code> address, which eventually calls the application's <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B66" id="P7000497027000000000000000044B66">main</code> routine. Aside from some header information, there is no copying of data from disk to memory during loading. The copying is deferred until the CPU references a mapped virtual page, at which point the operating system automatically transfers the page from disk to memory using its paging mechanism.</p>
</aside>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B67" id="P7000497027000000000000000044B67">of how much there is in a system. Disk space and kitchen trash cans share this same property.)</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B68" id="P7000497027000000000000000044B68"><i class="pcalibre17 pcalibre2 pcalibre1">Shared libraries</i> are modern innovations that address the disadvantages of static libraries. A shared library is an object module that, at either run time or load time, can be loaded at an arbitrary memory address and linked with a program in memory. This process is known as <i class="pcalibre17 pcalibre2 pcalibre1">dynamic linking</i> and is performed by a program called a <i class="pcalibre17 pcalibre2 pcalibre1">dynamic linker</i>. Shared libraries are also referred to as <i class="pcalibre17 pcalibre2 pcalibre1">shared objects</i>, and on Linux systems they are indicated by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B69" id="P7000497027000000000000000044B69">.so</code> suffix. Microsoft operating systems make heavy use of shared libraries, which they refer to as DLLs (dynamic link libraries).</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B6A" id="P7000497027000000000000000044B6A">Shared libraries are "shared" in two different ways. First, in any given file system, there is exactly one <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B6B" id="P7000497027000000000000000044B6B">.so</code> file for a particular library. The code and data in this <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B6C" id="P7000497027000000000000000044B6C">.so</code> file are shared by all of the executable object files that reference the library, as opposed to the contents of static libraries, which are copied and embedded in the executables that reference them. Second, a single copy of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B6D" id="P7000497027000000000000000044B6D">.text</code> section of a shared library in memory can be shared by different running processes. We will explore this in more detail when we study virtual memory in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006FF7.xhtml#P7000497027000000000000000006FF7"><span class="pcalibre1 pcalibre21 pcalibre2">Chapter </span><span class="pcalibre1 pcalibre21 pcalibre2">9</span></a>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B6E" id="P7000497027000000000000000044B6E"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000063C1"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.16</span></a> summarizes the dynamic linking process for the example program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P700049702700000000000000000621E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.7</span></a>. To build a shared library <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B6F" id="P7000497027000000000000000044B6F">libvector.so</code> of our example vector routines in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P70004970270000000000000000061F7"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.6</span></a>, we invoke the compiler driver with some special directives to the compiler and linker:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B70" id="P7000497027000000000000000044B70"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B71" id="P7000497027000000000000000044B71">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -shared -fpic -o libvector.so addvec.c multvec.c</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B72" id="P7000497027000000000000000044B72">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B73" id="P7000497027000000000000000044B73">-fpic</code> flag directs the compiler to generate <i class="pcalibre17 pcalibre2 pcalibre1">position-independent code</i> (more on this in the next section). The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B74" id="P7000497027000000000000000044B74">-shared</code> flag directs the linker to create a shared</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P70004970270000000000000000063C1" id="P70004970270000000000000000063C1">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000063C2" epub:type="pagebreak" id="P70004970270000000000000000063C2" title="700"></span>
<img alt="A diagram illustrates dynamic linking with shared libraries." class="pcalibre1 pcalibre2 calibre62" data-uri="P700049702700000000000000000B75D" id="P7000497027000000000000000044B75" src="Images/chapter-06-image-06.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044B76" id="P7000497027000000000000000044B76"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044B77" epub:type="title" id="P7000497027000000000000000044B77"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.16 </span>Dynamic linking with shared libraries.</h1></header>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter07.xhtml#P7000497027000000000000000024E8C" id="P7000497027000000000000000024E8C">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B78" id="P7000497027000000000000000044B78">A diagram flows from top to bottom as follows:</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter07.xhtml#P7000497027000000000000000044B79" id="P7000497027000000000000000044B79">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B7A" id="P7000497027000000000000000044B7A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B7B" id="P7000497027000000000000000044B7B">Main2. C and vector.h</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B7C" id="P7000497027000000000000000044B7C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B7D" id="P7000497027000000000000000044B7D">Translators (cpp, cc1, as)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B7E" id="P7000497027000000000000000044B7E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B7F" id="P7000497027000000000000000044B7F">Relocatable object file main2.0 and relocation and symbol table info libc.s0, libvector.so</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B80" id="P7000497027000000000000000044B80"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B81" id="P7000497027000000000000000044B81">Linker (ld)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B82" id="P7000497027000000000000000044B82"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B83" id="P7000497027000000000000000044B83">Partially linked executable object file prog21</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B84" id="P7000497027000000000000000044B84"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B85" id="P7000497027000000000000000044B85">Loader (execve)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B86" id="P7000497027000000000000000044B86"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B87" id="P7000497027000000000000000044B87">Fully linked executable in memory Dynamic linker (ld-linux.so); code and data from libc.so, libvector.so.</p></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B88" id="P7000497027000000000000000044B88">object file. Once we have created the library, we would then link it into our example program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P700049702700000000000000000621E"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.7</span></a>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B89" id="P7000497027000000000000000044B89"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B8A" id="P7000497027000000000000000044B8A">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -o prog2l main2.c ./libvector.so</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B8B" id="P7000497027000000000000000044B8B">This creates an executable object file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B8C" id="P7000497027000000000000000044B8C">prog2l</code> in a form that can be linked with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B8D" id="P7000497027000000000000000044B8D">libvector.so</code> at run time. The basic idea is to do some of the linking statically when the executable file is created, and then complete the linking process dynamically when the program is loaded. It is important to realize that none of the code or data sections from <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B8E" id="P7000497027000000000000000044B8E">libvector.so</code> are actually copied into the executable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B8F" id="P7000497027000000000000000044B8F">prog2l</code> at this point. Instead, the linker copies some relocation and symbol table information that will allow references to code and data in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B90" id="P7000497027000000000000000044B90">libvector.so</code> to be resolved at load time.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B91" id="P7000497027000000000000000044B91">When the loader loads and runs the executable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B92" id="P7000497027000000000000000044B92">prog2l</code>, it loads the partially linked executable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B93" id="P7000497027000000000000000044B93">prog2l</code>, using the techniques discussed in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006385.xhtml#P7000497027000000000000000006385"><span class="pcalibre1 pcalibre21 pcalibre2">Section </span><span class="pcalibre1 pcalibre21 pcalibre2">7.9</span></a>. Next, it notices that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B94" id="P7000497027000000000000000044B94">prog2l</code> contains a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B95" id="P7000497027000000000000000044B95">.interp</code> section, which contains the path name of the dynamic linker, which is itself a shared object (e.g., <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B96" id="P7000497027000000000000000044B96">ld-linux.so</code> on Linux systems). Instead of passing control to the application, as it would normally do, the loader loads and runs the dynamic linker. The dynamic linker then finishes the linking task by performing the following relocations:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B97" id="P7000497027000000000000000044B97">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B98" id="P7000497027000000000000000044B98"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B99" id="P7000497027000000000000000044B99">Relocating the text and data of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B9A" id="P7000497027000000000000000044B9A">libc.so</code> into some memory segment</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B9B" id="P7000497027000000000000000044B9B"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B9C" id="P7000497027000000000000000044B9C">Relocating the text and data of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044B9D" id="P7000497027000000000000000044B9D">libvector.so</code> into another memory segment</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044B9E" id="P7000497027000000000000000044B9E"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044B9F" id="P7000497027000000000000000044B9F">Relocating any references in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BA0" id="P7000497027000000000000000044BA0">prog2l</code> to symbols defined by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BA1" id="P7000497027000000000000000044BA1">libc.so</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BA2" id="P7000497027000000000000000044BA2">libvector.so</code></p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BA3" id="P7000497027000000000000000044BA3"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000063E2" epub:type="pagebreak" id="P70004970270000000000000000063E2" title="701"></span>Finally, the dynamic linker passes control to the application. From this point on, the locations of the shared libraries are fixed and do not change during execution of the program.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.11 Loading and Linking Shared Libraries from Applications</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000063E3"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044BA4" epub:type="title" id="P7000497027000000000000000044BA4"><span class="pcalibre1 pcalibre21 pcalibre2">7.11 </span>Loading and Linking Shared Libraries from Applications</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BA5" id="P7000497027000000000000000044BA5">Up to this point, we have discussed the scenario in which the dynamic linker loads and links shared libraries when an application is loaded, just before it executes. However, it is also possible for an application to request the dynamic linker to load and link arbitrary shared libraries while the application is running, without having to link in the applications against those libraries at compile time.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BA6" id="P7000497027000000000000000044BA6">Dynamic linking is a powerful and useful technique. Here are some examples in the real world:</p>
<ul class="pcalibre1 calibre9 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BA7" id="P7000497027000000000000000044BA7">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BA8" id="P7000497027000000000000000044BA8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044BA9" id="P7000497027000000000000000044BA9"><span class="pcalibre1 pcalibre2 pcalibre41">Distributing software. </span>Developers of Microsoft Windows applications frequently use shared libraries to distribute software updates. They generate a new copy of a shared library, which users can then download and use as a replacement for the current version. The next time they run their application, it will automatically link and load the new shared library.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BAA" id="P7000497027000000000000000044BAA"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044BAB" id="P7000497027000000000000000044BAB"><span class="pcalibre1 pcalibre2 pcalibre41">Building high-performance Web servers. </span>Many Web servers generate <i class="pcalibre17 pcalibre2 pcalibre1">dynamic content</i>, such as personalized Web pages, account balances, and banner ads. Early Web servers generated dynamic content by using <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BAC" id="P7000497027000000000000000044BAC">fork</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BAD" id="P7000497027000000000000000044BAD">execve</code> to create a child process and run a "CGI program" in the context of the child. However, modern high-performance Web servers can generate dynamic content using a more efficient and sophisticated approach based on dynamic linking.</p>
<p class="pcalibre1 pcalibre2 pcalibre63" data-uri="chapter07.xhtml#P7000497027000000000000000044BAE" id="P7000497027000000000000000044BAE">The idea is to package each function that generates dynamic content in a shared library. When a request arrives from a Web browser, the server dynamically loads and links the appropriate function and then calls it directly, as opposed to using <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BAF" id="P7000497027000000000000000044BAF">fork</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BB0" id="P7000497027000000000000000044BB0">execve</code> to run the function in the context of a child process. The function remains cached in the server's address space, so subsequent requests can be handled at the cost of a simple function call. This can have a significant impact on the throughput of a busy site. Further, existing functions can be updated and new functions can be added at run time, without stopping the server.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BB1" id="P7000497027000000000000000044BB1">Linux systems provide a simple interface to the dynamic linker that allows application programs to load and link shared libraries at run time.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BB2" id="P7000497027000000000000000044BB2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BB3" id="P7000497027000000000000000044BB3">#include &lt;dlfcn.h&gt;
void *dlopen(const char *filename, int flag);
				Returns: pointer to handle if OK, NULL on error</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BB4" id="P7000497027000000000000000044BB4"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000063F5" epub:type="pagebreak" id="P70004970270000000000000000063F5" title="702"></span>The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BB5" id="P7000497027000000000000000044BB5">dlopen</code> function loads and links the shared library <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BB6" id="P7000497027000000000000000044BB6">filename</code>. The external symbols in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BB7" id="P7000497027000000000000000044BB7">filename</code> are resolved using libraries previously opened with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BB8" id="P7000497027000000000000000044BB8">RTLD_GLOBAL</code> flag. If the current executable was compiled with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BB9" id="P7000497027000000000000000044BB9">-rdynamic</code> flag, then its global symbols are also available for symbol resolution. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BBA" id="P7000497027000000000000000044BBA">flag</code> argument must include either <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BBB" id="P7000497027000000000000000044BBB">RTLD_NOW</code>, which tells the linker to resolve references to external symbols immediately, or the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BBC" id="P7000497027000000000000000044BBC">RTLD_LAZY</code> flag, which instructs the linker to defer symbol resolution until code from the library is executed. Either of these values can be <span class="pcalibre1 pcalibre29 pcalibre2">or</span>ed with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BBD" id="P7000497027000000000000000044BBD">RTLD_GLOBAL</code> flag.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BBE" id="P7000497027000000000000000044BBE"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BBF" id="P7000497027000000000000000044BBF">#include &lt;dlfcn.h&gt;
void *dlsym(void *handle, char *symbol);
				Returns: pointer to symbol if OK, NULL on error</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BC0" id="P7000497027000000000000000044BC0">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BC1" id="P7000497027000000000000000044BC1">dlsym</code> function takes a handle to a previously opened shared library and a <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BC2" id="P7000497027000000000000000044BC2">symbol</code> name and returns the address of the symbol, if it exists, or NULL otherwise.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BC3" id="P7000497027000000000000000044BC3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BC4" id="P7000497027000000000000000044BC4">#include &lt;dlfcn.h&gt;
int dlclose (void *handle);
			Returns: 0 if OK, -1 on error</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BC5" id="P7000497027000000000000000044BC5">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BC6" id="P7000497027000000000000000044BC6">dlclose</code> function unloads the shared library if no other shared libraries are still using it.</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BC7" id="P7000497027000000000000000044BC7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BC8" id="P7000497027000000000000000044BC8">#include &lt;dlfcn.h&gt;
const char *dlerror(void);
		Returns: error message if previous call to dlopen, dlsym, or dlclose failed;
								NULL if previous call was OK</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BC9" id="P7000497027000000000000000044BC9">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BCA" id="P7000497027000000000000000044BCA">dlerror</code> function returns a string describing the most recent error that occurred as a result of calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BCB" id="P7000497027000000000000000044BCB">dlopen, dlsym</code>, or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BCC" id="P7000497027000000000000000044BCC">dlclose</code>, or NULL if no error occurred.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BCD" id="P7000497027000000000000000044BCD"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006413"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.17</span></a> shows how we would use this interface to dynamically link our <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BCE" id="P7000497027000000000000000044BCE">libvector.so</code> shared library at run time and then invoke its <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BCF" id="P7000497027000000000000000044BCF">addvec</code> routine. To compile the program, we would invoke <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>in the following way:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BD0" id="P7000497027000000000000000044BD0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BD1" id="P7000497027000000000000000044BD1">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -rdynamic -o prog2r dll.c -ldl</i></code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P7000497027000000000000000006413" id="P7000497027000000000000000006413">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006414" epub:type="pagebreak" id="P7000497027000000000000000006414" title="703"></span>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BD2" id="P7000497027000000000000000044BD2">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/dll.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BD3" id="P7000497027000000000000000044BD3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BD4" id="P7000497027000000000000000044BD4">
1	#include &lt;stdio.h&gt;
2	#include &lt;stdlib.h&gt;
3	#include &lt;dlfcn.h&gt;
4
5	int x[2] = {1, 2};
6	int y[2] = {3, 4};
7	int z[2]; 8
9	int main()
10	{
11		void *handle;
12		void (*addvec)(int *, int *, int *, int);
13		char *error;
14
15		/* Dynamically load the shared library containing addvec() */
16		handle = dlopen("./libvector.so", RTLD_LAZY);
17		if (!handle) {
18			fprintf(stderr, "%sn", dlerror());
19			exit(1);
20		}
21
22		/* Get a pointer to the addvec() function we just loaded */
23		addvec = dlsym(handle, "addvec");
24		if ((error = dlerror()) != NULL) {
25			fprintf(stderr, "%sn", error);
26			exit(1);
27		}
28
29		/* Now we can call addvec() just like any other function */
30		addvec(x, y, z, 2);
31		printf("z = [%d %d]n", z[0], z[1]);
32
33		/* Unload the shared library */
34		if (dlclose(handle) &lt; 0) {
35			fprintf(stderr, "%sn", dlerror());
36			exit(1);
37		}
38		return 0;
39	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BD5" id="P7000497027000000000000000044BD5">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/dll.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044BD6" id="P7000497027000000000000000044BD6"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044BD7" epub:type="title" id="P7000497027000000000000000044BD7"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.17 </span>Example program 3.</h1></header>
<div class="pcalibre1 caption pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BD8" id="P7000497027000000000000000044BD8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044BD9" id="P7000497027000000000000000044BD9">Dynamically loads and links the shared library <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BDA" id="P7000497027000000000000000044BDA">libvector.so</code> at run time.</p></div></figcaption>
</figure>
<aside class="pcalibre31 pcalibre32 pcalibre2" data-uri="chapter07.xhtml#P700049702700000000000000000641E" id="P700049702700000000000000000641E"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre33" data-uri="chapter07.xhtml#P7000497027000000000000000044BDB" epub:type="title" id="P7000497027000000000000000044BDB"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006420" epub:type="pagebreak" id="P7000497027000000000000000006420" title="704"></span><span class="pcalibre1 pcalibre2 pcalibre34">Aside </span>Shared libraries and the Java Native Interface</h1></header>
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044BDC" id="P7000497027000000000000000044BDC">Java defines a standard calling convention called <i class="pcalibre17 pcalibre2 pcalibre1">Java Native Interface (JNI)</i> that allows "native" C and C++ functions to be called from Java programs. The basic idea of JNI is to compile the native C function, say, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BDD" id="P7000497027000000000000000044BDD">foo</code>, into a shared library, say, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BDE" id="P7000497027000000000000000044BDE">foo.so</code>. When a running Java program attempts to invoke function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BDF" id="P7000497027000000000000000044BDF">foo</code>, the Java interpreter uses the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BE0" id="P7000497027000000000000000044BE0">dlopen</code> interface (or something like it) to dynamically link and load <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BE1" id="P7000497027000000000000000044BE1">foo.so</code> and then call <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BE2" id="P7000497027000000000000000044BE2">foo</code>.</p>
</aside>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.12 Position-Independent Code (PIC)</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006428"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044BE3" epub:type="title" id="P7000497027000000000000000044BE3"><span class="pcalibre1 pcalibre21 pcalibre2">7.12 </span>Position-Independent Code (PIC)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BE4" id="P7000497027000000000000000044BE4">A key purpose of shared libraries is to allow multiple running processes to share the same library code in memory and thus save precious memory resources. So how can multiple processes share a single copy of a program? One approach would be to assign a priori a dedicated chunk of the address space to each shared library, and then require the loader to always load the shared library at that address. While straightforward, this approach creates some serious problems. It would be an inefficient use of the address space because portions of the space would be allocated even if a process didn't use the library. It would also be difficult to manage. We would have to ensure that none of the chunks overlapped. Each time a library was modified, we would have to make sure that it still fit in its assigned chunk. If not, then we would have to find a new chunk. And if we created a new library, we would have to find room for it. Over time, given the hundreds of libraries and versions of libraries in a system, it would be difficult to keep the address space from fragmenting into lots of small unused but unusable holes. Even worse, the assignment of libraries to memory would be different for each system, thus creating even more management headaches.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BE5" id="P7000497027000000000000000044BE5">To avoid these problems, modern systems compile the code segments of shared modules so that they can be loaded anywhere in memory without having to be modified by the linker. With this approach, a single copy of a shared module's code segment can be shared by an unlimited number of processes. (Of course, each process will still get its own copy of the read/write data segment.)</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BE6" id="P7000497027000000000000000044BE6">Code that can be loaded without needing any relocations is known as <i class="pcalibre17 pcalibre2 pcalibre1">position-independent code (PIC).</i> Users direct GNU compilation systems to generate PIC code with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BE7" id="P7000497027000000000000000044BE7">-fpic</code> option to <span class="pcalibre1 pcalibre29 pcalibre2">gcc. </span>Shared libraries must always be compiled with this option.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BE8" id="P7000497027000000000000000044BE8">On x86-64 systems, references to symbols in the same executable object module require no special treatment to be PIC. These references can be compiled using PC-relative addressing and relocated by the static linker when it builds the object file. However, references to external procedures and global variables that are defined by shared modules require some special techniques, which we describe next.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P700049702700000000000000000642F" id="P700049702700000000000000000642F">
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006430" id="P7000497027000000000000000006430"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BE9" epub:type="title" id="P7000497027000000000000000044BE9">PIC Data References</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BEA" id="P7000497027000000000000000044BEA">Compilers generate PIC references to global variables by exploiting the following interesting fact: no matter where we load an object module (including shared</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P7000497027000000000000000006433" id="P7000497027000000000000000006433">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006434" epub:type="pagebreak" id="P7000497027000000000000000006434" title="705"></span>
<img alt="A diagram illustrates using the GOT to reference a global variable." class="pcalibre239 pcalibre1 pcalibre2" data-uri="P700049702700000000000000000B75E" id="P7000497027000000000000000044BEB" src="Images/chapter-06-image-07.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044BEC" id="P7000497027000000000000000044BEC"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044BED" epub:type="title" id="P7000497027000000000000000044BED"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.18 </span>Using the GOT to reference a global variable.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044BEE" id="P7000497027000000000000000044BEE"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044BEF" id="P7000497027000000000000000044BEF">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BF0" id="P7000497027000000000000000044BF0">addvec</code> routine in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BF1" id="P7000497027000000000000000044BF1">libvector.so</code> references <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BF2" id="P7000497027000000000000000044BF2">addcnt</code> indirectly through the GOT for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BF3" id="P7000497027000000000000000044BF3">libvector.so</code>.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter07.xhtml#P7000497027000000000000000024F09" id="P7000497027000000000000000024F09">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044BF4" id="P7000497027000000000000000044BF4">A diagram shows data segment and code segment, linked by fixed distance of 0x2008b9 bytes at run time between GOT[3] and addl instruction. Components of each are summarized below.</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter07.xhtml#P7000497027000000000000000044BF5" id="P7000497027000000000000000044BF5">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BF6" id="P7000497027000000000000000044BF6"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044BF7" id="P7000497027000000000000000044BF7">Data segment: Global offset table (GOT) contains GOT[0]:, GOT[1]:, GOT[2]:, GOT[3]: &amp;addcnt</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BF8" id="P7000497027000000000000000044BF8"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044BF9" id="P7000497027000000000000000044BF9">Code segment: addvec:</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter07.xhtml#P7000497027000000000000000044BFA" id="P7000497027000000000000000044BFA">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BFB" id="P7000497027000000000000000044BFB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044BFC" id="P7000497027000000000000000044BFC">Mov 0x2008b9(%rip), % rax</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BFD" id="P7000497027000000000000000044BFD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044BFE" id="P7000497027000000000000000044BFE">Addl $0x1, (%rax)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044BFF" id="P7000497027000000000000000044BFF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044C00" id="P7000497027000000000000000044C00"># %rax=*GOT[3]=%addcnt</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C01" id="P7000497027000000000000000044C01"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044C02" id="P7000497027000000000000000044C02"># addcnt++</p></li>
</ul></li>
</ul>
</details>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C03" id="P7000497027000000000000000044C03">object modules) in memory, the data segment is always the same distance from the code segment. Thus, the <i class="pcalibre17 pcalibre2 pcalibre1">distance</i> between any instruction in the code segment and any variable in the data segment is a run-time constant, independent of the absolute memory locations of the code and data segments.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C04" id="P7000497027000000000000000044C04">Compilers that want to generate PIC references to global variables exploit this fact by creating a table called the <i class="pcalibre17 pcalibre2 pcalibre1">global offset table (GOT)</i> at the beginning of the data segment. The GOT contains an 8-byte entry for each global data object (procedure or global variable) that is referenced by the object module. The compiler also generates a relocation record for each entry in the GOT. At load time, the dynamic linker relocates each GOT entry so that it contains the absolute address of the object. Each object module that references global objects has its own GOT.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C05" id="P7000497027000000000000000044C05"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006433"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.18</span></a> shows the GOT from our example <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C06" id="P7000497027000000000000000044C06">libvector.so</code> shared module. The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C07" id="P7000497027000000000000000044C07">addvec</code> routine loads the address of the global variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C08" id="P7000497027000000000000000044C08">addcnt</code> indirectly via GOT[3] and then increments <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C09" id="P7000497027000000000000000044C09">addcnt</code> in memory. The key idea here is that the offset in the PC-relative reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C0A" id="P7000497027000000000000000044C0A">GOT[3]</code> is a run-time constant.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C0B" id="P7000497027000000000000000044C0B">Since <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C0C" id="P7000497027000000000000000044C0C">addcnt</code> is defined by the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C0D" id="P7000497027000000000000000044C0D">libvector.so</code> module, the compiler could have exploited the constant distance between the code and data segments by generating a direct PC-relative reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C0E" id="P7000497027000000000000000044C0E">addcnt</code> and adding a relocation for the linker to resolve when it builds the shared module. However, if <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C0F" id="P7000497027000000000000000044C0F">addcnt</code> were defined by another shared module, then the indirect access through the GOT would be necessary. In this case, the compiler has chosen to use the most general solution, the GOT, for all references.</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P700049702700000000000000000644B" id="P700049702700000000000000000644B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre65 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C10" epub:type="title" id="P7000497027000000000000000044C10">PIC Function Calls</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C11" id="P7000497027000000000000000044C11">Suppose that a program calls a function that is defined by a shared library. The compiler has no way of predicting the run-time address of the function, since the shared module that defines it could be loaded anywhere at run time. The normal approach would be to generate a relocation record for the reference, which <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000644E" epub:type="pagebreak" id="P700049702700000000000000000644E" title="706"></span>the dynamic linker could then resolve when the program was loaded. However, this approach would not be PIC, since it would require the linker to modify the code segment of the calling module. GNU compilation systems solve this problem using an interesting technique, called <i class="pcalibre17 pcalibre2 pcalibre1">lazy binding</i>, that defers the binding of each procedure address until the <i class="pcalibre17 pcalibre2 pcalibre1">first time</i> the procedure is called.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C12" id="P7000497027000000000000000044C12">The motivation for lazy binding is that a typical application program will call only a handful of the hundreds or thousands of functions exported by a shared library such as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C13" id="P7000497027000000000000000044C13">libc.so</code>. By deferring the resolution of a function's address until it is actually called, the dynamic linker can avoid hundreds or thousands of unnecessary relocations at load time. There is a nontrivial run-time overhead the first time the function is called, but each call thereafter costs only a single instruction and a memory reference for the indirection.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C14" id="P7000497027000000000000000044C14">Lazy binding is implemented with a compact yet somewhat complex interaction between two data structures: the GOT and the <i class="pcalibre17 pcalibre2 pcalibre1">procedure linkage table (PLT)</i>. If an object module calls any functions that are defined in shared libraries, then it has its own GOT and PLT. The GOT is part of the data segment. The PLT is part of the code segment.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C15" id="P7000497027000000000000000044C15"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006457"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.19</span></a> shows how the PLT and GOT work together to resolve the address of a function at run time. First, let's examine the contents of each of these tables.</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C16" id="P7000497027000000000000000044C16">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C17" id="P7000497027000000000000000044C17"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C18" id="P7000497027000000000000000044C18"><span class="pcalibre1 pcalibre2 pcalibre41">Procedure linkage table (PLT). </span>The PLT is an array of 16-byte code entries. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C19" id="P7000497027000000000000000044C19">PLT[0]</code> is a special entry that jumps into the dynamic linker. Each shared library function called by the executable has its own PLT entry. Each of</p>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P7000497027000000000000000006457" id="P7000497027000000000000000006457">
<img alt="Diagrams illustrate using the PLT and GOT to call external functions." class="pcalibre1 pcalibre2 pcalibre240" data-uri="P700049702700000000000000000B75F" id="P7000497027000000000000000044C1A" src="Images/chapter-06-image-08.png"/>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044C1B" id="P7000497027000000000000000044C1B"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044C1C" epub:type="title" id="P7000497027000000000000000044C1C"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.19 </span>Using the PLT and GOT to call external functions.</h1></header>
<div class="pcalibre1 pcalibre2 pcalibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044C1D" id="P7000497027000000000000000044C1D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044C1E" id="P7000497027000000000000000044C1E">The dynamic linker resolves the address of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C1F" id="P7000497027000000000000000044C1F">addvec</code> the first time it is called.</p></div>
<details class="pcalibre1 pcalibre2 pcalibre59" data-uri="chapter07.xhtml#P7000497027000000000000000024F36" id="P7000497027000000000000000024F36">
<summary class="pcalibre1 pcalibre2 pcalibre61 pcalibre60"><span class="pcalibre1 pcalibre2 pcalibre37">Description</span></summary>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C20" id="P7000497027000000000000000044C20">Two diagrams show data segment and code segment, as summarized below.</p>
<ol class="pcalibre1 pcalibre2 pcalibre141" data-uri="chapter07.xhtml#P7000497027000000000000000044C21" id="P7000497027000000000000000044C21">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C22" id="P7000497027000000000000000044C22"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C23" id="P7000497027000000000000000044C23">First invocation of addvec</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter07.xhtml#P7000497027000000000000000044C24" id="P7000497027000000000000000044C24">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C25" id="P7000497027000000000000000044C25"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C26" id="P7000497027000000000000000044C26">Data segment: Global offset table (GOT):</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C27" id="P7000497027000000000000000044C27">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C28" id="P7000497027000000000000000044C28"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C29" id="P7000497027000000000000000044C29">GOT[0]: addr of dynamic</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C2A" id="P7000497027000000000000000044C2A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C2B" id="P7000497027000000000000000044C2B">GOT[1]: addr of reloc entries</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C2C" id="P7000497027000000000000000044C2C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C2D" id="P7000497027000000000000000044C2D">GOT[2]: addr of dynamic linker</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C2E" id="P7000497027000000000000000044C2E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C2F" id="P7000497027000000000000000044C2F">GOT[3]: 0x4005b6 # sys startup</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C30" id="P7000497027000000000000000044C30"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C31" id="P7000497027000000000000000044C31">GOT[4]: 0x4005c6 # addvec()</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C32" id="P7000497027000000000000000044C32"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C33" id="P7000497027000000000000000044C33">GOT[5]: 0x4005d6 # printf()</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C34" id="P7000497027000000000000000044C34"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C35" id="P7000497027000000000000000044C35">Code segment:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C36" id="P7000497027000000000000000044C36">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C37" id="P7000497027000000000000000044C37"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C38" id="P7000497027000000000000000044C38">Callq 0x4005c0 # call addvec() (1 to line 4005c0: jmpq below)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C39" id="P7000497027000000000000000044C39"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C3A" id="P7000497027000000000000000044C3A">Procedure linkage table (PLT):</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter07.xhtml#P7000497027000000000000000044C3B" id="P7000497027000000000000000044C3B">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C3C" id="P7000497027000000000000000044C3C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C3D" id="P7000497027000000000000000044C3D"># PLT[0]: call dynamic linker</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C3E" id="P7000497027000000000000000044C3E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C3F" id="P7000497027000000000000000044C3F">4005a0: pushq *GOT[1]</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C40" id="P7000497027000000000000000044C40"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C41" id="P7000497027000000000000000044C41">4005a6: jmpq *GOT[2]</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C42" id="P7000497027000000000000000044C42"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C43" id="P7000497027000000000000000044C43"></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C44" id="P7000497027000000000000000044C44"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C45" id="P7000497027000000000000000044C45"># PLT[2]: call addvec()</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C46" id="P7000497027000000000000000044C46"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C47" id="P7000497027000000000000000044C47">4005c0: jmpq *GOT[4] (2 to line below)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C48" id="P7000497027000000000000000044C48"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C49" id="P7000497027000000000000000044C49">4005c6: pushq $0x1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C4A" id="P7000497027000000000000000044C4A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C4B" id="P7000497027000000000000000044C4B">4005cb: jmpq 4005a0 (3 to line 4005a0: pushq above)</p></li>
</ul></li></ul></li></ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C4C" id="P7000497027000000000000000044C4C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C4D" id="P7000497027000000000000000044C4D">Subsequent invocations of addvec</p>
<ul class="pcalibre1 pcalibre2 pcalibre69" data-uri="chapter07.xhtml#P7000497027000000000000000044C4E" id="P7000497027000000000000000044C4E">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C4F" id="P7000497027000000000000000044C4F"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C50" id="P7000497027000000000000000044C50">Data segment: Global offset table (GOT):</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C51" id="P7000497027000000000000000044C51">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C52" id="P7000497027000000000000000044C52"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C53" id="P7000497027000000000000000044C53">GOT[0]: addr of dynamic</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C54" id="P7000497027000000000000000044C54"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C55" id="P7000497027000000000000000044C55">GOT[1]: addr of reloc entries</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C56" id="P7000497027000000000000000044C56"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C57" id="P7000497027000000000000000044C57">GOT[2]: addr of dynamic linker</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C58" id="P7000497027000000000000000044C58"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C59" id="P7000497027000000000000000044C59">GOT[3]: 0x4005b6 # sys startup</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C5A" id="P7000497027000000000000000044C5A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C5B" id="P7000497027000000000000000044C5B">GOT[4]: &amp;addvec()</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C5C" id="P7000497027000000000000000044C5C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C5D" id="P7000497027000000000000000044C5D">GOT[5]: 0x4005d6 # printf()</p></li>
</ul></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C5E" id="P7000497027000000000000000044C5E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C5F" id="P7000497027000000000000000044C5F">Code segment:</p>
<ul class="pcalibre146 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C60" id="P7000497027000000000000000044C60">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C61" id="P7000497027000000000000000044C61"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C62" id="P7000497027000000000000000044C62">Callq 0x4005c0 # call addvec() (1 to line 4005c0: jmpq below)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C63" id="P7000497027000000000000000044C63"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C64" id="P7000497027000000000000000044C64">Procedure linkage table (PLT):</p>
<ul class="pcalibre1 pcalibre2 pcalibre62" data-uri="chapter07.xhtml#P7000497027000000000000000044C65" id="P7000497027000000000000000044C65">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C66" id="P7000497027000000000000000044C66"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C67" id="P7000497027000000000000000044C67"># PLT[0]: call dynamic linker</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C68" id="P7000497027000000000000000044C68"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C69" id="P7000497027000000000000000044C69">4005a0: pushq *GOT[1]</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C6A" id="P7000497027000000000000000044C6A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C6B" id="P7000497027000000000000000044C6B">4005a6: jmpq *GOT[2]</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C6C" id="P7000497027000000000000000044C6C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C6D" id="P7000497027000000000000000044C6D"></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C6E" id="P7000497027000000000000000044C6E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C6F" id="P7000497027000000000000000044C6F"># PLT[2]: call addvec()</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C70" id="P7000497027000000000000000044C70"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C71" id="P7000497027000000000000000044C71">4005c0: jmpq *GOT[4] (2)</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C72" id="P7000497027000000000000000044C72"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C73" id="P7000497027000000000000000044C73">4005c6: pushq $0x1</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C74" id="P7000497027000000000000000044C74"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C75" id="P7000497027000000000000000044C75">4005cb: jmpq 4005a0</p></li>
</ul></li></ul></li></ul></li>
</ol>
</details>
</figcaption>
</figure>
<p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C76" id="P7000497027000000000000000044C76"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000645F" epub:type="pagebreak" id="P700049702700000000000000000645F" title="707"></span>these entries is responsible for invoking a specific function. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C77" id="P7000497027000000000000000044C77">PLT[1]</code> (not shown here) invokes the system startup function (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C78" id="P7000497027000000000000000044C78">__libc_start_main</code>), which initializes the execution environment, calls the main function, and handles its return value. Entries starting at <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C79" id="P7000497027000000000000000044C79">PLT[2]</code> invoke functions called by the user code. In our example, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C7A" id="P7000497027000000000000000044C7A">PLT[2]</code> invokes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C7B" id="P7000497027000000000000000044C7B">addvec</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C7C" id="P7000497027000000000000000044C7C">PLT[3]</code> (not shown) invokes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C7D" id="P7000497027000000000000000044C7D">printf</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C7E" id="P7000497027000000000000000044C7E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044C7F" id="P7000497027000000000000000044C7F"><span class="pcalibre1 pcalibre2 pcalibre41">Global offset table (GOT). </span>As we have seen, the GOT is an array of 8-byte address entries. When used in conjunction with the PLT, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C80" id="P7000497027000000000000000044C80">GOT[0]</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C81" id="P7000497027000000000000000044C81">GOT[1]</code> contain information that the dynamic linker uses when it resolves function addresses. <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C82" id="P7000497027000000000000000044C82">GOT[2]</code> is the entry point for the dynamic linker in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C83" id="P7000497027000000000000000044C83">ld-linux.so</code> module. Each of the remaining entries corresponds to a called function whose address needs to be resolved at run time. Each has a matching PLT entry. For example, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C84" id="P7000497027000000000000000044C84">GOT[4]</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C85" id="P7000497027000000000000000044C85">PLT[2]</code> correspond to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C86" id="P7000497027000000000000000044C86">addvec</code>. Initially, each GOT entry points to the second instruction in the corresponding PLT entry.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C87" id="P7000497027000000000000000044C87"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006457"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.19(a)</span></a> shows how the GOT and PLT work together to lazily resolve the run-time address of function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C88" id="P7000497027000000000000000044C88">addvec</code> the first time it is called:</p>
<ol class="pcalibre1 pcalibre2 pcalibre235" data-uri="chapter07.xhtml#P7000497027000000000000000044C89" id="P7000497027000000000000000044C89">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C8A" id="P7000497027000000000000000044C8A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044C8B" id="P7000497027000000000000000044C8B"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">1. </span>Instead of directly calling <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C8C" id="P7000497027000000000000000044C8C">addvec</code>, the program calls into <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C8D" id="P7000497027000000000000000044C8D">PLT[2]</code>, which is the PLT entry for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C8E" id="P7000497027000000000000000044C8E">addvec</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C8F" id="P7000497027000000000000000044C8F"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044C90" id="P7000497027000000000000000044C90"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">2.	 </span>The first PLT instruction does an indirect jump through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C91" id="P7000497027000000000000000044C91">GOT[4]</code>. Since each GOT entry initially points to the second instruction in its corresponding PLT entry, the indirect jump simply transfers control back to the next instruction in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C92" id="P7000497027000000000000000044C92">PLT[2]</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C93" id="P7000497027000000000000000044C93"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044C94" id="P7000497027000000000000000044C94"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">3.	 </span>After pushing an ID for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C95" id="P7000497027000000000000000044C95">addvec (0x1)</code> onto the stack, <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C96" id="P7000497027000000000000000044C96">PLT[2]</code> jumps to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C97" id="P7000497027000000000000000044C97">PLT[0]</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044C98" id="P7000497027000000000000000044C98"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044C99" id="P7000497027000000000000000044C99"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">4.	 </span><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C9A" id="P7000497027000000000000000044C9A">PLT[0]</code> pushes an argument for the dynamic linker indirectly through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C9B" id="P7000497027000000000000000044C9B">GOT[1]</code> and then jumps into the dynamic linker indirectly through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C9C" id="P7000497027000000000000000044C9C">GOT[2]</code>. The dynamic linker uses the two stack entries to determine the runtime location of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C9D" id="P7000497027000000000000000044C9D">addvec</code>, overwrites <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C9E" id="P7000497027000000000000000044C9E">GOT[4]</code> with this address, and passes control to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044C9F" id="P7000497027000000000000000044C9F">addvec</code>.</p></li>
</ol>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CA0" id="P7000497027000000000000000044CA0"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006457"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.19(b)</span></a> shows the control flow for any subsequent invocations of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CA1" id="P7000497027000000000000000044CA1">addvec</code>:</p>
<ol class="pcalibre1 pcalibre2 pcalibre235" data-uri="chapter07.xhtml#P7000497027000000000000000044CA2" id="P7000497027000000000000000044CA2">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CA3" id="P7000497027000000000000000044CA3">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044CA4" id="P7000497027000000000000000044CA4"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">1.	</span>Control passes to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CA5" id="P7000497027000000000000000044CA5">PLT[2]</code> as before.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CA6" id="P7000497027000000000000000044CA6">
<p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044CA7" id="P7000497027000000000000000044CA7"><span class="pcalibre1 pcalibre21 pcalibre2">Step </span><span class="pcalibre1 pcalibre21 pcalibre2">2.	</span>However, this time the indirect jump through <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CA8" id="P7000497027000000000000000044CA8">GOT[4]</code> transfers control directly to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CA9" id="P7000497027000000000000000044CA9">addvec</code>.</p></li>
</ol>
</section>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.13 Library Interpositioning</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006493"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044CAA" epub:type="title" id="P7000497027000000000000000044CAA"><span class="pcalibre1 pcalibre21 pcalibre2">7.13 </span>Library Interpositioning</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CAB" id="P7000497027000000000000000044CAB">Linux linkers support a powerful technique, called <i class="pcalibre17 pcalibre2 pcalibre1">library interpositioning</i>, that allows you to intercept calls to shared library functions and execute your own code instead. Using interpositioning, you could trace the number of times a particular <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006496" epub:type="pagebreak" id="P7000497027000000000000000006496" title="708"></span>library function is called, validate and trace its input and output values, or even replace it with a completely different implementation.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CAC" id="P7000497027000000000000000044CAC">Here's the basic idea: Given some <i class="pcalibre17 pcalibre2 pcalibre1">target function</i> to be interposed on, you create a <i class="pcalibre17 pcalibre2 pcalibre1">wrapper function</i> whose prototype is identical to the target function. Using some particular interpositioning mechanism, you then trick the system into calling the wrapper function instead of the target function. The wrapper function typically executes its own logic, then calls the target function and passes its return value back to the caller.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CAD" id="P7000497027000000000000000044CAD">Interpositioning can occur at compile time, link time, or run time as the program is being loaded and executed. To explore these different mechanisms, we will use the example program in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000064BB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.20(a)</span></a> as a running example. It calls the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CAE" id="P7000497027000000000000000044CAE">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CAF" id="P7000497027000000000000000044CAF">free</code> functions from the C standard library (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB0" id="P7000497027000000000000000044CB0">libc.so</code>). The call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB1" id="P7000497027000000000000000044CB1">malloc</code> allocates a block of 32 bytes from the heap and returns a pointer to the block. The call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB2" id="P7000497027000000000000000044CB2">free</code> gives the block back to the heap, for use by subsequent calls to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB3" id="P7000497027000000000000000044CB3">malloc</code>. Our goal is to use interpositioning to trace the calls to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB4" id="P7000497027000000000000000044CB4">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB5" id="P7000497027000000000000000044CB5">free</code> as the program runs.</p>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000064A1" id="P70004970270000000000000000064A1"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB6" epub:type="title" id="P7000497027000000000000000044CB6"><span class="pcalibre1 pcalibre21 pcalibre2">7.13.1 </span>Compile-Time Interpositioning</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB7" id="P7000497027000000000000000044CB7"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000064BB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.20</span></a> shows how to use the C preprocessor to interpose at compile time. Each wrapper function in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB8" id="P7000497027000000000000000044CB8">mymalloc.c</code> (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000064BB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.20(c)</span></a>) calls the target function, prints a trace, and returns. The local <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CB9" id="P7000497027000000000000000044CB9">malloc.h</code> header file (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000064BB"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.20(b)</span></a>) instructs the preprocessor to replace each call to a target function with a call to its wrapper. Here is how to compile and link the program:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CBA" id="P7000497027000000000000000044CBA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CBB" id="P7000497027000000000000000044CBB">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -DCOMPILETIME -c mymalloc.c</i>
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -I. -o intc int.c mymalloc.o</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CBC" id="P7000497027000000000000000044CBC">The interpositioning happens because of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CBD" id="P7000497027000000000000000044CBD">-I</code>. argument, which tells the C preprocessor to look for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CBE" id="P7000497027000000000000000044CBE">malloc.h</code> in the current directory before looking in the usual system directories. Notice that the wrappers in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CBF" id="P7000497027000000000000000044CBF">mymalloc.c</code> are compiled with the standard <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CC0" id="P7000497027000000000000000044CC0">malloc.h</code> header file.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CC1" id="P7000497027000000000000000044CC1">Running the program gives the following trace:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CC2" id="P7000497027000000000000000044CC2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CC3" id="P7000497027000000000000000044CC3">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">./intc</i>
malloc(32)=0x9ee010
free(0x9ee010)</code></pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000064B0" id="P70004970270000000000000000064B0"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CC4" epub:type="title" id="P7000497027000000000000000044CC4"><span class="pcalibre1 pcalibre21 pcalibre2">7.13.2 </span>Link-Time Interpositioning</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CC5" id="P7000497027000000000000000044CC5">The Linux static linker supports link-time interpositioning with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CC6" id="P7000497027000000000000000044CC6">--wrap f</code> flag. This flag tells the linker to resolve references to symbol <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CC7" id="P7000497027000000000000000044CC7">f</code> as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CC8" id="P7000497027000000000000000044CC8">__wrap_f</code> (two underscores for the prefix), and to resolve references to symbol <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CC9" id="P7000497027000000000000000044CC9">__real_f</code> (two underscores for the prefix) as <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CCA" id="P7000497027000000000000000044CCA">f</code>. <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P70004970270000000000000000064CE"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.21</span></a> shows the wrappers for our example program.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CCB" id="P7000497027000000000000000044CCB">Here is how to compile the source files into relocatable object files:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CCC" id="P7000497027000000000000000044CCC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CCD" id="P7000497027000000000000000044CCD">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -DLINKTIME -c mymalloc.c</i>
linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -c int.c</i></code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P70004970270000000000000000064BB" id="P70004970270000000000000000064BB">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000064BC" epub:type="pagebreak" id="P70004970270000000000000000064BC" title="709"></span>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CCE" id="P7000497027000000000000000044CCE">(a) Example program int.c</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CCF" id="P7000497027000000000000000044CCF">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/int.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CD0" id="P7000497027000000000000000044CD0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CD1" id="P7000497027000000000000000044CD1">
1	#include &lt;stdio.h&gt;
2	#include &lt;malloc.h&gt;
3
4	int main()
5	{
6		int *p = malloc(32);
7		free(p);
8		return(0);
9	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CD2" id="P7000497027000000000000000044CD2">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/int.c</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CD3" id="P7000497027000000000000000044CD3">(b) Local malloc.h file</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CD4" id="P7000497027000000000000000044CD4">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/malloc.h</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CD5" id="P7000497027000000000000000044CD5"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CD6" id="P7000497027000000000000000044CD6">
1	#define malloc(size) mymalloc(size)
2	#define free(ptr) myfree(ptr)
3
4	void *mymalloc(size_t size);
5	void myfree(void *ptr);
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CD7" id="P7000497027000000000000000044CD7">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/malloc.h</i></p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CD8" id="P7000497027000000000000000044CD8">(c) Wrapper functions in mymalloc.c</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CD9" id="P7000497027000000000000000044CD9">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/mymalloc.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CDA" id="P7000497027000000000000000044CDA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CDB" id="P7000497027000000000000000044CDB">
1	#ifdef COMPILETIME
2	#include &lt;stdio.h&gt;
3	#include &lt;malloc.h&gt;
4
5	/* malloc wrapper function */
6	void *mymalloc(size_t size)
7	{
8		void *ptr = malloc(size);
9		printf("malloc(%d)=%pn",
10			(int)size, ptr);
11		return ptr;
12	}
13
14	/* free wrapper function */
15	void myfree(void *ptr)
16	{
17		free(ptr);
18		printf("free(%p)n", ptr);
19	}
20	#endif
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CDC" id="P7000497027000000000000000044CDC">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/mymalloc.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044CDD" id="P7000497027000000000000000044CDD"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044CDE" epub:type="title" id="P7000497027000000000000000044CDE"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre2 pcalibre37">7.20 </span>Compile-time interpositioning with the C preprocessor.</h1></header>
</figcaption>
</figure>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P70004970270000000000000000064CE" id="P70004970270000000000000000064CE">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000064CF" epub:type="pagebreak" id="P70004970270000000000000000064CF" title="710"></span>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CDF" id="P7000497027000000000000000044CDF">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/mymalloc.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CE0" id="P7000497027000000000000000044CE0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CE1" id="P7000497027000000000000000044CE1">
1	#ifdef LINKTIME
2	#include &lt;stdio.h&gt;
3
4	void *__real_malloc(size_t size);
5	void __real_free(void *ptr);
6
7	/* malloc wrapper function */
8	void *__wrap_malloc(size_t size)
9	{
10		void *ptr = __real_malloc(size); /* Call libc malloc */
11		printf("malloc(%d) = %pn", (int)size, ptr);
12		return ptr;
13	}
14
15	/* free wrapper function */
16	void __wrap_free(void *ptr)
17	{
18		__real_free(ptr); /* Call libc free */
19		printf("free(%p)n", ptr);
20	}
21	#endif
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CE2" id="P7000497027000000000000000044CE2">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/mymalloc.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044CE3" id="P7000497027000000000000000044CE3"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044CE4" epub:type="title" id="P7000497027000000000000000044CE4"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.21 </span>Link-time interpositioning with the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CE5" id="P7000497027000000000000000044CE5">--wrap</code> flag.</h1></header>
</figcaption>
</figure>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CE6" id="P7000497027000000000000000044CE6">And here is how to link the object files into an executable:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CE7" id="P7000497027000000000000000044CE7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CE8" id="P7000497027000000000000000044CE8">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -Wl,--wrap,malloc -Wl,--wrap,free -o intl int.o mymalloc.o</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CE9" id="P7000497027000000000000000044CE9">The <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CEA" id="P7000497027000000000000000044CEA">-Wl</code>, option flag passes option to the linker. Each comma in option is replaced with a space. So <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CEB" id="P7000497027000000000000000044CEB">-Wl, --wrap, malloc</code> passes <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CEC" id="P7000497027000000000000000044CEC">--wrap malloc</code> to the linker, and similarly for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CED" id="P7000497027000000000000000044CED">-Wl, --wrap, free</code>.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CEE" id="P7000497027000000000000000044CEE">Running the program gives the following trace:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CEF" id="P7000497027000000000000000044CEF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF0" id="P7000497027000000000000000044CF0">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">./intl</i>
malloc(32) = 0x18cf010
free(0x18cf010)</code></pre>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000064E2" id="P70004970270000000000000000064E2"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF1" epub:type="title" id="P7000497027000000000000000044CF1"><span class="pcalibre1 pcalibre21 pcalibre2">7.13.3 </span>Run-Time Interpositioning</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF2" id="P7000497027000000000000000044CF2">Compile-time interpositioning requires access to a program's source files. Link-time interpositioning requires access to its relocatable object files. However, there is a mechanism for interpositioning at run time that requires access only to the executable object file. This fascinating mechanism is based on the dynamic linker's <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF3" id="P7000497027000000000000000044CF3">LD_PRELOAD</code> environment variable.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF4" id="P7000497027000000000000000044CF4"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000064E7" epub:type="pagebreak" id="P70004970270000000000000000064E7" title="711"></span>If the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF5" id="P7000497027000000000000000044CF5">LD_PRELOAD</code> environment variable is set to a list of shared library pathnames (separated by spaces or colons), then when you load and execute a program, the dynamic linker (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF6" id="P7000497027000000000000000044CF6"><span class="pcalibre1 pcalibre29 pcalibre2">ld-linux.so</span></code>) will search the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF7" id="P7000497027000000000000000044CF7">LD_PRELOAD</code> libraries first, before any other shared libraries, when it resolves undefined references. With this mechanism, you can interpose on any function in any shared library, including <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF8" id="P7000497027000000000000000044CF8">libc.so</code>, when you load and execute any executable.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CF9" id="P7000497027000000000000000044CF9"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006503"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.22</span></a> shows the wrappers for <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CFA" id="P7000497027000000000000000044CFA">malloc</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CFB" id="P7000497027000000000000000044CFB">free</code>. In each wrapper, the call to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CFC" id="P7000497027000000000000000044CFC">dlsym</code> returns the pointer to the target <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CFD" id="P7000497027000000000000000044CFD">libc</code> function. The wrapper then calls the target function, prints a trace, and returns.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044CFE" id="P7000497027000000000000000044CFE">Here is how to build the shared library that contains the wrapper functions:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044CFF" id="P7000497027000000000000000044CFF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D00" id="P7000497027000000000000000044D00">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -DRUNTIME -shared -fpic -o mymalloc.so mymalloc.c -ldl</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D01" id="P7000497027000000000000000044D01">Here is how to compile the main program:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D02" id="P7000497027000000000000000044D02"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D03" id="P7000497027000000000000000044D03">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">gcc -o intr int.c</i></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D04" id="P7000497027000000000000000044D04">Here is how to run the program from the bash shell:<a class="pcalibre1 pcalibre2 pcalibre56 pcalibre16 pcalibre14 pcalibre15" epub:type="noteref" href="#P7000497027000000000000000006667" id="r__P7000497027000000000000000006667">3</a></p><aside class="pcalibre2 pcalibre32 pcalibre57" data-uri="chapter07.xhtml#P7000497027000000000000000006667" epub:type="footnote" id="P7000497027000000000000000006667"><p class="pcalibre1 pcalibre2 pcalibre10"><span class="pcalibre1 pcalibre58 pcalibre2"><a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="#r__P7000497027000000000000000006667">3. </a></span>If you don't know what shell you are running, type <code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E57" id="P7000497027000000000000000044E57">printenv SHELL</code> at the command line.</p></aside>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D05" id="P7000497027000000000000000044D05"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D06" id="P7000497027000000000000000044D06">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">LD_PRELOAD="./mymalloc.so" . /intr</i>
malloc(32) = 0x1bf7010
free(0x1bf7010)</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D07" id="P7000497027000000000000000044D07">And here is how to run it from the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D08" id="P7000497027000000000000000044D08">csh</code> or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D09" id="P7000497027000000000000000044D09">tcsh</code> shells:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D0A" id="P7000497027000000000000000044D0A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D0B" id="P7000497027000000000000000044D0B">linux&gt; (<i class="pcalibre17 pcalibre2 pcalibre1">setenv LD_PRELOAD "./mymalloc.so"; . /intr; unsetenv LD_PRELOAD</i>)
malloc(32) = 0x2157010
free(0x2157010)</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D0C" id="P7000497027000000000000000044D0C">Notice that you can use <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D0D" id="P7000497027000000000000000044D0D">LD_PRELOAD</code> to interpose on the library calls of <i class="pcalibre17 pcalibre2 pcalibre1">any</i> executable program!</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D0E" id="P7000497027000000000000000044D0E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D0F" id="P7000497027000000000000000044D0F">linux&gt; <i class="pcalibre17 pcalibre2 pcalibre1">LD_PRELOAD="./mymalloc.so" /usr/bin/uptime</i>
malloc(568) = 0x21bb010
free(0x21bb010)
malloc(15) = 0x21bb010
malloc(568) = 0x21bb030
malloc(2255) = 0x21bb270
free(0x21bb030)
malloc(20) = 0x21bb030
malloc(20) = 0x21bb050
malloc(20) = 0x21bb070
malloc(20) = 0x21bb090
malloc(20) = 0x21bb0b0
malloc(384) = 0x21bb0d0
20:47:36 up 85 days, 6:04, 1 user, load average: 0.10, 0.04, 0.05</code></pre>
<figure class="pcalibre2 pcalibre32 pcalibre35" data-uri="chapter07.xhtml#P7000497027000000000000000006503" id="P7000497027000000000000000006503">
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006504" epub:type="pagebreak" id="P7000497027000000000000000006504" title="712"></span>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D10" id="P7000497027000000000000000044D10">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/mymalloc.c</i></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D11" id="P7000497027000000000000000044D11"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D12" id="P7000497027000000000000000044D12">
1	#ifdef RUNTIME
2	#define _GNU_SOURCE
3	#include &lt;stdio.h&gt;
4	#include &lt;stdlib.h&gt;
5	#include &lt;dlfcn.h&gt;
6
7	/* malloc wrapper function */
8	void *malloc(size_t size)
9	{
10		void *(*mallocp)(size_t size);
11		char *error;
12
13		mallocp = dlsym(RTLD_NEXT, "malloc"); /* Get address of libc malloc */
14		if ((error = dlerror()) != NULL) {
15			fputs(error, stderr);
16			exit(1);
17		}
18		char *ptr = mallocp(size); /* Call libc malloc */
19		printf("malloc(%d) = %pn", (int)size, ptr);
20		return ptr;
21	}
22
23	/* free wrapper function */
24	void free(void *ptr)
25	{
26		void (*freep)(void *) = NULL;
27		char *error;
28
29		if (!ptr)
30			return;
31
32		freep = dlsym(RTLD_NEXT, "free"); /* Get address of libc free */
33		if ((error = dlerror()) != NULL) {
34			fputs(error, stderr);
35			exit(1);
36		}
37		freep(ptr); /* Call libc free */
38		printf("free(%p)n", ptr);
39	}
40	#endif
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D13" id="P7000497027000000000000000044D13">-------------------------------------------<i class="pcalibre17 pcalibre2 pcalibre1">code/link/interpose/mymalloc.c</i></p>
<figcaption class="pcalibre1 pcalibre2 calibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044D14" id="P7000497027000000000000000044D14"><header class="pcalibre1 pcalibre2 pcalibre3"><h1 class="pcalibre1 pcalibre2 pcalibre36" data-uri="chapter07.xhtml#P7000497027000000000000000044D15" epub:type="title" id="P7000497027000000000000000044D15"><span class="label pcalibre1 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.22 </span>Run-time interpositioning with <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D16" id="P7000497027000000000000000044D16">LD_PRELOAD</code>.</h1></header>
</figcaption>
</figure>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.14 Tools for Manipulating Object Files</title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P700049702700000000000000000650C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044D17" epub:type="title" id="P7000497027000000000000000044D17"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000650E" epub:type="pagebreak" id="P700049702700000000000000000650E" title="713"></span><span class="pcalibre1 pcalibre21 pcalibre2">7.14 </span>Tools for Manipulating Object Files</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D18" id="P7000497027000000000000000044D18">There are a number of tools available on Linux systems to help you understand and manipulate object files. In particular, the GNU <i class="pcalibre17 pcalibre2 pcalibre1">binutils</i> package is especially helpful and runs on every Linux platform.</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D19" id="P7000497027000000000000000044D19">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D1A" id="P7000497027000000000000000044D1A"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044D1B" id="P7000497027000000000000000044D1B"><span class="pcalibre1 pcalibre29 pcalibre2">ar</span>. Creates static libraries, and inserts, deletes, lists, and extracts members.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D1C" id="P7000497027000000000000000044D1C"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044D1D" id="P7000497027000000000000000044D1D"><span class="pcalibre1 pcalibre29 pcalibre2">strings</span>. Lists all of the printable strings contained in an object file.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D1E" id="P7000497027000000000000000044D1E"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044D1F" id="P7000497027000000000000000044D1F"><span class="pcalibre1 pcalibre29 pcalibre2">strip</span>. Deletes symbol table information from an object file.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D20" id="P7000497027000000000000000044D20"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044D21" id="P7000497027000000000000000044D21"><span class="pcalibre1 pcalibre29 pcalibre2">nm</span>. Lists the symbols defined in the symbol table of an object file.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D22" id="P7000497027000000000000000044D22"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044D23" id="P7000497027000000000000000044D23"><span class="pcalibre1 pcalibre29 pcalibre2">size</span>. Lists the names and sizes of the sections in an object file.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D24" id="P7000497027000000000000000044D24"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044D25" id="P7000497027000000000000000044D25"><span class="pcalibre1 pcalibre29 pcalibre2">readelf</span>. Displays the complete structure of an object file, including all of the information encoded in the ELF header. Subsumes the functionality of <span class="pcalibre1 pcalibre29 pcalibre2">size </span>and <span class="pcalibre1 pcalibre29 pcalibre2">nm</span>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D26" id="P7000497027000000000000000044D26"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044D27" id="P7000497027000000000000000044D27"><span class="pcalibre1 pcalibre29 pcalibre2">objdump</span>. The mother of all binary tools. Can display all of the information in an object file. Its most useful function is disassembling the binary instructions in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D28" id="P7000497027000000000000000044D28">.text</code> section.</p></li>
</ul>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D29" id="P7000497027000000000000000044D29">Linux systems also provide the <span class="pcalibre1 pcalibre29 pcalibre2">ldd </span>program for manipulating shared libraries:</p>
<ul class="pcalibre38 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D2A" id="P7000497027000000000000000044D2A">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D2B" id="P7000497027000000000000000044D2B"><p class="pcalibre1 pcalibre2 pcalibre40" data-uri="chapter07.xhtml#P7000497027000000000000000044D2C" id="P7000497027000000000000000044D2C"><span class="pcalibre1 pcalibre29 pcalibre2">ldd</span>: Lists the shared libraries that an executable needs at run time.</p></li>
</ul>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>7.15 Summary </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006524"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044D2D" epub:type="title" id="P7000497027000000000000000044D2D"><span class="pcalibre1 pcalibre21 pcalibre2">7.15 </span><span class="pcalibre1 pcalibre21 pcalibre2">Summary </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D2E" id="P7000497027000000000000000044D2E">Linking can be performed at compile time by static linkers and at load time and run time by dynamic linkers. Linkers manipulate binary files called object files, which come in three different forms: relocatable, executable, and shared. Relocatable object files are combined by static linkers into an executable object file that can be loaded into memory and executed. Shared object files (shared libraries) are linked and loaded by dynamic linkers at run time, either implicitly when the calling program is loaded and begins executing, or on demand, when the program calls functions from the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D2F" id="P7000497027000000000000000044D2F">dlopen</code> library.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D30" id="P7000497027000000000000000044D30">The two main tasks of linkers are symbol resolution, where each global symbol in an object file is bound to a unique definition, and relocation, where the ultimate memory address for each symbol is determined and where references to those objects are modified.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D31" id="P7000497027000000000000000044D31">Static linkers are invoked by compiler drivers such as <span class="pcalibre1 pcalibre29 pcalibre2">gcc</span>. They combine multiple relocatable object files into a single executable object file. Multiple object files can define the same symbol, and the rules that linkers use for silently resolving these multiple definitions can introduce subtle bugs in user programs.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D32" id="P7000497027000000000000000044D32">Multiple object files can be concatenated in a single static library. Linkers use libraries to resolve symbol references in other object modules. The left-to-right sequential scan that many linkers use to resolve symbol references is another source of confusing link-time errors.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D33" id="P7000497027000000000000000044D33"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000652C" epub:type="pagebreak" id="P700049702700000000000000000652C" title="714"></span>Loaders map the contents of executable files into memory and run the program. Linkers can also produce partially linked executable object files with unresolved references to the routines and data defined in a shared library. At load time, the loader maps the partially linked executable into memory and then calls a dynamic linker, which completes the linking task by loading the shared library and relocating the references in the program.</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D34" id="P7000497027000000000000000044D34">Shared libraries that are compiled as position-independent code can be loaded anywhere and shared at run time by multiple processes. Applications can also use the dynamic linker at run time in order to load, link, and access the functions and data in shared libraries.</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Bibliographic Notes </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre83 pcalibre2" epub:type="bibliography" id="P700049702700000000000000000652E"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 title" data-uri="chapter07.xhtml#P7000497027000000000000000044D35" epub:type="title" id="P7000497027000000000000000044D35"><span class="pcalibre1 pcalibre21 pcalibre2">Bibliographic Notes </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D36" id="P7000497027000000000000000044D36">Linking is poorly documented in the computer systems literature. Since it lies at the intersection of compilers, computer architecture, and operating systems, linking requires an understanding of code generation, machine-language programming, program instantiation, and virtual memory. It does not fit neatly into any of the usual computer systems specialties and thus is not well covered by the classic texts in these areas. However, Levine's monograph provides a good general reference on the subject [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B42D">69</a>]. The original IA 32 specifications for ELF and DWARF (a specification for the contents of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D37" id="P7000497027000000000000000044D37">.debug</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D38" id="P7000497027000000000000000044D38">.line</code> sections) are described in [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B40E">54</a>]. The x86-64 extensions to the ELF file format are described in [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B3E9">36</a>]. The x86-64 application binary interface (ABI) describes the conventions for compiling, linking, and running x86-64 programs, including the rules for relocation and position-independent code [<a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" href="fileP700049702700000000000000000B39D.xhtml#P700049702700000000000000000B43D">77</a>].</p>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Homework Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P7000497027000000000000000006533"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044D39" epub:type="title" id="P7000497027000000000000000044D39"><span class="pcalibre1 pcalibre21 pcalibre2">Homework Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006535" id="P7000497027000000000000000006535"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D3A" epub:type="title" id="P7000497027000000000000000044D3A"><span class="pcalibre1 pcalibre21 pcalibre2">7.6 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D3B" id="P7000497027000000000000000044D3B">This problem concerns the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D3C" id="P7000497027000000000000000044D3C">m.o</code> module from <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000608B.xhtml#P700049702700000000000000000612D"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.5</span></a> and the following version of the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D3D" id="P7000497027000000000000000044D3D">swap.c</code> function that counts the number of times it has been called:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D3E" id="P7000497027000000000000000044D3E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D3F" id="P7000497027000000000000000044D3F">
1	extern int buf[];
2
3	int *bufp0 = &amp;buf[0];
4	static int *bufp1;
5
6	static void incr()
7	{
8		static int count=0;
9
10		count++;
11	}
12
13	void swap()
14	{
<span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000653C" epub:type="pagebreak" id="P700049702700000000000000000653C" title="715"></span>15		int temp;
16
17		incr();
18		bufp1 = &amp;buf[1];
19		temp = *bufp0;
20		*bufp0 = *bufp1;
21		*bufp1 = temp;
22	}</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D40" id="P7000497027000000000000000044D40">For each symbol that is defined and referenced in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D41" id="P7000497027000000000000000044D41">swap.o</code>, indicate if it will have a symbol table entry in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D42" id="P7000497027000000000000000044D42">.symtab</code> section in module <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D43" id="P7000497027000000000000000044D43">swap.o</code>. If so, indicate the module that defines the symbol (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D44" id="P7000497027000000000000000044D44">swap.o or m.o</code>), the symbol type(local, global, or extern), and the section (<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D45" id="P7000497027000000000000000044D45">.text, .data</code>, or <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D46" id="P7000497027000000000000000044D46">.bss</code>) it occupies in that module.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter07.xhtml#P7000497027000000000000000044D47" id="P7000497027000000000000000044D47">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044D48" id="P7000497027000000000000000044D48">Symbol</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044D49" id="P7000497027000000000000000044D49"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D4A" id="P7000497027000000000000000044D4A">swap.o .symtab</code> entry?</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044D4B" id="P7000497027000000000000000044D4B">Symbol type</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044D4C" id="P7000497027000000000000000044D4C">Module where defined</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044D4D" id="P7000497027000000000000000044D4D">Section</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D4E" id="P7000497027000000000000000044D4E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D4F" id="P7000497027000000000000000044D4F">buf</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D50" id="P7000497027000000000000000044D50">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D51" id="P7000497027000000000000000044D51">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D52" id="P7000497027000000000000000044D52">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D53" id="P7000497027000000000000000044D53">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D54" id="P7000497027000000000000000044D54"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D55" id="P7000497027000000000000000044D55">bufp0</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D56" id="P7000497027000000000000000044D56">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D57" id="P7000497027000000000000000044D57">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D58" id="P7000497027000000000000000044D58">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D59" id="P7000497027000000000000000044D59">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D5A" id="P7000497027000000000000000044D5A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D5B" id="P7000497027000000000000000044D5B">bufp1</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D5C" id="P7000497027000000000000000044D5C">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D5D" id="P7000497027000000000000000044D5D">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D5E" id="P7000497027000000000000000044D5E">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D5F" id="P7000497027000000000000000044D5F">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D60" id="P7000497027000000000000000044D60"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D61" id="P7000497027000000000000000044D61">swap</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D62" id="P7000497027000000000000000044D62">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D63" id="P7000497027000000000000000044D63">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D64" id="P7000497027000000000000000044D64">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D65" id="P7000497027000000000000000044D65">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D66" id="P7000497027000000000000000044D66"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D67" id="P7000497027000000000000000044D67">temp</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D68" id="P7000497027000000000000000044D68">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D69" id="P7000497027000000000000000044D69">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D6A" id="P7000497027000000000000000044D6A">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D6B" id="P7000497027000000000000000044D6B">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D6C" id="P7000497027000000000000000044D6C"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D6D" id="P7000497027000000000000000044D6D">incr</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D6E" id="P7000497027000000000000000044D6E">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D6F" id="P7000497027000000000000000044D6F">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D70" id="P7000497027000000000000000044D70">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D71" id="P7000497027000000000000000044D71">_____</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D72" id="P7000497027000000000000000044D72"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D73" id="P7000497027000000000000000044D73">count</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D74" id="P7000497027000000000000000044D74">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D75" id="P7000497027000000000000000044D75">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D76" id="P7000497027000000000000000044D76">_____</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044D77" id="P7000497027000000000000000044D77">_____</td>
</tr>
</tbody>
</table>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006575" id="P7000497027000000000000000006575"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D78" epub:type="title" id="P7000497027000000000000000044D78"><span class="pcalibre1 pcalibre21 pcalibre2">7.7 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D79" id="P7000497027000000000000000044D79">Without changing any variable names, modify <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D7A" id="P7000497027000000000000000044D7A">bar5.c</code> on page 683 so that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D7B" id="P7000497027000000000000000044D7B">foo5.c</code> prints the correct values of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D7C" id="P7000497027000000000000000044D7C">x</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D7D" id="P7000497027000000000000000044D7D">y</code> (i.e., the hex representations of integers 15213 and 15212).</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P700049702700000000000000000657C" id="P700049702700000000000000000657C"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D7E" epub:type="title" id="P7000497027000000000000000044D7E"><span class="pcalibre1 pcalibre21 pcalibre2">7.8 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D7F" id="P7000497027000000000000000044D7F">In this problem, let <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D80" id="P7000497027000000000000000044D80">REF(x.i)  DEF(x.k)</code> denote that the linker will associate an arbitrary reference to symbol <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D81" id="P7000497027000000000000000044D81">x</code> in module <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D82" id="P7000497027000000000000000044D82">i</code> to the definition of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D83" id="P7000497027000000000000000044D83">x</code> in module <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D84" id="P7000497027000000000000000044D84">k</code>. For each example below, use this notation to indicate how the linker would resolve references to the multiply-defined symbol in each module. If there is a link-time error (rule 1), write "<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D85" id="P7000497027000000000000000044D85"><span class="pcalibre1 pcalibre29 pcalibre2">error</span></code>". If the linker arbitrarily chooses one of the definitions (rule 3), write "<code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D86" id="P7000497027000000000000000044D86"><span class="pcalibre1 pcalibre29 pcalibre2">unknown</span></code>".</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P7000497027000000000000000044D87" id="P7000497027000000000000000044D87">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D88" id="P7000497027000000000000000044D88"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044D89" id="P7000497027000000000000000044D89"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D8A" id="P7000497027000000000000000044D8A"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D8B" id="P7000497027000000000000000044D8B">
/* Module 1 */		/* Module 2 */
int main()		static int main=1[
{			int p2()
}			{
			}
(a) REF(main.1)  DEF(_____._____)
(b) REF(main.2)  DEF(_____._____)
</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D8C" id="P7000497027000000000000000044D8C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044D8D" id="P7000497027000000000000000044D8D"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000658D" epub:type="pagebreak" id="P700049702700000000000000000658D" title="716"></span></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D8E" id="P7000497027000000000000000044D8E"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D8F" id="P7000497027000000000000000044D8F">
/* Module 1 */		/* Module 2 */
int x;			double x;
void main()		int p2()
{			{
}			}
(a) REF(x.1)  DEF(_____._____)
(b) REF(x.2)  DEF(_____._____)
</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D90" id="P7000497027000000000000000044D90"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044D91" id="P7000497027000000000000000044D91"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D92" id="P7000497027000000000000000044D92"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D93" id="P7000497027000000000000000044D93">
/* Module 1 */		/* Module 2 */
int x=1;		double x=1.0;
void main()		int p2()
{			{
}			}
(a) REF(x.1)  DEF(_____._____)
(b) REF(x.2)  DEF(_____._____)
</code></pre>
</li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006594" id="P7000497027000000000000000006594"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D94" epub:type="title" id="P7000497027000000000000000044D94"><span class="pcalibre1 pcalibre21 pcalibre2">7.9 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D95" id="P7000497027000000000000000044D95">Consider the following program, which consists of two object modules:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D96" id="P7000497027000000000000000044D96"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D97" id="P7000497027000000000000000044D97">
1	/* foo6.c */
2	void p2(void);
3
4	int main()
5	{
6		p2();
7		return 0;
8	}
</code></pre>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044D98" id="P7000497027000000000000000044D98"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D99" id="P7000497027000000000000000044D99">
1	/* bar6.c */
2	#include &lt;stdio.h&gt;
3
4	char main;
5
6	void p2()
7	{
8		printf("0x%xn", main);
9	}
</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D9A" id="P7000497027000000000000000044D9A">When this program is compiled and executed on an x86-64 Linux system, it prints the string <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D9B" id="P7000497027000000000000000044D9B">0x48\n</code> and terminates normally, even though function <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D9C" id="P7000497027000000000000000044D9C">p2</code> never initializes variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D9D" id="P7000497027000000000000000044D9D">main</code>. Can you explain this?</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P700049702700000000000000000659F" id="P700049702700000000000000000659F"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D9E" epub:type="title" id="P7000497027000000000000000044D9E"><span class="pcalibre1 pcalibre21 pcalibre2">7.10 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044D9F" id="P7000497027000000000000000044D9F">Let <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DA0" id="P7000497027000000000000000044DA0">a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DA1" id="P7000497027000000000000000044DA1">b</code> denote object modules or static libraries in the current directory, and let <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DA2" id="P7000497027000000000000000044DA2">a</code><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DA3" id="P7000497027000000000000000044DA3">b</code> denote that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DA4" id="P7000497027000000000000000044DA4">a</code> depends on <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DA5" id="P7000497027000000000000000044DA5">b</code>, in the sense that <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DA6" id="P7000497027000000000000000044DA6">b</code> defines a symbol that is <span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000065A9" epub:type="pagebreak" id="P70004970270000000000000000065A9" title="717"></span>referenced by <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DA7" id="P7000497027000000000000000044DA7">a</code>. For each of the following scenarios, show the minimal command line (i.e., one with the least number of object file and library arguments) that will allow the static linker to resolve all symbol references:</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P7000497027000000000000000044DA8" id="P7000497027000000000000000044DA8">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DA9" id="P7000497027000000000000000044DA9"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044DAA" id="P7000497027000000000000000044DAA"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DAB" id="P7000497027000000000000000044DAB"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DAC" id="P7000497027000000000000000044DAC">p.o  libx.a  p.o</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DAD" id="P7000497027000000000000000044DAD"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044DAE" id="P7000497027000000000000000044DAE"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DAF" id="P7000497027000000000000000044DAF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DB0" id="P7000497027000000000000000044DB0">p.o  libx.a  liby.a <i class="pcalibre17 pcalibre2 pcalibre1">and</i> liby.a  libx.a</code></pre></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DB1" id="P7000497027000000000000000044DB1"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044DB2" id="P7000497027000000000000000044DB2"></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DB3" id="P7000497027000000000000000044DB3"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DB4" id="P7000497027000000000000000044DB4">p.o  libx.a  liby.a  libz.a <i class="pcalibre17 pcalibre2 pcalibre1">and</i> liby.a  libx.a  libz.a</code></pre></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000065B8" id="P70004970270000000000000000065B8"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DB5" epub:type="title" id="P7000497027000000000000000044DB5"><span class="pcalibre1 pcalibre21 pcalibre2">7.11 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DB6" id="P7000497027000000000000000044DB6">The program header in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006348.xhtml#P700049702700000000000000000634F"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.14</span></a> indicates that the data segment occupies <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DB7" id="P7000497027000000000000000044DB7">0x230</code> bytes in memory. However, only the first <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DB8" id="P7000497027000000000000000044DB8">0x228</code> bytes of these come from the sections of the executable file. What causes this discrepancy?</p>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000065BD" id="P70004970270000000000000000065BD"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DB9" epub:type="title" id="P7000497027000000000000000044DB9"><span class="pcalibre1 pcalibre21 pcalibre2">7.12 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DBA" id="P7000497027000000000000000044DBA">Consider the call to function swap in object file <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DBB" id="P7000497027000000000000000044DBB">m.o</code> (<a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="#P7000497027000000000000000006535"><span class="pcalibre1 pcalibre21 pcalibre2">Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.6</span></a>).</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DBC" id="P7000497027000000000000000044DBC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DBD" id="P7000497027000000000000000044DBD">9: e8 00 00 00 00	callq e &lt;main+0xe&gt;	<b class="pcalibre1 pcalibre2 pcalibre12"><i class="pcalibre17 pcalibre2 pcalibre1">swap()</i></b></code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DBE" id="P7000497027000000000000000044DBE">with the following relocation entry:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DBF" id="P7000497027000000000000000044DBF"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DC0" id="P7000497027000000000000000044DC0">r.offset = 0xa
r.symbol = swap
r.type = R_X86_64_PC32
r.addend = -4</code></pre>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P7000497027000000000000000044DC1" id="P7000497027000000000000000044DC1">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DC2" id="P7000497027000000000000000044DC2"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044DC3" id="P7000497027000000000000000044DC3">Suppose that the linker relocates <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DC4" id="P7000497027000000000000000044DC4">.text</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DC5" id="P7000497027000000000000000044DC5">m.o</code> to address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DC6" id="P7000497027000000000000000044DC6">0x4004e0</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DC7" id="P7000497027000000000000000044DC7">swap</code> to address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DC8" id="P7000497027000000000000000044DC8">0x4004f8</code>. Then what is the value of the relocated reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DC9" id="P7000497027000000000000000044DC9">swap</code> in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DCA" id="P7000497027000000000000000044DCA">callq</code> instruction?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DCB" id="P7000497027000000000000000044DCB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044DCC" id="P7000497027000000000000000044DCC">Suppose that the linker relocates <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DCD" id="P7000497027000000000000000044DCD">.text</code> in <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DCE" id="P7000497027000000000000000044DCE">m.o</code> to address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DCF" id="P7000497027000000000000000044DCF">0x4004d0</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DD0" id="P7000497027000000000000000044DD0">swap</code> to address <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DD1" id="P7000497027000000000000000044DD1">0x400500</code>. Then what is the value of the relocated reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DD2" id="P7000497027000000000000000044DD2">swap</code> in the <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DD3" id="P7000497027000000000000000044DD3">callq</code> instruction?</p></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000065D9" id="P70004970270000000000000000065D9"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DD4" epub:type="title" id="P7000497027000000000000000044DD4"><span class="pcalibre1 pcalibre21 pcalibre2">7.13 </span></h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DD5" id="P7000497027000000000000000044DD5">Performing the following tasks will help you become more familiar with the various tools for manipulating object files.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P7000497027000000000000000044DD6" id="P7000497027000000000000000044DD6">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DD7" id="P7000497027000000000000000044DD7"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044DD8" id="P7000497027000000000000000044DD8">How many object files are contained in the versions of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DD9" id="P7000497027000000000000000044DD9">libc.a</code> and <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DDA" id="P7000497027000000000000000044DDA">libm.a</code> on your system?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DDB" id="P7000497027000000000000000044DDB"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044DDC" id="P7000497027000000000000000044DDC">Does <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DDD" id="P7000497027000000000000000044DDD">gcc -0g</code> produce different executable code than <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DDE" id="P7000497027000000000000000044DDE">gcc -0g -g</code>?</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044DDF" id="P7000497027000000000000000044DDF"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044DE0" id="P7000497027000000000000000044DE0">What shared libraries does the <span class="pcalibre1 pcalibre29 pcalibre2">gcc </span>driver on your system use?</p></li>
</ol>
</section>
</section></body></html>
<?xml version='1.0' encoding='utf-8'?>
<html epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta content="PXE Basic 1.0" name="dcterms.conformsTo"/>
<meta content="PXE Tools version 1.39.52" name="generator"/>
<!--Created by pxe.pl for standard version PXE Basic 1.0,data-profile-product=standard by PXE Tools 1.39.52, partial=false-->
<title>Solutions to Practice Problems </title>
<link href="../css/theme/night.css" rel="alternate stylesheet" title="night" type="text/css"/>
<link href="../css/theme/sepia.css" rel="alternate stylesheet" title="sepia" type="text/css"/>
<script src="js/format_lg_obj.js"></script>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body class="pcalibre1 pcalibre2 pcalibre" epub:type="bodymatter">
<section class="pcalibre1 pcalibre2 pcalibre3" id="P70004970270000000000000000065E7"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre1 pcalibre2 pcalibre4" data-uri="chapter07.xhtml#P7000497027000000000000000044DE1" epub:type="title" id="P7000497027000000000000000044DE1"><span class="pcalibre1 pcalibre21 pcalibre2">Solutions to Practice Problems </span></h1></header>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P70004970270000000000000000065E9" id="P70004970270000000000000000065E9"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DE2" epub:type="title" id="P7000497027000000000000000044DE2"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000608B.xhtml#P7000497027000000000000000006120"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.1 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000608B.xhtml#P70004970270000000000000000060D0">678</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DE3" id="P7000497027000000000000000044DE3">The purpose of this problem is to help you understand the relationship between linker symbols and C variables and functions. Notice that the C local variable <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DE4" id="P7000497027000000000000000044DE4">temp</code> does <i class="pcalibre17 pcalibre2 pcalibre1">not</i> have a symbol table entry.</p>
<table class="pcalibre1 pcalibre2 pcalibre43" data-uri="chapter07.xhtml#P7000497027000000000000000044DE5" id="P7000497027000000000000000044DE5">
<thead class="pcalibre44 pcalibre2 pcalibre1">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044DE6" id="P7000497027000000000000000044DE6"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P70004970270000000000000000065EF" epub:type="pagebreak" id="P70004970270000000000000000065EF" title="718"></span>Symbol</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044DE7" id="P7000497027000000000000000044DE7"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DE8" id="P7000497027000000000000000044DE8">.symtab</code> entry?</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044DE9" id="P7000497027000000000000000044DE9">Symbol type</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044DEA" id="P7000497027000000000000000044DEA">Module where defined</th>
<th class="pcalibre1 pcalibre2 calibre5" data-uri="chapter07.xhtml#P7000497027000000000000000044DEB" id="P7000497027000000000000000044DEB">Section</th>
</tr>
</thead>
<tbody class="pcalibre1 pcalibre2 calibre6">
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DEC" id="P7000497027000000000000000044DEC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DED" id="P7000497027000000000000000044DED">buf</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DEE" id="P7000497027000000000000000044DEE">Yes</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DEF" id="P7000497027000000000000000044DEF">extern</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DF0" id="P7000497027000000000000000044DF0"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DF1" id="P7000497027000000000000000044DF1">m.o</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DF2" id="P7000497027000000000000000044DF2"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DF3" id="P7000497027000000000000000044DF3">.data</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DF4" id="P7000497027000000000000000044DF4"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DF5" id="P7000497027000000000000000044DF5">bufp0</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DF6" id="P7000497027000000000000000044DF6">Yes</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DF7" id="P7000497027000000000000000044DF7">global</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DF8" id="P7000497027000000000000000044DF8"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DF9" id="P7000497027000000000000000044DF9">swap.o</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DFA" id="P7000497027000000000000000044DFA"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DFB" id="P7000497027000000000000000044DFB">.data</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DFC" id="P7000497027000000000000000044DFC"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044DFD" id="P7000497027000000000000000044DFD">bufp1</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DFE" id="P7000497027000000000000000044DFE">Yes</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044DFF" id="P7000497027000000000000000044DFF">global</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E00" id="P7000497027000000000000000044E00"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E01" id="P7000497027000000000000000044E01">swap.o</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E02" id="P7000497027000000000000000044E02">COMMON</td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E03" id="P7000497027000000000000000044E03"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E04" id="P7000497027000000000000000044E04">swap</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E05" id="P7000497027000000000000000044E05">Yes</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E06" id="P7000497027000000000000000044E06">global</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E07" id="P7000497027000000000000000044E07"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E08" id="P7000497027000000000000000044E08">swap.o</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E09" id="P7000497027000000000000000044E09"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E0A" id="P7000497027000000000000000044E0A">.text</code></td>
</tr>
<tr class="pcalibre45 pcalibre1 pcalibre2">
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E0B" id="P7000497027000000000000000044E0B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E0C" id="P7000497027000000000000000044E0C">temp</code></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E0D" id="P7000497027000000000000000044E0D">No</td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E0E" id="P7000497027000000000000000044E0E"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E0F" id="P7000497027000000000000000044E0F"></td>
<td class="pcalibre1 pcalibre2 calibre7" data-uri="chapter07.xhtml#P7000497027000000000000000044E10" id="P7000497027000000000000000044E10"></td>
</tr>
</tbody>
</table>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P700049702700000000000000000661A" id="P700049702700000000000000000661A"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E11" epub:type="title" id="P7000497027000000000000000044E11"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P70004970270000000000000000061C5"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.2 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000006160.xhtml#P70004970270000000000000000061C7">684</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E12" id="P7000497027000000000000000044E12">This is a simple drill that checks your understanding of the rules that a Unix linker uses when it resolves global symbols that are defined in more than one module. Understanding these rules can help you avoid some nasty programming bugs.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P7000497027000000000000000044E13" id="P7000497027000000000000000044E13">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E14" id="P7000497027000000000000000044E14"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E15" id="P7000497027000000000000000044E15">The linker chooses the strong symbol defined in module 1 over the weak symbol defined in module 2 (rule 2):</p>
<ol class="pcalibre1 pcalibre2 pcalibre118" data-uri="chapter07.xhtml#P7000497027000000000000000044E16" id="P7000497027000000000000000044E16">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E17" id="P7000497027000000000000000044E17"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E18" id="P7000497027000000000000000044E18"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E19" id="P7000497027000000000000000044E19">REF(main.1)  DEF(main.1)</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E1A" id="P7000497027000000000000000044E1A"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E1B" id="P7000497027000000000000000044E1B"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E1C" id="P7000497027000000000000000044E1C">REF(main.2)  DEF(main.1)</code></p></li>
</ol></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E1D" id="P7000497027000000000000000044E1D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E1E" id="P7000497027000000000000000044E1E">This is an <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E1F" id="P7000497027000000000000000044E1F"><span class="pcalibre1 pcalibre29 pcalibre2">error</span></code>, because each module defines a strong symbol <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E20" id="P7000497027000000000000000044E20">main</code> (rule 1).</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E21" id="P7000497027000000000000000044E21"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E22" id="P7000497027000000000000000044E22">The linker chooses the strong symbol defined in module 2 over the weak symbol defined in module 1 (rule 2):</p>
<ol class="pcalibre1 pcalibre2 pcalibre118" data-uri="chapter07.xhtml#P7000497027000000000000000044E23" id="P7000497027000000000000000044E23">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E24" id="P7000497027000000000000000044E24"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E25" id="P7000497027000000000000000044E25"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E26" id="P7000497027000000000000000044E26">REF(x.1)  DEF(x.2)</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E27" id="P7000497027000000000000000044E27"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E28" id="P7000497027000000000000000044E28"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E29" id="P7000497027000000000000000044E29">REF(x.2)  DEF(x.2)</code></p></li>
</ol></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006634" id="P7000497027000000000000000006634"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E2A" epub:type="title" id="P7000497027000000000000000044E2A"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP7000497027000000000000000006160.xhtml#P7000497027000000000000000006268"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.3 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP7000497027000000000000000006160.xhtml#P7000497027000000000000000006253">689</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E2B" id="P7000497027000000000000000044E2B">Placing static libraries in the wrong order on the command line is a common source of linker errors that confuses many programmers. However, once you understand how linkers use static libraries to resolve references, it's pretty straightforward. This little drill checks your understanding of this idea:</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P7000497027000000000000000044E2C" id="P7000497027000000000000000044E2C">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E2D" id="P7000497027000000000000000044E2D"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E2E" id="P7000497027000000000000000044E2E"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E2F" id="P7000497027000000000000000044E2F">linux&gt; gcc p.o libx.a</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E30" id="P7000497027000000000000000044E30"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E31" id="P7000497027000000000000000044E31"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E32" id="P7000497027000000000000000044E32">linux&gt; gcc p.o libx.a liby.a</code></p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E33" id="P7000497027000000000000000044E33"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E34" id="P7000497027000000000000000044E34"><code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E35" id="P7000497027000000000000000044E35">linux&gt; gcc p.o libx.a liby.a libx.a</code></p></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P7000497027000000000000000006641" id="P7000497027000000000000000006641"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E36" epub:type="title" id="P7000497027000000000000000044E36"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000627E.xhtml#P7000497027000000000000000006326"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.4 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000627E.xhtml#P700049702700000000000000000630C">694</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E37" id="P7000497027000000000000000044E37">This problem concerns the disassembly listing in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000627E.xhtml#P700049702700000000000000000630B"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.12(a)</span></a>. Our purpose here is to give you some practice reading disassembly listings and to check your understanding of PC-relative addressing.</p>
<ol class="pcalibre1 pcalibre2 pcalibre79" data-uri="chapter07.xhtml#P7000497027000000000000000044E38" id="P7000497027000000000000000044E38">
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E39" id="P7000497027000000000000000044E39"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E3A" id="P7000497027000000000000000044E3A">The hex address of the relocated reference in line 5 is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E3B" id="P7000497027000000000000000044E3B">0x4004df</code>.</p></li>
<li class="pcalibre39 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E3C" id="P7000497027000000000000000044E3C"><p class="pcalibre1 pcalibre2 pcalibre10" data-uri="chapter07.xhtml#P7000497027000000000000000044E3D" id="P7000497027000000000000000044E3D">The hex value of the relocated reference in line 5 is <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E3E" id="P7000497027000000000000000044E3E">0x5</code>. Remember that the disassembly listing shows the value of the reference in little-endian byte order.</p></li>
</ol>
</section>
<section class="pcalibre1 pcalibre2 pcalibre3" data-uri="chapter07.xhtml#P700049702700000000000000000664B" id="P700049702700000000000000000664B"><header class="pcalibre1 pcalibre2 calibre"><h1 class="pcalibre30 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E3F" epub:type="title" id="P7000497027000000000000000044E3F"><a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000627E.xhtml#P7000497027000000000000000006334"><span class="pcalibre1 pcalibre21 pcalibre2">Solution to Problem </span><span class="pcalibre1 pcalibre21 pcalibre2">7.5 </span></a>(page <a class="pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre15 pcalibre13" epub:type="pagebreak" href="fileP700049702700000000000000000627E.xhtml#P700049702700000000000000000632F">695</a>)</h1></header>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E40" id="P7000497027000000000000000044E40">This problem tests your understanding of how the linker relocates PC-relative references. You were given that</p>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E41" id="P7000497027000000000000000044E41"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P700049702700000000000000000664F" epub:type="pagebreak" id="P700049702700000000000000000664F" title="719"></span></p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E42" id="P7000497027000000000000000044E42"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E43" id="P7000497027000000000000000044E43">ADDR(s) = ADDR(.text) = 0x4004d0</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E44" id="P7000497027000000000000000044E44">and</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E45" id="P7000497027000000000000000044E45"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E46" id="P7000497027000000000000000044E46">ADDR(r.symbol) = ADDR(swap) = 0x4004e8</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E47" id="P7000497027000000000000000044E47">Using the algorithm in <a class="pcalibre15 pcalibre1 pcalibre2 pcalibre16 pcalibre14 pcalibre28" href="fileP700049702700000000000000000627E.xhtml#P70004970270000000000000000062B6"><span class="pcalibre1 pcalibre21 pcalibre2">Figure </span><span class="pcalibre1 pcalibre21 pcalibre2">7.10</span></a>, the linker first computes the run-time address of the reference:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E48" id="P7000497027000000000000000044E48"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E49" id="P7000497027000000000000000044E49">refaddr = ADDR(s) + r.offset
= 0x4004d0 + 0xa
= 0x4004da</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E4A" id="P7000497027000000000000000044E4A">It then updates the reference:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E4B" id="P7000497027000000000000000044E4B"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E4C" id="P7000497027000000000000000044E4C">*refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr)
= (unsigned) (0x4004e8 + (-4) - 0x4004da)
= (unsigned) (0xa)</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E4D" id="P7000497027000000000000000044E4D">Thus, in the resulting executable object file, the PC-relative reference to <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E4E" id="P7000497027000000000000000044E4E">swap</code> has a value of <code class="pcalibre1 calibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E4F" id="P7000497027000000000000000044E4F">0xa</code>:</p>
<pre class="calibre2 pcalibre2 pcalibre1" data-uri="chapter07.xhtml#P7000497027000000000000000044E50" id="P7000497027000000000000000044E50"><code class="calibre3 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E51" id="P7000497027000000000000000044E51">4004d9: e8 0a 00 00 00 callq 4004e8 &lt;swap&gt;</code></pre>
<p class="pcalibre8 pcalibre1 pcalibre2" data-uri="chapter07.xhtml#P7000497027000000000000000044E52" id="P7000497027000000000000000044E52"><span class="pcalibre1 pcalibre2 pcalibre5" data-uri="chapter07.xhtml#P7000497027000000000000000006661" epub:type="pagebreak" id="P7000497027000000000000000006661" title="720"></span></p>
</section>
</section></body></html>
