---
name: import-course
description: Import a course from an EPUB book into the database by reading course-plan.json files and creating course, parts, and chapters via the API. Use when the user wants to add a new book/course to the Brainer system.
---

# Import Course

## Overview

This skill automates the process of importing a course from an EPUB book into the Brainer database. It reads `course-plan.json` files from book directories (generated by `/reformat-epub`), **designs an original pedagogical structure** (not mirroring the book), and creates all entities in the database via REST API calls.

**Prerequisites:** The book must have been processed by `/reformat-epub` first to generate the `course-plan.json` file.

## When to Use This Skill

Invoke this skill when the user wants to:
- Import a new book/course into Brainer (after running `/reformat-epub`)
- Add a course from the books/ directory to the database
- Create the course structure (course, parts, chapters) in the database

**Important:** Run `/reformat-epub` first to generate the `course-plan.json` file.

## Workflow

### Step 0: Clear Temp Directory

**The script automatically clears the `temp/` directory at startup** to ensure a clean state.

### Step 1: Find Course Plan

Search for `course-plan.json` files in book directories within `books/`:
- If a specific book directory name is provided, load its `course-plan.json`
- If no name provided, list all available books with `course-plan.json` files
- The script looks for: `books/<book-directory>/course-plan.json`

**Note:** The `course-plan.json` file is generated by the `/reformat-epub` skill and contains the complete course structure.

### Step 2: Load Course Structure

Load the `course-plan.json` file from the book directory:
- Contains course metadata (title, slug, author)
- Contains parts structure with order and titles
- Contains chapters with order, titles, slugs, and source files
- This is the **raw book structure** — it will be completely redesigned in Step 2.6

### Step 2.5: Scan Source Content

Before designing the pedagogical structure, understand what each book chapter actually contains.

**Actions:**
1. Find the OEBPS directory for the book (check `books/{book-dir}/OEBPS/`, `books/{book-dir}/OEBPS/OEBPS/` — double-nesting exists for some books)
2. For each chapter listed in `course-plan.json`, read the corresponding XHTML file
3. Extract only: the `<h1>` title, all `<h2>` section headings, and word count (from file size or text length)
4. Build an internal working table (not saved to disk):

```
ch01.xhtml | [h1 title from file] | Sections: [h2 heading 1, h2 heading 2, ...] | ~N words
ch02.xhtml | [h1 title from file] | Sections: [h2 heading 1, h2 heading 2, ...] | ~N words
...
```

Do **not** read full content — just headings. This gives sufficient signal for grouping decisions.

### Step 2.6: Design Pedagogical Structure

**⚠️ ANTIPLAGIAT STRUCTUREL — CONTRAINTE ABSOLUE**

With the content scan from Step 2.5, design a **completely original** course structure. The book's structure is raw material for analysis, NOT a template to follow.

**Mandatory constraints:**

1. **Part titles** — Express what the student can DO after the part (action verb + object):
   - ✅ "Encoder l'information avec seulement deux états"
   - ✅ "Construire des circuits qui calculent"
   - ❌ "Communication et codes" (topic label, not a skill)
   - ❌ "Partie I : Introduction" (meaningless)

2. **Chapter titles** — Never a bare topic label; choose the format based on the book's nature:

   - **Questions** — adapté aux livres conceptuels/découverte où le contenu suscite une interrogation naturelle :
     - ✅ "Comment deux symboles suffisent-ils à tout représenter ?"
     - ✅ "Pourquoi un circuit électrique peut-il raisonner ?"
   - **Affirmations de compétence** — adapté aux livres techniques/pratiques où l'étudiant acquiert un savoir-faire :
     - ✅ "Construire un pipeline de données distribué"
     - ✅ "Optimiser les requêtes SQL pour la production"
   - **Règle de choix :** si le contenu du livre est principalement narratif/conceptuel → questions ; si le livre est principalement technique/opérationnel → affirmations de compétence. Ne pas forcer les questions sur du contenu technique, ni les affirmations sur du contenu découverte.
   - ❌ "Le binaire" (label thématique sans verbe ni question)
   - ❌ "Circuits et portes logiques" (liste de sujets)
   - ❌ "Introduction" (vide de sens pédagogique)

3. **Concision rule (HARD LIMIT)** — Titles must be short and focused on a single idea:
   - Part title (after "Partie N : "): ≤ 6 words
   - Chapter title (after "Chapitre N : "): ≤ 7 words
   - **NEVER join two concepts with "et"** — it signals you're cramming two ideas into one title; cut to the stronger concept or split the chapter
   - ❌ "Comprendre le rôle du data engineer et maîtriser le cycle de vie des données" (14 mots, 2 concepts)
   - ❌ "Concevoir et architecturer des systèmes de données" (double verbe redondant)
   - ❌ "Transformer, servir et pérenniser les données" (liste de 3 verbes)
   - ✅ "Le cycle de vie du data engineer" (6 mots, 1 concept)
   - ✅ "Concevoir des systèmes de données" (4 mots)
   - ✅ "Transformer et servir les données" (acceptable si les deux verbes forment UNE seule opération indissociable)

4. **Chapter count** — MUST differ from the book by at least 20%:
   - 28 book chapters → target 14–20 course chapters
   - 10 book chapters → target 6–12 course chapters
   - This is a hard constraint — a 1:1 mapping is NEVER acceptable

4. **Merging rule** — Merge book chapters when:
   - 2–4 short chapters (< 4,000 words each) share a single coherent skill the student must demonstrate
   - They form a natural learning unit that would have one set of exercises
   - Example: book ch01 (codes) + ch02 (combinations) + ch03 (binary) → course ch01 "Comment deux symboles suffisent-ils à tout représenter ?"

5. **Splitting rule** — Split one book chapter into two course chapters when:
   - It covers two clearly distinct skills (> 8,000 words, two separable competencies)
   - Example: a chapter on "memory AND I/O" → ch1 "Comment la mémoire stocke-t-elle l'état ?" + ch2 "Comment les périphériques communiquent-ils avec le processeur ?"

6. **Thematic reorganization** — Parts can group topics from different book parts if the learning progression demands it:
   - Example: book chapters on "circuits" (part 2) and "relay-based logic" (part 1) can be merged into one course part on "physical foundations of computation"

**Output of Step 2.6 — Internal mapping table:**
```
Course Part 1: "[Verbe d'action + domaine de compétence]"
  Course Ch 1: "[Question ou affirmation de compétence]"
    source_files: ["ch01.xhtml", "ch02.xhtml", "ch03.xhtml"]
    Rationale: three short chapters forming one coherent learning unit — [shared concept]

  Course Ch 2: "[Question ou affirmation de compétence]"
    source_files: ["ch04.xhtml", "ch05.xhtml"]
    Rationale: two chapters sharing the same competency — [shared concept]

Course Part 2: "[Verbe d'action + domaine de compétence]"
  Course Ch 3: "[Question ou affirmation de compétence]"
    source_files: ["ch06.xhtml"]
    Rationale: standalone large chapter (> 8,000 words) covering a distinct skill
  Course Ch 4: "[Question ou affirmation de compétence]"
    source_files: ["ch07.xhtml"]
    Rationale: second half of split chapter — distinct competency
  ...
```

### Step 3: Adapt to French and Generate Description

Working from the pedagogical structure designed in Step 2.6 (NOT from the book structure):

1. Generate a concise course description (1–2 sentences):
   - Summarize what the course covers from the student's perspective (skills acquired, not book blurb)
   - NOT just the author name
   - Conceptual book: "Comprendre comment [phénomène central] fonctionne — de [concept de base] jusqu'à [concept avancé]."
   - Technical book: "Maîtriser [domaine technique] : [outil/concept A], [outil/concept B] et [outil/concept C] pour [objectif professionnel]."

2. Generate the course slug from the French course title (kebab-case, no accents)

3. Finalize part and chapter titles (already in French from Step 2.6):
   - **Chapter title format:** Keep `"Chapitre N : "` prefix for UI consistency, then the question/skill statement
   - Question example: `"Chapitre 1 : Comment deux symboles suffisent-ils à tout représenter ?"`
   - Skill example: `"Chapitre 1 : Construire un pipeline de données robuste"`
   - Generate slugs from the full French title: `chapitre-1-[mots-cles-du-titre]`

4. Assign sequential `order` values (1-based) globally across all parts for chapters

5. Save as `temp/course-plan-fr.json` with the **new format** including `source_files` array:

```json
{
  "course": {
    "title": "[Titre du cours en français]",
    "slug": "[titre-du-cours-en-kebab-case]",
    "description": "[1-2 phrases décrivant les compétences acquises, angle pédagogique]",
    "author": "[Auteur]"
  },
  "parts": [
    {
      "order": 1,
      "title": "Partie 1 : [Verbe d'action + domaine de compétence]",
      "chapters": [
        {
          "order": 1,
          "title": "Chapitre 1 : [Question ou affirmation de compétence]",
          "slug": "chapitre-1-[mots-cles-du-titre]",
          "source_files": ["ch01.xhtml", "ch02.xhtml", "ch03.xhtml"]
        },
        {
          "order": 2,
          "title": "Chapitre 2 : [Question ou affirmation de compétence]",
          "slug": "chapitre-2-[mots-cles-du-titre]",
          "source_files": ["ch04.xhtml", "ch05.xhtml"]
        }
      ]
    }
  ],
  "summary": {
    "parts": 3,
    "chapters": 10
  }
}
```

**⚠️ Key format change:** `source_files` is an **array**, not a single string. Each course chapter references one or more book XHTML files.

### Step 4: Create Course in Database

Make API calls to create the course structure:

1. **Create Course** (`POST /api/courses`)
   ```json
   {
     "title": "Course title (in French)",
     "slug": "course-slug",
     "description": "Brief 1-2 sentence course description (in French)"
   }
   ```

2. **Create Parts** (`POST /api/courses/{slug}/parts` for each part)
   ```json
   {
     "order": 1,
     "title": "Part title",
     "description": ""
   }
   ```

3. **Create Chapters** (`POST /api/courses/{slug}/chapters` for each chapter)
   ```json
   {
     "part_id": 123,
     "order": 1,
     "title": "Chapter title",
     "slug": "chapter-slug",
     "content": "<p>Chapter content will be added later</p>"
   }
   ```

Note: `source_files` is NOT sent to the API — it stays in `course-plan-fr.json` and is written to `source-map.json` (Step 3.5).

### Step 3.5: Write Persistent Source Map

After the database import (`create_chapters()` call), the script automatically writes `books/{book-dir}/source-map.json`. This file is persistent (unlike `temp/`) and is used by `/create-chapters` to find which XHTML files to load for each course chapter.

**This step is handled automatically by `import_course.py`** — no manual action needed. The file format:

```json
{
  "course_slug": "[course-slug]",
  "chapters": {
    "chapitre-1-[mots-cles]": {
      "source_files": ["ch01.xhtml", "ch02.xhtml", "ch03.xhtml"]
    },
    "chapitre-2-[mots-cles]": {
      "source_files": ["ch04.xhtml", "ch05.xhtml"]
    }
  }
}
```

### Step 5: Report Results

Display a summary:
- Course created with slug (in French)
- Number of parts created
- Number of chapters created
- Source map saved at `books/{book-dir}/source-map.json`
- Direct link to view the course in the frontend

## Important Notes

- **Prerequisites:** Run `/reformat-epub` first to generate `course-plan.json` in the book directory
- **Backend must be running** on `http://localhost:8000` (or configured API URL)
- **`BRAINER_TOKEN` required:** Write endpoints are protected. Get a token first:
  ```bash
  curl -s -X POST http://localhost:8000/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"email":"you@example.com","password":"yourpassword"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])"
  export BRAINER_TOKEN=<token>
  ```
- **All titles MUST be in French** — the skill translates and uses `temp/course-plan-fr.json`
- **Temp directory is cleared** at the start of each import to ensure a clean state
- The skill creates the **structure only** (course, parts, chapters with placeholder content)
- Chapter **content extraction** from XHTML files is done separately via `/create-chapters`
- Images are handled by the `/create-chapters` skill
- If the course slug already exists in the database, the API will return an error

## Script Reference

This skill uses `.claude/skills/import-course/scripts/import_course.py` which:
- Clears the `temp/` directory at startup for a clean state
- Finds `course-plan.json` files in book directories
- Loads the course plan from the book directory
- Expects Claude to create `temp/course-plan-fr.json` with the redesigned structure
- Makes REST API calls using the `requests` library
- Writes `books/{book-dir}/source-map.json` after import for use by `/create-chapters`
- Handles errors gracefully (missing files, API failures, etc.)
- Reads API URL from environment variable `API_URL` (defaults to `http://localhost:8000`)

## Example Usage

**User request:**
> "Import the [Book Title] book into the database"

**Skill actions:**
1. Clear `temp/` directory
2. Find `books/[book-dir]/course-plan.json`
3. Load course plan (original book structure: N chapters in M parts)
4. **Scan** h1/h2 headings of all N XHTML files
5. **Assess book nature** — conceptual/narrative → questions ; technical/practical → skill statements
6. **Design original structure** targeting 20–30% fewer or more chapters than the book:
   - Part 1 "[Verbe d'action + domaine]" (K chapters merging related book chapters)
   - Part 2 "[Verbe d'action + domaine]" (K chapters, potentially splitting one large chapter)
   - etc.
7. Generate `temp/course-plan-fr.json` with `source_files` arrays
8. Create course/parts/chapters in DB
9. Write `books/[book-dir]/source-map.json`
10. Report: "✅ Course imported! X chapters in Y parts. View at http://localhost:3000/courses/[slug]"

## Resources

### .claude/skills/import-course/scripts/import_course.py
Python script that performs the actual import:
- Clears `temp/` directory at startup
- Finds and validates `course-plan.json` files in book directories
- Loads course plan from book directory
- Waits for Claude to create the redesigned French plan in `temp/course-plan-fr.json`
- Makes API requests to create course entities
- Writes `books/{book-dir}/source-map.json` for persistent source file mapping
- Provides detailed progress and error reporting

Usage:
```bash
source brainer_venv/bin/activate

# Prerequisites: Run /reformat-epub first to generate course-plan.json

# Import course (requires temp/course-plan-fr.json to exist)
python .claude/skills/import-course/scripts/import_course.py "Book Directory Name"

# Example:
python .claude/skills/import-course/scripts/import_course.py "my-book-directory"
```

**Note:** The book directory name should match the directory in `books/` that contains `course-plan.json`.

### references/api_endpoints.md
Documents the exact API endpoints and payload formats used for course creation.

### references/french_translation_guide.md
Complete guide for adapting course structure to French with pedagogical redesign principles.
