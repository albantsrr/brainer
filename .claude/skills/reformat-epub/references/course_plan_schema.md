# course-plan.json Schema

This document defines the expected structure of `course-plan.json` files generated by the EPUB reformat pipeline.

## Purpose

The `course-plan.json` file serves as a contract between:
1. **EPUB processing scripts** (parse_toc.py, normalize_epub.py) - produce this file
2. **`/import-course` skill** - consumes this file to create database records

## Schema

```json
{
  "course": {
    "title": string,        // Course title (from EPUB metadata or TOC)
    "slug": string,         // Kebab-case slug (auto-generated)
    "description": string   // Optional description (usually "by Author Name")
  },
  "parts": [               // Array of parts (optional, can be empty)
    {
      "order": integer,    // Part order (starts at 1)
      "title": string,     // Part title (e.g., "Part I: Introduction")
      "description": string, // Optional part description
      "chapters": [        // Array of chapters in this part
        {
          "order": integer,      // Chapter order within part (starts at 1)
          "title": string,       // Chapter title
          "slug": string,        // Kebab-case slug (auto-generated)
          "source_file": string  // XHTML file path relative to OEBPS/
        }
      ]
    }
  ]
}
```

## Field Definitions

### course.title
- **Type:** String
- **Required:** Yes
- **Format:** Human-readable title
- **Example:** `"Fundamentals of Data Engineering"`
- **Source:** EPUB metadata (dc:title) or first heading in TOC

### course.slug
- **Type:** String
- **Required:** Yes
- **Format:** Kebab-case (lowercase, hyphens, no spaces)
- **Example:** `"fundamentals-of-data-engineering"`
- **Generation:** `slugify(course.title)`
- **Used for:** URL paths, database unique constraint

### course.description
- **Type:** String
- **Required:** No
- **Format:** Free text (usually "by Author Name")
- **Example:** `"by Joe Reis and Matt Housley"`
- **Source:** EPUB metadata (dc:creator) or manually set

### parts[].order
- **Type:** Integer
- **Required:** Yes
- **Range:** 1 to N (sequential, no gaps)
- **Note:** Must be unique within the course
- **Example:** `1, 2, 3`

### parts[].title
- **Type:** String
- **Required:** Yes
- **Format:** Human-readable title (usually includes part number)
- **Example:** `"Part I: Foundation and Building Blocks"`
- **Source:** TOC section headings (Roman numerals) or semantic detection

### parts[].description
- **Type:** String
- **Required:** No
- **Format:** Free text description of the part
- **Example:** `"Introduction to core concepts"`

### parts[].chapters[].order
- **Type:** Integer
- **Required:** Yes
- **Range:** 1 to N (sequential within part)
- **Note:** Can repeat across parts (e.g., Part I has chapter 1, Part II also has chapter 1)
- **Example:** `1, 2, 3`

### parts[].chapters[].title
- **Type:** String
- **Required:** Yes
- **Format:** Human-readable title
- **Example:** `"Data Engineering Described"`
- **Source:** TOC or semantic detection from h1 headings

### parts[].chapters[].slug
- **Type:** String
- **Required:** Yes
- **Format:** Kebab-case (lowercase, hyphens)
- **Example:** `"data-engineering-described"`
- **Generation:** `slugify(chapter.title)`
- **Used for:** URL paths, database unique constraint (within course)

### parts[].chapters[].source_file
- **Type:** String
- **Required:** Yes
- **Format:** Relative path from OEBPS/ directory
- **Example:** `"ch01.xhtml"` or `"content/chapter01.xhtml"`
- **Note:** Path separators should use forward slashes (/)
- **Used by:** `/create-chapters` skill to read chapter content

## Examples

### Example 1: Standard Book with Parts

```json
{
  "course": {
    "title": "Fundamentals of Data Engineering",
    "slug": "fundamentals-of-data-engineering",
    "description": "by Joe Reis and Matt Housley"
  },
  "parts": [
    {
      "order": 1,
      "title": "Part I: Foundation and Building Blocks",
      "description": "",
      "chapters": [
        {
          "order": 1,
          "title": "Data Engineering Described",
          "slug": "data-engineering-described",
          "source_file": "ch01.xhtml"
        },
        {
          "order": 2,
          "title": "The Data Engineering Lifecycle",
          "slug": "the-data-engineering-lifecycle",
          "source_file": "ch02.xhtml"
        }
      ]
    },
    {
      "order": 2,
      "title": "Part II: The Data Engineering Lifecycle in Depth",
      "description": "",
      "chapters": [
        {
          "order": 1,
          "title": "Designing Good Data Architecture",
          "slug": "designing-good-data-architecture",
          "source_file": "ch03.xhtml"
        }
      ]
    }
  ]
}
```

### Example 2: Book Without Parts (Normalized EPUB)

```json
{
  "course": {
    "title": "Computer Systems: A Programmer's Perspective",
    "slug": "computer-systems-a-programmers-perspective",
    "description": "by Randal E. Bryant and David R. O'Hallaron"
  },
  "parts": [
    {
      "order": 1,
      "title": "Main Content",
      "description": "",
      "chapters": [
        {
          "order": 1,
          "title": "A Tour of Computer Systems",
          "slug": "a-tour-of-computer-systems",
          "source_file": "ch01.xhtml"
        },
        {
          "order": 2,
          "title": "Representing and Manipulating Information",
          "slug": "representing-and-manipulating-information",
          "source_file": "ch02.xhtml"
        },
        {
          "order": 3,
          "title": "Machine-Level Representation of Programs",
          "slug": "machine-level-representation-of-programs",
          "source_file": "ch03.xhtml"
        }
      ]
    }
  ]
}
```

### Example 3: Minimal Valid Structure

```json
{
  "course": {
    "title": "Introduction to Programming",
    "slug": "introduction-to-programming",
    "description": ""
  },
  "parts": [
    {
      "order": 1,
      "title": "Part 1",
      "description": "",
      "chapters": [
        {
          "order": 1,
          "title": "Getting Started",
          "slug": "getting-started",
          "source_file": "ch01.xhtml"
        }
      ]
    }
  ]
}
```

## Validation Rules

### Course Level
- `course.slug` must be unique across all courses in database
- `course.slug` must match regex: `^[a-z0-9]+(?:-[a-z0-9]+)*$`
- `course.title` must not be empty

### Part Level
- `parts` array can be empty, but usually has at least 1 part
- Part `order` values must be sequential: 1, 2, 3, ... (no gaps)
- Part `order` must be unique within the course
- Each part must have at least 1 chapter

### Chapter Level
- Chapter `order` values must be sequential within each part: 1, 2, 3, ...
- Chapter `slug` must be unique within the course (across all parts)
- Chapter `slug` must match regex: `^[a-z0-9]+(?:-[a-z0-9]+)*$`
- `source_file` must point to an existing XHTML file
- `source_file` path should use forward slashes (/)

## Generation Process

### Standard EPUBs (parse_toc.py)

1. **Parse toc.ncx XML**
   - Extract navMap structure
   - Identify navPoint elements (hierarchy)

2. **Detect Parts**
   - Look for Roman numeral patterns: "I.", "II.", "III.", etc.
   - These become `parts[]` entries

3. **Detect Chapters**
   - Look for numeric patterns: "1.", "2.", "3.", etc.
   - These become `chapters[]` entries
   - Assign to most recent part

4. **Generate slugs**
   - Apply `slugify()` to all titles
   - Remove special characters
   - Convert spaces to hyphens
   - Lowercase everything

5. **Extract source files**
   - Get `content[src]` attribute from navPoint
   - Store as relative path

### Normalized EPUBs (normalize_epub.py)

1. **Semantic chapter detection**
   - Scan XHTML files for h1/h2 headings
   - Identify chapter boundaries

2. **Create part structure**
   - Usually a single part: "Main Content"
   - Or detect part markers in headings

3. **Generate chapter entries**
   - Create ch01.xhtml, ch02.xhtml, etc.
   - Use first h1 as chapter title
   - Apply `slugify()` to titles

4. **Write course-plan.json**
   - Write to normalized output directory
   - Also copy to project root for convenience

## Usage by /import-course

The `/import-course` skill reads `course-plan.json` and:

1. Creates Course record in database
   ```sql
   INSERT INTO courses (title, slug, description)
   VALUES (course.title, course.slug, course.description)
   ```

2. Creates Part records
   ```sql
   INSERT INTO parts (course_id, order, title, description)
   VALUES (course_id, part.order, part.title, part.description)
   ```

3. Creates Chapter records
   ```sql
   INSERT INTO chapters (course_id, part_id, order, title, slug, content)
   VALUES (course_id, part_id, chapter.order, chapter.title, chapter.slug, '<p>Placeholder</p>')
   ```

Note: Initial `content` is just a placeholder. Actual content is filled by `/create-chapters` skill.

## File Location

After generation, `course-plan.json` can be in multiple locations:

1. **Project root:** `/home/teissier/brainer/course-plan.json`
   - Written by `parse_toc.py`
   - Used by `/import-course` when importing standard EPUBs

2. **Normalized book directory:** `books/{book-name}-normalized/course-plan.json`
   - Written by `normalize_epub.py`
   - Used by `/import-course` when importing normalized books

3. **Books directory:** `books/course-plan.json`
   - Sometimes copied here for convenience
   - Less common

The `/import-course` skill searches these locations in order.

## Troubleshooting

### Missing course-plan.json

**Symptom:** File not found after running parse_toc.py or normalize_epub.py

**Solutions:**
1. Check script output for errors
2. Verify EPUB has valid TOC or chapter structure
3. Run with DEBUG=1 to see detailed logs
4. Check permissions on output directory

### Invalid JSON syntax

**Symptom:** JSON parsing errors when loading file

**Solutions:**
1. Validate JSON: `python -m json.tool course-plan.json`
2. Check for trailing commas (not allowed in JSON)
3. Check for unescaped quotes in strings
4. Regenerate file from source

### Slug conflicts

**Symptom:** Database error "slug already exists" during import

**Solutions:**
1. Check if course already imported
2. Delete old course or change slug in course-plan.json
3. Regenerate with different book title

### Missing source files

**Symptom:** Chapter content cannot be loaded by /create-chapters

**Solutions:**
1. Verify all source_file paths exist: `ls books/Book/OEBPS/ch*.xhtml`
2. Check path separators (should be forward slashes)
3. Regenerate normalized structure if files were moved
